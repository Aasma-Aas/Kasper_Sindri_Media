[0m14:44:31.857324 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002558CF21550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002558CCBF7A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002558CF237D0>]}


============================== 14:44:31.864320 | e241274a-c59f-496b-9584-c5a1a6f34d0f ==============================
[0m14:44:31.864320 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:44:31.866498 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s test.sql', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m14:44:32.209185 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e241274a-c59f-496b-9584-c5a1a6f34d0f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002558CF791C0>]}
[0m14:44:32.362188 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e241274a-c59f-496b-9584-c5a1a6f34d0f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002558CD6D8B0>]}
[0m14:44:32.364589 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:44:32.380382 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:44:32.551108 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m14:44:32.552109 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m14:44:32.565112 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e241274a-c59f-496b-9584-c5a1a6f34d0f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002558D2124B0>]}
[0m14:44:32.588109 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e241274a-c59f-496b-9584-c5a1a6f34d0f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002558D2CD7F0>]}
[0m14:44:32.589164 [info ] [MainThread]: Found 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m14:44:32.591115 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e241274a-c59f-496b-9584-c5a1a6f34d0f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002558D2CC050>]}
[0m14:44:32.593108 [warn ] [MainThread]: The selection criterion 'test.sql' does not match any nodes
[0m14:44:32.596105 [info ] [MainThread]: 
[0m14:44:32.598108 [warn ] [MainThread]: Nothing to do. Try checking your model configs and model specification args
[0m14:44:32.600519 [debug] [MainThread]: Command end result
[0m14:44:32.613182 [debug] [MainThread]: Command `dbt compile` succeeded at 14:44:32.612103 after 1.03 seconds
[0m14:44:32.614109 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025589F31100>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002558CD6ED20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002558CD6F8C0>]}
[0m14:44:32.615314 [debug] [MainThread]: Flushing usage events
[0m14:45:26.111678 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BA3712B10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BA3713D10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BA3713860>]}


============================== 14:45:26.121683 | deb59346-06a5-4819-b74d-15b383214e16 ==============================
[0m14:45:26.121683 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:45:26.124684 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt compile -s test', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m14:45:26.500693 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'deb59346-06a5-4819-b74d-15b383214e16', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BA3768800>]}
[0m14:45:26.689573 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'deb59346-06a5-4819-b74d-15b383214e16', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BA36F3D40>]}
[0m14:45:26.691583 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:45:26.711594 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:45:26.803604 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m14:45:26.804617 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m14:45:26.812631 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'deb59346-06a5-4819-b74d-15b383214e16', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BA390E630>]}
[0m14:45:26.828703 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'deb59346-06a5-4819-b74d-15b383214e16', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BA3AF95B0>]}
[0m14:45:26.831640 [info ] [MainThread]: Found 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m14:45:26.833640 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'deb59346-06a5-4819-b74d-15b383214e16', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BA3736870>]}
[0m14:45:26.835635 [warn ] [MainThread]: The selection criterion 'test' does not match any nodes
[0m14:45:26.840697 [info ] [MainThread]: 
[0m14:45:26.842633 [warn ] [MainThread]: Nothing to do. Try checking your model configs and model specification args
[0m14:45:26.845639 [debug] [MainThread]: Command end result
[0m14:45:26.862635 [debug] [MainThread]: Command `dbt compile` succeeded at 14:45:26.862635 after 1.00 seconds
[0m14:45:26.864764 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019B9D095610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BA34C56A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BA3610320>]}
[0m14:45:26.866636 [debug] [MainThread]: Flushing usage events
[0m14:47:38.144693 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000135BCC11910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000135BCC11CA0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000135BCC13F80>]}


============================== 14:47:38.152694 | 95c40319-9659-47ec-a591-2a7ac81cf5cc ==============================
[0m14:47:38.152694 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:47:38.154696 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s test', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m14:47:38.553424 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '95c40319-9659-47ec-a591-2a7ac81cf5cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000135BCCD9400>]}
[0m14:47:38.711483 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '95c40319-9659-47ec-a591-2a7ac81cf5cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000135BCAEFEF0>]}
[0m14:47:38.714484 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:47:38.738483 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:47:38.840551 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m14:47:38.841569 [debug] [MainThread]: Partial parsing: added file: dbt_project_test_kasper://models\test.sql
[0m14:47:39.060331 [error] [MainThread]: Encountered an error:
Compilation Error in model test (models\test.sql)
  expected token ',', got 'Praksis'
    line 3
      {% set categories = ['Fodsundhed og samfund', 'Forebyggelse', 'Forskning og viden, 'Praksis'] %}
[0m14:47:39.063291 [debug] [MainThread]: Command `dbt compile` failed at 14:47:39.062424 after 1.20 seconds
[0m14:47:39.064292 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000135BCC37B60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000135BCC11BE0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000135BCC103B0>]}
[0m14:47:39.066287 [debug] [MainThread]: Flushing usage events
[0m14:48:48.305759 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029865F536B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029865F53140>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029865F52EA0>]}


============================== 14:48:48.315841 | 260ae816-48c4-437d-b0bc-f6e985d6c445 ==============================
[0m14:48:48.315841 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:48:48.319837 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt compile -s test', 'send_anonymous_usage_stats': 'True'}
[0m14:48:48.716910 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '260ae816-48c4-437d-b0bc-f6e985d6c445', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029865B1DAF0>]}
[0m14:48:48.904011 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '260ae816-48c4-437d-b0bc-f6e985d6c445', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000298656A0DD0>]}
[0m14:48:48.907033 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:48:48.928018 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:48:49.102008 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m14:48:49.104012 [debug] [MainThread]: Partial parsing: added file: dbt_project_test_kasper://models\test.sql
[0m14:48:49.289009 [error] [MainThread]: Encountered an error:
Compilation Error in model test (models\test.sql)
  expected token ':', got '}'
    line 7
      {% set diction2 = {0: {{categories}}, 1: {{tags}}, 2: {{tags_r}}}%}
[0m14:48:49.292010 [debug] [MainThread]: Command `dbt compile` failed at 14:48:49.291012 after 1.22 seconds
[0m14:48:49.293011 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002985F925610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000298661421B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000298663EED20>]}
[0m14:48:49.294036 [debug] [MainThread]: Flushing usage events
[0m14:49:38.474498 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202EA731520>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202E98AD7F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202EA730140>]}


============================== 14:49:38.484507 | aa00384a-057e-4d7b-a61c-f5ef3ec2aed2 ==============================
[0m14:49:38.484507 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:49:38.487505 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s test', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m14:49:38.852328 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'aa00384a-057e-4d7b-a61c-f5ef3ec2aed2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202EA7887A0>]}
[0m14:49:38.982701 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'aa00384a-057e-4d7b-a61c-f5ef3ec2aed2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202EA29AE70>]}
[0m14:49:38.984704 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:49:39.000240 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:49:39.160487 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m14:49:39.162488 [debug] [MainThread]: Partial parsing: added file: dbt_project_test_kasper://models\test.sql
[0m14:49:39.330635 [error] [MainThread]: Encountered an error:
Compilation Error in model test (models\test.sql)
  unexpected '%'
    line 7
      {% set diction2 = {0: {{%categories%}}, 1: {{%tags%}}, 2: {{%tags_r%}}} %}
[0m14:49:39.333632 [debug] [MainThread]: Command `dbt compile` failed at 14:49:39.332634 after 1.07 seconds
[0m14:49:39.334641 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202EA558740>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202EA9E30B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202EAA265D0>]}
[0m14:49:39.335943 [debug] [MainThread]: Flushing usage events
[0m14:50:58.695056 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B1667731D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B165D357F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B1667738C0>]}


============================== 14:50:58.705056 | 305b0afe-6ab1-4c25-8acd-cfd1b669f5b4 ==============================
[0m14:50:58.705056 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:50:58.708133 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s test', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m14:50:59.055065 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '305b0afe-6ab1-4c25-8acd-cfd1b669f5b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B1667C9F10>]}
[0m14:50:59.203285 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '305b0afe-6ab1-4c25-8acd-cfd1b669f5b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B166682F00>]}
[0m14:50:59.206277 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:50:59.223245 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:50:59.341242 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m14:50:59.342550 [debug] [MainThread]: Partial parsing: added file: dbt_project_test_kasper://models\test.sql
[0m14:50:59.600286 [error] [MainThread]: Encountered an error:
Compilation Error in model test (models\test.sql)
  expected token ':', got '}'
    line 33
      {% for j in range(len( {{diction2[i]}} ))%}
[0m14:50:59.603245 [debug] [MainThread]: Command `dbt compile` failed at 14:50:59.602384 after 1.24 seconds
[0m14:50:59.604262 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B166AB9DF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B166CAEB40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B166B125D0>]}
[0m14:50:59.605243 [debug] [MainThread]: Flushing usage events
[0m14:52:02.292652 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BD671E3260>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BD671E2E10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BD671E2B40>]}


============================== 14:52:02.302654 | e8003ca6-6b0d-4620-91bc-a2c2f5a45124 ==============================
[0m14:52:02.302654 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:52:02.305655 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt compile -s test', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m14:52:02.646779 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e8003ca6-6b0d-4620-91bc-a2c2f5a45124', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BD671E35F0>]}
[0m14:52:02.827331 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e8003ca6-6b0d-4620-91bc-a2c2f5a45124', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BD673F3890>]}
[0m14:52:02.830358 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:52:02.851527 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:52:02.993805 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m14:52:02.994889 [debug] [MainThread]: Partial parsing: added file: dbt_project_test_kasper://models\test.sql
[0m14:52:03.240031 [error] [MainThread]: Encountered an error:
Compilation Error in model test (models\test.sql)
  Unexpected end of template. Jinja was looking for the following tags: 'endfor' or 'else'. The innermost block that needs to be closed is 'for'.
    line 34
      WHEN {{ diction[i] }} like "%{{diction2[i][j]}}%" THEN "{{diction2[i][j]}}"
[0m14:52:03.243026 [debug] [MainThread]: Command `dbt compile` failed at 14:52:03.243026 after 1.21 seconds
[0m14:52:03.245017 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BD6764E7B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BD67454E90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BD6765F5C0>]}
[0m14:52:03.246019 [debug] [MainThread]: Flushing usage events
[0m14:53:03.759164 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018B4CF317F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018B4C32D7F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018B4CF31790>]}


============================== 14:53:03.773165 | 98aaedac-b36f-476c-a9af-8e78c0f4ee28 ==============================
[0m14:53:03.773165 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:53:03.776351 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s test', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m14:53:04.341729 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '98aaedac-b36f-476c-a9af-8e78c0f4ee28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018B4CD18650>]}
[0m14:53:04.501728 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '98aaedac-b36f-476c-a9af-8e78c0f4ee28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018B468B5490>]}
[0m14:53:04.504730 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:53:04.528844 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:53:04.664845 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m14:53:04.666846 [debug] [MainThread]: Partial parsing: added file: dbt_project_test_kasper://models\test.sql
[0m14:53:04.917831 [error] [MainThread]: Encountered an error:
'Undefined' object cannot be interpreted as an integer
[0m14:53:04.927823 [error] [MainThread]: Traceback (most recent call last):
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 91, in wrapper
    result, success = func(*args, **kwargs)
                      ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 76, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 169, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 198, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 245, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 271, in wrapper
    ctx.obj["manifest"] = parse_manifest(
                          ^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\manifest.py", line 1790, in parse_manifest
    manifest = ManifestLoader.get_full_manifest(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\manifest.py", line 318, in get_full_manifest
    manifest = loader.load()
               ^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\manifest.py", line 478, in load
    self.parse_project(
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\manifest.py", line 674, in parse_project
    parser.parse_file(block)
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\base.py", line 483, in parse_file
    self.parse_node(file_block)
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\base.py", line 444, in parse_node
    self.render_update(node, config)
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\models.py", line 360, in render_update
    super().render_update(node, config)
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\base.py", line 420, in render_update
    context = self.render_with_context(node, config)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\base.py", line 269, in render_with_context
    get_rendered(parsed_node.raw_code, context, parsed_node, capture_macros=True)
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\clients\jinja.py", line 600, in get_rendered
    rendered = render_template(template, ctx, node)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\clients\jinja.py", line 546, in render_template
    return template.render(ctx)
           ^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\jinja2\environment.py", line 1301, in render
    self.environment.handle_exception()
  File "C:\Users\hp\dbt\Lib\site-packages\jinja2\environment.py", line 936, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "<template>", line 33, in top-level template code
  File "C:\Users\hp\dbt\Lib\site-packages\jinja2\sandbox.py", line 393, in call
    return __context.call(__obj, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\jinja2\sandbox.py", line 101, in safe_range
    rng = range(*args)
          ^^^^^^^^^^^^
TypeError: 'Undefined' object cannot be interpreted as an integer

[0m14:53:04.934842 [debug] [MainThread]: Command `dbt compile` failed at 14:53:04.933837 after 1.53 seconds
[0m14:53:04.935831 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018B4CD18680>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018B4D19B260>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018B4D13C4D0>]}
[0m14:53:04.937834 [debug] [MainThread]: Flushing usage events
[0m14:54:09.319867 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B1D0FA2CC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B1D0FA0F50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B1D0FA0F80>]}


============================== 14:54:09.329622 | d5e30d24-184b-440f-8b3a-c36227b8dc50 ==============================
[0m14:54:09.329622 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:54:09.333628 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt compile -s test', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m14:54:09.773108 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd5e30d24-184b-440f-8b3a-c36227b8dc50', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B1D11C7950>]}
[0m14:54:09.930685 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd5e30d24-184b-440f-8b3a-c36227b8dc50', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B1D0EDD820>]}
[0m14:54:09.933713 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:54:09.954696 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:54:10.113750 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m14:54:10.115749 [debug] [MainThread]: Partial parsing: added file: dbt_project_test_kasper://models\test.sql
[0m14:54:10.318224 [error] [MainThread]: Encountered an error:
'Undefined' object cannot be interpreted as an integer
[0m14:54:10.326230 [error] [MainThread]: Traceback (most recent call last):
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 91, in wrapper
    result, success = func(*args, **kwargs)
                      ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 76, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 169, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 198, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 245, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 271, in wrapper
    ctx.obj["manifest"] = parse_manifest(
                          ^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\manifest.py", line 1790, in parse_manifest
    manifest = ManifestLoader.get_full_manifest(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\manifest.py", line 318, in get_full_manifest
    manifest = loader.load()
               ^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\manifest.py", line 478, in load
    self.parse_project(
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\manifest.py", line 674, in parse_project
    parser.parse_file(block)
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\base.py", line 483, in parse_file
    self.parse_node(file_block)
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\base.py", line 444, in parse_node
    self.render_update(node, config)
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\models.py", line 360, in render_update
    super().render_update(node, config)
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\base.py", line 420, in render_update
    context = self.render_with_context(node, config)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\base.py", line 269, in render_with_context
    get_rendered(parsed_node.raw_code, context, parsed_node, capture_macros=True)
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\clients\jinja.py", line 600, in get_rendered
    rendered = render_template(template, ctx, node)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\clients\jinja.py", line 546, in render_template
    return template.render(ctx)
           ^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\jinja2\environment.py", line 1301, in render
    self.environment.handle_exception()
  File "C:\Users\hp\dbt\Lib\site-packages\jinja2\environment.py", line 936, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "<template>", line 33, in top-level template code
  File "C:\Users\hp\dbt\Lib\site-packages\jinja2\sandbox.py", line 393, in call
    return __context.call(__obj, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\jinja2\sandbox.py", line 101, in safe_range
    rng = range(*args)
          ^^^^^^^^^^^^
TypeError: 'Undefined' object cannot be interpreted as an integer

[0m14:54:10.331229 [debug] [MainThread]: Command `dbt compile` failed at 14:54:10.330227 after 1.29 seconds
[0m14:54:10.332179 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B1D0BFD280>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B1D14BECC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B1D1233CE0>]}
[0m14:54:10.333197 [debug] [MainThread]: Flushing usage events
[0m14:54:43.072912 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D797AE62A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D797AE6F30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D797AE6D20>]}


============================== 14:54:43.083797 | 5a32db39-7a1b-4d7c-9ef6-c4d88e325b53 ==============================
[0m14:54:43.083797 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:54:43.086839 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt compile -s test', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m14:54:43.433833 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '5a32db39-7a1b-4d7c-9ef6-c4d88e325b53', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D797B09A00>]}
[0m14:54:43.590370 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '5a32db39-7a1b-4d7c-9ef6-c4d88e325b53', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D797B39D90>]}
[0m14:54:43.593400 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:54:43.617428 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:54:43.754413 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m14:54:43.755921 [debug] [MainThread]: Partial parsing: added file: dbt_project_test_kasper://models\test.sql
[0m14:54:43.960415 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '5a32db39-7a1b-4d7c-9ef6-c4d88e325b53', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D797D268D0>]}
[0m14:54:43.980417 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '5a32db39-7a1b-4d7c-9ef6-c4d88e325b53', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D797F596A0>]}
[0m14:54:43.981415 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m14:54:43.983414 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '5a32db39-7a1b-4d7c-9ef6-c4d88e325b53', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D79807C710>]}
[0m14:54:43.986415 [info ] [MainThread]: 
[0m14:54:43.988416 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m14:54:43.991413 [debug] [ThreadPool]: Acquiring new postgres connection 'list_DBT_DATABASE_public'
[0m14:54:44.015268 [debug] [ThreadPool]: Using postgres connection "list_DBT_DATABASE_public"
[0m14:54:44.016928 [debug] [ThreadPool]: On list_DBT_DATABASE_public: BEGIN
[0m14:54:44.018269 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:54:44.352808 [debug] [ThreadPool]: Postgres adapter: Got a retryable error when attempting to open a postgres connection.
1 attempts remaining. Retrying in 0 seconds.
Error:
connection to server at "localhost" (::1), port 5432 failed: FATAL:  password authentication failed for user "DBT_USER"

[0m14:54:44.434781 [debug] [ThreadPool]: Postgres adapter: Error running SQL: BEGIN
[0m14:54:44.436827 [debug] [ThreadPool]: Postgres adapter: Rolling back transaction.
[0m14:54:44.438760 [debug] [ThreadPool]: Postgres adapter: Error running SQL: macro list_relations_without_caching
[0m14:54:44.440778 [debug] [ThreadPool]: Postgres adapter: Rolling back transaction.
[0m14:54:44.441973 [debug] [ThreadPool]: On list_DBT_DATABASE_public: No close available on handle
[0m14:54:44.444760 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:54:44.446760 [debug] [MainThread]: Connection 'list_DBT_DATABASE_public' was properly closed.
[0m14:54:44.447757 [error] [MainThread]: Encountered an error:
Database Error
  connection to server at "localhost" (::1), port 5432 failed: FATAL:  password authentication failed for user "DBT_USER"
  
[0m14:54:44.451765 [debug] [MainThread]: Command `dbt compile` failed at 14:54:44.450957 after 1.57 seconds
[0m14:54:44.453017 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D7977B6A20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D7978FF470>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D797FA7320>]}
[0m14:54:44.453818 [debug] [MainThread]: Flushing usage events
[0m14:58:41.834684 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E86FE33E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E86D7D7F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E86FE3E30>]}


============================== 14:58:41.844686 | 9862bbbe-79fc-423f-a553-6ea9f961d01f ==============================
[0m14:58:41.844686 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:58:41.847965 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt compile -s test', 'send_anonymous_usage_stats': 'True'}
[0m14:58:42.004389 [error] [MainThread]: Encountered an error:
Runtime Error
  Credentials in profile "kasper", target "dev" invalid: 1234 is not of type 'string'
[0m14:58:42.008384 [debug] [MainThread]: Command `dbt compile` failed at 14:58:42.008384 after 0.53 seconds
[0m14:58:42.011392 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E86E9A750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E86D7D7F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E870A8E00>]}
[0m14:58:42.013386 [debug] [MainThread]: Flushing usage events
[0m14:59:15.473190 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E0E8B1940>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E0E8B18B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E0E8B3E90>]}


============================== 14:59:15.483193 | 70c06da4-dd05-4ecc-9ee7-65edfd812b08 ==============================
[0m14:59:15.483193 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:59:15.486241 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt compile -s test', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m14:59:15.878140 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '70c06da4-dd05-4ecc-9ee7-65edfd812b08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E0E908A40>]}
[0m14:59:16.042676 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '70c06da4-dd05-4ecc-9ee7-65edfd812b08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E0E909E20>]}
[0m14:59:16.046676 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:59:16.071746 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:59:16.118741 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m14:59:16.120742 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '70c06da4-dd05-4ecc-9ee7-65edfd812b08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E0EA335F0>]}
[0m14:59:17.728425 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '70c06da4-dd05-4ecc-9ee7-65edfd812b08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E0E5476E0>]}
[0m14:59:17.743428 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '70c06da4-dd05-4ecc-9ee7-65edfd812b08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E0EE365D0>]}
[0m14:59:17.744424 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m14:59:17.745429 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '70c06da4-dd05-4ecc-9ee7-65edfd812b08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E0EE2CCB0>]}
[0m14:59:17.749440 [info ] [MainThread]: 
[0m14:59:17.751428 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m14:59:17.754538 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m14:59:17.772536 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:59:17.773800 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m14:59:17.775540 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:59:17.882038 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m14:59:17.884049 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:59:17.885051 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m14:59:17.907049 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m14:59:17.909050 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m14:59:17.911055 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m14:59:17.925053 [debug] [MainThread]: Using postgres connection "master"
[0m14:59:17.926092 [debug] [MainThread]: On master: BEGIN
[0m14:59:17.927053 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:59:18.024053 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m14:59:18.025054 [debug] [MainThread]: Using postgres connection "master"
[0m14:59:18.027054 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m14:59:18.048047 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m14:59:18.052051 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '70c06da4-dd05-4ecc-9ee7-65edfd812b08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E0E909190>]}
[0m14:59:18.054053 [debug] [MainThread]: On master: ROLLBACK
[0m14:59:18.055545 [debug] [MainThread]: On master: Close
[0m14:59:18.058050 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:59:18.062057 [info ] [MainThread]: 
[0m14:59:18.074051 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m14:59:18.077059 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m14:59:18.078058 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m14:59:18.104057 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m14:59:18.109053 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 14:59:18.079058 => 14:59:18.108049
[0m14:59:18.111057 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m14:59:18.113052 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 14:59:18.112200 => 14:59:18.112200
[0m14:59:18.118058 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m14:59:18.121051 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:59:18.122050 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m14:59:18.123053 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m14:59:18.125053 [debug] [MainThread]: Command end result
[0m14:59:18.141052 [info ] [MainThread]: Compiled node 'test' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published_ as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                
				ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                
				ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                
				ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
[0m14:59:18.145051 [debug] [MainThread]: Command `dbt compile` succeeded at 14:59:18.145051 after 2.87 seconds
[0m14:59:18.147050 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E08295610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E0E8B3E90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E0E8B16D0>]}
[0m14:59:18.148312 [debug] [MainThread]: Flushing usage events
[0m16:21:33.965537 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B55A2B3680>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B55A2B3020>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B55A2B3410>]}


============================== 16:21:33.973533 | 07810003-65c3-41e3-94f2-5a5fcf2f265d ==============================
[0m16:21:33.973533 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:21:33.975535 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s test', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:21:34.249531 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '07810003-65c3-41e3-94f2-5a5fcf2f265d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B55A379130>]}
[0m16:21:34.372532 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '07810003-65c3-41e3-94f2-5a5fcf2f265d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B55A0988F0>]}
[0m16:21:34.374534 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:21:34.390532 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:21:34.512536 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:21:34.513535 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:21:34.683531 [error] [MainThread]: Encountered an error:
'Undefined' object cannot be interpreted as an integer
[0m16:21:34.691533 [error] [MainThread]: Traceback (most recent call last):
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 91, in wrapper
    result, success = func(*args, **kwargs)
                      ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 76, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 169, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 198, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 245, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 271, in wrapper
    ctx.obj["manifest"] = parse_manifest(
                          ^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\manifest.py", line 1790, in parse_manifest
    manifest = ManifestLoader.get_full_manifest(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\manifest.py", line 318, in get_full_manifest
    manifest = loader.load()
               ^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\manifest.py", line 478, in load
    self.parse_project(
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\manifest.py", line 674, in parse_project
    parser.parse_file(block)
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\base.py", line 483, in parse_file
    self.parse_node(file_block)
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\base.py", line 444, in parse_node
    self.render_update(node, config)
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\models.py", line 360, in render_update
    super().render_update(node, config)
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\base.py", line 420, in render_update
    context = self.render_with_context(node, config)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\base.py", line 269, in render_with_context
    get_rendered(parsed_node.raw_code, context, parsed_node, capture_macros=True)
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\clients\jinja.py", line 600, in get_rendered
    rendered = render_template(template, ctx, node)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\clients\jinja.py", line 546, in render_template
    return template.render(ctx)
           ^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\jinja2\environment.py", line 1301, in render
    self.environment.handle_exception()
  File "C:\Users\hp\dbt\Lib\site-packages\jinja2\environment.py", line 936, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "<template>", line 30, in top-level template code
  File "C:\Users\hp\dbt\Lib\site-packages\jinja2\sandbox.py", line 393, in call
    return __context.call(__obj, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\jinja2\sandbox.py", line 101, in safe_range
    rng = range(*args)
          ^^^^^^^^^^^^
TypeError: 'Undefined' object cannot be interpreted as an integer

[0m16:21:34.695536 [debug] [MainThread]: Command `dbt compile` failed at 16:21:34.695536 after 0.94 seconds
[0m16:21:34.696540 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B553C25610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B559644DA0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B55A308EF0>]}
[0m16:21:34.697536 [debug] [MainThread]: Flushing usage events
[0m16:23:00.997481 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000242B92832F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000242B92822A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000242B92827B0>]}


============================== 16:23:01.003481 | 1ca6bcd0-8648-48c5-be88-fa175796be24 ==============================
[0m16:23:01.003481 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:23:01.005486 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt compile -s test', 'send_anonymous_usage_stats': 'True'}
[0m16:23:01.257480 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1ca6bcd0-8648-48c5-be88-fa175796be24', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000242B92D9A30>]}
[0m16:23:01.373482 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1ca6bcd0-8648-48c5-be88-fa175796be24', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000242B906AE70>]}
[0m16:23:01.375482 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:23:01.388480 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:23:01.469479 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:23:01.470485 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:23:01.630484 [error] [MainThread]: Encountered an error:
'Undefined' object cannot be interpreted as an integer
[0m16:23:01.636481 [error] [MainThread]: Traceback (most recent call last):
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 91, in wrapper
    result, success = func(*args, **kwargs)
                      ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 76, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 169, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 198, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 245, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 271, in wrapper
    ctx.obj["manifest"] = parse_manifest(
                          ^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\manifest.py", line 1790, in parse_manifest
    manifest = ManifestLoader.get_full_manifest(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\manifest.py", line 318, in get_full_manifest
    manifest = loader.load()
               ^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\manifest.py", line 478, in load
    self.parse_project(
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\manifest.py", line 674, in parse_project
    parser.parse_file(block)
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\base.py", line 483, in parse_file
    self.parse_node(file_block)
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\base.py", line 444, in parse_node
    self.render_update(node, config)
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\models.py", line 360, in render_update
    super().render_update(node, config)
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\base.py", line 420, in render_update
    context = self.render_with_context(node, config)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\base.py", line 269, in render_with_context
    get_rendered(parsed_node.raw_code, context, parsed_node, capture_macros=True)
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\clients\jinja.py", line 600, in get_rendered
    rendered = render_template(template, ctx, node)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\clients\jinja.py", line 546, in render_template
    return template.render(ctx)
           ^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\jinja2\environment.py", line 1301, in render
    self.environment.handle_exception()
  File "C:\Users\hp\dbt\Lib\site-packages\jinja2\environment.py", line 936, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "<template>", line 22, in top-level template code
  File "C:\Users\hp\dbt\Lib\site-packages\jinja2\sandbox.py", line 393, in call
    return __context.call(__obj, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\jinja2\sandbox.py", line 101, in safe_range
    rng = range(*args)
          ^^^^^^^^^^^^
TypeError: 'Undefined' object cannot be interpreted as an integer

[0m16:23:01.640488 [debug] [MainThread]: Command `dbt compile` failed at 16:23:01.640488 after 0.79 seconds
[0m16:23:01.641487 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000242B2BB5610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000242B976AF60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000242B970EF30>]}
[0m16:23:01.642485 [debug] [MainThread]: Flushing usage events
[0m16:23:26.936620 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000244AFA53AD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000244AFA51820>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000244AFA52CF0>]}


============================== 16:23:26.942620 | 71c339bc-b3a2-4172-a0a5-d6b2822b1290 ==============================
[0m16:23:26.942620 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:23:26.944622 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt compile -s test', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m16:23:27.199938 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '71c339bc-b3a2-4172-a0a5-d6b2822b1290', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000244AFAA8C50>]}
[0m16:23:27.316942 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '71c339bc-b3a2-4172-a0a5-d6b2822b1290', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000244AFB326C0>]}
[0m16:23:27.318946 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:23:27.332939 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:23:27.418942 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:23:27.419944 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:23:27.587954 [error] [MainThread]: Encountered an error:
Compilation Error in model test (models\test.sql)
  expected token ':', got '}'
    line 22
      {% for i in range(len({{count}})) %}
[0m16:23:27.590962 [debug] [MainThread]: Command `dbt compile` failed at 16:23:27.589962 after 0.79 seconds
[0m16:23:27.591960 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000244AF806000>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000244AFD9EE70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000244AFF5EBA0>]}
[0m16:23:27.592958 [debug] [MainThread]: Flushing usage events
[0m16:24:14.571963 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DC20793D10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DC20792BD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DC20793CB0>]}


============================== 16:24:14.581966 | e026d525-2c50-4522-b37d-467f30b92540 ==============================
[0m16:24:14.581966 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:24:14.583964 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt compile -s test', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:24:15.010958 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e026d525-2c50-4522-b37d-467f30b92540', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DC20793260>]}
[0m16:24:15.128960 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e026d525-2c50-4522-b37d-467f30b92540', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DC207B4230>]}
[0m16:24:15.130962 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:24:15.145964 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:24:15.253001 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:24:15.254984 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:24:15.439984 [error] [MainThread]: Encountered an error:
Compilation Error in model test (models\test.sql)
  expected token ':', got '}'
    line 22
      {% for i in range(len({count})) %}
[0m16:24:15.442982 [debug] [MainThread]: Command `dbt compile` failed at 16:24:15.441984 after 1.03 seconds
[0m16:24:15.442982 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DC20793D10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DC20A41700>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DC20A41820>]}
[0m16:24:15.444981 [debug] [MainThread]: Flushing usage events
[0m16:27:49.896311 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002533A8035F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002533A801910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002533A801B20>]}


============================== 16:27:49.901309 | ceea629c-b5c8-48a8-b112-44865c508ad3 ==============================
[0m16:27:49.901309 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:27:49.903313 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt compile -s test', 'send_anonymous_usage_stats': 'True'}
[0m16:27:50.160310 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ceea629c-b5c8-48a8-b112-44865c508ad3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002533A8E7140>]}
[0m16:27:50.277311 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ceea629c-b5c8-48a8-b112-44865c508ad3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002533A8267B0>]}
[0m16:27:50.279309 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:27:50.293314 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:27:50.374309 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:27:50.375313 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:27:50.532332 [error] [MainThread]: Encountered an error:
Compilation Error in model test (models\test.sql)
  unexpected ')'
    line 22
      {% for i in range(count | lenght)) %}
[0m16:27:50.535313 [debug] [MainThread]: Command `dbt compile` failed at 16:27:50.534317 after 0.83 seconds
[0m16:27:50.536333 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002533A6954C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002533AAA3AD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002533AD0E5A0>]}
[0m16:27:50.537325 [debug] [MainThread]: Flushing usage events
[0m16:28:08.126798 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AC0F7B1D30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AC0F5FF920>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AC0F7B2840>]}


============================== 16:28:08.131800 | 396843b7-f4ed-4202-acb1-b6a2931ad54d ==============================
[0m16:28:08.131800 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:28:08.133802 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt compile -s test', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m16:28:08.388991 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '396843b7-f4ed-4202-acb1-b6a2931ad54d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AC0F808830>]}
[0m16:28:08.507992 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '396843b7-f4ed-4202-acb1-b6a2931ad54d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AC0F442E70>]}
[0m16:28:08.509996 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:28:08.523993 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:28:08.603991 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:28:08.604993 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:28:08.764995 [error] [MainThread]: Encountered an error:
Compilation Error in model test (models\test.sql)
  No filter named 'lenght'.
    line 22
      {% for i in range(count | lenght) %}
[0m16:28:08.767000 [debug] [MainThread]: Command `dbt compile` failed at 16:28:08.767000 after 0.77 seconds
[0m16:28:08.767996 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AC0F59AF60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AC0F7B1D30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AC0F7B1130>]}
[0m16:28:08.769002 [debug] [MainThread]: Flushing usage events
[0m16:28:22.981749 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002481C741850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002481C741880>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002481C7428D0>]}


============================== 16:28:22.987749 | 0a107a2d-e350-4df4-bf37-5114f80521f8 ==============================
[0m16:28:22.987749 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:28:22.989750 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s test', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:28:23.242751 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0a107a2d-e350-4df4-bf37-5114f80521f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002481C798470>]}
[0m16:28:23.361750 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0a107a2d-e350-4df4-bf37-5114f80521f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002481C7690D0>]}
[0m16:28:23.363748 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:28:23.376746 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:28:23.463776 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:28:23.465779 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:28:23.659777 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0a107a2d-e350-4df4-bf37-5114f80521f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002481CA1A2D0>]}
[0m16:28:23.681799 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0a107a2d-e350-4df4-bf37-5114f80521f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002481CAE93D0>]}
[0m16:28:23.682800 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m16:28:23.684798 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0a107a2d-e350-4df4-bf37-5114f80521f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002481CC79910>]}
[0m16:28:23.687819 [info ] [MainThread]: 
[0m16:28:23.689798 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m16:28:23.691797 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m16:28:23.706794 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:28:23.707796 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m16:28:23.708799 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:28:23.769870 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m16:28:23.770874 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:28:23.771873 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m16:28:23.780868 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m16:28:23.782871 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m16:28:23.783871 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m16:28:23.790872 [debug] [MainThread]: Using postgres connection "master"
[0m16:28:23.791871 [debug] [MainThread]: On master: BEGIN
[0m16:28:23.791871 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:28:23.841870 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:28:23.841870 [debug] [MainThread]: Using postgres connection "master"
[0m16:28:23.842869 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m16:28:23.854870 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m16:28:23.857873 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0a107a2d-e350-4df4-bf37-5114f80521f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002481CB8B110>]}
[0m16:28:23.858873 [debug] [MainThread]: On master: ROLLBACK
[0m16:28:23.859877 [debug] [MainThread]: On master: Close
[0m16:28:23.860875 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:28:23.862873 [info ] [MainThread]: 
[0m16:28:23.868869 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m16:28:23.870871 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m16:28:23.870871 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m16:28:23.883874 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m16:28:23.885873 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 16:28:23.871869 => 16:28:23.884883
[0m16:28:23.886874 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m16:28:23.887873 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 16:28:23.887873 => 16:28:23.887873
[0m16:28:23.889873 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m16:28:23.890871 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:28:23.891870 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m16:28:23.892872 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m16:28:23.893872 [debug] [MainThread]: Command end result
[0m16:28:23.903872 [info ] [MainThread]: Compiled node 'test' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published_ as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
				ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
				ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
				ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
[0m16:28:23.907875 [debug] [MainThread]: Command `dbt compile` succeeded at 16:28:23.907875 after 1.06 seconds
[0m16:28:23.909875 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002481C741880>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002481C741850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002481C76BAD0>]}
[0m16:28:23.910871 [debug] [MainThread]: Flushing usage events
[0m16:29:32.361530 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024919603CB0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024918BC57F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024919603FB0>]}


============================== 16:29:32.366528 | 200cdd7a-8bef-42c1-8f77-6c5b0e5f0a13 ==============================
[0m16:29:32.366528 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:29:32.368534 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s test', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:29:32.619527 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '200cdd7a-8bef-42c1-8f77-6c5b0e5f0a13', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024919658260>]}
[0m16:29:32.735529 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '200cdd7a-8bef-42c1-8f77-6c5b0e5f0a13', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000249191C9C10>]}
[0m16:29:32.736531 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:29:32.751528 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:29:32.848528 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:29:32.849532 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:29:33.053558 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '200cdd7a-8bef-42c1-8f77-6c5b0e5f0a13', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024919ACFF20>]}
[0m16:29:33.067589 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '200cdd7a-8bef-42c1-8f77-6c5b0e5f0a13', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000249199A96A0>]}
[0m16:29:33.068560 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m16:29:33.070563 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '200cdd7a-8bef-42c1-8f77-6c5b0e5f0a13', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024919A7E540>]}
[0m16:29:33.073577 [info ] [MainThread]: 
[0m16:29:33.075561 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m16:29:33.077559 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m16:29:33.092559 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:29:33.092559 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m16:29:33.093560 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:29:33.150563 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m16:29:33.151560 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:29:33.151560 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m16:29:33.160558 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m16:29:33.162558 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m16:29:33.162558 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m16:29:33.169558 [debug] [MainThread]: Using postgres connection "master"
[0m16:29:33.170560 [debug] [MainThread]: On master: BEGIN
[0m16:29:33.170560 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:29:33.220560 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:29:33.220560 [debug] [MainThread]: Using postgres connection "master"
[0m16:29:33.221562 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m16:29:33.230556 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m16:29:33.233562 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '200cdd7a-8bef-42c1-8f77-6c5b0e5f0a13', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002491932DDC0>]}
[0m16:29:33.234560 [debug] [MainThread]: On master: ROLLBACK
[0m16:29:33.235559 [debug] [MainThread]: On master: Close
[0m16:29:33.236560 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:29:33.238567 [info ] [MainThread]: 
[0m16:29:33.244556 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m16:29:33.245558 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m16:29:33.246557 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m16:29:33.261557 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m16:29:33.263559 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 16:29:33.246557 => 16:29:33.262558
[0m16:29:33.264559 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m16:29:33.265560 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 16:29:33.265560 => 16:29:33.265560
[0m16:29:33.267558 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m16:29:33.269558 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:29:33.271560 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m16:29:33.272562 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m16:29:33.273559 [debug] [MainThread]: Command end result
[0m16:29:33.284562 [info ] [MainThread]: Compiled node 'test' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published_ as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                
				WHEN categories 
                
				WHEN categories 
                
				WHEN categories 
                
				WHEN categories 
                
				ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                
				WHEN tags 
                
				WHEN tags 
                
				WHEN tags 
                
				ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                
				WHEN tag_r 
                
				WHEN tag_r 
                
				WHEN tag_r 
                
				WHEN tag_r 
                
				WHEN tag_r 
                
				ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
[0m16:29:33.290557 [debug] [MainThread]: Command `dbt compile` succeeded at 16:29:33.289560 after 1.07 seconds
[0m16:29:33.291560 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000249195107A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002491932DAF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024918BC57F0>]}
[0m16:29:33.293569 [debug] [MainThread]: Flushing usage events
[0m16:30:40.757084 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F376B32810>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F376B30E00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F376B32390>]}


============================== 16:30:40.763085 | dcb0bd89-e106-4f57-9ba3-cf0e81bb970a ==============================
[0m16:30:40.763085 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:30:40.765088 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt compile -s test', 'send_anonymous_usage_stats': 'True'}
[0m16:30:41.056089 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'dcb0bd89-e106-4f57-9ba3-cf0e81bb970a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F376B886E0>]}
[0m16:30:41.194087 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'dcb0bd89-e106-4f57-9ba3-cf0e81bb970a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F376B88980>]}
[0m16:30:41.196092 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:30:41.210087 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:30:41.311083 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:30:41.312086 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:30:41.534087 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'dcb0bd89-e106-4f57-9ba3-cf0e81bb970a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F37701AA20>]}
[0m16:30:41.550087 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'dcb0bd89-e106-4f57-9ba3-cf0e81bb970a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F376EF9400>]}
[0m16:30:41.551088 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m16:30:41.553092 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'dcb0bd89-e106-4f57-9ba3-cf0e81bb970a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F376FCE750>]}
[0m16:30:41.556098 [info ] [MainThread]: 
[0m16:30:41.558086 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m16:30:41.560086 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m16:30:41.578083 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:30:41.579089 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m16:30:41.580087 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:30:41.645088 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m16:30:41.646086 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:30:41.647084 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m16:30:41.657087 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m16:30:41.659086 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m16:30:41.660084 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m16:30:41.669089 [debug] [MainThread]: Using postgres connection "master"
[0m16:30:41.669089 [debug] [MainThread]: On master: BEGIN
[0m16:30:41.670091 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:30:41.726089 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:30:41.727088 [debug] [MainThread]: Using postgres connection "master"
[0m16:30:41.728087 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m16:30:41.739084 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m16:30:41.742091 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'dcb0bd89-e106-4f57-9ba3-cf0e81bb970a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F37615AA20>]}
[0m16:30:41.743091 [debug] [MainThread]: On master: ROLLBACK
[0m16:30:41.744089 [debug] [MainThread]: On master: Close
[0m16:30:41.746088 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:30:41.748089 [info ] [MainThread]: 
[0m16:30:41.755087 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m16:30:41.757092 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m16:30:41.757092 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m16:30:41.782090 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m16:30:41.786089 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 16:30:41.758088 => 16:30:41.785091
[0m16:30:41.787092 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m16:30:41.789090 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 16:30:41.788091 => 16:30:41.788091
[0m16:30:41.791088 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m16:30:41.793088 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:30:41.794091 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m16:30:41.794091 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m16:30:41.796090 [debug] [MainThread]: Command end result
[0m16:30:41.807090 [info ] [MainThread]: Compiled node 'test' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published_ as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                
				WHEN categories like Fodsundhed og samfund then Fodsundhed og samfund
                
				WHEN categories like Forebyggelse then Forebyggelse
                
				WHEN categories like Forskning og viden then Forskning og viden
                
				WHEN categories like Praksis then Praksis
                
				ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                
				WHEN tags like Hjælp mig med at forstå then Hjælp mig med at forstå
                
				WHEN tags like Inspirer mig then Inspirer mig
                
				WHEN tags like Giv mig en fordel then Giv mig en fordel
                
				ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                
				WHEN tag_r like Long read then Long read
                
				WHEN tag_r like Kort og godt then Kort og godt
                
				WHEN tag_r like Q&amp then Q&amp
                
				WHEN tag_r like Best Practice then Best Practice
                
				WHEN tag_r like Viden og forskning then Viden og forskning
                
				ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
[0m16:30:41.813087 [debug] [MainThread]: Command `dbt compile` succeeded at 16:30:41.813087 after 1.22 seconds
[0m16:30:41.815090 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F3768CD6A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F376076F30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F376A0CA10>]}
[0m16:30:41.818088 [debug] [MainThread]: Flushing usage events
[0m16:31:42.981544 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000213920C2F30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000213920C20C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000213920C2990>]}


============================== 16:31:42.987543 | d0b2f2ee-62ca-411b-a264-7293798cc95d ==============================
[0m16:31:42.987543 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:31:42.988544 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt compile -s test', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m16:31:43.247543 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd0b2f2ee-62ca-411b-a264-7293798cc95d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000213922D7FB0>]}
[0m16:31:43.365953 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd0b2f2ee-62ca-411b-a264-7293798cc95d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000213920E6630>]}
[0m16:31:43.367954 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:31:43.380951 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:31:43.471950 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:31:43.472956 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:31:43.668952 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd0b2f2ee-62ca-411b-a264-7293798cc95d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000213925DDD90>]}
[0m16:31:43.681958 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd0b2f2ee-62ca-411b-a264-7293798cc95d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002139250A0F0>]}
[0m16:31:43.682956 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m16:31:43.684968 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd0b2f2ee-62ca-411b-a264-7293798cc95d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021392652F60>]}
[0m16:31:43.687961 [info ] [MainThread]: 
[0m16:31:43.689954 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m16:31:43.691953 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m16:31:43.706952 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:31:43.707952 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m16:31:43.708952 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:31:43.762954 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m16:31:43.762954 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:31:43.763952 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m16:31:43.771954 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m16:31:43.774957 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m16:31:43.775953 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m16:31:43.781955 [debug] [MainThread]: Using postgres connection "master"
[0m16:31:43.782958 [debug] [MainThread]: On master: BEGIN
[0m16:31:43.783957 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:31:43.833022 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:31:43.833022 [debug] [MainThread]: Using postgres connection "master"
[0m16:31:43.833955 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m16:31:43.842953 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m16:31:43.846954 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd0b2f2ee-62ca-411b-a264-7293798cc95d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021391B46C90>]}
[0m16:31:43.846954 [debug] [MainThread]: On master: ROLLBACK
[0m16:31:43.847954 [debug] [MainThread]: On master: Close
[0m16:31:43.849953 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:31:43.851957 [info ] [MainThread]: 
[0m16:31:43.856953 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m16:31:43.857953 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m16:31:43.858954 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m16:31:43.876482 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m16:31:43.878484 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 16:31:43.859955 => 16:31:43.877481
[0m16:31:43.879483 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m16:31:43.880482 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 16:31:43.880482 => 16:31:43.880482
[0m16:31:43.883482 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m16:31:43.885480 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:31:43.885480 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m16:31:43.886481 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m16:31:43.888482 [debug] [MainThread]: Command end result
[0m16:31:43.898481 [info ] [MainThread]: Compiled node 'test' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published_ as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                
				WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                
				WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                
				WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                
				WHEN categories like "%Praksis%" then "Praksis"
                
				ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                
				WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                
				WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                
				WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                
				ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                
				WHEN tag_r like "%Long read%" then "Long read"
                
				WHEN tag_r like "%Kort og godt%" then "Kort og godt"
                
				WHEN tag_r like "%Q&amp%" then "Q&amp"
                
				WHEN tag_r like "%Best Practice%" then "Best Practice"
                
				WHEN tag_r like "%Viden og forskning%" then "Viden og forskning"
                
				ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
[0m16:31:43.903481 [debug] [MainThread]: Command `dbt compile` succeeded at 16:31:43.903481 after 1.07 seconds
[0m16:31:43.905483 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002138F1C54C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021392706150>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000213920C2CC0>]}
[0m16:31:43.906494 [debug] [MainThread]: Flushing usage events
[0m16:33:45.852085 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002807A3621E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002807A361CA0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002807A360E90>]}


============================== 16:33:45.857084 | 30c888c6-511f-417c-92c0-07b2d43dcc12 ==============================
[0m16:33:45.857084 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:33:45.859092 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s test', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m16:33:46.115086 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '30c888c6-511f-417c-92c0-07b2d43dcc12', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002807A4477A0>]}
[0m16:33:46.231110 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '30c888c6-511f-417c-92c0-07b2d43dcc12', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002807940EF30>]}
[0m16:33:46.233088 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:33:46.247087 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:33:46.341083 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:33:46.342089 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:33:46.500085 [error] [MainThread]: Encountered an error:
Compilation Error in model test (models\test.sql)
  Encountered unknown tag 'endfor'.
    line 38
      {% endfor %}
[0m16:33:46.503092 [debug] [MainThread]: Command `dbt compile` failed at 16:33:46.502099 after 0.84 seconds
[0m16:33:46.504087 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002807A17B6B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002807A629FD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002807A81E990>]}
[0m16:33:46.505094 [debug] [MainThread]: Flushing usage events
[0m16:34:19.999745 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002324C1F18B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002324BF8D7F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002324C03F920>]}


============================== 16:34:20.004744 | 24be1dfe-87b6-4892-ac9f-dead2e8746ab ==============================
[0m16:34:20.004744 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:34:20.006759 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s test', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:34:20.259746 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '24be1dfe-87b6-4892-ac9f-dead2e8746ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002324C1F0CB0>]}
[0m16:34:20.377745 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '24be1dfe-87b6-4892-ac9f-dead2e8746ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002324C216990>]}
[0m16:34:20.379745 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:34:20.393743 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:34:20.480743 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:34:20.481747 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:34:20.674746 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '24be1dfe-87b6-4892-ac9f-dead2e8746ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002324C6BFC50>]}
[0m16:34:20.689508 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '24be1dfe-87b6-4892-ac9f-dead2e8746ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002324C5E9850>]}
[0m16:34:20.690515 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m16:34:20.692528 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '24be1dfe-87b6-4892-ac9f-dead2e8746ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002324C6F7860>]}
[0m16:34:20.694510 [info ] [MainThread]: 
[0m16:34:20.697509 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m16:34:20.699506 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m16:34:20.715505 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:34:20.716507 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m16:34:20.716507 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:34:20.773508 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m16:34:20.774511 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:34:20.775512 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m16:34:20.783506 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m16:34:20.784506 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m16:34:20.785505 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m16:34:20.792505 [debug] [MainThread]: Using postgres connection "master"
[0m16:34:20.793507 [debug] [MainThread]: On master: BEGIN
[0m16:34:20.793507 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:34:20.843507 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:34:20.843507 [debug] [MainThread]: Using postgres connection "master"
[0m16:34:20.844508 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m16:34:20.853503 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m16:34:20.857505 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '24be1dfe-87b6-4892-ac9f-dead2e8746ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002324BC76CC0>]}
[0m16:34:20.858505 [debug] [MainThread]: On master: ROLLBACK
[0m16:34:20.858505 [debug] [MainThread]: On master: Close
[0m16:34:20.860507 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:34:20.862519 [info ] [MainThread]: 
[0m16:34:20.869504 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m16:34:20.870508 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m16:34:20.871506 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m16:34:20.886505 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m16:34:20.888508 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 16:34:20.871506 => 16:34:20.888508
[0m16:34:20.890505 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m16:34:20.891505 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 16:34:20.891505 => 16:34:20.891505
[0m16:34:20.893505 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m16:34:20.895505 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:34:20.896507 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m16:34:20.896507 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m16:34:20.898506 [debug] [MainThread]: Command end result
[0m16:34:20.909507 [info ] [MainThread]: Compiled node 'test' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published_ as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
				WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                
				WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                
				WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                
				WHEN categories like "%Praksis%" then "Praksis"
                
				ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
				WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                
				WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                
				WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                
				ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
				WHEN tag_r like "%Long read%" then "Long read"
                
				WHEN tag_r like "%Kort og godt%" then "Kort og godt"
                
				WHEN tag_r like "%Q&amp%" then "Q&amp"
                
				WHEN tag_r like "%Best Practice%" then "Best Practice"
                
				WHEN tag_r like "%Viden og forskning%" then "Viden og forskning"
                
				ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
[0m16:34:20.915509 [debug] [MainThread]: Command `dbt compile` succeeded at 16:34:20.914512 after 1.05 seconds
[0m16:34:20.916506 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002324BFD8680>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002324C0CFC20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002324BF8D7F0>]}
[0m16:34:20.919547 [debug] [MainThread]: Flushing usage events
[0m16:34:54.280002 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0F92D1520>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0F873D7F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0F92D1760>]}


============================== 16:34:54.286001 | 1f32a607-e11b-4e4e-8c53-4605fddf8fda ==============================
[0m16:34:54.286001 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:34:54.288017 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s test', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:34:54.538998 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1f32a607-e11b-4e4e-8c53-4605fddf8fda', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0F9328830>]}
[0m16:34:54.659000 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1f32a607-e11b-4e4e-8c53-4605fddf8fda', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0F81CC5C0>]}
[0m16:34:54.661001 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:34:54.676001 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:34:54.778039 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:34:54.779042 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:34:54.978042 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1f32a607-e11b-4e4e-8c53-4605fddf8fda', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0F990D4C0>]}
[0m16:34:54.992043 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1f32a607-e11b-4e4e-8c53-4605fddf8fda', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0F9709550>]}
[0m16:34:54.993045 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m16:34:54.995052 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1f32a607-e11b-4e4e-8c53-4605fddf8fda', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0F97DF860>]}
[0m16:34:54.998055 [info ] [MainThread]: 
[0m16:34:55.001045 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m16:34:55.003042 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m16:34:55.017041 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:34:55.018046 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m16:34:55.019049 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:34:55.080043 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m16:34:55.081045 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:34:55.082049 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m16:34:55.090043 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m16:34:55.092043 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m16:34:55.093041 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m16:34:55.100042 [debug] [MainThread]: Using postgres connection "master"
[0m16:34:55.100042 [debug] [MainThread]: On master: BEGIN
[0m16:34:55.101043 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:34:55.154040 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:34:55.155047 [debug] [MainThread]: Using postgres connection "master"
[0m16:34:55.156044 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m16:34:55.166041 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m16:34:55.170043 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1f32a607-e11b-4e4e-8c53-4605fddf8fda', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0F8D53020>]}
[0m16:34:55.170043 [debug] [MainThread]: On master: ROLLBACK
[0m16:34:55.171043 [debug] [MainThread]: On master: Close
[0m16:34:55.173047 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:34:55.175052 [info ] [MainThread]: 
[0m16:34:55.182043 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m16:34:55.183044 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m16:34:55.184043 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m16:34:55.201049 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m16:34:55.204050 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 16:34:55.186045 => 16:34:55.202054
[0m16:34:55.206043 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m16:34:55.207045 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 16:34:55.207045 => 16:34:55.207045
[0m16:34:55.209044 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m16:34:55.211042 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:34:55.211042 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m16:34:55.212062 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m16:34:55.213044 [debug] [MainThread]: Command end result
[0m16:34:55.224045 [info ] [MainThread]: Compiled node 'test' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published_ as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASEWHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                
				ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASEWHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                
				ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASEWHEN tag_r like "%Long read%" then "Long read"
                WHEN tag_r like "%Kort og godt%" then "Kort og godt"
                WHEN tag_r like "%Q&amp%" then "Q&amp"
                WHEN tag_r like "%Best Practice%" then "Best Practice"
                WHEN tag_r like "%Viden og forskning%" then "Viden og forskning"
                
				ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
[0m16:34:55.229049 [debug] [MainThread]: Command `dbt compile` succeeded at 16:34:55.229049 after 1.08 seconds
[0m16:34:55.230046 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0F92D1760>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0F906D130>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0F873D7F0>]}
[0m16:34:55.231042 [debug] [MainThread]: Flushing usage events
[0m16:35:42.225034 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A444981610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A444983F80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A444983AA0>]}


============================== 16:35:42.230031 | d5af10cc-f397-4d6f-8f87-1289e0769e64 ==============================
[0m16:35:42.230031 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:35:42.232034 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s test', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m16:35:42.567079 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd5af10cc-f397-4d6f-8f87-1289e0769e64', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A444B45400>]}
[0m16:35:42.706080 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd5af10cc-f397-4d6f-8f87-1289e0769e64', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A4449A66C0>]}
[0m16:35:42.708082 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:35:42.723085 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:35:42.822082 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:35:42.823081 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:35:43.034081 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd5af10cc-f397-4d6f-8f87-1289e0769e64', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A444E4F410>]}
[0m16:35:43.049082 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd5af10cc-f397-4d6f-8f87-1289e0769e64', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A444D21490>]}
[0m16:35:43.050083 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m16:35:43.052089 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd5af10cc-f397-4d6f-8f87-1289e0769e64', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A444E9B230>]}
[0m16:35:43.056101 [info ] [MainThread]: 
[0m16:35:43.058081 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m16:35:43.060081 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m16:35:43.077120 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:35:43.078082 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m16:35:43.079081 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:35:43.145081 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m16:35:43.146082 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:35:43.146082 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m16:35:43.156080 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m16:35:43.158078 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m16:35:43.158078 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m16:35:43.167080 [debug] [MainThread]: Using postgres connection "master"
[0m16:35:43.168082 [debug] [MainThread]: On master: BEGIN
[0m16:35:43.169082 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:35:43.221082 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:35:43.222082 [debug] [MainThread]: Using postgres connection "master"
[0m16:35:43.223082 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m16:35:43.232079 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m16:35:43.235084 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd5af10cc-f397-4d6f-8f87-1289e0769e64', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A4439B6C30>]}
[0m16:35:43.236082 [debug] [MainThread]: On master: ROLLBACK
[0m16:35:43.237085 [debug] [MainThread]: On master: Close
[0m16:35:43.239085 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:35:43.241094 [info ] [MainThread]: 
[0m16:35:43.248080 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m16:35:43.249081 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m16:35:43.250081 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m16:35:43.267082 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m16:35:43.269083 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 16:35:43.250081 => 16:35:43.268081
[0m16:35:43.270081 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m16:35:43.273094 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 16:35:43.272096 => 16:35:43.272096
[0m16:35:43.276083 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m16:35:43.279080 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:35:43.279080 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m16:35:43.280084 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m16:35:43.281082 [debug] [MainThread]: Command end result
[0m16:35:43.294143 [info ] [MainThread]: Compiled node 'test' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published_ as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASEWHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"WHEN categories like "%Forebyggelse%" then "Forebyggelse"WHEN categories like "%Forskning og viden%" then "Forskning og viden"WHEN categories like "%Praksis%" then "Praksis"ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASEWHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"WHEN tags like "%Inspirer mig%" then "Inspirer mig"WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASEWHEN tag_r like "%Long read%" then "Long read"WHEN tag_r like "%Kort og godt%" then "Kort og godt"WHEN tag_r like "%Q&amp%" then "Q&amp"WHEN tag_r like "%Best Practice%" then "Best Practice"WHEN tag_r like "%Viden og forskning%" then "Viden og forskning"ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
[0m16:35:43.299084 [debug] [MainThread]: Command `dbt compile` succeeded at 16:35:43.299084 after 1.22 seconds
[0m16:35:43.301088 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A44483AE40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A4445E1DF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A4449A7C20>]}
[0m16:35:43.302085 [debug] [MainThread]: Flushing usage events
[0m16:36:15.008014 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D4C88E1A30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D4C88E3DA0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D4C88E3D40>]}


============================== 16:36:15.013013 | d802dc98-c807-4e99-a63f-f9db2dd4a44e ==============================
[0m16:36:15.013013 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:36:15.015023 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt compile -s test', 'send_anonymous_usage_stats': 'True'}
[0m16:36:15.267011 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd802dc98-c807-4e99-a63f-f9db2dd4a44e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D4C8AD9E20>]}
[0m16:36:15.382012 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd802dc98-c807-4e99-a63f-f9db2dd4a44e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D4C84E2E70>]}
[0m16:36:15.384013 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:36:15.398015 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:36:15.494013 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:36:15.495016 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:36:15.685014 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd802dc98-c807-4e99-a63f-f9db2dd4a44e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D4C8E2AF30>]}
[0m16:36:15.699016 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd802dc98-c807-4e99-a63f-f9db2dd4a44e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D4C8D09A90>]}
[0m16:36:15.700038 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m16:36:15.702021 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd802dc98-c807-4e99-a63f-f9db2dd4a44e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D4C88E37D0>]}
[0m16:36:15.705018 [info ] [MainThread]: 
[0m16:36:15.708018 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m16:36:15.710016 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m16:36:15.724094 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:36:15.726019 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m16:36:15.727015 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:36:15.784017 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m16:36:15.784017 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:36:15.785018 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m16:36:15.793015 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m16:36:15.795015 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m16:36:15.796014 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m16:36:15.803013 [debug] [MainThread]: Using postgres connection "master"
[0m16:36:15.804017 [debug] [MainThread]: On master: BEGIN
[0m16:36:15.805015 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:36:15.854015 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:36:15.854852 [debug] [MainThread]: Using postgres connection "master"
[0m16:36:15.855013 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m16:36:15.866017 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m16:36:15.869013 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd802dc98-c807-4e99-a63f-f9db2dd4a44e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D4C8366CF0>]}
[0m16:36:15.870015 [debug] [MainThread]: On master: ROLLBACK
[0m16:36:15.871015 [debug] [MainThread]: On master: Close
[0m16:36:15.872016 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:36:15.874023 [info ] [MainThread]: 
[0m16:36:15.881014 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m16:36:15.882013 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m16:36:15.883015 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m16:36:15.899012 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m16:36:15.901015 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 16:36:15.884012 => 16:36:15.900013
[0m16:36:15.902014 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m16:36:15.903016 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 16:36:15.903016 => 16:36:15.903016
[0m16:36:15.906021 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m16:36:15.908017 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:36:15.909019 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m16:36:15.909019 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m16:36:15.910017 [debug] [MainThread]: Command end result
[0m16:36:15.921016 [info ] [MainThread]: Compiled node 'test' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published_ as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"WHEN categories like "%Forebyggelse%" then "Forebyggelse"WHEN categories like "%Forskning og viden%" then "Forskning og viden"WHEN categories like "%Praksis%" then "Praksis"ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"WHEN tags like "%Inspirer mig%" then "Inspirer mig"WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tag_r like "%Long read%" then "Long read"WHEN tag_r like "%Kort og godt%" then "Kort og godt"WHEN tag_r like "%Q&amp%" then "Q&amp"WHEN tag_r like "%Best Practice%" then "Best Practice"WHEN tag_r like "%Viden og forskning%" then "Viden og forskning"ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
[0m16:36:15.926015 [debug] [MainThread]: Command `dbt compile` succeeded at 16:36:15.925021 after 1.05 seconds
[0m16:36:15.927014 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D4C22C5610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D4C88E1A90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D4C87BD130>]}
[0m16:36:15.929023 [debug] [MainThread]: Flushing usage events
[0m16:36:39.774125 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FB9E2540>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FB8F38F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FB9E1730>]}


============================== 16:36:39.780126 | aed3f36d-42db-4968-b826-5adf7fc95541 ==============================
[0m16:36:39.780126 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:36:39.782123 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt compile -s test', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m16:36:40.057118 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'aed3f36d-42db-4968-b826-5adf7fc95541', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FBA387D0>]}
[0m16:36:40.174121 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'aed3f36d-42db-4968-b826-5adf7fc95541', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FBAC6750>]}
[0m16:36:40.176124 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:36:40.192125 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:36:40.287122 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:36:40.288122 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:36:40.481118 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'aed3f36d-42db-4968-b826-5adf7fc95541', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FB874DA0>]}
[0m16:36:40.494122 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'aed3f36d-42db-4968-b826-5adf7fc95541', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FBE21910>]}
[0m16:36:40.495125 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m16:36:40.497124 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'aed3f36d-42db-4968-b826-5adf7fc95541', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FBC87710>]}
[0m16:36:40.500128 [info ] [MainThread]: 
[0m16:36:40.503125 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m16:36:40.504129 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m16:36:40.521120 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:36:40.521120 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m16:36:40.522122 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:36:40.578121 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m16:36:40.578121 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:36:40.579122 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m16:36:40.587124 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m16:36:40.589126 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m16:36:40.590126 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m16:36:40.598121 [debug] [MainThread]: Using postgres connection "master"
[0m16:36:40.599122 [debug] [MainThread]: On master: BEGIN
[0m16:36:40.600123 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:36:40.649122 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:36:40.649122 [debug] [MainThread]: Using postgres connection "master"
[0m16:36:40.651123 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m16:36:40.660121 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m16:36:40.664127 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'aed3f36d-42db-4968-b826-5adf7fc95541', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FB466E40>]}
[0m16:36:40.665127 [debug] [MainThread]: On master: ROLLBACK
[0m16:36:40.666122 [debug] [MainThread]: On master: Close
[0m16:36:40.667123 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:36:40.669124 [info ] [MainThread]: 
[0m16:36:40.675126 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m16:36:40.677123 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m16:36:40.678121 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m16:36:40.693122 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m16:36:40.694122 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 16:36:40.678121 => 16:36:40.694122
[0m16:36:40.696120 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m16:36:40.697125 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 16:36:40.697125 => 16:36:40.697125
[0m16:36:40.699125 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m16:36:40.702132 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:36:40.703122 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m16:36:40.703122 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m16:36:40.705122 [debug] [MainThread]: Command end result
[0m16:36:40.723153 [info ] [MainThread]: Compiled node 'test' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published_ as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tag_r like "%Long read%" then "Long read"
                WHEN tag_r like "%Kort og godt%" then "Kort og godt"
                WHEN tag_r like "%Q&amp%" then "Q&amp"
                WHEN tag_r like "%Best Practice%" then "Best Practice"
                WHEN tag_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
[0m16:36:40.728150 [debug] [MainThread]: Command `dbt compile` succeeded at 16:36:40.727153 after 1.08 seconds
[0m16:36:40.729149 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FB91DAF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FB8F38F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FBD11C40>]}
[0m16:36:40.730159 [debug] [MainThread]: Flushing usage events
[0m16:43:00.668811 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029BC0FC2630>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029BC04E57F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029BC0FC35C0>]}


============================== 16:43:00.673821 | 013706be-3180-40fa-ae7b-f24ddf69d236 ==============================
[0m16:43:00.673821 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:43:00.675817 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt compile -s test', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m16:43:00.937808 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '013706be-3180-40fa-ae7b-f24ddf69d236', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029BC1018230>]}
[0m16:43:01.060812 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '013706be-3180-40fa-ae7b-f24ddf69d236', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029BC0FE9B20>]}
[0m16:43:01.061817 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:43:01.077820 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:43:01.175813 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:43:01.176810 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:43:01.338811 [error] [MainThread]: Encountered an error:
Compilation Error in model test (models\test.sql)
  Unexpected end of template. Jinja was looking for the following tags: 'endfor' or 'else'. The innermost block that needs to be closed is 'for'.
    line 48
      last_30_days_article_published_third_{{ count[i] }}
[0m16:43:01.341811 [debug] [MainThread]: Command `dbt compile` failed at 16:43:01.341811 after 0.88 seconds
[0m16:43:01.343837 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029BC0ED3320>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029BC144F050>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029BC14D82F0>]}
[0m16:43:01.344819 [debug] [MainThread]: Flushing usage events
[0m16:43:51.376233 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B46201B20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B46203F20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B46202120>]}


============================== 16:43:51.382231 | 9ac0c29f-22d4-44c7-9650-ecdb9399e568 ==============================
[0m16:43:51.382231 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:43:51.384231 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt compile -s test', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m16:43:51.642232 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9ac0c29f-22d4-44c7-9650-ecdb9399e568', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B46202210>]}
[0m16:43:51.764231 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9ac0c29f-22d4-44c7-9650-ecdb9399e568', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B461E3F80>]}
[0m16:43:51.765237 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:43:51.781230 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:43:51.868229 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:43:51.869235 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:43:52.078512 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '9ac0c29f-22d4-44c7-9650-ecdb9399e568', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B463DC7A0>]}
[0m16:43:52.093513 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '9ac0c29f-22d4-44c7-9650-ecdb9399e568', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B465A51F0>]}
[0m16:43:52.094513 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m16:43:52.096517 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9ac0c29f-22d4-44c7-9650-ecdb9399e568', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B466F48C0>]}
[0m16:43:52.099527 [info ] [MainThread]: 
[0m16:43:52.101512 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m16:43:52.103512 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m16:43:52.119520 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:43:52.120513 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m16:43:52.120513 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:43:52.180513 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m16:43:52.181519 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:43:52.181519 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m16:43:52.190510 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m16:43:52.192516 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m16:43:52.193513 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m16:43:52.202512 [debug] [MainThread]: Using postgres connection "master"
[0m16:43:52.203513 [debug] [MainThread]: On master: BEGIN
[0m16:43:52.203513 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:43:52.252512 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:43:52.253539 [debug] [MainThread]: Using postgres connection "master"
[0m16:43:52.254518 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m16:43:52.264511 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m16:43:52.267514 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9ac0c29f-22d4-44c7-9650-ecdb9399e568', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B46375B50>]}
[0m16:43:52.268513 [debug] [MainThread]: On master: ROLLBACK
[0m16:43:52.269514 [debug] [MainThread]: On master: Close
[0m16:43:52.271512 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:43:52.273515 [info ] [MainThread]: 
[0m16:43:52.280516 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m16:43:52.282517 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m16:43:52.282517 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m16:43:52.300515 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m16:43:52.302516 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 16:43:52.283516 => 16:43:52.301517
[0m16:43:52.303515 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m16:43:52.304516 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 16:43:52.304516 => 16:43:52.304516
[0m16:43:52.305518 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m16:43:52.307516 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:43:52.309522 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m16:43:52.310530 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m16:43:52.311528 [debug] [MainThread]: Command end result
[0m16:43:52.322518 [info ] [MainThread]: Compiled node 'test' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published_ as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tag_r like "%Long read%" then "Long read"
                WHEN tag_r like "%Kort og godt%" then "Kort og godt"
                WHEN tag_r like "%Q&amp%" then "Q&amp"
                WHEN tag_r like "%Best Practice%" then "Best Practice"
                WHEN tag_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    ,
    with
    
    last_30_days_article_published_Agg_ as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        
        last_30_days_article_published_third_ 
		where siteid = ', site, '
		group by 1,2
        
        last_30_days_article_published_third_second 
		where siteid = ', site, '
		group by 1,2
        
        last_30_days_article_published_third_third 
		where siteid = ', site, '
		group by 1,2
        
    ),
    
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        
        last_30_days_article_published_third_ 
		where siteid = ', site, '
		group by 1,2
        
        last_30_days_article_published_third_second 
		where siteid = ', site, '
		group by 1,2
        
        last_30_days_article_published_third_third 
		where siteid = ', site, '
		group by 1,2
        
    ),
    
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        
        last_30_days_article_published_third_ 
		where siteid = ', site, '
		group by 1,2
        
        last_30_days_article_published_third_second 
		where siteid = ', site, '
		group by 1,2
        
        last_30_days_article_published_third_third 
		where siteid = ', site, '
		group by 1,2
        
    ),
    
[0m16:43:52.329520 [debug] [MainThread]: Command `dbt compile` succeeded at 16:43:52.328520 after 1.09 seconds
[0m16:43:52.330516 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B460B9730>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B457C5AF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B46227C50>]}
[0m16:43:52.332515 [debug] [MainThread]: Flushing usage events
[0m16:49:14.666731 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013555033680>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000135545557F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000135550334A0>]}


============================== 16:49:14.675731 | 102e0a1b-952a-4880-ab76-651b357df03c ==============================
[0m16:49:14.675731 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:49:14.677731 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'invocation_command': 'dbt compile -s test', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:49:15.034730 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '102e0a1b-952a-4880-ab76-651b357df03c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013555088440>]}
[0m16:49:15.178771 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '102e0a1b-952a-4880-ab76-651b357df03c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013553F2C170>]}
[0m16:49:15.180772 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:49:15.199771 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:49:15.311768 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:49:15.312771 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:49:15.472769 [error] [MainThread]: Encountered an error:
Compilation Error in model test (models\test.sql)
  unexpected char '!' at 1652
    line 47
      {% if !loop.last %}, {% endif%}
[0m16:49:15.475768 [debug] [MainThread]: Command `dbt compile` failed at 16:49:15.475768 after 1.03 seconds
[0m16:49:15.476771 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001354E965610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001355528DAC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013555333470>]}
[0m16:49:15.477785 [debug] [MainThread]: Flushing usage events
[0m16:49:32.469143 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AADDDB33E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AADDDB2B40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AADDDB28A0>]}


============================== 16:49:32.475143 | 411ad3b3-d638-4073-b7f5-d7485b965a67 ==============================
[0m16:49:32.475143 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:49:32.477148 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s test', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:49:32.730141 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '411ad3b3-d638-4073-b7f5-d7485b965a67', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AADD5018E0>]}
[0m16:49:32.847145 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '411ad3b3-d638-4073-b7f5-d7485b965a67', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AADD979E50>]}
[0m16:49:32.849142 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:49:32.866140 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:49:32.945144 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:49:32.946148 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:49:33.139171 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '411ad3b3-d638-4073-b7f5-d7485b965a67', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AADE279BE0>]}
[0m16:49:33.153175 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '411ad3b3-d638-4073-b7f5-d7485b965a67', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AADE159970>]}
[0m16:49:33.154176 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m16:49:33.156178 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '411ad3b3-d638-4073-b7f5-d7485b965a67', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AADD146AB0>]}
[0m16:49:33.160193 [info ] [MainThread]: 
[0m16:49:33.162188 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m16:49:33.164174 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m16:49:33.181175 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:49:33.182174 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m16:49:33.182174 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:49:33.242170 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m16:49:33.243177 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:49:33.244177 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m16:49:33.252172 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m16:49:33.254172 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m16:49:33.255172 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m16:49:33.263170 [debug] [MainThread]: Using postgres connection "master"
[0m16:49:33.264171 [debug] [MainThread]: On master: BEGIN
[0m16:49:33.265174 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:49:33.314171 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:49:33.315177 [debug] [MainThread]: Using postgres connection "master"
[0m16:49:33.316172 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m16:49:33.325170 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m16:49:33.328175 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '411ad3b3-d638-4073-b7f5-d7485b965a67', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AADDE7B290>]}
[0m16:49:33.329174 [debug] [MainThread]: On master: ROLLBACK
[0m16:49:33.330175 [debug] [MainThread]: On master: Close
[0m16:49:33.331179 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:49:33.333179 [info ] [MainThread]: 
[0m16:49:33.340171 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m16:49:33.341174 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m16:49:33.342178 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m16:49:33.359178 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m16:49:33.362186 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 16:49:33.344175 => 16:49:33.361191
[0m16:49:33.364175 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m16:49:33.365190 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 16:49:33.364175 => 16:49:33.364175
[0m16:49:33.366176 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m16:49:33.368171 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:49:33.369173 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m16:49:33.370175 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m16:49:33.371174 [debug] [MainThread]: Command end result
[0m16:49:33.382173 [info ] [MainThread]: Compiled node 'test' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published_ as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_ as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_ 
		where siteid = ', site, '
		group by 1,2
    )
    , 
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    )
    , 
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tag_r like "%Long read%" then "Long read"
                WHEN tag_r like "%Kort og godt%" then "Kort og godt"
                WHEN tag_r like "%Q&amp%" then "Q&amp"
                WHEN tag_r like "%Best Practice%" then "Best Practice"
                WHEN tag_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    )
    
    
[0m16:49:33.387174 [debug] [MainThread]: Command `dbt compile` succeeded at 16:49:33.387174 after 1.05 seconds
[0m16:49:33.388195 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AAD7725610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AADDDD7C50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AAD7800890>]}
[0m16:49:33.389177 [debug] [MainThread]: Flushing usage events
[0m16:50:32.074186 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023B7EA20680>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023B7EA23C20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023B7EA22990>]}


============================== 16:50:32.080188 | 7f19cab7-049d-47d8-a816-bb4e16c507cc ==============================
[0m16:50:32.080188 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:50:32.081190 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt compile -s test', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:50:32.353184 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '7f19cab7-049d-47d8-a816-bb4e16c507cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023B7EC2BCB0>]}
[0m16:50:32.482185 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '7f19cab7-049d-47d8-a816-bb4e16c507cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023B7E5EDE50>]}
[0m16:50:32.484189 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:50:32.499187 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:50:32.599183 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:50:32.601187 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:50:32.802190 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '7f19cab7-049d-47d8-a816-bb4e16c507cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023B7EFCD310>]}
[0m16:50:32.816190 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '7f19cab7-049d-47d8-a816-bb4e16c507cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023B7EDC56A0>]}
[0m16:50:32.817191 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m16:50:32.819189 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7f19cab7-049d-47d8-a816-bb4e16c507cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023B7E9322D0>]}
[0m16:50:32.822201 [info ] [MainThread]: 
[0m16:50:32.824191 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m16:50:32.826187 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m16:50:32.843188 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:50:32.844186 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m16:50:32.844186 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:50:32.905185 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m16:50:32.906189 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:50:32.906189 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m16:50:32.915190 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m16:50:32.917186 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m16:50:32.918188 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m16:50:32.927190 [debug] [MainThread]: Using postgres connection "master"
[0m16:50:32.928192 [debug] [MainThread]: On master: BEGIN
[0m16:50:32.928192 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:50:32.981191 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:50:32.982188 [debug] [MainThread]: Using postgres connection "master"
[0m16:50:32.983187 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m16:50:32.993185 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m16:50:32.996193 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7f19cab7-049d-47d8-a816-bb4e16c507cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023B7EA21D30>]}
[0m16:50:32.997193 [debug] [MainThread]: On master: ROLLBACK
[0m16:50:32.998190 [debug] [MainThread]: On master: Close
[0m16:50:33.000189 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:50:33.002196 [info ] [MainThread]: 
[0m16:50:33.009186 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m16:50:33.010187 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m16:50:33.011187 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m16:50:33.028189 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m16:50:33.030190 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 16:50:33.012188 => 16:50:33.030190
[0m16:50:33.032187 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m16:50:33.034194 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 16:50:33.033231 => 16:50:33.033231
[0m16:50:33.037201 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m16:50:33.039189 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:50:33.040190 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m16:50:33.041186 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m16:50:33.042191 [debug] [MainThread]: Command end result
[0m16:50:33.054191 [info ] [MainThread]: Compiled node 'test' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_ 
		where siteid = ', site, '
		group by 1,2
    )
    , 
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published__second 
		where siteid = ', site, '
		group by 1,2
    )
    , 
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tag_r like "%Long read%" then "Long read"
                WHEN tag_r like "%Kort og godt%" then "Kort og godt"
                WHEN tag_r like "%Q&amp%" then "Q&amp"
                WHEN tag_r like "%Best Practice%" then "Best Practice"
                WHEN tag_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published__third 
		where siteid = ', site, '
		group by 1,2
    )
    
    
[0m16:50:33.060188 [debug] [MainThread]: Command `dbt compile` succeeded at 16:50:33.059188 after 1.13 seconds
[0m16:50:33.061192 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023B7EA20680>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023B7EA22990>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023B7EA21F40>]}
[0m16:50:33.063196 [debug] [MainThread]: Flushing usage events
[0m16:55:26.397228 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B44CE830B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B44CB17920>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B44CE82FF0>]}


============================== 16:55:26.402227 | 26aa9bd9-f2c2-42bb-a59d-fb25ea5fabcc ==============================
[0m16:55:26.402227 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:55:26.404242 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt compile -s test', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:55:26.658229 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '26aa9bd9-f2c2-42bb-a59d-fb25ea5fabcc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B44CF48350>]}
[0m16:55:26.776239 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '26aa9bd9-f2c2-42bb-a59d-fb25ea5fabcc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B44CF492B0>]}
[0m16:55:26.778228 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:55:26.791228 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:55:26.881226 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:55:26.883231 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:55:27.082259 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '26aa9bd9-f2c2-42bb-a59d-fb25ea5fabcc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B44D3682C0>]}
[0m16:55:27.095258 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '26aa9bd9-f2c2-42bb-a59d-fb25ea5fabcc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B44D249520>]}
[0m16:55:27.096258 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m16:55:27.098267 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '26aa9bd9-f2c2-42bb-a59d-fb25ea5fabcc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B44D3DB5F0>]}
[0m16:55:27.101260 [info ] [MainThread]: 
[0m16:55:27.103258 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m16:55:27.105256 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m16:55:27.122255 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:55:27.123258 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m16:55:27.124258 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:55:27.182257 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m16:55:27.182257 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:55:27.183258 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m16:55:27.191257 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m16:55:27.193257 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m16:55:27.194257 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m16:55:27.201255 [debug] [MainThread]: Using postgres connection "master"
[0m16:55:27.201255 [debug] [MainThread]: On master: BEGIN
[0m16:55:27.202256 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:55:27.252254 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:55:27.253257 [debug] [MainThread]: Using postgres connection "master"
[0m16:55:27.254258 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m16:55:27.262255 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m16:55:27.265256 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '26aa9bd9-f2c2-42bb-a59d-fb25ea5fabcc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B44D2EABA0>]}
[0m16:55:27.266254 [debug] [MainThread]: On master: ROLLBACK
[0m16:55:27.267256 [debug] [MainThread]: On master: Close
[0m16:55:27.269256 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:55:27.271272 [info ] [MainThread]: 
[0m16:55:27.278254 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m16:55:27.280255 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m16:55:27.281278 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m16:55:27.297265 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m16:55:27.300268 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 16:55:27.282256 => 16:55:27.299260
[0m16:55:27.301258 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m16:55:27.302258 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 16:55:27.302258 => 16:55:27.302258
[0m16:55:27.304257 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m16:55:27.305255 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:55:27.306256 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m16:55:27.307257 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m16:55:27.308257 [debug] [MainThread]: Command end result
[0m16:55:27.319259 [info ] [MainThread]: Compiled node 'test' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ), 
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_second as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_second e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ), 
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tag_r like "%Long read%" then "Long read"
                WHEN tag_r like "%Kort og godt%" then "Kort og godt"
                WHEN tag_r like "%Q&amp%" then "Q&amp"
                WHEN tag_r like "%Best Practice%" then "Best Practice"
                WHEN tag_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_third as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_third e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    )
    
[0m16:55:27.325257 [debug] [MainThread]: Command `dbt compile` succeeded at 16:55:27.324255 after 1.12 seconds
[0m16:55:27.326256 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B44C8CD460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B44CB17920>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B44CD5D130>]}
[0m16:55:27.328261 [debug] [MainThread]: Flushing usage events
[0m16:59:33.642856 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001737B9D18B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001737AD8D7F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001737B9D1790>]}


============================== 16:59:33.648851 | 2d0e8977-5eec-4776-94b6-a4a5b06977a3 ==============================
[0m16:59:33.648851 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:59:33.650857 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'invocation_command': 'dbt compile -s test', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:59:33.902850 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2d0e8977-5eec-4776-94b6-a4a5b06977a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001737BA28530>]}
[0m16:59:34.020850 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2d0e8977-5eec-4776-94b6-a4a5b06977a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001737BA7A6C0>]}
[0m16:59:34.022855 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:59:34.036852 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:59:34.132850 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:59:34.133853 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:59:34.330852 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2d0e8977-5eec-4776-94b6-a4a5b06977a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001737BCCF710>]}
[0m16:59:34.343854 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2d0e8977-5eec-4776-94b6-a4a5b06977a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001737BDC95B0>]}
[0m16:59:34.344856 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m16:59:34.346853 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2d0e8977-5eec-4776-94b6-a4a5b06977a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001737BAB6D20>]}
[0m16:59:34.349853 [info ] [MainThread]: 
[0m16:59:34.351855 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m16:59:34.353872 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m16:59:34.368851 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:59:34.369853 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m16:59:34.369853 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:59:34.431855 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m16:59:34.432852 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:59:34.432852 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m16:59:34.440873 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m16:59:34.442853 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m16:59:34.443851 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m16:59:34.450852 [debug] [MainThread]: Using postgres connection "master"
[0m16:59:34.450852 [debug] [MainThread]: On master: BEGIN
[0m16:59:34.451853 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:59:34.606094 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:59:34.607090 [debug] [MainThread]: Using postgres connection "master"
[0m16:59:34.608089 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m16:59:34.617092 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m16:59:34.620090 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2d0e8977-5eec-4776-94b6-a4a5b06977a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001737B120290>]}
[0m16:59:34.621088 [debug] [MainThread]: On master: ROLLBACK
[0m16:59:34.622089 [debug] [MainThread]: On master: Close
[0m16:59:34.624089 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:59:34.626096 [info ] [MainThread]: 
[0m16:59:34.632091 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m16:59:34.634095 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m16:59:34.634095 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m16:59:34.651087 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m16:59:34.653090 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 16:59:34.635104 => 16:59:34.652090
[0m16:59:34.654092 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m16:59:34.656098 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 16:59:34.655108 => 16:59:34.655108
[0m16:59:34.659087 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m16:59:34.660091 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:59:34.661091 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m16:59:34.662091 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m16:59:34.664094 [debug] [MainThread]: Command end result
[0m16:59:34.678092 [info ] [MainThread]: Compiled node 'test' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
     agg_cta_per_article as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article
		where siteid = ', site, '
		group by 1
	), 
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_second as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_second e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
     agg_cta_per_article_second as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_second
		where siteid = ', site, '
		group by 1
	), 
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tag_r like "%Long read%" then "Long read"
                WHEN tag_r like "%Kort og godt%" then "Kort og godt"
                WHEN tag_r like "%Q&amp%" then "Q&amp"
                WHEN tag_r like "%Best Practice%" then "Best Practice"
                WHEN tag_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_third as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_third e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
     agg_cta_per_article_third as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_third
		where siteid = ', site, '
		group by 1
	)
    
[0m16:59:34.687089 [debug] [MainThread]: Command `dbt compile` succeeded at 16:59:34.686092 after 1.24 seconds
[0m16:59:34.688091 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001737B7B8680>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017375440890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001737AD8D7F0>]}
[0m16:59:34.689091 [debug] [MainThread]: Flushing usage events
[0m17:13:48.142819 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023257A117F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023257A11940>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023257A11910>]}


============================== 17:13:48.148829 | 45f49fdc-783a-4f26-adbb-7322d8cdc02f ==============================
[0m17:13:48.148829 [info ] [MainThread]: Running with dbt=1.7.13
[0m17:13:48.150824 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s test', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m17:13:48.409820 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '45f49fdc-783a-4f26-adbb-7322d8cdc02f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000232579105F0>]}
[0m17:13:48.529818 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '45f49fdc-783a-4f26-adbb-7322d8cdc02f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000232579F3FE0>]}
[0m17:13:48.531819 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m17:13:48.545818 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m17:13:48.648821 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:13:48.649819 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m17:13:48.852820 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '45f49fdc-783a-4f26-adbb-7322d8cdc02f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023257F35CA0>]}
[0m17:13:48.866820 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '45f49fdc-783a-4f26-adbb-7322d8cdc02f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023257E19760>]}
[0m17:13:48.867820 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m17:13:48.869826 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '45f49fdc-783a-4f26-adbb-7322d8cdc02f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023256F36AB0>]}
[0m17:13:48.872826 [info ] [MainThread]: 
[0m17:13:48.875820 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m17:13:48.877820 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m17:13:48.897818 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:13:48.898819 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m17:13:48.899820 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:13:48.957818 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m17:13:48.958820 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:13:48.958820 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m17:13:48.967818 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m17:13:48.969819 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m17:13:48.970819 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m17:13:48.977817 [debug] [MainThread]: Using postgres connection "master"
[0m17:13:48.978820 [debug] [MainThread]: On master: BEGIN
[0m17:13:48.978820 [debug] [MainThread]: Opening a new connection, currently in state init
[0m17:13:49.028821 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m17:13:49.029821 [debug] [MainThread]: Using postgres connection "master"
[0m17:13:49.030822 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m17:13:49.042818 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m17:13:49.045826 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '45f49fdc-783a-4f26-adbb-7322d8cdc02f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000232578A6C00>]}
[0m17:13:49.046829 [debug] [MainThread]: On master: ROLLBACK
[0m17:13:49.047825 [debug] [MainThread]: On master: Close
[0m17:13:49.049821 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:13:49.051831 [info ] [MainThread]: 
[0m17:13:49.060820 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m17:13:49.062819 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m17:13:49.063818 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m17:13:49.093821 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m17:13:49.097822 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 17:13:49.064822 => 17:13:49.095823
[0m17:13:49.100195 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m17:13:49.102840 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 17:13:49.101820 => 17:13:49.101820
[0m17:13:49.103835 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m17:13:49.105671 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:13:49.106657 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m17:13:49.107659 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m17:13:49.108659 [debug] [MainThread]: Command end result
[0m17:13:49.121657 [info ] [MainThread]: Compiled node 'test' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article
		where siteid = ', site, '
		group by 1
	),
    less_tg_data as(
		select 
        
        l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published l
		left join cta_per_article a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_ as
    (
        select siteid as siteid,tags,sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_
		  where siteid = ', site, '
		group by 1,2
		),
        total_hits as
        (
			select 
				siteid as siteid ,
                sum(hits_tags) as total_tags_hit,
                sum(sum_by_top_10) as agg_by_top_10,
				sum(sum_by_approved) as agg_by_approved 
			from hits_by_tags
			where siteid = ', site, '
			group by 1
		),
        agg_data as(
		select h.siteid,h.tags,coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target 
		,coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
		from hits_by_tags h
		join total_hits t on h.siteid=t.siteid
		join last_30_days_article_published_Agg_ hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
		where h.siteid = ', site, '
		),
        categories_d as (
            select
                siteid as siteid ,',label_val,' as label,',hint_val,' as hint
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
				GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
				GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
			from agg_data
			group by 1,2,3
		),
        categories_ as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d
		),
        json_data as
		(
			SELECT 
				siteid,
				label AS lab, 
				hint AS h,
				cateogires AS cat,
				CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
					   ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
					   ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
			FROM categories
		), 
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_second as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_second e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_second as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_second
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_second as(
		select 
        
        l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_second l
		left join cta_per_article_second a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags__second as
    (
        select siteid as siteid,tags,sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data__second
		  where siteid = ', site, '
		group by 1,2
		),
        total_hits_second as
        (
			select 
				siteid as siteid ,
                sum(hits_tags) as total_tags_hit,
                sum(sum_by_top_10) as agg_by_top_10,
				sum(sum_by_approved) as agg_by_approved 
			from hits_by_tags_second
			where siteid = ', site, '
			group by 1
		),
        agg_data_second as(
		select h.siteid,h.tags,coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target 
		,coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
		from hits_by_tags_second h
		join total_hits_second t on h.siteid=t.siteid
		join last_30_days_article_published_Agg__second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
		where h.siteid = ', site, '
		),
        categories_d_second as (
            select
                siteid as siteid ,',label_val,' as label,',hint_val,' as hint
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
				GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
				GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
			from agg_data_second
			group by 1,2,3
		),
        categories__second as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_second
		),
        json_data_second as
		(
			SELECT 
				siteid,
				label AS lab, 
				hint AS h,
				cateogires AS cat,
				CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
					   ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
					   ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
			FROM categories_second
		), 
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tag_r like "%Long read%" then "Long read"
                WHEN tag_r like "%Kort og godt%" then "Kort og godt"
                WHEN tag_r like "%Q&amp%" then "Q&amp"
                WHEN tag_r like "%Best Practice%" then "Best Practice"
                WHEN tag_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_third as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_third e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_third as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_third
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_third as(
		select 
        
        l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_third l
		left join cta_per_article_third a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags__third as
    (
        select siteid as siteid,tags,sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data__third
		  where siteid = ', site, '
		group by 1,2
		),
        total_hits_third as
        (
			select 
				siteid as siteid ,
                sum(hits_tags) as total_tags_hit,
                sum(sum_by_top_10) as agg_by_top_10,
				sum(sum_by_approved) as agg_by_approved 
			from hits_by_tags_third
			where siteid = ', site, '
			group by 1
		),
        agg_data_third as(
		select h.siteid,h.tags,coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target 
		,coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
		from hits_by_tags_third h
		join total_hits_third t on h.siteid=t.siteid
		join last_30_days_article_published_Agg__third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
		where h.siteid = ', site, '
		),
        categories_d_third as (
            select
                siteid as siteid ,',label_val,' as label,',hint_val,' as hint
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
				GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
				GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
			from agg_data_third
			group by 1,2,3
		),
        categories__third as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_third
		),
        json_data_third as
		(
			SELECT 
				siteid,
				label AS lab, 
				hint AS h,
				cateogires AS cat,
				CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
					   ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
					   ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
			FROM categories_third
		)
    
[0m17:13:49.134657 [debug] [MainThread]: Command `dbt compile` succeeded at 17:13:49.134657 after 1.19 seconds
[0m17:13:49.135657 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000232513D5610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023257A11910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023257A11850>]}
[0m17:13:49.137669 [debug] [MainThread]: Flushing usage events
[0m17:17:41.130116 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027854FA18E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027854FA16A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027854FA1940>]}


============================== 17:17:41.136113 | 12624553-5a81-4f96-9bcb-a7de7c2bf1fd ==============================
[0m17:17:41.136113 [info ] [MainThread]: Running with dbt=1.7.13
[0m17:17:41.138115 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s test', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:17:41.391111 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '12624553-5a81-4f96-9bcb-a7de7c2bf1fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027853E98470>]}
[0m17:17:41.510112 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '12624553-5a81-4f96-9bcb-a7de7c2bf1fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027854F83F80>]}
[0m17:17:41.512112 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m17:17:41.524113 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m17:17:41.624111 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:17:41.625114 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m17:17:41.830113 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '12624553-5a81-4f96-9bcb-a7de7c2bf1fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000278555A1520>]}
[0m17:17:41.843115 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '12624553-5a81-4f96-9bcb-a7de7c2bf1fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027855399A30>]}
[0m17:17:41.844120 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m17:17:41.846115 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '12624553-5a81-4f96-9bcb-a7de7c2bf1fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000278553982C0>]}
[0m17:17:41.848116 [info ] [MainThread]: 
[0m17:17:41.850115 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m17:17:41.851113 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m17:17:41.866115 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:17:41.867118 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m17:17:41.867118 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:17:41.923112 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m17:17:41.924114 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:17:41.925114 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m17:17:41.933112 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m17:17:41.935112 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m17:17:41.936112 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m17:17:41.944111 [debug] [MainThread]: Using postgres connection "master"
[0m17:17:41.944111 [debug] [MainThread]: On master: BEGIN
[0m17:17:41.946115 [debug] [MainThread]: Opening a new connection, currently in state init
[0m17:17:42.031116 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m17:17:42.032119 [debug] [MainThread]: Using postgres connection "master"
[0m17:17:42.034116 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m17:17:42.052117 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m17:17:42.059117 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '12624553-5a81-4f96-9bcb-a7de7c2bf1fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027854A26C30>]}
[0m17:17:42.060114 [debug] [MainThread]: On master: ROLLBACK
[0m17:17:42.062150 [debug] [MainThread]: On master: Close
[0m17:17:42.064113 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:17:42.066113 [info ] [MainThread]: 
[0m17:17:42.073115 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m17:17:42.076115 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m17:17:42.077113 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m17:17:42.124114 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m17:17:42.127112 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 17:17:42.078116 => 17:17:42.126116
[0m17:17:42.129114 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m17:17:42.131116 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 17:17:42.130116 => 17:17:42.130116
[0m17:17:42.135117 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m17:17:42.138115 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:17:42.139116 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m17:17:42.141116 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m17:17:42.143117 [debug] [MainThread]: Command end result
[0m17:17:42.160115 [info ] [MainThread]: Compiled node 'test' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article
		where siteid = ', site, '
		group by 1
	),
    less_tg_data as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published l
		left join cta_per_article a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_ as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_
		  where siteid = ', site, '
		group by 1,2
		),
        total_hits as
        (
			select 
				siteid as siteid ,
                sum(hits_tags) as total_tags_hit,
                sum(sum_by_top_10) as agg_by_top_10,
				sum(sum_by_approved) as agg_by_approved 
			from hits_by_tags
			where siteid = ', site, '
			group by 1
		),
        agg_data
        as(
		    select 
                h.siteid,
                h.tags,
                coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
                coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
		from hits_by_tags h
		join total_hits t on h.siteid=t.siteid
		join last_30_days_article_published_Agg_ hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
		where h.siteid = ', site, '
		),
        categories_d as (
            select
                siteid as siteid ,
                ',label_val,' as label,'
                ,hint_val,' as hint
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
				GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
				GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
			from agg_data
			group by 1,2,3
		),
        categories_ as (
		    select
                siteid as siteid,
                label as label,
                hint as hint,  
		        CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		        less_than_target as less_than_target ,
		        approved as approved ,
		        top_10 as top_10 
		 from  categories_d
		),
        json_data as
		(
			SELECT 
				siteid,
				label AS lab, 
				hint AS h,
				cateogires AS cat,
				CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
					   ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
					   ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
			FROM categories
		), 
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_second as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_second e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_second as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_second
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_second as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_second l
		left join cta_per_article_second a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags__second as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data__second
		  where siteid = ', site, '
		group by 1,2
		),
        total_hits_second as
        (
			select 
				siteid as siteid ,
                sum(hits_tags) as total_tags_hit,
                sum(sum_by_top_10) as agg_by_top_10,
				sum(sum_by_approved) as agg_by_approved 
			from hits_by_tags_second
			where siteid = ', site, '
			group by 1
		),
        agg_data_second
        as(
		    select 
                h.siteid,
                h.tags,
                coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
                coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
		from hits_by_tags_second h
		join total_hits_second t on h.siteid=t.siteid
		join last_30_days_article_published_Agg__second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
		where h.siteid = ', site, '
		),
        categories_d_second as (
            select
                siteid as siteid ,
                ',label_val,' as label,'
                ,hint_val,' as hint
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
				GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
				GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
			from agg_data_second
			group by 1,2,3
		),
        categories__second as (
		    select
                siteid as siteid,
                label as label,
                hint as hint,  
		        CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		        less_than_target as less_than_target ,
		        approved as approved ,
		        top_10 as top_10 
		 from  categories_d_second
		),
        json_data_second as
		(
			SELECT 
				siteid,
				label AS lab, 
				hint AS h,
				cateogires AS cat,
				CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
					   ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
					   ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
			FROM categories_second
		), 
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tag_r like "%Long read%" then "Long read"
                WHEN tag_r like "%Kort og godt%" then "Kort og godt"
                WHEN tag_r like "%Q&amp%" then "Q&amp"
                WHEN tag_r like "%Best Practice%" then "Best Practice"
                WHEN tag_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_third as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_third e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_third as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_third
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_third as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_third l
		left join cta_per_article_third a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags__third as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data__third
		  where siteid = ', site, '
		group by 1,2
		),
        total_hits_third as
        (
			select 
				siteid as siteid ,
                sum(hits_tags) as total_tags_hit,
                sum(sum_by_top_10) as agg_by_top_10,
				sum(sum_by_approved) as agg_by_approved 
			from hits_by_tags_third
			where siteid = ', site, '
			group by 1
		),
        agg_data_third
        as(
		    select 
                h.siteid,
                h.tags,
                coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
                coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
		from hits_by_tags_third h
		join total_hits_third t on h.siteid=t.siteid
		join last_30_days_article_published_Agg__third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
		where h.siteid = ', site, '
		),
        categories_d_third as (
            select
                siteid as siteid ,
                ',label_val,' as label,'
                ,hint_val,' as hint
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
				GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
				GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
			from agg_data_third
			group by 1,2,3
		),
        categories__third as (
		    select
                siteid as siteid,
                label as label,
                hint as hint,  
		        CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		        less_than_target as less_than_target ,
		        approved as approved ,
		        top_10 as top_10 
		 from  categories_d_third
		),
        json_data_third as
		(
			SELECT 
				siteid,
				label AS lab, 
				hint AS h,
				cateogires AS cat,
				CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
					   ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
					   ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
			FROM categories_third
		)
    
[0m17:17:42.176120 [debug] [MainThread]: Command `dbt compile` succeeded at 17:17:42.176120 after 1.20 seconds
[0m17:17:42.178120 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027854E36B10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027854FC7CE0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027854B6D3A0>]}
[0m17:17:42.179114 [debug] [MainThread]: Flushing usage events
[0m17:35:19.573683 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202056E21E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202056E2CF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202056E1C10>]}


============================== 17:35:19.583684 | 2fa6428c-a0ab-4f0b-a12f-3c22023f4e04 ==============================
[0m17:35:19.583684 [info ] [MainThread]: Running with dbt=1.7.13
[0m17:35:19.587269 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt compile -s test', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m17:35:19.990927 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2fa6428c-a0ab-4f0b-a12f-3c22023f4e04', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002020540D640>]}
[0m17:35:20.119116 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2fa6428c-a0ab-4f0b-a12f-3c22023f4e04', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202057080E0>]}
[0m17:35:20.121115 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m17:35:20.141210 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m17:35:20.343105 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:35:20.345104 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m17:35:20.588102 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2fa6428c-a0ab-4f0b-a12f-3c22023f4e04', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020205BDF050>]}
[0m17:35:20.605104 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2fa6428c-a0ab-4f0b-a12f-3c22023f4e04', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020205B09700>]}
[0m17:35:20.607115 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m17:35:20.609106 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2fa6428c-a0ab-4f0b-a12f-3c22023f4e04', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020205C2E900>]}
[0m17:35:20.612108 [info ] [MainThread]: 
[0m17:35:20.614115 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m17:35:20.617105 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m17:35:20.637106 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:35:20.639116 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m17:35:20.641114 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:35:20.724109 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m17:35:20.725146 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:35:20.726108 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m17:35:20.738311 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m17:35:20.741135 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m17:35:20.742340 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m17:35:20.752133 [debug] [MainThread]: Using postgres connection "master"
[0m17:35:20.754141 [debug] [MainThread]: On master: BEGIN
[0m17:35:20.755137 [debug] [MainThread]: Opening a new connection, currently in state init
[0m17:35:20.838030 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m17:35:20.840002 [debug] [MainThread]: Using postgres connection "master"
[0m17:35:20.842182 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m17:35:20.859622 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m17:35:20.864435 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2fa6428c-a0ab-4f0b-a12f-3c22023f4e04', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202056E2D20>]}
[0m17:35:20.866435 [debug] [MainThread]: On master: ROLLBACK
[0m17:35:20.868433 [debug] [MainThread]: On master: Close
[0m17:35:20.871475 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:35:20.874443 [info ] [MainThread]: 
[0m17:35:20.883431 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m17:35:20.885431 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m17:35:20.886429 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m17:35:20.919429 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m17:35:20.922436 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 17:35:20.887431 => 17:35:20.921437
[0m17:35:20.924434 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m17:35:20.926434 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 17:35:20.925434 => 17:35:20.925434
[0m17:35:20.928430 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m17:35:20.930434 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:35:20.931431 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m17:35:20.932675 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m17:35:20.933430 [debug] [MainThread]: Command end result
[0m17:35:20.946967 [info ] [MainThread]: Compiled node 'test' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article
		where siteid = ', site, '
		group by 1
	),
    less_tg_data as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published l
		left join cta_per_article a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_ as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_
		  where siteid = ', site, '
		group by 1,2
		),
        total_hits as
        (
			select 
				siteid as siteid ,
                sum(hits_tags) as total_tags_hit,
                sum(sum_by_top_10) as agg_by_top_10,
				sum(sum_by_approved) as agg_by_approved 
			from hits_by_tags
			where siteid = ', site, '
			group by 1
		),
        agg_data
        as(
		    select 
                h.siteid,
                h.tags,
                coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
                coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
		from hits_by_tags h
		join total_hits t on h.siteid=t.siteid
		join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
		where h.siteid = ', site, '
		),
        categories_d as (
            select
                siteid as siteid ,
                ',label_val,' as label,'
                ,hint_val,' as hint
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
				GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
				GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
			from agg_data
			group by 1,2,3
		),
        categories_ as (
		    select
                siteid as siteid,
                label as label,
                hint as hint,  
		        CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		        less_than_target as less_than_target ,
		        approved as approved ,
		        top_10 as top_10 
		 from  categories_d
		),
        json_data as
		(
			SELECT 
				siteid,
				label AS lab, 
				hint AS h,
				cateogires AS cat,
				CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
					   ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
					   ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
			FROM categories
		),, 
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_second as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_second e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_second as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_second
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_second as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_second l
		left join cta_per_article_second a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags__second as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data__second
		  where siteid = ', site, '
		group by 1,2
		),
        total_hits_second as
        (
			select 
				siteid as siteid ,
                sum(hits_tags) as total_tags_hit,
                sum(sum_by_top_10) as agg_by_top_10,
				sum(sum_by_approved) as agg_by_approved 
			from hits_by_tags_second
			where siteid = ', site, '
			group by 1
		),
        agg_data_second
        as(
		    select 
                h.siteid,
                h.tags,
                coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
                coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
		from hits_by_tags_second h
		join total_hits_second t on h.siteid=t.siteid
		join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
		where h.siteid = ', site, '
		),
        categories_d_second as (
            select
                siteid as siteid ,
                ',label_val,' as label,'
                ,hint_val,' as hint
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
				GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
				GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
			from agg_data_second
			group by 1,2,3
		),
        categories__second as (
		    select
                siteid as siteid,
                label as label,
                hint as hint,  
		        CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		        less_than_target as less_than_target ,
		        approved as approved ,
		        top_10 as top_10 
		 from  categories_d_second
		),
        json_data_second as
		(
			SELECT 
				siteid,
				label AS lab, 
				hint AS h,
				cateogires AS cat,
				CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
					   ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
					   ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
			FROM categories_second
		),, 
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tag_r like "%Long read%" then "Long read"
                WHEN tag_r like "%Kort og godt%" then "Kort og godt"
                WHEN tag_r like "%Q&amp%" then "Q&amp"
                WHEN tag_r like "%Best Practice%" then "Best Practice"
                WHEN tag_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_third as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_third e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_third as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_third
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_third as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_third l
		left join cta_per_article_third a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags__third as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data__third
		  where siteid = ', site, '
		group by 1,2
		),
        total_hits_third as
        (
			select 
				siteid as siteid ,
                sum(hits_tags) as total_tags_hit,
                sum(sum_by_top_10) as agg_by_top_10,
				sum(sum_by_approved) as agg_by_approved 
			from hits_by_tags_third
			where siteid = ', site, '
			group by 1
		),
        agg_data_third
        as(
		    select 
                h.siteid,
                h.tags,
                coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
                coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
		from hits_by_tags_third h
		join total_hits_third t on h.siteid=t.siteid
		join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
		where h.siteid = ', site, '
		),
        categories_d_third as (
            select
                siteid as siteid ,
                ',label_val,' as label,'
                ,hint_val,' as hint
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
				GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
				GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
			from agg_data_third
			group by 1,2,3
		),
        categories__third as (
		    select
                siteid as siteid,
                label as label,
                hint as hint,  
		        CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		        less_than_target as less_than_target ,
		        approved as approved ,
		        top_10 as top_10 
		 from  categories_d_third
		),
        json_data_third as
		(
			SELECT 
				siteid,
				label AS lab, 
				hint AS h,
				cateogires AS cat,
				CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
					   ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
					   ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
			FROM categories_third
		),
    
[0m17:35:20.964979 [debug] [MainThread]: Command `dbt compile` succeeded at 17:35:20.964979 after 1.58 seconds
[0m17:35:20.966970 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202052E1C70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020205789DC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002020485DEE0>]}
[0m17:35:20.967972 [debug] [MainThread]: Flushing usage events
[0m17:40:52.598817 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000206BA972ED0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000206B9EE57F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000206BA973F20>]}


============================== 17:40:52.611630 | b62247f1-f1ff-4e44-8a83-33be3ffab151 ==============================
[0m17:40:52.611630 [info ] [MainThread]: Running with dbt=1.7.13
[0m17:40:52.616411 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt compile -s test', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m17:40:53.436552 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'b62247f1-f1ff-4e44-8a83-33be3ffab151', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000206BA84CB30>]}
[0m17:40:53.759845 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'b62247f1-f1ff-4e44-8a83-33be3ffab151', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000206BA999490>]}
[0m17:40:53.764849 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m17:40:53.793842 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m17:40:54.032296 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:40:54.034295 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m17:40:54.579529 [error] [MainThread]: Encountered an error:
Compilation Error in model test (models\test.sql)
  unexpected '}'
    line 5
      {% set diction3 = {0: 'order_statement_first', 1%}
[0m17:40:54.584521 [debug] [MainThread]: Command `dbt compile` failed at 17:40:54.583521 after 2.37 seconds
[0m17:40:54.587536 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000206B4345610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000206BA99A870>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000206BAC69820>]}
[0m17:40:54.590522 [debug] [MainThread]: Flushing usage events
[0m17:42:39.870019 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021433CE13D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002143393F920>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021433CE16D0>]}


============================== 17:42:39.880018 | 76b629c9-d9f9-4cd2-854e-1af9185845d5 ==============================
[0m17:42:39.880018 [info ] [MainThread]: Running with dbt=1.7.13
[0m17:42:39.884027 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt compile -s test', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m17:42:40.315066 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '76b629c9-d9f9-4cd2-854e-1af9185845d5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021433DC9CD0>]}
[0m17:42:40.550142 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '76b629c9-d9f9-4cd2-854e-1af9185845d5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021433D39F10>]}
[0m17:42:40.553137 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m17:42:40.581225 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m17:42:40.749220 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:42:40.751229 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m17:42:41.013277 [error] [MainThread]: Encountered an error:
Compilation Error in model test (models\test.sql)
  unexpected '}'
    line 5
      {% set diction3 = {0: 'order_statement_first', 1: 'tag_statement_additional', 2: 'order_statement_third'%}}
[0m17:42:41.017498 [debug] [MainThread]: Command `dbt compile` failed at 17:42:41.016282 after 1.50 seconds
[0m17:42:41.018280 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021433AC8680>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021433FBAF60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021433E82F60>]}
[0m17:42:41.019281 [debug] [MainThread]: Flushing usage events
[0m17:43:16.348481 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001924EBA3B30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001924EBA2000>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001924EBA2840>]}


============================== 17:43:16.358480 | 02c33bd4-0f8e-4f28-817c-bc3c67c7edbd ==============================
[0m17:43:16.358480 [info ] [MainThread]: Running with dbt=1.7.13
[0m17:43:16.362647 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt compile -s test', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m17:43:16.744725 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '02c33bd4-0f8e-4f28-817c-bc3c67c7edbd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001924EBF8B30>]}
[0m17:43:16.916725 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '02c33bd4-0f8e-4f28-817c-bc3c67c7edbd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001924EBC4EF0>]}
[0m17:43:16.919727 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m17:43:16.947729 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m17:43:17.095724 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:43:17.097745 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m17:43:17.374261 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '02c33bd4-0f8e-4f28-817c-bc3c67c7edbd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001924F129BE0>]}
[0m17:43:17.399262 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '02c33bd4-0f8e-4f28-817c-bc3c67c7edbd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001924EF9D610>]}
[0m17:43:17.400262 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m17:43:17.403259 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '02c33bd4-0f8e-4f28-817c-bc3c67c7edbd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001924EF9C230>]}
[0m17:43:17.408278 [info ] [MainThread]: 
[0m17:43:17.412265 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m17:43:17.415259 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m17:43:17.447258 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:43:17.449260 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m17:43:17.450647 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:43:17.555552 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m17:43:17.557438 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:43:17.558263 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m17:43:17.574318 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m17:43:17.578323 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m17:43:17.579655 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m17:43:17.596320 [debug] [MainThread]: Using postgres connection "master"
[0m17:43:17.597318 [debug] [MainThread]: On master: BEGIN
[0m17:43:17.599320 [debug] [MainThread]: Opening a new connection, currently in state init
[0m17:43:17.686425 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m17:43:17.687379 [debug] [MainThread]: Using postgres connection "master"
[0m17:43:17.689377 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m17:43:17.702372 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m17:43:17.707376 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '02c33bd4-0f8e-4f28-817c-bc3c67c7edbd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001924EBF88F0>]}
[0m17:43:17.708375 [debug] [MainThread]: On master: ROLLBACK
[0m17:43:17.710383 [debug] [MainThread]: On master: Close
[0m17:43:17.712375 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:43:17.714380 [info ] [MainThread]: 
[0m17:43:17.723477 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m17:43:17.726380 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m17:43:17.727376 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m17:43:17.763377 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m17:43:17.765380 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 17:43:17.728375 => 17:43:17.765380
[0m17:43:17.767376 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m17:43:17.768380 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 17:43:17.767376 => 17:43:17.767376
[0m17:43:17.771680 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m17:43:17.774376 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:43:17.775588 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m17:43:17.776376 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m17:43:17.778375 [debug] [MainThread]: Command end result
[0m17:43:17.795380 [info ] [MainThread]: Compiled node 'test' is:







CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article
		where siteid = ', site, '
		group by 1
	),
    less_tg_data as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published l
		left join cta_per_article a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_ as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_
		  where siteid = ', site, '
		group by 1,2
		),
        total_hits as
        (
			select 
				siteid as siteid ,
                sum(hits_tags) as total_tags_hit,
                sum(sum_by_top_10) as agg_by_top_10,
				sum(sum_by_approved) as agg_by_approved 
			from hits_by_tags
			where siteid = ', site, '
			group by 1
		),
        agg_data
        as(
		    select 
                h.siteid,
                h.tags,
                coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
                coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
		from hits_by_tags h
		join total_hits t on h.siteid=t.siteid
		join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
		where h.siteid = ', site, '
		),
        categories_d as (
            select
                siteid as siteid ,
                ',label_val,' as label,'
                ,hint_val,' as hint
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS less_than_target,
				GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS approved,
				GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_first, ', ''others'') SEPARATOR '','') AS top_10
			from agg_data
			group by 1,2,3
		),
        categories_ as (
		    select
                siteid as siteid,
                label as label,
                hint as hint,  
		        CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		        less_than_target as less_than_target ,
		        approved as approved ,
		        top_10 as top_10 
		 from  categories_d
		),
        json_data as
		(
			SELECT 
				siteid,
				label AS lab, 
				hint AS h,
				cateogires AS cat,
				CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
					   ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
					   ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
			FROM categories
		),, 
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_second as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_second e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_second as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_second
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_second as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_second l
		left join cta_per_article_second a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags__second as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data__second
		  where siteid = ', site, '
		group by 1,2
		),
        total_hits_second as
        (
			select 
				siteid as siteid ,
                sum(hits_tags) as total_tags_hit,
                sum(sum_by_top_10) as agg_by_top_10,
				sum(sum_by_approved) as agg_by_approved 
			from hits_by_tags_second
			where siteid = ', site, '
			group by 1
		),
        agg_data_second
        as(
		    select 
                h.siteid,
                h.tags,
                coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
                coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
		from hits_by_tags_second h
		join total_hits_second t on h.siteid=t.siteid
		join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
		where h.siteid = ', site, '
		),
        categories_d_second as (
            select
                siteid as siteid ,
                ',label_val,' as label,'
                ,hint_val,' as hint
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
				GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
				GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
			from agg_data_second
			group by 1,2,3
		),
        categories__second as (
		    select
                siteid as siteid,
                label as label,
                hint as hint,  
		        CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		        less_than_target as less_than_target ,
		        approved as approved ,
		        top_10 as top_10 
		 from  categories_d_second
		),
        json_data_second as
		(
			SELECT 
				siteid,
				label AS lab, 
				hint AS h,
				cateogires AS cat,
				CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
					   ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
					   ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
			FROM categories_second
		),, 
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tag_r like "%Long read%" then "Long read"
                WHEN tag_r like "%Kort og godt%" then "Kort og godt"
                WHEN tag_r like "%Q&amp%" then "Q&amp"
                WHEN tag_r like "%Best Practice%" then "Best Practice"
                WHEN tag_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_third as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_third e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_third as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_third
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_third as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_third l
		left join cta_per_article_third a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags__third as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data__third
		  where siteid = ', site, '
		group by 1,2
		),
        total_hits_third as
        (
			select 
				siteid as siteid ,
                sum(hits_tags) as total_tags_hit,
                sum(sum_by_top_10) as agg_by_top_10,
				sum(sum_by_approved) as agg_by_approved 
			from hits_by_tags_third
			where siteid = ', site, '
			group by 1
		),
        agg_data_third
        as(
		    select 
                h.siteid,
                h.tags,
                coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
                coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
		from hits_by_tags_third h
		join total_hits_third t on h.siteid=t.siteid
		join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
		where h.siteid = ', site, '
		),
        categories_d_third as (
            select
                siteid as siteid ,
                ',label_val,' as label,'
                ,hint_val,' as hint
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS less_than_target,
				GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS approved,
				GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_third, ', ''others'') SEPARATOR '','') AS top_10
			from agg_data_third
			group by 1,2,3
		),
        categories__third as (
		    select
                siteid as siteid,
                label as label,
                hint as hint,  
		        CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		        less_than_target as less_than_target ,
		        approved as approved ,
		        top_10 as top_10 
		 from  categories_d_third
		),
        json_data_third as
		(
			SELECT 
				siteid,
				label AS lab, 
				hint AS h,
				cateogires AS cat,
				CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
					   ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
					   ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
			FROM categories_third
		),
    
[0m17:43:17.815375 [debug] [MainThread]: Command `dbt compile` succeeded at 17:43:17.815375 after 1.72 seconds
[0m17:43:17.816374 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019248535610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001924E165AF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001924EAB12B0>]}
[0m17:43:17.818146 [debug] [MainThread]: Flushing usage events
[0m18:14:23.831433 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A198679E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A18C1EC60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A196AD7F0>]}


============================== 18:14:23.843605 | 57506310-fe8c-4d96-a556-ee1e519d02a2 ==============================
[0m18:14:23.843605 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:14:23.846436 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt compile -s test', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m18:14:24.178771 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '57506310-fe8c-4d96-a556-ee1e519d02a2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A198B9A60>]}
[0m18:14:24.308079 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '57506310-fe8c-4d96-a556-ee1e519d02a2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A19615E80>]}
[0m18:14:24.310113 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:14:24.328122 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:14:24.499123 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:14:24.500126 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m18:14:24.715136 [error] [MainThread]: Encountered an error:
Compilation Error in model test (models\test.sql)
  Unexpected end of template. Jinja was looking for the following tags: 'endfor' or 'else'. The innermost block that needs to be closed is 'for'.
    line 158
      {% for i in range(count | length) %}
[0m18:14:24.719127 [debug] [MainThread]: Command `dbt compile` failed at 18:14:24.719127 after 1.25 seconds
[0m18:14:24.721137 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A132E0890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A19CFBBC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A19DBEE40>]}
[0m18:14:24.723157 [debug] [MainThread]: Flushing usage events
[0m18:20:27.916797 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C521331700>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5203DD7F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C521331910>]}


============================== 18:20:27.926652 | 7452a54b-391c-4b9a-97d2-f60c4f5078b8 ==============================
[0m18:20:27.926652 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:20:27.929795 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s test', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m18:20:28.257261 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '7452a54b-391c-4b9a-97d2-f60c4f5078b8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C521388260>]}
[0m18:20:28.451369 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '7452a54b-391c-4b9a-97d2-f60c4f5078b8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C521389A60>]}
[0m18:20:28.454459 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:20:28.479825 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:20:28.655676 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:20:28.657762 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m18:20:29.004669 [error] [MainThread]: Encountered an error:
Compilation Error
  Model 'model.dbt_project_test_kasper.test' (models\test.sql) depends on a node named 'json_data' which was not found
[0m18:20:29.007708 [debug] [MainThread]: Command `dbt compile` failed at 18:20:29.007708 after 1.45 seconds
[0m18:20:29.009803 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C52105DDC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C521503CB0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5215009B0>]}
[0m18:20:29.010687 [debug] [MainThread]: Flushing usage events
[0m18:23:59.641064 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001966C72DE80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001966CB619A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001966CB618E0>]}


============================== 18:23:59.648059 | 3165803a-a7af-4ad6-8ae6-238ece739c9e ==============================
[0m18:23:59.648059 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:23:59.650685 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s test', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:23:59.959847 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3165803a-a7af-4ad6-8ae6-238ece739c9e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001966CB851F0>]}
[0m18:24:00.100843 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3165803a-a7af-4ad6-8ae6-238ece739c9e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001966C9AFFE0>]}
[0m18:24:00.103183 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:24:00.119844 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:24:00.258843 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:24:00.259845 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m18:24:00.527844 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3165803a-a7af-4ad6-8ae6-238ece739c9e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001966D141370>]}
[0m18:24:00.542423 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3165803a-a7af-4ad6-8ae6-238ece739c9e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001966CF394F0>]}
[0m18:24:00.543887 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m18:24:00.545130 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3165803a-a7af-4ad6-8ae6-238ece739c9e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001966D05B800>]}
[0m18:24:00.548845 [info ] [MainThread]: 
[0m18:24:00.550848 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:24:00.553853 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:24:00.581092 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:24:00.583090 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:24:00.584092 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:24:00.687353 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:24:00.688772 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:24:00.690385 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:24:00.708176 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:24:00.712238 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:24:00.713175 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:24:00.727183 [debug] [MainThread]: Using postgres connection "master"
[0m18:24:00.729187 [debug] [MainThread]: On master: BEGIN
[0m18:24:00.731180 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:24:00.833890 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:24:00.835697 [debug] [MainThread]: Using postgres connection "master"
[0m18:24:00.836635 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:24:00.847633 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:24:00.851636 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3165803a-a7af-4ad6-8ae6-238ece739c9e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001966C5E2F30>]}
[0m18:24:00.852678 [debug] [MainThread]: On master: ROLLBACK
[0m18:24:00.853637 [debug] [MainThread]: On master: Close
[0m18:24:00.855638 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:24:00.858642 [info ] [MainThread]: 
[0m18:24:00.865635 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m18:24:00.867637 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m18:24:00.868732 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m18:24:00.900711 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m18:24:00.902732 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 18:24:00.869698 => 18:24:00.901710
[0m18:24:00.903714 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m18:24:00.905712 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 18:24:00.904709 => 18:24:00.904709
[0m18:24:00.907711 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m18:24:00.909713 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:24:00.910718 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:24:00.911708 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m18:24:00.912711 [debug] [MainThread]: Command end result
[0m18:24:00.927707 [info ] [MainThread]: Compiled node 'test' is:







CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article
		where siteid = ', site, '
		group by 1
	),
    less_tg_data as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published l
		left join cta_per_article a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_ as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags
        where siteid = ', site, '
        group by 1
    ),
    agg_data as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags h
        join total_hits t on h.siteid=t.siteid
        join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_first, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data
        group by 1,2,3
    ),
    categories_ as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d
    ),
    json_data as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories
    ), 
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_second as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_second e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_second as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_second
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_second as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_second l
		left join cta_per_article_second a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags__second as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data__second
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_second as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_second
        where siteid = ', site, '
        group by 1
    ),
    agg_data_second as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_second h
        join total_hits_second t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_second as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_second
        group by 1,2,3
    ),
    categories__second as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_second
    ),
    json_data_second as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_second
    ), 
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tag_r like "%Long read%" then "Long read"
                WHEN tag_r like "%Kort og godt%" then "Kort og godt"
                WHEN tag_r like "%Q&amp%" then "Q&amp"
                WHEN tag_r like "%Best Practice%" then "Best Practice"
                WHEN tag_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_third as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_third e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_third as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_third
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_third as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_third l
		left join cta_per_article_third a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags__third as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data__third
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_third as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_third
        where siteid = ', site, '
        group by 1
    ),
    agg_data_third as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_third h
        join total_hits_third t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_third as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_third, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_third
        group by 1,2,3
    ),
    categories__third as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_third
    ),
    json_data_third as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_third
    )
    
    SELECT 
		CONCAT(
        ''{'',''"site":'',jd.siteid,'','',
        ''"data": {'',
        ''"label": "'', jd.lab, ''",'',
        ''"categories": ['', jd.cat, ''],'',
        ''"series": ['', jd.series, '']'',
        '',"defaultTitle":"',dtitle,'"'',
        '',"additional":[ {'',
        ''"title":"',title1,'",'',

        ''"data": {'',
        ''"label": "'',jnd.lab, ''",'',
        ''"categories": ['', jnd.cat, ''],'',
        ''"series": ['', jnd.series, '']'',
        ''}},'',
        ''{"title":"',title2,'",'',
        
        ''"data": {'',
        ''"label": "'', jrd.lab, ''",'',
        ''"categories": ['', jrd.cat, ''],'',
        ''"series": ['', jrd.series, '']'',
        ''}}]}}''
    
			) as json_data
		  FROM json_data jd
          CROSS join json_data_second jnd
          CROSS join json_data_third jrd;
[0m18:24:00.945717 [debug] [MainThread]: Command `dbt compile` succeeded at 18:24:00.945717 after 1.59 seconds
[0m18:24:00.947395 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001966CA717F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001966CB619A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001966CB618E0>]}
[0m18:24:00.948724 [debug] [MainThread]: Flushing usage events
[0m10:57:13.397335 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000226176D0F50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000226176D3350>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000226176D36E0>]}


============================== 10:57:13.410156 | 47446137-d85b-4431-9e95-c91103f0f485 ==============================
[0m10:57:13.410156 [info ] [MainThread]: Running with dbt=1.7.13
[0m10:57:13.413164 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt compile -s test', 'send_anonymous_usage_stats': 'True'}
[0m10:57:13.909074 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '47446137-d85b-4431-9e95-c91103f0f485', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000226179C14F0>]}
[0m10:57:14.085071 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '47446137-d85b-4431-9e95-c91103f0f485', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000226174B9400>]}
[0m10:57:14.088075 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m10:57:14.133550 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m10:57:15.673972 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m10:57:15.675338 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m10:57:15.688966 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '47446137-d85b-4431-9e95-c91103f0f485', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000226165C8E60>]}
[0m10:57:15.725565 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '47446137-d85b-4431-9e95-c91103f0f485', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022617B59550>]}
[0m10:57:15.727566 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m10:57:15.729568 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '47446137-d85b-4431-9e95-c91103f0f485', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000226177B65D0>]}
[0m10:57:15.733563 [info ] [MainThread]: 
[0m10:57:15.737567 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m10:57:15.739565 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m10:57:15.770575 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m10:57:15.772106 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m10:57:15.773574 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:57:15.877730 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m10:57:15.878724 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m10:57:15.880746 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m10:57:15.897617 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m10:57:15.900615 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m10:57:15.902618 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m10:57:15.919618 [debug] [MainThread]: Using postgres connection "master"
[0m10:57:15.920616 [debug] [MainThread]: On master: BEGIN
[0m10:57:15.921614 [debug] [MainThread]: Opening a new connection, currently in state init
[0m10:57:16.025169 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m10:57:16.026574 [debug] [MainThread]: Using postgres connection "master"
[0m10:57:16.027095 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m10:57:16.043435 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m10:57:16.045434 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '47446137-d85b-4431-9e95-c91103f0f485', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000226179272F0>]}
[0m10:57:16.047500 [debug] [MainThread]: On master: ROLLBACK
[0m10:57:16.048437 [debug] [MainThread]: On master: Close
[0m10:57:16.051439 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m10:57:16.053440 [info ] [MainThread]: 
[0m10:57:16.061509 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m10:57:16.063436 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m10:57:16.064438 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m10:57:16.102438 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m10:57:16.106458 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 10:57:16.066581 => 10:57:16.104437
[0m10:57:16.107440 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m10:57:16.109440 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 10:57:16.108439 => 10:57:16.108439
[0m10:57:16.111438 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m10:57:16.114440 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:57:16.116441 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m10:57:16.117578 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m10:57:16.119437 [debug] [MainThread]: Command end result
[0m10:57:16.142745 [info ] [MainThread]: Compiled node 'test' is:







CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article
		where siteid = ', site, '
		group by 1
	),
    less_tg_data as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published l
		left join cta_per_article a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_ as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags
        where siteid = ', site, '
        group by 1
    ),
    agg_data as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags h
        join total_hits t on h.siteid=t.siteid
        join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_first, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data
        group by 1,2,3
    ),
    categories_ as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d
    ),
    json_data as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories
    ), 
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_second as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_second e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_second as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_second
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_second as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_second l
		left join cta_per_article_second a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags__second as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data__second
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_second as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_second
        where siteid = ', site, '
        group by 1
    ),
    agg_data_second as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_second h
        join total_hits_second t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_second as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_second
        group by 1,2,3
    ),
    categories__second as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_second
    ),
    json_data_second as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_second
    ), 
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tag_r like "%Long read%" then "Long read"
                WHEN tag_r like "%Kort og godt%" then "Kort og godt"
                WHEN tag_r like "%Q&amp%" then "Q&amp"
                WHEN tag_r like "%Best Practice%" then "Best Practice"
                WHEN tag_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_third as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_third e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_third as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_third
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_third as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_third l
		left join cta_per_article_third a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags__third as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data__third
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_third as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_third
        where siteid = ', site, '
        group by 1
    ),
    agg_data_third as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_third h
        join total_hits_third t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_third as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_third, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_third
        group by 1,2,3
    ),
    categories__third as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_third
    ),
    json_data_third as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_third
    )
    
    SELECT 
		CONCAT(
        ''{'',''"site":'',jd.siteid,'','',
        ''"data": {'',
        ''"label": "'', jd.lab, ''",'',
        ''"categories": ['', jd.cat, ''],'',
        ''"series": ['', jd.series, '']'',
        '',"defaultTitle":"',dtitle,'"'',
        '',"additional":[ {'',
        ''"title":"',title1,'",'',

        ''"data": {'',
        ''"label": "'',jnd.lab, ''",'',
        ''"categories": ['', jnd.cat, ''],'',
        ''"series": ['', jnd.series, '']'',
        ''}},'',
        ''{"title":"',title2,'",'',
        
        ''"data": {'',
        ''"label": "'', jrd.lab, ''",'',
        ''"categories": ['', jrd.cat, ''],'',
        ''"series": ['', jrd.series, '']'',
        ''}}]}}''
    
			) as json_data
		  FROM json_data jd
          CROSS join json_data_second jnd
          CROSS join json_data_third jrd;
[0m10:57:16.173746 [debug] [MainThread]: Command `dbt compile` succeeded at 10:57:16.173085 after 3.17 seconds
[0m10:57:16.177750 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022611005610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000226173FCA40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000226176F8B60>]}
[0m10:57:16.181753 [debug] [MainThread]: Flushing usage events
[0m11:37:41.468097 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024453302ED0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024453303500>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024453300C20>]}


============================== 11:37:41.482414 | e0fbe344-d93b-4c5a-b352-3f660e13ef30 ==============================
[0m11:37:41.482414 [info ] [MainThread]: Running with dbt=1.7.13
[0m11:37:41.485417 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt compile -s test', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m11:37:42.084212 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e0fbe344-d93b-4c5a-b352-3f660e13ef30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024453553B30>]}
[0m11:37:42.468298 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e0fbe344-d93b-4c5a-b352-3f660e13ef30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024453152E70>]}
[0m11:37:42.480931 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m11:37:42.519232 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m11:37:42.789506 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m11:37:42.791511 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m11:37:43.302683 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e0fbe344-d93b-4c5a-b352-3f660e13ef30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024453879BE0>]}
[0m11:37:43.339600 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e0fbe344-d93b-4c5a-b352-3f660e13ef30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000244536E96D0>]}
[0m11:37:43.341603 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m11:37:43.344602 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e0fbe344-d93b-4c5a-b352-3f660e13ef30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024453838D70>]}
[0m11:37:43.351601 [info ] [MainThread]: 
[0m11:37:43.356601 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m11:37:43.366603 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m11:37:43.408603 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:37:43.410600 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m11:37:43.413088 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:37:43.561754 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m11:37:43.563718 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:37:43.564717 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m11:37:43.582712 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m11:37:43.585713 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m11:37:43.587714 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m11:37:43.601717 [debug] [MainThread]: Using postgres connection "master"
[0m11:37:43.602714 [debug] [MainThread]: On master: BEGIN
[0m11:37:43.603715 [debug] [MainThread]: Opening a new connection, currently in state init
[0m11:37:43.694609 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m11:37:43.696611 [debug] [MainThread]: Using postgres connection "master"
[0m11:37:43.698605 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m11:37:43.725005 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m11:37:43.733014 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e0fbe344-d93b-4c5a-b352-3f660e13ef30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000244533C97F0>]}
[0m11:37:43.734007 [debug] [MainThread]: On master: ROLLBACK
[0m11:37:43.736006 [debug] [MainThread]: On master: Close
[0m11:37:43.741011 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:37:43.745332 [info ] [MainThread]: 
[0m11:37:43.760085 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m11:37:43.764042 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m11:37:43.766009 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m11:37:43.823980 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m11:37:43.829977 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 11:37:43.767984 => 11:37:43.828270
[0m11:37:43.832979 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m11:37:43.834978 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 11:37:43.833985 => 11:37:43.833985
[0m11:37:43.839187 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m11:37:43.843501 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:37:43.845205 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m11:37:43.848205 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m11:37:43.850205 [debug] [MainThread]: Command end result
[0m11:37:43.879204 [info ] [MainThread]: Compiled node 'test' is:







CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article
		where siteid = ', site, '
		group by 1
	),
    less_tg_data as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published l
		left join cta_per_article a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_ as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags
        where siteid = ', site, '
        group by 1
    ),
    agg_data as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags h
        join total_hits t on h.siteid=t.siteid
        join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_first, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data
        group by 1,2,3
    ),
    categories as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d
    ),
    json_data as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories
    ), 
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_second as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_second e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_second as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_second
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_second as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_second l
		left join cta_per_article_second a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags__second as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data__second
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_second as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_second
        where siteid = ', site, '
        group by 1
    ),
    agg_data_second as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_second h
        join total_hits_second t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_second as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_second
        group by 1,2,3
    ),
    categories_second as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_second
    ),
    json_data_second as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_second
    ), 
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tag_r like "%Long read%" then "Long read"
                WHEN tag_r like "%Kort og godt%" then "Kort og godt"
                WHEN tag_r like "%Q&amp%" then "Q&amp"
                WHEN tag_r like "%Best Practice%" then "Best Practice"
                WHEN tag_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_third as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_third e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_third as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_third
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_third as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_third l
		left join cta_per_article_third a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags__third as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data__third
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_third as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_third
        where siteid = ', site, '
        group by 1
    ),
    agg_data_third as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_third h
        join total_hits_third t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_third as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_third, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_third
        group by 1,2,3
    ),
    categories_third as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_third
    ),
    json_data_third as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_third
    )
    
    SELECT 
		CONCAT(
        ''{'',''"site":'',jd.siteid,'','',
        ''"data": {'',
        ''"label": "'', jd.lab, ''",'',
        ''"categories": ['', jd.cat, ''],'',
        ''"series": ['', jd.series, '']'',
        '',"defaultTitle":"',dtitle,'"'',
        '',"additional":[ {'',
        ''"title":"',title1,'",'',

        ''"data": {'',
        ''"label": "'',jnd.lab, ''",'',
        ''"categories": ['', jnd.cat, ''],'',
        ''"series": ['', jnd.series, '']'',
        ''}},'',
        ''{"title":"',title2,'",'',
        
        ''"data": {'',
        ''"label": "'', jrd.lab, ''",'',
        ''"categories": ['', jrd.cat, ''],'',
        ''"series": ['', jrd.series, '']'',
        ''}}]}}''
    
			) as json_data
		  FROM json_data jd
          CROSS join json_data_second jnd
          CROSS join json_data_third jrd;
[0m11:37:43.910206 [debug] [MainThread]: Command `dbt compile` succeeded at 11:37:43.909206 after 2.91 seconds
[0m11:37:43.912443 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002444CCE5490>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024453754770>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024453754D70>]}
[0m11:37:43.916205 [debug] [MainThread]: Flushing usage events
[0m11:40:50.150393 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D01DED2DE0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D01DED3B00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D01DED1D30>]}


============================== 11:40:50.160389 | 63059940-7134-4424-8865-3696b52283db ==============================
[0m11:40:50.160389 [info ] [MainThread]: Running with dbt=1.7.13
[0m11:40:50.163396 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt compile -s test', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m11:40:50.508579 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '63059940-7134-4424-8865-3696b52283db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D01DF284D0>]}
[0m11:40:50.640579 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '63059940-7134-4424-8865-3696b52283db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D01E09CC20>]}
[0m11:40:50.642680 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m11:40:50.661624 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m11:40:50.838478 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m11:40:50.840704 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m11:40:51.227549 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '63059940-7134-4424-8865-3696b52283db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D01E469BE0>]}
[0m11:40:51.251131 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '63059940-7134-4424-8865-3696b52283db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D01E2D9850>]}
[0m11:40:51.252671 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m11:40:51.255670 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '63059940-7134-4424-8865-3696b52283db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D01DBA6AB0>]}
[0m11:40:51.261736 [info ] [MainThread]: 
[0m11:40:51.264663 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m11:40:51.267665 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m11:40:51.299732 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:40:51.301107 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m11:40:51.302647 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:40:51.402883 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m11:40:51.403884 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:40:51.405335 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m11:40:51.420889 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m11:40:51.424907 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m11:40:51.425891 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m11:40:51.441885 [debug] [MainThread]: Using postgres connection "master"
[0m11:40:51.442884 [debug] [MainThread]: On master: BEGIN
[0m11:40:51.444444 [debug] [MainThread]: Opening a new connection, currently in state init
[0m11:40:51.537612 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m11:40:51.538703 [debug] [MainThread]: Using postgres connection "master"
[0m11:40:51.540229 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m11:40:51.555355 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m11:40:51.559293 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '63059940-7134-4424-8865-3696b52283db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D01DF7B920>]}
[0m11:40:51.561293 [debug] [MainThread]: On master: ROLLBACK
[0m11:40:51.562295 [debug] [MainThread]: On master: Close
[0m11:40:51.564291 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:40:51.566298 [info ] [MainThread]: 
[0m11:40:51.574293 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m11:40:51.578293 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m11:40:51.579287 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m11:40:51.614462 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m11:40:51.617462 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 11:40:51.579287 => 11:40:51.616463
[0m11:40:51.619460 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m11:40:51.621468 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 11:40:51.620466 => 11:40:51.620466
[0m11:40:51.624460 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m11:40:51.626462 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:40:51.628104 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m11:40:51.628465 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m11:40:51.630466 [debug] [MainThread]: Command end result
[0m11:40:51.646465 [info ] [MainThread]: Compiled node 'test' is:







CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article
		where siteid = ', site, '
		group by 1
	),
    less_tg_data as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published l
		left join cta_per_article a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags
        where siteid = ', site, '
        group by 1
    ),
    agg_data as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags h
        join total_hits t on h.siteid=t.siteid
        join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_first, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data
        group by 1,2,3
    ),
    categories as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d
    ),
    json_data as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories
    ), 
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_second as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_second e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_second as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_second
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_second as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_second l
		left join cta_per_article_second a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_second as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data__second
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_second as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_second
        where siteid = ', site, '
        group by 1
    ),
    agg_data_second as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_second h
        join total_hits_second t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_second as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_second
        group by 1,2,3
    ),
    categories_second as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_second
    ),
    json_data_second as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_second
    ), 
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tag_r like "%Long read%" then "Long read"
                WHEN tag_r like "%Kort og godt%" then "Kort og godt"
                WHEN tag_r like "%Q&amp%" then "Q&amp"
                WHEN tag_r like "%Best Practice%" then "Best Practice"
                WHEN tag_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_third as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_third e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_third as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_third
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_third as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_third l
		left join cta_per_article_third a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_third as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data__third
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_third as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_third
        where siteid = ', site, '
        group by 1
    ),
    agg_data_third as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_third h
        join total_hits_third t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_third as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_third, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_third
        group by 1,2,3
    ),
    categories_third as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_third
    ),
    json_data_third as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_third
    )
    
    SELECT 
		CONCAT(
        ''{'',''"site":'',jd.siteid,'','',
        ''"data": {'',
        ''"label": "'', jd.lab, ''",'',
        ''"categories": ['', jd.cat, ''],'',
        ''"series": ['', jd.series, '']'',
        '',"defaultTitle":"',dtitle,'"'',
        '',"additional":[ {'',
        ''"title":"',title1,'",'',

        ''"data": {'',
        ''"label": "'',jnd.lab, ''",'',
        ''"categories": ['', jnd.cat, ''],'',
        ''"series": ['', jnd.series, '']'',
        ''}},'',
        ''{"title":"',title2,'",'',
        
        ''"data": {'',
        ''"label": "'', jrd.lab, ''",'',
        ''"categories": ['', jrd.cat, ''],'',
        ''"series": ['', jrd.series, '']'',
        ''}}]}}''
    
			) as json_data
		  FROM json_data jd
          CROSS join json_data_second jnd
          CROSS join json_data_third jrd;
[0m11:40:51.675889 [debug] [MainThread]: Command `dbt compile` succeeded at 11:40:51.675889 after 1.85 seconds
[0m11:40:51.677873 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D017805610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D01DED3B00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D01DED2DE0>]}
[0m11:40:51.678873 [debug] [MainThread]: Flushing usage events
[0m11:43:36.471871 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9B13A2930>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9B11EF920>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9B13A2F30>]}


============================== 11:43:36.478867 | ecff6ead-a0e4-4636-a92e-6a747200a1b1 ==============================
[0m11:43:36.478867 [info ] [MainThread]: Running with dbt=1.7.13
[0m11:43:36.480874 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s test', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m11:43:36.808115 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ecff6ead-a0e4-4636-a92e-6a747200a1b1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9B13F8470>]}
[0m11:43:36.951147 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ecff6ead-a0e4-4636-a92e-6a747200a1b1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9B12358B0>]}
[0m11:43:36.953150 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m11:43:36.970254 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m11:43:37.096247 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m11:43:37.098245 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m11:43:37.398809 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ecff6ead-a0e4-4636-a92e-6a747200a1b1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9B1969820>]}
[0m11:43:37.414812 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ecff6ead-a0e4-4636-a92e-6a747200a1b1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9B17894C0>]}
[0m11:43:37.415814 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m11:43:37.416894 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ecff6ead-a0e4-4636-a92e-6a747200a1b1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9B18FB800>]}
[0m11:43:37.420811 [info ] [MainThread]: 
[0m11:43:37.422813 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m11:43:37.425842 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m11:43:37.446942 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:43:37.447833 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m11:43:37.449045 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:43:37.523982 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m11:43:37.525160 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:43:37.525861 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m11:43:37.536858 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m11:43:37.538857 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m11:43:37.540858 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m11:43:37.548862 [debug] [MainThread]: Using postgres connection "master"
[0m11:43:37.550091 [debug] [MainThread]: On master: BEGIN
[0m11:43:37.550862 [debug] [MainThread]: Opening a new connection, currently in state init
[0m11:43:37.617203 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m11:43:37.617859 [debug] [MainThread]: Using postgres connection "master"
[0m11:43:37.618914 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m11:43:37.632883 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m11:43:37.637868 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ecff6ead-a0e4-4636-a92e-6a747200a1b1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9B0E26CC0>]}
[0m11:43:37.638863 [debug] [MainThread]: On master: ROLLBACK
[0m11:43:37.640859 [debug] [MainThread]: On master: Close
[0m11:43:37.642857 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:43:37.644965 [info ] [MainThread]: 
[0m11:43:37.662830 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m11:43:37.665831 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m11:43:37.667829 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m11:43:37.699827 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m11:43:37.701827 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 11:43:37.668441 => 11:43:37.701671
[0m11:43:37.703829 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m11:43:37.705891 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 11:43:37.704830 => 11:43:37.704830
[0m11:43:37.707904 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m11:43:37.710904 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:43:37.712302 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m11:43:37.712906 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m11:43:37.714906 [debug] [MainThread]: Command end result
[0m11:43:37.729905 [info ] [MainThread]: Compiled node 'test' is:







CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article
		where siteid = ', site, '
		group by 1
	),
    less_tg_data as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published l
		left join cta_per_article a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags
        where siteid = ', site, '
        group by 1
    ),
    agg_data as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags h
        join total_hits t on h.siteid=t.siteid
        join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_first, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data
        group by 1,2,3
    ),
    categories as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d
    ),
    json_data as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories
    ), 
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_second as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_second e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_second as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_second
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_second as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_second l
		left join cta_per_article_second a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_second as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_second
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_second as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_second
        where siteid = ', site, '
        group by 1
    ),
    agg_data_second as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_second h
        join total_hits_second t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_second as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_second
        group by 1,2,3
    ),
    categories_second as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_second
    ),
    json_data_second as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_second
    ), 
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tag_r like "%Long read%" then "Long read"
                WHEN tag_r like "%Kort og godt%" then "Kort og godt"
                WHEN tag_r like "%Q&amp%" then "Q&amp"
                WHEN tag_r like "%Best Practice%" then "Best Practice"
                WHEN tag_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_third as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_third e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_third as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_third
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_third as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_third l
		left join cta_per_article_third a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_third as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_third
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_third as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_third
        where siteid = ', site, '
        group by 1
    ),
    agg_data_third as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_third h
        join total_hits_third t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_third as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_third, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_third
        group by 1,2,3
    ),
    categories_third as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_third
    ),
    json_data_third as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_third
    )
    
    SELECT 
		CONCAT(
        ''{'',''"site":'',jd.siteid,'','',
        ''"data": {'',
        ''"label": "'', jd.lab, ''",'',
        ''"categories": ['', jd.cat, ''],'',
        ''"series": ['', jd.series, '']'',
        '',"defaultTitle":"',dtitle,'"'',
        '',"additional":[ {'',
        ''"title":"',title1,'",'',

        ''"data": {'',
        ''"label": "'',jnd.lab, ''",'',
        ''"categories": ['', jnd.cat, ''],'',
        ''"series": ['', jnd.series, '']'',
        ''}},'',
        ''{"title":"',title2,'",'',
        
        ''"data": {'',
        ''"label": "'', jrd.lab, ''",'',
        ''"categories": ['', jrd.cat, ''],'',
        ''"series": ['', jrd.series, '']'',
        ''}}]}}''
    
			) as json_data
		  FROM json_data jd
          CROSS join json_data_second jnd
          CROSS join json_data_third jrd;
[0m11:43:37.749903 [debug] [MainThread]: Command `dbt compile` succeeded at 11:43:37.748907 after 1.52 seconds
[0m11:43:37.751361 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9B118AFC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9B13A2420>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9B13A3C50>]}
[0m11:43:37.751903 [debug] [MainThread]: Flushing usage events
[0m16:42:28.564515 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F172863620>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F172863290>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F172863B60>]}


============================== 16:42:28.571515 | 90e3383f-72e8-4765-a2ee-51a7cb946489 ==============================
[0m16:42:28.571515 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:42:28.574518 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s test', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:42:28.916445 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '90e3383f-72e8-4765-a2ee-51a7cb946489', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F172770D40>]}
[0m16:42:29.040445 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '90e3383f-72e8-4765-a2ee-51a7cb946489', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F172843FE0>]}
[0m16:42:29.042448 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:42:29.067293 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:42:29.845211 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 1 files changed.
[0m16:42:29.846212 [debug] [MainThread]: Partial parsing: added file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_dropdown_dbt_test.sql
[0m16:42:29.847216 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:42:30.056242 [error] [MainThread]: Encountered an error:
Compilation Error in model test (models\test.sql)
  expected token 'end of statement block', got ':'
    line 6
      {%set additional_data_dictionary= 0:'Brugerbehov',1:'Formater'}
[0m16:42:30.059240 [debug] [MainThread]: Command `dbt compile` failed at 16:42:30.059240 after 1.71 seconds
[0m16:42:30.060236 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F172B91130>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F172862390>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F172E303B0>]}
[0m16:42:30.061240 [debug] [MainThread]: Flushing usage events
[0m16:51:24.696325 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A89893C80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A89893D10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A89891B20>]}


============================== 16:51:24.703327 | 9fec9831-46b2-443c-a35b-2dd912a6d091 ==============================
[0m16:51:24.703327 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:51:24.705332 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'invocation_command': 'dbt compile -s test', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:51:24.964327 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9fec9831-46b2-443c-a35b-2dd912a6d091', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A897A14F0>]}
[0m16:51:25.084324 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9fec9831-46b2-443c-a35b-2dd912a6d091', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A89958C20>]}
[0m16:51:25.086326 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:51:25.100325 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:51:25.191327 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 1 files changed.
[0m16:51:25.192347 [debug] [MainThread]: Partial parsing: added file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_dropdown_dbt_test.sql
[0m16:51:25.193328 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:51:25.418324 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '9fec9831-46b2-443c-a35b-2dd912a6d091', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A89DC74A0>]}
[0m16:51:25.455327 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '9fec9831-46b2-443c-a35b-2dd912a6d091', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A89C6CA70>]}
[0m16:51:25.456329 [info ] [MainThread]: Found 2 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m16:51:25.458333 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9fec9831-46b2-443c-a35b-2dd912a6d091', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A89E7A360>]}
[0m16:51:25.461333 [info ] [MainThread]: 
[0m16:51:25.464326 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m16:51:25.466325 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m16:51:25.482323 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:51:25.483348 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m16:51:25.484327 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:51:25.542615 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m16:51:25.543630 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:51:25.544627 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m16:51:25.555141 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m16:51:25.558138 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m16:51:25.558138 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m16:51:25.565138 [debug] [MainThread]: Using postgres connection "master"
[0m16:51:25.566139 [debug] [MainThread]: On master: BEGIN
[0m16:51:25.567139 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:51:25.617142 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:51:25.617142 [debug] [MainThread]: Using postgres connection "master"
[0m16:51:25.619142 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m16:51:25.635140 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m16:51:25.638138 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9fec9831-46b2-443c-a35b-2dd912a6d091', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A89C6CD70>]}
[0m16:51:25.640139 [debug] [MainThread]: On master: ROLLBACK
[0m16:51:25.641140 [debug] [MainThread]: On master: Close
[0m16:51:25.643142 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:51:25.645153 [info ] [MainThread]: 
[0m16:51:25.653141 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m16:51:25.654140 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m16:51:25.655142 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m16:51:25.700139 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m16:51:25.702140 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 16:51:25.656142 => 16:51:25.702140
[0m16:51:25.704139 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m16:51:25.705138 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 16:51:25.705138 => 16:51:25.705138
[0m16:51:25.708139 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m16:51:25.710139 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:51:25.711142 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m16:51:25.711142 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m16:51:25.713144 [debug] [MainThread]: Command end result
[0m16:51:25.728142 [info ] [MainThread]: Compiled node 'test' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article
		where siteid = ', site, '
		group by 1
	),
    less_tg_data as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published l
		left join cta_per_article a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags
        where siteid = ', site, '
        group by 1
    ),
    agg_data as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags h
        join total_hits t on h.siteid=t.siteid
        join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_first, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data
        group by 1,2,3
    ),
    categories as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d
    ),
    json_data as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories
    ), 
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_second as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_second e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_second as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_second
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_second as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_second l
		left join cta_per_article_second a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_second as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_second
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_second as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_second
        where siteid = ', site, '
        group by 1
    ),
    agg_data_second as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_second h
        join total_hits_second t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_second as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_second
        group by 1,2,3
    ),
    categories_second as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_second
    ),
    json_data_second as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_second
    ), 
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags_r like "%Long read%" then "Long read"
                WHEN tags_r like "%Kort og godt%" then "Kort og godt"
                WHEN tags_r like "%Q&amp%" then "Q&amp"
                WHEN tags_r like "%Best Practice%" then "Best Practice"
                WHEN tags_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_third as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_third e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_third as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_third
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_third as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_third l
		left join cta_per_article_third a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_third as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_third
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_third as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_third
        where siteid = ', site, '
        group by 1
    ),
    agg_data_third as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_third h
        join total_hits_third t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_third as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_third, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_third
        group by 1,2,3
    ),
    categories_third as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_third
    ),
    json_data_third as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_third
    )
    
   SELECT 
    CONCAT(
        '{''"site":'', jd.siteid, '',',
        ''"data": {'',
        ''"label": "'', jd.lab, ''",'',
        ''"categories": ['', jd.cat, ''],'',
        ''"series": ['', jd.series, '']'',
        '',"defaultTitle":"', dtitle, '"'',',
        ''"additional": [''','{''"title":"', additional_item.title, '"'',',
                ''"data": {'',
                ''"label": "'', jnd.lab, ''",'',
                ''"categories": ['', jnd.cat, ''],'',
                ''"series": ['', jnd.series, '']'',
                ''}'',, '{''"title":"', additional_item.title, '"'',',
                ''"data": {'',
                ''"label": "'', jnd.lab, ''",'',
                ''"categories": ['', jnd.cat, ''],'',
                ''"series": ['', jnd.series, '']'',
                ''}'',''
        ]}''
    ) AS json_data
FROM
    json_data jd
CROSS JOIN json_data_second jnd
CROSS JOIN json_data_third jrd;
[0m16:51:25.747144 [debug] [MainThread]: Command `dbt compile` succeeded at 16:51:25.747144 after 1.25 seconds
[0m16:51:25.748157 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A8976E1E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A887886B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A89E79C10>]}
[0m16:51:25.749147 [debug] [MainThread]: Flushing usage events
[0m17:03:19.645362 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020A1C553350>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020A1C1E7920>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020A1C553800>]}


============================== 17:03:19.651361 | 7722ff39-d06b-4a07-b26b-1203756811b6 ==============================
[0m17:03:19.651361 [info ] [MainThread]: Running with dbt=1.7.13
[0m17:03:19.653362 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt compile -s test', 'send_anonymous_usage_stats': 'True'}
[0m17:03:19.904359 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '7722ff39-d06b-4a07-b26b-1203756811b6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020A1C723CE0>]}
[0m17:03:20.022360 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '7722ff39-d06b-4a07-b26b-1203756811b6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020A1C5A84D0>]}
[0m17:03:20.024360 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m17:03:20.036360 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m17:03:20.137362 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:03:20.138364 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m17:03:20.297363 [error] [MainThread]: Encountered an error:
Compilation Error in model test (models\test.sql)
  unexpected ','
    line 9
      ,
[0m17:03:20.299364 [debug] [MainThread]: Command `dbt compile` failed at 17:03:20.298362 after 0.79 seconds
[0m17:03:20.299364 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020A1C553800>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020A1C6B4C80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020A1C927620>]}
[0m17:03:20.300360 [debug] [MainThread]: Flushing usage events
[0m17:03:46.573865 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023C59CC2960>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023C59CC3DA0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023C59CC3170>]}


============================== 17:03:46.579865 | 3a6e2d1c-70ba-443f-ae89-6443870692c2 ==============================
[0m17:03:46.579865 [info ] [MainThread]: Running with dbt=1.7.13
[0m17:03:46.580867 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt compile -s test', 'send_anonymous_usage_stats': 'True'}
[0m17:03:46.834862 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3a6e2d1c-70ba-443f-ae89-6443870692c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023C59BF9C70>]}
[0m17:03:46.952862 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3a6e2d1c-70ba-443f-ae89-6443870692c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023C59921160>]}
[0m17:03:46.954864 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m17:03:46.967862 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m17:03:47.067984 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:03:47.068988 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m17:03:47.288986 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3a6e2d1c-70ba-443f-ae89-6443870692c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023C5A1E0050>]}
[0m17:03:47.302987 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3a6e2d1c-70ba-443f-ae89-6443870692c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023C5A0995B0>]}
[0m17:03:47.304989 [info ] [MainThread]: Found 2 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m17:03:47.305988 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3a6e2d1c-70ba-443f-ae89-6443870692c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023C59E922D0>]}
[0m17:03:47.308991 [info ] [MainThread]: 
[0m17:03:47.309994 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m17:03:47.311990 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m17:03:47.327987 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:03:47.327987 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m17:03:47.329991 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:03:47.386990 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m17:03:47.387987 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:03:47.387987 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m17:03:47.396989 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m17:03:47.398989 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m17:03:47.399990 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m17:03:47.405986 [debug] [MainThread]: Using postgres connection "master"
[0m17:03:47.406987 [debug] [MainThread]: On master: BEGIN
[0m17:03:47.406987 [debug] [MainThread]: Opening a new connection, currently in state init
[0m17:03:47.458017 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m17:03:47.459018 [debug] [MainThread]: Using postgres connection "master"
[0m17:03:47.459018 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m17:03:47.468025 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m17:03:47.470020 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3a6e2d1c-70ba-443f-ae89-6443870692c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023C59746DB0>]}
[0m17:03:47.471021 [debug] [MainThread]: On master: ROLLBACK
[0m17:03:47.472022 [debug] [MainThread]: On master: Close
[0m17:03:47.474017 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:03:47.476017 [info ] [MainThread]: 
[0m17:03:47.481018 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m17:03:47.482017 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m17:03:47.483019 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m17:03:47.507016 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m17:03:47.508017 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 17:03:47.484015 => 17:03:47.508017
[0m17:03:47.509019 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m17:03:47.510028 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 17:03:47.510028 => 17:03:47.510028
[0m17:03:47.512019 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m17:03:47.514017 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:03:47.515018 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m17:03:47.516018 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m17:03:47.517017 [debug] [MainThread]: Command end result
[0m17:03:47.528020 [info ] [MainThread]: Compiled node 'test' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article
		where siteid = ', site, '
		group by 1
	),
    less_tg_data as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published l
		left join cta_per_article a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags
        where siteid = ', site, '
        group by 1
    ),
    agg_data as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags h
        join total_hits t on h.siteid=t.siteid
        join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_first, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data
        group by 1,2,3
    ),
    categories as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d
    ),
    json_data as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories
    ), 
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_second as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_second e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_second as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_second
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_second as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_second l
		left join cta_per_article_second a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_second as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_second
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_second as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_second
        where siteid = ', site, '
        group by 1
    ),
    agg_data_second as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_second h
        join total_hits_second t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_second as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_second
        group by 1,2,3
    ),
    categories_second as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_second
    ),
    json_data_second as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_second
    ), 
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags_r like "%Long read%" then "Long read"
                WHEN tags_r like "%Kort og godt%" then "Kort og godt"
                WHEN tags_r like "%Q&amp%" then "Q&amp"
                WHEN tags_r like "%Best Practice%" then "Best Practice"
                WHEN tags_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_third as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_third e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_third as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_third
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_third as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_third l
		left join cta_per_article_third a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_third as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_third
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_third as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_third
        where siteid = ', site, '
        group by 1
    ),
    agg_data_third as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_third h
        join total_hits_third t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_third as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_third, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_third
        group by 1,2,3
    ),
    categories_third as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_third
    ),
    json_data_third as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_third
    )
    
   SELECT 
    CONCAT(
        '{''"site":'', jd.siteid, '',',
        ''"data": {'',
        ''"label": "'', jd.lab, ''",'',
        ''"categories": ['', jd.cat, ''],'',
        ''"series": ['', jd.series, '']'',
        '',"defaultTitle":"', dtitle, '"'',',
        ''"additional": [''','{''"title":"', additional_item.title, '"'',',
                ''"data": {'',
                ''"label": "'', jnd.lab, ''",'',
                ''"categories": ['', jnd.cat, ''],'',
                ''"series": ['', jnd.series, '']'',
                ''}'',, '{''"title":"', additional_item.title, '"'',',
                ''"data": {'',
                ''"label": "'', jnd.lab, ''",'',
                ''"categories": ['', jnd.cat, ''],'',
                ''"series": ['', jnd.series, '']'',
                ''}'',''
        ]}''
    ) AS json_data
FROM
    json_data jd
CROSS JOIN json_data_second jnd
CROSS JOIN json_data_third jrd;
[0m17:03:47.547020 [debug] [MainThread]: Command `dbt compile` succeeded at 17:03:47.546016 after 1.11 seconds
[0m17:03:47.548019 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023C59B0F920>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023C5A1BA0C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023C59FA3980>]}
[0m17:03:47.549033 [debug] [MainThread]: Flushing usage events
[0m18:58:13.060123 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DDCC27F50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DDCB5D7F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DDCC274D0>]}


============================== 18:58:13.067372 | 9db4e1e3-3d22-40ee-b2aa-6409d7566599 ==============================
[0m18:58:13.067372 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:58:13.069374 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'invocation_command': 'dbt compile -s test', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:58:13.353808 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9db4e1e3-3d22-40ee-b2aa-6409d7566599', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DDCA6EC00>]}
[0m18:58:13.471812 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9db4e1e3-3d22-40ee-b2aa-6409d7566599', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DDCB32E70>]}
[0m18:58:13.473810 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:58:13.489494 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:58:13.615717 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:58:13.616719 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m18:58:13.823723 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '9db4e1e3-3d22-40ee-b2aa-6409d7566599', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DDD1E1520>]}
[0m18:58:13.837721 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '9db4e1e3-3d22-40ee-b2aa-6409d7566599', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DDCFC9790>]}
[0m18:58:13.838724 [info ] [MainThread]: Found 2 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m18:58:13.840728 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9db4e1e3-3d22-40ee-b2aa-6409d7566599', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DDCECF860>]}
[0m18:58:13.844738 [info ] [MainThread]: 
[0m18:58:13.846723 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:58:13.848719 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:58:13.866717 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:58:13.866717 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:58:13.867722 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:58:13.936399 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:58:13.937397 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:58:13.938396 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:58:13.950396 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:58:13.952394 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:58:13.953397 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:58:13.961396 [debug] [MainThread]: Using postgres connection "master"
[0m18:58:13.962395 [debug] [MainThread]: On master: BEGIN
[0m18:58:13.963398 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:58:14.018397 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:58:14.019396 [debug] [MainThread]: Using postgres connection "master"
[0m18:58:14.020395 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:58:14.034399 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:58:14.038399 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9db4e1e3-3d22-40ee-b2aa-6409d7566599', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DDD1A3680>]}
[0m18:58:14.039395 [debug] [MainThread]: On master: ROLLBACK
[0m18:58:14.040395 [debug] [MainThread]: On master: Close
[0m18:58:14.042399 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:58:14.044398 [info ] [MainThread]: 
[0m18:58:14.057396 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m18:58:14.060401 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m18:58:14.061396 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m18:58:14.091393 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m18:58:14.094400 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 18:58:14.063401 => 18:58:14.093395
[0m18:58:14.094400 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m18:58:14.095397 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 18:58:14.095397 => 18:58:14.095397
[0m18:58:14.097396 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m18:58:14.099396 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:58:14.099396 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:58:14.100398 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m18:58:14.101398 [debug] [MainThread]: Command end result
[0m18:58:14.113396 [info ] [MainThread]: Compiled node 'test' is:










CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article
		where siteid = ', site, '
		group by 1
	),
    less_tg_data as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published l
		left join cta_per_article a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags
        where siteid = ', site, '
        group by 1
    ),
    agg_data as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags h
        join total_hits t on h.siteid=t.siteid
        join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_first, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data
        group by 1,2,3
    ),
    categories as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d
    ),
    json_data as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories
    ), 
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_second as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_second e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_second as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_second
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_second as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_second l
		left join cta_per_article_second a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_second as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_second
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_second as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_second
        where siteid = ', site, '
        group by 1
    ),
    agg_data_second as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_second h
        join total_hits_second t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_second as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_second
        group by 1,2,3
    ),
    categories_second as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_second
    ),
    json_data_second as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_second
    ), 
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags_r like "%Long read%" then "Long read"
                WHEN tags_r like "%Kort og godt%" then "Kort og godt"
                WHEN tags_r like "%Q&amp%" then "Q&amp"
                WHEN tags_r like "%Best Practice%" then "Best Practice"
                WHEN tags_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_third as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_third e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_third as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_third
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_third as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_third l
		left join cta_per_article_third a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_third as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_third
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_third as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_third
        where siteid = ', site, '
        group by 1
    ),
    agg_data_third as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_third h
        join total_hits_third t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_third as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_third, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_third
        group by 1,2,3
    ),
    categories_third as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_third
    ),
    json_data_third as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_third
    )
    
   SELECT 
    CONCAT(
        '{''"site":'', jd.siteid, '',',
        ''"data": {'',
        ''"label": "'', jd.lab, ''",'',
        ''"categories": ['', jd.cat, ''],'',
        ''"series": ['', jd.series, '']'',
        '',"defaultTitle":"', dtitle, '"'',',
        ''"additional": [''',''
        ]}''
    ) AS json_data
FROM
    json_data jd
CROSS JOIN json_data_second jnd
CROSS JOIN json_data_third jrd;
[0m18:58:14.128400 [debug] [MainThread]: Command `dbt compile` succeeded at 18:58:14.128400 after 1.27 seconds
[0m18:58:14.129401 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DDC94DAF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DDCB5D7F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DD6620890>]}
[0m18:58:14.130400 [debug] [MainThread]: Flushing usage events
[0m18:58:53.911379 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A238970A40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A237F357F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A2389732F0>]}


============================== 18:58:53.917382 | cc3743f8-4694-4e92-865e-69526142ee92 ==============================
[0m18:58:53.917382 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:58:53.919384 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt compile -s test', 'send_anonymous_usage_stats': 'True'}
[0m18:58:54.176378 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'cc3743f8-4694-4e92-865e-69526142ee92', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A238710980>]}
[0m18:58:54.296415 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'cc3743f8-4694-4e92-865e-69526142ee92', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A238850860>]}
[0m18:58:54.297418 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:58:54.313414 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:58:54.413418 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:58:54.414417 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m18:58:54.617413 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'cc3743f8-4694-4e92-865e-69526142ee92', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A238EA6D20>]}
[0m18:58:54.631419 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'cc3743f8-4694-4e92-865e-69526142ee92', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A238D899D0>]}
[0m18:58:54.632417 [info ] [MainThread]: Found 2 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m18:58:54.634447 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cc3743f8-4694-4e92-865e-69526142ee92', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A238D88050>]}
[0m18:58:54.637418 [info ] [MainThread]: 
[0m18:58:54.640427 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:58:54.642417 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:58:54.659417 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:58:54.660420 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:58:54.661417 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:58:54.719418 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:58:54.720418 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:58:54.721417 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:58:54.728417 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:58:54.731420 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:58:54.731420 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:58:54.740414 [debug] [MainThread]: Using postgres connection "master"
[0m18:58:54.741416 [debug] [MainThread]: On master: BEGIN
[0m18:58:54.742417 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:58:54.791420 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:58:54.792417 [debug] [MainThread]: Using postgres connection "master"
[0m18:58:54.793417 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:58:54.808549 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:58:54.810557 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cc3743f8-4694-4e92-865e-69526142ee92', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A238D8A390>]}
[0m18:58:54.812550 [debug] [MainThread]: On master: ROLLBACK
[0m18:58:54.813557 [debug] [MainThread]: On master: Close
[0m18:58:54.816552 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:58:54.817581 [info ] [MainThread]: 
[0m18:58:54.824555 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m18:58:54.825549 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m18:58:54.826549 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m18:58:54.850548 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m18:58:54.852549 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 18:58:54.827549 => 18:58:54.852549
[0m18:58:54.853550 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m18:58:54.854548 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 18:58:54.854548 => 18:58:54.854548
[0m18:58:54.857549 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m18:58:54.859549 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:58:54.859549 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:58:54.860547 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m18:58:54.861552 [debug] [MainThread]: Command end result
[0m18:58:54.872549 [info ] [MainThread]: Compiled node 'test' is:










CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article
		where siteid = ', site, '
		group by 1
	),
    less_tg_data as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published l
		left join cta_per_article a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags
        where siteid = ', site, '
        group by 1
    ),
    agg_data as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags h
        join total_hits t on h.siteid=t.siteid
        join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_first, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data
        group by 1,2,3
    ),
    categories as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d
    ),
    json_data as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories
    ), 
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_second as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_second e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_second as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_second
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_second as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_second l
		left join cta_per_article_second a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_second as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_second
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_second as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_second
        where siteid = ', site, '
        group by 1
    ),
    agg_data_second as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_second h
        join total_hits_second t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_second as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_second
        group by 1,2,3
    ),
    categories_second as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_second
    ),
    json_data_second as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_second
    ), 
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags_r like "%Long read%" then "Long read"
                WHEN tags_r like "%Kort og godt%" then "Kort og godt"
                WHEN tags_r like "%Q&amp%" then "Q&amp"
                WHEN tags_r like "%Best Practice%" then "Best Practice"
                WHEN tags_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_third as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_third e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_third as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_third
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_third as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_third l
		left join cta_per_article_third a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_third as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_third
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_third as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_third
        where siteid = ', site, '
        group by 1
    ),
    agg_data_third as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_third h
        join total_hits_third t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_third as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_third, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_third
        group by 1,2,3
    ),
    categories_third as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_third
    ),
    json_data_third as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_third
    )
    
   SELECT 
    CONCAT(
        '{''"site":'', jd.siteid, '',',
        ''"data": {'',
        ''"label": "'', jd.lab, ''",'',
        ''"categories": ['', jd.cat, ''],'',
        ''"series": ['', jd.series, '']'',
        '',"defaultTitle":"', dtitle, '"'',',
        ''"additional": [''',

        
            
                '{''"title":"', title[key], '"'',',
                ''"data": {'',
                ''"label": "'', jnd.lab, ''",'',
                ''"categories": ['', jnd.cat, ''],'',
                ''"series": ['', jnd.series, '']'',
                ''}'',, 
                '{''"title":"', title[key], '"'',',
                ''"data": {'',
                ''"label": "'', jnd.lab, ''",'',
                ''"categories": ['', jnd.cat, ''],'',
                ''"series": ['', jnd.series, '']'',
                ''}'',''
        ]}''
    ) AS json_data
FROM
    json_data jd
CROSS JOIN json_data_second jnd
CROSS JOIN json_data_third jrd;
[0m18:58:54.893550 [debug] [MainThread]: Command `dbt compile` succeeded at 18:58:54.893550 after 1.12 seconds
[0m18:58:54.894551 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A237F357F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A238804A10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A2387C3BF0>]}
[0m18:58:54.895549 [debug] [MainThread]: Flushing usage events
[0m10:31:15.948250 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B857060050>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B856DFD7F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B856F1B320>]}


============================== 10:31:15.956250 | 9efe47c6-83d3-46c9-8ec2-3343dde003a7 ==============================
[0m10:31:15.956250 [info ] [MainThread]: Running with dbt=1.7.13
[0m10:31:15.959252 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s test', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m10:31:16.250250 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9efe47c6-83d3-46c9-8ec2-3343dde003a7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B8570B85F0>]}
[0m10:31:16.369247 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9efe47c6-83d3-46c9-8ec2-3343dde003a7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B857085400>]}
[0m10:31:16.371249 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m10:31:16.386248 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m10:31:16.509549 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m10:31:16.510553 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m10:31:16.673065 [error] [MainThread]: Encountered an error:
Compilation Error in model test (models\test.sql)
  expected token 'end of statement block', got 'CREATE'
    line 11
      CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
[0m10:31:16.676071 [debug] [MainThread]: Command `dbt compile` failed at 10:31:16.676071 after 0.89 seconds
[0m10:31:16.678072 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B850A50890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B8570B8EC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B85757EB70>]}
[0m10:31:16.679088 [debug] [MainThread]: Flushing usage events
[0m10:31:46.478516 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A145C61610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A145C61880>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A145C618B0>]}


============================== 10:31:46.484515 | 55c405ac-8301-424c-905f-b546b5552083 ==============================
[0m10:31:46.484515 [info ] [MainThread]: Running with dbt=1.7.13
[0m10:31:46.486535 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt compile -s test', 'send_anonymous_usage_stats': 'True'}
[0m10:31:46.744510 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '55c405ac-8301-424c-905f-b546b5552083', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A144D0F380>]}
[0m10:31:46.861517 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '55c405ac-8301-424c-905f-b546b5552083', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A1457CAE70>]}
[0m10:31:46.863513 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m10:31:46.878509 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m10:31:46.981511 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m10:31:46.982512 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m10:31:47.146513 [error] [MainThread]: Encountered an error:
Compilation Error in model test (models\test.sql)
  Unexpected end of template. Jinja was looking for the following tags: 'endfor' or 'else'. The innermost block that needs to be closed is 'for'.
    line 185
      {% endfor %};
[0m10:31:47.150517 [debug] [MainThread]: Command `dbt compile` failed at 10:31:47.149520 after 0.81 seconds
[0m10:31:47.151521 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A145896F30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A145FC3650>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A1460CED80>]}
[0m10:31:47.152523 [debug] [MainThread]: Flushing usage events
[0m10:38:19.089193 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A3A5821790>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A3A58217F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A3A5821910>]}


============================== 10:38:19.095192 | d32bd73a-5be0-49c1-b0d2-e52b7b64eced ==============================
[0m10:38:19.095192 [info ] [MainThread]: Running with dbt=1.7.13
[0m10:38:19.097216 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s test', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m10:38:19.384191 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd32bd73a-5be0-49c1-b0d2-e52b7b64eced', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A3A58789E0>]}
[0m10:38:19.503191 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd32bd73a-5be0-49c1-b0d2-e52b7b64eced', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A3A4DE88F0>]}
[0m10:38:19.505193 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m10:38:19.529197 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m10:38:20.387299 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m10:38:20.388303 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m10:38:20.559303 [error] [MainThread]: Encountered an error:
Compilation Error in model test (models\test.sql)
  Unexpected end of template. Jinja was looking for the following tags: 'endfor' or 'else'. The innermost block that needs to be closed is 'for'.
    line 185
      {% endfor %};
[0m10:38:20.562305 [debug] [MainThread]: Command `dbt compile` failed at 10:38:20.562305 after 1.70 seconds
[0m10:38:20.563303 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A3A5821B20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A3A5803F80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A3A5BB7F80>]}
[0m10:38:20.564313 [debug] [MainThread]: Flushing usage events
[0m10:39:27.611525 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D67780F20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D66D457F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D67781820>]}


============================== 10:39:27.617524 | 2232f0f7-e7a0-408f-bc64-82f44d483c00 ==============================
[0m10:39:27.617524 [info ] [MainThread]: Running with dbt=1.7.13
[0m10:39:27.619531 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s test', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m10:39:27.873524 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2232f0f7-e7a0-408f-bc64-82f44d483c00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D67927860>]}
[0m10:39:28.010529 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2232f0f7-e7a0-408f-bc64-82f44d483c00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D676908F0>]}
[0m10:39:28.012525 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m10:39:28.027527 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m10:39:28.115527 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m10:39:28.117529 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m10:39:28.321526 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2232f0f7-e7a0-408f-bc64-82f44d483c00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D67CA1970>]}
[0m10:39:28.352549 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2232f0f7-e7a0-408f-bc64-82f44d483c00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D67B59640>]}
[0m10:39:28.354548 [info ] [MainThread]: Found 2 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m10:39:28.356551 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2232f0f7-e7a0-408f-bc64-82f44d483c00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D677A52E0>]}
[0m10:39:28.359336 [info ] [MainThread]: 
[0m10:39:28.361741 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m10:39:28.363735 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m10:39:28.383735 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m10:39:28.384737 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m10:39:28.384737 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:39:28.457736 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m10:39:28.458738 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m10:39:28.458738 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m10:39:28.469733 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m10:39:28.472740 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m10:39:28.473740 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m10:39:28.482735 [debug] [MainThread]: Using postgres connection "master"
[0m10:39:28.483736 [debug] [MainThread]: On master: BEGIN
[0m10:39:28.483736 [debug] [MainThread]: Opening a new connection, currently in state init
[0m10:39:28.539736 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m10:39:28.540741 [debug] [MainThread]: Using postgres connection "master"
[0m10:39:28.541740 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m10:39:28.554734 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m10:39:28.558736 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2232f0f7-e7a0-408f-bc64-82f44d483c00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D67B59AC0>]}
[0m10:39:28.559737 [debug] [MainThread]: On master: ROLLBACK
[0m10:39:28.560738 [debug] [MainThread]: On master: Close
[0m10:39:28.562741 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m10:39:28.564743 [info ] [MainThread]: 
[0m10:39:28.575746 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m10:39:28.578740 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m10:39:28.579737 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m10:39:28.608738 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m10:39:28.610735 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 10:39:28.580740 => 10:39:28.610735
[0m10:39:28.611738 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m10:39:28.612737 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 10:39:28.612737 => 10:39:28.612737
[0m10:39:28.615737 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m10:39:28.617738 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:39:28.618738 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m10:39:28.619737 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m10:39:28.621737 [debug] [MainThread]: Command end result
[0m10:39:28.637739 [info ] [MainThread]: Compiled node 'test' is:










CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article
		where siteid = ', site, '
		group by 1
	),
    less_tg_data as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published l
		left join cta_per_article a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags
        where siteid = ', site, '
        group by 1
    ),
    agg_data as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags h
        join total_hits t on h.siteid=t.siteid
        join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_first, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data
        group by 1,2,3
    ),
    categories as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d
    ),
    json_data as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories
    ), 
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_second as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_second e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_second as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_second
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_second as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_second l
		left join cta_per_article_second a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_second as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_second
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_second as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_second
        where siteid = ', site, '
        group by 1
    ),
    agg_data_second as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_second h
        join total_hits_second t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_second as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_second
        group by 1,2,3
    ),
    categories_second as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_second
    ),
    json_data_second as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_second
    ), 
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags_r like "%Long read%" then "Long read"
                WHEN tags_r like "%Kort og godt%" then "Kort og godt"
                WHEN tags_r like "%Q&amp%" then "Q&amp"
                WHEN tags_r like "%Best Practice%" then "Best Practice"
                WHEN tags_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_third as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_third e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_third as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_third
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_third as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_third l
		left join cta_per_article_third a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_third as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_third
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_third as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_third
        where siteid = ', site, '
        group by 1
    ),
    agg_data_third as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_third h
        join total_hits_third t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_third as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_third, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_third
        group by 1,2,3
    ),
    categories_third as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_third
    ),
    json_data_third as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_third
    )
    
    SELECT 
		CONCAT(
        ''{'',
            ''"site":'',jd.siteid,'','',
            ''"data": {'',
                ''"label": "'', jd.lab, ''",'',
                ''"categories": ['', jd.cat, ''],'',
                ''"series": ['', jd.series, '']'',
                '',"defaultTitle":"',dtitle,'"'',
                '',"additional":[ ''
                
                ,''{'',
                ''"title":"',title1,'",'',
                ''"data": {'',
                ''"label": "'',_second.lab, ''",'',
                ''"categories": ['', _second.cat, ''],'',
                ''"series": ['', _second.series, '']'',
                ''}''
                
                ,
                
                
                ,''{'',
                ''"title":"',title2,'",'',
                ''"data": {'',
                ''"label": "'',_third.lab, ''",'',
                ''"categories": ['', _third.cat, ''],'',
                ''"series": ['', _third.series, '']'',
                ''}''
                
                
        '']}}''
    
			) as json_data
		  FROM json_data jd
          
          CROSS join json_data_second
          
          CROSS join json_data_third
          ;
[0m10:39:28.661740 [debug] [MainThread]: Command `dbt compile` succeeded at 10:39:28.661740 after 1.18 seconds
[0m10:39:28.663755 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D66D457F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D6751CBF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D611C0890>]}
[0m10:39:28.664738 [debug] [MainThread]: Flushing usage events
[0m10:42:37.294629 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025F2F3120C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025F2F313C80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025F2F3137A0>]}


============================== 10:42:37.299625 | c02edca3-f53c-4a5c-a818-744cb0fa3da8 ==============================
[0m10:42:37.299625 [info ] [MainThread]: Running with dbt=1.7.13
[0m10:42:37.301656 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'invocation_command': 'dbt compile -s test', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m10:42:37.560624 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c02edca3-f53c-4a5c-a818-744cb0fa3da8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025F2F368500>]}
[0m10:42:37.678626 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c02edca3-f53c-4a5c-a818-744cb0fa3da8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025F2F1CAE70>]}
[0m10:42:37.680624 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m10:42:37.696626 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m10:42:37.790625 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m10:42:37.791646 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m10:42:37.999630 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c02edca3-f53c-4a5c-a818-744cb0fa3da8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025F2F95D7F0>]}
[0m10:42:38.013630 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c02edca3-f53c-4a5c-a818-744cb0fa3da8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025F2F6EA300>]}
[0m10:42:38.014630 [info ] [MainThread]: Found 2 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m10:42:38.016635 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c02edca3-f53c-4a5c-a818-744cb0fa3da8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025F2F8D7230>]}
[0m10:42:38.019636 [info ] [MainThread]: 
[0m10:42:38.022628 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m10:42:38.024627 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m10:42:38.042696 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m10:42:38.043668 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m10:42:38.044669 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:42:38.100667 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m10:42:38.100667 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m10:42:38.101665 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m10:42:38.109665 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m10:42:38.111668 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m10:42:38.112665 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m10:42:38.120664 [debug] [MainThread]: Using postgres connection "master"
[0m10:42:38.121665 [debug] [MainThread]: On master: BEGIN
[0m10:42:38.122665 [debug] [MainThread]: Opening a new connection, currently in state init
[0m10:42:38.170666 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m10:42:38.171665 [debug] [MainThread]: Using postgres connection "master"
[0m10:42:38.172665 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m10:42:38.185695 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m10:42:38.189672 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c02edca3-f53c-4a5c-a818-744cb0fa3da8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025F2F741010>]}
[0m10:42:38.191667 [debug] [MainThread]: On master: ROLLBACK
[0m10:42:38.191667 [debug] [MainThread]: On master: Close
[0m10:42:38.194667 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m10:42:38.195666 [info ] [MainThread]: 
[0m10:42:38.203664 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m10:42:38.206699 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m10:42:38.207668 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m10:42:38.241664 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m10:42:38.243669 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 10:42:38.207668 => 10:42:38.242665
[0m10:42:38.244668 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m10:42:38.245666 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 10:42:38.245666 => 10:42:38.245666
[0m10:42:38.247667 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m10:42:38.249666 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:42:38.249666 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m10:42:38.250667 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m10:42:38.251667 [debug] [MainThread]: Command end result
[0m10:42:38.265664 [info ] [MainThread]: Compiled node 'test' is:










CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article
		where siteid = ', site, '
		group by 1
	),
    less_tg_data as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published l
		left join cta_per_article a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags
        where siteid = ', site, '
        group by 1
    ),
    agg_data as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags h
        join total_hits t on h.siteid=t.siteid
        join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_first, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data
        group by 1,2,3
    ),
    categories as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d
    ),
    json_data as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories
    ), 
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_second as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_second e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_second as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_second
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_second as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_second l
		left join cta_per_article_second a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_second as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_second
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_second as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_second
        where siteid = ', site, '
        group by 1
    ),
    agg_data_second as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_second h
        join total_hits_second t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_second as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_second
        group by 1,2,3
    ),
    categories_second as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_second
    ),
    json_data_second as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_second
    ), 
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags_r like "%Long read%" then "Long read"
                WHEN tags_r like "%Kort og godt%" then "Kort og godt"
                WHEN tags_r like "%Q&amp%" then "Q&amp"
                WHEN tags_r like "%Best Practice%" then "Best Practice"
                WHEN tags_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_third as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_third e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_third as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_third
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_third as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_third l
		left join cta_per_article_third a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_third as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_third
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_third as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_third
        where siteid = ', site, '
        group by 1
    ),
    agg_data_third as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_third h
        join total_hits_third t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_third as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_third, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_third
        group by 1,2,3
    ),
    categories_third as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_third
    ),
    json_data_third as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_third
    )
    
    SELECT 
		CONCAT(
        ''{'',
            ''"site":'',jd.siteid,'','',
            ''"data": {'',
                ''"label": "'', jd.lab, ''",'',
                ''"categories": ['', jd.cat, ''],'',
                ''"series": ['', jd.series, '']'',
                '',"defaultTitle":"',dtitle,'"'',
                '',"additional":[ ''
                
                ,''{'',
                ''"title":"',title1,'",'',
                ''"data": {'',
                ''"label": "'',json_data_second.lab, ''",'',
                ''"categories": ['', json_data_second.cat, ''],'',
                ''"series": ['', json_data_second.series, '']'',
                ''}''
                
                ,
                
                
                ,''{'',
                ''"title":"',title2,'",'',
                ''"data": {'',
                ''"label": "'',json_data_third.lab, ''",'',
                ''"categories": ['', json_data_third.cat, ''],'',
                ''"series": ['', json_data_third.series, '']'',
                ''}''
                
                
        '']}}''
    
			) as json_data
		  FROM json_data jd
          
          CROSS join json_data_second
          
          CROSS join json_data_third
          ;
[0m10:42:38.295675 [debug] [MainThread]: Command `dbt compile` succeeded at 10:42:38.295675 after 1.20 seconds
[0m10:42:38.297668 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025F2F0F8680>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025F2F957950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025F2F3120C0>]}
[0m10:42:38.297668 [debug] [MainThread]: Flushing usage events
[0m11:12:51.454110 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015074901880>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015074901850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015074901910>]}


============================== 11:12:51.460111 | 3c0704bb-fe80-4e06-a4e1-dca6bb822f59 ==============================
[0m11:12:51.460111 [info ] [MainThread]: Running with dbt=1.7.13
[0m11:12:51.462111 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_dropdown_dbt_test', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m11:12:51.746238 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3c0704bb-fe80-4e06-a4e1-dca6bb822f59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000150749586B0>]}
[0m11:12:51.867234 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3c0704bb-fe80-4e06-a4e1-dca6bb822f59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000150749263F0>]}
[0m11:12:51.869236 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m11:12:51.884237 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m11:12:51.987899 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m11:12:51.988901 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m11:12:51.995901 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3c0704bb-fe80-4e06-a4e1-dca6bb822f59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015074AF9A90>]}
[0m11:12:52.009903 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3c0704bb-fe80-4e06-a4e1-dca6bb822f59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015074D183B0>]}
[0m11:12:52.010907 [info ] [MainThread]: Found 2 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m11:12:52.011906 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3c0704bb-fe80-4e06-a4e1-dca6bb822f59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000150745D6AB0>]}
[0m11:12:52.015913 [info ] [MainThread]: 
[0m11:12:52.017913 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m11:12:52.019901 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m11:12:52.037903 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:12:52.037903 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m11:12:52.038904 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:12:52.096910 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m11:12:52.097902 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:12:52.097902 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m11:12:52.106901 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m11:12:52.107900 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m11:12:52.108901 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m11:12:52.115899 [debug] [MainThread]: Using postgres connection "master"
[0m11:12:52.116901 [debug] [MainThread]: On master: BEGIN
[0m11:12:52.116901 [debug] [MainThread]: Opening a new connection, currently in state init
[0m11:12:52.166903 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m11:12:52.167903 [debug] [MainThread]: Using postgres connection "master"
[0m11:12:52.168900 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m11:12:52.178900 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m11:12:52.181899 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3c0704bb-fe80-4e06-a4e1-dca6bb822f59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015074D180E0>]}
[0m11:12:52.181899 [debug] [MainThread]: On master: ROLLBACK
[0m11:12:52.182900 [debug] [MainThread]: On master: Close
[0m11:12:52.184903 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:12:52.185903 [info ] [MainThread]: 
[0m11:12:52.190900 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_dropdown_dbt_test
[0m11:12:52.192903 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_dropdown_dbt_test'
[0m11:12:52.192903 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_dropdown_dbt_test
[0m11:12:52.216914 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_dropdown_dbt_test"
[0m11:12:52.219901 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_dropdown_dbt_test (compile): 11:12:52.193901 => 11:12:52.219901
[0m11:12:52.221902 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_dropdown_dbt_test
[0m11:12:52.222904 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_dropdown_dbt_test (execute): 11:12:52.222904 => 11:12:52.222904
[0m11:12:52.225903 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_dropdown_dbt_test
[0m11:12:52.226901 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:12:52.227901 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m11:12:52.227901 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_dropdown_dbt_test' was properly closed.
[0m11:12:52.229903 [debug] [MainThread]: Command end result
[0m11:12:52.241902 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_month_dropdown_dbt_test' is:








CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article
		where siteid = ', site, '
		group by 1
	),
    less_tg_data as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published l
		left join cta_per_article a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags
        where siteid = ', site, '
        group by 1
    ),
    agg_data as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags h
        join total_hits t on h.siteid=t.siteid
        join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_first, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data
        group by 1,2,3
    ),
    categories as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d
    ),
    json_data as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories
    ), 
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_second as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_second e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_second as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_second
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_second as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_second l
		left join cta_per_article_second a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_second as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_second
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_second as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_second
        where siteid = ', site, '
        group by 1
    ),
    agg_data_second as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_second h
        join total_hits_second t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_second as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_second
        group by 1,2,3
    ),
    categories_second as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_second
    ),
    json_data_second as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_second
    ), 
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags_r like "%Long read%" then "Long read"
                WHEN tags_r like "%Kort og godt%" then "Kort og godt"
                WHEN tags_r like "%Q&amp%" then "Q&amp"
                WHEN tags_r like "%Best Practice%" then "Best Practice"
                WHEN tags_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_third as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_third e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_third as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_third
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_third as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_third l
		left join cta_per_article_third a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_third as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_third
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_third as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_third
        where siteid = ', site, '
        group by 1
    ),
    agg_data_third as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_third h
        join total_hits_third t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_third as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_third, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_third
        group by 1,2,3
    ),
    categories_third as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_third
    ),
    json_data_third as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_third
    )
    
    SELECT 
		CONCAT(
        ''{'',''"site":'',jd.siteid,'','',
        ''"data": {'',
        ''"label": "'', jd.lab, ''",'',
        ''"categories": ['', jd.cat, ''],'',
        ''"series": ['', jd.series, '']'',
        '',"defaultTitle":"',dtitle,'"'',
        '',"additional":[ {'',
        ''"title":"',title1,'",'',

        ''"data": {'',
        ''"label": "'',jnd.lab, ''",'',
        ''"categories": ['', jnd.cat, ''],'',
        ''"series": ['', jnd.series, '']'',
        ''}},'',
        ''{"title":"',title2,'",'',
        
        ''"data": {'',
        ''"label": "'', jrd.lab, ''",'',
        ''"categories": ['', jrd.cat, ''],'',
        ''"series": ['', jrd.series, '']'',
        ''}}]}}''
    
			) as json_data
		  FROM json_data jd
          CROSS join json_data_second jnd
          CROSS join json_data_third jrd;
[0m11:12:52.257907 [debug] [MainThread]: Command `dbt compile` succeeded at 11:12:52.257907 after 1.00 seconds
[0m11:12:52.259905 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001506E565610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015071A056A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015074812F30>]}
[0m11:12:52.260902 [debug] [MainThread]: Flushing usage events
[0m11:31:07.682963 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021D36683D40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021D36681B20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021D36682D80>]}


============================== 11:31:07.689960 | 2cdd7d01-f2da-4a32-8bec-ded628d31106 ==============================
[0m11:31:07.689960 [info ] [MainThread]: Running with dbt=1.7.13
[0m11:31:07.691970 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s test', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m11:31:08.043960 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2cdd7d01-f2da-4a32-8bec-ded628d31106', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021D367F7080>]}
[0m11:31:08.165962 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2cdd7d01-f2da-4a32-8bec-ded628d31106', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021D36468620>]}
[0m11:31:08.167961 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m11:31:08.182964 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m11:31:08.282996 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m11:31:08.282996 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m11:31:08.290962 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2cdd7d01-f2da-4a32-8bec-ded628d31106', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021D36951D90>]}
[0m11:31:08.304962 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2cdd7d01-f2da-4a32-8bec-ded628d31106', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021D369CD400>]}
[0m11:31:08.305965 [info ] [MainThread]: Found 2 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m11:31:08.307970 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2cdd7d01-f2da-4a32-8bec-ded628d31106', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021D35B4EAB0>]}
[0m11:31:08.311995 [info ] [MainThread]: 
[0m11:31:08.313963 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m11:31:08.316963 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m11:31:08.339961 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:31:08.340962 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m11:31:08.342965 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:31:08.406961 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m11:31:08.407961 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:31:08.407961 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m11:31:08.418959 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m11:31:08.420959 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m11:31:08.421959 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m11:31:08.428958 [debug] [MainThread]: Using postgres connection "master"
[0m11:31:08.429961 [debug] [MainThread]: On master: BEGIN
[0m11:31:08.429961 [debug] [MainThread]: Opening a new connection, currently in state init
[0m11:31:08.479962 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m11:31:08.480963 [debug] [MainThread]: Using postgres connection "master"
[0m11:31:08.481962 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m11:31:08.492959 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m11:31:08.495959 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2cdd7d01-f2da-4a32-8bec-ded628d31106', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021D36A24890>]}
[0m11:31:08.495959 [debug] [MainThread]: On master: ROLLBACK
[0m11:31:08.496959 [debug] [MainThread]: On master: Close
[0m11:31:08.498961 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:31:08.499966 [info ] [MainThread]: 
[0m11:31:08.505961 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m11:31:08.506962 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m11:31:08.507964 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m11:31:08.534961 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m11:31:08.536963 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 11:31:08.508962 => 11:31:08.535962
[0m11:31:08.537964 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m11:31:08.538970 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 11:31:08.537964 => 11:31:08.537964
[0m11:31:08.540964 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m11:31:08.542999 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:31:08.543962 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m11:31:08.543962 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m11:31:08.545963 [debug] [MainThread]: Command end result
[0m11:31:08.557973 [info ] [MainThread]: Compiled node 'test' is:










CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article
		where siteid = ', site, '
		group by 1
	),
    less_tg_data as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published l
		left join cta_per_article a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags
        where siteid = ', site, '
        group by 1
    ),
    agg_data as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags h
        join total_hits t on h.siteid=t.siteid
        join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_first, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data
        group by 1,2,3
    ),
    categories as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d
    ),
    json_data as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories
    ), 
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_second as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_second e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_second as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_second
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_second as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_second l
		left join cta_per_article_second a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_second as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_second
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_second as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_second
        where siteid = ', site, '
        group by 1
    ),
    agg_data_second as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_second h
        join total_hits_second t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_second as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_second
        group by 1,2,3
    ),
    categories_second as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_second
    ),
    json_data_second as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_second
    ), 
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags_r like "%Long read%" then "Long read"
                WHEN tags_r like "%Kort og godt%" then "Kort og godt"
                WHEN tags_r like "%Q&amp%" then "Q&amp"
                WHEN tags_r like "%Best Practice%" then "Best Practice"
                WHEN tags_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_third as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_third e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_third as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_third
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_third as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_third l
		left join cta_per_article_third a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_third as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_third
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_third as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_third
        where siteid = ', site, '
        group by 1
    ),
    agg_data_third as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_third h
        join total_hits_third t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_third as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_third, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_third
        group by 1,2,3
    ),
    categories_third as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_third
    ),
    json_data_third as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_third
    )
    
    SELECT 
		CONCAT(
        ''{'',
            ''"site":'',jd.siteid,'','',
            ''"data": {'',
                ''"label": "'', jd.lab, ''",'',
                ''"categories": ['', jd.cat, ''],'',
                ''"series": ['', jd.series, '']'',
                '',"defaultTitle":"',dtitle,'"'',
                '',"additional":[ ''
                
                ,''{'',
                ''"title":"',title1,'",'',
                ''"data": {'',
                ''"label": "'',json_data_second.lab, ''",'',
                ''"categories": ['', json_data_second.cat, ''],'',
                ''"series": ['', json_data_second.series, '']'',
                ''}''
                
                ,
                
                
                ,''{'',
                ''"title":"',title2,'",'',
                ''"data": {'',
                ''"label": "'',json_data_third.lab, ''",'',
                ''"categories": ['', json_data_third.cat, ''],'',
                ''"series": ['', json_data_third.series, '']'',
                ''}''
                
                
        '']}}''
    
			) as json_data
		  FROM json_data jd
          
          CROSS join json_data_second
          
          CROSS join json_data_third
          ;
[0m11:31:08.576845 [debug] [MainThread]: Command `dbt compile` succeeded at 11:31:08.576845 after 1.16 seconds
[0m11:31:08.577843 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021D36681D30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021D36683D40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021D36681B20>]}
[0m11:31:08.578844 [debug] [MainThread]: Flushing usage events
[0m18:17:15.767152 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012605BE3E00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012605BE25A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012605BE29F0>]}


============================== 18:17:15.774506 | 90a5fd31-c806-4ad4-820e-64b2920a0328 ==============================
[0m18:17:15.774506 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:17:15.776485 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'send_anonymous_usage_stats': 'True'}
[0m18:17:16.134300 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '90a5fd31-c806-4ad4-820e-64b2920a0328', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000126050769F0>]}
[0m18:17:16.261287 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '90a5fd31-c806-4ad4-820e-64b2920a0328', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012605BE2E10>]}
[0m18:17:16.264287 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:17:16.281155 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:17:17.112056 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 2 files added, 0 files changed.
[0m18:17:17.113059 [debug] [MainThread]: Partial parsing: added file: dbt_project_test_kasper://models\test2.sql
[0m18:17:17.114063 [debug] [MainThread]: Partial parsing: added file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m18:17:17.304073 [error] [MainThread]: Encountered an error:
Compilation Error in model tactical_userneeds_pageviews_chart_month_13 (models\tactical_userneeds_pageviews_chart_month_13.sql)
  Unexpected end of template. Jinja was looking for the following tags: 'endfor' or 'else'. The innermost block that needs to be closed is 'for'.
    line 32
      ELSE ''others''
[0m18:17:17.307072 [debug] [MainThread]: Command `dbt compile` failed at 18:17:17.306076 after 1.76 seconds
[0m18:17:17.308076 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000126059C8680>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012605F27500>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001260609F5C0>]}
[0m18:17:17.310099 [debug] [MainThread]: Flushing usage events
[0m18:19:24.830058 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221C0B53920>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221C0B52690>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221C0B52270>]}


============================== 18:19:24.837060 | 49331fca-161f-4cf9-a761-c99344b74377 ==============================
[0m18:19:24.837060 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:19:24.839062 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'send_anonymous_usage_stats': 'True'}
[0m18:19:25.098223 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '49331fca-161f-4cf9-a761-c99344b74377', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221C0A08B60>]}
[0m18:19:25.219221 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '49331fca-161f-4cf9-a761-c99344b74377', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221C0B53C50>]}
[0m18:19:25.220221 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:19:25.233220 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:19:25.326048 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 2 files added, 0 files changed.
[0m18:19:25.327051 [debug] [MainThread]: Partial parsing: added file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m18:19:25.328052 [debug] [MainThread]: Partial parsing: added file: dbt_project_test_kasper://models\test2.sql
[0m18:19:25.538183 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '49331fca-161f-4cf9-a761-c99344b74377', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221C0B51D60>]}
[0m18:19:25.567252 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '49331fca-161f-4cf9-a761-c99344b74377', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221C0EBCEF0>]}
[0m18:19:25.569198 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m18:19:25.570201 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '49331fca-161f-4cf9-a761-c99344b74377', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221BDC51BB0>]}
[0m18:19:25.573200 [info ] [MainThread]: 
[0m18:19:25.574201 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:19:25.576200 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:19:25.602201 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:19:25.603199 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:19:25.604202 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:19:25.679200 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:19:25.679200 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:19:25.680199 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:19:25.693200 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:19:25.696196 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:19:25.697199 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:19:25.704206 [debug] [MainThread]: Using postgres connection "master"
[0m18:19:25.705198 [debug] [MainThread]: On master: BEGIN
[0m18:19:25.706201 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:19:25.761198 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:19:25.762200 [debug] [MainThread]: Using postgres connection "master"
[0m18:19:25.763200 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:19:25.776199 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:19:25.778197 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '49331fca-161f-4cf9-a761-c99344b74377', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221C0F088C0>]}
[0m18:19:25.779203 [debug] [MainThread]: On master: ROLLBACK
[0m18:19:25.780201 [debug] [MainThread]: On master: Close
[0m18:19:25.782200 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:19:25.784200 [info ] [MainThread]: 
[0m18:19:25.790182 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:19:25.791183 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13'
[0m18:19:25.792181 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:19:25.807192 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13"
[0m18:19:25.809357 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (compile): 18:19:25.792181 => 18:19:25.808363
[0m18:19:25.809357 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:19:25.811359 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (execute): 18:19:25.810361 => 18:19:25.810361
[0m18:19:25.814361 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:19:25.815363 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:19:25.816359 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:19:25.817357 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13' was properly closed.
[0m18:19:25.817894 [debug] [MainThread]: Command end result
[0m18:19:25.829452 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_month_13' is:





CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_13`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
        SELECT
        siteid as siteid,
        id,
        date as fdate,
		CASE
			WHEN userneeds like "%Opdater mig%" then "Opdater mig"
                WHEN userneeds like "%Forbind mig%" then "Forbind mig"
                WHEN userneeds like "%Help mig med at forsta%" then "Help mig med at forsta"
                WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
                WHEN userneeds like "%Underhold mig%" then "Underhold mig"
                WHEN userneeds like "%Inspirer migg%" then "Inspirer migg"
                ELSE ''others''
		END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '), 
    
    last_30_days_article_published_second as
    (
        SELECT
        siteid as siteid,
        id,
        date as fdate,
		CASE
			WHEN Categories like "%Long read%" then "Long read"
                WHEN Categories like "%Kort og godt%" then "Kort og godt"
                WHEN Categories like "%Q&amp%" then "Q&amp"
                WHEN Categories like "%Best Practice%" then "Best Practice"
                WHEN Categories like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
		END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '), 
    
    last_30_days_article_published_third as
    (
        SELECT
        siteid as siteid,
        id,
        date as fdate,
		CASE
			WHEN Tags like "%order_statement_second%" then "order_statement_second"
                ELSE ''others''
		END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    
[0m18:19:25.833454 [debug] [MainThread]: Command `dbt compile` succeeded at 18:19:25.833454 after 1.21 seconds
[0m18:19:25.834453 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221C0B83FB0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221C0B83FE0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221C09E6B10>]}
[0m18:19:25.835455 [debug] [MainThread]: Flushing usage events
[0m18:20:43.203232 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024ACD2961B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024ACD295910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024ACD297AA0>]}


============================== 18:20:43.209232 | d3c3aa7e-7140-40f7-aa6c-b50efac47310 ==============================
[0m18:20:43.209232 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:20:43.212234 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:20:43.477359 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd3c3aa7e-7140-40f7-aa6c-b50efac47310', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024ACD2E99D0>]}
[0m18:20:43.605411 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd3c3aa7e-7140-40f7-aa6c-b50efac47310', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024ACD0783E0>]}
[0m18:20:43.607412 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:20:43.620510 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:20:43.723106 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:20:43.723106 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m18:20:43.923068 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd3c3aa7e-7140-40f7-aa6c-b50efac47310', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024ACD4707A0>]}
[0m18:20:43.937069 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd3c3aa7e-7140-40f7-aa6c-b50efac47310', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024ACD639700>]}
[0m18:20:43.939067 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m18:20:43.941076 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd3c3aa7e-7140-40f7-aa6c-b50efac47310', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024ACD7CE570>]}
[0m18:20:43.944078 [info ] [MainThread]: 
[0m18:20:43.946066 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:20:43.948065 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:20:43.966065 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:20:43.967066 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:20:43.968067 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:20:44.029064 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:20:44.030097 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:20:44.031069 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:20:44.039067 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:20:44.041063 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:20:44.042063 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:20:44.051062 [debug] [MainThread]: Using postgres connection "master"
[0m18:20:44.052063 [debug] [MainThread]: On master: BEGIN
[0m18:20:44.053065 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:20:44.102065 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:20:44.103067 [debug] [MainThread]: Using postgres connection "master"
[0m18:20:44.104065 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:20:44.114062 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:20:44.116067 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd3c3aa7e-7140-40f7-aa6c-b50efac47310', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024ACD63B5F0>]}
[0m18:20:44.117066 [debug] [MainThread]: On master: ROLLBACK
[0m18:20:44.118064 [debug] [MainThread]: On master: Close
[0m18:20:44.120066 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:20:44.129095 [info ] [MainThread]: 
[0m18:20:44.133064 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:20:44.135065 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13'
[0m18:20:44.135065 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:20:44.152071 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13"
[0m18:20:44.154066 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (compile): 18:20:44.136063 => 18:20:44.153064
[0m18:20:44.155070 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:20:44.156067 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (execute): 18:20:44.156067 => 18:20:44.156067
[0m18:20:44.158069 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:20:44.161066 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:20:44.162097 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:20:44.163070 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13' was properly closed.
[0m18:20:44.164065 [debug] [MainThread]: Command end result
[0m18:20:44.176069 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_month_13' is:





CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_13`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
        SELECT
        siteid as siteid,
        id,
        date as fdate,
		CASE
			WHEN userneeds like "%Opdater mig%" then "Opdater mig"
            WHEN userneeds like "%Forbind mig%" then "Forbind mig"
            WHEN userneeds like "%Help mig med at forsta%" then "Help mig med at forsta"
            WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
            WHEN userneeds like "%Underhold mig%" then "Underhold mig"
            WHEN userneeds like "%Inspirer migg%" then "Inspirer migg"
            ELSE ''others''
		END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '), 
    
    last_30_days_article_published_second as
    (
        SELECT
        siteid as siteid,
        id,
        date as fdate,
		CASE
			WHEN Categories like "%Long read%" then "Long read"
            WHEN Categories like "%Kort og godt%" then "Kort og godt"
            WHEN Categories like "%Q&amp%" then "Q&amp"
            WHEN Categories like "%Best Practice%" then "Best Practice"
            WHEN Categories like "%Viden og forskning%" then "Viden og forskning"
            ELSE ''others''
		END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '), 
    
    last_30_days_article_published_third as
    (
        SELECT
        siteid as siteid,
        id,
        date as fdate,
		CASE
			WHEN Tags like "%order_statement_second%" then "order_statement_second"
            ELSE ''others''
		END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    
[0m18:20:44.181073 [debug] [MainThread]: Command `dbt compile` succeeded at 18:20:44.181073 after 1.13 seconds
[0m18:20:44.182079 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024ACD148860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024ACD295910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024ACD2961B0>]}
[0m18:20:44.183072 [debug] [MainThread]: Flushing usage events
[0m18:21:59.459177 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF4A9A1BB0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF4A9A38F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF4A9A3200>]}


============================== 18:21:59.465175 | 233a2e9f-e2a4-436a-bcbe-5be2b049de54 ==============================
[0m18:21:59.465175 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:21:59.468180 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'send_anonymous_usage_stats': 'True'}
[0m18:21:59.733172 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '233a2e9f-e2a4-436a-bcbe-5be2b049de54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF4A7ED8B0>]}
[0m18:21:59.853269 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '233a2e9f-e2a4-436a-bcbe-5be2b049de54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF4A983F80>]}
[0m18:21:59.855267 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:21:59.870296 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:21:59.971393 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:21:59.972397 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m18:22:00.179180 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '233a2e9f-e2a4-436a-bcbe-5be2b049de54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF4AF2E810>]}
[0m18:22:00.194209 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '233a2e9f-e2a4-436a-bcbe-5be2b049de54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF4AD99760>]}
[0m18:22:00.195209 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m18:22:00.196220 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '233a2e9f-e2a4-436a-bcbe-5be2b049de54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF4AF38800>]}
[0m18:22:00.200180 [info ] [MainThread]: 
[0m18:22:00.201187 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:22:00.204177 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:22:00.222270 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:22:00.223271 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:22:00.224275 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:22:00.284124 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:22:00.284124 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:22:00.285124 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:22:00.294011 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:22:00.296011 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:22:00.296011 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:22:00.303531 [debug] [MainThread]: Using postgres connection "master"
[0m18:22:00.304535 [debug] [MainThread]: On master: BEGIN
[0m18:22:00.305534 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:22:00.354552 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:22:00.355553 [debug] [MainThread]: Using postgres connection "master"
[0m18:22:00.356553 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:22:00.365550 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:22:00.367549 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '233a2e9f-e2a4-436a-bcbe-5be2b049de54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF4AD990A0>]}
[0m18:22:00.368551 [debug] [MainThread]: On master: ROLLBACK
[0m18:22:00.369551 [debug] [MainThread]: On master: Close
[0m18:22:00.371557 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:22:00.373557 [info ] [MainThread]: 
[0m18:22:00.377556 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:22:00.379551 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13'
[0m18:22:00.379551 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:22:00.395549 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13"
[0m18:22:00.397552 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (compile): 18:22:00.380552 => 18:22:00.397552
[0m18:22:00.399555 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:22:00.401569 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (execute): 18:22:00.400553 => 18:22:00.400553
[0m18:22:00.404590 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:22:00.405552 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:22:00.406551 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:22:00.407553 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13' was properly closed.
[0m18:22:00.408553 [debug] [MainThread]: Command end result
[0m18:22:00.420556 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_month_13' is:





CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_13`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN userneeds like "%Opdater mig%" then "Opdater mig"
                WHEN userneeds like "%Forbind mig%" then "Forbind mig"
                WHEN userneeds like "%Help mig med at forsta%" then "Help mig med at forsta"
                WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
                WHEN userneeds like "%Underhold mig%" then "Underhold mig"
                WHEN userneeds like "%Inspirer migg%" then "Inspirer migg"
                ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '), 
    
    last_30_days_article_published_second as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Categories like "%Long read%" then "Long read"
                WHEN Categories like "%Kort og godt%" then "Kort og godt"
                WHEN Categories like "%Q&amp%" then "Q&amp"
                WHEN Categories like "%Best Practice%" then "Best Practice"
                WHEN Categories like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '), 
    
    last_30_days_article_published_third as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Tags like "%order_statement_second%" then "order_statement_second"
                ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    
[0m18:22:00.435619 [debug] [MainThread]: Command `dbt compile` succeeded at 18:22:00.435619 after 1.13 seconds
[0m18:22:00.437629 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF4A983EC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF442B5460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF4A5A1DC0>]}
[0m18:22:00.439658 [debug] [MainThread]: Flushing usage events
[0m18:22:37.118152 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D15022780>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D14EDB320>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D15022480>]}


============================== 18:22:37.124153 | a581ca89-ab67-4334-b20d-cf4b9e9627ff ==============================
[0m18:22:37.124153 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:22:37.126157 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m18:22:37.386746 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a581ca89-ab67-4334-b20d-cf4b9e9627ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D150E9100>]}
[0m18:22:37.508507 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a581ca89-ab67-4334-b20d-cf4b9e9627ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D15003EF0>]}
[0m18:22:37.510489 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:22:37.527319 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:22:37.629550 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:22:37.630550 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m18:22:37.831146 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a581ca89-ab67-4334-b20d-cf4b9e9627ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D15626240>]}
[0m18:22:37.845149 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a581ca89-ab67-4334-b20d-cf4b9e9627ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D154198E0>]}
[0m18:22:37.847151 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m18:22:37.849152 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a581ca89-ab67-4334-b20d-cf4b9e9627ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D1553B7A0>]}
[0m18:22:37.851153 [info ] [MainThread]: 
[0m18:22:37.852146 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:22:37.855148 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:22:37.872146 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:22:37.873149 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:22:37.873149 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:22:38.027251 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:22:38.028252 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:22:38.029250 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:22:38.037253 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:22:38.039736 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:22:38.040735 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:22:38.051904 [debug] [MainThread]: Using postgres connection "master"
[0m18:22:38.052903 [debug] [MainThread]: On master: BEGIN
[0m18:22:38.053902 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:22:38.105454 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:22:38.106477 [debug] [MainThread]: Using postgres connection "master"
[0m18:22:38.107459 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:22:38.116453 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:22:38.118456 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a581ca89-ab67-4334-b20d-cf4b9e9627ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D1541B620>]}
[0m18:22:38.119455 [debug] [MainThread]: On master: ROLLBACK
[0m18:22:38.120458 [debug] [MainThread]: On master: Close
[0m18:22:38.122460 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:22:38.123463 [info ] [MainThread]: 
[0m18:22:38.128455 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:22:38.130458 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13'
[0m18:22:38.131464 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:22:38.147475 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13"
[0m18:22:38.152460 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (compile): 18:22:38.132462 => 18:22:38.151485
[0m18:22:38.153461 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:22:38.155460 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (execute): 18:22:38.154461 => 18:22:38.154461
[0m18:22:38.158461 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:22:38.161456 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:22:38.163478 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:22:38.165456 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13' was properly closed.
[0m18:22:38.167457 [debug] [MainThread]: Command end result
[0m18:22:38.183459 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_month_13' is:





CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_13`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    
			    WHEN userneeds like "%Opdater mig%" then "Opdater mig"
                
			    WHEN userneeds like "%Forbind mig%" then "Forbind mig"
                
			    WHEN userneeds like "%Help mig med at forsta%" then "Help mig med at forsta"
                
			    WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
                
			    WHEN userneeds like "%Underhold mig%" then "Underhold mig"
                
			    WHEN userneeds like "%Inspirer migg%" then "Inspirer migg"
                ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '), 
    
    last_30_days_article_published_second as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    
			    WHEN Categories like "%Long read%" then "Long read"
                
			    WHEN Categories like "%Kort og godt%" then "Kort og godt"
                
			    WHEN Categories like "%Q&amp%" then "Q&amp"
                
			    WHEN Categories like "%Best Practice%" then "Best Practice"
                
			    WHEN Categories like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '), 
    
    last_30_days_article_published_third as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    
			    WHEN Tags like "%order_statement_second%" then "order_statement_second"
                ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    
[0m18:22:38.191463 [debug] [MainThread]: Command `dbt compile` succeeded at 18:22:38.190460 after 1.23 seconds
[0m18:22:38.193462 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D1435F830>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D14E6EF00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D0EA75460>]}
[0m18:22:38.194475 [debug] [MainThread]: Flushing usage events
[0m18:23:53.405176 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000170B43B3680>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000170B43B3B30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000170B43B2D80>]}


============================== 18:23:53.411176 | 15802d16-1ecd-437e-a85e-741669f0e11d ==============================
[0m18:23:53.411176 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:23:53.413187 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:23:53.810709 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '15802d16-1ecd-437e-a85e-741669f0e11d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000170B4408740>]}
[0m18:23:53.954703 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '15802d16-1ecd-437e-a85e-741669f0e11d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000170B428FBF0>]}
[0m18:23:53.956706 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:23:53.970354 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:23:54.067353 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:23:54.068365 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m18:23:54.269281 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '15802d16-1ecd-437e-a85e-741669f0e11d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000170B4A46270>]}
[0m18:23:54.283281 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '15802d16-1ecd-437e-a85e-741669f0e11d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000170B47F11F0>]}
[0m18:23:54.285282 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m18:23:54.286287 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '15802d16-1ecd-437e-a85e-741669f0e11d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000170B4409100>]}
[0m18:23:54.289294 [info ] [MainThread]: 
[0m18:23:54.290284 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:23:54.293280 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:23:54.311284 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:23:54.311284 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:23:54.312285 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:23:54.478930 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:23:54.479933 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:23:54.480933 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:23:54.488947 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:23:54.490945 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:23:54.491943 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:23:54.498946 [debug] [MainThread]: Using postgres connection "master"
[0m18:23:54.499945 [debug] [MainThread]: On master: BEGIN
[0m18:23:54.500945 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:23:54.551585 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:23:54.552588 [debug] [MainThread]: Using postgres connection "master"
[0m18:23:54.552588 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:23:54.562587 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:23:54.564584 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '15802d16-1ecd-437e-a85e-741669f0e11d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000170B47F2AE0>]}
[0m18:23:54.565585 [debug] [MainThread]: On master: ROLLBACK
[0m18:23:54.566586 [debug] [MainThread]: On master: Close
[0m18:23:54.568588 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:23:54.570597 [info ] [MainThread]: 
[0m18:23:54.576584 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:23:54.577585 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13'
[0m18:23:54.578588 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:23:54.595585 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13"
[0m18:23:54.597604 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (compile): 18:23:54.579585 => 18:23:54.597604
[0m18:23:54.599586 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:23:54.600589 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (execute): 18:23:54.600589 => 18:23:54.600589
[0m18:23:54.602588 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:23:54.604585 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:23:54.605609 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:23:54.606586 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13' was properly closed.
[0m18:23:54.607586 [debug] [MainThread]: Command end result
[0m18:23:54.619586 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_month_13' is:





CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_13`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN userneeds like "%Opdater mig%" then "Opdater mig"
                WHEN userneeds like "%Forbind mig%" then "Forbind mig"
                WHEN userneeds like "%Help mig med at forsta%" then "Help mig med at forsta"
                WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
                WHEN userneeds like "%Underhold mig%" then "Underhold mig"
                WHEN userneeds like "%Inspirer migg%" then "Inspirer migg"
                ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '), 
    
    last_30_days_article_published_second as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Categories like "%Long read%" then "Long read"
                WHEN Categories like "%Kort og godt%" then "Kort og godt"
                WHEN Categories like "%Q&amp%" then "Q&amp"
                WHEN Categories like "%Best Practice%" then "Best Practice"
                WHEN Categories like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '), 
    
    last_30_days_article_published_third as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Tags like "%order_statement_second%" then "order_statement_second"
                ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    
[0m18:23:54.624585 [debug] [MainThread]: Command `dbt compile` succeeded at 18:23:54.623584 after 1.37 seconds
[0m18:23:54.625585 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000170B36EF830>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000170B43B3680>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000170B43B3B30>]}
[0m18:23:54.627599 [debug] [MainThread]: Flushing usage events
[0m18:27:01.966890 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202CF6C2030>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202CF6C3B90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202CF6C23C0>]}


============================== 18:27:01.972888 | 5d899d6d-a8ed-4275-9bfe-04376426e33d ==============================
[0m18:27:01.972888 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:27:01.974890 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'send_anonymous_usage_stats': 'True'}
[0m18:27:02.236464 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '5d899d6d-a8ed-4275-9bfe-04376426e33d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202CF6C01A0>]}
[0m18:27:02.361458 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '5d899d6d-a8ed-4275-9bfe-04376426e33d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202CF789C40>]}
[0m18:27:02.363462 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:27:02.378501 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:27:02.481055 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:27:02.482055 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m18:27:02.684257 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '5d899d6d-a8ed-4275-9bfe-04376426e33d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202CF6C1730>]}
[0m18:27:02.699265 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '5d899d6d-a8ed-4275-9bfe-04376426e33d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202CFA21940>]}
[0m18:27:02.700265 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m18:27:02.702263 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '5d899d6d-a8ed-4275-9bfe-04376426e33d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202CFA23890>]}
[0m18:27:02.704261 [info ] [MainThread]: 
[0m18:27:02.706263 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:27:02.708336 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:27:02.726328 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:27:02.727331 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:27:02.727331 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:27:02.785288 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:27:02.786289 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:27:02.786289 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:27:02.795809 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:27:02.797807 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:27:02.798811 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:27:02.806810 [debug] [MainThread]: Using postgres connection "master"
[0m18:27:02.807811 [debug] [MainThread]: On master: BEGIN
[0m18:27:02.808812 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:27:02.859336 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:27:02.860337 [debug] [MainThread]: Using postgres connection "master"
[0m18:27:02.861335 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:27:02.870336 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:27:02.873338 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '5d899d6d-a8ed-4275-9bfe-04376426e33d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202CFA20F80>]}
[0m18:27:02.873338 [debug] [MainThread]: On master: ROLLBACK
[0m18:27:02.874336 [debug] [MainThread]: On master: Close
[0m18:27:02.876341 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:27:02.877347 [info ] [MainThread]: 
[0m18:27:02.892336 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:27:02.894338 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13'
[0m18:27:02.894338 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:27:02.911855 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13"
[0m18:27:02.913849 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (compile): 18:27:02.895338 => 18:27:02.912850
[0m18:27:02.914849 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:27:02.916850 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (execute): 18:27:02.915851 => 18:27:02.915851
[0m18:27:02.918850 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:27:02.920850 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:27:02.921852 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:27:02.922850 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13' was properly closed.
[0m18:27:02.923849 [debug] [MainThread]: Command end result
[0m18:27:02.933847 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_month_13' is:





CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_13`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN userneeds like "%Opdater mig%" then "Opdater mig"
                WHEN userneeds like "%Forbind mig%" then "Forbind mig"
                WHEN userneeds like "%Help mig med at forsta%" then "Help mig med at forsta"
                WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
                WHEN userneeds like "%Underhold mig%" then "Underhold mig"
                WHEN userneeds like "%Inspirer migg%" then "Inspirer migg"
                ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		), 
    
    last_30_days_article_published_second as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Categories like "%Long read%" then "Long read"
                WHEN Categories like "%Kort og godt%" then "Kort og godt"
                WHEN Categories like "%Q&amp%" then "Q&amp"
                WHEN Categories like "%Best Practice%" then "Best Practice"
                WHEN Categories like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_second  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		), 
    
    last_30_days_article_published_third as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Tags like "%order_statement_second%" then "order_statement_second"
                ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_third  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		)
    
[0m18:27:02.940853 [debug] [MainThread]: Command `dbt compile` succeeded at 18:27:02.940853 after 1.18 seconds
[0m18:27:02.941854 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202CF0BF830>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202CF6C3B90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202CF6C23C0>]}
[0m18:27:02.942859 [debug] [MainThread]: Flushing usage events
[0m18:30:10.365660 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021703121820>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021703121310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021703121880>]}


============================== 18:30:10.371681 | 7c45ed0a-ebf4-49cd-a4d0-10cd6dd53199 ==============================
[0m18:30:10.371681 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:30:10.373687 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:30:10.634331 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '7c45ed0a-ebf4-49cd-a4d0-10cd6dd53199', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021702F6E9F0>]}
[0m18:30:10.756366 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '7c45ed0a-ebf4-49cd-a4d0-10cd6dd53199', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021702F0ADE0>]}
[0m18:30:10.757370 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:30:10.771622 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:30:10.875315 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:30:10.876315 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m18:30:11.077769 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '7c45ed0a-ebf4-49cd-a4d0-10cd6dd53199', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002170349C260>]}
[0m18:30:11.091790 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '7c45ed0a-ebf4-49cd-a4d0-10cd6dd53199', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217035017F0>]}
[0m18:30:11.092789 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m18:30:11.094794 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7c45ed0a-ebf4-49cd-a4d0-10cd6dd53199', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002170361D070>]}
[0m18:30:11.096787 [info ] [MainThread]: 
[0m18:30:11.097791 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:30:11.099803 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:30:11.117819 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:30:11.118835 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:30:11.120860 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:30:11.179159 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:30:11.180162 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:30:11.181164 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:30:11.190164 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:30:11.192166 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:30:11.193163 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:30:11.199175 [debug] [MainThread]: Using postgres connection "master"
[0m18:30:11.200162 [debug] [MainThread]: On master: BEGIN
[0m18:30:11.201165 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:30:11.253197 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:30:11.253197 [debug] [MainThread]: Using postgres connection "master"
[0m18:30:11.254180 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:30:11.263200 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:30:11.266205 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7c45ed0a-ebf4-49cd-a4d0-10cd6dd53199', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217035017F0>]}
[0m18:30:11.266205 [debug] [MainThread]: On master: ROLLBACK
[0m18:30:11.267205 [debug] [MainThread]: On master: Close
[0m18:30:11.269203 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:30:11.270201 [info ] [MainThread]: 
[0m18:30:11.275200 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:30:11.276203 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13'
[0m18:30:11.277201 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:30:11.294232 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13"
[0m18:30:11.297235 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (compile): 18:30:11.278201 => 18:30:11.296231
[0m18:30:11.298234 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:30:11.299261 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (execute): 18:30:11.299261 => 18:30:11.299261
[0m18:30:11.301233 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:30:11.303232 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:30:11.304267 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:30:11.305233 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13' was properly closed.
[0m18:30:11.306236 [debug] [MainThread]: Command end result
[0m18:30:11.318278 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_month_13' is:





CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_13`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN userneeds like "%Opdater mig%" then "Opdater mig"
                WHEN userneeds like "%Forbind mig%" then "Forbind mig"
                WHEN userneeds like "%Help mig med at forsta%" then "Help mig med at forsta"
                WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
                WHEN userneeds like "%Underhold mig%" then "Underhold mig"
                WHEN userneeds like "%Inspirer migg%" then "Inspirer migg"
                ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article  e
			where  e.siteid = ', site, '
			group by 1,2,3

		), 
    
    last_30_days_article_published_second as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Categories like "%Long read%" then "Long read"
                WHEN Categories like "%Kort og godt%" then "Kort og godt"
                WHEN Categories like "%Q&amp%" then "Q&amp"
                WHEN Categories like "%Best Practice%" then "Best Practice"
                WHEN Categories like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_second as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_second  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_second as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_second  e
			where  e.siteid = ', site, '
			group by 1,2,3

		), 
    
    last_30_days_article_published_third as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Tags like "%order_statement_second%" then "order_statement_second"
                ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_third as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_third  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_third as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_third  e
			where  e.siteid = ', site, '
			group by 1,2,3

		)
    
[0m18:30:11.327269 [debug] [MainThread]: Command `dbt compile` succeeded at 18:30:11.326272 after 1.16 seconds
[0m18:30:11.328270 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002170232F440>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021702DB4A70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021702E4CBF0>]}
[0m18:30:11.329278 [debug] [MainThread]: Flushing usage events
[0m18:34:52.791006 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD07F46BA0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD07F47320>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD07F47F50>]}


============================== 18:34:52.797005 | 84959e90-f423-4fff-899f-eefd6ba6656b ==============================
[0m18:34:52.797005 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:34:52.799016 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:34:53.056004 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '84959e90-f423-4fff-899f-eefd6ba6656b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD07F986E0>]}
[0m18:34:53.173005 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '84959e90-f423-4fff-899f-eefd6ba6656b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD07D8D8B0>]}
[0m18:34:53.175005 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:34:53.189008 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:34:53.292004 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:34:53.293005 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m18:34:53.490008 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '84959e90-f423-4fff-899f-eefd6ba6656b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD080E7980>]}
[0m18:34:53.505007 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '84959e90-f423-4fff-899f-eefd6ba6656b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD08329760>]}
[0m18:34:53.507009 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m18:34:53.508024 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '84959e90-f423-4fff-899f-eefd6ba6656b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD081FC140>]}
[0m18:34:53.511013 [info ] [MainThread]: 
[0m18:34:53.513021 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:34:53.515007 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:34:53.533005 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:34:53.534007 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:34:53.535007 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:34:53.589007 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:34:53.590008 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:34:53.591007 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:34:53.599006 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:34:53.601006 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:34:53.602007 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:34:53.611010 [debug] [MainThread]: Using postgres connection "master"
[0m18:34:53.611010 [debug] [MainThread]: On master: BEGIN
[0m18:34:53.612009 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:34:53.662008 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:34:53.663009 [debug] [MainThread]: Using postgres connection "master"
[0m18:34:53.664007 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:34:53.674005 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:34:53.676007 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '84959e90-f423-4fff-899f-eefd6ba6656b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD0832BAD0>]}
[0m18:34:53.677006 [debug] [MainThread]: On master: ROLLBACK
[0m18:34:53.678005 [debug] [MainThread]: On master: Close
[0m18:34:53.679008 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:34:53.681019 [info ] [MainThread]: 
[0m18:34:53.685004 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:34:53.687006 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13'
[0m18:34:53.688007 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:34:53.705009 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13"
[0m18:34:53.707009 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (compile): 18:34:53.688007 => 18:34:53.706011
[0m18:34:53.708010 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:34:53.709010 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (execute): 18:34:53.708010 => 18:34:53.708010
[0m18:34:53.711016 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:34:53.713007 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:34:53.714009 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:34:53.715036 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13' was properly closed.
[0m18:34:53.717007 [debug] [MainThread]: Command end result
[0m18:34:53.729009 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_month_13' is:





CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_13`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    
			    WHEN userneeds like "%Opdater mig%" then "Opdater mig"
                
			    WHEN userneeds like "%Forbind mig%" then "Forbind mig"
                
			    WHEN userneeds like "%Help mig med at forsta%" then "Help mig med at forsta"
                
			    WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
                
			    WHEN userneeds like "%Underhold mig%" then "Underhold mig"
                
			    WHEN userneeds like "%Inspirer migg%" then "Inspirer migg"
                ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article
		where siteid = ', site, '
		group by 1,2
		), 
    
    last_30_days_article_published_second as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    
			    WHEN Categories like "%Long read%" then "Long read"
                
			    WHEN Categories like "%Kort og godt%" then "Kort og godt"
                
			    WHEN Categories like "%Q&amp%" then "Q&amp"
                
			    WHEN Categories like "%Best Practice%" then "Best Practice"
                
			    WHEN Categories like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_second as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_second  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_second as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_second  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_second as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_second
		where siteid = ', site, '
		group by 1,2
		), 
    
    last_30_days_article_published_third as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    
			    WHEN Tags like "%order_statement_second%" then "order_statement_second"
                ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_third as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_third  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_third as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_third  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_third as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_third
		where siteid = ', site, '
		group by 1,2
		)
    
[0m18:34:53.745047 [debug] [MainThread]: Command `dbt compile` succeeded at 18:34:53.745047 after 1.16 seconds
[0m18:34:53.747027 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD07C6D640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD07F47320>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD07CDCBF0>]}
[0m18:34:53.748028 [debug] [MainThread]: Flushing usage events
[0m18:35:45.483567 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021502FD3E30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021502FD37A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021502FD2FF0>]}


============================== 18:35:45.488565 | a8a89ce3-4233-4c8a-b917-6bd955165588 ==============================
[0m18:35:45.488565 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:35:45.490573 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m18:35:45.910566 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a8a89ce3-4233-4c8a-b917-6bd955165588', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021503028410>]}
[0m18:35:46.032565 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a8a89ce3-4233-4c8a-b917-6bd955165588', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021502A1C170>]}
[0m18:35:46.034568 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:35:46.048566 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:35:46.149418 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:35:46.150419 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m18:35:46.319422 [error] [MainThread]: Encountered an error:
Compilation Error in model tactical_userneeds_pageviews_chart_month_13 (models\tactical_userneeds_pageviews_chart_month_13.sql)
  tag name expected
    line 29
      {% -for j in range(diction2[i] | length)%}
[0m18:35:46.331086 [debug] [MainThread]: Command `dbt compile` failed at 18:35:46.331086 after 0.98 seconds
[0m18:35:46.332092 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021502BD2F00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021502C30C80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021503211FD0>]}
[0m18:35:46.333093 [debug] [MainThread]: Flushing usage events
[0m18:36:04.910613 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA6C2131A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA6C2136E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA6C2128A0>]}


============================== 18:36:04.916614 | 6d14ace2-4104-48e9-96eb-969f0c7ad631 ==============================
[0m18:36:04.916614 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:36:04.918622 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:36:05.172614 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6d14ace2-4104-48e9-96eb-969f0c7ad631', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA6C3DD580>]}
[0m18:36:05.294612 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6d14ace2-4104-48e9-96eb-969f0c7ad631', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA6B8A4170>]}
[0m18:36:05.295614 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:36:05.309632 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:36:05.408617 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:36:05.409620 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m18:36:05.571621 [error] [MainThread]: Encountered an error:
Compilation Error in model tactical_userneeds_pageviews_chart_month_13 (models\tactical_userneeds_pageviews_chart_month_13.sql)
  Encountered unknown tag 'endfor'.
    line 78
      {% endfor %}
[0m18:36:05.573635 [debug] [MainThread]: Command `dbt compile` failed at 18:36:05.573635 after 0.80 seconds
[0m18:36:05.574623 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA6BFF8860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA6C40D9A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA6C23BAD0>]}
[0m18:36:05.575625 [debug] [MainThread]: Flushing usage events
[0m18:36:53.204512 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B47C821940>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B47C8218E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B47C823FB0>]}


============================== 18:36:53.209507 | 6a8d9a2e-6414-4074-a576-b786786f2ee4 ==============================
[0m18:36:53.209507 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:36:53.211527 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:36:53.464516 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6a8d9a2e-6414-4074-a576-b786786f2ee4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B47C8230E0>]}
[0m18:36:53.583543 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6a8d9a2e-6414-4074-a576-b786786f2ee4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B47C8464B0>]}
[0m18:36:53.585522 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:36:53.602518 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:36:53.693520 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:36:53.694520 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m18:36:53.893517 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6a8d9a2e-6414-4074-a576-b786786f2ee4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B47CBB76E0>]}
[0m18:36:53.909521 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6a8d9a2e-6414-4074-a576-b786786f2ee4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B47CC40EC0>]}
[0m18:36:53.910521 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m18:36:53.911525 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6a8d9a2e-6414-4074-a576-b786786f2ee4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B47C608470>]}
[0m18:36:53.914524 [info ] [MainThread]: 
[0m18:36:53.915520 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:36:53.917522 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:36:53.935539 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:36:53.936536 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:36:53.937536 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:36:53.992519 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:36:53.993523 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:36:53.994520 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:36:54.002519 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:36:54.004519 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:36:54.005518 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:36:54.014523 [debug] [MainThread]: Using postgres connection "master"
[0m18:36:54.015529 [debug] [MainThread]: On master: BEGIN
[0m18:36:54.015529 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:36:54.065520 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:36:54.066522 [debug] [MainThread]: Using postgres connection "master"
[0m18:36:54.067519 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:36:54.077522 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:36:54.080025 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6a8d9a2e-6414-4074-a576-b786786f2ee4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B47CC42AB0>]}
[0m18:36:54.080025 [debug] [MainThread]: On master: ROLLBACK
[0m18:36:54.081042 [debug] [MainThread]: On master: Close
[0m18:36:54.083040 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:36:54.085052 [info ] [MainThread]: 
[0m18:36:54.090042 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:36:54.091038 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13'
[0m18:36:54.092037 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:36:54.111053 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13"
[0m18:36:54.114087 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (compile): 18:36:54.093038 => 18:36:54.113037
[0m18:36:54.115042 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:36:54.116040 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (execute): 18:36:54.116040 => 18:36:54.116040
[0m18:36:54.118038 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:36:54.120038 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:36:54.121038 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:36:54.121038 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13' was properly closed.
[0m18:36:54.122037 [debug] [MainThread]: Command end result
[0m18:36:54.135039 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_month_13' is:





CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_13`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN userneeds like "%Opdater mig%" then "Opdater mig"
                
			    WHEN userneeds like "%Forbind mig%" then "Forbind mig"
                
			    WHEN userneeds like "%Help mig med at forsta%" then "Help mig med at forsta"
                
			    WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
                
			    WHEN userneeds like "%Underhold mig%" then "Underhold mig"
                
			    WHEN userneeds like "%Inspirer migg%" then "Inspirer migg"
                ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article
		where siteid = ', site, '
		group by 1,2
		), 
    
    last_30_days_article_published_second as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Categories like "%Long read%" then "Long read"
                
			    WHEN Categories like "%Kort og godt%" then "Kort og godt"
                
			    WHEN Categories like "%Q&amp%" then "Q&amp"
                
			    WHEN Categories like "%Best Practice%" then "Best Practice"
                
			    WHEN Categories like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_second as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_second  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_second as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_second  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_second as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_second
		where siteid = ', site, '
		group by 1,2
		), 
    
    last_30_days_article_published_third as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Tags like "%order_statement_second%" then "order_statement_second"
                ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_third as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_third  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_third as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_third  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_third as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_third
		where siteid = ', site, '
		group by 1,2
		)
    
[0m18:36:54.145038 [debug] [MainThread]: Command `dbt compile` succeeded at 18:36:54.144070 after 1.09 seconds
[0m18:36:54.146040 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B47C823FB0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B47C8218E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B47C6FCA70>]}
[0m18:36:54.147042 [debug] [MainThread]: Flushing usage events
[0m18:37:48.822429 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EFDB8A3590>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EFDABDEC60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EFDB8A0CB0>]}


============================== 18:37:48.828428 | 2026062a-cc1d-4c72-9a83-4657b0c6dd92 ==============================
[0m18:37:48.828428 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:37:48.830435 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:37:49.087427 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2026062a-cc1d-4c72-9a83-4657b0c6dd92', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EFDB535130>]}
[0m18:37:49.206430 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2026062a-cc1d-4c72-9a83-4657b0c6dd92', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EFDB688980>]}
[0m18:37:49.208433 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:37:49.221426 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:37:49.329859 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:37:49.331863 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m18:37:49.535867 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2026062a-cc1d-4c72-9a83-4657b0c6dd92', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EFDBC7E000>]}
[0m18:37:49.550863 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2026062a-cc1d-4c72-9a83-4657b0c6dd92', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EFDBD29460>]}
[0m18:37:49.551867 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m18:37:49.552865 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2026062a-cc1d-4c72-9a83-4657b0c6dd92', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EFDBE46AB0>]}
[0m18:37:49.555864 [info ] [MainThread]: 
[0m18:37:49.557872 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:37:49.559865 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:37:49.576866 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:37:49.577868 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:37:49.578863 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:37:49.641862 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:37:49.642865 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:37:49.642865 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:37:49.651862 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:37:49.652864 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:37:49.654862 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:37:49.660858 [debug] [MainThread]: Using postgres connection "master"
[0m18:37:49.661860 [debug] [MainThread]: On master: BEGIN
[0m18:37:49.662862 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:37:49.712863 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:37:49.712863 [debug] [MainThread]: Using postgres connection "master"
[0m18:37:49.713865 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:37:49.723866 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:37:49.726861 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2026062a-cc1d-4c72-9a83-4657b0c6dd92', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EFDBD2B710>]}
[0m18:37:49.727862 [debug] [MainThread]: On master: ROLLBACK
[0m18:37:49.727862 [debug] [MainThread]: On master: Close
[0m18:37:49.729862 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:37:49.731871 [info ] [MainThread]: 
[0m18:37:49.736865 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:37:49.737862 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13'
[0m18:37:49.738880 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:37:49.756879 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13"
[0m18:37:49.759893 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (compile): 18:37:49.739876 => 18:37:49.758868
[0m18:37:49.761865 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:37:49.762865 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (execute): 18:37:49.762865 => 18:37:49.762865
[0m18:37:49.764863 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:37:49.766865 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:37:49.767862 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:37:49.767862 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13' was properly closed.
[0m18:37:49.769866 [debug] [MainThread]: Command end result
[0m18:37:49.782861 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_month_13' is:





CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_13`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN userneeds like "%Opdater mig%" then "Opdater mig"
			    WHEN userneeds like "%Forbind mig%" then "Forbind mig"
			    WHEN userneeds like "%Help mig med at forsta%" then "Help mig med at forsta"
			    WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
			    WHEN userneeds like "%Underhold mig%" then "Underhold mig"
			    WHEN userneeds like "%Inspirer migg%" then "Inspirer migg"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article
		where siteid = ', site, '
		group by 1,2
		), 
    
    last_30_days_article_published_second as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Categories like "%Long read%" then "Long read"
			    WHEN Categories like "%Kort og godt%" then "Kort og godt"
			    WHEN Categories like "%Q&amp%" then "Q&amp"
			    WHEN Categories like "%Best Practice%" then "Best Practice"
			    WHEN Categories like "%Viden og forskning%" then "Viden og forskning"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_second as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_second  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_second as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_second  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_second as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_second
		where siteid = ', site, '
		group by 1,2
		), 
    
    last_30_days_article_published_third as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Tags like "%order_statement_second%" then "order_statement_second"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_third as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_third  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_third as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_third  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_third as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_third
		where siteid = ', site, '
		group by 1,2
		)
    
[0m18:37:49.790865 [debug] [MainThread]: Command `dbt compile` succeeded at 18:37:49.790865 after 1.10 seconds
[0m18:37:49.791872 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EFD52D5610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EFDB759460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EFDB8A3590>]}
[0m18:37:49.792868 [debug] [MainThread]: Flushing usage events
[0m19:00:11.894533 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E623701820>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6237017F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6237019A0>]}


============================== 19:00:11.901534 | deb884e4-24ea-4336-8583-33d59d603572 ==============================
[0m19:00:11.901534 [info ] [MainThread]: Running with dbt=1.7.13
[0m19:00:11.903543 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'send_anonymous_usage_stats': 'True'}
[0m19:00:12.172009 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'deb884e4-24ea-4336-8583-33d59d603572', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6234B56A0>]}
[0m19:00:12.291012 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'deb884e4-24ea-4336-8583-33d59d603572', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E623611820>]}
[0m19:00:12.293016 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m19:00:12.307013 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m19:00:12.439356 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:00:12.440357 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m19:00:12.639087 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'deb884e4-24ea-4336-8583-33d59d603572', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E623CBE810>]}
[0m19:00:12.654091 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'deb884e4-24ea-4336-8583-33d59d603572', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E623B29A90>]}
[0m19:00:12.655094 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m19:00:12.657098 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'deb884e4-24ea-4336-8583-33d59d603572', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E623BFFF50>]}
[0m19:00:12.659094 [info ] [MainThread]: 
[0m19:00:12.661093 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m19:00:12.663091 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m19:00:12.681105 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m19:00:12.682100 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m19:00:12.683113 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:00:12.748090 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m19:00:12.749092 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m19:00:12.750091 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m19:00:12.761089 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m19:00:12.763089 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m19:00:12.764091 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m19:00:12.773092 [debug] [MainThread]: Using postgres connection "master"
[0m19:00:12.774092 [debug] [MainThread]: On master: BEGIN
[0m19:00:12.774092 [debug] [MainThread]: Opening a new connection, currently in state init
[0m19:00:12.824092 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m19:00:12.825093 [debug] [MainThread]: Using postgres connection "master"
[0m19:00:12.826090 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m19:00:12.837091 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m19:00:12.840089 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'deb884e4-24ea-4336-8583-33d59d603572', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E623B29A90>]}
[0m19:00:12.840089 [debug] [MainThread]: On master: ROLLBACK
[0m19:00:12.841092 [debug] [MainThread]: On master: Close
[0m19:00:12.843093 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m19:00:12.844101 [info ] [MainThread]: 
[0m19:00:12.850091 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m19:00:12.852092 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13'
[0m19:00:12.853093 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m19:00:12.871094 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13"
[0m19:00:12.873901 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (compile): 19:00:12.853093 => 19:00:12.872883
[0m19:00:12.873901 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m19:00:12.875897 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (execute): 19:00:12.874898 => 19:00:12.874898
[0m19:00:12.876897 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m19:00:12.878896 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:00:12.879908 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m19:00:12.880918 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13' was properly closed.
[0m19:00:12.882904 [debug] [MainThread]: Command end result
[0m19:00:12.901894 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_month_13' is:





CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_13`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN userneeds like "%Opdater mig%" then "Opdater mig"
			    WHEN userneeds like "%Forbind mig%" then "Forbind mig"
			    WHEN userneeds like "%Help mig med at forsta%" then "Help mig med at forsta"
			    WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
			    WHEN userneeds like "%Underhold mig%" then "Underhold mig"
			    WHEN userneeds like "%Inspirer migg%" then "Inspirer migg"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data
			group by 1,2
		),
        hits_by_tags as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data
		   where siteid = ',site,'
		   group by 1,2), 
    
    last_30_days_article_published_second as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Categories like "%Long read%" then "Long read"
			    WHEN Categories like "%Kort og godt%" then "Kort og godt"
			    WHEN Categories like "%Q&amp%" then "Q&amp"
			    WHEN Categories like "%Best Practice%" then "Best Practice"
			    WHEN Categories like "%Viden og forskning%" then "Viden og forskning"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_second as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_second  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_second as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_second  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_second as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_second
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_second as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_second l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_second as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_second
			group by 1,2
		),
        hits_by_tags_second as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_second
		   where siteid = ',site,'
		   group by 1,2), 
    
    last_30_days_article_published_third as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Tags like "%order_statement_second%" then "order_statement_second"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_third as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_third  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_third as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_third  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_third as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_third
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_third as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_third l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_third as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_third
			group by 1,2
		),
        hits_by_tags_third as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_third
		   where siteid = ',site,'
		   group by 1,2)
    
[0m19:00:12.919902 [debug] [MainThread]: Command `dbt compile` succeeded at 19:00:12.919902 after 1.25 seconds
[0m19:00:12.920899 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E62363D9D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6237019A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E623703EC0>]}
[0m19:00:12.922917 [debug] [MainThread]: Flushing usage events
[0m10:47:44.552677 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C27FB36210>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C27FB35AC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C27FB36630>]}


============================== 10:47:44.559676 | 1555c5f4-590e-46bf-b5fb-dca26997c815 ==============================
[0m10:47:44.559676 [info ] [MainThread]: Running with dbt=1.7.13
[0m10:47:44.561687 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'send_anonymous_usage_stats': 'True'}
[0m10:47:44.867552 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1555c5f4-590e-46bf-b5fb-dca26997c815', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C27FA0D130>]}
[0m10:47:44.988549 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1555c5f4-590e-46bf-b5fb-dca26997c815', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C27FA432C0>]}
[0m10:47:44.991347 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m10:47:45.006057 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m10:47:45.140399 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m10:47:45.142404 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m10:47:45.351151 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1555c5f4-590e-46bf-b5fb-dca26997c815', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C200177E30>]}
[0m10:47:45.367153 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1555c5f4-590e-46bf-b5fb-dca26997c815', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C27FF69940>]}
[0m10:47:45.368155 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m10:47:45.370160 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1555c5f4-590e-46bf-b5fb-dca26997c815', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C20019C8C0>]}
[0m10:47:45.373155 [info ] [MainThread]: 
[0m10:47:45.375154 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m10:47:45.377152 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m10:47:45.395157 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m10:47:45.395157 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m10:47:45.397158 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:47:45.475154 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m10:47:45.476151 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m10:47:45.477151 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m10:47:45.491150 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m10:47:45.493150 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m10:47:45.495152 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m10:47:45.508152 [debug] [MainThread]: Using postgres connection "master"
[0m10:47:45.510153 [debug] [MainThread]: On master: BEGIN
[0m10:47:45.511156 [debug] [MainThread]: Opening a new connection, currently in state init
[0m10:47:45.597155 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m10:47:45.599154 [debug] [MainThread]: Using postgres connection "master"
[0m10:47:45.601154 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m10:47:45.624154 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m10:47:45.629159 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1555c5f4-590e-46bf-b5fb-dca26997c815', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C27FF6B440>]}
[0m10:47:45.631155 [debug] [MainThread]: On master: ROLLBACK
[0m10:47:45.633156 [debug] [MainThread]: On master: Close
[0m10:47:45.635155 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m10:47:45.637163 [info ] [MainThread]: 
[0m10:47:45.647164 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m10:47:45.651157 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13'
[0m10:47:45.653157 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m10:47:45.714157 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13"
[0m10:47:45.717155 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (compile): 10:47:45.654155 => 10:47:45.717155
[0m10:47:45.719153 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m10:47:45.721154 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (execute): 10:47:45.720154 => 10:47:45.720154
[0m10:47:45.724153 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m10:47:45.728152 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:47:45.730154 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m10:47:45.731154 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13' was properly closed.
[0m10:47:45.734154 [debug] [MainThread]: Command end result
[0m10:47:45.754150 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_month_13' is:





CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_13`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN userneeds like "%Opdater mig%" then "Opdater mig"
			    WHEN userneeds like "%Forbind mig%" then "Forbind mig"
			    WHEN userneeds like "%Help mig med at forsta%" then "Help mig med at forsta"
			    WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
			    WHEN userneeds like "%Underhold mig%" then "Underhold mig"
			    WHEN userneeds like "%Inspirer migg%" then "Inspirer migg"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data
			group by 1,2
		),
        hits_by_tags as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_third_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data
		group by 1,2,3
		),
        categories as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d
		),
        json_data as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories
		), 
    
    last_30_days_article_published_second as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Categories like "%Long read%" then "Long read"
			    WHEN Categories like "%Kort og godt%" then "Kort og godt"
			    WHEN Categories like "%Q&amp%" then "Q&amp"
			    WHEN Categories like "%Best Practice%" then "Best Practice"
			    WHEN Categories like "%Viden og forskning%" then "Viden og forskning"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_second as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_second  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_second as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_second  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_second as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_second
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_second as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_second l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_second as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_second
			group by 1,2
		),
        hits_by_tags_second as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_second
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits_second as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_second
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data_second as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_second h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_third_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d_second as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_second
		group by 1,2,3
		),
        categories_second as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_second
		),
        json_data_second as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_second
		), 
    
    last_30_days_article_published_third as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Tags like "%order_statement_second%" then "order_statement_second"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_third as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_third  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_third as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_third  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_third as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_third
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_third as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_third l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_third as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_third
			group by 1,2
		),
        hits_by_tags_third as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_third
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits_third as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_third
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data_third as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_third h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_third_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d_third as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_third
		group by 1,2,3
		),
        categories_third as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_third
		),
        json_data_third as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_third
		)
    

    SELECT 
		CONCAT(
        ''{'',
            ''"site":'',jd.siteid,'','',
            ''"data": {'',
                ''"label": "'', jd.lab, ''",'',
                ''"categories": ['', jd.cat, ''],'',
                ''"series": ['', jd.series, '']'',
                '',"defaultTitle":"',dtitle,'"'',
                '',"additional":[ ''
                
                ,''{'',
                ''"title":"',title1,'",'',
                ''"data": {'',
                ''"label": "'',json_data_second.lab, ''",'',
                ''"categories": ['', json_data_second.cat, ''],'',
                ''"series": ['', json_data_second.series, '']'',
                ''}}''
                
                , '',''
                
                
                ,''{'',
                ''"title":"',title2,'",'',
                ''"data": {'',
                ''"label": "'',json_data_third.lab, ''",'',
                ''"categories": ['', json_data_third.cat, ''],'',
                ''"series": ['', json_data_third.series, '']'',
                ''}}''
                
                
        '']}}''
    
			) as json_data
		  FROM json_data jd
          
          CROSS join json_data_second
          
          CROSS join json_data_third
          ;
[0m10:47:45.784155 [debug] [MainThread]: Command `dbt compile` succeeded at 10:47:45.783168 after 1.46 seconds
[0m10:47:45.784155 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C27F9C5970>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C27F9EB110>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C27F9E9670>]}
[0m10:47:45.786165 [debug] [MainThread]: Flushing usage events
[0m11:21:17.780480 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028EA94B7D70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028EA94B5C70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028EA94B7B60>]}


============================== 11:21:17.786480 | 95855015-4eda-46f4-81f2-383de9c77ee1 ==============================
[0m11:21:17.786480 [info ] [MainThread]: Running with dbt=1.7.13
[0m11:21:17.788493 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m11:21:18.046477 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '95855015-4eda-46f4-81f2-383de9c77ee1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028EA9746150>]}
[0m11:21:18.166482 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '95855015-4eda-46f4-81f2-383de9c77ee1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028EA94DA780>]}
[0m11:21:18.168486 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m11:21:18.183485 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m11:21:18.284482 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m11:21:18.285484 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m11:21:18.490479 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '95855015-4eda-46f4-81f2-383de9c77ee1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028EA9B45B80>]}
[0m11:21:18.505483 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '95855015-4eda-46f4-81f2-383de9c77ee1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028EA993A330>]}
[0m11:21:18.506485 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m11:21:18.508483 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '95855015-4eda-46f4-81f2-383de9c77ee1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028EA9A0FCB0>]}
[0m11:21:18.511481 [info ] [MainThread]: 
[0m11:21:18.513486 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m11:21:18.515479 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m11:21:18.533484 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:21:18.534485 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m11:21:18.535481 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:21:18.596484 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m11:21:18.597481 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:21:18.599488 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m11:21:18.613481 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m11:21:18.616482 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m11:21:18.618482 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m11:21:18.628479 [debug] [MainThread]: Using postgres connection "master"
[0m11:21:18.629479 [debug] [MainThread]: On master: BEGIN
[0m11:21:18.630479 [debug] [MainThread]: Opening a new connection, currently in state init
[0m11:21:18.682481 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m11:21:18.682481 [debug] [MainThread]: Using postgres connection "master"
[0m11:21:18.683479 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m11:21:18.692479 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m11:21:18.695479 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '95855015-4eda-46f4-81f2-383de9c77ee1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028EA993BF80>]}
[0m11:21:18.695479 [debug] [MainThread]: On master: ROLLBACK
[0m11:21:18.696481 [debug] [MainThread]: On master: Close
[0m11:21:18.698482 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:21:18.699513 [info ] [MainThread]: 
[0m11:21:18.704479 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m11:21:18.706482 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13'
[0m11:21:18.707480 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m11:21:18.735480 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13"
[0m11:21:18.737483 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (compile): 11:21:18.707480 => 11:21:18.736480
[0m11:21:18.738484 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m11:21:18.739482 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (execute): 11:21:18.739482 => 11:21:18.739482
[0m11:21:18.741480 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m11:21:18.743479 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:21:18.744483 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m11:21:18.745528 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13' was properly closed.
[0m11:21:18.747480 [debug] [MainThread]: Command end result
[0m11:21:18.760480 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_month_13' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_13`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN userneeds like "%Opdater mig%" then "Opdater mig"
			    WHEN userneeds like "%Forbind mig%" then "Forbind mig"
			    WHEN userneeds like "%Help mig med at forsta%" then "Help mig med at forsta"
			    WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
			    WHEN userneeds like "%Underhold mig%" then "Underhold mig"
			    WHEN userneeds like "%Inspirer migg%" then "Inspirer migg"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data
			group by 1,2
		),
        hits_by_tags as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data
		group by 1,2,3
		),
        categories as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d
		),
        json_data as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories
		), 
    
    last_30_days_article_published_second as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Categories like "%Long read%" then "Long read"
			    WHEN Categories like "%Kort og godt%" then "Kort og godt"
			    WHEN Categories like "%Q&amp%" then "Q&amp"
			    WHEN Categories like "%Best Practice%" then "Best Practice"
			    WHEN Categories like "%Viden og forskning%" then "Viden og forskning"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_second as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_second  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_second as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_second  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_second as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_second
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_second as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_second l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_second as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_second
			group by 1,2
		),
        hits_by_tags_second as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_second
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits_second as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_second
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data_second as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_second h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_second_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d_second as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_second
		group by 1,2,3
		),
        categories_second as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_second
		),
        json_data_second as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_second
		), 
    
    last_30_days_article_published_third as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Tags like "%order_statement_second%" then "order_statement_second"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_third as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_third  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_third as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_third  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_third as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_third
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_third as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_third l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_third as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_third
			group by 1,2
		),
        hits_by_tags_third as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_third
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits_third as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_third
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data_third as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_third h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_third_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d_third as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_third
		group by 1,2,3
		),
        categories_third as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_third
		),
        json_data_third as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_third
		)
    

    SELECT 
		CONCAT(
        ''{'',
            ''"site":'',jd.siteid,'','',
            ''"data": {'',
                ''"label": "'', jd.lab, ''",'',
                ''"categories": ['', jd.cat, ''],'',
                ''"series": ['', jd.series, '']'',
                '',"defaultTitle":"',dtitle,'"'',
                '',"additional":[ ''
                
                ,''{'',
                ''"title":"',title1,'",'',
                ''"data": {'',
                ''"label": "'',json_data_second.lab, ''",'',
                ''"categories": ['', json_data_second.cat, ''],'',
                ''"series": ['', json_data_second.series, '']'',
                ''}}''
                
                , '',''
                
                
                ,''{'',
                ''"title":"',title2,'",'',
                ''"data": {'',
                ''"label": "'',json_data_third.lab, ''",'',
                ''"categories": ['', json_data_third.cat, ''],'',
                ''"series": ['', json_data_third.series, '']'',
                ''}}''
                
                
        '']}}''
    
			) as json_data
		  FROM json_data jd
          
          CROSS join json_data_second
          
          CROSS join json_data_third
          ;
[0m11:21:18.789481 [debug] [MainThread]: Command `dbt compile` succeeded at 11:21:18.789481 after 1.21 seconds
[0m11:21:18.790480 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028EA92FE750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028EA94B7D70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028EA94B5C70>]}
[0m11:21:18.791482 [debug] [MainThread]: Flushing usage events
[0m11:29:55.050811 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028D71B12330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028D71B13860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028D71B13C20>]}


============================== 11:29:55.056813 | c13d4695-8ea5-4ed6-aa3d-3cbb5bb07475 ==============================
[0m11:29:55.056813 [info ] [MainThread]: Running with dbt=1.7.13
[0m11:29:55.058817 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m11:29:55.338511 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c13d4695-8ea5-4ed6-aa3d-3cbb5bb07475', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028D71BD92B0>]}
[0m11:29:55.458523 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c13d4695-8ea5-4ed6-aa3d-3cbb5bb07475', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028D70EA4170>]}
[0m11:29:55.459524 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m11:29:55.475528 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m11:29:55.578521 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m11:29:55.579523 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m11:29:55.796615 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c13d4695-8ea5-4ed6-aa3d-3cbb5bb07475', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028D7202A7B0>]}
[0m11:29:55.811622 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c13d4695-8ea5-4ed6-aa3d-3cbb5bb07475', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028D71F08230>]}
[0m11:29:55.812619 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m11:29:55.814629 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c13d4695-8ea5-4ed6-aa3d-3cbb5bb07475', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028D7209DF40>]}
[0m11:29:55.817616 [info ] [MainThread]: 
[0m11:29:55.818619 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m11:29:55.820617 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m11:29:55.837618 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:29:55.837618 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m11:29:55.839622 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:29:55.909558 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m11:29:55.910560 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:29:55.910560 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m11:29:55.921558 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m11:29:55.923561 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m11:29:55.925560 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m11:29:55.931559 [debug] [MainThread]: Using postgres connection "master"
[0m11:29:55.932559 [debug] [MainThread]: On master: BEGIN
[0m11:29:55.932559 [debug] [MainThread]: Opening a new connection, currently in state init
[0m11:29:55.985559 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m11:29:55.986564 [debug] [MainThread]: Using postgres connection "master"
[0m11:29:55.986564 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m11:29:55.997557 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m11:29:56.000561 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c13d4695-8ea5-4ed6-aa3d-3cbb5bb07475', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028D71F0BC50>]}
[0m11:29:56.000561 [debug] [MainThread]: On master: ROLLBACK
[0m11:29:56.001560 [debug] [MainThread]: On master: Close
[0m11:29:56.003563 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:29:56.005575 [info ] [MainThread]: 
[0m11:29:56.010558 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m11:29:56.012560 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13'
[0m11:29:56.013558 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m11:29:56.037559 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13"
[0m11:29:56.040565 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (compile): 11:29:56.013558 => 11:29:56.039562
[0m11:29:56.042562 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m11:29:56.044558 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (execute): 11:29:56.043565 => 11:29:56.043565
[0m11:29:56.046559 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m11:29:56.048559 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:29:56.049559 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m11:29:56.049559 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13' was properly closed.
[0m11:29:56.051560 [debug] [MainThread]: Command end result
[0m11:29:56.065561 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_month_13' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_13`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN userneeds like "%Opdater mig%" then "Opdater mig"
			    WHEN userneeds like "%Forbind mig%" then "Forbind mig"
			    WHEN userneeds like "%Help mig med at forsta%" then "Help mig med at forsta"
			    WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
			    WHEN userneeds like "%Underhold mig%" then "Underhold mig"
			    WHEN userneeds like "%Inspirer migg%" then "Inspirer migg"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data
			group by 1,2
		),
        hits_by_tags as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data
		group by 1,2,3
		),
        categories as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d
		),
        json_data as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories
		), 
    
    last_30_days_article_published_second as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Categories like "%Long read%" then "Long read"
			    WHEN Categories like "%Kort og godt%" then "Kort og godt"
			    WHEN Categories like "%Q&amp%" then "Q&amp"
			    WHEN Categories like "%Best Practice%" then "Best Practice"
			    WHEN Categories like "%Viden og forskning%" then "Viden og forskning"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_second as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_second  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_second as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_second  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_second as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_second
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_second as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_second l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_second as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_second
			group by 1,2
		),
        hits_by_tags_second as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_second
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits_second as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_second
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data_second as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_second h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d_second as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_second
		group by 1,2,3
		),
        categories_second as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_second
		),
        json_data_second as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_second
		), 
    
    last_30_days_article_published_third as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Tags like "%order_statement_second%" then "order_statement_second"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_third as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_third  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_third as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_third  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_third as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_third
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_third as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_third l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_third as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_third
			group by 1,2
		),
        hits_by_tags_third as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_third
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits_third as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_third
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data_third as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_third h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d_third as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_third
		group by 1,2,3
		),
        categories_third as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_third
		),
        json_data_third as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_third
		)
    

    SELECT 
		CONCAT(
        ''{'',
            ''"site":'',jd.siteid,'','',
            ''"data": {'',
                ''"label": "'', jd.lab, ''",'',
                ''"categories": ['', jd.cat, ''],'',
                ''"series": ['', jd.series, '']'',
                '',"defaultTitle":"',dtitle,'"'',
                '',"additional":[ ''
                
                ,''{'',
                ''"title":"',title1,'",'',
                ''"data": {'',
                ''"label": "'',json_data_second.lab, ''",'',
                ''"categories": ['', json_data_second.cat, ''],'',
                ''"series": ['', json_data_second.series, '']'',
                ''}}''
                
                , '',''
                
                
                ,''{'',
                ''"title":"',title2,'",'',
                ''"data": {'',
                ''"label": "'',json_data_third.lab, ''",'',
                ''"categories": ['', json_data_third.cat, ''],'',
                ''"series": ['', json_data_third.series, '']'',
                ''}}''
                
                
        '']}}''
    
			) as json_data
		  FROM json_data jd
          
          CROSS join json_data_second
          
          CROSS join json_data_third
          ;
[0m11:29:56.093573 [debug] [MainThread]: Command `dbt compile` succeeded at 11:29:56.092562 after 1.24 seconds
[0m11:29:56.094565 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028D6B4F55E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028D71B37AA0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028D70F36F30>]}
[0m11:29:56.095566 [debug] [MainThread]: Flushing usage events
[0m11:38:58.430948 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A94FB63B90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A94FB63A10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A94FB62840>]}


============================== 11:38:58.436947 | 6b12ac9c-add9-42c5-b534-03dd21554dd5 ==============================
[0m11:38:58.436947 [info ] [MainThread]: Running with dbt=1.7.13
[0m11:38:58.438950 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m11:38:58.695489 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6b12ac9c-add9-42c5-b534-03dd21554dd5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A94FBB8620>]}
[0m11:38:58.816491 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6b12ac9c-add9-42c5-b534-03dd21554dd5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A94FED6150>]}
[0m11:38:58.818495 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m11:38:58.833491 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m11:38:58.946887 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m11:38:58.947892 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m11:38:59.155897 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6b12ac9c-add9-42c5-b534-03dd21554dd5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A9501602C0>]}
[0m11:38:59.171892 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6b12ac9c-add9-42c5-b534-03dd21554dd5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A94FF69A90>]}
[0m11:38:59.173894 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m11:38:59.174904 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6b12ac9c-add9-42c5-b534-03dd21554dd5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A94FE01130>]}
[0m11:38:59.176896 [info ] [MainThread]: 
[0m11:38:59.178893 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m11:38:59.180890 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m11:38:59.196901 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:38:59.197891 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m11:38:59.198900 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:38:59.254890 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m11:38:59.255893 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:38:59.255893 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m11:38:59.264890 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m11:38:59.266890 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m11:38:59.266890 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m11:38:59.274888 [debug] [MainThread]: Using postgres connection "master"
[0m11:38:59.274888 [debug] [MainThread]: On master: BEGIN
[0m11:38:59.275889 [debug] [MainThread]: Opening a new connection, currently in state init
[0m11:38:59.323891 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m11:38:59.324893 [debug] [MainThread]: Using postgres connection "master"
[0m11:38:59.325892 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m11:38:59.335888 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m11:38:59.337891 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6b12ac9c-add9-42c5-b534-03dd21554dd5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A950094110>]}
[0m11:38:59.338892 [debug] [MainThread]: On master: ROLLBACK
[0m11:38:59.339890 [debug] [MainThread]: On master: Close
[0m11:38:59.340894 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:38:59.342905 [info ] [MainThread]: 
[0m11:38:59.347891 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m11:38:59.348893 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13'
[0m11:38:59.349891 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m11:38:59.376899 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13"
[0m11:38:59.379893 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (compile): 11:38:59.349891 => 11:38:59.378928
[0m11:38:59.380894 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m11:38:59.382891 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (execute): 11:38:59.381893 => 11:38:59.381893
[0m11:38:59.384893 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m11:38:59.386891 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:38:59.386891 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m11:38:59.387890 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13' was properly closed.
[0m11:38:59.388890 [debug] [MainThread]: Command end result
[0m11:38:59.401893 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_month_13' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_13`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN userneeds like "%Opdater mig%" then "Opdater mig"
			    WHEN userneeds like "%Forbind mig%" then "Forbind mig"
			    WHEN userneeds like "%Help mig med at forsta%" then "Help mig med at forsta"
			    WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
			    WHEN userneeds like "%Underhold mig%" then "Underhold mig"
			    WHEN userneeds like "%Inspirer migg%" then "Inspirer migg"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data
			group by 1,2
		),
        hits_by_tags as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data
		group by 1,2,3
		),
        categories as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d
		),
        json_data as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories
		), 
    
    last_30_days_article_published_second as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Categories like "%Long read%" then "Long read"
			    WHEN Categories like "%Kort og godt%" then "Kort og godt"
			    WHEN Categories like "%Q&amp%" then "Q&amp"
			    WHEN Categories like "%Best Practice%" then "Best Practice"
			    WHEN Categories like "%Viden og forskning%" then "Viden og forskning"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_second as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_second  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_second as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_second  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_second as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_second
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_second as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_second l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_second as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_second
			group by 1,2
		),
        hits_by_tags_second as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_second
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits_second as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_second
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data_second as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_second h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d_second as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_second
		group by 1,2,3
		),
        categories_second as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_second
		),
        json_data_second as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_second
		), 
    
    last_30_days_article_published_third as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Tags like "%order_statement_second%" then "order_statement_second"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_third as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_third  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_third as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_third  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_third as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_third
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_third as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_third l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_third as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_third
			group by 1,2
		),
        hits_by_tags_third as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_third
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits_third as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_third
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data_third as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_third h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d_third as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_third
		group by 1,2,3
		),
        categories_third as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_third
		),
        json_data_third as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_third
		)
    

    SELECT 
		CONCAT(
        ''{'',
            ''"site":'',jd.siteid,'','',
            ''"data": {'',
                ''"label": "'', jd.lab, ''",'',
                ''"categories": ['', jd.cat, ''],'',
                ''"series": ['', jd.series, '']'',
                '',"defaultTitle":"',dtitle,'"'',
                '',"additional":[ ''
                
                ,''{'',
                ''"title":"',title1,'",'',
                ''"data": {'',
                ''"label": "'',json_data_second.lab, ''",'',
                ''"categories": ['', json_data_second.cat, ''],'',
                ''"series": ['', json_data_second.series, '']'',
                ''}}''
                
                , '',''
                
                
                ,''{'',
                ''"title":"',title2,'",'',
                ''"data": {'',
                ''"label": "'',json_data_third.lab, ''",'',
                ''"categories": ['', json_data_third.cat, ''],'',
                ''"series": ['', json_data_third.series, '']'',
                ''}}''
                
                
        '']}}''
    
			) as json_data
		  FROM json_data jd
          
          CROSS join json_data_second
          
          CROSS join json_data_third
          ;
[0m11:38:59.425893 [debug] [MainThread]: Command `dbt compile` succeeded at 11:38:59.424930 after 1.19 seconds
[0m11:38:59.426894 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A94F7F7830>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A94FB43CE0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A94FB43EC0>]}
[0m11:38:59.427893 [debug] [MainThread]: Flushing usage events
[0m12:09:32.741751 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C1E5742F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C1E575D00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C1E576A20>]}


============================== 12:09:32.748750 | 89770ad1-02dc-4fe7-9877-23be107d9861 ==============================
[0m12:09:32.748750 [info ] [MainThread]: Running with dbt=1.7.13
[0m12:09:32.750757 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'send_anonymous_usage_stats': 'True'}
[0m12:09:33.071946 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '89770ad1-02dc-4fe7-9877-23be107d9861', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C1E5C8770>]}
[0m12:09:33.191950 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '89770ad1-02dc-4fe7-9877-23be107d9861', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C1E474170>]}
[0m12:09:33.193949 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m12:09:33.216951 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m12:09:33.916623 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m12:09:33.917625 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m12:09:33.924625 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '89770ad1-02dc-4fe7-9877-23be107d9861', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C1E7E0C20>]}
[0m12:09:33.953628 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '89770ad1-02dc-4fe7-9877-23be107d9861', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C1E949640>]}
[0m12:09:33.955629 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m12:09:33.957635 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '89770ad1-02dc-4fe7-9877-23be107d9861', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C1E7561E0>]}
[0m12:09:33.960624 [info ] [MainThread]: 
[0m12:09:33.962628 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m12:09:33.964634 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m12:09:33.980633 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m12:09:33.981641 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m12:09:33.982644 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:09:34.042625 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m12:09:34.043628 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m12:09:34.044626 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m12:09:34.055625 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m12:09:34.057626 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m12:09:34.058626 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m12:09:34.065626 [debug] [MainThread]: Using postgres connection "master"
[0m12:09:34.065626 [debug] [MainThread]: On master: BEGIN
[0m12:09:34.066627 [debug] [MainThread]: Opening a new connection, currently in state init
[0m12:09:34.114628 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m12:09:34.114628 [debug] [MainThread]: Using postgres connection "master"
[0m12:09:34.115629 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m12:09:34.127625 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m12:09:34.129626 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '89770ad1-02dc-4fe7-9877-23be107d9861', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C1E8F0710>]}
[0m12:09:34.130624 [debug] [MainThread]: On master: ROLLBACK
[0m12:09:34.131625 [debug] [MainThread]: On master: Close
[0m12:09:34.132627 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m12:09:34.134641 [info ] [MainThread]: 
[0m12:09:34.140625 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m12:09:34.141627 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13'
[0m12:09:34.142628 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m12:09:34.170626 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13"
[0m12:09:34.172648 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (compile): 12:09:34.143627 => 12:09:34.171626
[0m12:09:34.173630 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m12:09:34.175628 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (execute): 12:09:34.174630 => 12:09:34.174630
[0m12:09:34.176629 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m12:09:34.178626 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:09:34.179629 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m12:09:34.181628 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13' was properly closed.
[0m12:09:34.182627 [debug] [MainThread]: Command end result
[0m12:09:34.194628 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_month_13' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_13`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN userneeds like "%Opdater mig%" then "Opdater mig"
			    WHEN userneeds like "%Forbind mig%" then "Forbind mig"
			    WHEN userneeds like "%Help mig med at forsta%" then "Help mig med at forsta"
			    WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
			    WHEN userneeds like "%Underhold mig%" then "Underhold mig"
			    WHEN userneeds like "%Inspirer migg%" then "Inspirer migg"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data
			group by 1,2
		),
        hits_by_tags as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data
		group by 1,2,3
		),
        categories as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d
		),
        json_data as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories
		), 
    
    last_30_days_article_published_second as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Categories like "%Long read%" then "Long read"
			    WHEN Categories like "%Kort og godt%" then "Kort og godt"
			    WHEN Categories like "%Q&amp%" then "Q&amp"
			    WHEN Categories like "%Best Practice%" then "Best Practice"
			    WHEN Categories like "%Viden og forskning%" then "Viden og forskning"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_second as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_second  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_second as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_second  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_second as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_second
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_second as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_second l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_second as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_second
			group by 1,2
		),
        hits_by_tags_second as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_second
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits_second as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_second
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data_second as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_second h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d_second as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_second
		group by 1,2,3
		),
        categories_second as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_second
		),
        json_data_second as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_second
		), 
    
    last_30_days_article_published_third as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Tags like "%order_statement_second%" then "order_statement_second"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_third as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_third  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_third as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_third  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_third as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_third
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_third as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_third l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_third as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_third
			group by 1,2
		),
        hits_by_tags_third as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_third
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits_third as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_third
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data_third as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_third h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d_third as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_third
		group by 1,2,3
		),
        categories_third as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_third
		),
        json_data_third as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_third
		)
    

    SELECT 
		CONCAT(
        ''{'',
            ''"site":'',jd.siteid,'','',
            ''"data": {'',
                ''"label": "'', jd.lab, ''",'',
                ''"categories": ['', jd.cat, ''],'',
                ''"series": ['', jd.series, '']'',
                '',"defaultTitle":"',dtitle,'"'',
                '',"additional":[ ''
                
                ,''{'',
                ''"title":"',title1,'",'',
                ''"data": {'',
                ''"label": "'',json_data_second.lab, ''",'',
                ''"categories": ['', json_data_second.cat, ''],'',
                ''"series": ['', json_data_second.series, '']'',
                ''}}''
                
                , '',''
                
                
                ,''{'',
                ''"title":"',title2,'",'',
                ''"data": {'',
                ''"label": "'',json_data_third.lab, ''",'',
                ''"categories": ['', json_data_third.cat, ''],'',
                ''"series": ['', json_data_third.series, '']'',
                ''}}''
                
                
        '']}}''
    
			) as json_data
		  FROM json_data jd
          
          CROSS join json_data_second
          
          CROSS join json_data_third
          ;
[0m12:09:34.218626 [debug] [MainThread]: Command `dbt compile` succeeded at 12:09:34.218626 after 1.70 seconds
[0m12:09:34.219628 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C1B675A90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C1E139D00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C1E139D90>]}
[0m12:09:34.220629 [debug] [MainThread]: Flushing usage events
[0m12:33:14.362001 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C1AE555970>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C1AE463320>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C1AE557E60>]}


============================== 12:33:14.367009 | c3255f50-98bb-41a0-8b9a-081b8c6d1e48 ==============================
[0m12:33:14.367009 [info ] [MainThread]: Running with dbt=1.7.13
[0m12:33:14.369014 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m12:33:14.630998 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c3255f50-98bb-41a0-8b9a-081b8c6d1e48', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C1AE5A8D40>]}
[0m12:33:14.750000 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c3255f50-98bb-41a0-8b9a-081b8c6d1e48', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C1AE63AB10>]}
[0m12:33:14.752000 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m12:33:14.774018 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m12:33:14.867017 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m12:33:14.868020 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m12:33:15.086473 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c3255f50-98bb-41a0-8b9a-081b8c6d1e48', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C1AE786C90>]}
[0m12:33:15.100474 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c3255f50-98bb-41a0-8b9a-081b8c6d1e48', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C1AE969970>]}
[0m12:33:15.101475 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m12:33:15.103483 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c3255f50-98bb-41a0-8b9a-081b8c6d1e48', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C1AEAAB800>]}
[0m12:33:15.106473 [info ] [MainThread]: 
[0m12:33:15.107475 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m12:33:15.109474 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m12:33:15.125472 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m12:33:15.127479 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m12:33:15.128475 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:33:15.186472 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m12:33:15.187478 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m12:33:15.187478 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m12:33:15.196475 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m12:33:15.198474 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m12:33:15.199473 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m12:33:15.208473 [debug] [MainThread]: Using postgres connection "master"
[0m12:33:15.208473 [debug] [MainThread]: On master: BEGIN
[0m12:33:15.209473 [debug] [MainThread]: Opening a new connection, currently in state init
[0m12:33:15.261476 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m12:33:15.262475 [debug] [MainThread]: Using postgres connection "master"
[0m12:33:15.263475 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m12:33:15.272474 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m12:33:15.274472 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c3255f50-98bb-41a0-8b9a-081b8c6d1e48', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C1AE96B1A0>]}
[0m12:33:15.275473 [debug] [MainThread]: On master: ROLLBACK
[0m12:33:15.276478 [debug] [MainThread]: On master: Close
[0m12:33:15.278478 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m12:33:15.279474 [info ] [MainThread]: 
[0m12:33:15.285475 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m12:33:15.286475 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13'
[0m12:33:15.287473 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m12:33:15.314476 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13"
[0m12:33:15.317488 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (compile): 12:33:15.288475 => 12:33:15.316483
[0m12:33:15.318476 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m12:33:15.319481 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (execute): 12:33:15.319481 => 12:33:15.319481
[0m12:33:15.321474 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m12:33:15.323475 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:33:15.324474 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m12:33:15.324474 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13' was properly closed.
[0m12:33:15.325475 [debug] [MainThread]: Command end result
[0m12:33:15.337484 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_month_13' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_13`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN userneeds like "%Opdater mig%" then "Opdater mig"
			    WHEN userneeds like "%Forbind mig%" then "Forbind mig"
			    WHEN userneeds like "%Help mig med at forsta%" then "Help mig med at forsta"
			    WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
			    WHEN userneeds like "%Underhold mig%" then "Underhold mig"
			    WHEN userneeds like "%Inspirer migg%" then "Inspirer migg"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data
			group by 1,2
		),
        hits_by_tags as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data
		group by 1,2,3
		),
        categories as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d
		),
        json_data as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories
		), 
    
    last_30_days_article_published_second as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Categories like "%order_statement_second%" then "order_statement_second"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_second as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_second  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_second as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_second  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_second as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_second
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_second as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_second l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_second as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_second
			group by 1,2
		),
        hits_by_tags_second as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_second
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits_second as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_second
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data_second as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_second h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d_second as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_second
		group by 1,2,3
		),
        categories_second as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_second
		),
        json_data_second as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_second
		), 
    
    last_30_days_article_published_third as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Tags like "%Long read%" then "Long read"
			    WHEN Tags like "%Kort og godt%" then "Kort og godt"
			    WHEN Tags like "%Q&amp%" then "Q&amp"
			    WHEN Tags like "%Best Practice%" then "Best Practice"
			    WHEN Tags like "%Viden og forskning%" then "Viden og forskning"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_third as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_third  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_third as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_third  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_third as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_third
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_third as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_third l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_third as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_third
			group by 1,2
		),
        hits_by_tags_third as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_third
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits_third as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_third
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data_third as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_third h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d_third as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_third
		group by 1,2,3
		),
        categories_third as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_third
		),
        json_data_third as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_third
		)
    

    SELECT 
		CONCAT(
        ''{'',
            ''"site":'',jd.siteid,'','',
            ''"data": {'',
                ''"label": "'', jd.lab, ''",'',
                ''"categories": ['', jd.cat, ''],'',
                ''"series": ['', jd.series, '']'',
                '',"defaultTitle":"',dtitle,'"'',
                '',"additional":[ ''
                
                ,''{'',
                ''"title":"',title1,'",'',
                ''"data": {'',
                ''"label": "'',json_data_second.lab, ''",'',
                ''"categories": ['', json_data_second.cat, ''],'',
                ''"series": ['', json_data_second.series, '']'',
                ''}}''
                
                , '',''
                
                
                ,''{'',
                ''"title":"',title2,'",'',
                ''"data": {'',
                ''"label": "'',json_data_third.lab, ''",'',
                ''"categories": ['', json_data_third.cat, ''],'',
                ''"series": ['', json_data_third.series, '']'',
                ''}}''
                
                
        '']}}''
    
			) as json_data
		  FROM json_data jd
          
          CROSS join json_data_second
          
          CROSS join json_data_third
          ;
[0m12:33:15.361474 [debug] [MainThread]: Command `dbt compile` succeeded at 12:33:15.360473 after 1.21 seconds
[0m12:33:15.361474 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C1AE557E60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C1AE463320>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C1AD8351C0>]}
[0m12:33:15.363476 [debug] [MainThread]: Flushing usage events
[0m12:41:56.558984 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C9A7330E90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C9A6EBC9B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C9A7331970>]}


============================== 12:41:56.563984 | f298537b-41a1-4fa7-9ed6-1e74efa0e98f ==============================
[0m12:41:56.563984 [info ] [MainThread]: Running with dbt=1.7.13
[0m12:41:56.565994 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m12:41:56.854001 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f298537b-41a1-4fa7-9ed6-1e74efa0e98f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C9A7388440>]}
[0m12:41:56.973025 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f298537b-41a1-4fa7-9ed6-1e74efa0e98f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C9A63DEE70>]}
[0m12:41:56.975026 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m12:41:56.991052 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m12:41:57.514024 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m12:41:57.515026 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m12:41:57.673026 [error] [MainThread]: Encountered an error:
Compilation Error in model tactical_userneeds_pageviews_chart_month_13 (models\tactical_userneeds_pageviews_chart_month_13.sql)
  expected token ',', got 'string'
    line 4
      {% set diction2 = {0: ['Opdater mig', 'Forbind mig', 'Help mig med at forsta', 'Giv mig en fordel','Underhold mig','Inspirer migg'],  2: ['Slagterindustri', Fødevareindustri', 'Mejeri', 'Butik', 'Alle brancher'],1: ['order_statement_second']} %}
[0m12:41:57.676032 [debug] [MainThread]: Command `dbt compile` failed at 12:41:57.676032 after 1.33 seconds
[0m12:41:57.677030 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C9A0D85610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C9A7119460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C9A7672690>]}
[0m12:41:57.678038 [debug] [MainThread]: Flushing usage events
[0m12:43:30.514541 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000209E3392780>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000209E3391A90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000209E3393DA0>]}


============================== 12:43:30.520540 | 0d7529ef-dddc-431b-8a52-6dd27a4476ce ==============================
[0m12:43:30.520540 [info ] [MainThread]: Running with dbt=1.7.13
[0m12:43:30.522546 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m12:43:30.775537 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0d7529ef-dddc-431b-8a52-6dd27a4476ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000209E33E85F0>]}
[0m12:43:30.893538 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0d7529ef-dddc-431b-8a52-6dd27a4476ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000209E33BA810>]}
[0m12:43:30.895537 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m12:43:30.908537 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m12:43:31.010537 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m12:43:31.011540 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m12:43:31.170540 [error] [MainThread]: Encountered an error:
Compilation Error in model tactical_userneeds_pageviews_chart_month_13 (models\tactical_userneeds_pageviews_chart_month_13.sql)
  expected token ',', got 'string'
    line 4
      {% set diction2 = {0: ['Opdater mig', 'Forbind mig', 'Help mig med at forsta', 'Giv mig en fordel','Underhold mig','Inspirer migg'],1: ['order_statement_second'],  2: ['Slagterindustri', Fødevareindustri', 'Mejeri', 'Butik', 'Alle brancher']} %}
[0m12:43:31.173555 [debug] [MainThread]: Command `dbt compile` failed at 12:43:31.172549 after 0.85 seconds
[0m12:43:31.173555 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000209E3027830>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000209E35D4C80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000209E3506DB0>]}
[0m12:43:31.175557 [debug] [MainThread]: Flushing usage events
[0m12:44:41.625396 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001132D820440>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001132D822870>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001132D822AE0>]}


============================== 12:44:41.631407 | 116466b4-d855-4a1c-b9f9-bf783daae42e ==============================
[0m12:44:41.631407 [info ] [MainThread]: Running with dbt=1.7.13
[0m12:44:41.633404 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m12:44:41.888395 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '116466b4-d855-4a1c-b9f9-bf783daae42e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001132D879070>]}
[0m12:44:42.010396 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '116466b4-d855-4a1c-b9f9-bf783daae42e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001132D8CB110>]}
[0m12:44:42.012397 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m12:44:42.025400 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m12:44:42.119399 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m12:44:42.120400 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m12:44:42.327397 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '116466b4-d855-4a1c-b9f9-bf783daae42e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001132DE3A0C0>]}
[0m12:44:42.342401 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '116466b4-d855-4a1c-b9f9-bf783daae42e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001132DC29CA0>]}
[0m12:44:42.344401 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m12:44:42.345405 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '116466b4-d855-4a1c-b9f9-bf783daae42e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001132D822300>]}
[0m12:44:42.348401 [info ] [MainThread]: 
[0m12:44:42.350400 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m12:44:42.352397 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m12:44:42.370396 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m12:44:42.370396 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m12:44:42.371397 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:44:42.427397 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m12:44:42.428400 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m12:44:42.429398 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m12:44:42.437397 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m12:44:42.438396 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m12:44:42.440399 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m12:44:42.448397 [debug] [MainThread]: Using postgres connection "master"
[0m12:44:42.449397 [debug] [MainThread]: On master: BEGIN
[0m12:44:42.449397 [debug] [MainThread]: Opening a new connection, currently in state init
[0m12:44:42.503409 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m12:44:42.504401 [debug] [MainThread]: Using postgres connection "master"
[0m12:44:42.505400 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m12:44:42.514396 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m12:44:42.516398 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '116466b4-d855-4a1c-b9f9-bf783daae42e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001132DC2BEF0>]}
[0m12:44:42.517399 [debug] [MainThread]: On master: ROLLBACK
[0m12:44:42.518398 [debug] [MainThread]: On master: Close
[0m12:44:42.520400 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m12:44:42.523409 [info ] [MainThread]: 
[0m12:44:42.530400 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m12:44:42.532398 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13'
[0m12:44:42.533396 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m12:44:42.557396 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13"
[0m12:44:42.561399 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (compile): 12:44:42.533396 => 12:44:42.560400
[0m12:44:42.562399 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m12:44:42.563398 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (execute): 12:44:42.562399 => 12:44:42.562399
[0m12:44:42.564397 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m12:44:42.566397 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:44:42.567396 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m12:44:42.568397 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13' was properly closed.
[0m12:44:42.569397 [debug] [MainThread]: Command end result
[0m12:44:42.581396 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_month_13' is:







CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_13`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN userneeds like "%Opdater mig%" then "Opdater mig"
			    WHEN userneeds like "%Forbind mig%" then "Forbind mig"
			    WHEN userneeds like "%Help mig med at forsta%" then "Help mig med at forsta"
			    WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
			    WHEN userneeds like "%Underhold mig%" then "Underhold mig"
			    WHEN userneeds like "%Inspirer migg%" then "Inspirer migg"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data
			group by 1,2
		),
        hits_by_tags as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data
		group by 1,2,3
		),
        categories as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d
		),
        json_data as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories
		), 
    
    last_30_days_article_published_second as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Categories like "%order_statement_second%" then "order_statement_second"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_second as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_second  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_second as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_second  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_second as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_second
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_second as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_second l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_second as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_second
			group by 1,2
		),
        hits_by_tags_second as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_second
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits_second as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_second
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data_second as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_second h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d_second as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_second
		group by 1,2,3
		),
        categories_second as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_second
		),
        json_data_second as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_second
		), 
    
    last_30_days_article_published_third as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Tags like "%Slagterindustri%" then "Slagterindustri"
			    WHEN Tags like "%Fødevareindustri%" then "Fødevareindustri"
			    WHEN Tags like "%Mejeri%" then "Mejeri"
			    WHEN Tags like "%Butik%" then "Butik"
			    WHEN Tags like "%Alle brancher%" then "Alle brancher"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_third as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_third  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_third as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_third  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_third as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_third
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_third as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_third l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_third as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_third
			group by 1,2
		),
        hits_by_tags_third as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_third
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits_third as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_third
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data_third as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_third h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d_third as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_third
		group by 1,2,3
		),
        categories_third as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_third
		),
        json_data_third as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_third
		)
    

    SELECT 
		CONCAT(
        ''{'',
            ''"site":'',jd.siteid,'','',
            ''"data": {'',
                ''"label": "'', jd.lab, ''",'',
                ''"categories": ['', jd.cat, ''],'',
                ''"series": ['', jd.series, '']'',
                '',"defaultTitle":"',dtitle,'"'',
                '',"additional":[ ''
                
                ,''{'',
                ''"title":"',title1,'",'',
                ''"data": {'',
                ''"label": "'',json_data_second.lab, ''",'',
                ''"categories": ['', json_data_second.cat, ''],'',
                ''"series": ['', json_data_second.series, '']'',
                ''}}''
                
                , '',''
                
                
                ,''{'',
                ''"title":"',title2,'",'',
                ''"data": {'',
                ''"label": "'',json_data_third.lab, ''",'',
                ''"categories": ['', json_data_third.cat, ''],'',
                ''"series": ['', json_data_third.series, '']'',
                ''}}''
                
                
        '']}}''
    
			) as json_data
		  FROM json_data jd
          
          CROSS join json_data_second
          
          CROSS join json_data_third
          ;
[0m12:44:42.605399 [debug] [MainThread]: Command `dbt compile` succeeded at 12:44:42.605399 after 1.13 seconds
[0m12:44:42.606398 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000113272B5610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001132CCEEF30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001132D8479B0>]}
[0m12:44:42.607399 [debug] [MainThread]: Flushing usage events
[0m13:02:15.801498 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F87F083860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F87F081CA0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F87F0830B0>]}


============================== 13:02:15.807500 | ac851f86-a8b9-4837-bb3c-a40aa3f9ec2c ==============================
[0m13:02:15.807500 [info ] [MainThread]: Running with dbt=1.7.13
[0m13:02:15.809503 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m13:02:16.064493 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ac851f86-a8b9-4837-bb3c-a40aa3f9ec2c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F87EF38B60>]}
[0m13:02:16.183496 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ac851f86-a8b9-4837-bb3c-a40aa3f9ec2c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F87EDAC170>]}
[0m13:02:16.185498 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m13:02:16.209210 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m13:02:16.304205 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m13:02:16.305208 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m13:02:16.511206 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ac851f86-a8b9-4837-bb3c-a40aa3f9ec2c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F87F5FDCA0>]}
[0m13:02:16.526209 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ac851f86-a8b9-4837-bb3c-a40aa3f9ec2c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F87F4B9BB0>]}
[0m13:02:16.527208 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m13:02:16.529215 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ac851f86-a8b9-4837-bb3c-a40aa3f9ec2c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F87F650530>]}
[0m13:02:16.531211 [info ] [MainThread]: 
[0m13:02:16.533206 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m13:02:16.535534 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m13:02:16.555297 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m13:02:16.555297 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m13:02:16.556297 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:02:16.615299 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m13:02:16.615299 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m13:02:16.616298 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m13:02:16.624297 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m13:02:16.626298 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m13:02:16.627296 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m13:02:16.635295 [debug] [MainThread]: Using postgres connection "master"
[0m13:02:16.636296 [debug] [MainThread]: On master: BEGIN
[0m13:02:16.637298 [debug] [MainThread]: Opening a new connection, currently in state init
[0m13:02:16.685297 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m13:02:16.686299 [debug] [MainThread]: Using postgres connection "master"
[0m13:02:16.687298 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m13:02:16.697297 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m13:02:16.699297 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ac851f86-a8b9-4837-bb3c-a40aa3f9ec2c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F87F4BBE30>]}
[0m13:02:16.700297 [debug] [MainThread]: On master: ROLLBACK
[0m13:02:16.700297 [debug] [MainThread]: On master: Close
[0m13:02:16.702299 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m13:02:16.703297 [info ] [MainThread]: 
[0m13:02:16.708296 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m13:02:16.710298 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13'
[0m13:02:16.712298 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m13:02:16.745328 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13"
[0m13:02:16.748298 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (compile): 13:02:16.713309 => 13:02:16.747296
[0m13:02:16.749297 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m13:02:16.750297 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (execute): 13:02:16.749297 => 13:02:16.749297
[0m13:02:16.752298 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m13:02:16.753298 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:02:16.754313 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m13:02:16.754313 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13' was properly closed.
[0m13:02:16.756299 [debug] [MainThread]: Command end result
[0m13:02:16.770296 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_month_13' is:







CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_13`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN userneeds like "%Opdater mig%" then "Opdater mig"
			    WHEN userneeds like "%Forbind mig%" then "Forbind mig"
			    WHEN userneeds like "%Help mig med at forsta%" then "Help mig med at forsta"
			    WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
			    WHEN userneeds like "%Underhold mig%" then "Underhold mig"
			    WHEN userneeds like "%Inspirer migg%" then "Inspirer migg"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data
			group by 1,2
		),
        hits_by_tags as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts h
			join total_hits t on h.siteid=t.siteid
			join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data
		group by 1,2,3
		),
        categories as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d
		),
        json_data as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories
		), 
    
    last_30_days_article_published_second as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Categories like "%order_statement_second%" then "order_statement_second"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_second as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_second  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_second as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_second  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_second as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_second
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_second as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_second l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_second as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_second
			group by 1,2
		),
        hits_by_tags_second as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_second
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits_second as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_second
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data_second as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_second h
			join total_hits_second t on h.siteid=t.siteid
			join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d_second as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_second
		group by 1,2,3
		),
        categories_second as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_second
		),
        json_data_second as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_second
		), 
    
    last_30_days_article_published_third as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Tags like "%Slagterindustri%" then "Slagterindustri"
			    WHEN Tags like "%Fødevareindustri%" then "Fødevareindustri"
			    WHEN Tags like "%Mejeri%" then "Mejeri"
			    WHEN Tags like "%Butik%" then "Butik"
			    WHEN Tags like "%Alle brancher%" then "Alle brancher"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_third as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_third  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_third as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_third  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_third as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_third
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_third as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_third l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_third as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_third
			group by 1,2
		),
        hits_by_tags_third as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_third
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits_third as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_third
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data_third as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_third h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d_third as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_third
		group by 1,2,3
		),
        categories_third as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_third
		),
        json_data_third as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_third
		)
    

    SELECT 
		CONCAT(
        ''{'',
            ''"site":'',jd.siteid,'','',
            ''"data": {'',
                ''"label": "'', jd.lab, ''",'',
                ''"categories": ['', jd.cat, ''],'',
                ''"series": ['', jd.series, '']'',
                '',"defaultTitle":"',dtitle,'"'',
                '',"additional":[ ''
                
                ,''{'',
                ''"title":"',title1,'",'',
                ''"data": {'',
                ''"label": "'',json_data_second.lab, ''",'',
                ''"categories": ['', json_data_second.cat, ''],'',
                ''"series": ['', json_data_second.series, '']'',
                ''}}''
                
                , '',''
                
                
                ,''{'',
                ''"title":"',title2,'",'',
                ''"data": {'',
                ''"label": "'',json_data_third.lab, ''",'',
                ''"categories": ['', json_data_third.cat, ''],'',
                ''"series": ['', json_data_third.series, '']'',
                ''}}''
                
                
        '']}}''
    
			) as json_data
		  FROM json_data jd
          
          CROSS join json_data_second
          
          CROSS join json_data_third
          ;
[0m13:02:16.797321 [debug] [MainThread]: Command `dbt compile` succeeded at 13:02:16.797321 after 1.20 seconds
[0m13:02:16.798320 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F87EE68680>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F87F083860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F87F6ABBF0>]}
[0m13:02:16.799320 [debug] [MainThread]: Flushing usage events
[0m14:37:07.218235 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FE407B30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FE407BC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FE407530>]}


============================== 14:37:07.230241 | 90a6c25e-484c-4373-83d8-920a714d4b67 ==============================
[0m14:37:07.230241 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:37:07.233235 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'send_anonymous_usage_stats': 'True'}
[0m14:37:07.738216 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '90a6c25e-484c-4373-83d8-920a714d4b67', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FE458BF0>]}
[0m14:37:07.978571 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '90a6c25e-484c-4373-83d8-920a714d4b67', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FE426750>]}
[0m14:37:07.981568 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:37:08.010642 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:37:08.243315 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m14:37:08.245316 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m14:37:08.628140 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '90a6c25e-484c-4373-83d8-920a714d4b67', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FE5FA0F0>]}
[0m14:37:08.656137 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '90a6c25e-484c-4373-83d8-920a714d4b67', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FE859820>]}
[0m14:37:08.657140 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m14:37:08.659520 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '90a6c25e-484c-4373-83d8-920a714d4b67', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FE77EAB0>]}
[0m14:37:08.664143 [info ] [MainThread]: 
[0m14:37:08.667140 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m14:37:08.669139 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m14:37:08.692472 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:37:08.693693 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m14:37:08.695312 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:37:08.785269 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m14:37:08.786270 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:37:08.787271 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m14:37:08.802943 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m14:37:08.805944 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m14:37:08.806942 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m14:37:08.816949 [debug] [MainThread]: Using postgres connection "master"
[0m14:37:08.818236 [debug] [MainThread]: On master: BEGIN
[0m14:37:08.818946 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:37:08.888947 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m14:37:08.890949 [debug] [MainThread]: Using postgres connection "master"
[0m14:37:08.891945 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m14:37:08.907765 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m14:37:08.911843 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '90a6c25e-484c-4373-83d8-920a714d4b67', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FE85BE30>]}
[0m14:37:08.912769 [debug] [MainThread]: On master: ROLLBACK
[0m14:37:08.914769 [debug] [MainThread]: On master: Close
[0m14:37:08.916003 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:37:08.918769 [info ] [MainThread]: 
[0m14:37:08.925763 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m14:37:08.928778 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13'
[0m14:37:08.929764 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m14:37:08.968763 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13"
[0m14:37:08.971778 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (compile): 14:37:08.931380 => 14:37:08.970769
[0m14:37:08.973763 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m14:37:08.974926 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (execute): 14:37:08.974926 => 14:37:08.974926
[0m14:37:08.977762 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m14:37:08.979766 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:37:08.980955 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m14:37:08.981766 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13' was properly closed.
[0m14:37:08.983767 [debug] [MainThread]: Command end result
[0m14:37:08.999763 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_month_13' is:








CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_13`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN userneeds like "%Opdater mig%" then "Opdater mig"
			    WHEN userneeds like "%Forbind mig%" then "Forbind mig"
			    WHEN userneeds like "%Help mig med at forsta%" then "Hjælp mig med at forstå"
			    WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
			    WHEN userneeds like "%Underhold mig%" then "Underhold mig"
			    WHEN userneeds like "%Inspirer migg%" then "Inspirer migg"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article as(
		select siteid as siteid,tags,sum(val) as agg_sum from
        cta_per_article
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data
			group by 1,2
		),
        hits_by_tags as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts h
			join total_hits t on h.siteid=t.siteid
			join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data
		group by 1,2,3
		),
        categories as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d
		),
        json_data as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories
		), 
    
    last_30_days_article_published_second as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Categories like "%Nyhed%" then "Nyhed"
			    WHEN Categories like "%Medlemsinfo%" then "Medlemsinfo"
			    WHEN Categories like "%Reportage%" then "Reportage"
			    WHEN Categories like "%Artikel%" then "Artikel"
			    WHEN Categories like "%Det ku ske for dig%" then "Det ku ske for dig"
			    WHEN Categories like "%Jeg mener%" then "Jeg mener"
			    WHEN Categories like "%Videoartikel%" then "Videoartikel"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_second as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_second  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_second as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_second  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_second as(
		select siteid as siteid,tags,sum(val) as agg_sum from
        cta_per_article_second
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_second as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_second l
		join cta_per_article_second a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_second as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_second
			group by 1,2
		),
        hits_by_tags_second as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_second
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits_second as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_second
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data_second as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_second h
			join total_hits_second t on h.siteid=t.siteid
			join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d_second as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_second
		group by 1,2,3
		),
        categories_second as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_second
		),
        json_data_second as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_second
		), 
    
    last_30_days_article_published_third as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Tags like "%Slagterindustri%" then "Slagterindustri"
			    WHEN Tags like "%Fødevareindustri%" then "Fødevareindustri"
			    WHEN Tags like "%Mejeri%" then "Mejeri"
			    WHEN Tags like "%Butik%" then "Butik"
			    WHEN Tags like "%Alle brancher%" then "Alle brancher"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_third as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_third  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_third as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_third  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_third as(
		select siteid as siteid,tags,sum(val) as agg_sum from
        cta_per_article_third
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_third as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_third l
		join cta_per_article_third a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_third as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_third
			group by 1,2
		),
        hits_by_tags_third as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_third
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits_third as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_third
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data_third as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_third h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d_third as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_third
		group by 1,2,3
		),
        categories_third as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_third
		),
        json_data_third as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_third
		)
    

    SELECT 
		CONCAT(
        ''{'',
            ''"site":'',jd.siteid,'','',
            ''"data": {'',
                ''"label": "'', jd.lab, ''",'',
                ''"categories": ['', jd.cat, ''],'',
                ''"series": ['', jd.series, '']'',
                '',"defaultTitle":"',dtitle,'"'',
                '',"additional":[ ''
                
                ,''{'',
                ''"title":"',title1,'",'',
                ''"data": {'',
                ''"label": "'',json_data_second.lab, ''",'',
                ''"categories": ['', json_data_second.cat, ''],'',
                ''"series": ['', json_data_second.series, '']'',
                ''}}''
                
                , '',''
                
                
                ,''{'',
                ''"title":"',title2,'",'',
                ''"data": {'',
                ''"label": "'',json_data_third.lab, ''",'',
                ''"categories": ['', json_data_third.cat, ''],'',
                ''"series": ['', json_data_third.series, '']'',
                ''}}''
                
                
        '']}}''
    
			) as json_data
		  FROM json_data jd
          
          CROSS join json_data_second
          
          CROSS join json_data_third
          ;
[0m14:37:09.037140 [debug] [MainThread]: Command `dbt compile` succeeded at 14:37:09.036548 after 2.16 seconds
[0m14:37:09.039141 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FD2F8470>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FE427C20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FE3E3EC0>]}
[0m14:37:09.040138 [debug] [MainThread]: Flushing usage events
[0m11:52:26.284532 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002205ECD17C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002205ECD1910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002205ECD19D0>]}


============================== 11:52:26.291532 | 01d0e43b-c03e-46db-b112-14d4d0015a7d ==============================
[0m11:52:26.291532 [info ] [MainThread]: Running with dbt=1.7.13
[0m11:52:26.293538 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m11:52:26.705529 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '01d0e43b-c03e-46db-b112-14d4d0015a7d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002205EA861E0>]}
[0m11:52:26.844530 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '01d0e43b-c03e-46db-b112-14d4d0015a7d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002205E0CC770>]}
[0m11:52:26.847533 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m11:52:26.875534 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m11:52:27.946532 [debug] [MainThread]: Partial parsing enabled: 1 files deleted, 1 files added, 1 files changed.
[0m11:52:27.946532 [debug] [MainThread]: Partial parsing: added file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m11:52:27.947532 [debug] [MainThread]: Partial parsing: deleted file: dbt_project_test_kasper://models\test2.sql
[0m11:52:27.948537 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m11:52:28.268534 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '01d0e43b-c03e-46db-b112-14d4d0015a7d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002205F23AAB0>]}
[0m11:52:28.301534 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '01d0e43b-c03e-46db-b112-14d4d0015a7d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002205F060CB0>]}
[0m11:52:28.302533 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m11:52:28.304557 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '01d0e43b-c03e-46db-b112-14d4d0015a7d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002205F24C8F0>]}
[0m11:52:28.308542 [info ] [MainThread]: 
[0m11:52:28.309533 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m11:52:28.311532 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m11:52:28.331531 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:52:28.332530 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m11:52:28.333534 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:52:28.401530 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m11:52:28.402532 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:52:28.403533 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m11:52:28.436531 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m11:52:28.438533 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m11:52:28.439532 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m11:52:28.446532 [debug] [MainThread]: Using postgres connection "master"
[0m11:52:28.447533 [debug] [MainThread]: On master: BEGIN
[0m11:52:28.448533 [debug] [MainThread]: Opening a new connection, currently in state init
[0m11:52:28.512532 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m11:52:28.513536 [debug] [MainThread]: Using postgres connection "master"
[0m11:52:28.515535 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m11:52:28.532531 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m11:52:28.535531 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '01d0e43b-c03e-46db-b112-14d4d0015a7d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002205EE769C0>]}
[0m11:52:28.537533 [debug] [MainThread]: On master: ROLLBACK
[0m11:52:28.538533 [debug] [MainThread]: On master: Close
[0m11:52:28.540538 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:52:28.542549 [info ] [MainThread]: 
[0m11:52:28.548531 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m11:52:28.549535 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m11:52:28.550533 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m11:52:28.565531 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m11:52:28.568535 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 11:52:28.551532 => 11:52:28.567535
[0m11:52:28.569534 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m11:52:28.571535 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 11:52:28.570536 => 11:52:28.570536
[0m11:52:28.576570 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m11:52:28.579533 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:52:28.580535 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m11:52:28.581537 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m11:52:28.584536 [debug] [MainThread]: Command end result
[0m11:52:28.602534 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:










CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    referrers AS

    ,
    categories AS (
            SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site, 
            UNION ALL SELECT 'Others'
        '), 
    
    referrers_second AS

    ,
    categories AS (
            SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site, 
            UNION ALL SELECT 'Others'
        '), 
    
    referrers_third AS

    ,
    categories AS (
            SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site, 
            UNION ALL SELECT 'Others'
        ')
    
[0m11:52:28.614536 [debug] [MainThread]: Command `dbt compile` succeeded at 11:52:28.614536 after 2.56 seconds
[0m11:52:28.615535 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002205E00F830>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002205ECD17C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002205ECD1910>]}
[0m11:52:28.616534 [debug] [MainThread]: Flushing usage events
[0m15:24:05.528309 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017C80D03260>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017C80D035C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017C80D02F60>]}


============================== 15:24:05.536255 | 944f0768-9ebc-4f46-abd4-306163881715 ==============================
[0m15:24:05.536255 [info ] [MainThread]: Running with dbt=1.7.13
[0m15:24:05.538274 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m15:24:05.857604 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '944f0768-9ebc-4f46-abd4-306163881715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017C80D58BC0>]}
[0m15:24:05.974603 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '944f0768-9ebc-4f46-abd4-306163881715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017C80CE3F80>]}
[0m15:24:05.976604 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m15:24:05.999607 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m15:24:06.589884 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:24:06.591885 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m15:24:06.785887 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '944f0768-9ebc-4f46-abd4-306163881715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017C80F1F890>]}
[0m15:24:06.809915 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '944f0768-9ebc-4f46-abd4-306163881715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017C810B9AC0>]}
[0m15:24:06.810914 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m15:24:06.812919 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '944f0768-9ebc-4f46-abd4-306163881715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017C811DAD80>]}
[0m15:24:06.814919 [info ] [MainThread]: 
[0m15:24:06.816913 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m15:24:06.818912 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m15:24:06.834914 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m15:24:06.835915 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m15:24:06.836914 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:24:06.904913 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m15:24:06.905922 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m15:24:06.905922 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m15:24:06.936402 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m15:24:06.938426 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m15:24:06.940180 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m15:24:06.947194 [debug] [MainThread]: Using postgres connection "master"
[0m15:24:06.948193 [debug] [MainThread]: On master: BEGIN
[0m15:24:06.948193 [debug] [MainThread]: Opening a new connection, currently in state init
[0m15:24:07.005193 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m15:24:07.006198 [debug] [MainThread]: Using postgres connection "master"
[0m15:24:07.007193 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m15:24:07.022191 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m15:24:07.024196 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '944f0768-9ebc-4f46-abd4-306163881715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017C810BBD10>]}
[0m15:24:07.025194 [debug] [MainThread]: On master: ROLLBACK
[0m15:24:07.026205 [debug] [MainThread]: On master: Close
[0m15:24:07.029200 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:24:07.031202 [info ] [MainThread]: 
[0m15:24:07.037196 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m15:24:07.039193 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m15:24:07.040191 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m15:24:07.057194 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m15:24:07.059196 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 15:24:07.041195 => 15:24:07.058193
[0m15:24:07.062195 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m15:24:07.063193 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 15:24:07.062195 => 15:24:07.062195
[0m15:24:07.065193 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m15:24:07.067193 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:24:07.067193 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m15:24:07.068195 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m15:24:07.069194 [debug] [MainThread]: Command end result
[0m15:24:07.080195 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:










CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    referrers AS

    ,
    categories AS (
            SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', diction30, ') and siteid = ', site, 
            UNION ALL SELECT 'Others'
        '), 
    
    referrers_second AS

    ,
    categories AS (
            SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', diction31, ') and siteid = ', site, 
            UNION ALL SELECT 'Others'
        '), 
    
    referrers_third AS

    ,
    categories AS (
            SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', diction32, ') and siteid = ', site, 
            UNION ALL SELECT 'Others'
        ')
    
[0m15:24:07.086198 [debug] [MainThread]: Command `dbt compile` succeeded at 15:24:07.085196 after 1.77 seconds
[0m15:24:07.087195 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017CFA905610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017C80D03260>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017C80D27B00>]}
[0m15:24:07.089195 [debug] [MainThread]: Flushing usage events
[0m15:24:49.712922 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9F1322C00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9F1323CB0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9F1323C20>]}


============================== 15:24:49.718920 | e02b9888-42c4-45ee-964f-3490d679053a ==============================
[0m15:24:49.718920 [info ] [MainThread]: Running with dbt=1.7.13
[0m15:24:49.720928 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m15:24:49.974919 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e02b9888-42c4-45ee-964f-3490d679053a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9F1378650>]}
[0m15:24:50.094953 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e02b9888-42c4-45ee-964f-3490d679053a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9F03CF020>]}
[0m15:24:50.095954 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m15:24:50.109951 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m15:24:50.211955 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:24:50.212976 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m15:24:50.380075 [error] [MainThread]: Encountered an error:
Compilation Error in model pageview_weeks_dummy_2_3__site__13 (models\pageview_weeks_dummy_2_3__site__13.sql)
  expected token 'end of print statement', got '{'
    line 31
      WHERE Categories IN (', {{diction3{{i}}}}, ') and siteid = ', site,
[0m15:24:50.383089 [debug] [MainThread]: Command `dbt compile` failed at 15:24:50.383089 after 0.85 seconds
[0m15:24:50.384103 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9F125DB80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9EAF81C70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9F1303F80>]}
[0m15:24:50.385095 [debug] [MainThread]: Flushing usage events
[0m15:25:33.994611 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012921486A50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000129214878F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000129214861B0>]}


============================== 15:25:33.999609 | fc1d6848-c0ce-4049-8c91-6e8dfdc556ca ==============================
[0m15:25:33.999609 [info ] [MainThread]: Running with dbt=1.7.13
[0m15:25:34.001619 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m15:25:34.259629 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'fc1d6848-c0ce-4049-8c91-6e8dfdc556ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000129211B0BC0>]}
[0m15:25:34.379630 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'fc1d6848-c0ce-4049-8c91-6e8dfdc556ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000129213611C0>]}
[0m15:25:34.381634 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m15:25:34.395631 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m15:25:34.486628 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:25:34.487633 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m15:25:34.687632 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'fc1d6848-c0ce-4049-8c91-6e8dfdc556ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000129219BE210>]}
[0m15:25:34.702644 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'fc1d6848-c0ce-4049-8c91-6e8dfdc556ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001292177FF20>]}
[0m15:25:34.703635 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m15:25:34.705636 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fc1d6848-c0ce-4049-8c91-6e8dfdc556ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012921392300>]}
[0m15:25:34.710634 [info ] [MainThread]: 
[0m15:25:34.711631 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m15:25:34.713628 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m15:25:34.730631 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m15:25:34.730631 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m15:25:34.731632 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:25:34.792629 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m15:25:34.793631 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m15:25:34.794630 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m15:25:34.805631 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m15:25:34.806632 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m15:25:34.807630 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m15:25:34.814628 [debug] [MainThread]: Using postgres connection "master"
[0m15:25:34.815630 [debug] [MainThread]: On master: BEGIN
[0m15:25:34.816632 [debug] [MainThread]: Opening a new connection, currently in state init
[0m15:25:34.869633 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m15:25:34.870638 [debug] [MainThread]: Using postgres connection "master"
[0m15:25:34.872633 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m15:25:34.906633 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m15:25:34.910633 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fc1d6848-c0ce-4049-8c91-6e8dfdc556ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000129219F7C50>]}
[0m15:25:34.912638 [debug] [MainThread]: On master: ROLLBACK
[0m15:25:34.913640 [debug] [MainThread]: On master: Close
[0m15:25:34.916637 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:25:34.918650 [info ] [MainThread]: 
[0m15:25:34.980631 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m15:25:34.981632 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m15:25:34.982636 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m15:25:35.012632 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m15:25:35.015633 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 15:25:34.983634 => 15:25:35.014631
[0m15:25:35.016632 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m15:25:35.017635 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 15:25:35.016632 => 15:25:35.016632
[0m15:25:35.019636 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m15:25:35.021630 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:25:35.021630 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m15:25:35.022628 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m15:25:35.024631 [debug] [MainThread]: Command end result
[0m15:25:35.040632 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:










CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    referrers AS

    ,
    categories AS (
            SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site, 
            UNION ALL SELECT 'Others'
        '), 
    
    referrers_second AS

    ,
    categories AS (
            SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site, 
            UNION ALL SELECT 'Others'
        '), 
    
    referrers_third AS

    ,
    categories AS (
            SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site, 
            UNION ALL SELECT 'Others'
        ')
    
[0m15:25:35.045631 [debug] [MainThread]: Command `dbt compile` succeeded at 15:25:35.044635 after 1.19 seconds
[0m15:25:35.046632 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001291AF45610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000129214AF920>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012921935490>]}
[0m15:25:35.047635 [debug] [MainThread]: Flushing usage events
[0m15:34:57.165119 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB209F7F20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB209F6AB0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB209F7110>]}


============================== 15:34:57.170117 | cc0a343d-5d68-4d74-8a3d-b8bb5e2e3a0d ==============================
[0m15:34:57.170117 [info ] [MainThread]: Running with dbt=1.7.13
[0m15:34:57.172129 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m15:34:57.427115 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'cc0a343d-5d68-4d74-8a3d-b8bb5e2e3a0d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB20A9B290>]}
[0m15:34:57.544116 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'cc0a343d-5d68-4d74-8a3d-b8bb5e2e3a0d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB2083D8B0>]}
[0m15:34:57.546120 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m15:34:57.561117 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m15:34:57.669117 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:34:57.670120 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m15:34:57.866117 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'cc0a343d-5d68-4d74-8a3d-b8bb5e2e3a0d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB20D3BD40>]}
[0m15:34:57.881120 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'cc0a343d-5d68-4d74-8a3d-b8bb5e2e3a0d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB20DAD850>]}
[0m15:34:57.882119 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m15:34:57.884129 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cc0a343d-5d68-4d74-8a3d-b8bb5e2e3a0d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB20A14200>]}
[0m15:34:57.886120 [info ] [MainThread]: 
[0m15:34:57.888120 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m15:34:57.890124 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m15:34:57.907135 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m15:34:57.908132 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m15:34:57.909143 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:34:57.967120 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m15:34:57.968122 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m15:34:57.969123 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m15:34:57.979119 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m15:34:57.981123 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m15:34:57.982124 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m15:34:57.988118 [debug] [MainThread]: Using postgres connection "master"
[0m15:34:57.990120 [debug] [MainThread]: On master: BEGIN
[0m15:34:57.990120 [debug] [MainThread]: Opening a new connection, currently in state init
[0m15:34:58.038142 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m15:34:58.039119 [debug] [MainThread]: Using postgres connection "master"
[0m15:34:58.040119 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m15:34:58.049116 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m15:34:58.052122 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cc0a343d-5d68-4d74-8a3d-b8bb5e2e3a0d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB20A49D60>]}
[0m15:34:58.053119 [debug] [MainThread]: On master: ROLLBACK
[0m15:34:58.055119 [debug] [MainThread]: On master: Close
[0m15:34:58.057122 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:34:58.059125 [info ] [MainThread]: 
[0m15:34:58.063120 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m15:34:58.065120 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m15:34:58.065120 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m15:34:58.082117 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m15:34:58.084122 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 15:34:58.066118 => 15:34:58.083119
[0m15:34:58.085121 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m15:34:58.086121 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 15:34:58.086121 => 15:34:58.086121
[0m15:34:58.088120 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m15:34:58.090132 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:34:58.091121 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m15:34:58.092129 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m15:34:58.093119 [debug] [MainThread]: Command end result
[0m15:34:58.103120 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:










CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    referrers AS

    ,
    categories AS (
            SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site, 
            UNION ALL SELECT 'Others'
        ')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        )
        ,
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,, 
    
    referrers_second AS

    ,
    categories_second AS (
            SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site, 
            UNION ALL SELECT 'Others'
        ')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        )
        ,
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,, 
    
    referrers_third AS

    ,
    categories_third AS (
            SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site, 
            UNION ALL SELECT 'Others'
        ')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        )
        ,
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
    
[0m15:34:58.119153 [debug] [MainThread]: Command `dbt compile` succeeded at 15:34:58.118153 after 1.15 seconds
[0m15:34:58.120141 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB20A17B60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB2071CA70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB208869F0>]}
[0m15:34:58.122147 [debug] [MainThread]: Flushing usage events
[0m16:51:41.905982 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F6AECB2D80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F6AECB3AA0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F6AECB2B10>]}


============================== 16:51:41.911981 | 4a4a0c4f-7da4-4203-a8f1-22b6d91cc89f ==============================
[0m16:51:41.911981 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:51:41.913988 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'send_anonymous_usage_stats': 'True'}
[0m16:51:42.173982 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4a4a0c4f-7da4-4203-a8f1-22b6d91cc89f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F6AED78410>]}
[0m16:51:42.292983 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4a4a0c4f-7da4-4203-a8f1-22b6d91cc89f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F6AED08560>]}
[0m16:51:42.295015 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:51:42.308981 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:51:42.423005 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:51:42.424008 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m16:51:42.623005 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4a4a0c4f-7da4-4203-a8f1-22b6d91cc89f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F6AF1EEC60>]}
[0m16:51:42.638012 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4a4a0c4f-7da4-4203-a8f1-22b6d91cc89f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F6AF059B20>]}
[0m16:51:42.639011 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m16:51:42.641016 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4a4a0c4f-7da4-4203-a8f1-22b6d91cc89f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F6AF12E390>]}
[0m16:51:42.645018 [info ] [MainThread]: 
[0m16:51:42.647009 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m16:51:42.649006 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m16:51:42.666005 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:51:42.667006 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m16:51:42.668008 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:51:42.724006 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m16:51:42.725007 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:51:42.726006 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m16:51:42.748006 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m16:51:42.750004 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m16:51:42.751008 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m16:51:42.759007 [debug] [MainThread]: Using postgres connection "master"
[0m16:51:42.760008 [debug] [MainThread]: On master: BEGIN
[0m16:51:42.761008 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:51:42.915825 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:51:42.916840 [debug] [MainThread]: Using postgres connection "master"
[0m16:51:42.918821 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m16:51:42.935822 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m16:51:42.939824 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4a4a0c4f-7da4-4203-a8f1-22b6d91cc89f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F6AF05BBF0>]}
[0m16:51:42.940820 [debug] [MainThread]: On master: ROLLBACK
[0m16:51:42.941820 [debug] [MainThread]: On master: Close
[0m16:51:42.943822 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:51:42.945829 [info ] [MainThread]: 
[0m16:51:42.958821 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m16:51:42.961830 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m16:51:42.963825 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m16:51:43.003821 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m16:51:43.006823 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 16:51:42.964824 => 16:51:43.005820
[0m16:51:43.008824 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m16:51:43.009824 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 16:51:43.008824 => 16:51:43.008824
[0m16:51:43.011823 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m16:51:43.013820 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:51:43.014822 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m16:51:43.015820 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m16:51:43.017831 [debug] [MainThread]: Command end result
[0m16:51:43.033821 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:










CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    referrers AS

    ,
    categories AS (
            SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site, 
            UNION ALL SELECT 'Others'
        ')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        )
        ,
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        )
        ,
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        ,
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        )
        ,
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        )
        ,
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		)
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third, 
    
    referrers_second AS

    ,
    categories_second AS (
            SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site, 
            UNION ALL SELECT 'Others'
        ')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        )
        ,
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_second, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        )
        ,
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        ,
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        )
        ,
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        )
        ,
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		)
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third, 
    
    referrers_third AS

    ,
    categories_third AS (
            SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site, 
            UNION ALL SELECT 'Others'
        ')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        )
        ,
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_third, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        )
        ,
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        ,
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        )
        ,
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        )
        ,
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third
    
[0m16:51:43.049820 [debug] [MainThread]: Command `dbt compile` succeeded at 16:51:43.049820 after 1.34 seconds
[0m16:51:43.051819 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F6AECDBB60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F6AEFA6030>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F6A8685460>]}
[0m16:51:43.052825 [debug] [MainThread]: Flushing usage events
[0m17:15:39.207705 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A7A4A70AD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A7A4A71790>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A7A4A71670>]}


============================== 17:15:39.214703 | 0e5980fa-33a4-47cb-9c76-3244abb5e227 ==============================
[0m17:15:39.214703 [info ] [MainThread]: Running with dbt=1.7.13
[0m17:15:39.216712 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:15:39.473701 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0e5980fa-33a4-47cb-9c76-3244abb5e227', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A7A4BD5730>]}
[0m17:15:39.599706 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0e5980fa-33a4-47cb-9c76-3244abb5e227', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A7A4AC8560>]}
[0m17:15:39.602708 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m17:15:39.622706 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m17:15:39.743223 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:15:39.744224 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m17:15:39.910223 [error] [MainThread]: Encountered an error:
Compilation Error in model pageview_weeks_dummy_2_3__site__13 (models\pageview_weeks_dummy_2_3__site__13.sql)
  Encountered unknown tag 'end'. Jinja was looking for the following tags: 'elif' or 'else' or 'endif'. The innermost block that needs to be closed is 'if'.
    line 81
      {%end if%}
[0m17:15:39.913230 [debug] [MainThread]: Command `dbt compile` failed at 17:15:39.912241 after 0.96 seconds
[0m17:15:39.914224 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A79E4C5610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A7A4C6DD30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A7A4F9E870>]}
[0m17:15:39.914224 [debug] [MainThread]: Flushing usage events
[0m17:16:50.862686 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002466FC03230>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002466FC03CE0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002466FC03710>]}


============================== 17:16:50.868686 | 3429d608-d661-4f4c-8c34-910ecfb43d70 ==============================
[0m17:16:50.868686 [info ] [MainThread]: Running with dbt=1.7.13
[0m17:16:50.870694 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m17:16:51.121684 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3429d608-d661-4f4c-8c34-910ecfb43d70', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002466FCAB290>]}
[0m17:16:51.238688 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3429d608-d661-4f4c-8c34-910ecfb43d70', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002466FC58440>]}
[0m17:16:51.240694 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m17:16:51.253685 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m17:16:51.345683 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:16:51.346685 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m17:16:51.508688 [error] [MainThread]: Encountered an error:
Compilation Error in model pageview_weeks_dummy_2_3__site__13 (models\pageview_weeks_dummy_2_3__site__13.sql)
  Encountered unknown tag 'end'. Jinja was looking for the following tags: 'elif' or 'else' or 'endif'. The innermost block that needs to be closed is 'if'.
    line 81
      {% end if %}
[0m17:16:51.510690 [debug] [MainThread]: Command `dbt compile` failed at 17:16:51.510690 after 0.79 seconds
[0m17:16:51.511686 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002466F9E9490>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002466FFB4B30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002467012F620>]}
[0m17:16:51.512688 [debug] [MainThread]: Flushing usage events
[0m17:17:18.205355 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002545FC06C30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002545FC06B70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002545FC065A0>]}


============================== 17:17:18.211355 | a442d553-4412-44af-8c73-75acc7bf7a56 ==============================
[0m17:17:18.211355 [info ] [MainThread]: Running with dbt=1.7.13
[0m17:17:18.213376 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:17:18.462358 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a442d553-4412-44af-8c73-75acc7bf7a56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002545F930BC0>]}
[0m17:17:18.582354 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a442d553-4412-44af-8c73-75acc7bf7a56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002545FC26420>]}
[0m17:17:18.583357 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m17:17:18.598355 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m17:17:18.690357 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:17:18.691358 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m17:17:18.905387 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a442d553-4412-44af-8c73-75acc7bf7a56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002545F7CD9A0>]}
[0m17:17:18.920391 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a442d553-4412-44af-8c73-75acc7bf7a56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002545FFA9610>]}
[0m17:17:18.922391 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m17:17:18.923396 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a442d553-4412-44af-8c73-75acc7bf7a56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002545FC58860>]}
[0m17:17:18.926388 [info ] [MainThread]: 
[0m17:17:18.928402 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m17:17:18.930390 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m17:17:18.947413 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:17:18.948389 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m17:17:18.949388 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:17:19.006388 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m17:17:19.007393 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:17:19.007393 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m17:17:19.016389 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m17:17:19.018388 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m17:17:19.019387 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m17:17:19.028387 [debug] [MainThread]: Using postgres connection "master"
[0m17:17:19.029388 [debug] [MainThread]: On master: BEGIN
[0m17:17:19.029388 [debug] [MainThread]: Opening a new connection, currently in state init
[0m17:17:19.080388 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m17:17:19.081394 [debug] [MainThread]: Using postgres connection "master"
[0m17:17:19.081394 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m17:17:19.091386 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m17:17:19.093388 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a442d553-4412-44af-8c73-75acc7bf7a56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002545FF583E0>]}
[0m17:17:19.094389 [debug] [MainThread]: On master: ROLLBACK
[0m17:17:19.096389 [debug] [MainThread]: On master: Close
[0m17:17:19.098391 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:17:19.099397 [info ] [MainThread]: 
[0m17:17:19.104794 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m17:17:19.106796 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m17:17:19.106796 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m17:17:19.127815 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m17:17:19.130830 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 17:17:19.107794 => 17:17:19.128805
[0m17:17:19.131796 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m17:17:19.133795 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 17:17:19.132796 => 17:17:19.132796
[0m17:17:19.135797 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m17:17:19.136796 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:17:19.137794 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m17:17:19.138796 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m17:17:19.139795 [debug] [MainThread]: Command end result
[0m17:17:19.151794 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:










CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    referrers AS

    ,
    categories AS (
            SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site, 
            UNION ALL SELECT 'Others'
        ')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        )
        ,
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        )
        ,
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        
        ,
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        )
        ,
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        )
        ,
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		)
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third, 
    
    referrers_second AS

    ,
    categories_second AS (
            SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site, 
            UNION ALL SELECT 'Others'
        ')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        )
        ,
        
        ,
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        )
        ,
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        )
        ,
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		)
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third, 
    
    referrers_third AS

    ,
    categories_third AS (
            SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site, 
            UNION ALL SELECT 'Others'
        ')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        )
        ,
        
        ,
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        )
        ,
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        )
        ,
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third
    
[0m17:17:19.163799 [debug] [MainThread]: Command `dbt compile` succeeded at 17:17:19.163799 after 1.09 seconds
[0m17:17:19.165797 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002545F8D4BF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002545FA94A70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002545FA956A0>]}
[0m17:17:19.167796 [debug] [MainThread]: Flushing usage events
[0m17:20:55.869035 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2BA3A6CF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2BA2B0B90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2BA3A74D0>]}


============================== 17:20:55.874034 | 35574c7a-93bd-40b3-bfff-7bbcc3aa47d0 ==============================
[0m17:20:55.874034 [info ] [MainThread]: Running with dbt=1.7.13
[0m17:20:55.876040 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'send_anonymous_usage_stats': 'True'}
[0m17:20:56.131037 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '35574c7a-93bd-40b3-bfff-7bbcc3aa47d0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2BA3A5CD0>]}
[0m17:20:56.247035 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '35574c7a-93bd-40b3-bfff-7bbcc3aa47d0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2BA2358B0>]}
[0m17:20:56.249036 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m17:20:56.262034 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m17:20:56.368036 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:20:56.370039 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m17:20:56.588081 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '35574c7a-93bd-40b3-bfff-7bbcc3aa47d0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2BA91EC90>]}
[0m17:20:56.603076 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '35574c7a-93bd-40b3-bfff-7bbcc3aa47d0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2BA789490>]}
[0m17:20:56.604075 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m17:20:56.606084 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '35574c7a-93bd-40b3-bfff-7bbcc3aa47d0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2BA3F8E30>]}
[0m17:20:56.608071 [info ] [MainThread]: 
[0m17:20:56.610073 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m17:20:56.612071 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m17:20:56.628072 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:20:56.629072 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m17:20:56.630079 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:20:56.688075 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m17:20:56.688075 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:20:56.689075 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m17:20:56.698071 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m17:20:56.700071 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m17:20:56.701076 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m17:20:56.708072 [debug] [MainThread]: Using postgres connection "master"
[0m17:20:56.708072 [debug] [MainThread]: On master: BEGIN
[0m17:20:56.709073 [debug] [MainThread]: Opening a new connection, currently in state init
[0m17:20:56.757070 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m17:20:56.758075 [debug] [MainThread]: Using postgres connection "master"
[0m17:20:56.758075 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m17:20:56.768069 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m17:20:56.770073 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '35574c7a-93bd-40b3-bfff-7bbcc3aa47d0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2BA78B5C0>]}
[0m17:20:56.771079 [debug] [MainThread]: On master: ROLLBACK
[0m17:20:56.772072 [debug] [MainThread]: On master: Close
[0m17:20:56.773072 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:20:56.775077 [info ] [MainThread]: 
[0m17:20:56.780071 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m17:20:56.782077 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m17:20:56.783084 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m17:20:56.805073 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m17:20:56.807077 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 17:20:56.784074 => 17:20:56.807077
[0m17:20:56.808075 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m17:20:56.809074 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 17:20:56.809074 => 17:20:56.809074
[0m17:20:56.811074 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m17:20:56.813073 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:20:56.815099 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m17:20:56.816073 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m17:20:56.817073 [debug] [MainThread]: Command end result
[0m17:20:56.827074 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:










CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    referrers AS

    ,
    categories AS (
            SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site, 
            UNION ALL SELECT 'Others'
        ')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        )
        ,
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        )
        ,
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        

        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        )
        ,
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        )
        ,
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		)
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third, 
    
    referrers_second AS

    ,
    categories_second AS (
            SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site, 
            UNION ALL SELECT 'Others'
        ')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        )
        ,
        

        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        )
        ,
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        )
        ,
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		)
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third, 
    
    referrers_third AS

    ,
    categories_third AS (
            SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site, 
            UNION ALL SELECT 'Others'
        ')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        )
        ,
        

        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        )
        ,
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        )
        ,
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third
    
[0m17:20:56.847096 [debug] [MainThread]: Command `dbt compile` succeeded at 17:20:56.847096 after 1.18 seconds
[0m17:20:56.849093 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2BA3A74D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2BA3A6CF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2BA159DC0>]}
[0m17:20:56.850096 [debug] [MainThread]: Flushing usage events
[0m18:01:01.022823 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017729C71340>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017729C70230>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017729C714C0>]}


============================== 18:01:01.029826 | b5894dea-cbb1-4d0d-884b-b2ba340005f3 ==============================
[0m18:01:01.029826 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:01:01.031826 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m18:01:01.317821 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'b5894dea-cbb1-4d0d-884b-b2ba340005f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017728EAD160>]}
[0m18:01:01.452820 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'b5894dea-cbb1-4d0d-884b-b2ba340005f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017729C947A0>]}
[0m18:01:01.454827 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:01:01.470822 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:01:01.579824 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:01:01.581826 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m18:01:01.807821 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'b5894dea-cbb1-4d0d-884b-b2ba340005f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001772A1AE7B0>]}
[0m18:01:01.822823 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'b5894dea-cbb1-4d0d-884b-b2ba340005f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001772A019A60>]}
[0m18:01:01.823832 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m18:01:01.824826 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b5894dea-cbb1-4d0d-884b-b2ba340005f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017729EB1B80>]}
[0m18:01:01.828828 [info ] [MainThread]: 
[0m18:01:01.831823 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:01:01.833821 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:01:01.854820 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:01:01.855822 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:01:01.856822 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:01:01.920821 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:01:01.921826 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:01:01.921826 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:01:01.933824 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:01:01.936821 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:01:01.937820 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:01:01.944824 [debug] [MainThread]: Using postgres connection "master"
[0m18:01:01.946822 [debug] [MainThread]: On master: BEGIN
[0m18:01:01.947822 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:01:02.001826 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:01:02.002825 [debug] [MainThread]: Using postgres connection "master"
[0m18:01:02.004826 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:01:02.020823 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:01:02.022825 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b5894dea-cbb1-4d0d-884b-b2ba340005f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001772A019640>]}
[0m18:01:02.023823 [debug] [MainThread]: On master: ROLLBACK
[0m18:01:02.024823 [debug] [MainThread]: On master: Close
[0m18:01:02.026825 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:01:02.028827 [info ] [MainThread]: 
[0m18:01:02.037825 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:01:02.039821 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m18:01:02.041825 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:01:02.071820 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m18:01:02.073822 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 18:01:02.042830 => 18:01:02.072823
[0m18:01:02.074822 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:01:02.075820 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 18:01:02.075820 => 18:01:02.075820
[0m18:01:02.079822 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:01:02.081821 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:01:02.081821 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:01:02.082820 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m18:01:02.083822 [debug] [MainThread]: Command end result
[0m18:01:02.095822 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ','SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site','
        UNION ALL SELECT ''Others''
    )
    
    
    ,
    categories AS (
            categories AS (
            ','SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site', '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        )
        ,
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        )
        ,
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        

        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        )
        ,
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        )
        ,
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		)
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third, 
    
    
    ,
    categories_second AS (
            categories AS (
            ',    SET @categories_sql_first = CONCAT(
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', {{diction[i]}}, ') and siteid = ', site
    , '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        )
        ,
        

        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        )
        ,
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        )
        ,
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		)
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third, 
    
    
    ,
    categories_third AS (
            categories AS (
            ',Tags, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        )
        ,
        

        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        )
        ,
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        )
        ,
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third
    
[0m18:01:02.111825 [debug] [MainThread]: Command `dbt compile` succeeded at 18:01:02.110828 after 1.30 seconds
[0m18:01:02.112851 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017729C53EC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017723595460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001772A15D4C0>]}
[0m18:01:02.115822 [debug] [MainThread]: Flushing usage events
[0m18:03:37.432241 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002748ED97440>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002748ED97980>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002748ED94D70>]}


============================== 18:03:37.437236 | 66b2c726-3348-433f-bef4-c76f13965887 ==============================
[0m18:03:37.437236 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:03:37.439244 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:03:37.701235 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '66b2c726-3348-433f-bef4-c76f13965887', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002748EDE8BC0>]}
[0m18:03:37.820239 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '66b2c726-3348-433f-bef4-c76f13965887', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002748DE3F2C0>]}
[0m18:03:37.822244 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:03:37.839246 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:03:37.943234 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:03:37.944238 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m18:03:38.144235 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '66b2c726-3348-433f-bef4-c76f13965887', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002748F3DA420>]}
[0m18:03:38.158239 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '66b2c726-3348-433f-bef4-c76f13965887', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002748F1C9400>]}
[0m18:03:38.159239 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m18:03:38.161254 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '66b2c726-3348-433f-bef4-c76f13965887', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002748F29EAB0>]}
[0m18:03:38.163241 [info ] [MainThread]: 
[0m18:03:38.165236 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:03:38.167236 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:03:38.184235 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:03:38.185237 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:03:38.186237 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:03:38.246268 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:03:38.247241 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:03:38.247241 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:03:38.259240 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:03:38.261241 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:03:38.263239 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:03:38.273239 [debug] [MainThread]: Using postgres connection "master"
[0m18:03:38.274237 [debug] [MainThread]: On master: BEGIN
[0m18:03:38.275238 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:03:38.437680 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:03:38.438688 [debug] [MainThread]: Using postgres connection "master"
[0m18:03:38.438688 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:03:38.448680 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:03:38.450680 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '66b2c726-3348-433f-bef4-c76f13965887', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002748F1CB3B0>]}
[0m18:03:38.451682 [debug] [MainThread]: On master: ROLLBACK
[0m18:03:38.452680 [debug] [MainThread]: On master: Close
[0m18:03:38.453687 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:03:38.455689 [info ] [MainThread]: 
[0m18:03:38.461681 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:03:38.462696 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m18:03:38.463683 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:03:38.483680 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m18:03:38.484679 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 18:03:38.463683 => 18:03:38.484679
[0m18:03:38.485704 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:03:38.486683 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 18:03:38.486683 => 18:03:38.486683
[0m18:03:38.488683 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:03:38.490680 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:03:38.492683 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:03:38.492683 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m18:03:38.494681 [debug] [MainThread]: Command end result
[0m18:03:38.505681 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ','SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site','
        UNION ALL SELECT ''Others''
    )
    
    
    ,
    categories AS (
            categories AS (
            ',    SET @categories_sql_first = CONCAT(
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', {{diction[i]}}, ') and siteid = ', site
    , '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        )
        ,
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        )
        ,
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        

        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        )
        ,
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        )
        ,
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		)
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third, 
    
    
    ,
    categories_second AS (
            categories AS (
            ',    SET @categories_sql_first = CONCAT(
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', {{diction[i]}}, ') and siteid = ', site
    , '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        )
        ,
        

        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        )
        ,
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        )
        ,
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		)
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third, 
    
    
    ,
    categories_third AS (
            categories AS (
            ',    SET @categories_sql_first = CONCAT(
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', {{diction[i]}}, ') and siteid = ', site
    , '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        )
        ,
        

        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        )
        ,
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        )
        ,
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third
    
[0m18:03:38.521679 [debug] [MainThread]: Command `dbt compile` succeeded at 18:03:38.521679 after 1.30 seconds
[0m18:03:38.523687 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002748ECA3230>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002748ECA1190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002748ECA2300>]}
[0m18:03:38.524682 [debug] [MainThread]: Flushing usage events
[0m18:07:36.103480 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000271CE721400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000271CE720110>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000271CE721340>]}


============================== 18:07:36.110483 | 8b1864df-568f-4e24-a07f-952b81551c0e ==============================
[0m18:07:36.110483 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:07:36.112489 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m18:07:36.401478 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '8b1864df-568f-4e24-a07f-952b81551c0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000271CE720320>]}
[0m18:07:36.533481 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '8b1864df-568f-4e24-a07f-952b81551c0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000271CE778E30>]}
[0m18:07:36.535479 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:07:36.551479 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:07:36.667482 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:07:36.668484 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m18:07:36.893482 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '8b1864df-568f-4e24-a07f-952b81551c0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000271CED75EE0>]}
[0m18:07:36.906485 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '8b1864df-568f-4e24-a07f-952b81551c0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000271CEACBFE0>]}
[0m18:07:36.908484 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m18:07:36.910488 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8b1864df-568f-4e24-a07f-952b81551c0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000271CED0E840>]}
[0m18:07:36.913481 [info ] [MainThread]: 
[0m18:07:36.914482 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:07:36.916483 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:07:36.935481 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:07:36.936480 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:07:36.936480 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:07:36.997485 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:07:36.998483 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:07:36.999482 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:07:37.009481 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:07:37.011483 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:07:37.012480 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:07:37.021482 [debug] [MainThread]: Using postgres connection "master"
[0m18:07:37.022483 [debug] [MainThread]: On master: BEGIN
[0m18:07:37.023481 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:07:37.076480 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:07:37.077483 [debug] [MainThread]: Using postgres connection "master"
[0m18:07:37.078483 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:07:37.096483 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:07:37.099482 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8b1864df-568f-4e24-a07f-952b81551c0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000271CEACAD20>]}
[0m18:07:37.101483 [debug] [MainThread]: On master: ROLLBACK
[0m18:07:37.101483 [debug] [MainThread]: On master: Close
[0m18:07:37.103481 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:07:37.105539 [info ] [MainThread]: 
[0m18:07:37.113480 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:07:37.114482 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m18:07:37.115482 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:07:37.140484 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m18:07:37.145481 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 18:07:37.115482 => 18:07:37.144489
[0m18:07:37.147486 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:07:37.148485 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 18:07:37.148485 => 18:07:37.148485
[0m18:07:37.151482 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:07:37.152479 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:07:37.153482 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:07:37.154480 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m18:07:37.155484 [debug] [MainThread]: Command end result
[0m18:07:37.169481 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ','SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site','
        UNION ALL SELECT ''Others''
    )
    
    
    ,
    categories AS (
            categories AS (
            ',    SET @categories_sql_first = CONCAT(
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site
    , '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        )
        ,
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        )
        ,
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        

        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        )
        ,
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        )
        ,
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		)
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third, 
    
    
    ,
    categories_second AS (
            categories AS (
            ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        )
        ,
        

        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        )
        ,
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        )
        ,
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		)
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third, 
    
    
    ,
    categories_third AS (
            categories AS (
            ',SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        )
        ,
        

        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        )
        ,
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        )
        ,
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third
    
[0m18:07:37.183483 [debug] [MainThread]: Command `dbt compile` succeeded at 18:07:37.183483 after 1.30 seconds
[0m18:07:37.184486 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000271CDC47830>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000271CE721340>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000271CE721460>]}
[0m18:07:37.186489 [debug] [MainThread]: Flushing usage events
[0m18:08:34.742800 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C6903F2A80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C6903F37A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C6903F3EF0>]}


============================== 18:08:34.748789 | d5b1a51f-05d9-4892-87f0-34a1e3cbfe81 ==============================
[0m18:08:34.748789 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:08:34.750793 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m18:08:35.033789 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd5b1a51f-05d9-4892-87f0-34a1e3cbfe81', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C6903D3DA0>]}
[0m18:08:35.168792 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd5b1a51f-05d9-4892-87f0-34a1e3cbfe81', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C68FFF2F30>]}
[0m18:08:35.171790 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:08:35.184793 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:08:35.297932 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:08:35.298935 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m18:08:35.520935 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd5b1a51f-05d9-4892-87f0-34a1e3cbfe81', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C69092E2D0>]}
[0m18:08:35.537937 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd5b1a51f-05d9-4892-87f0-34a1e3cbfe81', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C690799A60>]}
[0m18:08:35.538937 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m18:08:35.540941 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd5b1a51f-05d9-4892-87f0-34a1e3cbfe81', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C6906667B0>]}
[0m18:08:35.542934 [info ] [MainThread]: 
[0m18:08:35.544935 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:08:35.546937 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:08:35.564935 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:08:35.565942 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:08:35.568998 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:08:35.633940 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:08:35.635938 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:08:35.636936 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:08:35.644934 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:08:35.646936 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:08:35.647934 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:08:35.658933 [debug] [MainThread]: Using postgres connection "master"
[0m18:08:35.659936 [debug] [MainThread]: On master: BEGIN
[0m18:08:35.659936 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:08:35.719938 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:08:35.721944 [debug] [MainThread]: Using postgres connection "master"
[0m18:08:35.723938 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:08:35.737935 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:08:35.739936 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd5b1a51f-05d9-4892-87f0-34a1e3cbfe81', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C69079BB30>]}
[0m18:08:35.740938 [debug] [MainThread]: On master: ROLLBACK
[0m18:08:35.741937 [debug] [MainThread]: On master: Close
[0m18:08:35.743935 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:08:35.745946 [info ] [MainThread]: 
[0m18:08:35.754938 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:08:35.756942 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m18:08:35.757936 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:08:35.791939 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m18:08:35.793935 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 18:08:35.757936 => 18:08:35.792935
[0m18:08:35.794947 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:08:35.796937 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 18:08:35.795938 => 18:08:35.795938
[0m18:08:35.798934 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:08:35.800937 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:08:35.801940 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:08:35.802935 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m18:08:35.804935 [debug] [MainThread]: Command end result
[0m18:08:35.814937 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ','SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site','
        UNION ALL SELECT ''Others''
    )
    
    
    ,
    categories AS (
            categories AS (
            ',    SET @categories_sql_first = CONCAT(
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site
    , '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        )
        ,
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        )
        ,
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        

        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        )
        ,
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        )
        ,
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    
    ,
    categories_second AS (
            categories AS (
            ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        )
        ,
        

        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        )
        ,
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        )
        ,
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		), 
    
    
    ,
    categories_third AS (
            categories AS (
            ',SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        )
        ,
        

        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        )
        ,
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        )
        ,
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
    
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third
[0m18:08:35.836938 [debug] [MainThread]: Command `dbt compile` succeeded at 18:08:35.835940 after 1.24 seconds
[0m18:08:35.837943 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C6902AACC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C69098FA10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C690938AA0>]}
[0m18:08:35.839935 [debug] [MainThread]: Flushing usage events
[0m18:25:59.536158 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024547B33050>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024547B33500>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024547B30BC0>]}


============================== 18:25:59.542158 | 79767c7e-f36f-4c27-811f-cdd4aff0b0de ==============================
[0m18:25:59.542158 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:25:59.544174 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:25:59.796157 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '79767c7e-f36f-4c27-811f-cdd4aff0b0de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024547DC9A60>]}
[0m18:25:59.914157 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '79767c7e-f36f-4c27-811f-cdd4aff0b0de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024547B5A720>]}
[0m18:25:59.916158 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:25:59.929158 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:26:00.046159 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:26:00.047159 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m18:26:00.263167 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '79767c7e-f36f-4c27-811f-cdd4aff0b0de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002454803E390>]}
[0m18:26:00.288164 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '79767c7e-f36f-4c27-811f-cdd4aff0b0de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024547F0E180>]}
[0m18:26:00.290178 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m18:26:00.292177 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '79767c7e-f36f-4c27-811f-cdd4aff0b0de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024547E022D0>]}
[0m18:26:00.295159 [info ] [MainThread]: 
[0m18:26:00.298167 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:26:00.301160 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:26:00.317158 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:26:00.319160 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:26:00.319160 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:26:00.375158 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:26:00.376161 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:26:00.377159 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:26:00.385160 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:26:00.388159 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:26:00.389159 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:26:00.396157 [debug] [MainThread]: Using postgres connection "master"
[0m18:26:00.396157 [debug] [MainThread]: On master: BEGIN
[0m18:26:00.397168 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:26:00.446160 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:26:00.447161 [debug] [MainThread]: Using postgres connection "master"
[0m18:26:00.448161 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:26:00.457158 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:26:00.459158 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '79767c7e-f36f-4c27-811f-cdd4aff0b0de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024547F64BC0>]}
[0m18:26:00.460159 [debug] [MainThread]: On master: ROLLBACK
[0m18:26:00.461160 [debug] [MainThread]: On master: Close
[0m18:26:00.463163 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:26:00.464161 [info ] [MainThread]: 
[0m18:26:00.469159 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:26:00.470158 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m18:26:00.471157 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:26:00.491159 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m18:26:00.493161 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 18:26:00.472160 => 18:26:00.493161
[0m18:26:00.495160 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:26:00.496163 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 18:26:00.496163 => 18:26:00.496163
[0m18:26:00.498175 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:26:00.501159 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:26:00.502158 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:26:00.503160 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m18:26:00.504159 [debug] [MainThread]: Command end result
[0m18:26:00.516160 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site',
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
            categories AS (
                SET @categories_sql_first = CONCAT(
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site
    , 
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        )
        ,
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        )
        ,
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        

        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        )
        ,
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    ,
    categories_second AS (
            categories AS (
            'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site, 
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        )
        ,
        

        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        )
        ,
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		), 
    
    ,
    categories_third AS (
            categories AS (
            SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site, 
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        )
        ,
        

        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        )
        ,
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
    
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third
[0m18:26:00.538917 [debug] [MainThread]: Command `dbt compile` succeeded at 18:26:00.538917 after 1.20 seconds
[0m18:26:00.539936 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002454797C5C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024547A8CB60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024547B89BE0>]}
[0m18:26:00.541909 [debug] [MainThread]: Flushing usage events
[0m18:43:54.698455 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015022E13DA0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015022E13D40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015022E12BA0>]}


============================== 18:43:54.704455 | 8fc1c6d0-a98c-4897-bda2-f3bb3fafccbc ==============================
[0m18:43:54.704455 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:43:54.706462 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m18:43:54.965452 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '8fc1c6d0-a98c-4897-bda2-f3bb3fafccbc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015022EF5A30>]}
[0m18:43:55.085453 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '8fc1c6d0-a98c-4897-bda2-f3bb3fafccbc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015022BAD1F0>]}
[0m18:43:55.087455 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:43:55.100454 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:43:55.202453 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:43:55.203456 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m18:43:55.407454 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '8fc1c6d0-a98c-4897-bda2-f3bb3fafccbc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000150233874D0>]}
[0m18:43:55.422457 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '8fc1c6d0-a98c-4897-bda2-f3bb3fafccbc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000150231B65D0>]}
[0m18:43:55.423461 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m18:43:55.425459 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8fc1c6d0-a98c-4897-bda2-f3bb3fafccbc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015022CCB0B0>]}
[0m18:43:55.428461 [info ] [MainThread]: 
[0m18:43:55.430467 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:43:55.432454 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:43:55.449460 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:43:55.450455 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:43:55.450455 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:43:55.507456 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:43:55.508459 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:43:55.509460 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:43:55.518457 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:43:55.520453 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:43:55.521455 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:43:55.528457 [debug] [MainThread]: Using postgres connection "master"
[0m18:43:55.528457 [debug] [MainThread]: On master: BEGIN
[0m18:43:55.529456 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:43:55.578459 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:43:55.578459 [debug] [MainThread]: Using postgres connection "master"
[0m18:43:55.579460 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:43:55.595456 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:43:55.598457 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8fc1c6d0-a98c-4897-bda2-f3bb3fafccbc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015022EB9D60>]}
[0m18:43:55.599456 [debug] [MainThread]: On master: ROLLBACK
[0m18:43:55.600479 [debug] [MainThread]: On master: Close
[0m18:43:55.602457 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:43:55.604474 [info ] [MainThread]: 
[0m18:43:55.609454 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:43:55.612474 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m18:43:55.615457 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:43:55.646456 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m18:43:55.647458 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 18:43:55.616456 => 18:43:55.647458
[0m18:43:55.648457 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:43:55.649456 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 18:43:55.649456 => 18:43:55.649456
[0m18:43:55.651457 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:43:55.653454 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:43:55.653454 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:43:55.654456 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m18:43:55.655454 [debug] [MainThread]: Command end result
[0m18:43:55.667457 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ','SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site','
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
            categories AS (
            ',    SET @categories_sql_first = CONCAT(
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site
    , '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        )
        ,
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        )
        ,
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        

        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        )
        ,
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    ,
    categories_second AS (
            categories AS (
            ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        )
        ,
        

        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        )
        ,
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		), 
    
    ,
    categories_third AS (
            categories AS (
            ',SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        )
        ,
        

        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        )
        ,
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
    
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third
[0m18:43:55.688455 [debug] [MainThread]: Command `dbt compile` succeeded at 18:43:55.688455 after 1.21 seconds
[0m18:43:55.689454 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015022AA7830>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015022E13D40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015022E12BA0>]}
[0m18:43:55.691458 [debug] [MainThread]: Flushing usage events
[0m18:49:22.292957 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC5F6B2390>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC5F6B36E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC5F6B2840>]}


============================== 18:49:22.297961 | f646947c-7f72-48c5-bcb7-067e4e861f3b ==============================
[0m18:49:22.297961 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:49:22.308983 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m18:49:22.558974 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f646947c-7f72-48c5-bcb7-067e4e861f3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC5F6D8E60>]}
[0m18:49:22.679979 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f646947c-7f72-48c5-bcb7-067e4e861f3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC5EBA9880>]}
[0m18:49:22.682045 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:49:22.703998 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:49:22.805999 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:49:22.808001 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m18:49:23.007002 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f646947c-7f72-48c5-bcb7-067e4e861f3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC5FA433E0>]}
[0m18:49:23.022000 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f646947c-7f72-48c5-bcb7-067e4e861f3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC5FB189E0>]}
[0m18:49:23.023006 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m18:49:23.024004 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f646947c-7f72-48c5-bcb7-067e4e861f3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC5FBEF350>]}
[0m18:49:23.026999 [info ] [MainThread]: 
[0m18:49:23.029000 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:49:23.031004 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:49:23.047003 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:49:23.048004 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:49:23.048004 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:49:23.106001 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:49:23.107002 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:49:23.107002 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:49:23.116004 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:49:23.117999 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:49:23.118999 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:49:23.126002 [debug] [MainThread]: Using postgres connection "master"
[0m18:49:23.127004 [debug] [MainThread]: On master: BEGIN
[0m18:49:23.128002 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:49:23.177001 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:49:23.177001 [debug] [MainThread]: Using postgres connection "master"
[0m18:49:23.177998 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:49:23.187998 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:49:23.190004 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f646947c-7f72-48c5-bcb7-067e4e861f3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC5FCEBEF0>]}
[0m18:49:23.191004 [debug] [MainThread]: On master: ROLLBACK
[0m18:49:23.192014 [debug] [MainThread]: On master: Close
[0m18:49:23.194000 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:49:23.196007 [info ] [MainThread]: 
[0m18:49:23.200002 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:49:23.202005 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m18:49:23.202005 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:49:23.223000 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m18:49:23.226016 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 18:49:23.203004 => 18:49:23.225030
[0m18:49:23.228039 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:49:23.229004 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 18:49:23.229004 => 18:49:23.229004
[0m18:49:23.231004 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:49:23.233002 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:49:23.233002 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:49:23.234002 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m18:49:23.235002 [debug] [MainThread]: Command end result
[0m18:49:23.246998 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ','SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site','
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
            categories AS (
            ',    SET @categories_sql_first = CONCAT(
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site
    , '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        )
        ,
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        )
        ,
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        

        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        )
        ,
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		)
        ,, 
    
    ,
    categories_second AS (
            categories AS (
            ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        )
        ,
        

        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        )
        ,
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		)
        ,, 
    
    ,
    categories_third AS (
            categories AS (
            ',SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        )
        ,
        

        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        )
        ,
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
        ,
    
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third
[0m18:49:23.269497 [debug] [MainThread]: Command `dbt compile` succeeded at 18:49:23.269497 after 1.18 seconds
[0m18:49:23.271493 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC59150620>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC59075460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC5EBF6F30>]}
[0m18:49:23.273505 [debug] [MainThread]: Flushing usage events
[0m18:52:30.698616 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229BC991880>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229BC9915B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229BC991970>]}


============================== 18:52:30.703613 | 662f31c1-f38d-427c-b8da-f20009eed87c ==============================
[0m18:52:30.703613 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:52:30.706616 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m18:52:30.956612 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '662f31c1-f38d-427c-b8da-f20009eed87c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229BC389F70>]}
[0m18:52:31.114614 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '662f31c1-f38d-427c-b8da-f20009eed87c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229BC3DE5A0>]}
[0m18:52:31.115618 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:52:31.130616 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:52:31.223611 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m18:52:31.224614 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m18:52:31.231612 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '662f31c1-f38d-427c-b8da-f20009eed87c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229BCB5F710>]}
[0m18:52:31.246616 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '662f31c1-f38d-427c-b8da-f20009eed87c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229BCDD9130>]}
[0m18:52:31.247614 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m18:52:31.249624 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '662f31c1-f38d-427c-b8da-f20009eed87c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229BC9E8CB0>]}
[0m18:52:31.251617 [info ] [MainThread]: 
[0m18:52:31.253614 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:52:31.255614 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:52:31.271612 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:52:31.272614 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:52:31.273618 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:52:31.330614 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:52:31.331615 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:52:31.332614 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:52:31.340613 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:52:31.342616 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:52:31.343615 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:52:31.350612 [debug] [MainThread]: Using postgres connection "master"
[0m18:52:31.351615 [debug] [MainThread]: On master: BEGIN
[0m18:52:31.352617 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:52:31.400616 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:52:31.401616 [debug] [MainThread]: Using postgres connection "master"
[0m18:52:31.402622 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:52:31.413615 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:52:31.415615 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '662f31c1-f38d-427c-b8da-f20009eed87c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229BCD8C1A0>]}
[0m18:52:31.416614 [debug] [MainThread]: On master: ROLLBACK
[0m18:52:31.417614 [debug] [MainThread]: On master: Close
[0m18:52:31.419614 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:52:31.420650 [info ] [MainThread]: 
[0m18:52:31.434035 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:52:31.436039 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m18:52:31.436039 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:52:31.459035 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m18:52:31.461049 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 18:52:31.437036 => 18:52:31.461049
[0m18:52:31.462040 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:52:31.463041 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 18:52:31.463041 => 18:52:31.463041
[0m18:52:31.465039 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:52:31.466037 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:52:31.467037 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:52:31.468038 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m18:52:31.469039 [debug] [MainThread]: Command end result
[0m18:52:31.481039 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ','SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site','
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
            categories AS (
            ',    SET @categories_sql_first = CONCAT(
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site
    , '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        )
        ,
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        )
        ,
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        

        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        )
        ,
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		)
        ,, 
    
    ,
    categories_second AS (
            categories AS (
            ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        )
        ,
        

        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        )
        ,
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		)
        ,, 
    
    ,
    categories_third AS (
            categories AS (
            ',SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        )
        ,
        

        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        )
        ,
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
        ,
    
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third
[0m18:52:31.495040 [debug] [MainThread]: Command `dbt compile` succeeded at 18:52:31.495040 after 0.99 seconds
[0m18:52:31.497039 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229BBED69F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229BC7DC6E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229BBF051C0>]}
[0m18:52:31.498039 [debug] [MainThread]: Flushing usage events
[0m18:54:17.692567 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DA5BA19D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DA5BA1850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DA5BA1760>]}


============================== 18:54:17.698565 | ada7acc8-658a-497b-ba19-16af745b3460 ==============================
[0m18:54:17.698565 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:54:17.700579 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:54:17.955566 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ada7acc8-658a-497b-ba19-16af745b3460', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DA5BA3200>]}
[0m18:54:18.072568 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ada7acc8-658a-497b-ba19-16af745b3460', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DA5A7D4F0>]}
[0m18:54:18.074570 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:54:18.090569 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:54:18.172567 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:54:18.173569 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m18:54:18.372568 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ada7acc8-658a-497b-ba19-16af745b3460', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DA61F9D30>]}
[0m18:54:18.386570 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ada7acc8-658a-497b-ba19-16af745b3460', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DA5FE9A60>]}
[0m18:54:18.388574 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m18:54:18.389573 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ada7acc8-658a-497b-ba19-16af745b3460', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DA5E867B0>]}
[0m18:54:18.392567 [info ] [MainThread]: 
[0m18:54:18.393567 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:54:18.395568 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:54:18.412568 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:54:18.413570 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:54:18.413570 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:54:18.472578 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:54:18.473572 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:54:18.473572 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:54:18.482567 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:54:18.484567 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:54:18.485568 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:54:18.493567 [debug] [MainThread]: Using postgres connection "master"
[0m18:54:18.494568 [debug] [MainThread]: On master: BEGIN
[0m18:54:18.495571 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:54:18.543571 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:54:18.543571 [debug] [MainThread]: Using postgres connection "master"
[0m18:54:18.544573 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:54:18.561567 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:54:18.563570 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ada7acc8-658a-497b-ba19-16af745b3460', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DA5FEBFB0>]}
[0m18:54:18.564570 [debug] [MainThread]: On master: ROLLBACK
[0m18:54:18.565573 [debug] [MainThread]: On master: Close
[0m18:54:18.567573 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:54:18.569577 [info ] [MainThread]: 
[0m18:54:18.575570 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:54:18.576571 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m18:54:18.577571 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:54:18.604574 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m18:54:18.606572 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 18:54:18.578568 => 18:54:18.606572
[0m18:54:18.607571 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:54:18.609570 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 18:54:18.608570 => 18:54:18.608570
[0m18:54:18.611569 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:54:18.613568 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:54:18.614570 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:54:18.614570 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m18:54:18.615569 [debug] [MainThread]: Command end result
[0m18:54:18.627570 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ','SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site','
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
        categories AS (
            ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site
    , '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        )
        ,
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        )
        ,
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        

        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        )
        ,
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		)
        ,, 
    
    ,
    categories_second AS (
        categories AS (
            ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        )
        ,
        

        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        )
        ,
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		)
        ,, 
    
    ,
    categories_third AS (
        categories AS (
            ',SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        )
        ,
        

        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        )
        ,
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
        ,
    
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third
[0m18:54:18.641570 [debug] [MainThread]: Command `dbt compile` succeeded at 18:54:18.641570 after 1.15 seconds
[0m18:54:18.643571 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DA5BA3C80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DA5BA19D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DA5BA1850>]}
[0m18:54:18.644571 [debug] [MainThread]: Flushing usage events
[0m19:00:21.330041 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021C84E233E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021C84E234A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021C84E22750>]}


============================== 19:00:21.336039 | ba73da88-af06-4d44-81d4-d13d2cf2a1fe ==============================
[0m19:00:21.336039 [info ] [MainThread]: Running with dbt=1.7.13
[0m19:00:21.338068 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m19:00:21.591039 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ba73da88-af06-4d44-81d4-d13d2cf2a1fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021C84E788C0>]}
[0m19:00:21.706040 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ba73da88-af06-4d44-81d4-d13d2cf2a1fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021C84E02BD0>]}
[0m19:00:21.708046 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m19:00:21.722038 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m19:00:21.824037 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:00:21.825039 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m19:00:22.030039 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ba73da88-af06-4d44-81d4-d13d2cf2a1fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021C85449FA0>]}
[0m19:00:22.045048 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ba73da88-af06-4d44-81d4-d13d2cf2a1fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021C85238140>]}
[0m19:00:22.046046 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m19:00:22.048051 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ba73da88-af06-4d44-81d4-d13d2cf2a1fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021C84818980>]}
[0m19:00:22.050043 [info ] [MainThread]: 
[0m19:00:22.052043 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m19:00:22.054040 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m19:00:22.070041 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m19:00:22.071041 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m19:00:22.071041 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:00:22.132039 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m19:00:22.133045 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m19:00:22.134040 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m19:00:22.142043 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m19:00:22.144042 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m19:00:22.145041 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m19:00:22.154040 [debug] [MainThread]: Using postgres connection "master"
[0m19:00:22.155043 [debug] [MainThread]: On master: BEGIN
[0m19:00:22.155043 [debug] [MainThread]: Opening a new connection, currently in state init
[0m19:00:22.204041 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m19:00:22.205047 [debug] [MainThread]: Using postgres connection "master"
[0m19:00:22.206045 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m19:00:22.216040 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m19:00:22.218041 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ba73da88-af06-4d44-81d4-d13d2cf2a1fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021C8523A2A0>]}
[0m19:00:22.219041 [debug] [MainThread]: On master: ROLLBACK
[0m19:00:22.219041 [debug] [MainThread]: On master: Close
[0m19:00:22.221044 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m19:00:22.223059 [info ] [MainThread]: 
[0m19:00:22.227041 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m19:00:22.229041 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m19:00:22.230041 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m19:00:22.250039 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m19:00:22.252045 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 19:00:22.230041 => 19:00:22.251042
[0m19:00:22.253049 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m19:00:22.254043 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 19:00:22.253049 => 19:00:22.253049
[0m19:00:22.255046 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m19:00:22.257040 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:00:22.258040 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m19:00:22.258040 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m19:00:22.259042 [debug] [MainThread]: Command end result
[0m19:00:22.272050 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ','SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site','
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
        categories AS (
            ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site
    , '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        )
        ,
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        )
        ,
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        

        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        )
        ,
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    ,
    categories_second AS (
        categories AS (
            ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        )
        ,
        

        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        )
        ,
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		), 
    
    ,
    categories_third AS (
        categories AS (
            ',SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        )
        ,
        

        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        )
        ,
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
    
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third
[0m19:00:22.292949 [debug] [MainThread]: Command `dbt compile` succeeded at 19:00:22.291948 after 1.15 seconds
[0m19:00:22.293951 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021C84CD9730>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021C84A21DC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021CFE7D5460>]}
[0m19:00:22.295957 [debug] [MainThread]: Flushing usage events
[0m19:02:06.996441 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B8D5FF2A80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B8D5FF2C90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B8D5FF1B50>]}


============================== 19:02:07.002440 | ee3060dc-5ecf-411b-83d0-1b96e185c79c ==============================
[0m19:02:07.002440 [info ] [MainThread]: Running with dbt=1.7.13
[0m19:02:07.004447 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m19:02:07.255442 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ee3060dc-5ecf-411b-83d0-1b96e185c79c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B8D5D1CDA0>]}
[0m19:02:07.376443 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ee3060dc-5ecf-411b-83d0-1b96e185c79c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B8D6048590>]}
[0m19:02:07.378444 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m19:02:07.391443 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m19:02:07.505472 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:02:07.506488 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m19:02:07.704513 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ee3060dc-5ecf-411b-83d0-1b96e185c79c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B8D660EB10>]}
[0m19:02:07.720529 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ee3060dc-5ecf-411b-83d0-1b96e185c79c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B8D6479C10>]}
[0m19:02:07.721522 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m19:02:07.723528 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ee3060dc-5ecf-411b-83d0-1b96e185c79c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B8D6478110>]}
[0m19:02:07.727522 [info ] [MainThread]: 
[0m19:02:07.730519 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m19:02:07.733516 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m19:02:07.749514 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m19:02:07.750516 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m19:02:07.751516 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:02:07.807517 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m19:02:07.807517 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m19:02:07.808515 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m19:02:07.817516 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m19:02:07.819516 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m19:02:07.820515 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m19:02:07.826513 [debug] [MainThread]: Using postgres connection "master"
[0m19:02:07.827515 [debug] [MainThread]: On master: BEGIN
[0m19:02:07.828516 [debug] [MainThread]: Opening a new connection, currently in state init
[0m19:02:07.877515 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m19:02:07.877515 [debug] [MainThread]: Using postgres connection "master"
[0m19:02:07.878515 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m19:02:07.890523 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m19:02:07.894516 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ee3060dc-5ecf-411b-83d0-1b96e185c79c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B8D647BBC0>]}
[0m19:02:07.895520 [debug] [MainThread]: On master: ROLLBACK
[0m19:02:07.897517 [debug] [MainThread]: On master: Close
[0m19:02:07.899521 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m19:02:07.900524 [info ] [MainThread]: 
[0m19:02:07.908516 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m19:02:07.909518 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m19:02:07.911529 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m19:02:07.932516 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m19:02:07.934518 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 19:02:07.911529 => 19:02:07.933516
[0m19:02:07.935517 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m19:02:07.937517 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 19:02:07.936516 => 19:02:07.936516
[0m19:02:07.939519 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m19:02:07.941515 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:02:07.941515 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m19:02:07.943539 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m19:02:07.944518 [debug] [MainThread]: Command end result
[0m19:02:07.955517 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ','SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site','
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
            ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site
    , '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        )
        ,
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        )
        ,
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        

        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        )
        ,
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    ,
    categories_second AS (
            ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        )
        ,
        

        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        )
        ,
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		), 
    
    ,
    categories_third AS (
            ',SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        )
        ,
        

        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        )
        ,
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
    
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third
[0m19:02:07.975515 [debug] [MainThread]: Command `dbt compile` succeeded at 19:02:07.975515 after 1.17 seconds
[0m19:02:07.976517 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B8D5E869F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B8D5FF1B50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B8D5FF1C10>]}
[0m19:02:07.977522 [debug] [MainThread]: Flushing usage events
[0m11:09:50.964376 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000236A7786A20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000236A7786630>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000236A7786F00>]}


============================== 11:09:50.978496 | c26e44e2-53bf-4526-bda1-f9591e114ac2 ==============================
[0m11:09:50.978496 [info ] [MainThread]: Running with dbt=1.7.13
[0m11:09:50.981497 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m11:09:51.544726 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c26e44e2-53bf-4526-bda1-f9591e114ac2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000236A7784770>]}
[0m11:09:51.750734 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c26e44e2-53bf-4526-bda1-f9591e114ac2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000236A77D88C0>]}
[0m11:09:51.756402 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m11:09:51.792405 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m11:09:53.441255 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m11:09:53.444262 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m11:09:53.757136 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c26e44e2-53bf-4526-bda1-f9591e114ac2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000236A7CBC890>]}
[0m11:09:53.798277 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c26e44e2-53bf-4526-bda1-f9591e114ac2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000236A7B7A4E0>]}
[0m11:09:53.800275 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m11:09:53.803278 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c26e44e2-53bf-4526-bda1-f9591e114ac2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000236A7B78200>]}
[0m11:09:53.808364 [info ] [MainThread]: 
[0m11:09:53.811366 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m11:09:53.814467 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m11:09:53.848438 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:09:53.850436 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m11:09:53.852443 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:09:53.976891 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m11:09:53.978525 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:09:53.979881 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m11:09:54.035065 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m11:09:54.040979 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m11:09:54.043883 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m11:09:54.058086 [debug] [MainThread]: Using postgres connection "master"
[0m11:09:54.058086 [debug] [MainThread]: On master: BEGIN
[0m11:09:54.063940 [debug] [MainThread]: Opening a new connection, currently in state init
[0m11:09:54.165566 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m11:09:54.167097 [debug] [MainThread]: Using postgres connection "master"
[0m11:09:54.168280 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m11:09:54.193404 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m11:09:54.197650 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c26e44e2-53bf-4526-bda1-f9591e114ac2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000236A7B7BA10>]}
[0m11:09:54.198646 [debug] [MainThread]: On master: ROLLBACK
[0m11:09:54.201399 [debug] [MainThread]: On master: Close
[0m11:09:54.204317 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:09:54.207360 [info ] [MainThread]: 
[0m11:09:54.217619 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m11:09:54.223301 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m11:09:54.224963 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m11:09:54.269423 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m11:09:54.272419 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 11:09:54.226096 => 11:09:54.271425
[0m11:09:54.274504 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m11:09:54.277455 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 11:09:54.275427 => 11:09:54.275427
[0m11:09:54.280455 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m11:09:54.284450 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:09:54.286349 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m11:09:54.288007 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m11:09:54.290268 [debug] [MainThread]: Command end result
[0m11:09:54.313643 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
            ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site
    , '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        )
        ,
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        )
        ,
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        

        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        )
        ,
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    ,
    categories_second AS (
            ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        )
        ,
        

        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        )
        ,
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		), 
    
    ,
    categories_third AS (
            ',SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        )
        ,
        

        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        )
        ,
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
    
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third
[0m11:09:54.342752 [debug] [MainThread]: Command `dbt compile` succeeded at 11:09:54.341752 after 3.81 seconds
[0m11:09:54.345756 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000236A1222870>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000236A7763F20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000236A7763FE0>]}
[0m11:09:54.349350 [debug] [MainThread]: Flushing usage events
[0m11:11:13.494233 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018D63156A20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018D631576E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018D63157D40>]}


============================== 11:11:13.506260 | e4abb7dd-c374-4b78-bc4d-176c70b084ec ==============================
[0m11:11:13.506260 [info ] [MainThread]: Running with dbt=1.7.13
[0m11:11:13.509306 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m11:11:13.952307 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e4abb7dd-c374-4b78-bc4d-176c70b084ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018D62F38410>]}
[0m11:11:14.190031 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e4abb7dd-c374-4b78-bc4d-176c70b084ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018D62F9EC60>]}
[0m11:11:14.193029 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m11:11:14.218614 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m11:11:14.402005 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m11:11:14.403451 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m11:11:14.652582 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e4abb7dd-c374-4b78-bc4d-176c70b084ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018D6367EFC0>]}
[0m11:11:14.673442 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e4abb7dd-c374-4b78-bc4d-176c70b084ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018D63578590>]}
[0m11:11:14.675030 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m11:11:14.677084 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e4abb7dd-c374-4b78-bc4d-176c70b084ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018D63750D70>]}
[0m11:11:14.680084 [info ] [MainThread]: 
[0m11:11:14.682083 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m11:11:14.685197 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m11:11:14.707259 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:11:14.708672 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m11:11:14.709256 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:11:14.780326 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m11:11:14.781323 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:11:14.782324 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m11:11:14.792392 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m11:11:14.795445 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m11:11:14.796647 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m11:11:14.807139 [debug] [MainThread]: Using postgres connection "master"
[0m11:11:14.808142 [debug] [MainThread]: On master: BEGIN
[0m11:11:14.809139 [debug] [MainThread]: Opening a new connection, currently in state init
[0m11:11:14.877699 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m11:11:14.878688 [debug] [MainThread]: Using postgres connection "master"
[0m11:11:14.880685 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m11:11:14.895701 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m11:11:14.899737 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e4abb7dd-c374-4b78-bc4d-176c70b084ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018D631560C0>]}
[0m11:11:14.900736 [debug] [MainThread]: On master: ROLLBACK
[0m11:11:14.902736 [debug] [MainThread]: On master: Close
[0m11:11:14.904734 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:11:14.907044 [info ] [MainThread]: 
[0m11:11:14.913371 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m11:11:14.915370 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m11:11:14.917954 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m11:11:14.954985 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m11:11:14.958134 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 11:11:14.918948 => 11:11:14.957113
[0m11:11:14.960010 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m11:11:14.962017 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 11:11:14.961011 => 11:11:14.961011
[0m11:11:14.964088 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m11:11:14.966011 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:11:14.968044 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m11:11:14.969014 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m11:11:14.971019 [debug] [MainThread]: Command end result
[0m11:11:14.991236 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site,
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
            ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site
    , '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        )
        ,
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        )
        ,
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        

        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        )
        ,
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    ,
    categories_second AS (
            ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        )
        ,
        

        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        )
        ,
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		), 
    
    ,
    categories_third AS (
            ',SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        )
        ,
        

        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        )
        ,
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
    
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third
[0m11:11:15.023039 [debug] [MainThread]: Command `dbt compile` succeeded at 11:11:15.022582 after 1.83 seconds
[0m11:11:15.024987 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018D631559D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018D631576E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018D63157D40>]}
[0m11:11:15.027053 [debug] [MainThread]: Flushing usage events
[0m11:12:40.193476 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF51B323C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF51B32CF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF51B33A10>]}


============================== 11:12:40.205561 | 13d535d8-b3b9-42e3-b36a-1418464290f6 ==============================
[0m11:12:40.205561 [info ] [MainThread]: Running with dbt=1.7.13
[0m11:12:40.208704 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m11:12:40.632042 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '13d535d8-b3b9-42e3-b36a-1418464290f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF51B882F0>]}
[0m11:12:40.778318 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '13d535d8-b3b9-42e3-b36a-1418464290f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF519EB0E0>]}
[0m11:12:40.780329 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m11:12:40.798273 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m11:12:40.958379 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m11:12:40.960388 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m11:12:41.308775 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '13d535d8-b3b9-42e3-b36a-1418464290f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF5202DB50>]}
[0m11:12:41.328788 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '13d535d8-b3b9-42e3-b36a-1418464290f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF51EE9880>]}
[0m11:12:41.330789 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m11:12:41.332994 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '13d535d8-b3b9-42e3-b36a-1418464290f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF5207EAB0>]}
[0m11:12:41.337139 [info ] [MainThread]: 
[0m11:12:41.339222 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m11:12:41.342957 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m11:12:41.368397 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:12:41.368397 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m11:12:41.372238 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:12:41.472089 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m11:12:41.473926 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:12:41.475507 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m11:12:41.488590 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m11:12:41.488590 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m11:12:41.494475 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m11:12:41.506466 [debug] [MainThread]: Using postgres connection "master"
[0m11:12:41.508474 [debug] [MainThread]: On master: BEGIN
[0m11:12:41.508474 [debug] [MainThread]: Opening a new connection, currently in state init
[0m11:12:41.591580 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m11:12:41.593067 [debug] [MainThread]: Using postgres connection "master"
[0m11:12:41.594271 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m11:12:41.608498 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m11:12:41.614370 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '13d535d8-b3b9-42e3-b36a-1418464290f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF51EEB6B0>]}
[0m11:12:41.615367 [debug] [MainThread]: On master: ROLLBACK
[0m11:12:41.616431 [debug] [MainThread]: On master: Close
[0m11:12:41.619804 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:12:41.621894 [info ] [MainThread]: 
[0m11:12:41.630090 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m11:12:41.632097 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m11:12:41.632097 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m11:12:41.673472 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m11:12:41.677049 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 11:12:41.632097 => 11:12:41.675522
[0m11:12:41.678494 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m11:12:41.679494 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 11:12:41.679494 => 11:12:41.679494
[0m11:12:41.683403 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m11:12:41.685711 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:12:41.686800 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m11:12:41.688924 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m11:12:41.691201 [debug] [MainThread]: Command end result
[0m11:12:41.708475 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site,
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
            ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site
    , '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        )
        ,
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        )
        ,
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        

        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        )
        ,
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		'), 
    
    ,
    categories_second AS (
            ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        )
        ,
        

        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        )
        ,
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		'), 
    
    ,
    categories_third AS (
            ',SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        )
        ,
        

        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        )
        ,
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		')
    
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third
[0m11:12:41.740182 [debug] [MainThread]: Command `dbt compile` succeeded at 11:12:41.740182 after 1.83 seconds
[0m11:12:41.745838 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF50A28410>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF4EC35370>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF5207EB70>]}
[0m11:12:41.747772 [debug] [MainThread]: Flushing usage events
[0m13:06:32.375468 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154A8AC3860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154A8AC3770>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154A8AC30B0>]}


============================== 13:06:32.384030 | 94b72043-c2cb-4c5b-8722-95bbdafd6e25 ==============================
[0m13:06:32.384030 [info ] [MainThread]: Running with dbt=1.7.13
[0m13:06:32.384030 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'send_anonymous_usage_stats': 'True'}
[0m13:06:32.699123 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '94b72043-c2cb-4c5b-8722-95bbdafd6e25', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154A7E57D70>]}
[0m13:06:32.815513 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '94b72043-c2cb-4c5b-8722-95bbdafd6e25', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154A8B19A00>]}
[0m13:06:32.815513 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m13:06:32.843888 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m13:06:33.479244 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m13:06:33.480257 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m13:06:33.686636 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '94b72043-c2cb-4c5b-8722-95bbdafd6e25', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154A908E7B0>]}
[0m13:06:33.703454 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '94b72043-c2cb-4c5b-8722-95bbdafd6e25', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154A8EF9B20>]}
[0m13:06:33.704693 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m13:06:33.705689 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '94b72043-c2cb-4c5b-8722-95bbdafd6e25', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154A90186E0>]}
[0m13:06:33.708688 [info ] [MainThread]: 
[0m13:06:33.709687 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m13:06:33.712977 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m13:06:33.730053 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m13:06:33.730997 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m13:06:33.733020 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:06:33.802155 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m13:06:33.803157 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m13:06:33.803157 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m13:06:33.835285 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m13:06:33.835285 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m13:06:33.835285 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m13:06:33.844369 [debug] [MainThread]: Using postgres connection "master"
[0m13:06:33.844369 [debug] [MainThread]: On master: BEGIN
[0m13:06:33.844369 [debug] [MainThread]: Opening a new connection, currently in state init
[0m13:06:33.901640 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m13:06:33.902643 [debug] [MainThread]: Using postgres connection "master"
[0m13:06:33.903644 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m13:06:33.917162 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m13:06:33.919163 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '94b72043-c2cb-4c5b-8722-95bbdafd6e25', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154A8EA8950>]}
[0m13:06:33.920164 [debug] [MainThread]: On master: ROLLBACK
[0m13:06:33.921165 [debug] [MainThread]: On master: Close
[0m13:06:33.923166 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m13:06:33.925175 [info ] [MainThread]: 
[0m13:06:33.931118 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m13:06:33.932113 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m13:06:33.933114 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m13:06:33.955137 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m13:06:33.957102 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 13:06:33.934115 => 13:06:33.957102
[0m13:06:33.959100 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m13:06:33.960100 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 13:06:33.959100 => 13:06:33.959100
[0m13:06:33.961098 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m13:06:33.964099 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:06:33.965101 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m13:06:33.966097 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m13:06:33.967098 [debug] [MainThread]: Command end result
[0m13:06:33.979138 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ',SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', 'site',,
        'UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
            ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site
    ,
            'UNION ALL SELECT ''Others'')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        ,
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		'), 
    
    ,
    categories_second AS (
            ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site,
            'UNION ALL SELECT ''Others'')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers_second r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        ),
        ,
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		'), 
    
    ,
    categories_third AS (
            ',SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,
            'UNION ALL SELECT ''Others'')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers_third r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        ),
        ,
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		')
    
[0m13:06:33.993785 [debug] [MainThread]: Command `dbt compile` succeeded at 13:06:33.985188 after 1.78 seconds
[0m13:06:33.995854 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154A87969F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154A899CA70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154A899E300>]}
[0m13:06:33.995854 [debug] [MainThread]: Flushing usage events
[0m13:09:22.794417 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CFA886F90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CFA886C90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CFA8869F0>]}


============================== 13:09:22.795346 | f4b2d523-992b-4575-9ffe-5cb0dd1230e7 ==============================
[0m13:09:22.795346 [info ] [MainThread]: Running with dbt=1.7.13
[0m13:09:22.795346 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m13:09:23.063943 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f4b2d523-992b-4575-9ffe-5cb0dd1230e7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CFAB6E480>]}
[0m13:09:23.210092 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f4b2d523-992b-4575-9ffe-5cb0dd1230e7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CFA8AE2D0>]}
[0m13:09:23.212102 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m13:09:23.225116 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m13:09:23.333989 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m13:09:23.333989 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m13:09:23.545557 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f4b2d523-992b-4575-9ffe-5cb0dd1230e7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CFAC35BE0>]}
[0m13:09:23.561445 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f4b2d523-992b-4575-9ffe-5cb0dd1230e7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CFACC0CE0>]}
[0m13:09:23.562463 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m13:09:23.563503 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f4b2d523-992b-4575-9ffe-5cb0dd1230e7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CFAE9EAB0>]}
[0m13:09:23.565593 [info ] [MainThread]: 
[0m13:09:23.567645 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m13:09:23.567645 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m13:09:23.587906 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m13:09:23.588907 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m13:09:23.589907 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:09:23.645055 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m13:09:23.645055 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m13:09:23.645055 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m13:09:23.654120 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m13:09:23.654120 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m13:09:23.654120 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m13:09:23.665171 [debug] [MainThread]: Using postgres connection "master"
[0m13:09:23.665171 [debug] [MainThread]: On master: BEGIN
[0m13:09:23.665171 [debug] [MainThread]: Opening a new connection, currently in state init
[0m13:09:23.724096 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m13:09:23.725099 [debug] [MainThread]: Using postgres connection "master"
[0m13:09:23.725099 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m13:09:23.735100 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m13:09:23.737096 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f4b2d523-992b-4575-9ffe-5cb0dd1230e7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CFACC2870>]}
[0m13:09:23.738099 [debug] [MainThread]: On master: ROLLBACK
[0m13:09:23.739097 [debug] [MainThread]: On master: Close
[0m13:09:23.741097 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m13:09:23.743155 [info ] [MainThread]: 
[0m13:09:23.748116 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m13:09:23.750115 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m13:09:23.750115 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m13:09:23.773113 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m13:09:23.775724 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 13:09:23.751113 => 13:09:23.774719
[0m13:09:23.776717 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m13:09:23.778721 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 13:09:23.777714 => 13:09:23.777714
[0m13:09:23.780716 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m13:09:23.782716 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:09:23.783717 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m13:09:23.783717 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m13:09:23.785798 [debug] [MainThread]: Command end result
[0m13:09:23.797058 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ',SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', 'site',,
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
            ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site
    ,
            UNION ALL SELECT ''Others'')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        ,
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		'), 
    
    ,
    categories_second AS (
            ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site,
            UNION ALL SELECT ''Others'')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers_second r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        ),
        ,
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		'), 
    
    ,
    categories_third AS (
            ',SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,
            UNION ALL SELECT ''Others'')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers_third r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        ),
        ,
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		')
    
[0m13:09:23.810610 [debug] [MainThread]: Command `dbt compile` succeeded at 13:09:23.810610 after 1.23 seconds
[0m13:09:23.811604 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CFA715970>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CFAC58740>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CFA949280>]}
[0m13:09:23.813603 [debug] [MainThread]: Flushing usage events
[0m13:14:43.110714 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000288AD2710D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000288AD273A10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000288AD272E40>]}


============================== 13:14:43.124716 | 504524e0-fe15-44c8-9072-c66b08cc4e7e ==============================
[0m13:14:43.124716 [info ] [MainThread]: Running with dbt=1.7.13
[0m13:14:43.157729 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m13:14:43.995841 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '504524e0-fe15-44c8-9072-c66b08cc4e7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000288AD2C9C10>]}
[0m13:14:44.251713 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '504524e0-fe15-44c8-9072-c66b08cc4e7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000288AD29C710>]}
[0m13:14:44.256703 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m13:14:44.289262 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m13:14:44.565271 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m13:14:44.565271 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m13:14:44.835768 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '504524e0-fe15-44c8-9072-c66b08cc4e7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000288AD29E7B0>]}
[0m13:14:44.853781 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '504524e0-fe15-44c8-9072-c66b08cc4e7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000288AD587890>]}
[0m13:14:44.854781 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m13:14:44.856792 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '504524e0-fe15-44c8-9072-c66b08cc4e7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000288AD585AF0>]}
[0m13:14:44.861787 [info ] [MainThread]: 
[0m13:14:44.863779 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m13:14:44.868665 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m13:14:44.885883 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m13:14:44.886719 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m13:14:44.887719 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:14:44.947487 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m13:14:44.948487 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m13:14:44.948487 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m13:14:44.957488 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m13:14:44.959487 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m13:14:44.960486 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m13:14:44.967660 [debug] [MainThread]: Using postgres connection "master"
[0m13:14:44.968662 [debug] [MainThread]: On master: BEGIN
[0m13:14:44.969661 [debug] [MainThread]: Opening a new connection, currently in state init
[0m13:14:45.013993 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m13:14:45.013993 [debug] [MainThread]: Using postgres connection "master"
[0m13:14:45.013993 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m13:14:45.025449 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m13:14:45.033999 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '504524e0-fe15-44c8-9072-c66b08cc4e7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000288AD7F3C80>]}
[0m13:14:45.033999 [debug] [MainThread]: On master: ROLLBACK
[0m13:14:45.033999 [debug] [MainThread]: On master: Close
[0m13:14:45.033999 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m13:14:45.033999 [info ] [MainThread]: 
[0m13:14:45.044311 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m13:14:45.044311 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m13:14:45.044311 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m13:14:45.074585 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m13:14:45.076583 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 13:14:45.044311 => 13:14:45.075580
[0m13:14:45.077584 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m13:14:45.078586 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 13:14:45.078586 => 13:14:45.078586
[0m13:14:45.082583 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m13:14:45.084059 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:14:45.085028 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m13:14:45.086029 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m13:14:45.086952 [debug] [MainThread]: Command end result
[0m13:14:45.098959 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
            ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
            UNION ALL SELECT ''Others'')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        ,
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		'), 
    
    ,
    categories_second AS (
            ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
            UNION ALL SELECT ''Others'')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers_second r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        ),
        ,
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		'), 
    
    ,
    categories_third AS (
            ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
            UNION ALL SELECT ''Others'')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers_third r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        ),
        ,
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		')
    
[0m13:14:45.113203 [debug] [MainThread]: Command `dbt compile` succeeded at 13:14:45.112208 after 2.31 seconds
[0m13:14:45.115202 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000288AC3ED280>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000288AD104C20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000288A6BB5460>]}
[0m13:14:45.116222 [debug] [MainThread]: Flushing usage events
[0m13:51:57.024410 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BA641760F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BA64055190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BA641777A0>]}


============================== 13:51:57.024410 | 27240f27-6c7a-4ab8-b482-9e81f5ff192c ==============================
[0m13:51:57.024410 [info ] [MainThread]: Running with dbt=1.7.13
[0m13:51:57.024410 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m13:51:57.348663 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '27240f27-6c7a-4ab8-b482-9e81f5ff192c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BA641759A0>]}
[0m13:51:57.467664 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '27240f27-6c7a-4ab8-b482-9e81f5ff192c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BA640AC170>]}
[0m13:51:57.469667 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m13:51:57.484668 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m13:51:57.609848 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m13:51:57.609848 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m13:51:57.808936 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '27240f27-6c7a-4ab8-b482-9e81f5ff192c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BA64658E90>]}
[0m13:51:57.808936 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '27240f27-6c7a-4ab8-b482-9e81f5ff192c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BA644BC050>]}
[0m13:51:57.824569 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m13:51:57.824569 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '27240f27-6c7a-4ab8-b482-9e81f5ff192c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BA6423AA50>]}
[0m13:51:57.824569 [info ] [MainThread]: 
[0m13:51:57.824569 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m13:51:57.824569 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m13:51:57.840199 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m13:51:57.840199 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m13:51:57.840199 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:51:57.908721 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m13:51:57.908721 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m13:51:57.908721 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m13:51:57.957132 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m13:51:57.960137 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m13:51:57.962138 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m13:51:57.971135 [debug] [MainThread]: Using postgres connection "master"
[0m13:51:57.971135 [debug] [MainThread]: On master: BEGIN
[0m13:51:57.972136 [debug] [MainThread]: Opening a new connection, currently in state init
[0m13:51:58.024136 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m13:51:58.024136 [debug] [MainThread]: Using postgres connection "master"
[0m13:51:58.026138 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m13:51:58.040505 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m13:51:58.042505 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '27240f27-6c7a-4ab8-b482-9e81f5ff192c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BA644BF440>]}
[0m13:51:58.043505 [debug] [MainThread]: On master: ROLLBACK
[0m13:51:58.043505 [debug] [MainThread]: On master: Close
[0m13:51:58.045520 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m13:51:58.047515 [info ] [MainThread]: 
[0m13:51:58.053505 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m13:51:58.054505 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m13:51:58.055507 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m13:51:58.077504 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m13:51:58.079511 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 13:51:58.056504 => 13:51:58.078504
[0m13:51:58.080508 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m13:51:58.081507 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 13:51:58.080508 => 13:51:58.080508
[0m13:51:58.083509 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m13:51:58.085508 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:51:58.086507 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m13:51:58.087517 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m13:51:58.088507 [debug] [MainThread]: Command end result
[0m13:51:58.102506 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
            ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
            UNION ALL SELECT ''Others'')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        ,
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    ,
    categories_second AS (
            ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
            UNION ALL SELECT ''Others'')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers_second r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        ),
        ,
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		), 
    
    ,
    categories_third AS (
            ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
            UNION ALL SELECT ''Others'')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers_third r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        ),
        ,
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
    
[0m13:51:58.117563 [debug] [MainThread]: Command `dbt compile` succeeded at 13:51:58.117563 after 1.29 seconds
[0m13:51:58.118564 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BA636E7830>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BA64153EC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BA63B68BC0>]}
[0m13:51:58.119557 [debug] [MainThread]: Flushing usage events
[0m13:57:16.822966 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E31A2747D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E31A277590>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E31A277530>]}


============================== 13:57:16.828970 | 4f685b04-a6b5-4cf8-9b8e-9788d661ba53 ==============================
[0m13:57:16.828970 [info ] [MainThread]: Running with dbt=1.7.13
[0m13:57:16.830969 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m13:57:17.105505 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4f685b04-a6b5-4cf8-9b8e-9788d661ba53', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E31A180BC0>]}
[0m13:57:17.223575 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4f685b04-a6b5-4cf8-9b8e-9788d661ba53', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E31A2C9130>]}
[0m13:57:17.225578 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m13:57:17.238589 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m13:57:17.344434 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m13:57:17.344434 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m13:57:17.549573 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4f685b04-a6b5-4cf8-9b8e-9788d661ba53', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E31A5E4890>]}
[0m13:57:17.564577 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4f685b04-a6b5-4cf8-9b8e-9788d661ba53', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E31A6982F0>]}
[0m13:57:17.565576 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m13:57:17.575887 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4f685b04-a6b5-4cf8-9b8e-9788d661ba53', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E319F44770>]}
[0m13:57:17.577881 [info ] [MainThread]: 
[0m13:57:17.579884 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m13:57:17.580882 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m13:57:17.594207 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m13:57:17.594207 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m13:57:17.594207 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:57:17.656821 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m13:57:17.657825 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m13:57:17.658825 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m13:57:17.666822 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m13:57:17.668823 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m13:57:17.669823 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m13:57:17.676825 [debug] [MainThread]: Using postgres connection "master"
[0m13:57:17.677827 [debug] [MainThread]: On master: BEGIN
[0m13:57:17.678826 [debug] [MainThread]: Opening a new connection, currently in state init
[0m13:57:17.728822 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m13:57:17.729975 [debug] [MainThread]: Using postgres connection "master"
[0m13:57:17.729975 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m13:57:17.729975 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m13:57:17.729975 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4f685b04-a6b5-4cf8-9b8e-9788d661ba53', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E31A69BFB0>]}
[0m13:57:17.729975 [debug] [MainThread]: On master: ROLLBACK
[0m13:57:17.729975 [debug] [MainThread]: On master: Close
[0m13:57:17.745608 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m13:57:17.745608 [info ] [MainThread]: 
[0m13:57:17.745608 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m13:57:17.745608 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m13:57:17.745608 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m13:57:17.774769 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m13:57:17.774769 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 13:57:17.745608 => 13:57:17.774769
[0m13:57:17.774769 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m13:57:17.774769 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 13:57:17.774769 => 13:57:17.774769
[0m13:57:17.774769 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m13:57:17.774769 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:57:17.774769 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m13:57:17.774769 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m13:57:17.790842 [debug] [MainThread]: Command end result
[0m13:57:17.802838 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
            ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
            UNION ALL SELECT ''Others'')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    ,
    categories_second AS (
            ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
            UNION ALL SELECT ''Others'')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers_second r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        ),
        
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		), 
    
    ,
    categories_third AS (
            ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
            UNION ALL SELECT ''Others'')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers_third r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        ),
        
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
    
[0m13:57:17.817937 [debug] [MainThread]: Command `dbt compile` succeeded at 13:57:17.817937 after 1.20 seconds
[0m13:57:17.819935 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E319797830>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E31A853D70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E31A5E60F0>]}
[0m13:57:17.820946 [debug] [MainThread]: Flushing usage events
[0m14:00:23.987715 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000253E0997CB0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000253E08A3320>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000253E0994200>]}


============================== 14:00:23.987715 | f4e00f4a-0159-4c75-bb6e-32f75a6c21cd ==============================
[0m14:00:23.987715 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:00:23.987715 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m14:00:24.267554 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f4e00f4a-0159-4c75-bb6e-32f75a6c21cd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000253E0BC74A0>]}
[0m14:00:24.396709 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f4e00f4a-0159-4c75-bb6e-32f75a6c21cd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000253E0C616A0>]}
[0m14:00:24.398716 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:00:24.412351 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:00:24.516837 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m14:00:24.518857 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m14:00:24.721922 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f4e00f4a-0159-4c75-bb6e-32f75a6c21cd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000253E0BC6390>]}
[0m14:00:24.737609 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f4e00f4a-0159-4c75-bb6e-32f75a6c21cd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000253E0DB8740>]}
[0m14:00:24.737609 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m14:00:24.737609 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f4e00f4a-0159-4c75-bb6e-32f75a6c21cd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000253E0F8E840>]}
[0m14:00:24.737609 [info ] [MainThread]: 
[0m14:00:24.737609 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m14:00:24.747944 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m14:00:24.762091 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:00:24.762091 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m14:00:24.767125 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:00:24.829891 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m14:00:24.830895 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:00:24.831894 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m14:00:24.840536 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m14:00:24.842535 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m14:00:24.843549 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m14:00:24.851544 [debug] [MainThread]: Using postgres connection "master"
[0m14:00:24.852545 [debug] [MainThread]: On master: BEGIN
[0m14:00:24.853546 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:00:24.908442 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m14:00:24.909472 [debug] [MainThread]: Using postgres connection "master"
[0m14:00:24.910437 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m14:00:24.920290 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m14:00:24.922295 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f4e00f4a-0159-4c75-bb6e-32f75a6c21cd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000253E0E04050>]}
[0m14:00:24.923293 [debug] [MainThread]: On master: ROLLBACK
[0m14:00:24.924292 [debug] [MainThread]: On master: Close
[0m14:00:24.926294 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:00:24.927298 [info ] [MainThread]: 
[0m14:00:24.932292 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:00:24.933292 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m14:00:24.934295 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:00:24.959588 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m14:00:24.959588 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 14:00:24.934295 => 14:00:24.959588
[0m14:00:24.959588 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:00:24.959588 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 14:00:24.959588 => 14:00:24.959588
[0m14:00:24.967119 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:00:24.967636 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:00:24.967636 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m14:00:24.967636 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m14:00:24.967636 [debug] [MainThread]: Command end result
[0m14:00:24.978912 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    
    categories AS (
            ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
            UNION ALL SELECT ''Others''
            )
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        ),
        
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    
    categories_second AS (
            ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
            UNION ALL SELECT ''Others''
            )
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers_second r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        ),
        
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		), 
    
    
    categories_third AS (
            ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
            UNION ALL SELECT ''Others''
            )
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers_third r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        ),
        
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
    
[0m14:00:25.008757 [debug] [MainThread]: Command `dbt compile` succeeded at 14:00:25.008757 after 1.23 seconds
[0m14:00:25.009762 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000253E077E300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000253E07AE9F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000253DA365460>]}
[0m14:00:25.010758 [debug] [MainThread]: Flushing usage events
[0m14:01:03.991700 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013531A86870>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013531A87980>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013531A849E0>]}


============================== 14:01:03.997698 | 6ff97353-6665-4e10-bbd7-eb001f082f88 ==============================
[0m14:01:03.997698 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:01:03.999706 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'send_anonymous_usage_stats': 'True'}
[0m14:01:04.249222 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6ff97353-6665-4e10-bbd7-eb001f082f88', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000135318A8BC0>]}
[0m14:01:04.368994 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6ff97353-6665-4e10-bbd7-eb001f082f88', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013530B2F080>]}
[0m14:01:04.377582 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:01:04.388834 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:01:04.504931 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m14:01:04.505937 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m14:01:04.707693 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6ff97353-6665-4e10-bbd7-eb001f082f88', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013531B66390>]}
[0m14:01:04.719090 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6ff97353-6665-4e10-bbd7-eb001f082f88', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013531EA98B0>]}
[0m14:01:04.719090 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m14:01:04.719090 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6ff97353-6665-4e10-bbd7-eb001f082f88', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013531682A50>]}
[0m14:01:04.727654 [info ] [MainThread]: 
[0m14:01:04.727654 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m14:01:04.727654 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m14:01:04.751096 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:01:04.752085 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m14:01:04.753110 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:01:04.812074 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m14:01:04.813070 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:01:04.814072 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m14:01:04.823419 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m14:01:04.825418 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m14:01:04.826420 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m14:01:04.833234 [debug] [MainThread]: Using postgres connection "master"
[0m14:01:04.833234 [debug] [MainThread]: On master: BEGIN
[0m14:01:04.834236 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:01:04.883721 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m14:01:04.884722 [debug] [MainThread]: Using postgres connection "master"
[0m14:01:04.884722 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m14:01:04.894722 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m14:01:04.897720 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6ff97353-6665-4e10-bbd7-eb001f082f88', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013531EA92B0>]}
[0m14:01:04.897720 [debug] [MainThread]: On master: ROLLBACK
[0m14:01:04.899718 [debug] [MainThread]: On master: Close
[0m14:01:04.900723 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:01:04.902729 [info ] [MainThread]: 
[0m14:01:04.907722 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:01:04.908718 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m14:01:04.909723 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:01:04.931991 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m14:01:04.934993 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 14:01:04.910729 => 14:01:04.934008
[0m14:01:04.936986 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:01:04.937986 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 14:01:04.936986 => 14:01:04.936986
[0m14:01:04.940003 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:01:04.941005 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:01:04.942003 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m14:01:04.943004 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m14:01:04.944006 [debug] [MainThread]: Command end result
[0m14:01:04.956917 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
            ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
            UNION ALL SELECT ''Others''
            )
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        ),
        
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    
    categories_second AS (
            ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
            UNION ALL SELECT ''Others''
            )
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers_second r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        ),
        
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		), 
    
    
    categories_third AS (
            ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
            UNION ALL SELECT ''Others''
            )
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers_third r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        ),
        
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
    
[0m14:01:04.973623 [debug] [MainThread]: Command `dbt compile` succeeded at 14:01:04.973623 after 1.12 seconds
[0m14:01:04.975622 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000135319936B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000135319915B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013531992060>]}
[0m14:01:04.976624 [debug] [MainThread]: Flushing usage events
[0m14:05:36.308877 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B365E07410>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B365E07500>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B365E070B0>]}


============================== 14:05:36.313871 | 87e3d355-c71a-48c3-b757-f322c199d80e ==============================
[0m14:05:36.313871 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:05:36.316894 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'send_anonymous_usage_stats': 'True'}
[0m14:05:36.571995 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '87e3d355-c71a-48c3-b757-f322c199d80e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B3653276E0>]}
[0m14:05:36.826953 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '87e3d355-c71a-48c3-b757-f322c199d80e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B365D137A0>]}
[0m14:05:36.829058 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:05:36.858041 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:05:37.061072 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m14:05:37.067138 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m14:05:37.412438 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '87e3d355-c71a-48c3-b757-f322c199d80e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B365C4EC90>]}
[0m14:05:37.437188 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '87e3d355-c71a-48c3-b757-f322c199d80e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B3661B94C0>]}
[0m14:05:37.439239 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m14:05:37.439239 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '87e3d355-c71a-48c3-b757-f322c199d80e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B36628E1B0>]}
[0m14:05:37.439239 [info ] [MainThread]: 
[0m14:05:37.447280 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m14:05:37.452314 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m14:05:37.484744 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:05:37.485745 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m14:05:37.486746 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:05:37.558783 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m14:05:37.558783 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:05:37.558783 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m14:05:37.569926 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m14:05:37.569926 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m14:05:37.569926 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m14:05:37.579034 [debug] [MainThread]: Using postgres connection "master"
[0m14:05:37.587758 [debug] [MainThread]: On master: BEGIN
[0m14:05:37.588751 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:05:37.649751 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m14:05:37.650755 [debug] [MainThread]: Using postgres connection "master"
[0m14:05:37.651753 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m14:05:37.664756 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m14:05:37.668760 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '87e3d355-c71a-48c3-b757-f322c199d80e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B3661BB2F0>]}
[0m14:05:37.669749 [debug] [MainThread]: On master: ROLLBACK
[0m14:05:37.671753 [debug] [MainThread]: On master: Close
[0m14:05:37.673752 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:05:37.675760 [info ] [MainThread]: 
[0m14:05:37.684847 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:05:37.686839 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m14:05:37.687836 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:05:37.728848 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m14:05:37.732838 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 14:05:37.688835 => 14:05:37.731834
[0m14:05:37.733834 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:05:37.735837 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 14:05:37.734833 => 14:05:37.734833
[0m14:05:37.738834 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:05:37.740834 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:05:37.741835 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m14:05:37.742836 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m14:05:37.743836 [debug] [MainThread]: Command end result
[0m14:05:37.759834 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
            ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
            UNION ALL SELECT ''Others''
            )
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        ),
        
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    
    categories_second AS (
            ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
            UNION ALL SELECT ''Others''
            )
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers_second r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        ),
        
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		), 
    
    
    categories_third AS (
            ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
            UNION ALL SELECT ''Others''
            )
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers_third r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        ),
        
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
    
[0m14:05:37.775836 [debug] [MainThread]: Command `dbt compile` succeeded at 14:05:37.775836 after 1.68 seconds
[0m14:05:37.776838 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B365BEE9F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B365E07500>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B365E070B0>]}
[0m14:05:37.778870 [debug] [MainThread]: Flushing usage events
[0m14:07:36.011219 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FBA10F3F50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FBA10F3290>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FBA10F2DE0>]}


============================== 14:07:36.017219 | 8eb46a0b-7422-4e80-9648-b14096308e80 ==============================
[0m14:07:36.017219 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:07:36.020224 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m14:07:36.277772 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '8eb46a0b-7422-4e80-9648-b14096308e80', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FBA10D3DA0>]}
[0m14:07:36.404537 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '8eb46a0b-7422-4e80-9648-b14096308e80', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FBA0F1B950>]}
[0m14:07:36.406535 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:07:36.422535 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:07:36.519537 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m14:07:36.520537 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m14:07:36.733834 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '8eb46a0b-7422-4e80-9648-b14096308e80', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FBA16828D0>]}
[0m14:07:36.748185 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '8eb46a0b-7422-4e80-9648-b14096308e80', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FBA14874A0>]}
[0m14:07:36.748185 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m14:07:36.748185 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8eb46a0b-7422-4e80-9648-b14096308e80', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FBA16CDC40>]}
[0m14:07:36.748185 [info ] [MainThread]: 
[0m14:07:36.748185 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m14:07:36.757230 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m14:07:36.772030 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:07:36.772030 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m14:07:36.772030 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:07:36.827597 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m14:07:36.827597 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:07:36.827597 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m14:07:36.838732 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m14:07:36.838732 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m14:07:36.847791 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m14:07:36.847791 [debug] [MainThread]: Using postgres connection "master"
[0m14:07:36.856924 [debug] [MainThread]: On master: BEGIN
[0m14:07:36.857947 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:07:36.907658 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m14:07:36.907658 [debug] [MainThread]: Using postgres connection "master"
[0m14:07:36.907658 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m14:07:36.918123 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m14:07:36.918123 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8eb46a0b-7422-4e80-9648-b14096308e80', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FBA170B920>]}
[0m14:07:36.918123 [debug] [MainThread]: On master: ROLLBACK
[0m14:07:36.918123 [debug] [MainThread]: On master: Close
[0m14:07:36.918123 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:07:36.918123 [info ] [MainThread]: 
[0m14:07:36.929054 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:07:36.929054 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m14:07:36.929054 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:07:36.949653 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m14:07:36.957702 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 14:07:36.929054 => 14:07:36.957178
[0m14:07:36.957702 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:07:36.957702 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 14:07:36.957702 => 14:07:36.957702
[0m14:07:36.957702 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:07:36.957702 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:07:36.957702 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m14:07:36.957702 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m14:07:36.967874 [debug] [MainThread]: Command end result
[0m14:07:36.977558 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13_dbt_test`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
            ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
            UNION ALL SELECT ''Others''
            )
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        ),
        
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    
    categories_second AS (
            ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
            UNION ALL SELECT ''Others''
            )
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers_second r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        ),
        
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		), 
    
    
    categories_third AS (
            ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
            UNION ALL SELECT ''Others''
            )
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers_third r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        ),
        
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
    
[0m14:07:36.988730 [debug] [MainThread]: Command `dbt compile` succeeded at 14:07:36.988730 after 1.18 seconds
[0m14:07:36.994288 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FBA0B27830>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FBA10F3290>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FBA0F869F0>]}
[0m14:07:36.994288 [debug] [MainThread]: Flushing usage events
[0m14:09:29.357896 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002ADC60618E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002ADC6061940>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002ADC6063D70>]}


============================== 14:09:29.363895 | d0307440-60f8-4c41-a643-69dccd0913eb ==============================
[0m14:09:29.363895 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:09:29.365899 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m14:09:29.628606 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd0307440-60f8-4c41-a643-69dccd0913eb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002ADC60B9220>]}
[0m14:09:29.748606 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd0307440-60f8-4c41-a643-69dccd0913eb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002ADC6085430>]}
[0m14:09:29.748606 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:09:29.757760 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:09:29.879604 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m14:09:29.880606 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m14:09:30.086909 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd0307440-60f8-4c41-a643-69dccd0913eb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002ADC664E390>]}
[0m14:09:30.101921 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd0307440-60f8-4c41-a643-69dccd0913eb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002ADC64B9340>]}
[0m14:09:30.102922 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m14:09:30.104189 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd0307440-60f8-4c41-a643-69dccd0913eb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002ADC6407AD0>]}
[0m14:09:30.107227 [info ] [MainThread]: 
[0m14:09:30.108771 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m14:09:30.108771 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m14:09:30.127194 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:09:30.128221 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m14:09:30.129229 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:09:30.189191 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m14:09:30.189191 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:09:30.189191 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m14:09:30.207945 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m14:09:30.207945 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m14:09:30.207945 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m14:09:30.218924 [debug] [MainThread]: Using postgres connection "master"
[0m14:09:30.218924 [debug] [MainThread]: On master: BEGIN
[0m14:09:30.218924 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:09:30.279842 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m14:09:30.280844 [debug] [MainThread]: Using postgres connection "master"
[0m14:09:30.281842 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m14:09:30.292005 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m14:09:30.292005 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd0307440-60f8-4c41-a643-69dccd0913eb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002ADC64642F0>]}
[0m14:09:30.292005 [debug] [MainThread]: On master: ROLLBACK
[0m14:09:30.292005 [debug] [MainThread]: On master: Close
[0m14:09:30.297050 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:09:30.299087 [info ] [MainThread]: 
[0m14:09:30.299087 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:09:30.299087 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m14:09:30.307713 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:09:30.327713 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m14:09:30.327713 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 14:09:30.307713 => 14:09:30.327713
[0m14:09:30.327713 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:09:30.332224 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 14:09:30.332224 => 14:09:30.332224
[0m14:09:30.332224 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:09:30.332224 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:09:30.332224 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m14:09:30.337249 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m14:09:30.339597 [debug] [MainThread]: Command end result
[0m14:09:30.347699 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13_dbt_test`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
        ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
        UNION ALL SELECT ''Others''
        ),
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        ),
        
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    
    categories_second AS (
        ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
        UNION ALL SELECT ''Others''
        ),
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers_second r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        ),
        
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		), 
    
    
    categories_third AS (
        ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
        UNION ALL SELECT ''Others''
        ),
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers_third r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        ),
        
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
    
[0m14:09:30.358720 [debug] [MainThread]: Command `dbt compile` succeeded at 14:09:30.358720 after 1.21 seconds
[0m14:09:30.367302 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002ADC6061940>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002ADC6063D70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002ADC6063BC0>]}
[0m14:09:30.367831 [debug] [MainThread]: Flushing usage events
[0m14:12:33.185712 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011B58073020>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011B57F4D190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011B58073410>]}


============================== 14:12:33.189857 | 8f061a0d-eee0-4b77-a57f-df4241bdb8fa ==============================
[0m14:12:33.189857 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:12:33.189857 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m14:12:33.458859 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '8f061a0d-eee0-4b77-a57f-df4241bdb8fa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011B58341A60>]}
[0m14:12:33.578845 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '8f061a0d-eee0-4b77-a57f-df4241bdb8fa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011B581390D0>]}
[0m14:12:33.578845 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:12:33.587913 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:12:33.698147 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m14:12:33.699148 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m14:12:33.910842 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '8f061a0d-eee0-4b77-a57f-df4241bdb8fa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011B585F4050>]}
[0m14:12:33.924865 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '8f061a0d-eee0-4b77-a57f-df4241bdb8fa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011B584D99A0>]}
[0m14:12:33.925865 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m14:12:33.927974 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8f061a0d-eee0-4b77-a57f-df4241bdb8fa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011B585C1E20>]}
[0m14:12:33.930958 [info ] [MainThread]: 
[0m14:12:33.931958 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m14:12:33.933959 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m14:12:33.950974 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:12:33.951974 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m14:12:33.952974 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:12:34.009717 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m14:12:34.010722 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:12:34.011721 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m14:12:34.020720 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m14:12:34.022718 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m14:12:34.023719 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m14:12:34.029857 [debug] [MainThread]: Using postgres connection "master"
[0m14:12:34.030856 [debug] [MainThread]: On master: BEGIN
[0m14:12:34.030856 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:12:34.078182 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m14:12:34.078182 [debug] [MainThread]: Using postgres connection "master"
[0m14:12:34.078182 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m14:12:34.088728 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m14:12:34.088728 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8f061a0d-eee0-4b77-a57f-df4241bdb8fa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011B584DB380>]}
[0m14:12:34.088728 [debug] [MainThread]: On master: ROLLBACK
[0m14:12:34.097787 [debug] [MainThread]: On master: Close
[0m14:12:34.097787 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:12:34.097787 [info ] [MainThread]: 
[0m14:12:34.097787 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:12:34.107938 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m14:12:34.109023 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:12:34.130844 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m14:12:34.132842 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 14:12:34.109023 => 14:12:34.131846
[0m14:12:34.133842 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:12:34.135842 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 14:12:34.134844 => 14:12:34.134844
[0m14:12:34.137867 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:12:34.139863 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:12:34.141863 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m14:12:34.141863 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m14:12:34.142862 [debug] [MainThread]: Command end result
[0m14:12:34.155840 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13_dbt_test`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
        ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
        UNION ALL SELECT ''Others''
        ),
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        ),
        
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    
    categories_second AS (
        ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
        UNION ALL SELECT ''Others''
        ),
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers_second r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        ),
        
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		), 
    
    
    categories_third AS (
        ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
        UNION ALL SELECT ''Others''
        ),
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers_third r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        ),
        
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
    
[0m14:12:34.176435 [debug] [MainThread]: Command `dbt compile` succeeded at 14:12:34.175434 after 1.19 seconds
[0m14:12:34.177435 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011B57CACA70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011B5809BA40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011B57E0CBF0>]}
[0m14:12:34.179599 [debug] [MainThread]: Flushing usage events
[0m14:16:39.842691 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C2709F3860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C2709F3B00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C2709F30E0>]}


============================== 14:16:39.847689 | 0cd8161a-76c9-461d-826a-5107a5bbd7ad ==============================
[0m14:16:39.847689 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:16:39.849920 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m14:16:40.117912 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0cd8161a-76c9-461d-826a-5107a5bbd7ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C270B57860>]}
[0m14:16:40.240579 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0cd8161a-76c9-461d-826a-5107a5bbd7ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C270A48620>]}
[0m14:16:40.242599 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:16:40.256631 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:16:40.370754 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m14:16:40.371761 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m14:16:40.575092 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0cd8161a-76c9-461d-826a-5107a5bbd7ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C270FAE390>]}
[0m14:16:40.590060 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0cd8161a-76c9-461d-826a-5107a5bbd7ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C270D678C0>]}
[0m14:16:40.591059 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m14:16:40.593062 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0cd8161a-76c9-461d-826a-5107a5bbd7ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C270A9B0E0>]}
[0m14:16:40.595059 [info ] [MainThread]: 
[0m14:16:40.596057 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m14:16:40.598846 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m14:16:40.615861 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:16:40.616869 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m14:16:40.619140 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:16:40.677210 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m14:16:40.677210 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:16:40.678620 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m14:16:40.687581 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m14:16:40.689583 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m14:16:40.690583 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m14:16:40.697584 [debug] [MainThread]: Using postgres connection "master"
[0m14:16:40.697584 [debug] [MainThread]: On master: BEGIN
[0m14:16:40.698957 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:16:40.748790 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m14:16:40.749792 [debug] [MainThread]: Using postgres connection "master"
[0m14:16:40.750789 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m14:16:40.760789 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m14:16:40.762789 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0cd8161a-76c9-461d-826a-5107a5bbd7ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C270FD3C50>]}
[0m14:16:40.763790 [debug] [MainThread]: On master: ROLLBACK
[0m14:16:40.764789 [debug] [MainThread]: On master: Close
[0m14:16:40.765791 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:16:40.768794 [info ] [MainThread]: 
[0m14:16:40.772787 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:16:40.774791 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m14:16:40.774791 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:16:40.795800 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m14:16:40.797797 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 14:16:40.775793 => 14:16:40.796802
[0m14:16:40.798883 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:16:40.800843 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 14:16:40.799800 => 14:16:40.799800
[0m14:16:40.802806 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:16:40.805797 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:16:40.805797 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m14:16:40.806797 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m14:16:40.807798 [debug] [MainThread]: Command end result
[0m14:16:40.820797 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13_dbt_test`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
        ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
        UNION ALL SELECT ''Others''
        ),
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        ),
        
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    
    categories_second AS (
        ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
        UNION ALL SELECT ''Others''
        ),
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        ),
        
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		), 
    
    
    categories_third AS (
        ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
        UNION ALL SELECT ''Others''
        ),
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        ),
        
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
    
[0m14:16:40.841924 [debug] [MainThread]: Command `dbt compile` succeeded at 14:16:40.841924 after 1.21 seconds
[0m14:16:40.843918 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C27092C380>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C270466570>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C2709D3EC0>]}
[0m14:16:40.844919 [debug] [MainThread]: Flushing usage events
[0m14:47:54.201839 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015773036AE0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015773037A70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015773037530>]}


============================== 14:47:54.210519 | 8ca0df5c-67c2-4b77-a821-62c20626945d ==============================
[0m14:47:54.210519 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:47:54.212537 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'send_anonymous_usage_stats': 'True'}
[0m14:47:54.499852 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '8ca0df5c-67c2-4b77-a821-62c20626945d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015772EC5250>]}
[0m14:47:54.621929 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '8ca0df5c-67c2-4b77-a821-62c20626945d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015773088D40>]}
[0m14:47:54.623928 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:47:54.639434 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:47:54.761886 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m14:47:54.763897 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m14:47:55.010643 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '8ca0df5c-67c2-4b77-a821-62c20626945d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015773306210>]}
[0m14:47:55.037172 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '8ca0df5c-67c2-4b77-a821-62c20626945d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000157733D96D0>]}
[0m14:47:55.039172 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m14:47:55.041178 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8ca0df5c-67c2-4b77-a821-62c20626945d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015773088A10>]}
[0m14:47:55.045172 [info ] [MainThread]: 
[0m14:47:55.048172 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m14:47:55.053193 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m14:47:55.082802 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:47:55.083803 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m14:47:55.084842 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:47:55.156799 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m14:47:55.157801 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:47:55.158802 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m14:47:55.188914 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m14:47:55.188914 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m14:47:55.188914 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m14:47:55.197984 [debug] [MainThread]: Using postgres connection "master"
[0m14:47:55.197984 [debug] [MainThread]: On master: BEGIN
[0m14:47:55.197984 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:47:55.257642 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m14:47:55.258643 [debug] [MainThread]: Using postgres connection "master"
[0m14:47:55.258643 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m14:47:55.273180 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m14:47:55.275182 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8ca0df5c-67c2-4b77-a821-62c20626945d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000157731A69C0>]}
[0m14:47:55.276180 [debug] [MainThread]: On master: ROLLBACK
[0m14:47:55.277182 [debug] [MainThread]: On master: Close
[0m14:47:55.278582 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:47:55.280607 [info ] [MainThread]: 
[0m14:47:55.286957 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:47:55.287955 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m14:47:55.288956 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:47:55.310956 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m14:47:55.312957 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 14:47:55.289958 => 14:47:55.311955
[0m14:47:55.313960 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:47:55.314958 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 14:47:55.314958 => 14:47:55.314958
[0m14:47:55.317992 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:47:55.319983 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:47:55.320989 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m14:47:55.320989 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m14:47:55.322985 [debug] [MainThread]: Command end result
[0m14:47:55.334933 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13_dbt_test`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
        ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
        UNION ALL SELECT ''Others''
        ),
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        ),
        
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN userneeds IN (', tag_statement_first, ') THEN  userneeds
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    
    categories_second AS (
        ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
        UNION ALL SELECT ''Others''
        ),
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        ),
        
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		), 
    
    
    categories_third AS (
        ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
        UNION ALL SELECT ''Others''
        ),
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        ),
        
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Tags IN (', tag_statement_third, ') THEN  Tags
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
    
[0m14:47:55.347281 [debug] [MainThread]: Command `dbt compile` succeeded at 14:47:55.346280 after 1.36 seconds
[0m14:47:55.348303 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015772EC56A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015772EC4A70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015773013B60>]}
[0m14:47:55.350831 [debug] [MainThread]: Flushing usage events
[0m17:04:48.558821 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000222F3A27470>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000222F3A26F30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000222F3A26F60>]}


============================== 17:04:48.565804 | 2fac2d97-7d1d-4b06-b794-9a977da1152e ==============================
[0m17:04:48.565804 [info ] [MainThread]: Running with dbt=1.7.13
[0m17:04:48.568806 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'send_anonymous_usage_stats': 'True'}
[0m17:04:48.838338 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2fac2d97-7d1d-4b06-b794-9a977da1152e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000222F3A79070>]}
[0m17:04:48.948635 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2fac2d97-7d1d-4b06-b794-9a977da1152e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000222F346CC20>]}
[0m17:04:48.948635 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m17:04:48.964278 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m17:04:49.091652 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:04:49.092653 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m17:04:49.294749 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2fac2d97-7d1d-4b06-b794-9a977da1152e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000222F3C0C260>]}
[0m17:04:49.309994 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2fac2d97-7d1d-4b06-b794-9a977da1152e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000222F3E49940>]}
[0m17:04:49.311999 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m17:04:49.314001 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2fac2d97-7d1d-4b06-b794-9a977da1152e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000222F3E48140>]}
[0m17:04:49.315993 [info ] [MainThread]: 
[0m17:04:49.317996 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m17:04:49.320006 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m17:04:49.335993 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:04:49.336995 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m17:04:49.338001 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:04:49.411059 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m17:04:49.412066 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:04:49.412066 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m17:04:49.444604 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m17:04:49.446616 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m17:04:49.447903 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m17:04:49.455914 [debug] [MainThread]: Using postgres connection "master"
[0m17:04:49.456915 [debug] [MainThread]: On master: BEGIN
[0m17:04:49.457915 [debug] [MainThread]: Opening a new connection, currently in state init
[0m17:04:49.508916 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m17:04:49.509920 [debug] [MainThread]: Using postgres connection "master"
[0m17:04:49.510917 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m17:04:49.524769 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m17:04:49.526770 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2fac2d97-7d1d-4b06-b794-9a977da1152e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000222F3E4BC50>]}
[0m17:04:49.527769 [debug] [MainThread]: On master: ROLLBACK
[0m17:04:49.528770 [debug] [MainThread]: On master: Close
[0m17:04:49.529772 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:04:49.531777 [info ] [MainThread]: 
[0m17:04:49.537997 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m17:04:49.539005 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m17:04:49.539996 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m17:04:49.560995 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m17:04:49.562998 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 17:04:49.540996 => 17:04:49.561996
[0m17:04:49.563998 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m17:04:49.564996 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 17:04:49.564996 => 17:04:49.564996
[0m17:04:49.566999 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m17:04:49.569003 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:04:49.570007 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m17:04:49.571006 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m17:04:49.571995 [debug] [MainThread]: Command end result
[0m17:04:49.585009 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13_dbt_test`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
        ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
        UNION ALL SELECT ''Others''
        ),
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',order_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        ),
        
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN userneeds IN (', tag_statement_first, ') THEN  userneeds
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN {0: 'userneeds', 1: 'Categories', 2: 'Tags'} IN (',  tag_statement_first, ') THEN userneeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    
    categories_second AS (
        ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
        UNION ALL SELECT ''Others''
        ),
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN {0: 'userneeds', 1: 'Categories', 2: 'Tags'} IN (',  tag_statement_second, ') THEN Categories
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		), 
    
    
    categories_third AS (
        ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
        UNION ALL SELECT ''Others''
        ),
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Tags IN (', tag_statement_third, ') THEN  Tags
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN {0: 'userneeds', 1: 'Categories', 2: 'Tags'} IN (',  tag_statement_third, ') THEN Tags
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
    
[0m17:04:49.598997 [debug] [MainThread]: Command `dbt compile` succeeded at 17:04:49.598997 after 1.24 seconds
[0m17:04:49.600996 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000222F37D9DC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000222F35E9DF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000222ED550620>]}
[0m17:04:49.602004 [debug] [MainThread]: Flushing usage events
[0m17:07:41.876481 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000156B8A57B00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000156B8A57830>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000156B8A57320>]}


============================== 17:07:41.876481 | 1935259b-f38b-4893-ae9c-4128993a02bb ==============================
[0m17:07:41.876481 [info ] [MainThread]: Running with dbt=1.7.13
[0m17:07:41.876481 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m17:07:42.146358 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1935259b-f38b-4893-ae9c-4128993a02bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000156B8AA8650>]}
[0m17:07:42.264359 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1935259b-f38b-4893-ae9c-4128993a02bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000156B8B39EB0>]}
[0m17:07:42.266362 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m17:07:42.278362 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m17:07:42.378851 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:07:42.378851 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m17:07:42.593119 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1935259b-f38b-4893-ae9c-4128993a02bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000156B8D21070>]}
[0m17:07:42.608119 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1935259b-f38b-4893-ae9c-4128993a02bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000156B8DF9820>]}
[0m17:07:42.609118 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m17:07:42.610118 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1935259b-f38b-4893-ae9c-4128993a02bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000156B8ECE570>]}
[0m17:07:42.613117 [info ] [MainThread]: 
[0m17:07:42.615119 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m17:07:42.617123 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m17:07:42.632230 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:07:42.633242 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m17:07:42.633242 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:07:42.687344 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m17:07:42.688342 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:07:42.689344 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m17:07:42.697342 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m17:07:42.699348 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m17:07:42.700347 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m17:07:42.709346 [debug] [MainThread]: Using postgres connection "master"
[0m17:07:42.710342 [debug] [MainThread]: On master: BEGIN
[0m17:07:42.710342 [debug] [MainThread]: Opening a new connection, currently in state init
[0m17:07:42.759349 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m17:07:42.759349 [debug] [MainThread]: Using postgres connection "master"
[0m17:07:42.760344 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m17:07:42.770341 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m17:07:42.772345 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1935259b-f38b-4893-ae9c-4128993a02bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000156B8DFB650>]}
[0m17:07:42.773349 [debug] [MainThread]: On master: ROLLBACK
[0m17:07:42.774369 [debug] [MainThread]: On master: Close
[0m17:07:42.775344 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:07:42.776344 [info ] [MainThread]: 
[0m17:07:42.781342 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m17:07:42.782344 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m17:07:42.783343 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m17:07:42.803343 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m17:07:42.805346 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 17:07:42.783343 => 17:07:42.804344
[0m17:07:42.806344 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m17:07:42.808343 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 17:07:42.807343 => 17:07:42.807343
[0m17:07:42.810346 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m17:07:42.811342 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:07:42.812343 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m17:07:42.813343 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m17:07:42.814343 [debug] [MainThread]: Command end result
[0m17:07:42.826344 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13_dbt_test`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
        ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
        UNION ALL SELECT ''Others''
        ),
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',order_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        ),
        
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN userneeds IN (', tag_statement_first, ') THEN  userneeds
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN userneeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    
    categories_second AS (
        ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
        UNION ALL SELECT ''Others''
        ),
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN Categories IN (',  tag_statement_second, ') THEN Categories
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		), 
    
    
    categories_third AS (
        ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
        UNION ALL SELECT ''Others''
        ),
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Tags IN (', tag_statement_third, ') THEN  Tags
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN Tags IN (',  tag_statement_third, ') THEN Tags
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
    
[0m17:07:42.836343 [debug] [MainThread]: Command `dbt compile` succeeded at 17:07:42.836343 after 1.15 seconds
[0m17:07:42.837341 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000156B886E9F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000156B8A56B10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000156B8A57B00>]}
[0m17:07:42.838343 [debug] [MainThread]: Flushing usage events
[0m17:17:43.429397 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ACE7403770>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ACE7401970>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ACE7403B60>]}


============================== 17:17:43.445026 | 3385e55d-927c-4a59-8533-4e67e26e3b84 ==============================
[0m17:17:43.445026 [info ] [MainThread]: Running with dbt=1.7.13
[0m17:17:43.445026 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:17:43.699080 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3385e55d-927c-4a59-8533-4e67e26e3b84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ACE74AB290>]}
[0m17:17:43.821271 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3385e55d-927c-4a59-8533-4e67e26e3b84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ACE71E8620>]}
[0m17:17:43.823270 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m17:17:43.844278 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m17:17:43.984903 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m17:17:43.984903 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m17:17:44.000532 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3385e55d-927c-4a59-8533-4e67e26e3b84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ACE76ADF10>]}
[0m17:17:44.031784 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3385e55d-927c-4a59-8533-4e67e26e3b84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ACE77E94F0>]}
[0m17:17:44.031784 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m17:17:44.031784 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3385e55d-927c-4a59-8533-4e67e26e3b84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ACE74E6540>]}
[0m17:17:44.031784 [info ] [MainThread]: 
[0m17:17:44.031784 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m17:17:44.051107 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m17:17:44.087099 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:17:44.089095 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m17:17:44.090094 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:17:44.148093 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m17:17:44.149094 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:17:44.150093 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m17:17:44.159093 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m17:17:44.161093 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m17:17:44.162093 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m17:17:44.170092 [debug] [MainThread]: Using postgres connection "master"
[0m17:17:44.171093 [debug] [MainThread]: On master: BEGIN
[0m17:17:44.172094 [debug] [MainThread]: Opening a new connection, currently in state init
[0m17:17:44.221132 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m17:17:44.222096 [debug] [MainThread]: Using postgres connection "master"
[0m17:17:44.223096 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m17:17:44.233091 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m17:17:44.235094 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3385e55d-927c-4a59-8533-4e67e26e3b84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ACE77EB140>]}
[0m17:17:44.236095 [debug] [MainThread]: On master: ROLLBACK
[0m17:17:44.237094 [debug] [MainThread]: On master: Close
[0m17:17:44.239099 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:17:44.240095 [info ] [MainThread]: 
[0m17:17:44.245097 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m17:17:44.247097 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m17:17:44.248101 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m17:17:44.270094 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m17:17:44.272093 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 17:17:44.248101 => 17:17:44.272093
[0m17:17:44.274096 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m17:17:44.275094 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 17:17:44.275094 => 17:17:44.275094
[0m17:17:44.278100 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m17:17:44.280096 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:17:44.281099 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m17:17:44.281099 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m17:17:44.282097 [debug] [MainThread]: Command end result
[0m17:17:44.294095 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13_dbt_test`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
        ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
        UNION ALL SELECT ''Others''
        ),
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',order_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        ),
        
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN userneeds IN (', tag_statement_first, ') THEN  userneeds
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN userneeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    
    categories_second AS (
        ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
        UNION ALL SELECT ''Others''
        ),
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN Categories IN (',  tag_statement_second, ') THEN Categories
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		), 
    
    
    categories_third AS (
        ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
        UNION ALL SELECT ''Others''
        ),
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Tags IN (', tag_statement_third, ') THEN  Tags
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN Tags IN (',  tag_statement_third, ') THEN Tags
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
    
[0m17:17:44.314052 [debug] [MainThread]: Command `dbt compile` succeeded at 17:17:44.313054 after 1.07 seconds
[0m17:17:44.315058 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ACE6977830>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ACE7061DC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ACE724CA70>]}
[0m17:17:44.317058 [debug] [MainThread]: Flushing usage events
[0m14:18:07.146250 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000133092A2240>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000133092A3170>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000133092A3A70>]}


============================== 14:18:07.152246 | 814b37b4-3639-4b46-90a2-d6d93eead754 ==============================
[0m14:18:07.152246 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:18:07.154256 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m14:18:07.520249 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '814b37b4-3639-4b46-90a2-d6d93eead754', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000133092F86E0>]}
[0m14:18:07.715248 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '814b37b4-3639-4b46-90a2-d6d93eead754', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013309369610>]}
[0m14:18:07.717246 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:18:07.742246 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:18:08.940805 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m14:18:08.941801 [debug] [MainThread]: Partial parsing: added file: dbt_project_test_kasper://models\pageview_month_13.sql
[0m14:18:09.182795 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '814b37b4-3639-4b46-90a2-d6d93eead754', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000133098C2360>]}
[0m14:18:09.216800 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '814b37b4-3639-4b46-90a2-d6d93eead754', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000133096B9790>]}
[0m14:18:09.217797 [info ] [MainThread]: Found 5 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m14:18:09.219817 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '814b37b4-3639-4b46-90a2-d6d93eead754', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001330908A120>]}
[0m14:18:09.225796 [info ] [MainThread]: 
[0m14:18:09.227799 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m14:18:09.231799 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m14:18:09.250795 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:18:09.251797 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m14:18:09.252797 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:18:09.349795 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m14:18:09.350798 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:18:09.351801 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m14:18:09.410799 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m14:18:09.413797 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m14:18:09.415797 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m14:18:09.425818 [debug] [MainThread]: Using postgres connection "master"
[0m14:18:09.426800 [debug] [MainThread]: On master: BEGIN
[0m14:18:09.427798 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:18:09.487799 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m14:18:09.488797 [debug] [MainThread]: Using postgres connection "master"
[0m14:18:09.490797 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m14:18:09.508794 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m14:18:09.511795 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '814b37b4-3639-4b46-90a2-d6d93eead754', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000133096BB8F0>]}
[0m14:18:09.512795 [debug] [MainThread]: On master: ROLLBACK
[0m14:18:09.513797 [debug] [MainThread]: On master: Close
[0m14:18:09.515796 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:18:09.516797 [info ] [MainThread]: 
[0m14:18:09.524798 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_month_13
[0m14:18:09.525798 [debug] [Thread-2 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:18:09.527797 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_month_13'
[0m14:18:09.530801 [debug] [Thread-2 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m14:18:09.531799 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_month_13
[0m14:18:09.533797 [debug] [Thread-2 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:18:09.554795 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_month_13"
[0m14:18:09.578796 [debug] [Thread-2 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m14:18:09.580801 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_month_13 (compile): 14:18:09.533797 => 14:18:09.579799
[0m14:18:09.582800 [debug] [Thread-2 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 14:18:09.556863 => 14:18:09.581798
[0m14:18:09.583799 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_month_13
[0m14:18:09.584797 [debug] [Thread-2 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:18:09.586798 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_month_13 (execute): 14:18:09.585801 => 14:18:09.585801
[0m14:18:09.588802 [debug] [Thread-2 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 14:18:09.587799 => 14:18:09.587799
[0m14:18:09.590795 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_month_13
[0m14:18:09.593799 [debug] [Thread-2 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:18:09.593799 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m14:18:09.595797 [debug] [Thread-2 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_dropdown_dbt_test
[0m14:18:09.596796 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.dbt_project_test_kasper.pageview_month_13, now model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13)
[0m14:18:09.598797 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13, now model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_dropdown_dbt_test)
[0m14:18:09.599797 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m14:18:09.600797 [debug] [Thread-2 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_dropdown_dbt_test
[0m14:18:09.628798 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13"
[0m14:18:09.649794 [debug] [Thread-2 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_dropdown_dbt_test"
[0m14:18:09.651798 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (compile): 14:18:09.601797 => 14:18:09.651798
[0m14:18:09.653798 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m14:18:09.654797 [debug] [Thread-2 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_dropdown_dbt_test (compile): 14:18:09.629797 => 14:18:09.653798
[0m14:18:09.656800 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (execute): 14:18:09.655797 => 14:18:09.655797
[0m14:18:09.657804 [debug] [Thread-2 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_dropdown_dbt_test
[0m14:18:09.660798 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m14:18:09.663799 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m14:18:09.662798 [debug] [Thread-2 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_dropdown_dbt_test (execute): 14:18:09.661797 => 14:18:09.661797
[0m14:18:09.665799 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13, now model.dbt_project_test_kasper.test)
[0m14:18:09.668798 [debug] [Thread-2 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_dropdown_dbt_test
[0m14:18:09.670802 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m14:18:09.716799 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m14:18:09.718800 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 14:18:09.671800 => 14:18:09.717802
[0m14:18:09.719799 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m14:18:09.721804 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 14:18:09.720798 => 14:18:09.720798
[0m14:18:09.724798 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m14:18:09.727802 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:18:09.729802 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m14:18:09.730801 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m14:18:09.731799 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_dropdown_dbt_test' was properly closed.
[0m14:18:09.735795 [debug] [MainThread]: Command end result
[0m14:18:09.755799 [debug] [MainThread]: Command `dbt compile` succeeded at 14:18:09.754799 after 2.82 seconds
[0m14:18:09.756798 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001330908A390>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000133098D7BC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000133098F56D0>]}
[0m14:18:09.757801 [debug] [MainThread]: Flushing usage events
[0m14:18:15.799209 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001883D2434A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001883D2415B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001883D243AA0>]}


============================== 14:18:15.805209 | 0915b74b-6123-4b4f-9c1e-8c30a558ac31 ==============================
[0m14:18:15.805209 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:18:15.806210 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --models pageview_month_13', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m14:18:16.115209 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0915b74b-6123-4b4f-9c1e-8c30a558ac31', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001883D2986B0>]}
[0m14:18:16.237208 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0915b74b-6123-4b4f-9c1e-8c30a558ac31', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001883C138050>]}
[0m14:18:16.240210 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:18:16.255209 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:18:16.386249 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m14:18:16.387247 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m14:18:16.397250 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0915b74b-6123-4b4f-9c1e-8c30a558ac31', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001883D5ABFB0>]}
[0m14:18:16.423252 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0915b74b-6123-4b4f-9c1e-8c30a558ac31', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001883D67C2F0>]}
[0m14:18:16.425257 [info ] [MainThread]: Found 5 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m14:18:16.429251 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0915b74b-6123-4b4f-9c1e-8c30a558ac31', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001883D67C1D0>]}
[0m14:18:16.437255 [info ] [MainThread]: 
[0m14:18:16.443254 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m14:18:16.446253 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper'
[0m14:18:16.465251 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper"
[0m14:18:16.467254 [debug] [ThreadPool]: On list_dbt_project_test_kasper: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper"} */

    select distinct nspname from pg_namespace
  
[0m14:18:16.468252 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:18:16.604256 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.0 seconds
[0m14:18:16.607246 [debug] [ThreadPool]: On list_dbt_project_test_kasper: Close
[0m14:18:16.610250 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m14:18:16.618248 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:18:16.619249 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m14:18:16.619249 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:18:16.698249 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m14:18:16.699257 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:18:16.700250 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m14:18:16.712248 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m14:18:16.715249 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m14:18:16.717249 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m14:18:16.725247 [debug] [MainThread]: Using postgres connection "master"
[0m14:18:16.726249 [debug] [MainThread]: On master: BEGIN
[0m14:18:16.727248 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:18:16.788249 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m14:18:16.790253 [debug] [MainThread]: Using postgres connection "master"
[0m14:18:16.791252 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m14:18:16.805247 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m14:18:16.807250 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0915b74b-6123-4b4f-9c1e-8c30a558ac31', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001883D5A9BB0>]}
[0m14:18:16.808251 [debug] [MainThread]: On master: ROLLBACK
[0m14:18:16.809249 [debug] [MainThread]: Using postgres connection "master"
[0m14:18:16.809249 [debug] [MainThread]: On master: BEGIN
[0m14:18:16.810252 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m14:18:16.811250 [debug] [MainThread]: On master: COMMIT
[0m14:18:16.812248 [debug] [MainThread]: Using postgres connection "master"
[0m14:18:16.813251 [debug] [MainThread]: On master: COMMIT
[0m14:18:16.814250 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m14:18:16.815250 [debug] [MainThread]: On master: Close
[0m14:18:16.817250 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:18:16.818252 [info ] [MainThread]: 
[0m14:18:16.825248 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_month_13
[0m14:18:16.826250 [info ] [Thread-1 (]: 1 of 1 START sql table model public.pageview_month_13 .......................... [RUN]
[0m14:18:16.829260 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_month_13'
[0m14:18:16.830250 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_month_13
[0m14:18:16.857245 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_month_13"
[0m14:18:16.859250 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_month_13 (compile): 14:18:16.831251 => 14:18:16.858246
[0m14:18:16.860250 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_month_13
[0m14:18:16.931247 [debug] [Thread-1 (]: Writing runtime sql for node "model.dbt_project_test_kasper.pageview_month_13"
[0m14:18:16.935252 [debug] [Thread-1 (]: Using postgres connection "model.dbt_project_test_kasper.pageview_month_13"
[0m14:18:16.936250 [debug] [Thread-1 (]: On model.dbt_project_test_kasper.pageview_month_13: BEGIN
[0m14:18:16.938248 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m14:18:17.009248 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m14:18:17.011250 [debug] [Thread-1 (]: Using postgres connection "model.dbt_project_test_kasper.pageview_month_13"
[0m14:18:17.012251 [debug] [Thread-1 (]: On model.dbt_project_test_kasper.pageview_month_13: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "node_id": "model.dbt_project_test_kasper.pageview_month_13"} */

  
    

  create  table "dbt_project_test_kasper"."public"."pageview_month_13__dbt_tmp"
  
  
    as
  
  (
    
CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`pageview_month_13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
  );
  
[0m14:18:17.017252 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near "CREATE"
LINE 13: CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`pageview_month_...
         ^

[0m14:18:17.019251 [debug] [Thread-1 (]: On model.dbt_project_test_kasper.pageview_month_13: ROLLBACK
[0m14:18:17.021249 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_month_13 (execute): 14:18:16.861248 => 14:18:17.020250
[0m14:18:17.022247 [debug] [Thread-1 (]: On model.dbt_project_test_kasper.pageview_month_13: Close
[0m14:18:17.249288 [debug] [Thread-1 (]: Database Error in model pageview_month_13 (models\pageview_month_13.sql)
  syntax error at or near "CREATE"
  LINE 13: CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`pageview_month_...
           ^
  compiled Code at target\run\dbt_project_test_kasper\models\pageview_month_13.sql
[0m14:18:17.252248 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0915b74b-6123-4b4f-9c1e-8c30a558ac31', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001883D62E7E0>]}
[0m14:18:17.254252 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model public.pageview_month_13 ................. [[31mERROR[0m in 0.43s]
[0m14:18:17.257261 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_month_13
[0m14:18:17.262253 [debug] [MainThread]: Using postgres connection "master"
[0m14:18:17.263249 [debug] [MainThread]: On master: BEGIN
[0m14:18:17.265258 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m14:18:17.359249 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m14:18:17.360267 [debug] [MainThread]: On master: COMMIT
[0m14:18:17.361245 [debug] [MainThread]: Using postgres connection "master"
[0m14:18:17.362248 [debug] [MainThread]: On master: COMMIT
[0m14:18:17.364251 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m14:18:17.365249 [debug] [MainThread]: On master: Close
[0m14:18:17.367252 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:18:17.369250 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper' was properly closed.
[0m14:18:17.370249 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m14:18:17.371250 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_month_13' was properly closed.
[0m14:18:17.372251 [info ] [MainThread]: 
[0m14:18:17.373250 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 0.93 seconds (0.93s).
[0m14:18:17.376259 [debug] [MainThread]: Command end result
[0m14:18:17.400262 [info ] [MainThread]: 
[0m14:18:17.404252 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m14:18:17.407283 [info ] [MainThread]: 
[0m14:18:17.410251 [error] [MainThread]:   Database Error in model pageview_month_13 (models\pageview_month_13.sql)
  syntax error at or near "CREATE"
  LINE 13: CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`pageview_month_...
           ^
  compiled Code at target\run\dbt_project_test_kasper\models\pageview_month_13.sql
[0m14:18:17.412249 [info ] [MainThread]: 
[0m14:18:17.415282 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m14:18:17.423255 [debug] [MainThread]: Command `dbt run` failed at 14:18:17.422252 after 1.76 seconds
[0m14:18:17.429251 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001883D25BFE0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001883D223DD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001883D06B950>]}
[0m14:18:17.433261 [debug] [MainThread]: Flushing usage events
[0m14:23:56.798645 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020244E52C90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020244E52DB0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020244E52A20>]}


============================== 14:23:56.804644 | 4734d5de-0025-4463-b39e-c68bf6974712 ==============================
[0m14:23:56.804644 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:23:56.805644 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt compile -s pageview_month_13', 'send_anonymous_usage_stats': 'True'}
[0m14:23:57.102647 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4734d5de-0025-4463-b39e-c68bf6974712', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020244EA8860>]}
[0m14:23:57.274644 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4734d5de-0025-4463-b39e-c68bf6974712', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020244EA85C0>]}
[0m14:23:57.283644 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:23:57.320649 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:23:57.436644 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m14:23:57.437650 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m14:23:57.449643 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4734d5de-0025-4463-b39e-c68bf6974712', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020244BF1A60>]}
[0m14:23:57.470647 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4734d5de-0025-4463-b39e-c68bf6974712', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202452481A0>]}
[0m14:23:57.472649 [info ] [MainThread]: Found 5 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m14:23:57.474647 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4734d5de-0025-4463-b39e-c68bf6974712', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020244C3E0C0>]}
[0m14:23:57.477648 [info ] [MainThread]: 
[0m14:23:57.480685 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m14:23:57.483647 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m14:23:57.501646 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:23:57.502691 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m14:23:57.503649 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:23:57.566644 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m14:23:57.567646 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:23:57.568646 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m14:23:57.576643 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m14:23:57.578645 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m14:23:57.580644 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m14:23:57.588644 [debug] [MainThread]: Using postgres connection "master"
[0m14:23:57.589646 [debug] [MainThread]: On master: BEGIN
[0m14:23:57.590656 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:23:57.640645 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m14:23:57.641645 [debug] [MainThread]: Using postgres connection "master"
[0m14:23:57.643647 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m14:23:57.654643 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m14:23:57.656646 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4734d5de-0025-4463-b39e-c68bf6974712', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202451F0770>]}
[0m14:23:57.657647 [debug] [MainThread]: On master: ROLLBACK
[0m14:23:57.658649 [debug] [MainThread]: On master: Close
[0m14:23:57.660646 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:23:57.662646 [info ] [MainThread]: 
[0m14:23:57.667643 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_month_13
[0m14:23:57.668645 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_month_13'
[0m14:23:57.669643 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_month_13
[0m14:23:57.691645 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_month_13"
[0m14:23:57.693648 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_month_13 (compile): 14:23:57.669643 => 14:23:57.692645
[0m14:23:57.694646 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_month_13
[0m14:23:57.695647 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_month_13 (execute): 14:23:57.695647 => 14:23:57.695647
[0m14:23:57.697646 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_month_13
[0m14:23:57.699644 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:23:57.700644 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m14:23:57.701645 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_month_13' was properly closed.
[0m14:23:57.702645 [debug] [MainThread]: Command end result
[0m14:23:57.713648 [info ] [MainThread]: Compiled node 'pageview_month_13' is:

CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`pageview_month_13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
[0m14:23:57.716649 [debug] [MainThread]: Command `dbt compile` succeeded at 14:23:57.715650 after 1.11 seconds
[0m14:23:57.717647 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020241F55280>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002023E815520>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020244E6BB30>]}
[0m14:23:57.718648 [debug] [MainThread]: Flushing usage events
[0m14:27:17.245497 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E4042D3EC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E4042D3980>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E4042D1C40>]}


============================== 14:27:17.250493 | 86b70123-5b13-4f37-9d6c-9131ce00df3c ==============================
[0m14:27:17.250493 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:27:17.251494 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt compile -s pageview_month_13', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m14:27:17.538613 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '86b70123-5b13-4f37-9d6c-9131ce00df3c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E404328B00>]}
[0m14:27:17.654615 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '86b70123-5b13-4f37-9d6c-9131ce00df3c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E4041D03B0>]}
[0m14:27:17.657614 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:27:17.669615 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:27:17.762616 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m14:27:17.762616 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_month_13.sql
[0m14:27:18.126614 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '86b70123-5b13-4f37-9d6c-9131ce00df3c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E4048BEF90>]}
[0m14:27:18.140616 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '86b70123-5b13-4f37-9d6c-9131ce00df3c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E4046CD9A0>]}
[0m14:27:18.141614 [info ] [MainThread]: Found 5 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m14:27:18.143614 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '86b70123-5b13-4f37-9d6c-9131ce00df3c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E4048C50D0>]}
[0m14:27:18.145613 [info ] [MainThread]: 
[0m14:27:18.147615 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m14:27:18.149613 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m14:27:18.165611 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:27:18.165611 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m14:27:18.166614 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:27:18.222614 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m14:27:18.222614 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:27:18.223612 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m14:27:18.232615 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m14:27:18.235614 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m14:27:18.236614 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m14:27:18.243612 [debug] [MainThread]: Using postgres connection "master"
[0m14:27:18.244613 [debug] [MainThread]: On master: BEGIN
[0m14:27:18.244613 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:27:18.302615 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m14:27:18.303614 [debug] [MainThread]: Using postgres connection "master"
[0m14:27:18.304614 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m14:27:18.313613 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m14:27:18.315611 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '86b70123-5b13-4f37-9d6c-9131ce00df3c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E4044F4110>]}
[0m14:27:18.317613 [debug] [MainThread]: On master: ROLLBACK
[0m14:27:18.317613 [debug] [MainThread]: On master: Close
[0m14:27:18.319613 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:27:18.321614 [info ] [MainThread]: 
[0m14:27:18.325612 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_month_13
[0m14:27:18.326615 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_month_13'
[0m14:27:18.327615 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_month_13
[0m14:27:18.350616 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_month_13"
[0m14:27:18.352615 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_month_13 (compile): 14:27:18.328615 => 14:27:18.352615
[0m14:27:18.353617 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_month_13
[0m14:27:18.355614 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_month_13 (execute): 14:27:18.354616 => 14:27:18.354616
[0m14:27:18.357618 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_month_13
[0m14:27:18.359614 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:27:18.360615 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m14:27:18.361616 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_month_13' was properly closed.
[0m14:27:18.363617 [debug] [MainThread]: Command end result
[0m14:27:18.377612 [info ] [MainThread]: Compiled node 'pageview_month_13' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`pageview_month_13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
        ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
        UNION ALL SELECT ''Others''
        ),
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',order_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date date between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        ),
        
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN userneeds IN (', tag_statement_first, ') THEN  userneeds
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN userneeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    
    categories_second AS (
        ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
        UNION ALL SELECT ''Others''
        ),
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN Categories IN (',  tag_statement_second, ') THEN Categories
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		), 
    
    
    categories_third AS (
        ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
        UNION ALL SELECT ''Others''
        ),
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Tags IN (', tag_statement_third, ') THEN  Tags
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN Tags IN (',  tag_statement_third, ') THEN Tags
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
    
[0m14:27:18.389626 [debug] [MainThread]: Command `dbt compile` succeeded at 14:27:18.388619 after 1.33 seconds
[0m14:27:18.390621 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E4042D3B30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E4042D3980>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E4042D1C40>]}
[0m14:27:18.391620 [debug] [MainThread]: Flushing usage events
[0m16:48:34.158123 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFDF0016D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFDEF13320>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFDF0031A0>]}


============================== 16:48:34.166122 | aba2effd-c603-403e-8637-50bb97bb26d0 ==============================
[0m16:48:34.166122 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:48:34.169126 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s pageview_month_13', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:48:34.468123 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'aba2effd-c603-403e-8637-50bb97bb26d0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFDF029130>]}
[0m16:48:34.635122 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'aba2effd-c603-403e-8637-50bb97bb26d0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFDF028BC0>]}
[0m16:48:34.637122 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:48:34.653124 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:48:34.803210 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 2 files changed.
[0m16:48:34.804209 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_month_13.sql
[0m16:48:34.805211 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m16:48:35.094209 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'aba2effd-c603-403e-8637-50bb97bb26d0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFDF30B6E0>]}
[0m16:48:35.110211 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'aba2effd-c603-403e-8637-50bb97bb26d0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFDF3D80E0>]}
[0m16:48:35.111212 [info ] [MainThread]: Found 5 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m16:48:35.113224 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'aba2effd-c603-403e-8637-50bb97bb26d0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFDF5ABB90>]}
[0m16:48:35.119212 [info ] [MainThread]: 
[0m16:48:35.121211 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m16:48:35.123210 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m16:48:35.142209 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:48:35.143211 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m16:48:35.143211 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:48:35.224214 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m16:48:35.225212 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:48:35.226211 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m16:48:35.260211 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m16:48:35.264219 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m16:48:35.266217 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m16:48:35.279216 [debug] [MainThread]: Using postgres connection "master"
[0m16:48:35.281216 [debug] [MainThread]: On master: BEGIN
[0m16:48:35.282215 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:48:35.439210 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:48:35.440211 [debug] [MainThread]: Using postgres connection "master"
[0m16:48:35.441211 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m16:48:35.456208 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m16:48:35.460211 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'aba2effd-c603-403e-8637-50bb97bb26d0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFDEA86C00>]}
[0m16:48:35.461210 [debug] [MainThread]: On master: ROLLBACK
[0m16:48:35.462211 [debug] [MainThread]: On master: Close
[0m16:48:35.464213 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:48:35.466221 [info ] [MainThread]: 
[0m16:48:35.476209 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_month_13
[0m16:48:35.478221 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_month_13'
[0m16:48:35.479207 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_month_13
[0m16:48:35.506211 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_month_13"
[0m16:48:35.508211 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_month_13 (compile): 16:48:35.480207 => 16:48:35.507214
[0m16:48:35.509211 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_month_13
[0m16:48:35.510214 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_month_13 (execute): 16:48:35.510214 => 16:48:35.510214
[0m16:48:35.513212 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_month_13
[0m16:48:35.516211 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:48:35.517212 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m16:48:35.517212 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_month_13' was properly closed.
[0m16:48:35.519211 [debug] [MainThread]: Command end result
[0m16:48:35.532209 [info ] [MainThread]: Compiled node 'pageview_month_13' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`pageview_month_13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
        ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
        UNION ALL SELECT ''Others''
        ),
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',order_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date date between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        ),
        
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN userneeds IN (', tag_statement_first, ') THEN  userneeds
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN userneeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    
    categories_second AS (
        ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
        UNION ALL SELECT ''Others''
        ),
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN Categories IN (',  tag_statement_second, ') THEN Categories
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories_second,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile_second
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile_second, ''}''), '']'') AS series_second
			FROM pivoted_data_second
			group by label,cat_second,hint
		), 
    
    
    categories_third AS (
        ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
        UNION ALL SELECT ''Others''
        ),
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Tags IN (', tag_statement_third, ') THEN  Tags
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN Tags IN (',  tag_statement_third, ') THEN Tags
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories_third,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile_third
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile_third, ''}''), '']'') AS series_third
			FROM pivoted_data_third
			group by label,cat_third,hint
		)
    
[0m16:48:35.545214 [debug] [MainThread]: Command `dbt compile` succeeded at 16:48:35.545214 after 1.60 seconds
[0m16:48:35.546214 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFDE575640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFDEF13320>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFDEF116D0>]}
[0m16:48:35.548215 [debug] [MainThread]: Flushing usage events
[0m17:25:09.777818 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015A7F8903E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015A7F9913A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015A7F990200>]}


============================== 17:25:09.784115 | 73e89da1-13b3-450b-aff2-8671d3a10fe7 ==============================
[0m17:25:09.784115 [info ] [MainThread]: Running with dbt=1.7.13
[0m17:25:09.786135 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s pageview_month_13', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:25:10.084478 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '73e89da1-13b3-450b-aff2-8671d3a10fe7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015A7FC3D3D0>]}
[0m17:25:10.227482 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '73e89da1-13b3-450b-aff2-8671d3a10fe7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015A7F9BA840>]}
[0m17:25:10.229481 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m17:25:10.246480 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m17:25:10.388476 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 1 files changed.
[0m17:25:10.389477 [debug] [MainThread]: Partial parsing: added file: dbt_project_test_kasper://models\pageview_ytd_13.sql
[0m17:25:10.390480 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_month_13.sql
[0m17:25:10.762476 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '73e89da1-13b3-450b-aff2-8671d3a10fe7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015A0002BC50>]}
[0m17:25:10.780482 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '73e89da1-13b3-450b-aff2-8671d3a10fe7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015A7FE099D0>]}
[0m17:25:10.781480 [info ] [MainThread]: Found 6 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m17:25:10.783493 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '73e89da1-13b3-450b-aff2-8671d3a10fe7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015A7FCA22D0>]}
[0m17:25:10.786486 [info ] [MainThread]: 
[0m17:25:10.789478 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m17:25:10.792483 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m17:25:10.814479 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:25:10.815479 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m17:25:10.816480 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:25:10.915479 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m17:25:10.916482 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:25:10.918480 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m17:25:10.954480 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m17:25:10.957481 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m17:25:10.959481 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m17:25:10.969476 [debug] [MainThread]: Using postgres connection "master"
[0m17:25:10.970482 [debug] [MainThread]: On master: BEGIN
[0m17:25:10.971480 [debug] [MainThread]: Opening a new connection, currently in state init
[0m17:25:11.042480 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m17:25:11.044481 [debug] [MainThread]: Using postgres connection "master"
[0m17:25:11.045482 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m17:25:11.066479 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m17:25:11.069478 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '73e89da1-13b3-450b-aff2-8671d3a10fe7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015A7F990F50>]}
[0m17:25:11.071483 [debug] [MainThread]: On master: ROLLBACK
[0m17:25:11.072480 [debug] [MainThread]: On master: Close
[0m17:25:11.074480 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:25:11.076489 [info ] [MainThread]: 
[0m17:25:11.086479 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_month_13
[0m17:25:11.088481 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_month_13'
[0m17:25:11.089481 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_month_13
[0m17:25:11.135479 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_month_13"
[0m17:25:11.138481 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_month_13 (compile): 17:25:11.090481 => 17:25:11.137481
[0m17:25:11.139482 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_month_13
[0m17:25:11.141484 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_month_13 (execute): 17:25:11.140482 => 17:25:11.140482
[0m17:25:11.144480 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_month_13
[0m17:25:11.146481 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:25:11.147481 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m17:25:11.148485 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_month_13' was properly closed.
[0m17:25:11.150479 [debug] [MainThread]: Command end result
[0m17:25:11.170478 [info ] [MainThread]: Compiled node 'pageview_month_13' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`pageview_month_13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
        ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
        UNION ALL SELECT ''Others''
        ),
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',order_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        ),
        
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN userneeds IN (', tag_statement_first, ') THEN  userneeds
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN userneeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    
    categories_second AS (
        ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
        UNION ALL SELECT ''Others''
        ),
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN Categories IN (',  tag_statement_second, ') THEN Categories
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories_second,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile_second
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories_second AS cat_second, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile_second, ''}''), '']'') AS series_second
			FROM pivoted_data_second
			group by label,cat_second,hint
		), 
    
    
    categories_third AS (
        ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
        UNION ALL SELECT ''Others''
        ),
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Tags IN (', tag_statement_third, ') THEN  Tags
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN Tags IN (',  tag_statement_third, ') THEN Tags
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories_third,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile_third
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories_third AS cat_third, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile_third, ''}''), '']'') AS series_third
			FROM pivoted_data_third
			group by label,cat_third,hint
		)
    
[0m17:25:11.186485 [debug] [MainThread]: Command `dbt compile` succeeded at 17:25:11.186485 after 1.61 seconds
[0m17:25:11.187481 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015A7EB0C380>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015A7F9913A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015A7F990200>]}
[0m17:25:11.190478 [debug] [MainThread]: Flushing usage events
[0m17:27:27.145922 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017F76B637A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017F76B62C60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017F76B626C0>]}


============================== 17:27:27.151946 | 0c626e0a-31e3-476c-b398-a7f6683b8e6b ==============================
[0m17:27:27.151946 [info ] [MainThread]: Running with dbt=1.7.13
[0m17:27:27.153969 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s pageview_ytd_13', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:27:27.467133 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0c626e0a-31e3-476c-b398-a7f6683b8e6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017F76BB8680>]}
[0m17:27:27.631753 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0c626e0a-31e3-476c-b398-a7f6683b8e6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017F76A3E3C0>]}
[0m17:27:27.633757 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m17:27:27.652886 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m17:27:27.771873 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m17:27:27.772863 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m17:27:27.780864 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0c626e0a-31e3-476c-b398-a7f6683b8e6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017F75C0F050>]}
[0m17:27:27.798863 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0c626e0a-31e3-476c-b398-a7f6683b8e6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017F76F89D00>]}
[0m17:27:27.799862 [info ] [MainThread]: Found 6 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m17:27:27.801870 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0c626e0a-31e3-476c-b398-a7f6683b8e6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017F75F1E0C0>]}
[0m17:27:27.806880 [info ] [MainThread]: 
[0m17:27:27.808865 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m17:27:27.811861 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m17:27:27.832862 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:27:27.833865 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m17:27:27.834873 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:27:27.903862 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m17:27:27.903862 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:27:27.904868 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m17:27:27.916861 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m17:27:27.918863 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m17:27:27.919860 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m17:27:27.928860 [debug] [MainThread]: Using postgres connection "master"
[0m17:27:27.928860 [debug] [MainThread]: On master: BEGIN
[0m17:27:27.929869 [debug] [MainThread]: Opening a new connection, currently in state init
[0m17:27:28.002865 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m17:27:28.004866 [debug] [MainThread]: Using postgres connection "master"
[0m17:27:28.006863 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m17:27:28.024864 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m17:27:28.028866 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0c626e0a-31e3-476c-b398-a7f6683b8e6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017F76F892E0>]}
[0m17:27:28.029866 [debug] [MainThread]: On master: ROLLBACK
[0m17:27:28.031912 [debug] [MainThread]: On master: Close
[0m17:27:28.033862 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:27:28.035865 [info ] [MainThread]: 
[0m17:27:28.044866 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_ytd_13
[0m17:27:28.047863 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_ytd_13'
[0m17:27:28.048865 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_ytd_13
[0m17:27:28.092859 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_ytd_13"
[0m17:27:28.094862 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_ytd_13 (compile): 17:27:28.049864 => 17:27:28.094862
[0m17:27:28.096863 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_ytd_13
[0m17:27:28.097862 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_ytd_13 (execute): 17:27:28.097862 => 17:27:28.097862
[0m17:27:28.101859 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_ytd_13
[0m17:27:28.103862 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:27:28.104878 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m17:27:28.105863 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_ytd_13' was properly closed.
[0m17:27:28.107862 [debug] [MainThread]: Command end result
[0m17:27:28.124860 [info ] [MainThread]: Compiled node 'pageview_ytd_13' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`pageview_ytd_13_dbt_test`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
        ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
        UNION ALL SELECT ''Others''
        ),
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, '  AND date BETWEEN  MAKEDATE(EXTRACT(YEAR FROM CURDATE()), 1) AND DATE_SUB(CAST(NOW() AS DATE), INTERVAL 1 DAY)
                AND r.realreferrer IN (',order_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN MAKEDATE(EXTRACT(YEAR FROM CURDATE()), 1) AND DATE_SUB(CAST(NOW() AS DATE), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        ),
        
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN userneeds IN (', tag_statement_first, ') THEN  userneeds
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN userneeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    
    categories_second AS (
        ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
        UNION ALL SELECT ''Others''
        ),
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN Categories IN (',  tag_statement_second, ') THEN Categories
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories_second,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile_second
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories_second AS cat_second, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile_second, ''}''), '']'') AS series_second
			FROM pivoted_data_second
			group by label,cat_second,hint
		), 
    
    
    categories_third AS (
        ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
        UNION ALL SELECT ''Others''
        ),
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Tags IN (', tag_statement_third, ') THEN  Tags
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN Tags IN (',  tag_statement_third, ') THEN Tags
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories_third,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile_third
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories_third AS cat_third, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile_third, ''}''), '']'') AS series_third
			FROM pivoted_data_third
			group by label,cat_third,hint
		)
    
[0m17:27:28.138872 [debug] [MainThread]: Command `dbt compile` succeeded at 17:27:28.137865 after 1.22 seconds
[0m17:27:28.139867 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017F768FC980>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017F7697F3E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017F76761E50>]}
[0m17:27:28.141874 [debug] [MainThread]: Flushing usage events
[0m10:49:29.798326 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB12763A10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB12762690>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB127634D0>]}


============================== 10:49:29.810198 | 42ff64cc-47d3-4224-998f-07f709dc4213 ==============================
[0m10:49:29.810198 [info ] [MainThread]: Running with dbt=1.7.13
[0m10:49:29.813208 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s pageview_ytd_13', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m10:49:30.271303 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '42ff64cc-47d3-4224-998f-07f709dc4213', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB12760B60>]}
[0m10:49:30.418302 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '42ff64cc-47d3-4224-998f-07f709dc4213', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB12515E50>]}
[0m10:49:30.420304 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m10:49:30.461867 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m10:49:32.340766 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m10:49:32.341770 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m10:49:32.356769 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '42ff64cc-47d3-4224-998f-07f709dc4213', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB12A7A510>]}
[0m10:49:32.403328 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '42ff64cc-47d3-4224-998f-07f709dc4213', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB12B48FE0>]}
[0m10:49:32.405327 [info ] [MainThread]: Found 6 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m10:49:32.408330 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '42ff64cc-47d3-4224-998f-07f709dc4213', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB127B9CD0>]}
[0m10:49:32.414100 [info ] [MainThread]: 
[0m10:49:32.418328 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m10:49:32.422334 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m10:49:32.457328 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m10:49:32.458340 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m10:49:32.460328 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:49:32.582322 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m10:49:32.583325 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m10:49:32.584385 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m10:49:32.620646 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m10:49:32.625653 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m10:49:32.628649 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m10:49:32.644657 [debug] [MainThread]: Using postgres connection "master"
[0m10:49:32.645655 [debug] [MainThread]: On master: BEGIN
[0m10:49:32.646656 [debug] [MainThread]: Opening a new connection, currently in state init
[0m10:49:32.744886 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m10:49:32.746868 [debug] [MainThread]: Using postgres connection "master"
[0m10:49:32.747701 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m10:49:32.781870 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m10:49:32.784870 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '42ff64cc-47d3-4224-998f-07f709dc4213', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB12B4B1D0>]}
[0m10:49:32.786898 [debug] [MainThread]: On master: ROLLBACK
[0m10:49:32.788869 [debug] [MainThread]: On master: Close
[0m10:49:32.792126 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m10:49:32.794951 [info ] [MainThread]: 
[0m10:49:32.805940 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_ytd_13
[0m10:49:32.808950 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_ytd_13'
[0m10:49:32.810943 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_ytd_13
[0m10:49:32.859943 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_ytd_13"
[0m10:49:32.863945 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_ytd_13 (compile): 10:49:32.811942 => 10:49:32.862863
[0m10:49:32.865946 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_ytd_13
[0m10:49:32.867949 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_ytd_13 (execute): 10:49:32.866945 => 10:49:32.866945
[0m10:49:32.872943 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_ytd_13
[0m10:49:32.875947 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:49:32.877952 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m10:49:32.878951 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_ytd_13' was properly closed.
[0m10:49:32.881943 [debug] [MainThread]: Command end result
[0m10:49:32.900942 [info ] [MainThread]: Compiled node 'pageview_ytd_13' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`pageview_ytd_13_dbt_test`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
        ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
        UNION ALL SELECT ''Others''
        ),
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, '  AND date BETWEEN  MAKEDATE(EXTRACT(YEAR FROM CURDATE()), 1) AND DATE_SUB(CAST(NOW() AS DATE), INTERVAL 1 DAY)
                AND r.realreferrer IN (',order_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN MAKEDATE(EXTRACT(YEAR FROM CURDATE()), 1) AND DATE_SUB(CAST(NOW() AS DATE), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        ),
        
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN userneeds IN (', tag_statement_first, ') THEN  userneeds
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN userneeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    
    categories_second AS (
        ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
        UNION ALL SELECT ''Others''
        ),
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN Categories IN (',  tag_statement_second, ') THEN Categories
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories_second,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile_second
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories_second AS cat_second, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile_second, ''}''), '']'') AS series_second
			FROM pivoted_data_second
			group by label,cat_second,hint
		), 
    
    
    categories_third AS (
        ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
        UNION ALL SELECT ''Others''
        ),
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Tags IN (', tag_statement_third, ') THEN  Tags
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN Tags IN (',  tag_statement_third, ') THEN Tags
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories_third,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile_third
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories_third AS cat_third, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile_third, ''}''), '']'') AS series_third
			FROM pivoted_data_third
			group by label,cat_third,hint
		)
    
[0m10:49:32.915943 [debug] [MainThread]: Command `dbt compile` succeeded at 10:49:32.915943 after 3.37 seconds
[0m10:49:32.916942 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB119CE540>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB12434CB0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB12C30260>]}
[0m10:49:32.918974 [debug] [MainThread]: Flushing usage events
[0m11:43:07.474737 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A56E12030>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A56E13860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A56E12000>]}


============================== 11:43:07.484275 | 76ae0f6d-cacf-447f-8591-fb2a5e27d40c ==============================
[0m11:43:07.484275 [info ] [MainThread]: Running with dbt=1.7.13
[0m11:43:07.487275 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt compile -s pageview_ytd_13', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m11:43:07.828558 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '76ae0f6d-cacf-447f-8591-fb2a5e27d40c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A56D23830>]}
[0m11:43:08.166713 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '76ae0f6d-cacf-447f-8591-fb2a5e27d40c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A56BC9E20>]}
[0m11:43:08.169709 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m11:43:08.196219 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m11:43:08.324515 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m11:43:08.325516 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_ytd_13.sql
[0m11:43:08.562001 [error] [MainThread]: Encountered an error:
Compilation Error in model pageview_ytd_13 (models\pageview_ytd_13.sql)
  unexpected ':'
    line 15
      {%set dictionTable={0:'site_archive_post',1:'site_archive_post',:2'split_tags_test'}%}
[0m11:43:08.565711 [debug] [MainThread]: Command `dbt compile` failed at 11:43:08.565711 after 1.44 seconds
[0m11:43:08.567571 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A56D20DD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A571535C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A572F87D0>]}
[0m11:43:08.569580 [debug] [MainThread]: Flushing usage events
[0m11:44:21.608352 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021554172DE0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021556923800>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021556920C20>]}


============================== 11:44:21.619090 | 2162bd8b-eddc-427b-8ea8-1ca0c30a93ab ==============================
[0m11:44:21.619090 [info ] [MainThread]: Running with dbt=1.7.13
[0m11:44:21.622389 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt compile -s pageview_ytd_13', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m11:44:22.063560 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2162bd8b-eddc-427b-8ea8-1ca0c30a93ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021556A07860>]}
[0m11:44:22.210451 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2162bd8b-eddc-427b-8ea8-1ca0c30a93ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021556922690>]}
[0m11:44:22.212713 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m11:44:22.229889 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m11:44:22.361430 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m11:44:22.362503 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_ytd_13.sql
[0m11:44:22.834626 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2162bd8b-eddc-427b-8ea8-1ca0c30a93ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021556BFE870>]}
[0m11:44:22.860632 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2162bd8b-eddc-427b-8ea8-1ca0c30a93ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021556CF96A0>]}
[0m11:44:22.863485 [info ] [MainThread]: Found 6 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m11:44:22.865497 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2162bd8b-eddc-427b-8ea8-1ca0c30a93ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000215569222D0>]}
[0m11:44:22.871681 [info ] [MainThread]: 
[0m11:44:22.875792 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m11:44:22.882772 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m11:44:22.916600 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:44:22.918000 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m11:44:22.919607 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:44:23.029656 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m11:44:23.030659 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:44:23.032758 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m11:44:23.056929 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m11:44:23.060263 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m11:44:23.062237 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m11:44:23.077282 [debug] [MainThread]: Using postgres connection "master"
[0m11:44:23.079594 [debug] [MainThread]: On master: BEGIN
[0m11:44:23.080278 [debug] [MainThread]: Opening a new connection, currently in state init
[0m11:44:23.189122 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m11:44:23.190085 [debug] [MainThread]: Using postgres connection "master"
[0m11:44:23.192047 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m11:44:23.209552 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m11:44:23.215572 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2162bd8b-eddc-427b-8ea8-1ca0c30a93ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021556E967B0>]}
[0m11:44:23.217572 [debug] [MainThread]: On master: ROLLBACK
[0m11:44:23.219567 [debug] [MainThread]: On master: Close
[0m11:44:23.222598 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:44:23.225588 [info ] [MainThread]: 
[0m11:44:23.237520 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_ytd_13
[0m11:44:23.239525 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_ytd_13'
[0m11:44:23.241520 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_ytd_13
[0m11:44:23.299644 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_ytd_13"
[0m11:44:23.303970 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_ytd_13 (compile): 11:44:23.245829 => 11:44:23.301837
[0m11:44:23.306566 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_ytd_13
[0m11:44:23.308567 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_ytd_13 (execute): 11:44:23.307564 => 11:44:23.307564
[0m11:44:23.311567 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_ytd_13
[0m11:44:23.315650 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:44:23.317650 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m11:44:23.318649 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_ytd_13' was properly closed.
[0m11:44:23.320651 [debug] [MainThread]: Command end result
[0m11:44:23.347819 [info ] [MainThread]: Compiled node 'pageview_ytd_13' is:










CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`pageview_ytd_13_dbt_test`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
        ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
        UNION ALL SELECT ''Others''
        ),
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, '  AND date BETWEEN  MAKEDATE(EXTRACT(YEAR FROM CURDATE()), 1) AND DATE_SUB(CAST(NOW() AS DATE), INTERVAL 1 DAY)
                AND r.realreferrer IN (',order_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN MAKEDATE(EXTRACT(YEAR FROM CURDATE()), 1) AND DATE_SUB(CAST(NOW() AS DATE), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        ),
        
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN userneeds IN (', tag_statement_first, ') THEN  userneeds
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN userneeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    
    categories_second AS (
        ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
        UNION ALL SELECT ''Others''
        ),
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN Categories IN (',  tag_statement_second, ') THEN Categories
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories_second,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile_second
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories_second AS cat_second, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile_second, ''}''), '']'') AS series_second
			FROM pivoted_data_second
			group by label,cat_second,hint
		), 
    
    
    categories_third AS (
        ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
        UNION ALL SELECT ''Others''
        ),
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Tags IN (', tag_statement_third, ') THEN  Tags
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.split_tags_test p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN Tags IN (',  tag_statement_third, ') THEN Tags
                    ELSE ''Others''
                END AS tag
            FROM prod.split_tags_test s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories_third,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile_third
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories_third AS cat_third, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile_third, ''}''), '']'') AS series_third
			FROM pivoted_data_third
			group by label,cat_third,hint
		)
    
[0m11:44:23.371979 [debug] [MainThread]: Command `dbt compile` succeeded at 11:44:23.371071 after 1.98 seconds
[0m11:44:23.375036 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021556831370>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021556E18950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021556E1A5A0>]}
[0m11:44:23.377534 [debug] [MainThread]: Flushing usage events
[0m12:28:36.227504 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E92EF70B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E92EF7B30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E92EF7860>]}


============================== 12:28:36.237563 | 2bbd8192-2c9a-42fe-acef-417d148934ee ==============================
[0m12:28:36.237563 [info ] [MainThread]: Running with dbt=1.7.13
[0m12:28:36.241276 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s pageview_month_13', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m12:28:36.689457 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2bbd8192-2c9a-42fe-acef-417d148934ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E92EF62A0>]}
[0m12:28:36.864584 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2bbd8192-2c9a-42fe-acef-417d148934ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E92CDC2F0>]}
[0m12:28:36.867586 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m12:28:36.890800 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m12:28:37.149281 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 2 files changed.
[0m12:28:37.150600 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_month_13.sql
[0m12:28:37.152594 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m12:28:37.577075 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2bbd8192-2c9a-42fe-acef-417d148934ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E93435C70>]}
[0m12:28:37.597704 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2bbd8192-2c9a-42fe-acef-417d148934ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E93299700>]}
[0m12:28:37.598705 [info ] [MainThread]: Found 6 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m12:28:37.600780 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2bbd8192-2c9a-42fe-acef-417d148934ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E9346FAA0>]}
[0m12:28:37.607347 [info ] [MainThread]: 
[0m12:28:37.609354 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m12:28:37.613349 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m12:28:37.639081 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m12:28:37.640605 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m12:28:37.641587 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:28:37.723416 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m12:28:37.725019 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m12:28:37.726019 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m12:28:37.740629 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m12:28:37.744586 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m12:28:37.746589 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m12:28:37.760752 [debug] [MainThread]: Using postgres connection "master"
[0m12:28:37.762766 [debug] [MainThread]: On master: BEGIN
[0m12:28:37.764219 [debug] [MainThread]: Opening a new connection, currently in state init
[0m12:28:37.831481 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m12:28:37.832417 [debug] [MainThread]: Using postgres connection "master"
[0m12:28:37.833438 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m12:28:37.847396 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m12:28:37.850082 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2bbd8192-2c9a-42fe-acef-417d148934ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E9329B800>]}
[0m12:28:37.851598 [debug] [MainThread]: On master: ROLLBACK
[0m12:28:37.853252 [debug] [MainThread]: On master: Close
[0m12:28:37.855599 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m12:28:37.857600 [info ] [MainThread]: 
[0m12:28:37.864911 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_month_13
[0m12:28:37.866925 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_month_13'
[0m12:28:37.867914 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_month_13
[0m12:28:37.900329 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_month_13"
[0m12:28:37.905547 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_month_13 (compile): 12:28:37.868915 => 12:28:37.904548
[0m12:28:37.907551 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_month_13
[0m12:28:37.910182 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_month_13 (execute): 12:28:37.908548 => 12:28:37.909549
[0m12:28:37.913713 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_month_13
[0m12:28:37.916707 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:28:37.918707 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m12:28:37.919744 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_month_13' was properly closed.
[0m12:28:37.921845 [debug] [MainThread]: Command end result
[0m12:28:37.937335 [info ] [MainThread]: Compiled node 'pageview_month_13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`pageview_month_13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
        ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
        UNION ALL SELECT ''Others''
        ),
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',order_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        ),
        
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN userneeds IN (', tag_statement_first, ') THEN  userneeds
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN userneeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    
    categories_second AS (
        ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
        UNION ALL SELECT ''Others''
        ),
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN Categories IN (',  tag_statement_second, ') THEN Categories
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories_second,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile_second
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories_second AS cat_second, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile_second, ''}''), '']'') AS series_second
			FROM pivoted_data_second
			group by label,cat_second,hint
		), 
    
    
    categories_third AS (
        ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
        UNION ALL SELECT ''Others''
        ),
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Tags IN (', tag_statement_third, ') THEN  Tags
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.split_tags_test p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN Tags IN (',  tag_statement_third, ') THEN Tags
                    ELSE ''Others''
                END AS tag
            FROM prod.split_tags_test s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories_third,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile_third
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories_third AS cat_third, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile_third, ''}''), '']'') AS series_third
			FROM pivoted_data_third
			group by label,cat_third,hint
		)
    
        select * from final
        union all
        select * from final_second
        union all
        select * from final_third
    ');

    PREPARE dynamic_query FROM @sql_query;
    EXECUTE dynamic_query;
    DEALLOCATE PREPARE dynamic_query;
[0m12:28:37.951607 [debug] [MainThread]: Command `dbt compile` succeeded at 12:28:37.950534 after 2.10 seconds
[0m12:28:37.953532 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E92EF6960>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E92EF7B30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E92EF7860>]}
[0m12:28:37.955530 [debug] [MainThread]: Flushing usage events
[0m11:37:16.904789 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026E6C683E30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026E6C681880>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026E6C682E10>]}


============================== 11:37:16.913358 | bd36351a-b85c-4e40-aa35-0d42d704a2ca ==============================
[0m11:37:16.913358 [info ] [MainThread]: Running with dbt=1.7.13
[0m11:37:16.915388 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt compile -s pageview_month_13', 'send_anonymous_usage_stats': 'True'}
[0m11:37:17.492013 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'bd36351a-b85c-4e40-aa35-0d42d704a2ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026E6C7F7860>]}
[0m11:37:17.661524 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'bd36351a-b85c-4e40-aa35-0d42d704a2ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026E6C698BF0>]}
[0m11:37:17.667068 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m11:37:17.707775 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m11:37:19.401535 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m11:37:19.402536 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_month_13.sql
[0m11:37:19.659973 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'bd36351a-b85c-4e40-aa35-0d42d704a2ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026E6CB49460>]}
[0m11:37:19.710321 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'bd36351a-b85c-4e40-aa35-0d42d704a2ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026E6CA293D0>]}
[0m11:37:19.713324 [info ] [MainThread]: Found 6 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m11:37:19.716338 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bd36351a-b85c-4e40-aa35-0d42d704a2ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026E6CBC3230>]}
[0m11:37:19.722957 [info ] [MainThread]: 
[0m11:37:19.725965 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m11:37:19.731686 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m11:37:19.770393 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:37:19.772507 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m11:37:19.773526 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:37:19.899140 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m11:37:19.900697 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:37:19.902259 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m11:37:19.953153 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m11:37:19.958148 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m11:37:19.959975 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m11:37:19.974800 [debug] [MainThread]: Using postgres connection "master"
[0m11:37:19.976816 [debug] [MainThread]: On master: BEGIN
[0m11:37:19.977814 [debug] [MainThread]: Opening a new connection, currently in state init
[0m11:37:20.086508 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m11:37:20.088554 [debug] [MainThread]: Using postgres connection "master"
[0m11:37:20.091925 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m11:37:20.113792 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m11:37:20.116791 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bd36351a-b85c-4e40-aa35-0d42d704a2ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026E6CA2BFE0>]}
[0m11:37:20.118794 [debug] [MainThread]: On master: ROLLBACK
[0m11:37:20.119791 [debug] [MainThread]: On master: Close
[0m11:37:20.122863 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:37:20.124803 [info ] [MainThread]: 
[0m11:37:20.135268 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_month_13
[0m11:37:20.138267 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_month_13'
[0m11:37:20.139274 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_month_13
[0m11:37:20.184929 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_month_13"
[0m11:37:20.189599 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_month_13 (compile): 11:37:20.140264 => 11:37:20.188752
[0m11:37:20.192726 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_month_13
[0m11:37:20.194725 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_month_13 (execute): 11:37:20.193728 => 11:37:20.193728
[0m11:37:20.199729 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_month_13
[0m11:37:20.202329 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:37:20.203709 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m11:37:20.204342 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_month_13' was properly closed.
[0m11:37:20.206341 [debug] [MainThread]: Command end result
[0m11:37:20.226293 [info ] [MainThread]: Compiled node 'pageview_month_13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`pageview_month_13_dbt_test`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
        ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
        UNION ALL SELECT ''Others''
        ),
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',order_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        ),
        
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN userneeds IN (', tag_statement_first, ') THEN  userneeds
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN userneeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    
    categories_second AS (
        ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
        UNION ALL SELECT ''Others''
        ),
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN Categories IN (',  tag_statement_second, ') THEN Categories
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories_second,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile_second
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories_second AS cat_second, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile_second, ''}''), '']'') AS series_second
			FROM pivoted_data_second
			group by label,cat_second,hint
		), 
    
    
    categories_third AS (
        ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
        UNION ALL SELECT ''Others''
        ),
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Tags IN (', tag_statement_third, ') THEN  Tags
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.split_tags_test p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN Tags IN (',  tag_statement_third, ') THEN Tags
                    ELSE ''Others''
                END AS tag
            FROM prod.split_tags_test s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories_third,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile_third
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories_third AS cat_third, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile_third, ''}''), '']'') AS series_third
			FROM pivoted_data_third
			group by label,cat_third,hint
		)
    
        select * from final
        union all
        select * from final_second
        union all
        select * from final_third
    ');

    PREPARE dynamic_query FROM @sql_query;
    EXECUTE dynamic_query;
    DEALLOCATE PREPARE dynamic_query;
    END
[0m11:37:20.252463 [debug] [MainThread]: Command `dbt compile` succeeded at 11:37:20.251372 after 3.71 seconds
[0m11:37:20.254477 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026E6C4CEBD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026E6C7661B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026E6CC3B410>]}
[0m11:37:20.256649 [debug] [MainThread]: Flushing usage events
[0m17:29:49.906540 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012F6966F6D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012F69657950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012F6936A450>]}


============================== 17:29:49.919503 | 52faf989-b6a6-42b9-91ba-55bd91bf7585 ==============================
[0m17:29:49.919503 [info ] [MainThread]: Running with dbt=1.8.1
[0m17:29:49.922189 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\DBT\\DBT_Transformation', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'E:\\DBT\\DBT_Transformation\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s pageview_month_13', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:29:50.479194 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '52faf989-b6a6-42b9-91ba-55bd91bf7585', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012F699FA8D0>]}
[0m17:29:50.568953 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '52faf989-b6a6-42b9-91ba-55bd91bf7585', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012F66940ED0>]}
[0m17:29:50.571945 [info ] [MainThread]: Registered adapter: postgres=1.8.0
[0m17:29:50.613994 [debug] [MainThread]: checksum: ebc509fb14e151ea268e89b60fd5abf912ed99129f87516462718fa2f14f4838, vars: {}, profile: , target: , version: 1.8.1
[0m17:29:50.762359 [info ] [MainThread]: Unable to do partial parsing because of a version mismatch
[0m17:29:50.764350 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '52faf989-b6a6-42b9-91ba-55bd91bf7585', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012F67402D50>]}
[0m17:29:54.385959 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '52faf989-b6a6-42b9-91ba-55bd91bf7585', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012F69652990>]}
[0m17:29:54.664395 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '52faf989-b6a6-42b9-91ba-55bd91bf7585', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012F69CF8390>]}
[0m17:29:54.666689 [info ] [MainThread]: Found 6 models, 413 macros
[0m17:29:54.668947 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '52faf989-b6a6-42b9-91ba-55bd91bf7585', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012F69ACBC10>]}
[0m17:29:54.673851 [info ] [MainThread]: 
[0m17:29:54.676843 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m17:29:54.689434 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m17:29:59.133022 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:29:59.134018 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m17:29:59.136028 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:29:59.237289 [debug] [ThreadPool]: Postgres adapter: Got a retryable error when attempting to open a postgres connection.
1 attempts remaining. Retrying in 0 seconds.
Error:
connection to server at "localhost" (::1), port 5432 failed: FATAL:  password authentication failed for user "postgres"

[0m17:29:59.465373 [debug] [ThreadPool]: Postgres adapter: Error running SQL: BEGIN
[0m17:29:59.468367 [debug] [ThreadPool]: Postgres adapter: Rolling back transaction.
[0m17:29:59.471357 [debug] [ThreadPool]: Postgres adapter: Error running SQL: macro list_relations_without_caching
[0m17:29:59.473352 [debug] [ThreadPool]: Postgres adapter: Rolling back transaction.
[0m17:29:59.475343 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: No close available on handle
[0m17:29:59.479333 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:29:59.481383 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m17:29:59.483385 [error] [MainThread]: Encountered an error:
Database Error
  connection to server at "localhost" (::1), port 5432 failed: FATAL:  password authentication failed for user "postgres"
  
[0m17:29:59.493360 [debug] [MainThread]: Command `dbt compile` failed at 17:29:59.492361 after 9.73 seconds
[0m17:29:59.495355 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012F696919D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012F69C8F090>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012F69693F90>]}
[0m17:29:59.497348 [debug] [MainThread]: Flushing usage events
[0m17:30:36.116111 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261B5479BD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261B8158750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261B8186F90>]}


============================== 17:30:36.124091 | e82ac43b-14b9-4ebd-ac0b-068ffbba8839 ==============================
[0m17:30:36.124091 [info ] [MainThread]: Running with dbt=1.8.1
[0m17:30:36.126336 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\DBT\\DBT_Transformation', 'version_check': 'True', 'debug': 'False', 'log_path': 'E:\\DBT\\DBT_Transformation\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s pageview_month_13', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:30:36.492586 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e82ac43b-14b9-4ebd-ac0b-068ffbba8839', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261B847F790>]}
[0m17:30:36.604676 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e82ac43b-14b9-4ebd-ac0b-068ffbba8839', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261B5470ED0>]}
[0m17:30:36.606793 [info ] [MainThread]: Registered adapter: postgres=1.8.0
[0m17:30:36.622822 [debug] [MainThread]: checksum: ebc509fb14e151ea268e89b60fd5abf912ed99129f87516462718fa2f14f4838, vars: {}, profile: , target: , version: 1.8.1
[0m17:30:36.905138 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m17:30:36.907134 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m17:30:36.963982 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e82ac43b-14b9-4ebd-ac0b-068ffbba8839', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261B865DA50>]}
[0m17:30:37.163264 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e82ac43b-14b9-4ebd-ac0b-068ffbba8839', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261B85FF6D0>]}
[0m17:30:37.165973 [info ] [MainThread]: Found 6 models, 413 macros
[0m17:30:37.168962 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e82ac43b-14b9-4ebd-ac0b-068ffbba8839', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261B8520150>]}
[0m17:30:37.173949 [info ] [MainThread]: 
[0m17:30:37.177385 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m17:30:37.190905 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m17:30:37.378575 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:30:37.379572 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m17:30:37.380671 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:30:37.610364 [debug] [ThreadPool]: Postgres adapter: Got a retryable error when attempting to open a postgres connection.
1 attempts remaining. Retrying in 0 seconds.
Error:
connection to server at "localhost" (::1), port 5432 failed: FATAL:  database "dbt_project_test_kasper" does not exist

[0m17:30:37.746993 [debug] [ThreadPool]: Postgres adapter: Error running SQL: BEGIN
[0m17:30:37.750055 [debug] [ThreadPool]: Postgres adapter: Rolling back transaction.
[0m17:30:37.753209 [debug] [ThreadPool]: Postgres adapter: Error running SQL: macro list_relations_without_caching
[0m17:30:37.756967 [debug] [ThreadPool]: Postgres adapter: Rolling back transaction.
[0m17:30:37.759959 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: No close available on handle
[0m17:30:37.763968 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:30:37.766125 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m17:30:37.768937 [error] [MainThread]: Encountered an error:
Database Error
  connection to server at "localhost" (::1), port 5432 failed: FATAL:  database "dbt_project_test_kasper" does not exist
  
[0m17:30:37.774914 [debug] [MainThread]: Command `dbt compile` failed at 17:30:37.774490 after 1.82 seconds
[0m17:30:37.776909 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261B81C3A90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261B8B64290>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261B87CF4D0>]}
[0m17:30:37.778903 [debug] [MainThread]: Flushing usage events
[0m17:30:45.578850 [debug] [MainThread]: Error sending anonymous usage statistics. Disabling tracking for this execution. If you wish to permanently disable tracking, see: https://docs.getdbt.com/reference/global-configs#send-anonymous-usage-stats.
[0m17:31:51.128776 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDE69EB290>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEA708750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEA70B910>]}


============================== 17:31:51.136783 | f45055ab-8d74-485f-b7e0-4a8e93f9a37f ==============================
[0m17:31:51.136783 [info ] [MainThread]: Running with dbt=1.8.1
[0m17:31:51.139171 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\DBT\\DBT_Transformation', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'E:\\DBT\\DBT_Transformation\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s pageview_month_13', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:31:51.451534 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f45055ab-8d74-485f-b7e0-4a8e93f9a37f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEA74E3D0>]}
[0m17:31:51.547477 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f45055ab-8d74-485f-b7e0-4a8e93f9a37f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDE7A310D0>]}
[0m17:31:51.550479 [info ] [MainThread]: Registered adapter: postgres=1.8.0
[0m17:31:51.568609 [debug] [MainThread]: checksum: ebc509fb14e151ea268e89b60fd5abf912ed99129f87516462718fa2f14f4838, vars: {}, profile: , target: , version: 1.8.1
[0m17:31:51.809931 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m17:31:51.810927 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m17:31:51.860023 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f45055ab-8d74-485f-b7e0-4a8e93f9a37f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEABC0150>]}
[0m17:31:52.006414 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f45055ab-8d74-485f-b7e0-4a8e93f9a37f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEA74FC90>]}
[0m17:31:52.008501 [info ] [MainThread]: Found 6 models, 413 macros
[0m17:31:52.011006 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f45055ab-8d74-485f-b7e0-4a8e93f9a37f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEAA10610>]}
[0m17:31:52.015990 [info ] [MainThread]: 
[0m17:31:52.017988 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m17:31:52.027965 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m17:31:52.181705 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:31:52.182702 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m17:31:52.183714 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:31:52.249141 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m17:31:52.249881 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:31:52.250925 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.8.1", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m17:31:52.267655 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m17:31:52.270649 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m17:31:52.271882 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m17:31:52.282616 [debug] [MainThread]: Using postgres connection "master"
[0m17:31:52.283614 [debug] [MainThread]: On master: BEGIN
[0m17:31:52.284717 [debug] [MainThread]: Opening a new connection, currently in state init
[0m17:31:52.521783 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m17:31:52.523715 [debug] [MainThread]: Using postgres connection "master"
[0m17:31:52.526665 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.1", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m17:31:52.560116 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m17:31:52.565102 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f45055ab-8d74-485f-b7e0-4a8e93f9a37f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEA7870D0>]}
[0m17:31:52.569087 [debug] [MainThread]: On master: ROLLBACK
[0m17:31:52.571469 [debug] [MainThread]: On master: Close
[0m17:31:52.575069 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:31:52.579062 [info ] [MainThread]: 
[0m17:31:52.592756 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_month_13
[0m17:31:52.597742 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_month_13'
[0m17:31:52.601725 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_month_13
[0m17:31:52.673532 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_month_13"
[0m17:31:52.676528 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_month_13
[0m17:31:52.680512 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_month_13
[0m17:31:52.684506 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:31:52.686500 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m17:31:52.687631 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_month_13' was properly closed.
[0m17:31:52.690489 [debug] [MainThread]: Command end result
[0m17:31:52.781242 [info ] [MainThread]: Compiled node 'pageview_month_13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`pageview_month_13_dbt_test`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
        ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
        UNION ALL SELECT ''Others''
        ),
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',order_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        ),
        
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN userneeds IN (', tag_statement_first, ') THEN  userneeds
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN userneeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    
    categories_second AS (
        ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
        UNION ALL SELECT ''Others''
        ),
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN Categories IN (',  tag_statement_second, ') THEN Categories
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories_second,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile_second
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories_second AS cat_second, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile_second, ''}''), '']'') AS series_second
			FROM pivoted_data_second
			group by label,cat_second,hint
		), 
    
    
    categories_third AS (
        ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
        UNION ALL SELECT ''Others''
        ),
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Tags IN (', tag_statement_third, ') THEN  Tags
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.split_tags_test p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN Tags IN (',  tag_statement_third, ') THEN Tags
                    ELSE ''Others''
                END AS tag
            FROM prod.split_tags_test s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories_third,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile_third
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories_third AS cat_third, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile_third, ''}''), '']'') AS series_third
			FROM pivoted_data_third
			group by label,cat_third,hint
		)
    
        select * from final
        union all
        select * from final_second
        union all
        select * from final_third
    ');

    PREPARE dynamic_query FROM @sql_query;
    EXECUTE dynamic_query;
    DEALLOCATE PREPARE dynamic_query;
    END
[0m17:31:52.800196 [debug] [MainThread]: Command `dbt compile` succeeded at 17:31:52.799433 after 1.78 seconds
[0m17:31:52.802189 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEA773E10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEA4D1C90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDE45E1BD0>]}
[0m17:31:52.803189 [debug] [MainThread]: Flushing usage events
[0m18:01:36.367986 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219FD0AD8D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219FD06B910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219FD0686D0>]}


============================== 18:01:36.373967 | 323cf077-7634-416a-bf63-adb557ed0605 ==============================
[0m18:01:36.373967 [info ] [MainThread]: Running with dbt=1.8.1
[0m18:01:36.375963 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'E:\\DBT\\DBT_Transformation', 'log_path': 'E:\\DBT\\DBT_Transformation\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_ytd_13', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:01:36.645680 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '323cf077-7634-416a-bf63-adb557ed0605', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219FD3E83D0>]}
[0m18:01:36.720480 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '323cf077-7634-416a-bf63-adb557ed0605', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219FA380E10>]}
[0m18:01:36.723322 [info ] [MainThread]: Registered adapter: postgres=1.8.0
[0m18:01:36.736272 [debug] [MainThread]: checksum: ebc509fb14e151ea268e89b60fd5abf912ed99129f87516462718fa2f14f4838, vars: {}, profile: , target: , version: 1.8.1
[0m18:01:36.909753 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m18:01:36.910751 [debug] [MainThread]: Partial parsing: added file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_ytd_13.sql
[0m18:01:37.211944 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '323cf077-7634-416a-bf63-adb557ed0605', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219FD083590>]}
[0m18:01:37.337317 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '323cf077-7634-416a-bf63-adb557ed0605', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219FD7FE410>]}
[0m18:01:37.339312 [info ] [MainThread]: Found 7 models, 413 macros
[0m18:01:37.340011 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '323cf077-7634-416a-bf63-adb557ed0605', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219FD5978D0>]}
[0m18:01:37.343006 [info ] [MainThread]: 
[0m18:01:37.343622 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:01:37.350889 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:01:37.472272 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:01:37.473269 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:01:37.474267 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:01:37.661014 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:01:37.662012 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:01:37.663009 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.8.1", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:01:37.676970 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:01:37.680960 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:01:37.681972 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:01:37.689937 [debug] [MainThread]: Using postgres connection "master"
[0m18:01:37.690934 [debug] [MainThread]: On master: BEGIN
[0m18:01:37.690934 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:01:37.742168 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:01:37.743164 [debug] [MainThread]: Using postgres connection "master"
[0m18:01:37.744186 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.1", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:01:37.755131 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:01:37.757126 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '323cf077-7634-416a-bf63-adb557ed0605', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219FD734450>]}
[0m18:01:37.758126 [debug] [MainThread]: On master: ROLLBACK
[0m18:01:37.758126 [debug] [MainThread]: On master: Close
[0m18:01:37.760120 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:01:37.761117 [info ] [MainThread]: 
[0m18:01:37.767134 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_ytd_13
[0m18:01:37.768096 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_ytd_13'
[0m18:01:37.769095 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_ytd_13
[0m18:01:37.797020 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_ytd_13"
[0m18:01:37.799015 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_ytd_13
[0m18:01:37.801008 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_ytd_13
[0m18:01:37.803005 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:01:37.804002 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:01:37.804002 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_ytd_13' was properly closed.
[0m18:01:37.806000 [debug] [MainThread]: Command end result
[0m18:01:37.849924 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_ytd_13' is:








CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_month_13_dbt_test`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_ytd_article_published as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN userneeds like "%Opdater mig%" then "Opdater mig"
			    WHEN userneeds like "%Forbind mig%" then "Forbind mig"
			    WHEN userneeds like "%Help mig med at forsta%" then "Hjælp mig med at forstå"
			    WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
			    WHEN userneeds like "%Underhold mig%" then "Underhold mig"
			    WHEN userneeds like "%Inspirer migg%" then "Inspirer mig"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date between MAKEDATE(EXTRACT(YEAR FROM CURDATE()),1)  and  DATE_SUB(cast(NOW() as date), INTERVAL 1 DAY)
        
        AND siteid = ', site, '),
    last_ytd_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_ytd_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_ytd_article_published  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article as(
		select siteid as siteid,tags,sum(val) as agg_sum from
        cta_per_article
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_ytd_article_published l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data
			group by 1,2
		),
        hits_by_tags as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts h
			join total_hits t on h.siteid=t.siteid
			join last_ytd_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data
		group by 1,2,3
		),
        categories as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d
		),
        json_data as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories
		), 
    
    last_ytd_article_published_second as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Categories like "%Nyhed%" then "Nyhed"
			    WHEN Categories like "%Medlemsinfo%" then "Medlemsinfo"
			    WHEN Categories like "%Reportage%" then "Reportage"
			    WHEN Categories like "%Artikel%" then "Artikel"
			    WHEN Categories like "%Det ku ske for dig%" then "Det ku ske for dig"
			    WHEN Categories like "%Jeg mener%" then "Jeg mener"
			    WHEN Categories like "%Videoartikel%" then "Videoartikel"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date between MAKEDATE(EXTRACT(YEAR FROM CURDATE()),1)  and  DATE_SUB(cast(NOW() as date), INTERVAL 1 DAY)
        
        AND siteid = ', site, '),
    last_ytd_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_ytd_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_second as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_ytd_article_published_second  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_second as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_second  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_second as(
		select siteid as siteid,tags,sum(val) as agg_sum from
        cta_per_article_second
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_second as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_ytd_article_published_second l
		join cta_per_article_second a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_second as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_second
			group by 1,2
		),
        hits_by_tags_second as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_second
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits_second as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_second
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data_second as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_second h
			join total_hits_second t on h.siteid=t.siteid
			join last_ytd_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d_second as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_second
		group by 1,2,3
		),
        categories_second as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_second
		),
        json_data_second as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_second
		), 
    
    last_ytd_article_published_third as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Tags like "%Slagterindustri%" then "Slagterindustri"
			    WHEN Tags like "%Fødevareindustri%" then "Fødevareindustri"
			    WHEN Tags like "%Mejeri%" then "Mejeri"
			    WHEN Tags like "%Butik%" then "Butik"
			    WHEN Tags like "%Alle brancher%" then "Alle brancher"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date between MAKEDATE(EXTRACT(YEAR FROM CURDATE()),1)  and  DATE_SUB(cast(NOW() as date), INTERVAL 1 DAY)
        
        AND siteid = ', site, '),
    last_ytd_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_ytd_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_third as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_ytd_article_published_third  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_third as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_third  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_third as(
		select siteid as siteid,tags,sum(val) as agg_sum from
        cta_per_article_third
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_third as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_ytd_article_published_third l
		join cta_per_article_third a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_third as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_third
			group by 1,2
		),
        hits_by_tags_third as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_third
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits_third as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_third
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data_third as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_third h
			join total_hits_third t on h.siteid=t.siteid
			join last_ytd_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d_third as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_third
		group by 1,2,3
		),
        categories_third as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_third
		),
        json_data_third as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_third
		)
    

    SELECT 
		CONCAT(
        ''{'',
            ''"site":'',jd.siteid,'','',
            ''"data": {'',
                ''"label": "'', jd.lab, ''",'',
                ''"categories": ['', jd.cat, ''],'',
                ''"series": ['', jd.series, '']'',
                '',"defaultTitle":"',dtitle,'"'',
                '',"additional":[ ''
                
                ,''{'',
                ''"title":"',title1,'",'',
                ''"data": {'',
                ''"label": "'',json_data_second.lab, ''",'',
                ''"categories": ['', json_data_second.cat, ''],'',
                ''"series": ['', json_data_second.series, '']'',
                ''}}''
                
                , '',''
                
                
                ,''{'',
                ''"title":"',title2,'",'',
                ''"data": {'',
                ''"label": "'',json_data_third.lab, ''",'',
                ''"categories": ['', json_data_third.cat, ''],'',
                ''"series": ['', json_data_third.series, '']'',
                ''}}''
                
                
        '']}}''
    
			) as json_data
		  FROM json_data jd
          
          CROSS join json_data_second
          
          CROSS join json_data_third
          ;
[0m18:01:37.872817 [debug] [MainThread]: Command `dbt compile` succeeded at 18:01:37.872817 after 1.59 seconds
[0m18:01:37.873813 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219F6BBC2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219F6BF7C50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219FD441210>]}
[0m18:01:37.874813 [debug] [MainThread]: Flushing usage events
[0m18:01:43.732943 [debug] [MainThread]: Error sending anonymous usage statistics. Disabling tracking for this execution. If you wish to permanently disable tracking, see: https://docs.getdbt.com/reference/global-configs#send-anonymous-usage-stats.
[0m18:28:54.126793 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229C1AF9250>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229C1ABB350>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229C1ABB9D0>]}


============================== 18:28:54.135770 | e7fb4476-6d48-48e9-b5a0-c83b5d3f33db ==============================
[0m18:28:54.135770 [info ] [MainThread]: Running with dbt=1.8.1
[0m18:28:54.137764 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'E:\\DBT\\DBT_Transformation', 'log_path': 'E:\\DBT\\DBT_Transformation\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_11', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:28:54.472403 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e7fb4476-6d48-48e9-b5a0-c83b5d3f33db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229C1DDF250>]}
[0m18:28:54.554184 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e7fb4476-6d48-48e9-b5a0-c83b5d3f33db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229BEDD0E90>]}
[0m18:28:54.556542 [info ] [MainThread]: Registered adapter: postgres=1.8.0
[0m18:28:54.571771 [debug] [MainThread]: checksum: ebc509fb14e151ea268e89b60fd5abf912ed99129f87516462718fa2f14f4838, vars: {}, profile: , target: , version: 1.8.1
[0m18:28:54.786327 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 1 files changed.
[0m18:28:54.787324 [debug] [MainThread]: Partial parsing: added file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_11.sql
[0m18:28:54.788321 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_ytd_13.sql
[0m18:28:55.221165 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e7fb4476-6d48-48e9-b5a0-c83b5d3f33db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229C1EFA990>]}
[0m18:28:55.364773 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e7fb4476-6d48-48e9-b5a0-c83b5d3f33db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229C1EF8C50>]}
[0m18:28:55.365766 [info ] [MainThread]: Found 8 models, 413 macros
[0m18:28:55.366761 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e7fb4476-6d48-48e9-b5a0-c83b5d3f33db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229C2213C10>]}
[0m18:28:55.368759 [info ] [MainThread]: 
[0m18:28:55.370241 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:28:55.377228 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:28:55.512941 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:28:55.513938 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:28:55.515932 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:28:55.580581 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:28:55.581582 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:28:55.582578 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.8.1", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:28:55.592789 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:28:55.595765 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:28:55.596763 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:28:55.603745 [debug] [MainThread]: Using postgres connection "master"
[0m18:28:55.604744 [debug] [MainThread]: On master: BEGIN
[0m18:28:55.604744 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:28:55.785422 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:28:55.786420 [debug] [MainThread]: Using postgres connection "master"
[0m18:28:55.787416 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.1", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:28:55.800654 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:28:55.802657 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e7fb4476-6d48-48e9-b5a0-c83b5d3f33db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229C1DA9450>]}
[0m18:28:55.803662 [debug] [MainThread]: On master: ROLLBACK
[0m18:28:55.804642 [debug] [MainThread]: On master: Close
[0m18:28:55.805641 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:28:55.808632 [info ] [MainThread]: 
[0m18:28:55.814615 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_11
[0m18:28:55.815612 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_11'
[0m18:28:55.816610 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_11
[0m18:28:55.852513 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_11"
[0m18:28:55.854509 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_11
[0m18:28:55.857502 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_11
[0m18:28:55.859495 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:28:55.860493 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:28:55.861491 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_11' was properly closed.
[0m18:28:55.862488 [debug] [MainThread]: Command end result
[0m18:28:55.919336 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_month_11' is:








CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_month_11_dbt_test`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
    IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_ytd_article_published as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN userneeds like "%Opdater mig%" then "Opdater mig"
			    WHEN userneeds like "%Forbind mig%" then "Forbind mig"
			    WHEN userneeds like "%Help mig med at forsta%" then "Hjælp mig med at forstå"
			    WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
			    WHEN userneeds like "%Underhold mig%" then "Underhold mig"
			    WHEN userneeds like "%Inspirer migg%" then "Inspirer mig"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date between MAKEDATE(EXTRACT(YEAR FROM CURDATE()),1)  and  DATE_SUB(cast(NOW() as date), INTERVAL 1 DAY)
        
        AND siteid = ', site, '
AND (
    (tags NOT LIKE "%billedkunst%" 
    AND tags NOT LIKE "%børnehaveklassen%" 
    AND tags NOT LIKE "%dsa%" 
    AND tags NOT LIKE "%engelsk%" 
    AND tags NOT LIKE "%håndværk og design%" 
    AND tags NOT LIKE "%idræt%" 
    AND tags NOT LIKE "%kulturfag%" 
    AND tags NOT LIKE "%lærersenior%" 
    AND tags NOT LIKE "%lærerstuderende%" 
    AND tags NOT LIKE "%madkundskab%" 
    AND tags NOT LIKE "%musik%" 
    AND tags   NOT LIKE "%naturfag%" 
    AND tags   NOT LIKE "%plc%" 
    AND tags   NOT LIKE "%ppr%" 
    AND tags  NOT LIKE "%praktik%" 
    AND tags  NOT LIKE "%sosu%" 
    AND tags  NOT LIKE "%tyskfransk%" 
    AND tags NOT LIKE "%uu%")
    OR 
    (tags LIKE "%dansk%" 
    OR tags LIKE "%it,%" 
    OR tags LIKE ",%it,%" 
    OR tags LIKE "%,it%" 
    OR tags LIKE "%matematik%" 
    OR tags LIKE "%specialpædagogik%" 
    OR tags LIKE "%Skolepolitik%" 
    OR tags LIKE "%DLF%" 
    OR tags LIKE "%Skoleledelse%" 
    OR tags LIKE "%Psykisk arbejdsmiljø%" 
    OR tags LIKE "%Forskning%"
    )
    OR
    (tags NOT LIKE "%billedkunst%" 
    AND tags NOT LIKE "%børnehaveklassen%" 
    AND tags NOT LIKE "%dsa%" 
    AND tags NOT LIKE "%engelsk%" 
    AND tags NOT LIKE "%håndværk og design%" 
    AND tags NOT LIKE "%idræt%" 
    AND tags NOT LIKE "%kulturfag%" 
    AND tags NOT LIKE "%lærersenior%" 
    AND tags NOT LIKE "%lærerstuderende%" 
    AND tags NOT LIKE "%madkundskab%" 
    AND tags NOT LIKE "%musik%" 
    AND tags NOT LIKE "%naturfag%" 
    AND tags NOT LIKE "%plc%" 
    AND tags NOT LIKE "%ppr%" 
    AND tags NOT LIKE "%praktik%" 
    AND tags NOT LIKE "%sosu%" 
    AND tags NOT LIKE "%tyskfransk%" 
    AND tags NOT LIKE "%uu%")
    AND 
    (tags NOT LIKE "%dansk%" 
    AND tags NOT LIKE "%it,%" 
    AND tags NOT LIKE ",%it,%" 
    AND tags NOT LIKE "%,it%" 
    AND tags NOT LIKE "%matematik%" 
    AND tags NOT LIKE "%specialpædagogik%" 
    AND tags NOT LIKE "%Skolepolitik%" 
    AND tags NOT LIKE "%DLF%" 
    AND tags NOT LIKE "%Skoleledelse%" 
    AND tags NOT LIKE "%Psykisk arbejdsmiljø%" 
    AND tags NOT LIKE "%Forskning%")
)
),
    last_ytd_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_ytd_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_ytd_article_published  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article as(
		select siteid as siteid,tags,sum(val) as agg_sum from
        cta_per_article
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_ytd_article_published l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data
			group by 1,2
		),
        hits_by_tags as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts h
			join total_hits t on h.siteid=t.siteid
			join last_ytd_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data
		group by 1,2,3
		),
        categories as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d
		),
        json_data as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories
		), 
    
    last_ytd_article_published_second as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Categories like "%Nyhed%" then "Nyhed"
			    WHEN Categories like "%Medlemsinfo%" then "Medlemsinfo"
			    WHEN Categories like "%Reportage%" then "Reportage"
			    WHEN Categories like "%Artikel%" then "Artikel"
			    WHEN Categories like "%Det ku ske for dig%" then "Det ku ske for dig"
			    WHEN Categories like "%Jeg mener%" then "Jeg mener"
			    WHEN Categories like "%Videoartikel%" then "Videoartikel"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date between MAKEDATE(EXTRACT(YEAR FROM CURDATE()),1)  and  DATE_SUB(cast(NOW() as date), INTERVAL 1 DAY)
        
        AND siteid = ', site, '
AND (
    (tags NOT LIKE "%billedkunst%" 
    AND tags NOT LIKE "%børnehaveklassen%" 
    AND tags NOT LIKE "%dsa%" 
    AND tags NOT LIKE "%engelsk%" 
    AND tags NOT LIKE "%håndværk og design%" 
    AND tags NOT LIKE "%idræt%" 
    AND tags NOT LIKE "%kulturfag%" 
    AND tags NOT LIKE "%lærersenior%" 
    AND tags NOT LIKE "%lærerstuderende%" 
    AND tags NOT LIKE "%madkundskab%" 
    AND tags NOT LIKE "%musik%" 
    AND tags   NOT LIKE "%naturfag%" 
    AND tags   NOT LIKE "%plc%" 
    AND tags   NOT LIKE "%ppr%" 
    AND tags  NOT LIKE "%praktik%" 
    AND tags  NOT LIKE "%sosu%" 
    AND tags  NOT LIKE "%tyskfransk%" 
    AND tags NOT LIKE "%uu%")
    OR 
    (tags LIKE "%dansk%" 
    OR tags LIKE "%it,%" 
    OR tags LIKE ",%it,%" 
    OR tags LIKE "%,it%" 
    OR tags LIKE "%matematik%" 
    OR tags LIKE "%specialpædagogik%" 
    OR tags LIKE "%Skolepolitik%" 
    OR tags LIKE "%DLF%" 
    OR tags LIKE "%Skoleledelse%" 
    OR tags LIKE "%Psykisk arbejdsmiljø%" 
    OR tags LIKE "%Forskning%"
    )
    OR
    (tags NOT LIKE "%billedkunst%" 
    AND tags NOT LIKE "%børnehaveklassen%" 
    AND tags NOT LIKE "%dsa%" 
    AND tags NOT LIKE "%engelsk%" 
    AND tags NOT LIKE "%håndværk og design%" 
    AND tags NOT LIKE "%idræt%" 
    AND tags NOT LIKE "%kulturfag%" 
    AND tags NOT LIKE "%lærersenior%" 
    AND tags NOT LIKE "%lærerstuderende%" 
    AND tags NOT LIKE "%madkundskab%" 
    AND tags NOT LIKE "%musik%" 
    AND tags NOT LIKE "%naturfag%" 
    AND tags NOT LIKE "%plc%" 
    AND tags NOT LIKE "%ppr%" 
    AND tags NOT LIKE "%praktik%" 
    AND tags NOT LIKE "%sosu%" 
    AND tags NOT LIKE "%tyskfransk%" 
    AND tags NOT LIKE "%uu%")
    AND 
    (tags NOT LIKE "%dansk%" 
    AND tags NOT LIKE "%it,%" 
    AND tags NOT LIKE ",%it,%" 
    AND tags NOT LIKE "%,it%" 
    AND tags NOT LIKE "%matematik%" 
    AND tags NOT LIKE "%specialpædagogik%" 
    AND tags NOT LIKE "%Skolepolitik%" 
    AND tags NOT LIKE "%DLF%" 
    AND tags NOT LIKE "%Skoleledelse%" 
    AND tags NOT LIKE "%Psykisk arbejdsmiljø%" 
    AND tags NOT LIKE "%Forskning%")
)
),
    last_ytd_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_ytd_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_second as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_ytd_article_published_second  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_second as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_second  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_second as(
		select siteid as siteid,tags,sum(val) as agg_sum from
        cta_per_article_second
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_second as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_ytd_article_published_second l
		join cta_per_article_second a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_second as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_second
			group by 1,2
		),
        hits_by_tags_second as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_second
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits_second as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_second
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data_second as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_second h
			join total_hits_second t on h.siteid=t.siteid
			join last_ytd_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d_second as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_second
		group by 1,2,3
		),
        categories_second as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_second
		),
        json_data_second as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_second
		), 
    
    last_ytd_article_published_third as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Tags like "%Slagterindustri%" then "Slagterindustri"
			    WHEN Tags like "%Fødevareindustri%" then "Fødevareindustri"
			    WHEN Tags like "%Mejeri%" then "Mejeri"
			    WHEN Tags like "%Butik%" then "Butik"
			    WHEN Tags like "%Alle brancher%" then "Alle brancher"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date between MAKEDATE(EXTRACT(YEAR FROM CURDATE()),1)  and  DATE_SUB(cast(NOW() as date), INTERVAL 1 DAY)
        
        AND siteid = ', site, '
AND (
    (tags NOT LIKE "%billedkunst%" 
    AND tags NOT LIKE "%børnehaveklassen%" 
    AND tags NOT LIKE "%dsa%" 
    AND tags NOT LIKE "%engelsk%" 
    AND tags NOT LIKE "%håndværk og design%" 
    AND tags NOT LIKE "%idræt%" 
    AND tags NOT LIKE "%kulturfag%" 
    AND tags NOT LIKE "%lærersenior%" 
    AND tags NOT LIKE "%lærerstuderende%" 
    AND tags NOT LIKE "%madkundskab%" 
    AND tags NOT LIKE "%musik%" 
    AND tags   NOT LIKE "%naturfag%" 
    AND tags   NOT LIKE "%plc%" 
    AND tags   NOT LIKE "%ppr%" 
    AND tags  NOT LIKE "%praktik%" 
    AND tags  NOT LIKE "%sosu%" 
    AND tags  NOT LIKE "%tyskfransk%" 
    AND tags NOT LIKE "%uu%")
    OR 
    (tags LIKE "%dansk%" 
    OR tags LIKE "%it,%" 
    OR tags LIKE ",%it,%" 
    OR tags LIKE "%,it%" 
    OR tags LIKE "%matematik%" 
    OR tags LIKE "%specialpædagogik%" 
    OR tags LIKE "%Skolepolitik%" 
    OR tags LIKE "%DLF%" 
    OR tags LIKE "%Skoleledelse%" 
    OR tags LIKE "%Psykisk arbejdsmiljø%" 
    OR tags LIKE "%Forskning%"
    )
    OR
    (tags NOT LIKE "%billedkunst%" 
    AND tags NOT LIKE "%børnehaveklassen%" 
    AND tags NOT LIKE "%dsa%" 
    AND tags NOT LIKE "%engelsk%" 
    AND tags NOT LIKE "%håndværk og design%" 
    AND tags NOT LIKE "%idræt%" 
    AND tags NOT LIKE "%kulturfag%" 
    AND tags NOT LIKE "%lærersenior%" 
    AND tags NOT LIKE "%lærerstuderende%" 
    AND tags NOT LIKE "%madkundskab%" 
    AND tags NOT LIKE "%musik%" 
    AND tags NOT LIKE "%naturfag%" 
    AND tags NOT LIKE "%plc%" 
    AND tags NOT LIKE "%ppr%" 
    AND tags NOT LIKE "%praktik%" 
    AND tags NOT LIKE "%sosu%" 
    AND tags NOT LIKE "%tyskfransk%" 
    AND tags NOT LIKE "%uu%")
    AND 
    (tags NOT LIKE "%dansk%" 
    AND tags NOT LIKE "%it,%" 
    AND tags NOT LIKE ",%it,%" 
    AND tags NOT LIKE "%,it%" 
    AND tags NOT LIKE "%matematik%" 
    AND tags NOT LIKE "%specialpædagogik%" 
    AND tags NOT LIKE "%Skolepolitik%" 
    AND tags NOT LIKE "%DLF%" 
    AND tags NOT LIKE "%Skoleledelse%" 
    AND tags NOT LIKE "%Psykisk arbejdsmiljø%" 
    AND tags NOT LIKE "%Forskning%")
)
),
    last_ytd_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_ytd_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_third as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_ytd_article_published_third  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_third as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_third  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_third as(
		select siteid as siteid,tags,sum(val) as agg_sum from
        cta_per_article_third
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_third as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_ytd_article_published_third l
		join cta_per_article_third a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_third as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_third
			group by 1,2
		),
        hits_by_tags_third as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_third
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits_third as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_third
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data_third as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_third h
			join total_hits_third t on h.siteid=t.siteid
			join last_ytd_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d_third as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_third
		group by 1,2,3
		),
        categories_third as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_third
		),
        json_data_third as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_third
		)
    

    SELECT 
		CONCAT(
        ''{'',
            ''"site":'',jd.siteid,'','',
            ''"data": {'',
                ''"label": "'', jd.lab, ''",'',
                ''"categories": ['', jd.cat, ''],'',
                ''"series": ['', jd.series, '']'',
                '',"defaultTitle":"',dtitle,'"'',
                '',"additional":[ ''
                
                ,''{'',
                ''"title":"',title1,'",'',
                ''"data": {'',
                ''"label": "'',json_data_second.lab, ''",'',
                ''"categories": ['', json_data_second.cat, ''],'',
                ''"series": ['', json_data_second.series, '']'',
                ''}}''
                
                , '',''
                
                
                ,''{'',
                ''"title":"',title2,'",'',
                ''"data": {'',
                ''"label": "'',json_data_third.lab, ''",'',
                ''"categories": ['', json_data_third.cat, ''],'',
                ''"series": ['', json_data_third.series, '']'',
                ''}}''
                
                
        '']}}''
    
			) as json_data
		  FROM json_data jd
          
          CROSS join json_data_second
          
          CROSS join json_data_third
          ;
[0m18:28:56.046994 [debug] [MainThread]: Command `dbt compile` succeeded at 18:28:56.046994 after 2.03 seconds
[0m18:28:56.050984 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229C1881C90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229BB5B7CD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229BB5B7C50>]}
[0m18:28:56.051980 [debug] [MainThread]: Flushing usage events
