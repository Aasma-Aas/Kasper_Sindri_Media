{"metadata": {"dbt_schema_version": "https://schemas.getdbt.com/dbt/run-results/v6.json", "dbt_version": "1.8.1", "generated_at": "2024-05-23T13:28:55.861491Z", "invocation_id": "e7fb4476-6d48-48e9-b5a0-c83b5d3f33db", "env": {}}, "results": [{"status": "success", "timing": [{"name": "compile", "started_at": "2024-05-23T13:28:55.817606Z", "completed_at": "2024-05-23T13:28:55.854509Z"}, {"name": "execute", "started_at": "2024-05-23T13:28:55.855506Z", "completed_at": "2024-05-23T13:28:55.855506Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.039893388748168945, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_11", "compiled": true, "compiled_code": "\n\n\n\n\n\n\n\nCREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_month_11_dbt_test`(\n\tIN site INT,\n    IN label_val VARCHAR(200),\n    IN hint_val text,\n    IN order_statement  VARCHAR(2000),\n\tIN order_statement_second VARCHAR(2000),\n    IN order_statement_third VARCHAR(2000),\n\tIN dtitle VARCHAR(200),\n    IN title1 VARCHAR(200),\n    IN title2 VARCHAR(200),\n    IN event_action VARCHAR(255)\n)\nBEGIN\n    SET @sql_query = CONCAT('\n    with \n    \n    last_ytd_article_published as\n    (\n        SELECT\n            siteid as siteid,\n            id,\n            date as fdate,\n\t\t    CASE\n\t\t\t    WHEN userneeds like \"%Opdater mig%\" then \"Opdater mig\"\n\t\t\t    WHEN userneeds like \"%Forbind mig%\" then \"Forbind mig\"\n\t\t\t    WHEN userneeds like \"%Help mig med at forsta%\" then \"Hj\u00e6lp mig med at forst\u00e5\"\n\t\t\t    WHEN userneeds like \"%Giv mig en fordel%\" then \"Giv mig en fordel\"\n\t\t\t    WHEN userneeds like \"%Underhold mig%\" then \"Underhold mig\"\n\t\t\t    WHEN userneeds like \"%Inspirer migg%\" then \"Inspirer mig\"\n\t\t\t    ELSE ''others''\n\t\t    END AS tags\n        FROM prod.site_archive_post   \n        WHERE date between MAKEDATE(EXTRACT(YEAR FROM CURDATE()),1)  and  DATE_SUB(cast(NOW() as date), INTERVAL 1 DAY)\n        \n        AND siteid = ', site, '\nAND (\n    (tags NOT LIKE \"%billedkunst%\" \n    AND tags NOT LIKE \"%b\u00f8rnehaveklassen%\" \n    AND tags NOT LIKE \"%dsa%\" \n    AND tags NOT LIKE \"%engelsk%\" \n    AND tags NOT LIKE \"%h\u00e5ndv\u00e6rk og design%\" \n    AND tags NOT LIKE \"%idr\u00e6t%\" \n    AND tags NOT LIKE \"%kulturfag%\" \n    AND tags NOT LIKE \"%l\u00e6rersenior%\" \n    AND tags NOT LIKE \"%l\u00e6rerstuderende%\" \n    AND tags NOT LIKE \"%madkundskab%\" \n    AND tags NOT LIKE \"%musik%\" \n    AND tags   NOT LIKE \"%naturfag%\" \n    AND tags   NOT LIKE \"%plc%\" \n    AND tags   NOT LIKE \"%ppr%\" \n    AND tags  NOT LIKE \"%praktik%\" \n    AND tags  NOT LIKE \"%sosu%\" \n    AND tags  NOT LIKE \"%tyskfransk%\" \n    AND tags NOT LIKE \"%uu%\")\n    OR \n    (tags LIKE \"%dansk%\" \n    OR tags LIKE \"%it,%\" \n    OR tags LIKE \",%it,%\" \n    OR tags LIKE \"%,it%\" \n    OR tags LIKE \"%matematik%\" \n    OR tags LIKE \"%specialp\u00e6dagogik%\" \n    OR tags LIKE \"%Skolepolitik%\" \n    OR tags LIKE \"%DLF%\" \n    OR tags LIKE \"%Skoleledelse%\" \n    OR tags LIKE \"%Psykisk arbejdsmilj\u00f8%\" \n    OR tags LIKE \"%Forskning%\"\n    )\n    OR\n    (tags NOT LIKE \"%billedkunst%\" \n    AND tags NOT LIKE \"%b\u00f8rnehaveklassen%\" \n    AND tags NOT LIKE \"%dsa%\" \n    AND tags NOT LIKE \"%engelsk%\" \n    AND tags NOT LIKE \"%h\u00e5ndv\u00e6rk og design%\" \n    AND tags NOT LIKE \"%idr\u00e6t%\" \n    AND tags NOT LIKE \"%kulturfag%\" \n    AND tags NOT LIKE \"%l\u00e6rersenior%\" \n    AND tags NOT LIKE \"%l\u00e6rerstuderende%\" \n    AND tags NOT LIKE \"%madkundskab%\" \n    AND tags NOT LIKE \"%musik%\" \n    AND tags NOT LIKE \"%naturfag%\" \n    AND tags NOT LIKE \"%plc%\" \n    AND tags NOT LIKE \"%ppr%\" \n    AND tags NOT LIKE \"%praktik%\" \n    AND tags NOT LIKE \"%sosu%\" \n    AND tags NOT LIKE \"%tyskfransk%\" \n    AND tags NOT LIKE \"%uu%\")\n    AND \n    (tags NOT LIKE \"%dansk%\" \n    AND tags NOT LIKE \"%it,%\" \n    AND tags NOT LIKE \",%it,%\" \n    AND tags NOT LIKE \"%,it%\" \n    AND tags NOT LIKE \"%matematik%\" \n    AND tags NOT LIKE \"%specialp\u00e6dagogik%\" \n    AND tags NOT LIKE \"%Skolepolitik%\" \n    AND tags NOT LIKE \"%DLF%\" \n    AND tags NOT LIKE \"%Skoleledelse%\" \n    AND tags NOT LIKE \"%Psykisk arbejdsmilj\u00f8%\" \n    AND tags NOT LIKE \"%Forskning%\")\n)\n),\n    last_ytd_article_published_Agg as\n    (\n        SELECT\n            siteid as siteid,tags,count(*) as agg\n        from\n        last_ytd_article_published \n\t\twhere siteid = ', site, '\n\t\tgroup by 1,2\n    ),\n    agg_next_click_per_article as \n      (\n\t\tSELECT  \n\t\t\te.siteid as siteid,\n            e.id as postid,\n            e.tags,\n            coalesce(sum(hits),0) as val,\n\t\t\tcoalesce(sum(unique_pageviews),0) as page_view \n\t\tfrom last_ytd_article_published  e\n\t\tleft join prod.pages p on p.postid=e.id and p.siteid =e.siteid\n\t\tleft join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'\n\t\twhere    e.siteid = ', site, '  \n\t\tgroup by 1,2,3\n\t\t),\n        cta_per_article as\n\t\t( \n\t\t\tSELECT\n              e.siteid as siteid,\n              e.postid, e.tags,\n\t\t\tround(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val \n            from agg_next_click_per_article  e\n\t\t\twhere  e.siteid = ', site, '\n\t\t\tgroup by 1,2,3\n\n\t\t),\n        agg_cta_per_article as(\n\t\tselect siteid as siteid,tags,sum(val) as agg_sum from\n        cta_per_article\n\t\twhere siteid = ', site, '\n\t\tgroup by 1,2\n\t\t),\n        less_tg_data as(\n\t\tselect \n\t\tpostid,l.tags ,val,min_cta\n\t\t,a.siteid,\n\t\tcase when val<min_cta then 1 else 0 end as less_than_target\n\t\t,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile\n\t\t from last_ytd_article_published l\n\t\tjoin cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags\n\t\tjoin prod.goals g on a.siteid = g.site_id and g.Date = l.fdate\n\t\t where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '\n\t\t),\n        counts as (\n\t\t\tselect \n\t\t\t\tsiteid,\n\t\t\t\ttags,\n\t\t\t\tsum(less_than_target) as less_than_target_count,\n\t\t\t\tsum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,\n\t\t\t\tsum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count\n\t\t\tfrom less_tg_data\n\t\t\tgroup by 1,2\n\t\t),\n        hits_by_tags as(\n\t\t\tselect \n\t\t\t\tsiteid as siteid,\n\t\t\t\ttags,\n\t\t\t\tsum(less_than_target) as hits_tags,\n\t\t\t\tsum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,\n\t\t\t\tsum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved\n\t\t   from less_tg_data\n\t\t   where siteid = ',site,'\n\t\t   group by 1,2)\n           ,\n           total_hits as(\n\t\t\tselect \n\t\t\t\tsiteid as siteid ,\n\t\t\t\tsum(less_than_target_count) as total_tags_hit,\n                sum(top_10_count) as agg_by_top_10,\n                sum(approved_count) as agg_by_approved \n\t\t\tfrom counts\n\t\t\twhere  siteid = ',site,'\n\t\t\tgroup by 1)\n            ,\n            agg_data as(\n\t\t\tselect \n\t\t\t\th.siteid as siteid ,\n\t\t\t\th.tags,\n\t\t\t\tcoalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,\n\t\t\t\tcoalesce(top_10_count/agg_by_top_10,0)*100 as top_10,\n\t\t\t\tcoalesce(approved_count/agg_by_approved,0)*100 as  approved\n\t\t\tfrom counts h\n\t\t\tjoin total_hits t on h.siteid=t.siteid\n\t\t\tjoin last_ytd_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags\n\t\t\twhere h.siteid  = ',site,'\n\t\t),\n        categories_d as (\n\t\t\tselect \n\t\t\t\tsiteid as siteid ,\n\t\t\t\t ',label_val,' as label,\n                ',hint_val,' as hint,\n\t\t\t\tGROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS cateogires,\n\t\t\t\tGROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS less_than_target,\n\t\t\tGROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS approved,\n\t\t\tGROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS top_10\n\t\tfrom agg_data\n\t\tgroup by 1,2,3\n\t\t),\n        categories as (\n\t\tselect siteid as siteid ,label as label, hint as hint,  \n\t\t CONCAT(''\"'', REPLACE(cateogires, '','', ''\",\"''), ''\"'') AS  cateogires,\n\t\tless_than_target as less_than_target ,\n\t\tapproved as approved ,\n\t\t top_10 as top_10 \n\t\t from  categories_d\n\t\t),\n        json_data as\n\t\t(\n\t\tselect siteid,label as lab,hint as h,cateogires as cat,CONCAT(\n\t\t''{\"name\": \"Under m\u00e5l\", \"data\": ['',cast(less_than_target as char),'']}''\n\t\t,'',{\"name\": \"Over m\u00e5l\" ,\"data\": ['',cast(approved as char),'']}'','',\n        {\"name\": \"Top 10%\" ,\"data\": ['',cast(top_10 as char),'']}'') \n        as series from categories\n\t\t), \n    \n    last_ytd_article_published_second as\n    (\n        SELECT\n            siteid as siteid,\n            id,\n            date as fdate,\n\t\t    CASE\n\t\t\t    WHEN Categories like \"%Nyhed%\" then \"Nyhed\"\n\t\t\t    WHEN Categories like \"%Medlemsinfo%\" then \"Medlemsinfo\"\n\t\t\t    WHEN Categories like \"%Reportage%\" then \"Reportage\"\n\t\t\t    WHEN Categories like \"%Artikel%\" then \"Artikel\"\n\t\t\t    WHEN Categories like \"%Det ku ske for dig%\" then \"Det ku ske for dig\"\n\t\t\t    WHEN Categories like \"%Jeg mener%\" then \"Jeg mener\"\n\t\t\t    WHEN Categories like \"%Videoartikel%\" then \"Videoartikel\"\n\t\t\t    ELSE ''others''\n\t\t    END AS tags\n        FROM prod.site_archive_post   \n        WHERE date between MAKEDATE(EXTRACT(YEAR FROM CURDATE()),1)  and  DATE_SUB(cast(NOW() as date), INTERVAL 1 DAY)\n        \n        AND siteid = ', site, '\nAND (\n    (tags NOT LIKE \"%billedkunst%\" \n    AND tags NOT LIKE \"%b\u00f8rnehaveklassen%\" \n    AND tags NOT LIKE \"%dsa%\" \n    AND tags NOT LIKE \"%engelsk%\" \n    AND tags NOT LIKE \"%h\u00e5ndv\u00e6rk og design%\" \n    AND tags NOT LIKE \"%idr\u00e6t%\" \n    AND tags NOT LIKE \"%kulturfag%\" \n    AND tags NOT LIKE \"%l\u00e6rersenior%\" \n    AND tags NOT LIKE \"%l\u00e6rerstuderende%\" \n    AND tags NOT LIKE \"%madkundskab%\" \n    AND tags NOT LIKE \"%musik%\" \n    AND tags   NOT LIKE \"%naturfag%\" \n    AND tags   NOT LIKE \"%plc%\" \n    AND tags   NOT LIKE \"%ppr%\" \n    AND tags  NOT LIKE \"%praktik%\" \n    AND tags  NOT LIKE \"%sosu%\" \n    AND tags  NOT LIKE \"%tyskfransk%\" \n    AND tags NOT LIKE \"%uu%\")\n    OR \n    (tags LIKE \"%dansk%\" \n    OR tags LIKE \"%it,%\" \n    OR tags LIKE \",%it,%\" \n    OR tags LIKE \"%,it%\" \n    OR tags LIKE \"%matematik%\" \n    OR tags LIKE \"%specialp\u00e6dagogik%\" \n    OR tags LIKE \"%Skolepolitik%\" \n    OR tags LIKE \"%DLF%\" \n    OR tags LIKE \"%Skoleledelse%\" \n    OR tags LIKE \"%Psykisk arbejdsmilj\u00f8%\" \n    OR tags LIKE \"%Forskning%\"\n    )\n    OR\n    (tags NOT LIKE \"%billedkunst%\" \n    AND tags NOT LIKE \"%b\u00f8rnehaveklassen%\" \n    AND tags NOT LIKE \"%dsa%\" \n    AND tags NOT LIKE \"%engelsk%\" \n    AND tags NOT LIKE \"%h\u00e5ndv\u00e6rk og design%\" \n    AND tags NOT LIKE \"%idr\u00e6t%\" \n    AND tags NOT LIKE \"%kulturfag%\" \n    AND tags NOT LIKE \"%l\u00e6rersenior%\" \n    AND tags NOT LIKE \"%l\u00e6rerstuderende%\" \n    AND tags NOT LIKE \"%madkundskab%\" \n    AND tags NOT LIKE \"%musik%\" \n    AND tags NOT LIKE \"%naturfag%\" \n    AND tags NOT LIKE \"%plc%\" \n    AND tags NOT LIKE \"%ppr%\" \n    AND tags NOT LIKE \"%praktik%\" \n    AND tags NOT LIKE \"%sosu%\" \n    AND tags NOT LIKE \"%tyskfransk%\" \n    AND tags NOT LIKE \"%uu%\")\n    AND \n    (tags NOT LIKE \"%dansk%\" \n    AND tags NOT LIKE \"%it,%\" \n    AND tags NOT LIKE \",%it,%\" \n    AND tags NOT LIKE \"%,it%\" \n    AND tags NOT LIKE \"%matematik%\" \n    AND tags NOT LIKE \"%specialp\u00e6dagogik%\" \n    AND tags NOT LIKE \"%Skolepolitik%\" \n    AND tags NOT LIKE \"%DLF%\" \n    AND tags NOT LIKE \"%Skoleledelse%\" \n    AND tags NOT LIKE \"%Psykisk arbejdsmilj\u00f8%\" \n    AND tags NOT LIKE \"%Forskning%\")\n)\n),\n    last_ytd_article_published_Agg_second as\n    (\n        SELECT\n            siteid as siteid,tags,count(*) as agg\n        from\n        last_ytd_article_published_second \n\t\twhere siteid = ', site, '\n\t\tgroup by 1,2\n    ),\n    agg_next_click_per_article_second as \n      (\n\t\tSELECT  \n\t\t\te.siteid as siteid,\n            e.id as postid,\n            e.tags,\n            coalesce(sum(hits),0) as val,\n\t\t\tcoalesce(sum(unique_pageviews),0) as page_view \n\t\tfrom last_ytd_article_published_second  e\n\t\tleft join prod.pages p on p.postid=e.id and p.siteid =e.siteid\n\t\tleft join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'\n\t\twhere    e.siteid = ', site, '  \n\t\tgroup by 1,2,3\n\t\t),\n        cta_per_article_second as\n\t\t( \n\t\t\tSELECT\n              e.siteid as siteid,\n              e.postid, e.tags,\n\t\t\tround(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val \n            from agg_next_click_per_article_second  e\n\t\t\twhere  e.siteid = ', site, '\n\t\t\tgroup by 1,2,3\n\n\t\t),\n        agg_cta_per_article_second as(\n\t\tselect siteid as siteid,tags,sum(val) as agg_sum from\n        cta_per_article_second\n\t\twhere siteid = ', site, '\n\t\tgroup by 1,2\n\t\t),\n        less_tg_data_second as(\n\t\tselect \n\t\tpostid,l.tags ,val,min_cta\n\t\t,a.siteid,\n\t\tcase when val<min_cta then 1 else 0 end as less_than_target\n\t\t,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile\n\t\t from last_ytd_article_published_second l\n\t\tjoin cta_per_article_second a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags\n\t\tjoin prod.goals g on a.siteid = g.site_id and g.Date = l.fdate\n\t\t where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '\n\t\t),\n        counts_second as (\n\t\t\tselect \n\t\t\t\tsiteid,\n\t\t\t\ttags,\n\t\t\t\tsum(less_than_target) as less_than_target_count,\n\t\t\t\tsum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,\n\t\t\t\tsum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count\n\t\t\tfrom less_tg_data_second\n\t\t\tgroup by 1,2\n\t\t),\n        hits_by_tags_second as(\n\t\t\tselect \n\t\t\t\tsiteid as siteid,\n\t\t\t\ttags,\n\t\t\t\tsum(less_than_target) as hits_tags,\n\t\t\t\tsum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,\n\t\t\t\tsum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved\n\t\t   from less_tg_data_second\n\t\t   where siteid = ',site,'\n\t\t   group by 1,2)\n           ,\n           total_hits_second as(\n\t\t\tselect \n\t\t\t\tsiteid as siteid ,\n\t\t\t\tsum(less_than_target_count) as total_tags_hit,\n                sum(top_10_count) as agg_by_top_10,\n                sum(approved_count) as agg_by_approved \n\t\t\tfrom counts_second\n\t\t\twhere  siteid = ',site,'\n\t\t\tgroup by 1)\n            ,\n            agg_data_second as(\n\t\t\tselect \n\t\t\t\th.siteid as siteid ,\n\t\t\t\th.tags,\n\t\t\t\tcoalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,\n\t\t\t\tcoalesce(top_10_count/agg_by_top_10,0)*100 as top_10,\n\t\t\t\tcoalesce(approved_count/agg_by_approved,0)*100 as  approved\n\t\t\tfrom counts_second h\n\t\t\tjoin total_hits_second t on h.siteid=t.siteid\n\t\t\tjoin last_ytd_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags\n\t\t\twhere h.siteid  = ',site,'\n\t\t),\n        categories_d_second as (\n\t\t\tselect \n\t\t\t\tsiteid as siteid ,\n\t\t\t\t ',label_val,' as label,\n                ',hint_val,' as hint,\n\t\t\t\tGROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS cateogires,\n\t\t\t\tGROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS less_than_target,\n\t\t\tGROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS approved,\n\t\t\tGROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS top_10\n\t\tfrom agg_data_second\n\t\tgroup by 1,2,3\n\t\t),\n        categories_second as (\n\t\tselect siteid as siteid ,label as label, hint as hint,  \n\t\t CONCAT(''\"'', REPLACE(cateogires, '','', ''\",\"''), ''\"'') AS  cateogires,\n\t\tless_than_target as less_than_target ,\n\t\tapproved as approved ,\n\t\t top_10 as top_10 \n\t\t from  categories_d_second\n\t\t),\n        json_data_second as\n\t\t(\n\t\tselect siteid,label as lab,hint as h,cateogires as cat,CONCAT(\n\t\t''{\"name\": \"Under m\u00e5l\", \"data\": ['',cast(less_than_target as char),'']}''\n\t\t,'',{\"name\": \"Over m\u00e5l\" ,\"data\": ['',cast(approved as char),'']}'','',\n        {\"name\": \"Top 10%\" ,\"data\": ['',cast(top_10 as char),'']}'') \n        as series from categories_second\n\t\t), \n    \n    last_ytd_article_published_third as\n    (\n        SELECT\n            siteid as siteid,\n            id,\n            date as fdate,\n\t\t    CASE\n\t\t\t    WHEN Tags like \"%Slagterindustri%\" then \"Slagterindustri\"\n\t\t\t    WHEN Tags like \"%F\u00f8devareindustri%\" then \"F\u00f8devareindustri\"\n\t\t\t    WHEN Tags like \"%Mejeri%\" then \"Mejeri\"\n\t\t\t    WHEN Tags like \"%Butik%\" then \"Butik\"\n\t\t\t    WHEN Tags like \"%Alle brancher%\" then \"Alle brancher\"\n\t\t\t    ELSE ''others''\n\t\t    END AS tags\n        FROM prod.site_archive_post   \n        WHERE date between MAKEDATE(EXTRACT(YEAR FROM CURDATE()),1)  and  DATE_SUB(cast(NOW() as date), INTERVAL 1 DAY)\n        \n        AND siteid = ', site, '\nAND (\n    (tags NOT LIKE \"%billedkunst%\" \n    AND tags NOT LIKE \"%b\u00f8rnehaveklassen%\" \n    AND tags NOT LIKE \"%dsa%\" \n    AND tags NOT LIKE \"%engelsk%\" \n    AND tags NOT LIKE \"%h\u00e5ndv\u00e6rk og design%\" \n    AND tags NOT LIKE \"%idr\u00e6t%\" \n    AND tags NOT LIKE \"%kulturfag%\" \n    AND tags NOT LIKE \"%l\u00e6rersenior%\" \n    AND tags NOT LIKE \"%l\u00e6rerstuderende%\" \n    AND tags NOT LIKE \"%madkundskab%\" \n    AND tags NOT LIKE \"%musik%\" \n    AND tags   NOT LIKE \"%naturfag%\" \n    AND tags   NOT LIKE \"%plc%\" \n    AND tags   NOT LIKE \"%ppr%\" \n    AND tags  NOT LIKE \"%praktik%\" \n    AND tags  NOT LIKE \"%sosu%\" \n    AND tags  NOT LIKE \"%tyskfransk%\" \n    AND tags NOT LIKE \"%uu%\")\n    OR \n    (tags LIKE \"%dansk%\" \n    OR tags LIKE \"%it,%\" \n    OR tags LIKE \",%it,%\" \n    OR tags LIKE \"%,it%\" \n    OR tags LIKE \"%matematik%\" \n    OR tags LIKE \"%specialp\u00e6dagogik%\" \n    OR tags LIKE \"%Skolepolitik%\" \n    OR tags LIKE \"%DLF%\" \n    OR tags LIKE \"%Skoleledelse%\" \n    OR tags LIKE \"%Psykisk arbejdsmilj\u00f8%\" \n    OR tags LIKE \"%Forskning%\"\n    )\n    OR\n    (tags NOT LIKE \"%billedkunst%\" \n    AND tags NOT LIKE \"%b\u00f8rnehaveklassen%\" \n    AND tags NOT LIKE \"%dsa%\" \n    AND tags NOT LIKE \"%engelsk%\" \n    AND tags NOT LIKE \"%h\u00e5ndv\u00e6rk og design%\" \n    AND tags NOT LIKE \"%idr\u00e6t%\" \n    AND tags NOT LIKE \"%kulturfag%\" \n    AND tags NOT LIKE \"%l\u00e6rersenior%\" \n    AND tags NOT LIKE \"%l\u00e6rerstuderende%\" \n    AND tags NOT LIKE \"%madkundskab%\" \n    AND tags NOT LIKE \"%musik%\" \n    AND tags NOT LIKE \"%naturfag%\" \n    AND tags NOT LIKE \"%plc%\" \n    AND tags NOT LIKE \"%ppr%\" \n    AND tags NOT LIKE \"%praktik%\" \n    AND tags NOT LIKE \"%sosu%\" \n    AND tags NOT LIKE \"%tyskfransk%\" \n    AND tags NOT LIKE \"%uu%\")\n    AND \n    (tags NOT LIKE \"%dansk%\" \n    AND tags NOT LIKE \"%it,%\" \n    AND tags NOT LIKE \",%it,%\" \n    AND tags NOT LIKE \"%,it%\" \n    AND tags NOT LIKE \"%matematik%\" \n    AND tags NOT LIKE \"%specialp\u00e6dagogik%\" \n    AND tags NOT LIKE \"%Skolepolitik%\" \n    AND tags NOT LIKE \"%DLF%\" \n    AND tags NOT LIKE \"%Skoleledelse%\" \n    AND tags NOT LIKE \"%Psykisk arbejdsmilj\u00f8%\" \n    AND tags NOT LIKE \"%Forskning%\")\n)\n),\n    last_ytd_article_published_Agg_third as\n    (\n        SELECT\n            siteid as siteid,tags,count(*) as agg\n        from\n        last_ytd_article_published_third \n\t\twhere siteid = ', site, '\n\t\tgroup by 1,2\n    ),\n    agg_next_click_per_article_third as \n      (\n\t\tSELECT  \n\t\t\te.siteid as siteid,\n            e.id as postid,\n            e.tags,\n            coalesce(sum(hits),0) as val,\n\t\t\tcoalesce(sum(unique_pageviews),0) as page_view \n\t\tfrom last_ytd_article_published_third  e\n\t\tleft join prod.pages p on p.postid=e.id and p.siteid =e.siteid\n\t\tleft join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'\n\t\twhere    e.siteid = ', site, '  \n\t\tgroup by 1,2,3\n\t\t),\n        cta_per_article_third as\n\t\t( \n\t\t\tSELECT\n              e.siteid as siteid,\n              e.postid, e.tags,\n\t\t\tround(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val \n            from agg_next_click_per_article_third  e\n\t\t\twhere  e.siteid = ', site, '\n\t\t\tgroup by 1,2,3\n\n\t\t),\n        agg_cta_per_article_third as(\n\t\tselect siteid as siteid,tags,sum(val) as agg_sum from\n        cta_per_article_third\n\t\twhere siteid = ', site, '\n\t\tgroup by 1,2\n\t\t),\n        less_tg_data_third as(\n\t\tselect \n\t\tpostid,l.tags ,val,min_cta\n\t\t,a.siteid,\n\t\tcase when val<min_cta then 1 else 0 end as less_than_target\n\t\t,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile\n\t\t from last_ytd_article_published_third l\n\t\tjoin cta_per_article_third a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags\n\t\tjoin prod.goals g on a.siteid = g.site_id and g.Date = l.fdate\n\t\t where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '\n\t\t),\n        counts_third as (\n\t\t\tselect \n\t\t\t\tsiteid,\n\t\t\t\ttags,\n\t\t\t\tsum(less_than_target) as less_than_target_count,\n\t\t\t\tsum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,\n\t\t\t\tsum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count\n\t\t\tfrom less_tg_data_third\n\t\t\tgroup by 1,2\n\t\t),\n        hits_by_tags_third as(\n\t\t\tselect \n\t\t\t\tsiteid as siteid,\n\t\t\t\ttags,\n\t\t\t\tsum(less_than_target) as hits_tags,\n\t\t\t\tsum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,\n\t\t\t\tsum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved\n\t\t   from less_tg_data_third\n\t\t   where siteid = ',site,'\n\t\t   group by 1,2)\n           ,\n           total_hits_third as(\n\t\t\tselect \n\t\t\t\tsiteid as siteid ,\n\t\t\t\tsum(less_than_target_count) as total_tags_hit,\n                sum(top_10_count) as agg_by_top_10,\n                sum(approved_count) as agg_by_approved \n\t\t\tfrom counts_third\n\t\t\twhere  siteid = ',site,'\n\t\t\tgroup by 1)\n            ,\n            agg_data_third as(\n\t\t\tselect \n\t\t\t\th.siteid as siteid ,\n\t\t\t\th.tags,\n\t\t\t\tcoalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,\n\t\t\t\tcoalesce(top_10_count/agg_by_top_10,0)*100 as top_10,\n\t\t\t\tcoalesce(approved_count/agg_by_approved,0)*100 as  approved\n\t\t\tfrom counts_third h\n\t\t\tjoin total_hits_third t on h.siteid=t.siteid\n\t\t\tjoin last_ytd_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags\n\t\t\twhere h.siteid  = ',site,'\n\t\t),\n        categories_d_third as (\n\t\t\tselect \n\t\t\t\tsiteid as siteid ,\n\t\t\t\t ',label_val,' as label,\n                ',hint_val,' as hint,\n\t\t\t\tGROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS cateogires,\n\t\t\t\tGROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS less_than_target,\n\t\t\tGROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS approved,\n\t\t\tGROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS top_10\n\t\tfrom agg_data_third\n\t\tgroup by 1,2,3\n\t\t),\n        categories_third as (\n\t\tselect siteid as siteid ,label as label, hint as hint,  \n\t\t CONCAT(''\"'', REPLACE(cateogires, '','', ''\",\"''), ''\"'') AS  cateogires,\n\t\tless_than_target as less_than_target ,\n\t\tapproved as approved ,\n\t\t top_10 as top_10 \n\t\t from  categories_d_third\n\t\t),\n        json_data_third as\n\t\t(\n\t\tselect siteid,label as lab,hint as h,cateogires as cat,CONCAT(\n\t\t''{\"name\": \"Under m\u00e5l\", \"data\": ['',cast(less_than_target as char),'']}''\n\t\t,'',{\"name\": \"Over m\u00e5l\" ,\"data\": ['',cast(approved as char),'']}'','',\n        {\"name\": \"Top 10%\" ,\"data\": ['',cast(top_10 as char),'']}'') \n        as series from categories_third\n\t\t)\n    \n\n    SELECT \n\t\tCONCAT(\n        ''{'',\n            ''\"site\":'',jd.siteid,'','',\n            ''\"data\": {'',\n                ''\"label\": \"'', jd.lab, ''\",'',\n                ''\"categories\": ['', jd.cat, ''],'',\n                ''\"series\": ['', jd.series, '']'',\n                '',\"defaultTitle\":\"',dtitle,'\"'',\n                '',\"additional\":[ ''\n                \n                ,''{'',\n                ''\"title\":\"',title1,'\",'',\n                ''\"data\": {'',\n                ''\"label\": \"'',json_data_second.lab, ''\",'',\n                ''\"categories\": ['', json_data_second.cat, ''],'',\n                ''\"series\": ['', json_data_second.series, '']'',\n                ''}}''\n                \n                , '',''\n                \n                \n                ,''{'',\n                ''\"title\":\"',title2,'\",'',\n                ''\"data\": {'',\n                ''\"label\": \"'',json_data_third.lab, ''\",'',\n                ''\"categories\": ['', json_data_third.cat, ''],'',\n                ''\"series\": ['', json_data_third.series, '']'',\n                ''}}''\n                \n                \n        '']}}''\n    \n\t\t\t) as json_data\n\t\t  FROM json_data jd\n          \n          CROSS join json_data_second\n          \n          CROSS join json_data_third\n          ;", "relation_name": "\"dbt_project_test_kasper\".\"public\".\"tactical_userneeds_pageviews_chart_month_11\""}], "elapsed_time": 0.49124979972839355, "args": {"favor_state": false, "print": true, "introspect": true, "log_level_file": "debug", "vars": {}, "printer_width": 80, "defer": false, "log_level": "info", "require_resource_names_without_spaces": false, "use_colors_file": true, "log_format_file": "debug", "macro_debugging": false, "version_check": true, "invocation_command": "dbt compile -s tactical_userneeds_pageviews_chart_month_11", "populate_cache": true, "profiles_dir": "E:\\DBT\\DBT_Transformation", "exclude": [], "warn_error_options": {"include": [], "exclude": []}, "static_parser": true, "which": "compile", "enable_legacy_logger": false, "send_anonymous_usage_stats": true, "show_resource_report": false, "source_freshness_run_project_hooks": false, "write_json": true, "strict_mode": false, "require_explicit_package_overrides_for_builtin_materializations": true, "quiet": false, "partial_parse_file_diff": true, "cache_selected_only": false, "log_format": "default", "partial_parse": true, "empty": false, "log_file_max_bytes": 10485760, "project_dir": "E:\\DBT\\DBT_Transformation", "indirect_selection": "eager", "output": "text", "log_path": "E:\\DBT\\DBT_Transformation\\logs", "select": ["tactical_userneeds_pageviews_chart_month_11"], "inject_ephemeral_ctes": true, "use_colors": true}}