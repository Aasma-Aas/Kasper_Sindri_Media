{"metadata": {"dbt_schema_version": "https://schemas.getdbt.com/dbt/run-results/v5.json", "dbt_version": "1.7.17", "generated_at": "2024-08-02T11:20:31.297238Z", "invocation_id": "7fc609ce-0ef6-450f-b278-aa1c42169418", "env": {}}, "results": [{"status": "error", "timing": [{"name": "compile", "started_at": "2024-08-02T11:20:27.495162Z", "completed_at": "2024-08-02T11:20:27.525080Z"}, {"name": "execute", "started_at": "2024-08-02T11:20:27.528073Z", "completed_at": "2024-08-02T11:20:29.639548Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 2.3817477226257324, "adapter_response": {}, "message": "Database Error in model macro_pro (models/sindri_media_sites\\macro_pro.sql)\n  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_clicks_chart_mont' at line 18\n  compiled Code at target\\run\\site_dev\\models/sindri_media_sites\\macro_pro.sql", "failures": null, "unique_id": "model.site_dev.macro_pro", "compiled": true, "compiled_code": "\n\n\n\n\n\n\n\n    \n\n\nCREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_clicks_chart_month_dbt_4`()\nBEGIN\n\nwith last_30_days_article_published as\n(\n\tSELECT \n\t\tsiteid as siteid,\n\t\tid, \n\t\tdate as fdate  \n\tFROM prod.site_archive_post\n\twhere date between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY)\n\t\n\tand siteid = 4\n)\n,\nlast_30_days_article_published_Agg as\n(\n\tselect \n\t\tsiteid as siteid,\n\t\tcount(*) as agg\n\tfrom  last_30_days_article_published\n\twhere   siteid = 4\n\tgroup by 1\n),\nnext_clicks_events as\n(\n\tselect  \n\t\te.siteid as siteid,\n\t\te.postid,\n\t\tsum(hits) as val \n\tfrom prod.events e\n\tjoin  last_30_days_article_published a on a.id=e.postid\n\twhere e.Event_Action = 'Next Click'  \n\tand e.siteid = 4\n\tand date between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY)\n\tgroup by 1,2\n),\npages as\n(\n\tselect\n\t\tp.siteid,\n\t\tp.postid,\n\t\tsum(p.Unique_pageViews) as pageviews\n\tfrom prod.pages p\n\tleft join last_30_days_article_published l on l.id = p.postid\n\twhere p.date between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY)\n\tand p.siteid = 4\n\tgroup by 1,2\n),\nnext_click_percentage as\n(\n\tselect \n\t\tncv.siteid,\n\t\tncv.postid,\n\t\tncv.val as value,\n\t\tp.pageviews,\n\t\tround((ncv.val/p.pageviews * 100),2) as val\n\tfrom next_clicks_events ncv\n\tleft join pages p on p.postid = ncv.postid and  p.siteid = ncv.siteid\n),\nagg_data as\n(\n\tselect \n\t\tl.siteid,\n\t\tpostid,\n\t\tval,\n\t\tvalue,\n\t\tpageviews,\n\t\tmin_cta,\n\t\tpercent_rank() over (ORDER BY case when val>=min_cta then val-min_cta else 0 end) as percentile,\n\t\tcase when coalesce (val,0)>=min_cta then val-min_cta else 0 end greater_than_target,\n\t\tcase when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target\n\t\t\n\tfrom last_30_days_article_published l\n\tleft join next_click_percentage a on l.siteid = a.siteid and l.id = a.postid\n\tleft join prod.goals g on  g.Date = l.fdate\n\twhere g.date between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY)\n\tand g.site_id = 4\n)\n,\ndark_blue as\n(\n\tSELECT\n    category,\n    SUM(value) / SUM(pageviews) * 100 AS percentage\n\tFROM (\n\t\tSELECT\n\t\t\tpostid,\n\t\t\tCASE\n\t\t\t\tWHEN percentile >= 0 AND percentile < 0.9 AND less_than_target = 0 THEN 'Approved'\n\t\t\t\tWHEN percentile <= 1 AND percentile >= 0.9 THEN 'Top 10%'\n\t\t\t\tWHEN less_than_target = 1 THEN 'Less_than_target'\n\t\t\tEND AS category,\n\t\t\tvalue,\n\t\t\tpageviews\n\t\tFROM\n\t\t\tagg_data\n\t) AS categorized_data\n\tWHERE\n\t\tcategory IS NOT NULL  \n\tGROUP BY\n\t\tcategory\n),\ndata_out as\n(\n\tselect \n\t\ta.siteid,\n\t\t 'Artikler ift. next click m\u00e5l' as label,\n\t\t 'Artikler grupperet ift hvordan de har performet p\u00e5 next click.' as hint,\n\t\t'\"Under m\u00e5l\" , \"Over m\u00e5l\" , \"Top 10%\"' as categories,\n\t\tCOALESCE((sum(less_than_target)/agg)*100,0)  as less_than_target,\n\t\tCOALESCE((sum(case when percentile<=1 and percentile>=0.9 then 1 else 0 end)/agg)*100,0) as top_10,\n\t\tCOALESCE((sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then 1 else 0 end)/agg)*100,0) as approved,\n        \n        COALESCE((select percentage  from dark_blue where category = 'Less_than_target'),0) as less_than_target_click,\n        COALESCE((select percentage  from dark_blue where category = 'Top 10%'),0) as top_10_clicks,\n        COALESCE((select percentage  from dark_blue where category = 'Approved'),0) as approved_clicks\n        \n\tfrom agg_data a\n\tjoin last_30_days_article_published_Agg ag on ag.siteid=a.siteid\n\twhere   a.siteid = 4\n\tgroup by 1,2,3,4\n),\n\njson_data as\n(\n\tselect \n\t\tsiteid as siteid,\n        label as lab,\n        hint as ht,\n        categories as cat,\n        CONCAT\n        (\n        '{\"name\": \"Andel artikler\",\n        \"data\": [',\n        cast(less_than_target as char),',',\n        cast(approved as char),',',\n        cast(top_10 as char),']}'\n\t    ,',\n        {\"name\": \"Gns. next click for artikler.\",\n        \"data\": [',\n        cast(less_than_target_click as char),',',\n        cast(approved_clicks as char),',',\n        cast(top_10_clicks as char),']}'\n        ) as series \n\tfrom data_out\n)\n\n\nSELECT \n    IFNULL(\n        CONCAT(\n            '{',\n            '\"site\":', siteid, ',',\n            '\"data\":{\"label\":\"', lab, '\",\"hint\":\"', ht, '\",\"categories\":', '[' , cat, '],',\n            '\"series\":', '[', series, ']'\n            ,'}}'\n        ),\n        '{\"site\": ' || 4 || ',\n          \"data\":{\"label\":\"' || lab || '\",\"hint\":\"' || ht || '\",\"categories\":[' || cat || '],\"series\":[]}}'\n    ) as json_data\nFROM json_data;\n\nEND;\n\n\n", "relation_name": "`site_dev`.`macro_pro`"}], "elapsed_time": 8.197939157485962, "args": {"log_format_file": "debug", "log_format": "default", "show_resource_report": false, "introspect": true, "project_dir": "E:\\Kasper_Sindri_Media", "favor_state": false, "enable_legacy_logger": false, "select": ["macro_pro.sql"], "log_path": "E:\\Kasper_Sindri_Media\\logs", "log_file_max_bytes": 10485760, "use_colors_file": true, "static_parser": true, "vars": {}, "use_colors": true, "log_level_file": "debug", "require_explicit_package_overrides_for_builtin_materializations": false, "populate_cache": true, "printer_width": 80, "which": "run", "cache_selected_only": false, "write_json": true, "exclude": [], "quiet": false, "partial_parse": true, "version_check": true, "log_level": "info", "print": true, "send_anonymous_usage_stats": true, "invocation_command": "dbt run --models macro_pro.sql", "indirect_selection": "eager", "partial_parse_file_diff": true, "strict_mode": false, "defer": false, "macro_debugging": false, "warn_error_options": {"include": [], "exclude": []}, "profiles_dir": "E:\\Kasper_Sindri_Media"}}