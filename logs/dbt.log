[0m14:44:31.857324 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002558CF21550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002558CCBF7A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002558CF237D0>]}


============================== 14:44:31.864320 | e241274a-c59f-496b-9584-c5a1a6f34d0f ==============================
[0m14:44:31.864320 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:44:31.866498 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s test.sql', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m14:44:32.209185 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e241274a-c59f-496b-9584-c5a1a6f34d0f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002558CF791C0>]}
[0m14:44:32.362188 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e241274a-c59f-496b-9584-c5a1a6f34d0f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002558CD6D8B0>]}
[0m14:44:32.364589 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:44:32.380382 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:44:32.551108 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m14:44:32.552109 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m14:44:32.565112 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e241274a-c59f-496b-9584-c5a1a6f34d0f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002558D2124B0>]}
[0m14:44:32.588109 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e241274a-c59f-496b-9584-c5a1a6f34d0f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002558D2CD7F0>]}
[0m14:44:32.589164 [info ] [MainThread]: Found 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m14:44:32.591115 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e241274a-c59f-496b-9584-c5a1a6f34d0f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002558D2CC050>]}
[0m14:44:32.593108 [warn ] [MainThread]: The selection criterion 'test.sql' does not match any nodes
[0m14:44:32.596105 [info ] [MainThread]: 
[0m14:44:32.598108 [warn ] [MainThread]: Nothing to do. Try checking your model configs and model specification args
[0m14:44:32.600519 [debug] [MainThread]: Command end result
[0m14:44:32.613182 [debug] [MainThread]: Command `dbt compile` succeeded at 14:44:32.612103 after 1.03 seconds
[0m14:44:32.614109 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025589F31100>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002558CD6ED20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002558CD6F8C0>]}
[0m14:44:32.615314 [debug] [MainThread]: Flushing usage events
[0m14:45:26.111678 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BA3712B10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BA3713D10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BA3713860>]}


============================== 14:45:26.121683 | deb59346-06a5-4819-b74d-15b383214e16 ==============================
[0m14:45:26.121683 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:45:26.124684 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt compile -s test', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m14:45:26.500693 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'deb59346-06a5-4819-b74d-15b383214e16', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BA3768800>]}
[0m14:45:26.689573 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'deb59346-06a5-4819-b74d-15b383214e16', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BA36F3D40>]}
[0m14:45:26.691583 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:45:26.711594 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:45:26.803604 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m14:45:26.804617 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m14:45:26.812631 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'deb59346-06a5-4819-b74d-15b383214e16', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BA390E630>]}
[0m14:45:26.828703 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'deb59346-06a5-4819-b74d-15b383214e16', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BA3AF95B0>]}
[0m14:45:26.831640 [info ] [MainThread]: Found 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m14:45:26.833640 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'deb59346-06a5-4819-b74d-15b383214e16', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BA3736870>]}
[0m14:45:26.835635 [warn ] [MainThread]: The selection criterion 'test' does not match any nodes
[0m14:45:26.840697 [info ] [MainThread]: 
[0m14:45:26.842633 [warn ] [MainThread]: Nothing to do. Try checking your model configs and model specification args
[0m14:45:26.845639 [debug] [MainThread]: Command end result
[0m14:45:26.862635 [debug] [MainThread]: Command `dbt compile` succeeded at 14:45:26.862635 after 1.00 seconds
[0m14:45:26.864764 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019B9D095610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BA34C56A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BA3610320>]}
[0m14:45:26.866636 [debug] [MainThread]: Flushing usage events
[0m14:47:38.144693 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000135BCC11910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000135BCC11CA0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000135BCC13F80>]}


============================== 14:47:38.152694 | 95c40319-9659-47ec-a591-2a7ac81cf5cc ==============================
[0m14:47:38.152694 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:47:38.154696 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s test', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m14:47:38.553424 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '95c40319-9659-47ec-a591-2a7ac81cf5cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000135BCCD9400>]}
[0m14:47:38.711483 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '95c40319-9659-47ec-a591-2a7ac81cf5cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000135BCAEFEF0>]}
[0m14:47:38.714484 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:47:38.738483 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:47:38.840551 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m14:47:38.841569 [debug] [MainThread]: Partial parsing: added file: dbt_project_test_kasper://models\test.sql
[0m14:47:39.060331 [error] [MainThread]: Encountered an error:
Compilation Error in model test (models\test.sql)
  expected token ',', got 'Praksis'
    line 3
      {% set categories = ['Fodsundhed og samfund', 'Forebyggelse', 'Forskning og viden, 'Praksis'] %}
[0m14:47:39.063291 [debug] [MainThread]: Command `dbt compile` failed at 14:47:39.062424 after 1.20 seconds
[0m14:47:39.064292 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000135BCC37B60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000135BCC11BE0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000135BCC103B0>]}
[0m14:47:39.066287 [debug] [MainThread]: Flushing usage events
[0m14:48:48.305759 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029865F536B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029865F53140>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029865F52EA0>]}


============================== 14:48:48.315841 | 260ae816-48c4-437d-b0bc-f6e985d6c445 ==============================
[0m14:48:48.315841 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:48:48.319837 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt compile -s test', 'send_anonymous_usage_stats': 'True'}
[0m14:48:48.716910 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '260ae816-48c4-437d-b0bc-f6e985d6c445', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029865B1DAF0>]}
[0m14:48:48.904011 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '260ae816-48c4-437d-b0bc-f6e985d6c445', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000298656A0DD0>]}
[0m14:48:48.907033 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:48:48.928018 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:48:49.102008 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m14:48:49.104012 [debug] [MainThread]: Partial parsing: added file: dbt_project_test_kasper://models\test.sql
[0m14:48:49.289009 [error] [MainThread]: Encountered an error:
Compilation Error in model test (models\test.sql)
  expected token ':', got '}'
    line 7
      {% set diction2 = {0: {{categories}}, 1: {{tags}}, 2: {{tags_r}}}%}
[0m14:48:49.292010 [debug] [MainThread]: Command `dbt compile` failed at 14:48:49.291012 after 1.22 seconds
[0m14:48:49.293011 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002985F925610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000298661421B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000298663EED20>]}
[0m14:48:49.294036 [debug] [MainThread]: Flushing usage events
[0m14:49:38.474498 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202EA731520>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202E98AD7F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202EA730140>]}


============================== 14:49:38.484507 | aa00384a-057e-4d7b-a61c-f5ef3ec2aed2 ==============================
[0m14:49:38.484507 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:49:38.487505 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s test', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m14:49:38.852328 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'aa00384a-057e-4d7b-a61c-f5ef3ec2aed2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202EA7887A0>]}
[0m14:49:38.982701 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'aa00384a-057e-4d7b-a61c-f5ef3ec2aed2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202EA29AE70>]}
[0m14:49:38.984704 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:49:39.000240 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:49:39.160487 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m14:49:39.162488 [debug] [MainThread]: Partial parsing: added file: dbt_project_test_kasper://models\test.sql
[0m14:49:39.330635 [error] [MainThread]: Encountered an error:
Compilation Error in model test (models\test.sql)
  unexpected '%'
    line 7
      {% set diction2 = {0: {{%categories%}}, 1: {{%tags%}}, 2: {{%tags_r%}}} %}
[0m14:49:39.333632 [debug] [MainThread]: Command `dbt compile` failed at 14:49:39.332634 after 1.07 seconds
[0m14:49:39.334641 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202EA558740>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202EA9E30B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202EAA265D0>]}
[0m14:49:39.335943 [debug] [MainThread]: Flushing usage events
[0m14:50:58.695056 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B1667731D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B165D357F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B1667738C0>]}


============================== 14:50:58.705056 | 305b0afe-6ab1-4c25-8acd-cfd1b669f5b4 ==============================
[0m14:50:58.705056 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:50:58.708133 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s test', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m14:50:59.055065 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '305b0afe-6ab1-4c25-8acd-cfd1b669f5b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B1667C9F10>]}
[0m14:50:59.203285 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '305b0afe-6ab1-4c25-8acd-cfd1b669f5b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B166682F00>]}
[0m14:50:59.206277 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:50:59.223245 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:50:59.341242 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m14:50:59.342550 [debug] [MainThread]: Partial parsing: added file: dbt_project_test_kasper://models\test.sql
[0m14:50:59.600286 [error] [MainThread]: Encountered an error:
Compilation Error in model test (models\test.sql)
  expected token ':', got '}'
    line 33
      {% for j in range(len( {{diction2[i]}} ))%}
[0m14:50:59.603245 [debug] [MainThread]: Command `dbt compile` failed at 14:50:59.602384 after 1.24 seconds
[0m14:50:59.604262 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B166AB9DF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B166CAEB40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B166B125D0>]}
[0m14:50:59.605243 [debug] [MainThread]: Flushing usage events
[0m14:52:02.292652 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BD671E3260>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BD671E2E10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BD671E2B40>]}


============================== 14:52:02.302654 | e8003ca6-6b0d-4620-91bc-a2c2f5a45124 ==============================
[0m14:52:02.302654 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:52:02.305655 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt compile -s test', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m14:52:02.646779 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e8003ca6-6b0d-4620-91bc-a2c2f5a45124', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BD671E35F0>]}
[0m14:52:02.827331 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e8003ca6-6b0d-4620-91bc-a2c2f5a45124', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BD673F3890>]}
[0m14:52:02.830358 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:52:02.851527 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:52:02.993805 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m14:52:02.994889 [debug] [MainThread]: Partial parsing: added file: dbt_project_test_kasper://models\test.sql
[0m14:52:03.240031 [error] [MainThread]: Encountered an error:
Compilation Error in model test (models\test.sql)
  Unexpected end of template. Jinja was looking for the following tags: 'endfor' or 'else'. The innermost block that needs to be closed is 'for'.
    line 34
      WHEN {{ diction[i] }} like "%{{diction2[i][j]}}%" THEN "{{diction2[i][j]}}"
[0m14:52:03.243026 [debug] [MainThread]: Command `dbt compile` failed at 14:52:03.243026 after 1.21 seconds
[0m14:52:03.245017 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BD6764E7B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BD67454E90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BD6765F5C0>]}
[0m14:52:03.246019 [debug] [MainThread]: Flushing usage events
[0m14:53:03.759164 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018B4CF317F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018B4C32D7F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018B4CF31790>]}


============================== 14:53:03.773165 | 98aaedac-b36f-476c-a9af-8e78c0f4ee28 ==============================
[0m14:53:03.773165 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:53:03.776351 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s test', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m14:53:04.341729 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '98aaedac-b36f-476c-a9af-8e78c0f4ee28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018B4CD18650>]}
[0m14:53:04.501728 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '98aaedac-b36f-476c-a9af-8e78c0f4ee28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018B468B5490>]}
[0m14:53:04.504730 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:53:04.528844 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:53:04.664845 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m14:53:04.666846 [debug] [MainThread]: Partial parsing: added file: dbt_project_test_kasper://models\test.sql
[0m14:53:04.917831 [error] [MainThread]: Encountered an error:
'Undefined' object cannot be interpreted as an integer
[0m14:53:04.927823 [error] [MainThread]: Traceback (most recent call last):
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 91, in wrapper
    result, success = func(*args, **kwargs)
                      ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 76, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 169, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 198, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 245, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 271, in wrapper
    ctx.obj["manifest"] = parse_manifest(
                          ^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\manifest.py", line 1790, in parse_manifest
    manifest = ManifestLoader.get_full_manifest(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\manifest.py", line 318, in get_full_manifest
    manifest = loader.load()
               ^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\manifest.py", line 478, in load
    self.parse_project(
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\manifest.py", line 674, in parse_project
    parser.parse_file(block)
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\base.py", line 483, in parse_file
    self.parse_node(file_block)
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\base.py", line 444, in parse_node
    self.render_update(node, config)
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\models.py", line 360, in render_update
    super().render_update(node, config)
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\base.py", line 420, in render_update
    context = self.render_with_context(node, config)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\base.py", line 269, in render_with_context
    get_rendered(parsed_node.raw_code, context, parsed_node, capture_macros=True)
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\clients\jinja.py", line 600, in get_rendered
    rendered = render_template(template, ctx, node)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\clients\jinja.py", line 546, in render_template
    return template.render(ctx)
           ^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\jinja2\environment.py", line 1301, in render
    self.environment.handle_exception()
  File "C:\Users\hp\dbt\Lib\site-packages\jinja2\environment.py", line 936, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "<template>", line 33, in top-level template code
  File "C:\Users\hp\dbt\Lib\site-packages\jinja2\sandbox.py", line 393, in call
    return __context.call(__obj, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\jinja2\sandbox.py", line 101, in safe_range
    rng = range(*args)
          ^^^^^^^^^^^^
TypeError: 'Undefined' object cannot be interpreted as an integer

[0m14:53:04.934842 [debug] [MainThread]: Command `dbt compile` failed at 14:53:04.933837 after 1.53 seconds
[0m14:53:04.935831 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018B4CD18680>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018B4D19B260>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018B4D13C4D0>]}
[0m14:53:04.937834 [debug] [MainThread]: Flushing usage events
[0m14:54:09.319867 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B1D0FA2CC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B1D0FA0F50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B1D0FA0F80>]}


============================== 14:54:09.329622 | d5e30d24-184b-440f-8b3a-c36227b8dc50 ==============================
[0m14:54:09.329622 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:54:09.333628 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt compile -s test', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m14:54:09.773108 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd5e30d24-184b-440f-8b3a-c36227b8dc50', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B1D11C7950>]}
[0m14:54:09.930685 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd5e30d24-184b-440f-8b3a-c36227b8dc50', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B1D0EDD820>]}
[0m14:54:09.933713 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:54:09.954696 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:54:10.113750 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m14:54:10.115749 [debug] [MainThread]: Partial parsing: added file: dbt_project_test_kasper://models\test.sql
[0m14:54:10.318224 [error] [MainThread]: Encountered an error:
'Undefined' object cannot be interpreted as an integer
[0m14:54:10.326230 [error] [MainThread]: Traceback (most recent call last):
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 91, in wrapper
    result, success = func(*args, **kwargs)
                      ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 76, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 169, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 198, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 245, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 271, in wrapper
    ctx.obj["manifest"] = parse_manifest(
                          ^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\manifest.py", line 1790, in parse_manifest
    manifest = ManifestLoader.get_full_manifest(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\manifest.py", line 318, in get_full_manifest
    manifest = loader.load()
               ^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\manifest.py", line 478, in load
    self.parse_project(
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\manifest.py", line 674, in parse_project
    parser.parse_file(block)
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\base.py", line 483, in parse_file
    self.parse_node(file_block)
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\base.py", line 444, in parse_node
    self.render_update(node, config)
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\models.py", line 360, in render_update
    super().render_update(node, config)
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\base.py", line 420, in render_update
    context = self.render_with_context(node, config)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\base.py", line 269, in render_with_context
    get_rendered(parsed_node.raw_code, context, parsed_node, capture_macros=True)
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\clients\jinja.py", line 600, in get_rendered
    rendered = render_template(template, ctx, node)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\clients\jinja.py", line 546, in render_template
    return template.render(ctx)
           ^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\jinja2\environment.py", line 1301, in render
    self.environment.handle_exception()
  File "C:\Users\hp\dbt\Lib\site-packages\jinja2\environment.py", line 936, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "<template>", line 33, in top-level template code
  File "C:\Users\hp\dbt\Lib\site-packages\jinja2\sandbox.py", line 393, in call
    return __context.call(__obj, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\jinja2\sandbox.py", line 101, in safe_range
    rng = range(*args)
          ^^^^^^^^^^^^
TypeError: 'Undefined' object cannot be interpreted as an integer

[0m14:54:10.331229 [debug] [MainThread]: Command `dbt compile` failed at 14:54:10.330227 after 1.29 seconds
[0m14:54:10.332179 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B1D0BFD280>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B1D14BECC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B1D1233CE0>]}
[0m14:54:10.333197 [debug] [MainThread]: Flushing usage events
[0m14:54:43.072912 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D797AE62A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D797AE6F30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D797AE6D20>]}


============================== 14:54:43.083797 | 5a32db39-7a1b-4d7c-9ef6-c4d88e325b53 ==============================
[0m14:54:43.083797 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:54:43.086839 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt compile -s test', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m14:54:43.433833 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '5a32db39-7a1b-4d7c-9ef6-c4d88e325b53', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D797B09A00>]}
[0m14:54:43.590370 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '5a32db39-7a1b-4d7c-9ef6-c4d88e325b53', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D797B39D90>]}
[0m14:54:43.593400 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:54:43.617428 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:54:43.754413 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m14:54:43.755921 [debug] [MainThread]: Partial parsing: added file: dbt_project_test_kasper://models\test.sql
[0m14:54:43.960415 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '5a32db39-7a1b-4d7c-9ef6-c4d88e325b53', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D797D268D0>]}
[0m14:54:43.980417 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '5a32db39-7a1b-4d7c-9ef6-c4d88e325b53', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D797F596A0>]}
[0m14:54:43.981415 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m14:54:43.983414 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '5a32db39-7a1b-4d7c-9ef6-c4d88e325b53', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D79807C710>]}
[0m14:54:43.986415 [info ] [MainThread]: 
[0m14:54:43.988416 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m14:54:43.991413 [debug] [ThreadPool]: Acquiring new postgres connection 'list_DBT_DATABASE_public'
[0m14:54:44.015268 [debug] [ThreadPool]: Using postgres connection "list_DBT_DATABASE_public"
[0m14:54:44.016928 [debug] [ThreadPool]: On list_DBT_DATABASE_public: BEGIN
[0m14:54:44.018269 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:54:44.352808 [debug] [ThreadPool]: Postgres adapter: Got a retryable error when attempting to open a postgres connection.
1 attempts remaining. Retrying in 0 seconds.
Error:
connection to server at "localhost" (::1), port 5432 failed: FATAL:  password authentication failed for user "DBT_USER"

[0m14:54:44.434781 [debug] [ThreadPool]: Postgres adapter: Error running SQL: BEGIN
[0m14:54:44.436827 [debug] [ThreadPool]: Postgres adapter: Rolling back transaction.
[0m14:54:44.438760 [debug] [ThreadPool]: Postgres adapter: Error running SQL: macro list_relations_without_caching
[0m14:54:44.440778 [debug] [ThreadPool]: Postgres adapter: Rolling back transaction.
[0m14:54:44.441973 [debug] [ThreadPool]: On list_DBT_DATABASE_public: No close available on handle
[0m14:54:44.444760 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:54:44.446760 [debug] [MainThread]: Connection 'list_DBT_DATABASE_public' was properly closed.
[0m14:54:44.447757 [error] [MainThread]: Encountered an error:
Database Error
  connection to server at "localhost" (::1), port 5432 failed: FATAL:  password authentication failed for user "DBT_USER"
  
[0m14:54:44.451765 [debug] [MainThread]: Command `dbt compile` failed at 14:54:44.450957 after 1.57 seconds
[0m14:54:44.453017 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D7977B6A20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D7978FF470>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D797FA7320>]}
[0m14:54:44.453818 [debug] [MainThread]: Flushing usage events
[0m14:58:41.834684 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E86FE33E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E86D7D7F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E86FE3E30>]}


============================== 14:58:41.844686 | 9862bbbe-79fc-423f-a553-6ea9f961d01f ==============================
[0m14:58:41.844686 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:58:41.847965 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt compile -s test', 'send_anonymous_usage_stats': 'True'}
[0m14:58:42.004389 [error] [MainThread]: Encountered an error:
Runtime Error
  Credentials in profile "kasper", target "dev" invalid: 1234 is not of type 'string'
[0m14:58:42.008384 [debug] [MainThread]: Command `dbt compile` failed at 14:58:42.008384 after 0.53 seconds
[0m14:58:42.011392 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E86E9A750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E86D7D7F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E870A8E00>]}
[0m14:58:42.013386 [debug] [MainThread]: Flushing usage events
[0m14:59:15.473190 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E0E8B1940>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E0E8B18B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E0E8B3E90>]}


============================== 14:59:15.483193 | 70c06da4-dd05-4ecc-9ee7-65edfd812b08 ==============================
[0m14:59:15.483193 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:59:15.486241 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt compile -s test', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m14:59:15.878140 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '70c06da4-dd05-4ecc-9ee7-65edfd812b08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E0E908A40>]}
[0m14:59:16.042676 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '70c06da4-dd05-4ecc-9ee7-65edfd812b08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E0E909E20>]}
[0m14:59:16.046676 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:59:16.071746 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:59:16.118741 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m14:59:16.120742 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '70c06da4-dd05-4ecc-9ee7-65edfd812b08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E0EA335F0>]}
[0m14:59:17.728425 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '70c06da4-dd05-4ecc-9ee7-65edfd812b08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E0E5476E0>]}
[0m14:59:17.743428 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '70c06da4-dd05-4ecc-9ee7-65edfd812b08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E0EE365D0>]}
[0m14:59:17.744424 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m14:59:17.745429 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '70c06da4-dd05-4ecc-9ee7-65edfd812b08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E0EE2CCB0>]}
[0m14:59:17.749440 [info ] [MainThread]: 
[0m14:59:17.751428 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m14:59:17.754538 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m14:59:17.772536 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:59:17.773800 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m14:59:17.775540 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:59:17.882038 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m14:59:17.884049 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:59:17.885051 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m14:59:17.907049 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m14:59:17.909050 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m14:59:17.911055 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m14:59:17.925053 [debug] [MainThread]: Using postgres connection "master"
[0m14:59:17.926092 [debug] [MainThread]: On master: BEGIN
[0m14:59:17.927053 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:59:18.024053 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m14:59:18.025054 [debug] [MainThread]: Using postgres connection "master"
[0m14:59:18.027054 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m14:59:18.048047 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m14:59:18.052051 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '70c06da4-dd05-4ecc-9ee7-65edfd812b08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E0E909190>]}
[0m14:59:18.054053 [debug] [MainThread]: On master: ROLLBACK
[0m14:59:18.055545 [debug] [MainThread]: On master: Close
[0m14:59:18.058050 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:59:18.062057 [info ] [MainThread]: 
[0m14:59:18.074051 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m14:59:18.077059 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m14:59:18.078058 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m14:59:18.104057 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m14:59:18.109053 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 14:59:18.079058 => 14:59:18.108049
[0m14:59:18.111057 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m14:59:18.113052 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 14:59:18.112200 => 14:59:18.112200
[0m14:59:18.118058 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m14:59:18.121051 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:59:18.122050 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m14:59:18.123053 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m14:59:18.125053 [debug] [MainThread]: Command end result
[0m14:59:18.141052 [info ] [MainThread]: Compiled node 'test' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published_ as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                
				ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                
				ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                
				ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
[0m14:59:18.145051 [debug] [MainThread]: Command `dbt compile` succeeded at 14:59:18.145051 after 2.87 seconds
[0m14:59:18.147050 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E08295610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E0E8B3E90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E0E8B16D0>]}
[0m14:59:18.148312 [debug] [MainThread]: Flushing usage events
[0m16:21:33.965537 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B55A2B3680>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B55A2B3020>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B55A2B3410>]}


============================== 16:21:33.973533 | 07810003-65c3-41e3-94f2-5a5fcf2f265d ==============================
[0m16:21:33.973533 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:21:33.975535 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s test', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:21:34.249531 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '07810003-65c3-41e3-94f2-5a5fcf2f265d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B55A379130>]}
[0m16:21:34.372532 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '07810003-65c3-41e3-94f2-5a5fcf2f265d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B55A0988F0>]}
[0m16:21:34.374534 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:21:34.390532 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:21:34.512536 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:21:34.513535 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:21:34.683531 [error] [MainThread]: Encountered an error:
'Undefined' object cannot be interpreted as an integer
[0m16:21:34.691533 [error] [MainThread]: Traceback (most recent call last):
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 91, in wrapper
    result, success = func(*args, **kwargs)
                      ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 76, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 169, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 198, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 245, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 271, in wrapper
    ctx.obj["manifest"] = parse_manifest(
                          ^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\manifest.py", line 1790, in parse_manifest
    manifest = ManifestLoader.get_full_manifest(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\manifest.py", line 318, in get_full_manifest
    manifest = loader.load()
               ^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\manifest.py", line 478, in load
    self.parse_project(
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\manifest.py", line 674, in parse_project
    parser.parse_file(block)
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\base.py", line 483, in parse_file
    self.parse_node(file_block)
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\base.py", line 444, in parse_node
    self.render_update(node, config)
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\models.py", line 360, in render_update
    super().render_update(node, config)
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\base.py", line 420, in render_update
    context = self.render_with_context(node, config)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\base.py", line 269, in render_with_context
    get_rendered(parsed_node.raw_code, context, parsed_node, capture_macros=True)
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\clients\jinja.py", line 600, in get_rendered
    rendered = render_template(template, ctx, node)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\clients\jinja.py", line 546, in render_template
    return template.render(ctx)
           ^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\jinja2\environment.py", line 1301, in render
    self.environment.handle_exception()
  File "C:\Users\hp\dbt\Lib\site-packages\jinja2\environment.py", line 936, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "<template>", line 30, in top-level template code
  File "C:\Users\hp\dbt\Lib\site-packages\jinja2\sandbox.py", line 393, in call
    return __context.call(__obj, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\jinja2\sandbox.py", line 101, in safe_range
    rng = range(*args)
          ^^^^^^^^^^^^
TypeError: 'Undefined' object cannot be interpreted as an integer

[0m16:21:34.695536 [debug] [MainThread]: Command `dbt compile` failed at 16:21:34.695536 after 0.94 seconds
[0m16:21:34.696540 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B553C25610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B559644DA0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B55A308EF0>]}
[0m16:21:34.697536 [debug] [MainThread]: Flushing usage events
[0m16:23:00.997481 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000242B92832F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000242B92822A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000242B92827B0>]}


============================== 16:23:01.003481 | 1ca6bcd0-8648-48c5-be88-fa175796be24 ==============================
[0m16:23:01.003481 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:23:01.005486 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt compile -s test', 'send_anonymous_usage_stats': 'True'}
[0m16:23:01.257480 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1ca6bcd0-8648-48c5-be88-fa175796be24', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000242B92D9A30>]}
[0m16:23:01.373482 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1ca6bcd0-8648-48c5-be88-fa175796be24', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000242B906AE70>]}
[0m16:23:01.375482 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:23:01.388480 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:23:01.469479 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:23:01.470485 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:23:01.630484 [error] [MainThread]: Encountered an error:
'Undefined' object cannot be interpreted as an integer
[0m16:23:01.636481 [error] [MainThread]: Traceback (most recent call last):
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 91, in wrapper
    result, success = func(*args, **kwargs)
                      ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 76, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 169, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 198, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 245, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\cli\requires.py", line 271, in wrapper
    ctx.obj["manifest"] = parse_manifest(
                          ^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\manifest.py", line 1790, in parse_manifest
    manifest = ManifestLoader.get_full_manifest(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\manifest.py", line 318, in get_full_manifest
    manifest = loader.load()
               ^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\manifest.py", line 478, in load
    self.parse_project(
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\manifest.py", line 674, in parse_project
    parser.parse_file(block)
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\base.py", line 483, in parse_file
    self.parse_node(file_block)
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\base.py", line 444, in parse_node
    self.render_update(node, config)
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\models.py", line 360, in render_update
    super().render_update(node, config)
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\base.py", line 420, in render_update
    context = self.render_with_context(node, config)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\parser\base.py", line 269, in render_with_context
    get_rendered(parsed_node.raw_code, context, parsed_node, capture_macros=True)
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\clients\jinja.py", line 600, in get_rendered
    rendered = render_template(template, ctx, node)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\dbt\clients\jinja.py", line 546, in render_template
    return template.render(ctx)
           ^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\jinja2\environment.py", line 1301, in render
    self.environment.handle_exception()
  File "C:\Users\hp\dbt\Lib\site-packages\jinja2\environment.py", line 936, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "<template>", line 22, in top-level template code
  File "C:\Users\hp\dbt\Lib\site-packages\jinja2\sandbox.py", line 393, in call
    return __context.call(__obj, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\hp\dbt\Lib\site-packages\jinja2\sandbox.py", line 101, in safe_range
    rng = range(*args)
          ^^^^^^^^^^^^
TypeError: 'Undefined' object cannot be interpreted as an integer

[0m16:23:01.640488 [debug] [MainThread]: Command `dbt compile` failed at 16:23:01.640488 after 0.79 seconds
[0m16:23:01.641487 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000242B2BB5610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000242B976AF60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000242B970EF30>]}
[0m16:23:01.642485 [debug] [MainThread]: Flushing usage events
[0m16:23:26.936620 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000244AFA53AD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000244AFA51820>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000244AFA52CF0>]}


============================== 16:23:26.942620 | 71c339bc-b3a2-4172-a0a5-d6b2822b1290 ==============================
[0m16:23:26.942620 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:23:26.944622 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt compile -s test', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m16:23:27.199938 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '71c339bc-b3a2-4172-a0a5-d6b2822b1290', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000244AFAA8C50>]}
[0m16:23:27.316942 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '71c339bc-b3a2-4172-a0a5-d6b2822b1290', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000244AFB326C0>]}
[0m16:23:27.318946 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:23:27.332939 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:23:27.418942 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:23:27.419944 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:23:27.587954 [error] [MainThread]: Encountered an error:
Compilation Error in model test (models\test.sql)
  expected token ':', got '}'
    line 22
      {% for i in range(len({{count}})) %}
[0m16:23:27.590962 [debug] [MainThread]: Command `dbt compile` failed at 16:23:27.589962 after 0.79 seconds
[0m16:23:27.591960 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000244AF806000>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000244AFD9EE70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000244AFF5EBA0>]}
[0m16:23:27.592958 [debug] [MainThread]: Flushing usage events
[0m16:24:14.571963 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DC20793D10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DC20792BD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DC20793CB0>]}


============================== 16:24:14.581966 | e026d525-2c50-4522-b37d-467f30b92540 ==============================
[0m16:24:14.581966 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:24:14.583964 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt compile -s test', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:24:15.010958 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e026d525-2c50-4522-b37d-467f30b92540', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DC20793260>]}
[0m16:24:15.128960 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e026d525-2c50-4522-b37d-467f30b92540', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DC207B4230>]}
[0m16:24:15.130962 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:24:15.145964 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:24:15.253001 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:24:15.254984 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:24:15.439984 [error] [MainThread]: Encountered an error:
Compilation Error in model test (models\test.sql)
  expected token ':', got '}'
    line 22
      {% for i in range(len({count})) %}
[0m16:24:15.442982 [debug] [MainThread]: Command `dbt compile` failed at 16:24:15.441984 after 1.03 seconds
[0m16:24:15.442982 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DC20793D10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DC20A41700>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DC20A41820>]}
[0m16:24:15.444981 [debug] [MainThread]: Flushing usage events
[0m16:27:49.896311 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002533A8035F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002533A801910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002533A801B20>]}


============================== 16:27:49.901309 | ceea629c-b5c8-48a8-b112-44865c508ad3 ==============================
[0m16:27:49.901309 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:27:49.903313 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt compile -s test', 'send_anonymous_usage_stats': 'True'}
[0m16:27:50.160310 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ceea629c-b5c8-48a8-b112-44865c508ad3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002533A8E7140>]}
[0m16:27:50.277311 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ceea629c-b5c8-48a8-b112-44865c508ad3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002533A8267B0>]}
[0m16:27:50.279309 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:27:50.293314 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:27:50.374309 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:27:50.375313 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:27:50.532332 [error] [MainThread]: Encountered an error:
Compilation Error in model test (models\test.sql)
  unexpected ')'
    line 22
      {% for i in range(count | lenght)) %}
[0m16:27:50.535313 [debug] [MainThread]: Command `dbt compile` failed at 16:27:50.534317 after 0.83 seconds
[0m16:27:50.536333 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002533A6954C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002533AAA3AD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002533AD0E5A0>]}
[0m16:27:50.537325 [debug] [MainThread]: Flushing usage events
[0m16:28:08.126798 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AC0F7B1D30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AC0F5FF920>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AC0F7B2840>]}


============================== 16:28:08.131800 | 396843b7-f4ed-4202-acb1-b6a2931ad54d ==============================
[0m16:28:08.131800 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:28:08.133802 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt compile -s test', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m16:28:08.388991 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '396843b7-f4ed-4202-acb1-b6a2931ad54d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AC0F808830>]}
[0m16:28:08.507992 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '396843b7-f4ed-4202-acb1-b6a2931ad54d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AC0F442E70>]}
[0m16:28:08.509996 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:28:08.523993 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:28:08.603991 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:28:08.604993 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:28:08.764995 [error] [MainThread]: Encountered an error:
Compilation Error in model test (models\test.sql)
  No filter named 'lenght'.
    line 22
      {% for i in range(count | lenght) %}
[0m16:28:08.767000 [debug] [MainThread]: Command `dbt compile` failed at 16:28:08.767000 after 0.77 seconds
[0m16:28:08.767996 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AC0F59AF60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AC0F7B1D30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AC0F7B1130>]}
[0m16:28:08.769002 [debug] [MainThread]: Flushing usage events
[0m16:28:22.981749 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002481C741850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002481C741880>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002481C7428D0>]}


============================== 16:28:22.987749 | 0a107a2d-e350-4df4-bf37-5114f80521f8 ==============================
[0m16:28:22.987749 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:28:22.989750 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s test', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:28:23.242751 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0a107a2d-e350-4df4-bf37-5114f80521f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002481C798470>]}
[0m16:28:23.361750 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0a107a2d-e350-4df4-bf37-5114f80521f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002481C7690D0>]}
[0m16:28:23.363748 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:28:23.376746 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:28:23.463776 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:28:23.465779 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:28:23.659777 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0a107a2d-e350-4df4-bf37-5114f80521f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002481CA1A2D0>]}
[0m16:28:23.681799 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0a107a2d-e350-4df4-bf37-5114f80521f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002481CAE93D0>]}
[0m16:28:23.682800 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m16:28:23.684798 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0a107a2d-e350-4df4-bf37-5114f80521f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002481CC79910>]}
[0m16:28:23.687819 [info ] [MainThread]: 
[0m16:28:23.689798 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m16:28:23.691797 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m16:28:23.706794 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:28:23.707796 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m16:28:23.708799 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:28:23.769870 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m16:28:23.770874 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:28:23.771873 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m16:28:23.780868 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m16:28:23.782871 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m16:28:23.783871 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m16:28:23.790872 [debug] [MainThread]: Using postgres connection "master"
[0m16:28:23.791871 [debug] [MainThread]: On master: BEGIN
[0m16:28:23.791871 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:28:23.841870 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:28:23.841870 [debug] [MainThread]: Using postgres connection "master"
[0m16:28:23.842869 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m16:28:23.854870 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m16:28:23.857873 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0a107a2d-e350-4df4-bf37-5114f80521f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002481CB8B110>]}
[0m16:28:23.858873 [debug] [MainThread]: On master: ROLLBACK
[0m16:28:23.859877 [debug] [MainThread]: On master: Close
[0m16:28:23.860875 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:28:23.862873 [info ] [MainThread]: 
[0m16:28:23.868869 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m16:28:23.870871 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m16:28:23.870871 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m16:28:23.883874 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m16:28:23.885873 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 16:28:23.871869 => 16:28:23.884883
[0m16:28:23.886874 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m16:28:23.887873 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 16:28:23.887873 => 16:28:23.887873
[0m16:28:23.889873 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m16:28:23.890871 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:28:23.891870 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m16:28:23.892872 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m16:28:23.893872 [debug] [MainThread]: Command end result
[0m16:28:23.903872 [info ] [MainThread]: Compiled node 'test' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published_ as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
				ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
				ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
				ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
[0m16:28:23.907875 [debug] [MainThread]: Command `dbt compile` succeeded at 16:28:23.907875 after 1.06 seconds
[0m16:28:23.909875 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002481C741880>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002481C741850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002481C76BAD0>]}
[0m16:28:23.910871 [debug] [MainThread]: Flushing usage events
[0m16:29:32.361530 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024919603CB0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024918BC57F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024919603FB0>]}


============================== 16:29:32.366528 | 200cdd7a-8bef-42c1-8f77-6c5b0e5f0a13 ==============================
[0m16:29:32.366528 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:29:32.368534 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s test', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:29:32.619527 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '200cdd7a-8bef-42c1-8f77-6c5b0e5f0a13', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024919658260>]}
[0m16:29:32.735529 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '200cdd7a-8bef-42c1-8f77-6c5b0e5f0a13', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000249191C9C10>]}
[0m16:29:32.736531 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:29:32.751528 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:29:32.848528 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:29:32.849532 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:29:33.053558 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '200cdd7a-8bef-42c1-8f77-6c5b0e5f0a13', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024919ACFF20>]}
[0m16:29:33.067589 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '200cdd7a-8bef-42c1-8f77-6c5b0e5f0a13', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000249199A96A0>]}
[0m16:29:33.068560 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m16:29:33.070563 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '200cdd7a-8bef-42c1-8f77-6c5b0e5f0a13', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024919A7E540>]}
[0m16:29:33.073577 [info ] [MainThread]: 
[0m16:29:33.075561 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m16:29:33.077559 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m16:29:33.092559 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:29:33.092559 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m16:29:33.093560 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:29:33.150563 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m16:29:33.151560 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:29:33.151560 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m16:29:33.160558 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m16:29:33.162558 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m16:29:33.162558 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m16:29:33.169558 [debug] [MainThread]: Using postgres connection "master"
[0m16:29:33.170560 [debug] [MainThread]: On master: BEGIN
[0m16:29:33.170560 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:29:33.220560 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:29:33.220560 [debug] [MainThread]: Using postgres connection "master"
[0m16:29:33.221562 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m16:29:33.230556 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m16:29:33.233562 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '200cdd7a-8bef-42c1-8f77-6c5b0e5f0a13', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002491932DDC0>]}
[0m16:29:33.234560 [debug] [MainThread]: On master: ROLLBACK
[0m16:29:33.235559 [debug] [MainThread]: On master: Close
[0m16:29:33.236560 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:29:33.238567 [info ] [MainThread]: 
[0m16:29:33.244556 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m16:29:33.245558 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m16:29:33.246557 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m16:29:33.261557 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m16:29:33.263559 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 16:29:33.246557 => 16:29:33.262558
[0m16:29:33.264559 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m16:29:33.265560 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 16:29:33.265560 => 16:29:33.265560
[0m16:29:33.267558 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m16:29:33.269558 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:29:33.271560 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m16:29:33.272562 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m16:29:33.273559 [debug] [MainThread]: Command end result
[0m16:29:33.284562 [info ] [MainThread]: Compiled node 'test' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published_ as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                
				WHEN categories 
                
				WHEN categories 
                
				WHEN categories 
                
				WHEN categories 
                
				ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                
				WHEN tags 
                
				WHEN tags 
                
				WHEN tags 
                
				ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                
				WHEN tag_r 
                
				WHEN tag_r 
                
				WHEN tag_r 
                
				WHEN tag_r 
                
				WHEN tag_r 
                
				ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
[0m16:29:33.290557 [debug] [MainThread]: Command `dbt compile` succeeded at 16:29:33.289560 after 1.07 seconds
[0m16:29:33.291560 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000249195107A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002491932DAF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024918BC57F0>]}
[0m16:29:33.293569 [debug] [MainThread]: Flushing usage events
[0m16:30:40.757084 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F376B32810>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F376B30E00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F376B32390>]}


============================== 16:30:40.763085 | dcb0bd89-e106-4f57-9ba3-cf0e81bb970a ==============================
[0m16:30:40.763085 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:30:40.765088 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt compile -s test', 'send_anonymous_usage_stats': 'True'}
[0m16:30:41.056089 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'dcb0bd89-e106-4f57-9ba3-cf0e81bb970a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F376B886E0>]}
[0m16:30:41.194087 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'dcb0bd89-e106-4f57-9ba3-cf0e81bb970a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F376B88980>]}
[0m16:30:41.196092 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:30:41.210087 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:30:41.311083 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:30:41.312086 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:30:41.534087 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'dcb0bd89-e106-4f57-9ba3-cf0e81bb970a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F37701AA20>]}
[0m16:30:41.550087 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'dcb0bd89-e106-4f57-9ba3-cf0e81bb970a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F376EF9400>]}
[0m16:30:41.551088 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m16:30:41.553092 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'dcb0bd89-e106-4f57-9ba3-cf0e81bb970a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F376FCE750>]}
[0m16:30:41.556098 [info ] [MainThread]: 
[0m16:30:41.558086 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m16:30:41.560086 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m16:30:41.578083 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:30:41.579089 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m16:30:41.580087 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:30:41.645088 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m16:30:41.646086 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:30:41.647084 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m16:30:41.657087 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m16:30:41.659086 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m16:30:41.660084 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m16:30:41.669089 [debug] [MainThread]: Using postgres connection "master"
[0m16:30:41.669089 [debug] [MainThread]: On master: BEGIN
[0m16:30:41.670091 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:30:41.726089 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:30:41.727088 [debug] [MainThread]: Using postgres connection "master"
[0m16:30:41.728087 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m16:30:41.739084 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m16:30:41.742091 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'dcb0bd89-e106-4f57-9ba3-cf0e81bb970a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F37615AA20>]}
[0m16:30:41.743091 [debug] [MainThread]: On master: ROLLBACK
[0m16:30:41.744089 [debug] [MainThread]: On master: Close
[0m16:30:41.746088 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:30:41.748089 [info ] [MainThread]: 
[0m16:30:41.755087 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m16:30:41.757092 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m16:30:41.757092 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m16:30:41.782090 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m16:30:41.786089 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 16:30:41.758088 => 16:30:41.785091
[0m16:30:41.787092 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m16:30:41.789090 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 16:30:41.788091 => 16:30:41.788091
[0m16:30:41.791088 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m16:30:41.793088 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:30:41.794091 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m16:30:41.794091 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m16:30:41.796090 [debug] [MainThread]: Command end result
[0m16:30:41.807090 [info ] [MainThread]: Compiled node 'test' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published_ as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                
				WHEN categories like Fodsundhed og samfund then Fodsundhed og samfund
                
				WHEN categories like Forebyggelse then Forebyggelse
                
				WHEN categories like Forskning og viden then Forskning og viden
                
				WHEN categories like Praksis then Praksis
                
				ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                
				WHEN tags like Hjælp mig med at forstå then Hjælp mig med at forstå
                
				WHEN tags like Inspirer mig then Inspirer mig
                
				WHEN tags like Giv mig en fordel then Giv mig en fordel
                
				ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                
				WHEN tag_r like Long read then Long read
                
				WHEN tag_r like Kort og godt then Kort og godt
                
				WHEN tag_r like Q&amp then Q&amp
                
				WHEN tag_r like Best Practice then Best Practice
                
				WHEN tag_r like Viden og forskning then Viden og forskning
                
				ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
[0m16:30:41.813087 [debug] [MainThread]: Command `dbt compile` succeeded at 16:30:41.813087 after 1.22 seconds
[0m16:30:41.815090 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F3768CD6A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F376076F30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F376A0CA10>]}
[0m16:30:41.818088 [debug] [MainThread]: Flushing usage events
[0m16:31:42.981544 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000213920C2F30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000213920C20C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000213920C2990>]}


============================== 16:31:42.987543 | d0b2f2ee-62ca-411b-a264-7293798cc95d ==============================
[0m16:31:42.987543 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:31:42.988544 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt compile -s test', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m16:31:43.247543 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd0b2f2ee-62ca-411b-a264-7293798cc95d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000213922D7FB0>]}
[0m16:31:43.365953 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd0b2f2ee-62ca-411b-a264-7293798cc95d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000213920E6630>]}
[0m16:31:43.367954 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:31:43.380951 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:31:43.471950 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:31:43.472956 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:31:43.668952 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd0b2f2ee-62ca-411b-a264-7293798cc95d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000213925DDD90>]}
[0m16:31:43.681958 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd0b2f2ee-62ca-411b-a264-7293798cc95d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002139250A0F0>]}
[0m16:31:43.682956 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m16:31:43.684968 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd0b2f2ee-62ca-411b-a264-7293798cc95d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021392652F60>]}
[0m16:31:43.687961 [info ] [MainThread]: 
[0m16:31:43.689954 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m16:31:43.691953 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m16:31:43.706952 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:31:43.707952 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m16:31:43.708952 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:31:43.762954 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m16:31:43.762954 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:31:43.763952 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m16:31:43.771954 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m16:31:43.774957 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m16:31:43.775953 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m16:31:43.781955 [debug] [MainThread]: Using postgres connection "master"
[0m16:31:43.782958 [debug] [MainThread]: On master: BEGIN
[0m16:31:43.783957 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:31:43.833022 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:31:43.833022 [debug] [MainThread]: Using postgres connection "master"
[0m16:31:43.833955 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m16:31:43.842953 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m16:31:43.846954 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd0b2f2ee-62ca-411b-a264-7293798cc95d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021391B46C90>]}
[0m16:31:43.846954 [debug] [MainThread]: On master: ROLLBACK
[0m16:31:43.847954 [debug] [MainThread]: On master: Close
[0m16:31:43.849953 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:31:43.851957 [info ] [MainThread]: 
[0m16:31:43.856953 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m16:31:43.857953 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m16:31:43.858954 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m16:31:43.876482 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m16:31:43.878484 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 16:31:43.859955 => 16:31:43.877481
[0m16:31:43.879483 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m16:31:43.880482 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 16:31:43.880482 => 16:31:43.880482
[0m16:31:43.883482 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m16:31:43.885480 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:31:43.885480 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m16:31:43.886481 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m16:31:43.888482 [debug] [MainThread]: Command end result
[0m16:31:43.898481 [info ] [MainThread]: Compiled node 'test' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published_ as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                
				WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                
				WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                
				WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                
				WHEN categories like "%Praksis%" then "Praksis"
                
				ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                
				WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                
				WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                
				WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                
				ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                
				WHEN tag_r like "%Long read%" then "Long read"
                
				WHEN tag_r like "%Kort og godt%" then "Kort og godt"
                
				WHEN tag_r like "%Q&amp%" then "Q&amp"
                
				WHEN tag_r like "%Best Practice%" then "Best Practice"
                
				WHEN tag_r like "%Viden og forskning%" then "Viden og forskning"
                
				ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
[0m16:31:43.903481 [debug] [MainThread]: Command `dbt compile` succeeded at 16:31:43.903481 after 1.07 seconds
[0m16:31:43.905483 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002138F1C54C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021392706150>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000213920C2CC0>]}
[0m16:31:43.906494 [debug] [MainThread]: Flushing usage events
[0m16:33:45.852085 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002807A3621E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002807A361CA0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002807A360E90>]}


============================== 16:33:45.857084 | 30c888c6-511f-417c-92c0-07b2d43dcc12 ==============================
[0m16:33:45.857084 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:33:45.859092 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s test', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m16:33:46.115086 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '30c888c6-511f-417c-92c0-07b2d43dcc12', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002807A4477A0>]}
[0m16:33:46.231110 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '30c888c6-511f-417c-92c0-07b2d43dcc12', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002807940EF30>]}
[0m16:33:46.233088 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:33:46.247087 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:33:46.341083 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:33:46.342089 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:33:46.500085 [error] [MainThread]: Encountered an error:
Compilation Error in model test (models\test.sql)
  Encountered unknown tag 'endfor'.
    line 38
      {% endfor %}
[0m16:33:46.503092 [debug] [MainThread]: Command `dbt compile` failed at 16:33:46.502099 after 0.84 seconds
[0m16:33:46.504087 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002807A17B6B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002807A629FD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002807A81E990>]}
[0m16:33:46.505094 [debug] [MainThread]: Flushing usage events
[0m16:34:19.999745 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002324C1F18B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002324BF8D7F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002324C03F920>]}


============================== 16:34:20.004744 | 24be1dfe-87b6-4892-ac9f-dead2e8746ab ==============================
[0m16:34:20.004744 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:34:20.006759 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s test', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:34:20.259746 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '24be1dfe-87b6-4892-ac9f-dead2e8746ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002324C1F0CB0>]}
[0m16:34:20.377745 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '24be1dfe-87b6-4892-ac9f-dead2e8746ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002324C216990>]}
[0m16:34:20.379745 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:34:20.393743 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:34:20.480743 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:34:20.481747 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:34:20.674746 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '24be1dfe-87b6-4892-ac9f-dead2e8746ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002324C6BFC50>]}
[0m16:34:20.689508 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '24be1dfe-87b6-4892-ac9f-dead2e8746ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002324C5E9850>]}
[0m16:34:20.690515 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m16:34:20.692528 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '24be1dfe-87b6-4892-ac9f-dead2e8746ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002324C6F7860>]}
[0m16:34:20.694510 [info ] [MainThread]: 
[0m16:34:20.697509 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m16:34:20.699506 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m16:34:20.715505 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:34:20.716507 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m16:34:20.716507 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:34:20.773508 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m16:34:20.774511 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:34:20.775512 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m16:34:20.783506 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m16:34:20.784506 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m16:34:20.785505 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m16:34:20.792505 [debug] [MainThread]: Using postgres connection "master"
[0m16:34:20.793507 [debug] [MainThread]: On master: BEGIN
[0m16:34:20.793507 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:34:20.843507 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:34:20.843507 [debug] [MainThread]: Using postgres connection "master"
[0m16:34:20.844508 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m16:34:20.853503 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m16:34:20.857505 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '24be1dfe-87b6-4892-ac9f-dead2e8746ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002324BC76CC0>]}
[0m16:34:20.858505 [debug] [MainThread]: On master: ROLLBACK
[0m16:34:20.858505 [debug] [MainThread]: On master: Close
[0m16:34:20.860507 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:34:20.862519 [info ] [MainThread]: 
[0m16:34:20.869504 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m16:34:20.870508 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m16:34:20.871506 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m16:34:20.886505 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m16:34:20.888508 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 16:34:20.871506 => 16:34:20.888508
[0m16:34:20.890505 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m16:34:20.891505 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 16:34:20.891505 => 16:34:20.891505
[0m16:34:20.893505 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m16:34:20.895505 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:34:20.896507 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m16:34:20.896507 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m16:34:20.898506 [debug] [MainThread]: Command end result
[0m16:34:20.909507 [info ] [MainThread]: Compiled node 'test' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published_ as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
				WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                
				WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                
				WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                
				WHEN categories like "%Praksis%" then "Praksis"
                
				ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
				WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                
				WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                
				WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                
				ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
				WHEN tag_r like "%Long read%" then "Long read"
                
				WHEN tag_r like "%Kort og godt%" then "Kort og godt"
                
				WHEN tag_r like "%Q&amp%" then "Q&amp"
                
				WHEN tag_r like "%Best Practice%" then "Best Practice"
                
				WHEN tag_r like "%Viden og forskning%" then "Viden og forskning"
                
				ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
[0m16:34:20.915509 [debug] [MainThread]: Command `dbt compile` succeeded at 16:34:20.914512 after 1.05 seconds
[0m16:34:20.916506 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002324BFD8680>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002324C0CFC20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002324BF8D7F0>]}
[0m16:34:20.919547 [debug] [MainThread]: Flushing usage events
[0m16:34:54.280002 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0F92D1520>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0F873D7F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0F92D1760>]}


============================== 16:34:54.286001 | 1f32a607-e11b-4e4e-8c53-4605fddf8fda ==============================
[0m16:34:54.286001 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:34:54.288017 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s test', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:34:54.538998 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1f32a607-e11b-4e4e-8c53-4605fddf8fda', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0F9328830>]}
[0m16:34:54.659000 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1f32a607-e11b-4e4e-8c53-4605fddf8fda', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0F81CC5C0>]}
[0m16:34:54.661001 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:34:54.676001 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:34:54.778039 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:34:54.779042 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:34:54.978042 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1f32a607-e11b-4e4e-8c53-4605fddf8fda', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0F990D4C0>]}
[0m16:34:54.992043 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1f32a607-e11b-4e4e-8c53-4605fddf8fda', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0F9709550>]}
[0m16:34:54.993045 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m16:34:54.995052 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1f32a607-e11b-4e4e-8c53-4605fddf8fda', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0F97DF860>]}
[0m16:34:54.998055 [info ] [MainThread]: 
[0m16:34:55.001045 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m16:34:55.003042 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m16:34:55.017041 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:34:55.018046 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m16:34:55.019049 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:34:55.080043 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m16:34:55.081045 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:34:55.082049 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m16:34:55.090043 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m16:34:55.092043 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m16:34:55.093041 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m16:34:55.100042 [debug] [MainThread]: Using postgres connection "master"
[0m16:34:55.100042 [debug] [MainThread]: On master: BEGIN
[0m16:34:55.101043 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:34:55.154040 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:34:55.155047 [debug] [MainThread]: Using postgres connection "master"
[0m16:34:55.156044 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m16:34:55.166041 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m16:34:55.170043 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1f32a607-e11b-4e4e-8c53-4605fddf8fda', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0F8D53020>]}
[0m16:34:55.170043 [debug] [MainThread]: On master: ROLLBACK
[0m16:34:55.171043 [debug] [MainThread]: On master: Close
[0m16:34:55.173047 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:34:55.175052 [info ] [MainThread]: 
[0m16:34:55.182043 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m16:34:55.183044 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m16:34:55.184043 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m16:34:55.201049 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m16:34:55.204050 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 16:34:55.186045 => 16:34:55.202054
[0m16:34:55.206043 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m16:34:55.207045 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 16:34:55.207045 => 16:34:55.207045
[0m16:34:55.209044 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m16:34:55.211042 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:34:55.211042 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m16:34:55.212062 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m16:34:55.213044 [debug] [MainThread]: Command end result
[0m16:34:55.224045 [info ] [MainThread]: Compiled node 'test' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published_ as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASEWHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                
				ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASEWHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                
				ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASEWHEN tag_r like "%Long read%" then "Long read"
                WHEN tag_r like "%Kort og godt%" then "Kort og godt"
                WHEN tag_r like "%Q&amp%" then "Q&amp"
                WHEN tag_r like "%Best Practice%" then "Best Practice"
                WHEN tag_r like "%Viden og forskning%" then "Viden og forskning"
                
				ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
[0m16:34:55.229049 [debug] [MainThread]: Command `dbt compile` succeeded at 16:34:55.229049 after 1.08 seconds
[0m16:34:55.230046 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0F92D1760>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0F906D130>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0F873D7F0>]}
[0m16:34:55.231042 [debug] [MainThread]: Flushing usage events
[0m16:35:42.225034 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A444981610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A444983F80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A444983AA0>]}


============================== 16:35:42.230031 | d5af10cc-f397-4d6f-8f87-1289e0769e64 ==============================
[0m16:35:42.230031 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:35:42.232034 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s test', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m16:35:42.567079 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd5af10cc-f397-4d6f-8f87-1289e0769e64', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A444B45400>]}
[0m16:35:42.706080 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd5af10cc-f397-4d6f-8f87-1289e0769e64', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A4449A66C0>]}
[0m16:35:42.708082 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:35:42.723085 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:35:42.822082 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:35:42.823081 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:35:43.034081 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd5af10cc-f397-4d6f-8f87-1289e0769e64', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A444E4F410>]}
[0m16:35:43.049082 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd5af10cc-f397-4d6f-8f87-1289e0769e64', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A444D21490>]}
[0m16:35:43.050083 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m16:35:43.052089 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd5af10cc-f397-4d6f-8f87-1289e0769e64', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A444E9B230>]}
[0m16:35:43.056101 [info ] [MainThread]: 
[0m16:35:43.058081 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m16:35:43.060081 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m16:35:43.077120 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:35:43.078082 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m16:35:43.079081 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:35:43.145081 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m16:35:43.146082 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:35:43.146082 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m16:35:43.156080 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m16:35:43.158078 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m16:35:43.158078 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m16:35:43.167080 [debug] [MainThread]: Using postgres connection "master"
[0m16:35:43.168082 [debug] [MainThread]: On master: BEGIN
[0m16:35:43.169082 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:35:43.221082 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:35:43.222082 [debug] [MainThread]: Using postgres connection "master"
[0m16:35:43.223082 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m16:35:43.232079 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m16:35:43.235084 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd5af10cc-f397-4d6f-8f87-1289e0769e64', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A4439B6C30>]}
[0m16:35:43.236082 [debug] [MainThread]: On master: ROLLBACK
[0m16:35:43.237085 [debug] [MainThread]: On master: Close
[0m16:35:43.239085 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:35:43.241094 [info ] [MainThread]: 
[0m16:35:43.248080 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m16:35:43.249081 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m16:35:43.250081 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m16:35:43.267082 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m16:35:43.269083 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 16:35:43.250081 => 16:35:43.268081
[0m16:35:43.270081 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m16:35:43.273094 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 16:35:43.272096 => 16:35:43.272096
[0m16:35:43.276083 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m16:35:43.279080 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:35:43.279080 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m16:35:43.280084 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m16:35:43.281082 [debug] [MainThread]: Command end result
[0m16:35:43.294143 [info ] [MainThread]: Compiled node 'test' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published_ as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASEWHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"WHEN categories like "%Forebyggelse%" then "Forebyggelse"WHEN categories like "%Forskning og viden%" then "Forskning og viden"WHEN categories like "%Praksis%" then "Praksis"ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASEWHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"WHEN tags like "%Inspirer mig%" then "Inspirer mig"WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASEWHEN tag_r like "%Long read%" then "Long read"WHEN tag_r like "%Kort og godt%" then "Kort og godt"WHEN tag_r like "%Q&amp%" then "Q&amp"WHEN tag_r like "%Best Practice%" then "Best Practice"WHEN tag_r like "%Viden og forskning%" then "Viden og forskning"ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
[0m16:35:43.299084 [debug] [MainThread]: Command `dbt compile` succeeded at 16:35:43.299084 after 1.22 seconds
[0m16:35:43.301088 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A44483AE40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A4445E1DF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A4449A7C20>]}
[0m16:35:43.302085 [debug] [MainThread]: Flushing usage events
[0m16:36:15.008014 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D4C88E1A30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D4C88E3DA0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D4C88E3D40>]}


============================== 16:36:15.013013 | d802dc98-c807-4e99-a63f-f9db2dd4a44e ==============================
[0m16:36:15.013013 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:36:15.015023 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt compile -s test', 'send_anonymous_usage_stats': 'True'}
[0m16:36:15.267011 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd802dc98-c807-4e99-a63f-f9db2dd4a44e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D4C8AD9E20>]}
[0m16:36:15.382012 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd802dc98-c807-4e99-a63f-f9db2dd4a44e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D4C84E2E70>]}
[0m16:36:15.384013 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:36:15.398015 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:36:15.494013 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:36:15.495016 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:36:15.685014 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd802dc98-c807-4e99-a63f-f9db2dd4a44e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D4C8E2AF30>]}
[0m16:36:15.699016 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd802dc98-c807-4e99-a63f-f9db2dd4a44e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D4C8D09A90>]}
[0m16:36:15.700038 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m16:36:15.702021 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd802dc98-c807-4e99-a63f-f9db2dd4a44e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D4C88E37D0>]}
[0m16:36:15.705018 [info ] [MainThread]: 
[0m16:36:15.708018 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m16:36:15.710016 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m16:36:15.724094 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:36:15.726019 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m16:36:15.727015 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:36:15.784017 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m16:36:15.784017 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:36:15.785018 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m16:36:15.793015 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m16:36:15.795015 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m16:36:15.796014 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m16:36:15.803013 [debug] [MainThread]: Using postgres connection "master"
[0m16:36:15.804017 [debug] [MainThread]: On master: BEGIN
[0m16:36:15.805015 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:36:15.854015 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:36:15.854852 [debug] [MainThread]: Using postgres connection "master"
[0m16:36:15.855013 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m16:36:15.866017 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m16:36:15.869013 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd802dc98-c807-4e99-a63f-f9db2dd4a44e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D4C8366CF0>]}
[0m16:36:15.870015 [debug] [MainThread]: On master: ROLLBACK
[0m16:36:15.871015 [debug] [MainThread]: On master: Close
[0m16:36:15.872016 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:36:15.874023 [info ] [MainThread]: 
[0m16:36:15.881014 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m16:36:15.882013 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m16:36:15.883015 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m16:36:15.899012 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m16:36:15.901015 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 16:36:15.884012 => 16:36:15.900013
[0m16:36:15.902014 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m16:36:15.903016 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 16:36:15.903016 => 16:36:15.903016
[0m16:36:15.906021 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m16:36:15.908017 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:36:15.909019 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m16:36:15.909019 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m16:36:15.910017 [debug] [MainThread]: Command end result
[0m16:36:15.921016 [info ] [MainThread]: Compiled node 'test' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published_ as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"WHEN categories like "%Forebyggelse%" then "Forebyggelse"WHEN categories like "%Forskning og viden%" then "Forskning og viden"WHEN categories like "%Praksis%" then "Praksis"ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"WHEN tags like "%Inspirer mig%" then "Inspirer mig"WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tag_r like "%Long read%" then "Long read"WHEN tag_r like "%Kort og godt%" then "Kort og godt"WHEN tag_r like "%Q&amp%" then "Q&amp"WHEN tag_r like "%Best Practice%" then "Best Practice"WHEN tag_r like "%Viden og forskning%" then "Viden og forskning"ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
[0m16:36:15.926015 [debug] [MainThread]: Command `dbt compile` succeeded at 16:36:15.925021 after 1.05 seconds
[0m16:36:15.927014 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D4C22C5610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D4C88E1A90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D4C87BD130>]}
[0m16:36:15.929023 [debug] [MainThread]: Flushing usage events
[0m16:36:39.774125 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FB9E2540>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FB8F38F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FB9E1730>]}


============================== 16:36:39.780126 | aed3f36d-42db-4968-b826-5adf7fc95541 ==============================
[0m16:36:39.780126 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:36:39.782123 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt compile -s test', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m16:36:40.057118 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'aed3f36d-42db-4968-b826-5adf7fc95541', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FBA387D0>]}
[0m16:36:40.174121 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'aed3f36d-42db-4968-b826-5adf7fc95541', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FBAC6750>]}
[0m16:36:40.176124 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:36:40.192125 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:36:40.287122 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:36:40.288122 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:36:40.481118 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'aed3f36d-42db-4968-b826-5adf7fc95541', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FB874DA0>]}
[0m16:36:40.494122 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'aed3f36d-42db-4968-b826-5adf7fc95541', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FBE21910>]}
[0m16:36:40.495125 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m16:36:40.497124 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'aed3f36d-42db-4968-b826-5adf7fc95541', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FBC87710>]}
[0m16:36:40.500128 [info ] [MainThread]: 
[0m16:36:40.503125 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m16:36:40.504129 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m16:36:40.521120 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:36:40.521120 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m16:36:40.522122 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:36:40.578121 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m16:36:40.578121 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:36:40.579122 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m16:36:40.587124 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m16:36:40.589126 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m16:36:40.590126 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m16:36:40.598121 [debug] [MainThread]: Using postgres connection "master"
[0m16:36:40.599122 [debug] [MainThread]: On master: BEGIN
[0m16:36:40.600123 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:36:40.649122 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:36:40.649122 [debug] [MainThread]: Using postgres connection "master"
[0m16:36:40.651123 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m16:36:40.660121 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m16:36:40.664127 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'aed3f36d-42db-4968-b826-5adf7fc95541', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FB466E40>]}
[0m16:36:40.665127 [debug] [MainThread]: On master: ROLLBACK
[0m16:36:40.666122 [debug] [MainThread]: On master: Close
[0m16:36:40.667123 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:36:40.669124 [info ] [MainThread]: 
[0m16:36:40.675126 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m16:36:40.677123 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m16:36:40.678121 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m16:36:40.693122 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m16:36:40.694122 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 16:36:40.678121 => 16:36:40.694122
[0m16:36:40.696120 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m16:36:40.697125 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 16:36:40.697125 => 16:36:40.697125
[0m16:36:40.699125 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m16:36:40.702132 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:36:40.703122 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m16:36:40.703122 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m16:36:40.705122 [debug] [MainThread]: Command end result
[0m16:36:40.723153 [info ] [MainThread]: Compiled node 'test' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published_ as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tag_r like "%Long read%" then "Long read"
                WHEN tag_r like "%Kort og godt%" then "Kort og godt"
                WHEN tag_r like "%Q&amp%" then "Q&amp"
                WHEN tag_r like "%Best Practice%" then "Best Practice"
                WHEN tag_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
[0m16:36:40.728150 [debug] [MainThread]: Command `dbt compile` succeeded at 16:36:40.727153 after 1.08 seconds
[0m16:36:40.729149 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FB91DAF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FB8F38F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FBD11C40>]}
[0m16:36:40.730159 [debug] [MainThread]: Flushing usage events
[0m16:43:00.668811 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029BC0FC2630>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029BC04E57F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029BC0FC35C0>]}


============================== 16:43:00.673821 | 013706be-3180-40fa-ae7b-f24ddf69d236 ==============================
[0m16:43:00.673821 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:43:00.675817 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt compile -s test', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m16:43:00.937808 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '013706be-3180-40fa-ae7b-f24ddf69d236', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029BC1018230>]}
[0m16:43:01.060812 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '013706be-3180-40fa-ae7b-f24ddf69d236', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029BC0FE9B20>]}
[0m16:43:01.061817 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:43:01.077820 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:43:01.175813 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:43:01.176810 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:43:01.338811 [error] [MainThread]: Encountered an error:
Compilation Error in model test (models\test.sql)
  Unexpected end of template. Jinja was looking for the following tags: 'endfor' or 'else'. The innermost block that needs to be closed is 'for'.
    line 48
      last_30_days_article_published_third_{{ count[i] }}
[0m16:43:01.341811 [debug] [MainThread]: Command `dbt compile` failed at 16:43:01.341811 after 0.88 seconds
[0m16:43:01.343837 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029BC0ED3320>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029BC144F050>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029BC14D82F0>]}
[0m16:43:01.344819 [debug] [MainThread]: Flushing usage events
[0m16:43:51.376233 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B46201B20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B46203F20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B46202120>]}


============================== 16:43:51.382231 | 9ac0c29f-22d4-44c7-9650-ecdb9399e568 ==============================
[0m16:43:51.382231 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:43:51.384231 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt compile -s test', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m16:43:51.642232 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9ac0c29f-22d4-44c7-9650-ecdb9399e568', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B46202210>]}
[0m16:43:51.764231 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9ac0c29f-22d4-44c7-9650-ecdb9399e568', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B461E3F80>]}
[0m16:43:51.765237 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:43:51.781230 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:43:51.868229 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:43:51.869235 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:43:52.078512 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '9ac0c29f-22d4-44c7-9650-ecdb9399e568', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B463DC7A0>]}
[0m16:43:52.093513 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '9ac0c29f-22d4-44c7-9650-ecdb9399e568', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B465A51F0>]}
[0m16:43:52.094513 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m16:43:52.096517 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9ac0c29f-22d4-44c7-9650-ecdb9399e568', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B466F48C0>]}
[0m16:43:52.099527 [info ] [MainThread]: 
[0m16:43:52.101512 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m16:43:52.103512 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m16:43:52.119520 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:43:52.120513 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m16:43:52.120513 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:43:52.180513 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m16:43:52.181519 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:43:52.181519 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m16:43:52.190510 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m16:43:52.192516 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m16:43:52.193513 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m16:43:52.202512 [debug] [MainThread]: Using postgres connection "master"
[0m16:43:52.203513 [debug] [MainThread]: On master: BEGIN
[0m16:43:52.203513 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:43:52.252512 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:43:52.253539 [debug] [MainThread]: Using postgres connection "master"
[0m16:43:52.254518 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m16:43:52.264511 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m16:43:52.267514 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9ac0c29f-22d4-44c7-9650-ecdb9399e568', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B46375B50>]}
[0m16:43:52.268513 [debug] [MainThread]: On master: ROLLBACK
[0m16:43:52.269514 [debug] [MainThread]: On master: Close
[0m16:43:52.271512 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:43:52.273515 [info ] [MainThread]: 
[0m16:43:52.280516 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m16:43:52.282517 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m16:43:52.282517 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m16:43:52.300515 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m16:43:52.302516 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 16:43:52.283516 => 16:43:52.301517
[0m16:43:52.303515 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m16:43:52.304516 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 16:43:52.304516 => 16:43:52.304516
[0m16:43:52.305518 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m16:43:52.307516 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:43:52.309522 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m16:43:52.310530 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m16:43:52.311528 [debug] [MainThread]: Command end result
[0m16:43:52.322518 [info ] [MainThread]: Compiled node 'test' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published_ as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tag_r like "%Long read%" then "Long read"
                WHEN tag_r like "%Kort og godt%" then "Kort og godt"
                WHEN tag_r like "%Q&amp%" then "Q&amp"
                WHEN tag_r like "%Best Practice%" then "Best Practice"
                WHEN tag_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    
    ,
    with
    
    last_30_days_article_published_Agg_ as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        
        last_30_days_article_published_third_ 
		where siteid = ', site, '
		group by 1,2
        
        last_30_days_article_published_third_second 
		where siteid = ', site, '
		group by 1,2
        
        last_30_days_article_published_third_third 
		where siteid = ', site, '
		group by 1,2
        
    ),
    
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        
        last_30_days_article_published_third_ 
		where siteid = ', site, '
		group by 1,2
        
        last_30_days_article_published_third_second 
		where siteid = ', site, '
		group by 1,2
        
        last_30_days_article_published_third_third 
		where siteid = ', site, '
		group by 1,2
        
    ),
    
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        
        last_30_days_article_published_third_ 
		where siteid = ', site, '
		group by 1,2
        
        last_30_days_article_published_third_second 
		where siteid = ', site, '
		group by 1,2
        
        last_30_days_article_published_third_third 
		where siteid = ', site, '
		group by 1,2
        
    ),
    
[0m16:43:52.329520 [debug] [MainThread]: Command `dbt compile` succeeded at 16:43:52.328520 after 1.09 seconds
[0m16:43:52.330516 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B460B9730>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B457C5AF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B46227C50>]}
[0m16:43:52.332515 [debug] [MainThread]: Flushing usage events
[0m16:49:14.666731 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013555033680>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000135545557F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000135550334A0>]}


============================== 16:49:14.675731 | 102e0a1b-952a-4880-ab76-651b357df03c ==============================
[0m16:49:14.675731 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:49:14.677731 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'invocation_command': 'dbt compile -s test', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:49:15.034730 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '102e0a1b-952a-4880-ab76-651b357df03c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013555088440>]}
[0m16:49:15.178771 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '102e0a1b-952a-4880-ab76-651b357df03c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013553F2C170>]}
[0m16:49:15.180772 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:49:15.199771 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:49:15.311768 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:49:15.312771 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:49:15.472769 [error] [MainThread]: Encountered an error:
Compilation Error in model test (models\test.sql)
  unexpected char '!' at 1652
    line 47
      {% if !loop.last %}, {% endif%}
[0m16:49:15.475768 [debug] [MainThread]: Command `dbt compile` failed at 16:49:15.475768 after 1.03 seconds
[0m16:49:15.476771 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001354E965610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001355528DAC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013555333470>]}
[0m16:49:15.477785 [debug] [MainThread]: Flushing usage events
[0m16:49:32.469143 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AADDDB33E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AADDDB2B40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AADDDB28A0>]}


============================== 16:49:32.475143 | 411ad3b3-d638-4073-b7f5-d7485b965a67 ==============================
[0m16:49:32.475143 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:49:32.477148 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s test', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:49:32.730141 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '411ad3b3-d638-4073-b7f5-d7485b965a67', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AADD5018E0>]}
[0m16:49:32.847145 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '411ad3b3-d638-4073-b7f5-d7485b965a67', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AADD979E50>]}
[0m16:49:32.849142 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:49:32.866140 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:49:32.945144 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:49:32.946148 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:49:33.139171 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '411ad3b3-d638-4073-b7f5-d7485b965a67', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AADE279BE0>]}
[0m16:49:33.153175 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '411ad3b3-d638-4073-b7f5-d7485b965a67', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AADE159970>]}
[0m16:49:33.154176 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m16:49:33.156178 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '411ad3b3-d638-4073-b7f5-d7485b965a67', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AADD146AB0>]}
[0m16:49:33.160193 [info ] [MainThread]: 
[0m16:49:33.162188 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m16:49:33.164174 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m16:49:33.181175 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:49:33.182174 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m16:49:33.182174 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:49:33.242170 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m16:49:33.243177 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:49:33.244177 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m16:49:33.252172 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m16:49:33.254172 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m16:49:33.255172 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m16:49:33.263170 [debug] [MainThread]: Using postgres connection "master"
[0m16:49:33.264171 [debug] [MainThread]: On master: BEGIN
[0m16:49:33.265174 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:49:33.314171 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:49:33.315177 [debug] [MainThread]: Using postgres connection "master"
[0m16:49:33.316172 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m16:49:33.325170 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m16:49:33.328175 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '411ad3b3-d638-4073-b7f5-d7485b965a67', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AADDE7B290>]}
[0m16:49:33.329174 [debug] [MainThread]: On master: ROLLBACK
[0m16:49:33.330175 [debug] [MainThread]: On master: Close
[0m16:49:33.331179 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:49:33.333179 [info ] [MainThread]: 
[0m16:49:33.340171 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m16:49:33.341174 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m16:49:33.342178 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m16:49:33.359178 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m16:49:33.362186 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 16:49:33.344175 => 16:49:33.361191
[0m16:49:33.364175 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m16:49:33.365190 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 16:49:33.364175 => 16:49:33.364175
[0m16:49:33.366176 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m16:49:33.368171 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:49:33.369173 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m16:49:33.370175 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m16:49:33.371174 [debug] [MainThread]: Command end result
[0m16:49:33.382173 [info ] [MainThread]: Compiled node 'test' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published_ as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_ as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_ 
		where siteid = ', site, '
		group by 1,2
    )
    , 
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    )
    , 
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tag_r like "%Long read%" then "Long read"
                WHEN tag_r like "%Kort og godt%" then "Kort og godt"
                WHEN tag_r like "%Q&amp%" then "Q&amp"
                WHEN tag_r like "%Best Practice%" then "Best Practice"
                WHEN tag_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    )
    
    
[0m16:49:33.387174 [debug] [MainThread]: Command `dbt compile` succeeded at 16:49:33.387174 after 1.05 seconds
[0m16:49:33.388195 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AAD7725610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AADDDD7C50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AAD7800890>]}
[0m16:49:33.389177 [debug] [MainThread]: Flushing usage events
[0m16:50:32.074186 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023B7EA20680>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023B7EA23C20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023B7EA22990>]}


============================== 16:50:32.080188 | 7f19cab7-049d-47d8-a816-bb4e16c507cc ==============================
[0m16:50:32.080188 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:50:32.081190 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt compile -s test', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:50:32.353184 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '7f19cab7-049d-47d8-a816-bb4e16c507cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023B7EC2BCB0>]}
[0m16:50:32.482185 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '7f19cab7-049d-47d8-a816-bb4e16c507cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023B7E5EDE50>]}
[0m16:50:32.484189 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:50:32.499187 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:50:32.599183 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:50:32.601187 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:50:32.802190 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '7f19cab7-049d-47d8-a816-bb4e16c507cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023B7EFCD310>]}
[0m16:50:32.816190 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '7f19cab7-049d-47d8-a816-bb4e16c507cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023B7EDC56A0>]}
[0m16:50:32.817191 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m16:50:32.819189 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7f19cab7-049d-47d8-a816-bb4e16c507cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023B7E9322D0>]}
[0m16:50:32.822201 [info ] [MainThread]: 
[0m16:50:32.824191 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m16:50:32.826187 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m16:50:32.843188 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:50:32.844186 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m16:50:32.844186 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:50:32.905185 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m16:50:32.906189 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:50:32.906189 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m16:50:32.915190 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m16:50:32.917186 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m16:50:32.918188 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m16:50:32.927190 [debug] [MainThread]: Using postgres connection "master"
[0m16:50:32.928192 [debug] [MainThread]: On master: BEGIN
[0m16:50:32.928192 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:50:32.981191 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:50:32.982188 [debug] [MainThread]: Using postgres connection "master"
[0m16:50:32.983187 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m16:50:32.993185 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m16:50:32.996193 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7f19cab7-049d-47d8-a816-bb4e16c507cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023B7EA21D30>]}
[0m16:50:32.997193 [debug] [MainThread]: On master: ROLLBACK
[0m16:50:32.998190 [debug] [MainThread]: On master: Close
[0m16:50:33.000189 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:50:33.002196 [info ] [MainThread]: 
[0m16:50:33.009186 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m16:50:33.010187 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m16:50:33.011187 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m16:50:33.028189 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m16:50:33.030190 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 16:50:33.012188 => 16:50:33.030190
[0m16:50:33.032187 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m16:50:33.034194 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 16:50:33.033231 => 16:50:33.033231
[0m16:50:33.037201 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m16:50:33.039189 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:50:33.040190 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m16:50:33.041186 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m16:50:33.042191 [debug] [MainThread]: Command end result
[0m16:50:33.054191 [info ] [MainThread]: Compiled node 'test' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_ 
		where siteid = ', site, '
		group by 1,2
    )
    , 
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published__second 
		where siteid = ', site, '
		group by 1,2
    )
    , 
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tag_r like "%Long read%" then "Long read"
                WHEN tag_r like "%Kort og godt%" then "Kort og godt"
                WHEN tag_r like "%Q&amp%" then "Q&amp"
                WHEN tag_r like "%Best Practice%" then "Best Practice"
                WHEN tag_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published__third 
		where siteid = ', site, '
		group by 1,2
    )
    
    
[0m16:50:33.060188 [debug] [MainThread]: Command `dbt compile` succeeded at 16:50:33.059188 after 1.13 seconds
[0m16:50:33.061192 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023B7EA20680>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023B7EA22990>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023B7EA21F40>]}
[0m16:50:33.063196 [debug] [MainThread]: Flushing usage events
[0m16:55:26.397228 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B44CE830B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B44CB17920>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B44CE82FF0>]}


============================== 16:55:26.402227 | 26aa9bd9-f2c2-42bb-a59d-fb25ea5fabcc ==============================
[0m16:55:26.402227 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:55:26.404242 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt compile -s test', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:55:26.658229 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '26aa9bd9-f2c2-42bb-a59d-fb25ea5fabcc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B44CF48350>]}
[0m16:55:26.776239 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '26aa9bd9-f2c2-42bb-a59d-fb25ea5fabcc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B44CF492B0>]}
[0m16:55:26.778228 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:55:26.791228 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:55:26.881226 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:55:26.883231 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:55:27.082259 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '26aa9bd9-f2c2-42bb-a59d-fb25ea5fabcc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B44D3682C0>]}
[0m16:55:27.095258 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '26aa9bd9-f2c2-42bb-a59d-fb25ea5fabcc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B44D249520>]}
[0m16:55:27.096258 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m16:55:27.098267 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '26aa9bd9-f2c2-42bb-a59d-fb25ea5fabcc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B44D3DB5F0>]}
[0m16:55:27.101260 [info ] [MainThread]: 
[0m16:55:27.103258 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m16:55:27.105256 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m16:55:27.122255 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:55:27.123258 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m16:55:27.124258 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:55:27.182257 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m16:55:27.182257 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:55:27.183258 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m16:55:27.191257 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m16:55:27.193257 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m16:55:27.194257 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m16:55:27.201255 [debug] [MainThread]: Using postgres connection "master"
[0m16:55:27.201255 [debug] [MainThread]: On master: BEGIN
[0m16:55:27.202256 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:55:27.252254 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:55:27.253257 [debug] [MainThread]: Using postgres connection "master"
[0m16:55:27.254258 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m16:55:27.262255 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m16:55:27.265256 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '26aa9bd9-f2c2-42bb-a59d-fb25ea5fabcc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B44D2EABA0>]}
[0m16:55:27.266254 [debug] [MainThread]: On master: ROLLBACK
[0m16:55:27.267256 [debug] [MainThread]: On master: Close
[0m16:55:27.269256 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:55:27.271272 [info ] [MainThread]: 
[0m16:55:27.278254 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m16:55:27.280255 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m16:55:27.281278 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m16:55:27.297265 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m16:55:27.300268 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 16:55:27.282256 => 16:55:27.299260
[0m16:55:27.301258 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m16:55:27.302258 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 16:55:27.302258 => 16:55:27.302258
[0m16:55:27.304257 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m16:55:27.305255 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:55:27.306256 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m16:55:27.307257 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m16:55:27.308257 [debug] [MainThread]: Command end result
[0m16:55:27.319259 [info ] [MainThread]: Compiled node 'test' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ), 
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_second as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_second e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ), 
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tag_r like "%Long read%" then "Long read"
                WHEN tag_r like "%Kort og godt%" then "Kort og godt"
                WHEN tag_r like "%Q&amp%" then "Q&amp"
                WHEN tag_r like "%Best Practice%" then "Best Practice"
                WHEN tag_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_third as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_third e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    )
    
[0m16:55:27.325257 [debug] [MainThread]: Command `dbt compile` succeeded at 16:55:27.324255 after 1.12 seconds
[0m16:55:27.326256 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B44C8CD460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B44CB17920>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B44CD5D130>]}
[0m16:55:27.328261 [debug] [MainThread]: Flushing usage events
[0m16:59:33.642856 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001737B9D18B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001737AD8D7F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001737B9D1790>]}


============================== 16:59:33.648851 | 2d0e8977-5eec-4776-94b6-a4a5b06977a3 ==============================
[0m16:59:33.648851 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:59:33.650857 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'invocation_command': 'dbt compile -s test', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:59:33.902850 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2d0e8977-5eec-4776-94b6-a4a5b06977a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001737BA28530>]}
[0m16:59:34.020850 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2d0e8977-5eec-4776-94b6-a4a5b06977a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001737BA7A6C0>]}
[0m16:59:34.022855 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:59:34.036852 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:59:34.132850 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:59:34.133853 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:59:34.330852 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2d0e8977-5eec-4776-94b6-a4a5b06977a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001737BCCF710>]}
[0m16:59:34.343854 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2d0e8977-5eec-4776-94b6-a4a5b06977a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001737BDC95B0>]}
[0m16:59:34.344856 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m16:59:34.346853 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2d0e8977-5eec-4776-94b6-a4a5b06977a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001737BAB6D20>]}
[0m16:59:34.349853 [info ] [MainThread]: 
[0m16:59:34.351855 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m16:59:34.353872 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m16:59:34.368851 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:59:34.369853 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m16:59:34.369853 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:59:34.431855 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m16:59:34.432852 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:59:34.432852 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m16:59:34.440873 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m16:59:34.442853 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m16:59:34.443851 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m16:59:34.450852 [debug] [MainThread]: Using postgres connection "master"
[0m16:59:34.450852 [debug] [MainThread]: On master: BEGIN
[0m16:59:34.451853 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:59:34.606094 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:59:34.607090 [debug] [MainThread]: Using postgres connection "master"
[0m16:59:34.608089 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m16:59:34.617092 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m16:59:34.620090 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2d0e8977-5eec-4776-94b6-a4a5b06977a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001737B120290>]}
[0m16:59:34.621088 [debug] [MainThread]: On master: ROLLBACK
[0m16:59:34.622089 [debug] [MainThread]: On master: Close
[0m16:59:34.624089 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:59:34.626096 [info ] [MainThread]: 
[0m16:59:34.632091 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m16:59:34.634095 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m16:59:34.634095 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m16:59:34.651087 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m16:59:34.653090 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 16:59:34.635104 => 16:59:34.652090
[0m16:59:34.654092 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m16:59:34.656098 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 16:59:34.655108 => 16:59:34.655108
[0m16:59:34.659087 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m16:59:34.660091 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:59:34.661091 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m16:59:34.662091 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m16:59:34.664094 [debug] [MainThread]: Command end result
[0m16:59:34.678092 [info ] [MainThread]: Compiled node 'test' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
     agg_cta_per_article as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article
		where siteid = ', site, '
		group by 1
	), 
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_second as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_second e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
     agg_cta_per_article_second as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_second
		where siteid = ', site, '
		group by 1
	), 
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tag_r like "%Long read%" then "Long read"
                WHEN tag_r like "%Kort og godt%" then "Kort og godt"
                WHEN tag_r like "%Q&amp%" then "Q&amp"
                WHEN tag_r like "%Best Practice%" then "Best Practice"
                WHEN tag_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_third as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_third e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
     agg_cta_per_article_third as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_third
		where siteid = ', site, '
		group by 1
	)
    
[0m16:59:34.687089 [debug] [MainThread]: Command `dbt compile` succeeded at 16:59:34.686092 after 1.24 seconds
[0m16:59:34.688091 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001737B7B8680>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017375440890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001737AD8D7F0>]}
[0m16:59:34.689091 [debug] [MainThread]: Flushing usage events
[0m17:13:48.142819 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023257A117F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023257A11940>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023257A11910>]}


============================== 17:13:48.148829 | 45f49fdc-783a-4f26-adbb-7322d8cdc02f ==============================
[0m17:13:48.148829 [info ] [MainThread]: Running with dbt=1.7.13
[0m17:13:48.150824 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s test', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m17:13:48.409820 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '45f49fdc-783a-4f26-adbb-7322d8cdc02f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000232579105F0>]}
[0m17:13:48.529818 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '45f49fdc-783a-4f26-adbb-7322d8cdc02f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000232579F3FE0>]}
[0m17:13:48.531819 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m17:13:48.545818 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m17:13:48.648821 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:13:48.649819 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m17:13:48.852820 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '45f49fdc-783a-4f26-adbb-7322d8cdc02f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023257F35CA0>]}
[0m17:13:48.866820 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '45f49fdc-783a-4f26-adbb-7322d8cdc02f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023257E19760>]}
[0m17:13:48.867820 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m17:13:48.869826 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '45f49fdc-783a-4f26-adbb-7322d8cdc02f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023256F36AB0>]}
[0m17:13:48.872826 [info ] [MainThread]: 
[0m17:13:48.875820 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m17:13:48.877820 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m17:13:48.897818 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:13:48.898819 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m17:13:48.899820 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:13:48.957818 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m17:13:48.958820 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:13:48.958820 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m17:13:48.967818 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m17:13:48.969819 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m17:13:48.970819 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m17:13:48.977817 [debug] [MainThread]: Using postgres connection "master"
[0m17:13:48.978820 [debug] [MainThread]: On master: BEGIN
[0m17:13:48.978820 [debug] [MainThread]: Opening a new connection, currently in state init
[0m17:13:49.028821 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m17:13:49.029821 [debug] [MainThread]: Using postgres connection "master"
[0m17:13:49.030822 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m17:13:49.042818 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m17:13:49.045826 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '45f49fdc-783a-4f26-adbb-7322d8cdc02f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000232578A6C00>]}
[0m17:13:49.046829 [debug] [MainThread]: On master: ROLLBACK
[0m17:13:49.047825 [debug] [MainThread]: On master: Close
[0m17:13:49.049821 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:13:49.051831 [info ] [MainThread]: 
[0m17:13:49.060820 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m17:13:49.062819 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m17:13:49.063818 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m17:13:49.093821 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m17:13:49.097822 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 17:13:49.064822 => 17:13:49.095823
[0m17:13:49.100195 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m17:13:49.102840 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 17:13:49.101820 => 17:13:49.101820
[0m17:13:49.103835 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m17:13:49.105671 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:13:49.106657 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m17:13:49.107659 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m17:13:49.108659 [debug] [MainThread]: Command end result
[0m17:13:49.121657 [info ] [MainThread]: Compiled node 'test' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article
		where siteid = ', site, '
		group by 1
	),
    less_tg_data as(
		select 
        
        l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published l
		left join cta_per_article a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_ as
    (
        select siteid as siteid,tags,sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_
		  where siteid = ', site, '
		group by 1,2
		),
        total_hits as
        (
			select 
				siteid as siteid ,
                sum(hits_tags) as total_tags_hit,
                sum(sum_by_top_10) as agg_by_top_10,
				sum(sum_by_approved) as agg_by_approved 
			from hits_by_tags
			where siteid = ', site, '
			group by 1
		),
        agg_data as(
		select h.siteid,h.tags,coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target 
		,coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
		from hits_by_tags h
		join total_hits t on h.siteid=t.siteid
		join last_30_days_article_published_Agg_ hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
		where h.siteid = ', site, '
		),
        categories_d as (
            select
                siteid as siteid ,',label_val,' as label,',hint_val,' as hint
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
				GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
				GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
			from agg_data
			group by 1,2,3
		),
        categories_ as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d
		),
        json_data as
		(
			SELECT 
				siteid,
				label AS lab, 
				hint AS h,
				cateogires AS cat,
				CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
					   ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
					   ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
			FROM categories
		), 
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_second as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_second e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_second as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_second
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_second as(
		select 
        
        l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_second l
		left join cta_per_article_second a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags__second as
    (
        select siteid as siteid,tags,sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data__second
		  where siteid = ', site, '
		group by 1,2
		),
        total_hits_second as
        (
			select 
				siteid as siteid ,
                sum(hits_tags) as total_tags_hit,
                sum(sum_by_top_10) as agg_by_top_10,
				sum(sum_by_approved) as agg_by_approved 
			from hits_by_tags_second
			where siteid = ', site, '
			group by 1
		),
        agg_data_second as(
		select h.siteid,h.tags,coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target 
		,coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
		from hits_by_tags_second h
		join total_hits_second t on h.siteid=t.siteid
		join last_30_days_article_published_Agg__second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
		where h.siteid = ', site, '
		),
        categories_d_second as (
            select
                siteid as siteid ,',label_val,' as label,',hint_val,' as hint
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
				GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
				GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
			from agg_data_second
			group by 1,2,3
		),
        categories__second as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_second
		),
        json_data_second as
		(
			SELECT 
				siteid,
				label AS lab, 
				hint AS h,
				cateogires AS cat,
				CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
					   ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
					   ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
			FROM categories_second
		), 
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tag_r like "%Long read%" then "Long read"
                WHEN tag_r like "%Kort og godt%" then "Kort og godt"
                WHEN tag_r like "%Q&amp%" then "Q&amp"
                WHEN tag_r like "%Best Practice%" then "Best Practice"
                WHEN tag_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_third as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_third e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_third as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_third
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_third as(
		select 
        
        l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_third l
		left join cta_per_article_third a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags__third as
    (
        select siteid as siteid,tags,sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data__third
		  where siteid = ', site, '
		group by 1,2
		),
        total_hits_third as
        (
			select 
				siteid as siteid ,
                sum(hits_tags) as total_tags_hit,
                sum(sum_by_top_10) as agg_by_top_10,
				sum(sum_by_approved) as agg_by_approved 
			from hits_by_tags_third
			where siteid = ', site, '
			group by 1
		),
        agg_data_third as(
		select h.siteid,h.tags,coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target 
		,coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
		from hits_by_tags_third h
		join total_hits_third t on h.siteid=t.siteid
		join last_30_days_article_published_Agg__third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
		where h.siteid = ', site, '
		),
        categories_d_third as (
            select
                siteid as siteid ,',label_val,' as label,',hint_val,' as hint
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
				GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
				GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
			from agg_data_third
			group by 1,2,3
		),
        categories__third as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_third
		),
        json_data_third as
		(
			SELECT 
				siteid,
				label AS lab, 
				hint AS h,
				cateogires AS cat,
				CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
					   ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
					   ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
			FROM categories_third
		)
    
[0m17:13:49.134657 [debug] [MainThread]: Command `dbt compile` succeeded at 17:13:49.134657 after 1.19 seconds
[0m17:13:49.135657 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000232513D5610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023257A11910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023257A11850>]}
[0m17:13:49.137669 [debug] [MainThread]: Flushing usage events
[0m17:17:41.130116 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027854FA18E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027854FA16A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027854FA1940>]}


============================== 17:17:41.136113 | 12624553-5a81-4f96-9bcb-a7de7c2bf1fd ==============================
[0m17:17:41.136113 [info ] [MainThread]: Running with dbt=1.7.13
[0m17:17:41.138115 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s test', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:17:41.391111 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '12624553-5a81-4f96-9bcb-a7de7c2bf1fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027853E98470>]}
[0m17:17:41.510112 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '12624553-5a81-4f96-9bcb-a7de7c2bf1fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027854F83F80>]}
[0m17:17:41.512112 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m17:17:41.524113 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m17:17:41.624111 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:17:41.625114 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m17:17:41.830113 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '12624553-5a81-4f96-9bcb-a7de7c2bf1fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000278555A1520>]}
[0m17:17:41.843115 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '12624553-5a81-4f96-9bcb-a7de7c2bf1fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027855399A30>]}
[0m17:17:41.844120 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m17:17:41.846115 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '12624553-5a81-4f96-9bcb-a7de7c2bf1fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000278553982C0>]}
[0m17:17:41.848116 [info ] [MainThread]: 
[0m17:17:41.850115 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m17:17:41.851113 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m17:17:41.866115 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:17:41.867118 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m17:17:41.867118 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:17:41.923112 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m17:17:41.924114 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:17:41.925114 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m17:17:41.933112 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m17:17:41.935112 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m17:17:41.936112 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m17:17:41.944111 [debug] [MainThread]: Using postgres connection "master"
[0m17:17:41.944111 [debug] [MainThread]: On master: BEGIN
[0m17:17:41.946115 [debug] [MainThread]: Opening a new connection, currently in state init
[0m17:17:42.031116 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m17:17:42.032119 [debug] [MainThread]: Using postgres connection "master"
[0m17:17:42.034116 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m17:17:42.052117 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m17:17:42.059117 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '12624553-5a81-4f96-9bcb-a7de7c2bf1fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027854A26C30>]}
[0m17:17:42.060114 [debug] [MainThread]: On master: ROLLBACK
[0m17:17:42.062150 [debug] [MainThread]: On master: Close
[0m17:17:42.064113 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:17:42.066113 [info ] [MainThread]: 
[0m17:17:42.073115 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m17:17:42.076115 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m17:17:42.077113 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m17:17:42.124114 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m17:17:42.127112 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 17:17:42.078116 => 17:17:42.126116
[0m17:17:42.129114 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m17:17:42.131116 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 17:17:42.130116 => 17:17:42.130116
[0m17:17:42.135117 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m17:17:42.138115 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:17:42.139116 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m17:17:42.141116 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m17:17:42.143117 [debug] [MainThread]: Command end result
[0m17:17:42.160115 [info ] [MainThread]: Compiled node 'test' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article
		where siteid = ', site, '
		group by 1
	),
    less_tg_data as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published l
		left join cta_per_article a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_ as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_
		  where siteid = ', site, '
		group by 1,2
		),
        total_hits as
        (
			select 
				siteid as siteid ,
                sum(hits_tags) as total_tags_hit,
                sum(sum_by_top_10) as agg_by_top_10,
				sum(sum_by_approved) as agg_by_approved 
			from hits_by_tags
			where siteid = ', site, '
			group by 1
		),
        agg_data
        as(
		    select 
                h.siteid,
                h.tags,
                coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
                coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
		from hits_by_tags h
		join total_hits t on h.siteid=t.siteid
		join last_30_days_article_published_Agg_ hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
		where h.siteid = ', site, '
		),
        categories_d as (
            select
                siteid as siteid ,
                ',label_val,' as label,'
                ,hint_val,' as hint
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
				GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
				GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
			from agg_data
			group by 1,2,3
		),
        categories_ as (
		    select
                siteid as siteid,
                label as label,
                hint as hint,  
		        CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		        less_than_target as less_than_target ,
		        approved as approved ,
		        top_10 as top_10 
		 from  categories_d
		),
        json_data as
		(
			SELECT 
				siteid,
				label AS lab, 
				hint AS h,
				cateogires AS cat,
				CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
					   ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
					   ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
			FROM categories
		), 
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_second as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_second e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_second as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_second
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_second as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_second l
		left join cta_per_article_second a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags__second as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data__second
		  where siteid = ', site, '
		group by 1,2
		),
        total_hits_second as
        (
			select 
				siteid as siteid ,
                sum(hits_tags) as total_tags_hit,
                sum(sum_by_top_10) as agg_by_top_10,
				sum(sum_by_approved) as agg_by_approved 
			from hits_by_tags_second
			where siteid = ', site, '
			group by 1
		),
        agg_data_second
        as(
		    select 
                h.siteid,
                h.tags,
                coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
                coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
		from hits_by_tags_second h
		join total_hits_second t on h.siteid=t.siteid
		join last_30_days_article_published_Agg__second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
		where h.siteid = ', site, '
		),
        categories_d_second as (
            select
                siteid as siteid ,
                ',label_val,' as label,'
                ,hint_val,' as hint
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
				GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
				GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
			from agg_data_second
			group by 1,2,3
		),
        categories__second as (
		    select
                siteid as siteid,
                label as label,
                hint as hint,  
		        CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		        less_than_target as less_than_target ,
		        approved as approved ,
		        top_10 as top_10 
		 from  categories_d_second
		),
        json_data_second as
		(
			SELECT 
				siteid,
				label AS lab, 
				hint AS h,
				cateogires AS cat,
				CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
					   ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
					   ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
			FROM categories_second
		), 
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tag_r like "%Long read%" then "Long read"
                WHEN tag_r like "%Kort og godt%" then "Kort og godt"
                WHEN tag_r like "%Q&amp%" then "Q&amp"
                WHEN tag_r like "%Best Practice%" then "Best Practice"
                WHEN tag_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_third as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_third e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_third as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_third
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_third as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_third l
		left join cta_per_article_third a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags__third as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data__third
		  where siteid = ', site, '
		group by 1,2
		),
        total_hits_third as
        (
			select 
				siteid as siteid ,
                sum(hits_tags) as total_tags_hit,
                sum(sum_by_top_10) as agg_by_top_10,
				sum(sum_by_approved) as agg_by_approved 
			from hits_by_tags_third
			where siteid = ', site, '
			group by 1
		),
        agg_data_third
        as(
		    select 
                h.siteid,
                h.tags,
                coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
                coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
		from hits_by_tags_third h
		join total_hits_third t on h.siteid=t.siteid
		join last_30_days_article_published_Agg__third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
		where h.siteid = ', site, '
		),
        categories_d_third as (
            select
                siteid as siteid ,
                ',label_val,' as label,'
                ,hint_val,' as hint
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
				GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
				GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
			from agg_data_third
			group by 1,2,3
		),
        categories__third as (
		    select
                siteid as siteid,
                label as label,
                hint as hint,  
		        CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		        less_than_target as less_than_target ,
		        approved as approved ,
		        top_10 as top_10 
		 from  categories_d_third
		),
        json_data_third as
		(
			SELECT 
				siteid,
				label AS lab, 
				hint AS h,
				cateogires AS cat,
				CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
					   ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
					   ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
			FROM categories_third
		)
    
[0m17:17:42.176120 [debug] [MainThread]: Command `dbt compile` succeeded at 17:17:42.176120 after 1.20 seconds
[0m17:17:42.178120 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027854E36B10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027854FC7CE0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027854B6D3A0>]}
[0m17:17:42.179114 [debug] [MainThread]: Flushing usage events
[0m17:35:19.573683 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202056E21E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202056E2CF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202056E1C10>]}


============================== 17:35:19.583684 | 2fa6428c-a0ab-4f0b-a12f-3c22023f4e04 ==============================
[0m17:35:19.583684 [info ] [MainThread]: Running with dbt=1.7.13
[0m17:35:19.587269 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt compile -s test', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m17:35:19.990927 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2fa6428c-a0ab-4f0b-a12f-3c22023f4e04', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002020540D640>]}
[0m17:35:20.119116 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2fa6428c-a0ab-4f0b-a12f-3c22023f4e04', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202057080E0>]}
[0m17:35:20.121115 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m17:35:20.141210 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m17:35:20.343105 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:35:20.345104 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m17:35:20.588102 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2fa6428c-a0ab-4f0b-a12f-3c22023f4e04', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020205BDF050>]}
[0m17:35:20.605104 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2fa6428c-a0ab-4f0b-a12f-3c22023f4e04', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020205B09700>]}
[0m17:35:20.607115 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m17:35:20.609106 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2fa6428c-a0ab-4f0b-a12f-3c22023f4e04', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020205C2E900>]}
[0m17:35:20.612108 [info ] [MainThread]: 
[0m17:35:20.614115 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m17:35:20.617105 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m17:35:20.637106 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:35:20.639116 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m17:35:20.641114 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:35:20.724109 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m17:35:20.725146 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:35:20.726108 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m17:35:20.738311 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m17:35:20.741135 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m17:35:20.742340 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m17:35:20.752133 [debug] [MainThread]: Using postgres connection "master"
[0m17:35:20.754141 [debug] [MainThread]: On master: BEGIN
[0m17:35:20.755137 [debug] [MainThread]: Opening a new connection, currently in state init
[0m17:35:20.838030 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m17:35:20.840002 [debug] [MainThread]: Using postgres connection "master"
[0m17:35:20.842182 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m17:35:20.859622 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m17:35:20.864435 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2fa6428c-a0ab-4f0b-a12f-3c22023f4e04', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202056E2D20>]}
[0m17:35:20.866435 [debug] [MainThread]: On master: ROLLBACK
[0m17:35:20.868433 [debug] [MainThread]: On master: Close
[0m17:35:20.871475 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:35:20.874443 [info ] [MainThread]: 
[0m17:35:20.883431 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m17:35:20.885431 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m17:35:20.886429 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m17:35:20.919429 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m17:35:20.922436 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 17:35:20.887431 => 17:35:20.921437
[0m17:35:20.924434 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m17:35:20.926434 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 17:35:20.925434 => 17:35:20.925434
[0m17:35:20.928430 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m17:35:20.930434 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:35:20.931431 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m17:35:20.932675 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m17:35:20.933430 [debug] [MainThread]: Command end result
[0m17:35:20.946967 [info ] [MainThread]: Compiled node 'test' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article
		where siteid = ', site, '
		group by 1
	),
    less_tg_data as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published l
		left join cta_per_article a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_ as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_
		  where siteid = ', site, '
		group by 1,2
		),
        total_hits as
        (
			select 
				siteid as siteid ,
                sum(hits_tags) as total_tags_hit,
                sum(sum_by_top_10) as agg_by_top_10,
				sum(sum_by_approved) as agg_by_approved 
			from hits_by_tags
			where siteid = ', site, '
			group by 1
		),
        agg_data
        as(
		    select 
                h.siteid,
                h.tags,
                coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
                coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
		from hits_by_tags h
		join total_hits t on h.siteid=t.siteid
		join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
		where h.siteid = ', site, '
		),
        categories_d as (
            select
                siteid as siteid ,
                ',label_val,' as label,'
                ,hint_val,' as hint
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
				GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
				GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
			from agg_data
			group by 1,2,3
		),
        categories_ as (
		    select
                siteid as siteid,
                label as label,
                hint as hint,  
		        CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		        less_than_target as less_than_target ,
		        approved as approved ,
		        top_10 as top_10 
		 from  categories_d
		),
        json_data as
		(
			SELECT 
				siteid,
				label AS lab, 
				hint AS h,
				cateogires AS cat,
				CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
					   ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
					   ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
			FROM categories
		),, 
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_second as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_second e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_second as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_second
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_second as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_second l
		left join cta_per_article_second a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags__second as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data__second
		  where siteid = ', site, '
		group by 1,2
		),
        total_hits_second as
        (
			select 
				siteid as siteid ,
                sum(hits_tags) as total_tags_hit,
                sum(sum_by_top_10) as agg_by_top_10,
				sum(sum_by_approved) as agg_by_approved 
			from hits_by_tags_second
			where siteid = ', site, '
			group by 1
		),
        agg_data_second
        as(
		    select 
                h.siteid,
                h.tags,
                coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
                coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
		from hits_by_tags_second h
		join total_hits_second t on h.siteid=t.siteid
		join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
		where h.siteid = ', site, '
		),
        categories_d_second as (
            select
                siteid as siteid ,
                ',label_val,' as label,'
                ,hint_val,' as hint
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
				GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
				GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
			from agg_data_second
			group by 1,2,3
		),
        categories__second as (
		    select
                siteid as siteid,
                label as label,
                hint as hint,  
		        CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		        less_than_target as less_than_target ,
		        approved as approved ,
		        top_10 as top_10 
		 from  categories_d_second
		),
        json_data_second as
		(
			SELECT 
				siteid,
				label AS lab, 
				hint AS h,
				cateogires AS cat,
				CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
					   ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
					   ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
			FROM categories_second
		),, 
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tag_r like "%Long read%" then "Long read"
                WHEN tag_r like "%Kort og godt%" then "Kort og godt"
                WHEN tag_r like "%Q&amp%" then "Q&amp"
                WHEN tag_r like "%Best Practice%" then "Best Practice"
                WHEN tag_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_third as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_third e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_third as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_third
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_third as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_third l
		left join cta_per_article_third a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags__third as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data__third
		  where siteid = ', site, '
		group by 1,2
		),
        total_hits_third as
        (
			select 
				siteid as siteid ,
                sum(hits_tags) as total_tags_hit,
                sum(sum_by_top_10) as agg_by_top_10,
				sum(sum_by_approved) as agg_by_approved 
			from hits_by_tags_third
			where siteid = ', site, '
			group by 1
		),
        agg_data_third
        as(
		    select 
                h.siteid,
                h.tags,
                coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
                coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
		from hits_by_tags_third h
		join total_hits_third t on h.siteid=t.siteid
		join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
		where h.siteid = ', site, '
		),
        categories_d_third as (
            select
                siteid as siteid ,
                ',label_val,' as label,'
                ,hint_val,' as hint
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
				GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
				GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
			from agg_data_third
			group by 1,2,3
		),
        categories__third as (
		    select
                siteid as siteid,
                label as label,
                hint as hint,  
		        CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		        less_than_target as less_than_target ,
		        approved as approved ,
		        top_10 as top_10 
		 from  categories_d_third
		),
        json_data_third as
		(
			SELECT 
				siteid,
				label AS lab, 
				hint AS h,
				cateogires AS cat,
				CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
					   ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
					   ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
			FROM categories_third
		),
    
[0m17:35:20.964979 [debug] [MainThread]: Command `dbt compile` succeeded at 17:35:20.964979 after 1.58 seconds
[0m17:35:20.966970 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202052E1C70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020205789DC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002020485DEE0>]}
[0m17:35:20.967972 [debug] [MainThread]: Flushing usage events
[0m17:40:52.598817 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000206BA972ED0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000206B9EE57F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000206BA973F20>]}


============================== 17:40:52.611630 | b62247f1-f1ff-4e44-8a83-33be3ffab151 ==============================
[0m17:40:52.611630 [info ] [MainThread]: Running with dbt=1.7.13
[0m17:40:52.616411 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt compile -s test', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m17:40:53.436552 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'b62247f1-f1ff-4e44-8a83-33be3ffab151', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000206BA84CB30>]}
[0m17:40:53.759845 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'b62247f1-f1ff-4e44-8a83-33be3ffab151', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000206BA999490>]}
[0m17:40:53.764849 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m17:40:53.793842 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m17:40:54.032296 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:40:54.034295 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m17:40:54.579529 [error] [MainThread]: Encountered an error:
Compilation Error in model test (models\test.sql)
  unexpected '}'
    line 5
      {% set diction3 = {0: 'order_statement_first', 1%}
[0m17:40:54.584521 [debug] [MainThread]: Command `dbt compile` failed at 17:40:54.583521 after 2.37 seconds
[0m17:40:54.587536 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000206B4345610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000206BA99A870>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000206BAC69820>]}
[0m17:40:54.590522 [debug] [MainThread]: Flushing usage events
[0m17:42:39.870019 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021433CE13D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002143393F920>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021433CE16D0>]}


============================== 17:42:39.880018 | 76b629c9-d9f9-4cd2-854e-1af9185845d5 ==============================
[0m17:42:39.880018 [info ] [MainThread]: Running with dbt=1.7.13
[0m17:42:39.884027 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt compile -s test', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m17:42:40.315066 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '76b629c9-d9f9-4cd2-854e-1af9185845d5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021433DC9CD0>]}
[0m17:42:40.550142 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '76b629c9-d9f9-4cd2-854e-1af9185845d5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021433D39F10>]}
[0m17:42:40.553137 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m17:42:40.581225 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m17:42:40.749220 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:42:40.751229 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m17:42:41.013277 [error] [MainThread]: Encountered an error:
Compilation Error in model test (models\test.sql)
  unexpected '}'
    line 5
      {% set diction3 = {0: 'order_statement_first', 1: 'tag_statement_additional', 2: 'order_statement_third'%}}
[0m17:42:41.017498 [debug] [MainThread]: Command `dbt compile` failed at 17:42:41.016282 after 1.50 seconds
[0m17:42:41.018280 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021433AC8680>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021433FBAF60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021433E82F60>]}
[0m17:42:41.019281 [debug] [MainThread]: Flushing usage events
[0m17:43:16.348481 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001924EBA3B30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001924EBA2000>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001924EBA2840>]}


============================== 17:43:16.358480 | 02c33bd4-0f8e-4f28-817c-bc3c67c7edbd ==============================
[0m17:43:16.358480 [info ] [MainThread]: Running with dbt=1.7.13
[0m17:43:16.362647 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt compile -s test', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m17:43:16.744725 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '02c33bd4-0f8e-4f28-817c-bc3c67c7edbd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001924EBF8B30>]}
[0m17:43:16.916725 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '02c33bd4-0f8e-4f28-817c-bc3c67c7edbd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001924EBC4EF0>]}
[0m17:43:16.919727 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m17:43:16.947729 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m17:43:17.095724 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:43:17.097745 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m17:43:17.374261 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '02c33bd4-0f8e-4f28-817c-bc3c67c7edbd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001924F129BE0>]}
[0m17:43:17.399262 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '02c33bd4-0f8e-4f28-817c-bc3c67c7edbd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001924EF9D610>]}
[0m17:43:17.400262 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m17:43:17.403259 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '02c33bd4-0f8e-4f28-817c-bc3c67c7edbd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001924EF9C230>]}
[0m17:43:17.408278 [info ] [MainThread]: 
[0m17:43:17.412265 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m17:43:17.415259 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m17:43:17.447258 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:43:17.449260 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m17:43:17.450647 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:43:17.555552 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m17:43:17.557438 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:43:17.558263 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m17:43:17.574318 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m17:43:17.578323 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m17:43:17.579655 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m17:43:17.596320 [debug] [MainThread]: Using postgres connection "master"
[0m17:43:17.597318 [debug] [MainThread]: On master: BEGIN
[0m17:43:17.599320 [debug] [MainThread]: Opening a new connection, currently in state init
[0m17:43:17.686425 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m17:43:17.687379 [debug] [MainThread]: Using postgres connection "master"
[0m17:43:17.689377 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m17:43:17.702372 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m17:43:17.707376 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '02c33bd4-0f8e-4f28-817c-bc3c67c7edbd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001924EBF88F0>]}
[0m17:43:17.708375 [debug] [MainThread]: On master: ROLLBACK
[0m17:43:17.710383 [debug] [MainThread]: On master: Close
[0m17:43:17.712375 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:43:17.714380 [info ] [MainThread]: 
[0m17:43:17.723477 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m17:43:17.726380 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m17:43:17.727376 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m17:43:17.763377 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m17:43:17.765380 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 17:43:17.728375 => 17:43:17.765380
[0m17:43:17.767376 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m17:43:17.768380 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 17:43:17.767376 => 17:43:17.767376
[0m17:43:17.771680 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m17:43:17.774376 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:43:17.775588 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m17:43:17.776376 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m17:43:17.778375 [debug] [MainThread]: Command end result
[0m17:43:17.795380 [info ] [MainThread]: Compiled node 'test' is:







CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article
		where siteid = ', site, '
		group by 1
	),
    less_tg_data as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published l
		left join cta_per_article a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_ as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_
		  where siteid = ', site, '
		group by 1,2
		),
        total_hits as
        (
			select 
				siteid as siteid ,
                sum(hits_tags) as total_tags_hit,
                sum(sum_by_top_10) as agg_by_top_10,
				sum(sum_by_approved) as agg_by_approved 
			from hits_by_tags
			where siteid = ', site, '
			group by 1
		),
        agg_data
        as(
		    select 
                h.siteid,
                h.tags,
                coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
                coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
		from hits_by_tags h
		join total_hits t on h.siteid=t.siteid
		join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
		where h.siteid = ', site, '
		),
        categories_d as (
            select
                siteid as siteid ,
                ',label_val,' as label,'
                ,hint_val,' as hint
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS less_than_target,
				GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS approved,
				GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_first, ', ''others'') SEPARATOR '','') AS top_10
			from agg_data
			group by 1,2,3
		),
        categories_ as (
		    select
                siteid as siteid,
                label as label,
                hint as hint,  
		        CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		        less_than_target as less_than_target ,
		        approved as approved ,
		        top_10 as top_10 
		 from  categories_d
		),
        json_data as
		(
			SELECT 
				siteid,
				label AS lab, 
				hint AS h,
				cateogires AS cat,
				CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
					   ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
					   ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
			FROM categories
		),, 
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_second as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_second e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_second as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_second
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_second as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_second l
		left join cta_per_article_second a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags__second as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data__second
		  where siteid = ', site, '
		group by 1,2
		),
        total_hits_second as
        (
			select 
				siteid as siteid ,
                sum(hits_tags) as total_tags_hit,
                sum(sum_by_top_10) as agg_by_top_10,
				sum(sum_by_approved) as agg_by_approved 
			from hits_by_tags_second
			where siteid = ', site, '
			group by 1
		),
        agg_data_second
        as(
		    select 
                h.siteid,
                h.tags,
                coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
                coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
		from hits_by_tags_second h
		join total_hits_second t on h.siteid=t.siteid
		join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
		where h.siteid = ', site, '
		),
        categories_d_second as (
            select
                siteid as siteid ,
                ',label_val,' as label,'
                ,hint_val,' as hint
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
				GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
				GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
			from agg_data_second
			group by 1,2,3
		),
        categories__second as (
		    select
                siteid as siteid,
                label as label,
                hint as hint,  
		        CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		        less_than_target as less_than_target ,
		        approved as approved ,
		        top_10 as top_10 
		 from  categories_d_second
		),
        json_data_second as
		(
			SELECT 
				siteid,
				label AS lab, 
				hint AS h,
				cateogires AS cat,
				CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
					   ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
					   ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
			FROM categories_second
		),, 
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tag_r like "%Long read%" then "Long read"
                WHEN tag_r like "%Kort og godt%" then "Kort og godt"
                WHEN tag_r like "%Q&amp%" then "Q&amp"
                WHEN tag_r like "%Best Practice%" then "Best Practice"
                WHEN tag_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_third as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_third e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_third as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_third
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_third as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_third l
		left join cta_per_article_third a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags__third as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data__third
		  where siteid = ', site, '
		group by 1,2
		),
        total_hits_third as
        (
			select 
				siteid as siteid ,
                sum(hits_tags) as total_tags_hit,
                sum(sum_by_top_10) as agg_by_top_10,
				sum(sum_by_approved) as agg_by_approved 
			from hits_by_tags_third
			where siteid = ', site, '
			group by 1
		),
        agg_data_third
        as(
		    select 
                h.siteid,
                h.tags,
                coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
                coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
		from hits_by_tags_third h
		join total_hits_third t on h.siteid=t.siteid
		join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
		where h.siteid = ', site, '
		),
        categories_d_third as (
            select
                siteid as siteid ,
                ',label_val,' as label,'
                ,hint_val,' as hint
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS less_than_target,
				GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS approved,
				GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_third, ', ''others'') SEPARATOR '','') AS top_10
			from agg_data_third
			group by 1,2,3
		),
        categories__third as (
		    select
                siteid as siteid,
                label as label,
                hint as hint,  
		        CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		        less_than_target as less_than_target ,
		        approved as approved ,
		        top_10 as top_10 
		 from  categories_d_third
		),
        json_data_third as
		(
			SELECT 
				siteid,
				label AS lab, 
				hint AS h,
				cateogires AS cat,
				CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
					   ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
					   ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
			FROM categories_third
		),
    
[0m17:43:17.815375 [debug] [MainThread]: Command `dbt compile` succeeded at 17:43:17.815375 after 1.72 seconds
[0m17:43:17.816374 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019248535610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001924E165AF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001924EAB12B0>]}
[0m17:43:17.818146 [debug] [MainThread]: Flushing usage events
[0m18:14:23.831433 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A198679E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A18C1EC60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A196AD7F0>]}


============================== 18:14:23.843605 | 57506310-fe8c-4d96-a556-ee1e519d02a2 ==============================
[0m18:14:23.843605 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:14:23.846436 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt compile -s test', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m18:14:24.178771 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '57506310-fe8c-4d96-a556-ee1e519d02a2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A198B9A60>]}
[0m18:14:24.308079 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '57506310-fe8c-4d96-a556-ee1e519d02a2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A19615E80>]}
[0m18:14:24.310113 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:14:24.328122 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:14:24.499123 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:14:24.500126 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m18:14:24.715136 [error] [MainThread]: Encountered an error:
Compilation Error in model test (models\test.sql)
  Unexpected end of template. Jinja was looking for the following tags: 'endfor' or 'else'. The innermost block that needs to be closed is 'for'.
    line 158
      {% for i in range(count | length) %}
[0m18:14:24.719127 [debug] [MainThread]: Command `dbt compile` failed at 18:14:24.719127 after 1.25 seconds
[0m18:14:24.721137 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A132E0890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A19CFBBC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A19DBEE40>]}
[0m18:14:24.723157 [debug] [MainThread]: Flushing usage events
[0m18:20:27.916797 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C521331700>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5203DD7F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C521331910>]}


============================== 18:20:27.926652 | 7452a54b-391c-4b9a-97d2-f60c4f5078b8 ==============================
[0m18:20:27.926652 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:20:27.929795 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s test', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m18:20:28.257261 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '7452a54b-391c-4b9a-97d2-f60c4f5078b8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C521388260>]}
[0m18:20:28.451369 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '7452a54b-391c-4b9a-97d2-f60c4f5078b8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C521389A60>]}
[0m18:20:28.454459 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:20:28.479825 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:20:28.655676 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:20:28.657762 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m18:20:29.004669 [error] [MainThread]: Encountered an error:
Compilation Error
  Model 'model.dbt_project_test_kasper.test' (models\test.sql) depends on a node named 'json_data' which was not found
[0m18:20:29.007708 [debug] [MainThread]: Command `dbt compile` failed at 18:20:29.007708 after 1.45 seconds
[0m18:20:29.009803 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C52105DDC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C521503CB0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5215009B0>]}
[0m18:20:29.010687 [debug] [MainThread]: Flushing usage events
[0m18:23:59.641064 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001966C72DE80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001966CB619A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001966CB618E0>]}


============================== 18:23:59.648059 | 3165803a-a7af-4ad6-8ae6-238ece739c9e ==============================
[0m18:23:59.648059 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:23:59.650685 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s test', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:23:59.959847 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3165803a-a7af-4ad6-8ae6-238ece739c9e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001966CB851F0>]}
[0m18:24:00.100843 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3165803a-a7af-4ad6-8ae6-238ece739c9e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001966C9AFFE0>]}
[0m18:24:00.103183 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:24:00.119844 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:24:00.258843 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:24:00.259845 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m18:24:00.527844 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3165803a-a7af-4ad6-8ae6-238ece739c9e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001966D141370>]}
[0m18:24:00.542423 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3165803a-a7af-4ad6-8ae6-238ece739c9e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001966CF394F0>]}
[0m18:24:00.543887 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m18:24:00.545130 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3165803a-a7af-4ad6-8ae6-238ece739c9e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001966D05B800>]}
[0m18:24:00.548845 [info ] [MainThread]: 
[0m18:24:00.550848 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:24:00.553853 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:24:00.581092 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:24:00.583090 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:24:00.584092 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:24:00.687353 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:24:00.688772 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:24:00.690385 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:24:00.708176 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:24:00.712238 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:24:00.713175 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:24:00.727183 [debug] [MainThread]: Using postgres connection "master"
[0m18:24:00.729187 [debug] [MainThread]: On master: BEGIN
[0m18:24:00.731180 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:24:00.833890 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:24:00.835697 [debug] [MainThread]: Using postgres connection "master"
[0m18:24:00.836635 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:24:00.847633 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:24:00.851636 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3165803a-a7af-4ad6-8ae6-238ece739c9e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001966C5E2F30>]}
[0m18:24:00.852678 [debug] [MainThread]: On master: ROLLBACK
[0m18:24:00.853637 [debug] [MainThread]: On master: Close
[0m18:24:00.855638 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:24:00.858642 [info ] [MainThread]: 
[0m18:24:00.865635 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m18:24:00.867637 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m18:24:00.868732 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m18:24:00.900711 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m18:24:00.902732 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 18:24:00.869698 => 18:24:00.901710
[0m18:24:00.903714 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m18:24:00.905712 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 18:24:00.904709 => 18:24:00.904709
[0m18:24:00.907711 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m18:24:00.909713 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:24:00.910718 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:24:00.911708 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m18:24:00.912711 [debug] [MainThread]: Command end result
[0m18:24:00.927707 [info ] [MainThread]: Compiled node 'test' is:







CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article
		where siteid = ', site, '
		group by 1
	),
    less_tg_data as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published l
		left join cta_per_article a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_ as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags
        where siteid = ', site, '
        group by 1
    ),
    agg_data as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags h
        join total_hits t on h.siteid=t.siteid
        join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_first, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data
        group by 1,2,3
    ),
    categories_ as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d
    ),
    json_data as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories
    ), 
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_second as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_second e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_second as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_second
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_second as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_second l
		left join cta_per_article_second a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags__second as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data__second
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_second as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_second
        where siteid = ', site, '
        group by 1
    ),
    agg_data_second as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_second h
        join total_hits_second t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_second as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_second
        group by 1,2,3
    ),
    categories__second as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_second
    ),
    json_data_second as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_second
    ), 
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tag_r like "%Long read%" then "Long read"
                WHEN tag_r like "%Kort og godt%" then "Kort og godt"
                WHEN tag_r like "%Q&amp%" then "Q&amp"
                WHEN tag_r like "%Best Practice%" then "Best Practice"
                WHEN tag_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_third as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_third e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_third as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_third
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_third as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_third l
		left join cta_per_article_third a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags__third as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data__third
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_third as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_third
        where siteid = ', site, '
        group by 1
    ),
    agg_data_third as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_third h
        join total_hits_third t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_third as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_third, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_third
        group by 1,2,3
    ),
    categories__third as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_third
    ),
    json_data_third as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_third
    )
    
    SELECT 
		CONCAT(
        ''{'',''"site":'',jd.siteid,'','',
        ''"data": {'',
        ''"label": "'', jd.lab, ''",'',
        ''"categories": ['', jd.cat, ''],'',
        ''"series": ['', jd.series, '']'',
        '',"defaultTitle":"',dtitle,'"'',
        '',"additional":[ {'',
        ''"title":"',title1,'",'',

        ''"data": {'',
        ''"label": "'',jnd.lab, ''",'',
        ''"categories": ['', jnd.cat, ''],'',
        ''"series": ['', jnd.series, '']'',
        ''}},'',
        ''{"title":"',title2,'",'',
        
        ''"data": {'',
        ''"label": "'', jrd.lab, ''",'',
        ''"categories": ['', jrd.cat, ''],'',
        ''"series": ['', jrd.series, '']'',
        ''}}]}}''
    
			) as json_data
		  FROM json_data jd
          CROSS join json_data_second jnd
          CROSS join json_data_third jrd;
[0m18:24:00.945717 [debug] [MainThread]: Command `dbt compile` succeeded at 18:24:00.945717 after 1.59 seconds
[0m18:24:00.947395 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001966CA717F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001966CB619A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001966CB618E0>]}
[0m18:24:00.948724 [debug] [MainThread]: Flushing usage events
[0m10:57:13.397335 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000226176D0F50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000226176D3350>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000226176D36E0>]}


============================== 10:57:13.410156 | 47446137-d85b-4431-9e95-c91103f0f485 ==============================
[0m10:57:13.410156 [info ] [MainThread]: Running with dbt=1.7.13
[0m10:57:13.413164 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt compile -s test', 'send_anonymous_usage_stats': 'True'}
[0m10:57:13.909074 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '47446137-d85b-4431-9e95-c91103f0f485', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000226179C14F0>]}
[0m10:57:14.085071 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '47446137-d85b-4431-9e95-c91103f0f485', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000226174B9400>]}
[0m10:57:14.088075 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m10:57:14.133550 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m10:57:15.673972 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m10:57:15.675338 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m10:57:15.688966 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '47446137-d85b-4431-9e95-c91103f0f485', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000226165C8E60>]}
[0m10:57:15.725565 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '47446137-d85b-4431-9e95-c91103f0f485', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022617B59550>]}
[0m10:57:15.727566 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m10:57:15.729568 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '47446137-d85b-4431-9e95-c91103f0f485', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000226177B65D0>]}
[0m10:57:15.733563 [info ] [MainThread]: 
[0m10:57:15.737567 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m10:57:15.739565 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m10:57:15.770575 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m10:57:15.772106 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m10:57:15.773574 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:57:15.877730 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m10:57:15.878724 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m10:57:15.880746 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m10:57:15.897617 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m10:57:15.900615 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m10:57:15.902618 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m10:57:15.919618 [debug] [MainThread]: Using postgres connection "master"
[0m10:57:15.920616 [debug] [MainThread]: On master: BEGIN
[0m10:57:15.921614 [debug] [MainThread]: Opening a new connection, currently in state init
[0m10:57:16.025169 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m10:57:16.026574 [debug] [MainThread]: Using postgres connection "master"
[0m10:57:16.027095 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m10:57:16.043435 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m10:57:16.045434 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '47446137-d85b-4431-9e95-c91103f0f485', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000226179272F0>]}
[0m10:57:16.047500 [debug] [MainThread]: On master: ROLLBACK
[0m10:57:16.048437 [debug] [MainThread]: On master: Close
[0m10:57:16.051439 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m10:57:16.053440 [info ] [MainThread]: 
[0m10:57:16.061509 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m10:57:16.063436 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m10:57:16.064438 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m10:57:16.102438 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m10:57:16.106458 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 10:57:16.066581 => 10:57:16.104437
[0m10:57:16.107440 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m10:57:16.109440 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 10:57:16.108439 => 10:57:16.108439
[0m10:57:16.111438 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m10:57:16.114440 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:57:16.116441 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m10:57:16.117578 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m10:57:16.119437 [debug] [MainThread]: Command end result
[0m10:57:16.142745 [info ] [MainThread]: Compiled node 'test' is:







CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article
		where siteid = ', site, '
		group by 1
	),
    less_tg_data as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published l
		left join cta_per_article a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_ as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags
        where siteid = ', site, '
        group by 1
    ),
    agg_data as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags h
        join total_hits t on h.siteid=t.siteid
        join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_first, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data
        group by 1,2,3
    ),
    categories_ as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d
    ),
    json_data as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories
    ), 
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_second as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_second e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_second as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_second
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_second as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_second l
		left join cta_per_article_second a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags__second as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data__second
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_second as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_second
        where siteid = ', site, '
        group by 1
    ),
    agg_data_second as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_second h
        join total_hits_second t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_second as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_second
        group by 1,2,3
    ),
    categories__second as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_second
    ),
    json_data_second as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_second
    ), 
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tag_r like "%Long read%" then "Long read"
                WHEN tag_r like "%Kort og godt%" then "Kort og godt"
                WHEN tag_r like "%Q&amp%" then "Q&amp"
                WHEN tag_r like "%Best Practice%" then "Best Practice"
                WHEN tag_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_third as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_third e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_third as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_third
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_third as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_third l
		left join cta_per_article_third a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags__third as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data__third
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_third as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_third
        where siteid = ', site, '
        group by 1
    ),
    agg_data_third as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_third h
        join total_hits_third t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_third as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_third, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_third
        group by 1,2,3
    ),
    categories__third as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_third
    ),
    json_data_third as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_third
    )
    
    SELECT 
		CONCAT(
        ''{'',''"site":'',jd.siteid,'','',
        ''"data": {'',
        ''"label": "'', jd.lab, ''",'',
        ''"categories": ['', jd.cat, ''],'',
        ''"series": ['', jd.series, '']'',
        '',"defaultTitle":"',dtitle,'"'',
        '',"additional":[ {'',
        ''"title":"',title1,'",'',

        ''"data": {'',
        ''"label": "'',jnd.lab, ''",'',
        ''"categories": ['', jnd.cat, ''],'',
        ''"series": ['', jnd.series, '']'',
        ''}},'',
        ''{"title":"',title2,'",'',
        
        ''"data": {'',
        ''"label": "'', jrd.lab, ''",'',
        ''"categories": ['', jrd.cat, ''],'',
        ''"series": ['', jrd.series, '']'',
        ''}}]}}''
    
			) as json_data
		  FROM json_data jd
          CROSS join json_data_second jnd
          CROSS join json_data_third jrd;
[0m10:57:16.173746 [debug] [MainThread]: Command `dbt compile` succeeded at 10:57:16.173085 after 3.17 seconds
[0m10:57:16.177750 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022611005610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000226173FCA40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000226176F8B60>]}
[0m10:57:16.181753 [debug] [MainThread]: Flushing usage events
[0m11:37:41.468097 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024453302ED0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024453303500>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024453300C20>]}


============================== 11:37:41.482414 | e0fbe344-d93b-4c5a-b352-3f660e13ef30 ==============================
[0m11:37:41.482414 [info ] [MainThread]: Running with dbt=1.7.13
[0m11:37:41.485417 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt compile -s test', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m11:37:42.084212 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e0fbe344-d93b-4c5a-b352-3f660e13ef30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024453553B30>]}
[0m11:37:42.468298 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e0fbe344-d93b-4c5a-b352-3f660e13ef30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024453152E70>]}
[0m11:37:42.480931 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m11:37:42.519232 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m11:37:42.789506 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m11:37:42.791511 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m11:37:43.302683 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e0fbe344-d93b-4c5a-b352-3f660e13ef30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024453879BE0>]}
[0m11:37:43.339600 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e0fbe344-d93b-4c5a-b352-3f660e13ef30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000244536E96D0>]}
[0m11:37:43.341603 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m11:37:43.344602 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e0fbe344-d93b-4c5a-b352-3f660e13ef30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024453838D70>]}
[0m11:37:43.351601 [info ] [MainThread]: 
[0m11:37:43.356601 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m11:37:43.366603 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m11:37:43.408603 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:37:43.410600 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m11:37:43.413088 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:37:43.561754 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m11:37:43.563718 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:37:43.564717 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m11:37:43.582712 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m11:37:43.585713 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m11:37:43.587714 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m11:37:43.601717 [debug] [MainThread]: Using postgres connection "master"
[0m11:37:43.602714 [debug] [MainThread]: On master: BEGIN
[0m11:37:43.603715 [debug] [MainThread]: Opening a new connection, currently in state init
[0m11:37:43.694609 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m11:37:43.696611 [debug] [MainThread]: Using postgres connection "master"
[0m11:37:43.698605 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m11:37:43.725005 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m11:37:43.733014 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e0fbe344-d93b-4c5a-b352-3f660e13ef30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000244533C97F0>]}
[0m11:37:43.734007 [debug] [MainThread]: On master: ROLLBACK
[0m11:37:43.736006 [debug] [MainThread]: On master: Close
[0m11:37:43.741011 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:37:43.745332 [info ] [MainThread]: 
[0m11:37:43.760085 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m11:37:43.764042 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m11:37:43.766009 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m11:37:43.823980 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m11:37:43.829977 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 11:37:43.767984 => 11:37:43.828270
[0m11:37:43.832979 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m11:37:43.834978 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 11:37:43.833985 => 11:37:43.833985
[0m11:37:43.839187 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m11:37:43.843501 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:37:43.845205 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m11:37:43.848205 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m11:37:43.850205 [debug] [MainThread]: Command end result
[0m11:37:43.879204 [info ] [MainThread]: Compiled node 'test' is:







CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article
		where siteid = ', site, '
		group by 1
	),
    less_tg_data as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published l
		left join cta_per_article a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_ as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags
        where siteid = ', site, '
        group by 1
    ),
    agg_data as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags h
        join total_hits t on h.siteid=t.siteid
        join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_first, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data
        group by 1,2,3
    ),
    categories as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d
    ),
    json_data as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories
    ), 
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_second as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_second e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_second as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_second
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_second as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_second l
		left join cta_per_article_second a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags__second as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data__second
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_second as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_second
        where siteid = ', site, '
        group by 1
    ),
    agg_data_second as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_second h
        join total_hits_second t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_second as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_second
        group by 1,2,3
    ),
    categories_second as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_second
    ),
    json_data_second as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_second
    ), 
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tag_r like "%Long read%" then "Long read"
                WHEN tag_r like "%Kort og godt%" then "Kort og godt"
                WHEN tag_r like "%Q&amp%" then "Q&amp"
                WHEN tag_r like "%Best Practice%" then "Best Practice"
                WHEN tag_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_third as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_third e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_third as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_third
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_third as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_third l
		left join cta_per_article_third a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags__third as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data__third
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_third as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_third
        where siteid = ', site, '
        group by 1
    ),
    agg_data_third as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_third h
        join total_hits_third t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_third as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_third, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_third
        group by 1,2,3
    ),
    categories_third as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_third
    ),
    json_data_third as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_third
    )
    
    SELECT 
		CONCAT(
        ''{'',''"site":'',jd.siteid,'','',
        ''"data": {'',
        ''"label": "'', jd.lab, ''",'',
        ''"categories": ['', jd.cat, ''],'',
        ''"series": ['', jd.series, '']'',
        '',"defaultTitle":"',dtitle,'"'',
        '',"additional":[ {'',
        ''"title":"',title1,'",'',

        ''"data": {'',
        ''"label": "'',jnd.lab, ''",'',
        ''"categories": ['', jnd.cat, ''],'',
        ''"series": ['', jnd.series, '']'',
        ''}},'',
        ''{"title":"',title2,'",'',
        
        ''"data": {'',
        ''"label": "'', jrd.lab, ''",'',
        ''"categories": ['', jrd.cat, ''],'',
        ''"series": ['', jrd.series, '']'',
        ''}}]}}''
    
			) as json_data
		  FROM json_data jd
          CROSS join json_data_second jnd
          CROSS join json_data_third jrd;
[0m11:37:43.910206 [debug] [MainThread]: Command `dbt compile` succeeded at 11:37:43.909206 after 2.91 seconds
[0m11:37:43.912443 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002444CCE5490>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024453754770>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024453754D70>]}
[0m11:37:43.916205 [debug] [MainThread]: Flushing usage events
[0m11:40:50.150393 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D01DED2DE0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D01DED3B00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D01DED1D30>]}


============================== 11:40:50.160389 | 63059940-7134-4424-8865-3696b52283db ==============================
[0m11:40:50.160389 [info ] [MainThread]: Running with dbt=1.7.13
[0m11:40:50.163396 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt compile -s test', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m11:40:50.508579 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '63059940-7134-4424-8865-3696b52283db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D01DF284D0>]}
[0m11:40:50.640579 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '63059940-7134-4424-8865-3696b52283db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D01E09CC20>]}
[0m11:40:50.642680 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m11:40:50.661624 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m11:40:50.838478 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m11:40:50.840704 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m11:40:51.227549 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '63059940-7134-4424-8865-3696b52283db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D01E469BE0>]}
[0m11:40:51.251131 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '63059940-7134-4424-8865-3696b52283db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D01E2D9850>]}
[0m11:40:51.252671 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m11:40:51.255670 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '63059940-7134-4424-8865-3696b52283db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D01DBA6AB0>]}
[0m11:40:51.261736 [info ] [MainThread]: 
[0m11:40:51.264663 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m11:40:51.267665 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m11:40:51.299732 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:40:51.301107 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m11:40:51.302647 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:40:51.402883 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m11:40:51.403884 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:40:51.405335 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m11:40:51.420889 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m11:40:51.424907 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m11:40:51.425891 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m11:40:51.441885 [debug] [MainThread]: Using postgres connection "master"
[0m11:40:51.442884 [debug] [MainThread]: On master: BEGIN
[0m11:40:51.444444 [debug] [MainThread]: Opening a new connection, currently in state init
[0m11:40:51.537612 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m11:40:51.538703 [debug] [MainThread]: Using postgres connection "master"
[0m11:40:51.540229 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m11:40:51.555355 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m11:40:51.559293 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '63059940-7134-4424-8865-3696b52283db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D01DF7B920>]}
[0m11:40:51.561293 [debug] [MainThread]: On master: ROLLBACK
[0m11:40:51.562295 [debug] [MainThread]: On master: Close
[0m11:40:51.564291 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:40:51.566298 [info ] [MainThread]: 
[0m11:40:51.574293 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m11:40:51.578293 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m11:40:51.579287 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m11:40:51.614462 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m11:40:51.617462 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 11:40:51.579287 => 11:40:51.616463
[0m11:40:51.619460 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m11:40:51.621468 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 11:40:51.620466 => 11:40:51.620466
[0m11:40:51.624460 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m11:40:51.626462 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:40:51.628104 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m11:40:51.628465 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m11:40:51.630466 [debug] [MainThread]: Command end result
[0m11:40:51.646465 [info ] [MainThread]: Compiled node 'test' is:







CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article
		where siteid = ', site, '
		group by 1
	),
    less_tg_data as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published l
		left join cta_per_article a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags
        where siteid = ', site, '
        group by 1
    ),
    agg_data as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags h
        join total_hits t on h.siteid=t.siteid
        join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_first, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data
        group by 1,2,3
    ),
    categories as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d
    ),
    json_data as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories
    ), 
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_second as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_second e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_second as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_second
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_second as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_second l
		left join cta_per_article_second a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_second as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data__second
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_second as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_second
        where siteid = ', site, '
        group by 1
    ),
    agg_data_second as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_second h
        join total_hits_second t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_second as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_second
        group by 1,2,3
    ),
    categories_second as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_second
    ),
    json_data_second as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_second
    ), 
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tag_r like "%Long read%" then "Long read"
                WHEN tag_r like "%Kort og godt%" then "Kort og godt"
                WHEN tag_r like "%Q&amp%" then "Q&amp"
                WHEN tag_r like "%Best Practice%" then "Best Practice"
                WHEN tag_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_third as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_third e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_third as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_third
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_third as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_third l
		left join cta_per_article_third a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_third as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data__third
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_third as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_third
        where siteid = ', site, '
        group by 1
    ),
    agg_data_third as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_third h
        join total_hits_third t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_third as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_third, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_third
        group by 1,2,3
    ),
    categories_third as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_third
    ),
    json_data_third as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_third
    )
    
    SELECT 
		CONCAT(
        ''{'',''"site":'',jd.siteid,'','',
        ''"data": {'',
        ''"label": "'', jd.lab, ''",'',
        ''"categories": ['', jd.cat, ''],'',
        ''"series": ['', jd.series, '']'',
        '',"defaultTitle":"',dtitle,'"'',
        '',"additional":[ {'',
        ''"title":"',title1,'",'',

        ''"data": {'',
        ''"label": "'',jnd.lab, ''",'',
        ''"categories": ['', jnd.cat, ''],'',
        ''"series": ['', jnd.series, '']'',
        ''}},'',
        ''{"title":"',title2,'",'',
        
        ''"data": {'',
        ''"label": "'', jrd.lab, ''",'',
        ''"categories": ['', jrd.cat, ''],'',
        ''"series": ['', jrd.series, '']'',
        ''}}]}}''
    
			) as json_data
		  FROM json_data jd
          CROSS join json_data_second jnd
          CROSS join json_data_third jrd;
[0m11:40:51.675889 [debug] [MainThread]: Command `dbt compile` succeeded at 11:40:51.675889 after 1.85 seconds
[0m11:40:51.677873 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D017805610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D01DED3B00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D01DED2DE0>]}
[0m11:40:51.678873 [debug] [MainThread]: Flushing usage events
[0m11:43:36.471871 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9B13A2930>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9B11EF920>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9B13A2F30>]}


============================== 11:43:36.478867 | ecff6ead-a0e4-4636-a92e-6a747200a1b1 ==============================
[0m11:43:36.478867 [info ] [MainThread]: Running with dbt=1.7.13
[0m11:43:36.480874 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s test', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m11:43:36.808115 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ecff6ead-a0e4-4636-a92e-6a747200a1b1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9B13F8470>]}
[0m11:43:36.951147 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ecff6ead-a0e4-4636-a92e-6a747200a1b1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9B12358B0>]}
[0m11:43:36.953150 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m11:43:36.970254 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m11:43:37.096247 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m11:43:37.098245 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m11:43:37.398809 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ecff6ead-a0e4-4636-a92e-6a747200a1b1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9B1969820>]}
[0m11:43:37.414812 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ecff6ead-a0e4-4636-a92e-6a747200a1b1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9B17894C0>]}
[0m11:43:37.415814 [info ] [MainThread]: Found 1 model, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m11:43:37.416894 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ecff6ead-a0e4-4636-a92e-6a747200a1b1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9B18FB800>]}
[0m11:43:37.420811 [info ] [MainThread]: 
[0m11:43:37.422813 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m11:43:37.425842 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m11:43:37.446942 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:43:37.447833 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m11:43:37.449045 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:43:37.523982 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m11:43:37.525160 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:43:37.525861 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m11:43:37.536858 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m11:43:37.538857 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m11:43:37.540858 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m11:43:37.548862 [debug] [MainThread]: Using postgres connection "master"
[0m11:43:37.550091 [debug] [MainThread]: On master: BEGIN
[0m11:43:37.550862 [debug] [MainThread]: Opening a new connection, currently in state init
[0m11:43:37.617203 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m11:43:37.617859 [debug] [MainThread]: Using postgres connection "master"
[0m11:43:37.618914 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m11:43:37.632883 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m11:43:37.637868 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ecff6ead-a0e4-4636-a92e-6a747200a1b1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9B0E26CC0>]}
[0m11:43:37.638863 [debug] [MainThread]: On master: ROLLBACK
[0m11:43:37.640859 [debug] [MainThread]: On master: Close
[0m11:43:37.642857 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:43:37.644965 [info ] [MainThread]: 
[0m11:43:37.662830 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m11:43:37.665831 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m11:43:37.667829 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m11:43:37.699827 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m11:43:37.701827 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 11:43:37.668441 => 11:43:37.701671
[0m11:43:37.703829 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m11:43:37.705891 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 11:43:37.704830 => 11:43:37.704830
[0m11:43:37.707904 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m11:43:37.710904 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:43:37.712302 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m11:43:37.712906 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m11:43:37.714906 [debug] [MainThread]: Command end result
[0m11:43:37.729905 [info ] [MainThread]: Compiled node 'test' is:







CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article
		where siteid = ', site, '
		group by 1
	),
    less_tg_data as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published l
		left join cta_per_article a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags
        where siteid = ', site, '
        group by 1
    ),
    agg_data as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags h
        join total_hits t on h.siteid=t.siteid
        join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_first, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data
        group by 1,2,3
    ),
    categories as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d
    ),
    json_data as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories
    ), 
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_second as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_second e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_second as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_second
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_second as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_second l
		left join cta_per_article_second a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_second as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_second
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_second as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_second
        where siteid = ', site, '
        group by 1
    ),
    agg_data_second as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_second h
        join total_hits_second t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_second as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_second
        group by 1,2,3
    ),
    categories_second as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_second
    ),
    json_data_second as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_second
    ), 
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tag_r like "%Long read%" then "Long read"
                WHEN tag_r like "%Kort og godt%" then "Kort og godt"
                WHEN tag_r like "%Q&amp%" then "Q&amp"
                WHEN tag_r like "%Best Practice%" then "Best Practice"
                WHEN tag_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_third as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_third e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_third as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_third
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_third as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_third l
		left join cta_per_article_third a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_third as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_third
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_third as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_third
        where siteid = ', site, '
        group by 1
    ),
    agg_data_third as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_third h
        join total_hits_third t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_third as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_third, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_third
        group by 1,2,3
    ),
    categories_third as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_third
    ),
    json_data_third as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_third
    )
    
    SELECT 
		CONCAT(
        ''{'',''"site":'',jd.siteid,'','',
        ''"data": {'',
        ''"label": "'', jd.lab, ''",'',
        ''"categories": ['', jd.cat, ''],'',
        ''"series": ['', jd.series, '']'',
        '',"defaultTitle":"',dtitle,'"'',
        '',"additional":[ {'',
        ''"title":"',title1,'",'',

        ''"data": {'',
        ''"label": "'',jnd.lab, ''",'',
        ''"categories": ['', jnd.cat, ''],'',
        ''"series": ['', jnd.series, '']'',
        ''}},'',
        ''{"title":"',title2,'",'',
        
        ''"data": {'',
        ''"label": "'', jrd.lab, ''",'',
        ''"categories": ['', jrd.cat, ''],'',
        ''"series": ['', jrd.series, '']'',
        ''}}]}}''
    
			) as json_data
		  FROM json_data jd
          CROSS join json_data_second jnd
          CROSS join json_data_third jrd;
[0m11:43:37.749903 [debug] [MainThread]: Command `dbt compile` succeeded at 11:43:37.748907 after 1.52 seconds
[0m11:43:37.751361 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9B118AFC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9B13A2420>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9B13A3C50>]}
[0m11:43:37.751903 [debug] [MainThread]: Flushing usage events
[0m16:42:28.564515 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F172863620>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F172863290>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F172863B60>]}


============================== 16:42:28.571515 | 90e3383f-72e8-4765-a2ee-51a7cb946489 ==============================
[0m16:42:28.571515 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:42:28.574518 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s test', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:42:28.916445 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '90e3383f-72e8-4765-a2ee-51a7cb946489', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F172770D40>]}
[0m16:42:29.040445 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '90e3383f-72e8-4765-a2ee-51a7cb946489', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F172843FE0>]}
[0m16:42:29.042448 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:42:29.067293 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:42:29.845211 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 1 files changed.
[0m16:42:29.846212 [debug] [MainThread]: Partial parsing: added file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_dropdown_dbt_test.sql
[0m16:42:29.847216 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:42:30.056242 [error] [MainThread]: Encountered an error:
Compilation Error in model test (models\test.sql)
  expected token 'end of statement block', got ':'
    line 6
      {%set additional_data_dictionary= 0:'Brugerbehov',1:'Formater'}
[0m16:42:30.059240 [debug] [MainThread]: Command `dbt compile` failed at 16:42:30.059240 after 1.71 seconds
[0m16:42:30.060236 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F172B91130>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F172862390>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F172E303B0>]}
[0m16:42:30.061240 [debug] [MainThread]: Flushing usage events
[0m16:51:24.696325 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A89893C80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A89893D10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A89891B20>]}


============================== 16:51:24.703327 | 9fec9831-46b2-443c-a35b-2dd912a6d091 ==============================
[0m16:51:24.703327 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:51:24.705332 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'invocation_command': 'dbt compile -s test', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:51:24.964327 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9fec9831-46b2-443c-a35b-2dd912a6d091', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A897A14F0>]}
[0m16:51:25.084324 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9fec9831-46b2-443c-a35b-2dd912a6d091', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A89958C20>]}
[0m16:51:25.086326 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:51:25.100325 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:51:25.191327 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 1 files changed.
[0m16:51:25.192347 [debug] [MainThread]: Partial parsing: added file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_dropdown_dbt_test.sql
[0m16:51:25.193328 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m16:51:25.418324 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '9fec9831-46b2-443c-a35b-2dd912a6d091', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A89DC74A0>]}
[0m16:51:25.455327 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '9fec9831-46b2-443c-a35b-2dd912a6d091', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A89C6CA70>]}
[0m16:51:25.456329 [info ] [MainThread]: Found 2 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m16:51:25.458333 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9fec9831-46b2-443c-a35b-2dd912a6d091', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A89E7A360>]}
[0m16:51:25.461333 [info ] [MainThread]: 
[0m16:51:25.464326 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m16:51:25.466325 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m16:51:25.482323 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:51:25.483348 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m16:51:25.484327 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:51:25.542615 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m16:51:25.543630 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:51:25.544627 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m16:51:25.555141 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m16:51:25.558138 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m16:51:25.558138 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m16:51:25.565138 [debug] [MainThread]: Using postgres connection "master"
[0m16:51:25.566139 [debug] [MainThread]: On master: BEGIN
[0m16:51:25.567139 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:51:25.617142 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:51:25.617142 [debug] [MainThread]: Using postgres connection "master"
[0m16:51:25.619142 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m16:51:25.635140 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m16:51:25.638138 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9fec9831-46b2-443c-a35b-2dd912a6d091', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A89C6CD70>]}
[0m16:51:25.640139 [debug] [MainThread]: On master: ROLLBACK
[0m16:51:25.641140 [debug] [MainThread]: On master: Close
[0m16:51:25.643142 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:51:25.645153 [info ] [MainThread]: 
[0m16:51:25.653141 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m16:51:25.654140 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m16:51:25.655142 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m16:51:25.700139 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m16:51:25.702140 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 16:51:25.656142 => 16:51:25.702140
[0m16:51:25.704139 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m16:51:25.705138 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 16:51:25.705138 => 16:51:25.705138
[0m16:51:25.708139 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m16:51:25.710139 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:51:25.711142 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m16:51:25.711142 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m16:51:25.713144 [debug] [MainThread]: Command end result
[0m16:51:25.728142 [info ] [MainThread]: Compiled node 'test' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article
		where siteid = ', site, '
		group by 1
	),
    less_tg_data as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published l
		left join cta_per_article a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags
        where siteid = ', site, '
        group by 1
    ),
    agg_data as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags h
        join total_hits t on h.siteid=t.siteid
        join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_first, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data
        group by 1,2,3
    ),
    categories as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d
    ),
    json_data as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories
    ), 
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_second as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_second e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_second as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_second
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_second as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_second l
		left join cta_per_article_second a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_second as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_second
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_second as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_second
        where siteid = ', site, '
        group by 1
    ),
    agg_data_second as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_second h
        join total_hits_second t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_second as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_second
        group by 1,2,3
    ),
    categories_second as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_second
    ),
    json_data_second as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_second
    ), 
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags_r like "%Long read%" then "Long read"
                WHEN tags_r like "%Kort og godt%" then "Kort og godt"
                WHEN tags_r like "%Q&amp%" then "Q&amp"
                WHEN tags_r like "%Best Practice%" then "Best Practice"
                WHEN tags_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_third as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_third e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_third as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_third
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_third as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_third l
		left join cta_per_article_third a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_third as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_third
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_third as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_third
        where siteid = ', site, '
        group by 1
    ),
    agg_data_third as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_third h
        join total_hits_third t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_third as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_third, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_third
        group by 1,2,3
    ),
    categories_third as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_third
    ),
    json_data_third as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_third
    )
    
   SELECT 
    CONCAT(
        '{''"site":'', jd.siteid, '',',
        ''"data": {'',
        ''"label": "'', jd.lab, ''",'',
        ''"categories": ['', jd.cat, ''],'',
        ''"series": ['', jd.series, '']'',
        '',"defaultTitle":"', dtitle, '"'',',
        ''"additional": [''','{''"title":"', additional_item.title, '"'',',
                ''"data": {'',
                ''"label": "'', jnd.lab, ''",'',
                ''"categories": ['', jnd.cat, ''],'',
                ''"series": ['', jnd.series, '']'',
                ''}'',, '{''"title":"', additional_item.title, '"'',',
                ''"data": {'',
                ''"label": "'', jnd.lab, ''",'',
                ''"categories": ['', jnd.cat, ''],'',
                ''"series": ['', jnd.series, '']'',
                ''}'',''
        ]}''
    ) AS json_data
FROM
    json_data jd
CROSS JOIN json_data_second jnd
CROSS JOIN json_data_third jrd;
[0m16:51:25.747144 [debug] [MainThread]: Command `dbt compile` succeeded at 16:51:25.747144 after 1.25 seconds
[0m16:51:25.748157 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A8976E1E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A887886B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A89E79C10>]}
[0m16:51:25.749147 [debug] [MainThread]: Flushing usage events
[0m17:03:19.645362 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020A1C553350>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020A1C1E7920>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020A1C553800>]}


============================== 17:03:19.651361 | 7722ff39-d06b-4a07-b26b-1203756811b6 ==============================
[0m17:03:19.651361 [info ] [MainThread]: Running with dbt=1.7.13
[0m17:03:19.653362 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt compile -s test', 'send_anonymous_usage_stats': 'True'}
[0m17:03:19.904359 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '7722ff39-d06b-4a07-b26b-1203756811b6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020A1C723CE0>]}
[0m17:03:20.022360 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '7722ff39-d06b-4a07-b26b-1203756811b6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020A1C5A84D0>]}
[0m17:03:20.024360 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m17:03:20.036360 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m17:03:20.137362 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:03:20.138364 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m17:03:20.297363 [error] [MainThread]: Encountered an error:
Compilation Error in model test (models\test.sql)
  unexpected ','
    line 9
      ,
[0m17:03:20.299364 [debug] [MainThread]: Command `dbt compile` failed at 17:03:20.298362 after 0.79 seconds
[0m17:03:20.299364 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020A1C553800>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020A1C6B4C80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020A1C927620>]}
[0m17:03:20.300360 [debug] [MainThread]: Flushing usage events
[0m17:03:46.573865 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023C59CC2960>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023C59CC3DA0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023C59CC3170>]}


============================== 17:03:46.579865 | 3a6e2d1c-70ba-443f-ae89-6443870692c2 ==============================
[0m17:03:46.579865 [info ] [MainThread]: Running with dbt=1.7.13
[0m17:03:46.580867 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt compile -s test', 'send_anonymous_usage_stats': 'True'}
[0m17:03:46.834862 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3a6e2d1c-70ba-443f-ae89-6443870692c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023C59BF9C70>]}
[0m17:03:46.952862 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3a6e2d1c-70ba-443f-ae89-6443870692c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023C59921160>]}
[0m17:03:46.954864 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m17:03:46.967862 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m17:03:47.067984 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:03:47.068988 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m17:03:47.288986 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3a6e2d1c-70ba-443f-ae89-6443870692c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023C5A1E0050>]}
[0m17:03:47.302987 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3a6e2d1c-70ba-443f-ae89-6443870692c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023C5A0995B0>]}
[0m17:03:47.304989 [info ] [MainThread]: Found 2 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m17:03:47.305988 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3a6e2d1c-70ba-443f-ae89-6443870692c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023C59E922D0>]}
[0m17:03:47.308991 [info ] [MainThread]: 
[0m17:03:47.309994 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m17:03:47.311990 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m17:03:47.327987 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:03:47.327987 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m17:03:47.329991 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:03:47.386990 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m17:03:47.387987 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:03:47.387987 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m17:03:47.396989 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m17:03:47.398989 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m17:03:47.399990 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m17:03:47.405986 [debug] [MainThread]: Using postgres connection "master"
[0m17:03:47.406987 [debug] [MainThread]: On master: BEGIN
[0m17:03:47.406987 [debug] [MainThread]: Opening a new connection, currently in state init
[0m17:03:47.458017 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m17:03:47.459018 [debug] [MainThread]: Using postgres connection "master"
[0m17:03:47.459018 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m17:03:47.468025 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m17:03:47.470020 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3a6e2d1c-70ba-443f-ae89-6443870692c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023C59746DB0>]}
[0m17:03:47.471021 [debug] [MainThread]: On master: ROLLBACK
[0m17:03:47.472022 [debug] [MainThread]: On master: Close
[0m17:03:47.474017 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:03:47.476017 [info ] [MainThread]: 
[0m17:03:47.481018 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m17:03:47.482017 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m17:03:47.483019 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m17:03:47.507016 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m17:03:47.508017 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 17:03:47.484015 => 17:03:47.508017
[0m17:03:47.509019 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m17:03:47.510028 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 17:03:47.510028 => 17:03:47.510028
[0m17:03:47.512019 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m17:03:47.514017 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:03:47.515018 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m17:03:47.516018 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m17:03:47.517017 [debug] [MainThread]: Command end result
[0m17:03:47.528020 [info ] [MainThread]: Compiled node 'test' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article
		where siteid = ', site, '
		group by 1
	),
    less_tg_data as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published l
		left join cta_per_article a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags
        where siteid = ', site, '
        group by 1
    ),
    agg_data as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags h
        join total_hits t on h.siteid=t.siteid
        join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_first, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data
        group by 1,2,3
    ),
    categories as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d
    ),
    json_data as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories
    ), 
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_second as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_second e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_second as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_second
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_second as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_second l
		left join cta_per_article_second a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_second as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_second
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_second as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_second
        where siteid = ', site, '
        group by 1
    ),
    agg_data_second as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_second h
        join total_hits_second t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_second as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_second
        group by 1,2,3
    ),
    categories_second as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_second
    ),
    json_data_second as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_second
    ), 
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags_r like "%Long read%" then "Long read"
                WHEN tags_r like "%Kort og godt%" then "Kort og godt"
                WHEN tags_r like "%Q&amp%" then "Q&amp"
                WHEN tags_r like "%Best Practice%" then "Best Practice"
                WHEN tags_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_third as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_third e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_third as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_third
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_third as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_third l
		left join cta_per_article_third a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_third as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_third
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_third as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_third
        where siteid = ', site, '
        group by 1
    ),
    agg_data_third as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_third h
        join total_hits_third t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_third as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_third, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_third
        group by 1,2,3
    ),
    categories_third as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_third
    ),
    json_data_third as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_third
    )
    
   SELECT 
    CONCAT(
        '{''"site":'', jd.siteid, '',',
        ''"data": {'',
        ''"label": "'', jd.lab, ''",'',
        ''"categories": ['', jd.cat, ''],'',
        ''"series": ['', jd.series, '']'',
        '',"defaultTitle":"', dtitle, '"'',',
        ''"additional": [''','{''"title":"', additional_item.title, '"'',',
                ''"data": {'',
                ''"label": "'', jnd.lab, ''",'',
                ''"categories": ['', jnd.cat, ''],'',
                ''"series": ['', jnd.series, '']'',
                ''}'',, '{''"title":"', additional_item.title, '"'',',
                ''"data": {'',
                ''"label": "'', jnd.lab, ''",'',
                ''"categories": ['', jnd.cat, ''],'',
                ''"series": ['', jnd.series, '']'',
                ''}'',''
        ]}''
    ) AS json_data
FROM
    json_data jd
CROSS JOIN json_data_second jnd
CROSS JOIN json_data_third jrd;
[0m17:03:47.547020 [debug] [MainThread]: Command `dbt compile` succeeded at 17:03:47.546016 after 1.11 seconds
[0m17:03:47.548019 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023C59B0F920>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023C5A1BA0C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023C59FA3980>]}
[0m17:03:47.549033 [debug] [MainThread]: Flushing usage events
[0m18:58:13.060123 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DDCC27F50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DDCB5D7F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DDCC274D0>]}


============================== 18:58:13.067372 | 9db4e1e3-3d22-40ee-b2aa-6409d7566599 ==============================
[0m18:58:13.067372 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:58:13.069374 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'invocation_command': 'dbt compile -s test', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:58:13.353808 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9db4e1e3-3d22-40ee-b2aa-6409d7566599', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DDCA6EC00>]}
[0m18:58:13.471812 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9db4e1e3-3d22-40ee-b2aa-6409d7566599', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DDCB32E70>]}
[0m18:58:13.473810 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:58:13.489494 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:58:13.615717 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:58:13.616719 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m18:58:13.823723 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '9db4e1e3-3d22-40ee-b2aa-6409d7566599', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DDD1E1520>]}
[0m18:58:13.837721 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '9db4e1e3-3d22-40ee-b2aa-6409d7566599', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DDCFC9790>]}
[0m18:58:13.838724 [info ] [MainThread]: Found 2 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m18:58:13.840728 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9db4e1e3-3d22-40ee-b2aa-6409d7566599', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DDCECF860>]}
[0m18:58:13.844738 [info ] [MainThread]: 
[0m18:58:13.846723 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:58:13.848719 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:58:13.866717 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:58:13.866717 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:58:13.867722 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:58:13.936399 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:58:13.937397 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:58:13.938396 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:58:13.950396 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:58:13.952394 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:58:13.953397 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:58:13.961396 [debug] [MainThread]: Using postgres connection "master"
[0m18:58:13.962395 [debug] [MainThread]: On master: BEGIN
[0m18:58:13.963398 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:58:14.018397 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:58:14.019396 [debug] [MainThread]: Using postgres connection "master"
[0m18:58:14.020395 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:58:14.034399 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:58:14.038399 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9db4e1e3-3d22-40ee-b2aa-6409d7566599', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DDD1A3680>]}
[0m18:58:14.039395 [debug] [MainThread]: On master: ROLLBACK
[0m18:58:14.040395 [debug] [MainThread]: On master: Close
[0m18:58:14.042399 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:58:14.044398 [info ] [MainThread]: 
[0m18:58:14.057396 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m18:58:14.060401 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m18:58:14.061396 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m18:58:14.091393 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m18:58:14.094400 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 18:58:14.063401 => 18:58:14.093395
[0m18:58:14.094400 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m18:58:14.095397 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 18:58:14.095397 => 18:58:14.095397
[0m18:58:14.097396 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m18:58:14.099396 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:58:14.099396 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:58:14.100398 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m18:58:14.101398 [debug] [MainThread]: Command end result
[0m18:58:14.113396 [info ] [MainThread]: Compiled node 'test' is:










CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article
		where siteid = ', site, '
		group by 1
	),
    less_tg_data as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published l
		left join cta_per_article a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags
        where siteid = ', site, '
        group by 1
    ),
    agg_data as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags h
        join total_hits t on h.siteid=t.siteid
        join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_first, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data
        group by 1,2,3
    ),
    categories as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d
    ),
    json_data as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories
    ), 
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_second as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_second e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_second as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_second
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_second as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_second l
		left join cta_per_article_second a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_second as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_second
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_second as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_second
        where siteid = ', site, '
        group by 1
    ),
    agg_data_second as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_second h
        join total_hits_second t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_second as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_second
        group by 1,2,3
    ),
    categories_second as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_second
    ),
    json_data_second as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_second
    ), 
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags_r like "%Long read%" then "Long read"
                WHEN tags_r like "%Kort og godt%" then "Kort og godt"
                WHEN tags_r like "%Q&amp%" then "Q&amp"
                WHEN tags_r like "%Best Practice%" then "Best Practice"
                WHEN tags_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_third as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_third e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_third as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_third
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_third as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_third l
		left join cta_per_article_third a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_third as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_third
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_third as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_third
        where siteid = ', site, '
        group by 1
    ),
    agg_data_third as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_third h
        join total_hits_third t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_third as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_third, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_third
        group by 1,2,3
    ),
    categories_third as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_third
    ),
    json_data_third as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_third
    )
    
   SELECT 
    CONCAT(
        '{''"site":'', jd.siteid, '',',
        ''"data": {'',
        ''"label": "'', jd.lab, ''",'',
        ''"categories": ['', jd.cat, ''],'',
        ''"series": ['', jd.series, '']'',
        '',"defaultTitle":"', dtitle, '"'',',
        ''"additional": [''',''
        ]}''
    ) AS json_data
FROM
    json_data jd
CROSS JOIN json_data_second jnd
CROSS JOIN json_data_third jrd;
[0m18:58:14.128400 [debug] [MainThread]: Command `dbt compile` succeeded at 18:58:14.128400 after 1.27 seconds
[0m18:58:14.129401 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DDC94DAF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DDCB5D7F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DD6620890>]}
[0m18:58:14.130400 [debug] [MainThread]: Flushing usage events
[0m18:58:53.911379 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A238970A40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A237F357F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A2389732F0>]}


============================== 18:58:53.917382 | cc3743f8-4694-4e92-865e-69526142ee92 ==============================
[0m18:58:53.917382 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:58:53.919384 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt compile -s test', 'send_anonymous_usage_stats': 'True'}
[0m18:58:54.176378 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'cc3743f8-4694-4e92-865e-69526142ee92', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A238710980>]}
[0m18:58:54.296415 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'cc3743f8-4694-4e92-865e-69526142ee92', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A238850860>]}
[0m18:58:54.297418 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:58:54.313414 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:58:54.413418 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:58:54.414417 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m18:58:54.617413 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'cc3743f8-4694-4e92-865e-69526142ee92', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A238EA6D20>]}
[0m18:58:54.631419 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'cc3743f8-4694-4e92-865e-69526142ee92', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A238D899D0>]}
[0m18:58:54.632417 [info ] [MainThread]: Found 2 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m18:58:54.634447 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cc3743f8-4694-4e92-865e-69526142ee92', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A238D88050>]}
[0m18:58:54.637418 [info ] [MainThread]: 
[0m18:58:54.640427 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:58:54.642417 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:58:54.659417 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:58:54.660420 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:58:54.661417 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:58:54.719418 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:58:54.720418 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:58:54.721417 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:58:54.728417 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:58:54.731420 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:58:54.731420 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:58:54.740414 [debug] [MainThread]: Using postgres connection "master"
[0m18:58:54.741416 [debug] [MainThread]: On master: BEGIN
[0m18:58:54.742417 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:58:54.791420 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:58:54.792417 [debug] [MainThread]: Using postgres connection "master"
[0m18:58:54.793417 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:58:54.808549 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:58:54.810557 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cc3743f8-4694-4e92-865e-69526142ee92', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A238D8A390>]}
[0m18:58:54.812550 [debug] [MainThread]: On master: ROLLBACK
[0m18:58:54.813557 [debug] [MainThread]: On master: Close
[0m18:58:54.816552 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:58:54.817581 [info ] [MainThread]: 
[0m18:58:54.824555 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m18:58:54.825549 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m18:58:54.826549 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m18:58:54.850548 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m18:58:54.852549 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 18:58:54.827549 => 18:58:54.852549
[0m18:58:54.853550 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m18:58:54.854548 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 18:58:54.854548 => 18:58:54.854548
[0m18:58:54.857549 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m18:58:54.859549 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:58:54.859549 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:58:54.860547 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m18:58:54.861552 [debug] [MainThread]: Command end result
[0m18:58:54.872549 [info ] [MainThread]: Compiled node 'test' is:










CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article
		where siteid = ', site, '
		group by 1
	),
    less_tg_data as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published l
		left join cta_per_article a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags
        where siteid = ', site, '
        group by 1
    ),
    agg_data as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags h
        join total_hits t on h.siteid=t.siteid
        join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_first, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data
        group by 1,2,3
    ),
    categories as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d
    ),
    json_data as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories
    ), 
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_second as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_second e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_second as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_second
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_second as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_second l
		left join cta_per_article_second a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_second as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_second
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_second as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_second
        where siteid = ', site, '
        group by 1
    ),
    agg_data_second as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_second h
        join total_hits_second t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_second as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_second
        group by 1,2,3
    ),
    categories_second as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_second
    ),
    json_data_second as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_second
    ), 
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags_r like "%Long read%" then "Long read"
                WHEN tags_r like "%Kort og godt%" then "Kort og godt"
                WHEN tags_r like "%Q&amp%" then "Q&amp"
                WHEN tags_r like "%Best Practice%" then "Best Practice"
                WHEN tags_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_third as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_third e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_third as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_third
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_third as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_third l
		left join cta_per_article_third a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_third as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_third
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_third as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_third
        where siteid = ', site, '
        group by 1
    ),
    agg_data_third as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_third h
        join total_hits_third t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_third as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_third, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_third
        group by 1,2,3
    ),
    categories_third as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_third
    ),
    json_data_third as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_third
    )
    
   SELECT 
    CONCAT(
        '{''"site":'', jd.siteid, '',',
        ''"data": {'',
        ''"label": "'', jd.lab, ''",'',
        ''"categories": ['', jd.cat, ''],'',
        ''"series": ['', jd.series, '']'',
        '',"defaultTitle":"', dtitle, '"'',',
        ''"additional": [''',

        
            
                '{''"title":"', title[key], '"'',',
                ''"data": {'',
                ''"label": "'', jnd.lab, ''",'',
                ''"categories": ['', jnd.cat, ''],'',
                ''"series": ['', jnd.series, '']'',
                ''}'',, 
                '{''"title":"', title[key], '"'',',
                ''"data": {'',
                ''"label": "'', jnd.lab, ''",'',
                ''"categories": ['', jnd.cat, ''],'',
                ''"series": ['', jnd.series, '']'',
                ''}'',''
        ]}''
    ) AS json_data
FROM
    json_data jd
CROSS JOIN json_data_second jnd
CROSS JOIN json_data_third jrd;
[0m18:58:54.893550 [debug] [MainThread]: Command `dbt compile` succeeded at 18:58:54.893550 after 1.12 seconds
[0m18:58:54.894551 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A237F357F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A238804A10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A2387C3BF0>]}
[0m18:58:54.895549 [debug] [MainThread]: Flushing usage events
[0m10:31:15.948250 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B857060050>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B856DFD7F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B856F1B320>]}


============================== 10:31:15.956250 | 9efe47c6-83d3-46c9-8ec2-3343dde003a7 ==============================
[0m10:31:15.956250 [info ] [MainThread]: Running with dbt=1.7.13
[0m10:31:15.959252 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s test', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m10:31:16.250250 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9efe47c6-83d3-46c9-8ec2-3343dde003a7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B8570B85F0>]}
[0m10:31:16.369247 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9efe47c6-83d3-46c9-8ec2-3343dde003a7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B857085400>]}
[0m10:31:16.371249 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m10:31:16.386248 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m10:31:16.509549 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m10:31:16.510553 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m10:31:16.673065 [error] [MainThread]: Encountered an error:
Compilation Error in model test (models\test.sql)
  expected token 'end of statement block', got 'CREATE'
    line 11
      CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
[0m10:31:16.676071 [debug] [MainThread]: Command `dbt compile` failed at 10:31:16.676071 after 0.89 seconds
[0m10:31:16.678072 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B850A50890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B8570B8EC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B85757EB70>]}
[0m10:31:16.679088 [debug] [MainThread]: Flushing usage events
[0m10:31:46.478516 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A145C61610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A145C61880>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A145C618B0>]}


============================== 10:31:46.484515 | 55c405ac-8301-424c-905f-b546b5552083 ==============================
[0m10:31:46.484515 [info ] [MainThread]: Running with dbt=1.7.13
[0m10:31:46.486535 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt compile -s test', 'send_anonymous_usage_stats': 'True'}
[0m10:31:46.744510 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '55c405ac-8301-424c-905f-b546b5552083', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A144D0F380>]}
[0m10:31:46.861517 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '55c405ac-8301-424c-905f-b546b5552083', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A1457CAE70>]}
[0m10:31:46.863513 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m10:31:46.878509 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m10:31:46.981511 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m10:31:46.982512 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m10:31:47.146513 [error] [MainThread]: Encountered an error:
Compilation Error in model test (models\test.sql)
  Unexpected end of template. Jinja was looking for the following tags: 'endfor' or 'else'. The innermost block that needs to be closed is 'for'.
    line 185
      {% endfor %};
[0m10:31:47.150517 [debug] [MainThread]: Command `dbt compile` failed at 10:31:47.149520 after 0.81 seconds
[0m10:31:47.151521 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A145896F30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A145FC3650>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A1460CED80>]}
[0m10:31:47.152523 [debug] [MainThread]: Flushing usage events
[0m10:38:19.089193 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A3A5821790>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A3A58217F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A3A5821910>]}


============================== 10:38:19.095192 | d32bd73a-5be0-49c1-b0d2-e52b7b64eced ==============================
[0m10:38:19.095192 [info ] [MainThread]: Running with dbt=1.7.13
[0m10:38:19.097216 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s test', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m10:38:19.384191 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd32bd73a-5be0-49c1-b0d2-e52b7b64eced', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A3A58789E0>]}
[0m10:38:19.503191 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd32bd73a-5be0-49c1-b0d2-e52b7b64eced', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A3A4DE88F0>]}
[0m10:38:19.505193 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m10:38:19.529197 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m10:38:20.387299 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m10:38:20.388303 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m10:38:20.559303 [error] [MainThread]: Encountered an error:
Compilation Error in model test (models\test.sql)
  Unexpected end of template. Jinja was looking for the following tags: 'endfor' or 'else'. The innermost block that needs to be closed is 'for'.
    line 185
      {% endfor %};
[0m10:38:20.562305 [debug] [MainThread]: Command `dbt compile` failed at 10:38:20.562305 after 1.70 seconds
[0m10:38:20.563303 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A3A5821B20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A3A5803F80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A3A5BB7F80>]}
[0m10:38:20.564313 [debug] [MainThread]: Flushing usage events
[0m10:39:27.611525 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D67780F20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D66D457F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D67781820>]}


============================== 10:39:27.617524 | 2232f0f7-e7a0-408f-bc64-82f44d483c00 ==============================
[0m10:39:27.617524 [info ] [MainThread]: Running with dbt=1.7.13
[0m10:39:27.619531 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s test', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m10:39:27.873524 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2232f0f7-e7a0-408f-bc64-82f44d483c00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D67927860>]}
[0m10:39:28.010529 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2232f0f7-e7a0-408f-bc64-82f44d483c00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D676908F0>]}
[0m10:39:28.012525 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m10:39:28.027527 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m10:39:28.115527 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m10:39:28.117529 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m10:39:28.321526 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2232f0f7-e7a0-408f-bc64-82f44d483c00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D67CA1970>]}
[0m10:39:28.352549 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2232f0f7-e7a0-408f-bc64-82f44d483c00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D67B59640>]}
[0m10:39:28.354548 [info ] [MainThread]: Found 2 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m10:39:28.356551 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2232f0f7-e7a0-408f-bc64-82f44d483c00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D677A52E0>]}
[0m10:39:28.359336 [info ] [MainThread]: 
[0m10:39:28.361741 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m10:39:28.363735 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m10:39:28.383735 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m10:39:28.384737 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m10:39:28.384737 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:39:28.457736 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m10:39:28.458738 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m10:39:28.458738 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m10:39:28.469733 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m10:39:28.472740 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m10:39:28.473740 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m10:39:28.482735 [debug] [MainThread]: Using postgres connection "master"
[0m10:39:28.483736 [debug] [MainThread]: On master: BEGIN
[0m10:39:28.483736 [debug] [MainThread]: Opening a new connection, currently in state init
[0m10:39:28.539736 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m10:39:28.540741 [debug] [MainThread]: Using postgres connection "master"
[0m10:39:28.541740 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m10:39:28.554734 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m10:39:28.558736 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2232f0f7-e7a0-408f-bc64-82f44d483c00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D67B59AC0>]}
[0m10:39:28.559737 [debug] [MainThread]: On master: ROLLBACK
[0m10:39:28.560738 [debug] [MainThread]: On master: Close
[0m10:39:28.562741 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m10:39:28.564743 [info ] [MainThread]: 
[0m10:39:28.575746 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m10:39:28.578740 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m10:39:28.579737 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m10:39:28.608738 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m10:39:28.610735 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 10:39:28.580740 => 10:39:28.610735
[0m10:39:28.611738 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m10:39:28.612737 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 10:39:28.612737 => 10:39:28.612737
[0m10:39:28.615737 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m10:39:28.617738 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:39:28.618738 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m10:39:28.619737 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m10:39:28.621737 [debug] [MainThread]: Command end result
[0m10:39:28.637739 [info ] [MainThread]: Compiled node 'test' is:










CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article
		where siteid = ', site, '
		group by 1
	),
    less_tg_data as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published l
		left join cta_per_article a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags
        where siteid = ', site, '
        group by 1
    ),
    agg_data as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags h
        join total_hits t on h.siteid=t.siteid
        join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_first, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data
        group by 1,2,3
    ),
    categories as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d
    ),
    json_data as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories
    ), 
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_second as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_second e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_second as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_second
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_second as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_second l
		left join cta_per_article_second a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_second as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_second
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_second as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_second
        where siteid = ', site, '
        group by 1
    ),
    agg_data_second as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_second h
        join total_hits_second t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_second as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_second
        group by 1,2,3
    ),
    categories_second as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_second
    ),
    json_data_second as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_second
    ), 
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags_r like "%Long read%" then "Long read"
                WHEN tags_r like "%Kort og godt%" then "Kort og godt"
                WHEN tags_r like "%Q&amp%" then "Q&amp"
                WHEN tags_r like "%Best Practice%" then "Best Practice"
                WHEN tags_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_third as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_third e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_third as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_third
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_third as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_third l
		left join cta_per_article_third a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_third as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_third
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_third as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_third
        where siteid = ', site, '
        group by 1
    ),
    agg_data_third as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_third h
        join total_hits_third t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_third as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_third, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_third
        group by 1,2,3
    ),
    categories_third as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_third
    ),
    json_data_third as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_third
    )
    
    SELECT 
		CONCAT(
        ''{'',
            ''"site":'',jd.siteid,'','',
            ''"data": {'',
                ''"label": "'', jd.lab, ''",'',
                ''"categories": ['', jd.cat, ''],'',
                ''"series": ['', jd.series, '']'',
                '',"defaultTitle":"',dtitle,'"'',
                '',"additional":[ ''
                
                ,''{'',
                ''"title":"',title1,'",'',
                ''"data": {'',
                ''"label": "'',_second.lab, ''",'',
                ''"categories": ['', _second.cat, ''],'',
                ''"series": ['', _second.series, '']'',
                ''}''
                
                ,
                
                
                ,''{'',
                ''"title":"',title2,'",'',
                ''"data": {'',
                ''"label": "'',_third.lab, ''",'',
                ''"categories": ['', _third.cat, ''],'',
                ''"series": ['', _third.series, '']'',
                ''}''
                
                
        '']}}''
    
			) as json_data
		  FROM json_data jd
          
          CROSS join json_data_second
          
          CROSS join json_data_third
          ;
[0m10:39:28.661740 [debug] [MainThread]: Command `dbt compile` succeeded at 10:39:28.661740 after 1.18 seconds
[0m10:39:28.663755 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D66D457F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D6751CBF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D611C0890>]}
[0m10:39:28.664738 [debug] [MainThread]: Flushing usage events
[0m10:42:37.294629 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025F2F3120C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025F2F313C80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025F2F3137A0>]}


============================== 10:42:37.299625 | c02edca3-f53c-4a5c-a818-744cb0fa3da8 ==============================
[0m10:42:37.299625 [info ] [MainThread]: Running with dbt=1.7.13
[0m10:42:37.301656 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'invocation_command': 'dbt compile -s test', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m10:42:37.560624 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c02edca3-f53c-4a5c-a818-744cb0fa3da8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025F2F368500>]}
[0m10:42:37.678626 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c02edca3-f53c-4a5c-a818-744cb0fa3da8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025F2F1CAE70>]}
[0m10:42:37.680624 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m10:42:37.696626 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m10:42:37.790625 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m10:42:37.791646 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\test.sql
[0m10:42:37.999630 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c02edca3-f53c-4a5c-a818-744cb0fa3da8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025F2F95D7F0>]}
[0m10:42:38.013630 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c02edca3-f53c-4a5c-a818-744cb0fa3da8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025F2F6EA300>]}
[0m10:42:38.014630 [info ] [MainThread]: Found 2 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m10:42:38.016635 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c02edca3-f53c-4a5c-a818-744cb0fa3da8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025F2F8D7230>]}
[0m10:42:38.019636 [info ] [MainThread]: 
[0m10:42:38.022628 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m10:42:38.024627 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m10:42:38.042696 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m10:42:38.043668 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m10:42:38.044669 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:42:38.100667 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m10:42:38.100667 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m10:42:38.101665 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m10:42:38.109665 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m10:42:38.111668 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m10:42:38.112665 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m10:42:38.120664 [debug] [MainThread]: Using postgres connection "master"
[0m10:42:38.121665 [debug] [MainThread]: On master: BEGIN
[0m10:42:38.122665 [debug] [MainThread]: Opening a new connection, currently in state init
[0m10:42:38.170666 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m10:42:38.171665 [debug] [MainThread]: Using postgres connection "master"
[0m10:42:38.172665 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m10:42:38.185695 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m10:42:38.189672 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c02edca3-f53c-4a5c-a818-744cb0fa3da8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025F2F741010>]}
[0m10:42:38.191667 [debug] [MainThread]: On master: ROLLBACK
[0m10:42:38.191667 [debug] [MainThread]: On master: Close
[0m10:42:38.194667 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m10:42:38.195666 [info ] [MainThread]: 
[0m10:42:38.203664 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m10:42:38.206699 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m10:42:38.207668 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m10:42:38.241664 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m10:42:38.243669 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 10:42:38.207668 => 10:42:38.242665
[0m10:42:38.244668 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m10:42:38.245666 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 10:42:38.245666 => 10:42:38.245666
[0m10:42:38.247667 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m10:42:38.249666 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:42:38.249666 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m10:42:38.250667 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m10:42:38.251667 [debug] [MainThread]: Command end result
[0m10:42:38.265664 [info ] [MainThread]: Compiled node 'test' is:










CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article
		where siteid = ', site, '
		group by 1
	),
    less_tg_data as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published l
		left join cta_per_article a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags
        where siteid = ', site, '
        group by 1
    ),
    agg_data as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags h
        join total_hits t on h.siteid=t.siteid
        join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_first, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data
        group by 1,2,3
    ),
    categories as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d
    ),
    json_data as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories
    ), 
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_second as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_second e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_second as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_second
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_second as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_second l
		left join cta_per_article_second a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_second as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_second
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_second as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_second
        where siteid = ', site, '
        group by 1
    ),
    agg_data_second as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_second h
        join total_hits_second t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_second as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_second
        group by 1,2,3
    ),
    categories_second as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_second
    ),
    json_data_second as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_second
    ), 
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags_r like "%Long read%" then "Long read"
                WHEN tags_r like "%Kort og godt%" then "Kort og godt"
                WHEN tags_r like "%Q&amp%" then "Q&amp"
                WHEN tags_r like "%Best Practice%" then "Best Practice"
                WHEN tags_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_third as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_third e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_third as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_third
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_third as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_third l
		left join cta_per_article_third a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_third as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_third
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_third as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_third
        where siteid = ', site, '
        group by 1
    ),
    agg_data_third as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_third h
        join total_hits_third t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_third as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_third, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_third
        group by 1,2,3
    ),
    categories_third as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_third
    ),
    json_data_third as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_third
    )
    
    SELECT 
		CONCAT(
        ''{'',
            ''"site":'',jd.siteid,'','',
            ''"data": {'',
                ''"label": "'', jd.lab, ''",'',
                ''"categories": ['', jd.cat, ''],'',
                ''"series": ['', jd.series, '']'',
                '',"defaultTitle":"',dtitle,'"'',
                '',"additional":[ ''
                
                ,''{'',
                ''"title":"',title1,'",'',
                ''"data": {'',
                ''"label": "'',json_data_second.lab, ''",'',
                ''"categories": ['', json_data_second.cat, ''],'',
                ''"series": ['', json_data_second.series, '']'',
                ''}''
                
                ,
                
                
                ,''{'',
                ''"title":"',title2,'",'',
                ''"data": {'',
                ''"label": "'',json_data_third.lab, ''",'',
                ''"categories": ['', json_data_third.cat, ''],'',
                ''"series": ['', json_data_third.series, '']'',
                ''}''
                
                
        '']}}''
    
			) as json_data
		  FROM json_data jd
          
          CROSS join json_data_second
          
          CROSS join json_data_third
          ;
[0m10:42:38.295675 [debug] [MainThread]: Command `dbt compile` succeeded at 10:42:38.295675 after 1.20 seconds
[0m10:42:38.297668 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025F2F0F8680>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025F2F957950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025F2F3120C0>]}
[0m10:42:38.297668 [debug] [MainThread]: Flushing usage events
[0m11:12:51.454110 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015074901880>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015074901850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015074901910>]}


============================== 11:12:51.460111 | 3c0704bb-fe80-4e06-a4e1-dca6bb822f59 ==============================
[0m11:12:51.460111 [info ] [MainThread]: Running with dbt=1.7.13
[0m11:12:51.462111 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_dropdown_dbt_test', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m11:12:51.746238 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3c0704bb-fe80-4e06-a4e1-dca6bb822f59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000150749586B0>]}
[0m11:12:51.867234 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3c0704bb-fe80-4e06-a4e1-dca6bb822f59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000150749263F0>]}
[0m11:12:51.869236 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m11:12:51.884237 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m11:12:51.987899 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m11:12:51.988901 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m11:12:51.995901 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3c0704bb-fe80-4e06-a4e1-dca6bb822f59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015074AF9A90>]}
[0m11:12:52.009903 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3c0704bb-fe80-4e06-a4e1-dca6bb822f59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015074D183B0>]}
[0m11:12:52.010907 [info ] [MainThread]: Found 2 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m11:12:52.011906 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3c0704bb-fe80-4e06-a4e1-dca6bb822f59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000150745D6AB0>]}
[0m11:12:52.015913 [info ] [MainThread]: 
[0m11:12:52.017913 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m11:12:52.019901 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m11:12:52.037903 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:12:52.037903 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m11:12:52.038904 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:12:52.096910 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m11:12:52.097902 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:12:52.097902 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m11:12:52.106901 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m11:12:52.107900 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m11:12:52.108901 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m11:12:52.115899 [debug] [MainThread]: Using postgres connection "master"
[0m11:12:52.116901 [debug] [MainThread]: On master: BEGIN
[0m11:12:52.116901 [debug] [MainThread]: Opening a new connection, currently in state init
[0m11:12:52.166903 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m11:12:52.167903 [debug] [MainThread]: Using postgres connection "master"
[0m11:12:52.168900 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m11:12:52.178900 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m11:12:52.181899 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3c0704bb-fe80-4e06-a4e1-dca6bb822f59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015074D180E0>]}
[0m11:12:52.181899 [debug] [MainThread]: On master: ROLLBACK
[0m11:12:52.182900 [debug] [MainThread]: On master: Close
[0m11:12:52.184903 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:12:52.185903 [info ] [MainThread]: 
[0m11:12:52.190900 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_dropdown_dbt_test
[0m11:12:52.192903 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_dropdown_dbt_test'
[0m11:12:52.192903 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_dropdown_dbt_test
[0m11:12:52.216914 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_dropdown_dbt_test"
[0m11:12:52.219901 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_dropdown_dbt_test (compile): 11:12:52.193901 => 11:12:52.219901
[0m11:12:52.221902 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_dropdown_dbt_test
[0m11:12:52.222904 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_dropdown_dbt_test (execute): 11:12:52.222904 => 11:12:52.222904
[0m11:12:52.225903 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_dropdown_dbt_test
[0m11:12:52.226901 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:12:52.227901 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m11:12:52.227901 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_dropdown_dbt_test' was properly closed.
[0m11:12:52.229903 [debug] [MainThread]: Command end result
[0m11:12:52.241902 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_month_dropdown_dbt_test' is:








CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article
		where siteid = ', site, '
		group by 1
	),
    less_tg_data as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published l
		left join cta_per_article a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags
        where siteid = ', site, '
        group by 1
    ),
    agg_data as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags h
        join total_hits t on h.siteid=t.siteid
        join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_first, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data
        group by 1,2,3
    ),
    categories as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d
    ),
    json_data as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories
    ), 
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_second as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_second e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_second as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_second
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_second as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_second l
		left join cta_per_article_second a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_second as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_second
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_second as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_second
        where siteid = ', site, '
        group by 1
    ),
    agg_data_second as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_second h
        join total_hits_second t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_second as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_second
        group by 1,2,3
    ),
    categories_second as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_second
    ),
    json_data_second as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_second
    ), 
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags_r like "%Long read%" then "Long read"
                WHEN tags_r like "%Kort og godt%" then "Kort og godt"
                WHEN tags_r like "%Q&amp%" then "Q&amp"
                WHEN tags_r like "%Best Practice%" then "Best Practice"
                WHEN tags_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_third as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_third e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_third as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_third
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_third as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_third l
		left join cta_per_article_third a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_third as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_third
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_third as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_third
        where siteid = ', site, '
        group by 1
    ),
    agg_data_third as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_third h
        join total_hits_third t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_third as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_third, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_third
        group by 1,2,3
    ),
    categories_third as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_third
    ),
    json_data_third as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_third
    )
    
    SELECT 
		CONCAT(
        ''{'',''"site":'',jd.siteid,'','',
        ''"data": {'',
        ''"label": "'', jd.lab, ''",'',
        ''"categories": ['', jd.cat, ''],'',
        ''"series": ['', jd.series, '']'',
        '',"defaultTitle":"',dtitle,'"'',
        '',"additional":[ {'',
        ''"title":"',title1,'",'',

        ''"data": {'',
        ''"label": "'',jnd.lab, ''",'',
        ''"categories": ['', jnd.cat, ''],'',
        ''"series": ['', jnd.series, '']'',
        ''}},'',
        ''{"title":"',title2,'",'',
        
        ''"data": {'',
        ''"label": "'', jrd.lab, ''",'',
        ''"categories": ['', jrd.cat, ''],'',
        ''"series": ['', jrd.series, '']'',
        ''}}]}}''
    
			) as json_data
		  FROM json_data jd
          CROSS join json_data_second jnd
          CROSS join json_data_third jrd;
[0m11:12:52.257907 [debug] [MainThread]: Command `dbt compile` succeeded at 11:12:52.257907 after 1.00 seconds
[0m11:12:52.259905 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001506E565610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015071A056A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015074812F30>]}
[0m11:12:52.260902 [debug] [MainThread]: Flushing usage events
[0m11:31:07.682963 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021D36683D40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021D36681B20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021D36682D80>]}


============================== 11:31:07.689960 | 2cdd7d01-f2da-4a32-8bec-ded628d31106 ==============================
[0m11:31:07.689960 [info ] [MainThread]: Running with dbt=1.7.13
[0m11:31:07.691970 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s test', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m11:31:08.043960 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2cdd7d01-f2da-4a32-8bec-ded628d31106', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021D367F7080>]}
[0m11:31:08.165962 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2cdd7d01-f2da-4a32-8bec-ded628d31106', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021D36468620>]}
[0m11:31:08.167961 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m11:31:08.182964 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m11:31:08.282996 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m11:31:08.282996 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m11:31:08.290962 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2cdd7d01-f2da-4a32-8bec-ded628d31106', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021D36951D90>]}
[0m11:31:08.304962 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2cdd7d01-f2da-4a32-8bec-ded628d31106', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021D369CD400>]}
[0m11:31:08.305965 [info ] [MainThread]: Found 2 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m11:31:08.307970 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2cdd7d01-f2da-4a32-8bec-ded628d31106', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021D35B4EAB0>]}
[0m11:31:08.311995 [info ] [MainThread]: 
[0m11:31:08.313963 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m11:31:08.316963 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m11:31:08.339961 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:31:08.340962 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m11:31:08.342965 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:31:08.406961 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m11:31:08.407961 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:31:08.407961 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m11:31:08.418959 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m11:31:08.420959 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m11:31:08.421959 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m11:31:08.428958 [debug] [MainThread]: Using postgres connection "master"
[0m11:31:08.429961 [debug] [MainThread]: On master: BEGIN
[0m11:31:08.429961 [debug] [MainThread]: Opening a new connection, currently in state init
[0m11:31:08.479962 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m11:31:08.480963 [debug] [MainThread]: Using postgres connection "master"
[0m11:31:08.481962 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m11:31:08.492959 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m11:31:08.495959 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2cdd7d01-f2da-4a32-8bec-ded628d31106', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021D36A24890>]}
[0m11:31:08.495959 [debug] [MainThread]: On master: ROLLBACK
[0m11:31:08.496959 [debug] [MainThread]: On master: Close
[0m11:31:08.498961 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:31:08.499966 [info ] [MainThread]: 
[0m11:31:08.505961 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m11:31:08.506962 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.test'
[0m11:31:08.507964 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m11:31:08.534961 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m11:31:08.536963 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 11:31:08.508962 => 11:31:08.535962
[0m11:31:08.537964 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m11:31:08.538970 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 11:31:08.537964 => 11:31:08.537964
[0m11:31:08.540964 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m11:31:08.542999 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:31:08.543962 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m11:31:08.543962 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m11:31:08.545963 [debug] [MainThread]: Command end result
[0m11:31:08.557973 [info ] [MainThread]: Compiled node 'test' is:










CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_dropdown`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement_first  VARCHAR(2000),
	IN tag_statement_additional VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
	IN event_action VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN categories like "%Fodsundhed og samfund%" then "Fodsundhed og samfund"
                WHEN categories like "%Forebyggelse%" then "Forebyggelse"
                WHEN categories like "%Forskning og viden%" then "Forskning og viden"
                WHEN categories like "%Praksis%" then "Praksis"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article
		where siteid = ', site, '
		group by 1
	),
    less_tg_data as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published l
		left join cta_per_article a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags
        where siteid = ', site, '
        group by 1
    ),
    agg_data as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags h
        join total_hits t on h.siteid=t.siteid
        join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_first, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_first, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data
        group by 1,2,3
    ),
    categories as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d
    ),
    json_data as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories
    ), 
    
    last_30_days_article_published_second as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
                WHEN tags like "%Inspirer mig%" then "Inspirer mig"
                WHEN tags like "%Giv mig en fordel%" then "Giv mig en fordel"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_second as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_second e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_second as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_second
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_second as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_second l
		left join cta_per_article_second a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_second as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_second
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_second as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_second
        where siteid = ', site, '
        group by 1
    ),
    agg_data_second as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_second h
        join total_hits_second t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_second as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', tag_statement_additional, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', tag_statement_additional, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_second
        group by 1,2,3
    ),
    categories_second as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_second
    ),
    json_data_second as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_second
    ), 
    
    last_30_days_article_published_third as
    (
		SELECT 
			siteid as siteid,
            id,
            date as fdate,
			CASE
                WHEN tags_r like "%Long read%" then "Long read"
                WHEN tags_r like "%Kort og godt%" then "Kort og godt"
                WHEN tags_r like "%Q&amp%" then "Q&amp"
                WHEN tags_r like "%Best Practice%" then "Best Practice"
                WHEN tags_r like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
			END AS tags
        FROM prod.site_archive_post  
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND siteid = ', site, '
	),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    cta_per_article_third as
    (
        select
            e.siteid as siteid,
            e.id as postid,
            coalesce(sum(hits),0) as val
        from last_30_days_article_published_third e
        left join prod.events a on a.postid = e.id
        where e.siteid = ', site, ' and a.Event_Action = ',event_action,'
        group by 1,2
    ),
    agg_cta_per_article_third as
      (
		select 
			siteid as siteid,
            sum(val) as agg_sum 
		from  cta_per_article_third
		where siteid = ', site, '
		group by 1
	),
    less_tg_data_third as(
		select 
        
            l.id,
            l.tags ,
            a.val,
            min_cta,
            l.siteid,
			case when coalesce (val,0)<min_cta then 1 else 0 end as less_than_target,
            percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		from last_30_days_article_published_third l
		left join cta_per_article_third a on l.siteid = a.siteid and l.id = a.postid
		left join prod.goals g on l.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
	),
    hits_by_tags_third as
    (
        select
            siteid as siteid,
            tags,
            sum(less_than_target) as hits_tags,
		sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
		sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		  from less_tg_data_third
		  where siteid = ', site, '
		group by 1,2
	),
    total_hits_third as
    (
        select 
            siteid as siteid ,
            sum(hits_tags) as total_tags_hit,
            sum(sum_by_top_10) as agg_by_top_10,
            sum(sum_by_approved) as agg_by_approved 
        from hits_by_tags_third
        where siteid = ', site, '
        group by 1
    ),
    agg_data_third as
    (
        select 
            h.siteid,
            h.tags,
            coalesce ((hits_tags/total_tags_hit),0)*100 as less_than_target,
            coalesce((sum_by_top_10/agg_by_top_10),0)*100 as top_10,coalesce((sum_by_approved/agg_by_approved),0)*100 approved
        from hits_by_tags_third h
        join total_hits_third t on h.siteid=t.siteid
        join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
        where h.siteid = ', site, '
    ),
    categories_d_third as (
        select
            siteid as siteid ,
            ',label_val,' as label,'
            ,hint_val,' as hint,
            GROUP_CONCAT(tags ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS cateogires,
            GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS less_than_target,
            GROUP_CONCAT(approved ORDER BY FIELD(tags, ', order_statement_third, ', ''others'') SEPARATOR '','') AS approved,
            GROUP_CONCAT(top_10 ORDER BY FIELD(tags,', order_statement_third, ', ''others'') SEPARATOR '','') AS top_10
        from agg_data_third
        group by 1,2,3
    ),
    categories_third as (
        select
            siteid as siteid,
            label as label,
            hint as hint,  
            CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
            less_than_target as less_than_target ,
            approved as approved ,
            top_10 as top_10 
        from  categories_d_third
    ),
    json_data_third as
    (
        SELECT 
            siteid,
            label AS lab, 
            hint AS h,
            cateogires AS cat,
            CONCAT(''{"name": "Under mål", "data": ['', CAST(less_than_target AS CHAR), '']}, '',
                    ''{"name": "Godkendt", "data": ['', CAST(approved AS CHAR), '']}, '',
                    ''{"name": "Top 10%", "data": ['', CAST(top_10 AS CHAR), '']} '') AS series
        FROM categories_third
    )
    
    SELECT 
		CONCAT(
        ''{'',
            ''"site":'',jd.siteid,'','',
            ''"data": {'',
                ''"label": "'', jd.lab, ''",'',
                ''"categories": ['', jd.cat, ''],'',
                ''"series": ['', jd.series, '']'',
                '',"defaultTitle":"',dtitle,'"'',
                '',"additional":[ ''
                
                ,''{'',
                ''"title":"',title1,'",'',
                ''"data": {'',
                ''"label": "'',json_data_second.lab, ''",'',
                ''"categories": ['', json_data_second.cat, ''],'',
                ''"series": ['', json_data_second.series, '']'',
                ''}''
                
                ,
                
                
                ,''{'',
                ''"title":"',title2,'",'',
                ''"data": {'',
                ''"label": "'',json_data_third.lab, ''",'',
                ''"categories": ['', json_data_third.cat, ''],'',
                ''"series": ['', json_data_third.series, '']'',
                ''}''
                
                
        '']}}''
    
			) as json_data
		  FROM json_data jd
          
          CROSS join json_data_second
          
          CROSS join json_data_third
          ;
[0m11:31:08.576845 [debug] [MainThread]: Command `dbt compile` succeeded at 11:31:08.576845 after 1.16 seconds
[0m11:31:08.577843 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021D36681D30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021D36683D40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021D36681B20>]}
[0m11:31:08.578844 [debug] [MainThread]: Flushing usage events
[0m18:17:15.767152 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012605BE3E00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012605BE25A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012605BE29F0>]}


============================== 18:17:15.774506 | 90a5fd31-c806-4ad4-820e-64b2920a0328 ==============================
[0m18:17:15.774506 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:17:15.776485 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'send_anonymous_usage_stats': 'True'}
[0m18:17:16.134300 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '90a5fd31-c806-4ad4-820e-64b2920a0328', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000126050769F0>]}
[0m18:17:16.261287 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '90a5fd31-c806-4ad4-820e-64b2920a0328', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012605BE2E10>]}
[0m18:17:16.264287 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:17:16.281155 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:17:17.112056 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 2 files added, 0 files changed.
[0m18:17:17.113059 [debug] [MainThread]: Partial parsing: added file: dbt_project_test_kasper://models\test2.sql
[0m18:17:17.114063 [debug] [MainThread]: Partial parsing: added file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m18:17:17.304073 [error] [MainThread]: Encountered an error:
Compilation Error in model tactical_userneeds_pageviews_chart_month_13 (models\tactical_userneeds_pageviews_chart_month_13.sql)
  Unexpected end of template. Jinja was looking for the following tags: 'endfor' or 'else'. The innermost block that needs to be closed is 'for'.
    line 32
      ELSE ''others''
[0m18:17:17.307072 [debug] [MainThread]: Command `dbt compile` failed at 18:17:17.306076 after 1.76 seconds
[0m18:17:17.308076 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000126059C8680>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012605F27500>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001260609F5C0>]}
[0m18:17:17.310099 [debug] [MainThread]: Flushing usage events
[0m18:19:24.830058 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221C0B53920>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221C0B52690>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221C0B52270>]}


============================== 18:19:24.837060 | 49331fca-161f-4cf9-a761-c99344b74377 ==============================
[0m18:19:24.837060 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:19:24.839062 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'send_anonymous_usage_stats': 'True'}
[0m18:19:25.098223 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '49331fca-161f-4cf9-a761-c99344b74377', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221C0A08B60>]}
[0m18:19:25.219221 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '49331fca-161f-4cf9-a761-c99344b74377', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221C0B53C50>]}
[0m18:19:25.220221 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:19:25.233220 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:19:25.326048 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 2 files added, 0 files changed.
[0m18:19:25.327051 [debug] [MainThread]: Partial parsing: added file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m18:19:25.328052 [debug] [MainThread]: Partial parsing: added file: dbt_project_test_kasper://models\test2.sql
[0m18:19:25.538183 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '49331fca-161f-4cf9-a761-c99344b74377', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221C0B51D60>]}
[0m18:19:25.567252 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '49331fca-161f-4cf9-a761-c99344b74377', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221C0EBCEF0>]}
[0m18:19:25.569198 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m18:19:25.570201 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '49331fca-161f-4cf9-a761-c99344b74377', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221BDC51BB0>]}
[0m18:19:25.573200 [info ] [MainThread]: 
[0m18:19:25.574201 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:19:25.576200 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:19:25.602201 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:19:25.603199 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:19:25.604202 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:19:25.679200 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:19:25.679200 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:19:25.680199 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:19:25.693200 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:19:25.696196 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:19:25.697199 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:19:25.704206 [debug] [MainThread]: Using postgres connection "master"
[0m18:19:25.705198 [debug] [MainThread]: On master: BEGIN
[0m18:19:25.706201 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:19:25.761198 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:19:25.762200 [debug] [MainThread]: Using postgres connection "master"
[0m18:19:25.763200 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:19:25.776199 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:19:25.778197 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '49331fca-161f-4cf9-a761-c99344b74377', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221C0F088C0>]}
[0m18:19:25.779203 [debug] [MainThread]: On master: ROLLBACK
[0m18:19:25.780201 [debug] [MainThread]: On master: Close
[0m18:19:25.782200 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:19:25.784200 [info ] [MainThread]: 
[0m18:19:25.790182 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:19:25.791183 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13'
[0m18:19:25.792181 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:19:25.807192 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13"
[0m18:19:25.809357 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (compile): 18:19:25.792181 => 18:19:25.808363
[0m18:19:25.809357 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:19:25.811359 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (execute): 18:19:25.810361 => 18:19:25.810361
[0m18:19:25.814361 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:19:25.815363 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:19:25.816359 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:19:25.817357 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13' was properly closed.
[0m18:19:25.817894 [debug] [MainThread]: Command end result
[0m18:19:25.829452 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_month_13' is:





CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_13`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
        SELECT
        siteid as siteid,
        id,
        date as fdate,
		CASE
			WHEN userneeds like "%Opdater mig%" then "Opdater mig"
                WHEN userneeds like "%Forbind mig%" then "Forbind mig"
                WHEN userneeds like "%Help mig med at forsta%" then "Help mig med at forsta"
                WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
                WHEN userneeds like "%Underhold mig%" then "Underhold mig"
                WHEN userneeds like "%Inspirer migg%" then "Inspirer migg"
                ELSE ''others''
		END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '), 
    
    last_30_days_article_published_second as
    (
        SELECT
        siteid as siteid,
        id,
        date as fdate,
		CASE
			WHEN Categories like "%Long read%" then "Long read"
                WHEN Categories like "%Kort og godt%" then "Kort og godt"
                WHEN Categories like "%Q&amp%" then "Q&amp"
                WHEN Categories like "%Best Practice%" then "Best Practice"
                WHEN Categories like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
		END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '), 
    
    last_30_days_article_published_third as
    (
        SELECT
        siteid as siteid,
        id,
        date as fdate,
		CASE
			WHEN Tags like "%order_statement_second%" then "order_statement_second"
                ELSE ''others''
		END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    
[0m18:19:25.833454 [debug] [MainThread]: Command `dbt compile` succeeded at 18:19:25.833454 after 1.21 seconds
[0m18:19:25.834453 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221C0B83FB0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221C0B83FE0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221C09E6B10>]}
[0m18:19:25.835455 [debug] [MainThread]: Flushing usage events
[0m18:20:43.203232 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024ACD2961B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024ACD295910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024ACD297AA0>]}


============================== 18:20:43.209232 | d3c3aa7e-7140-40f7-aa6c-b50efac47310 ==============================
[0m18:20:43.209232 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:20:43.212234 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:20:43.477359 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd3c3aa7e-7140-40f7-aa6c-b50efac47310', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024ACD2E99D0>]}
[0m18:20:43.605411 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd3c3aa7e-7140-40f7-aa6c-b50efac47310', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024ACD0783E0>]}
[0m18:20:43.607412 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:20:43.620510 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:20:43.723106 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:20:43.723106 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m18:20:43.923068 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd3c3aa7e-7140-40f7-aa6c-b50efac47310', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024ACD4707A0>]}
[0m18:20:43.937069 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd3c3aa7e-7140-40f7-aa6c-b50efac47310', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024ACD639700>]}
[0m18:20:43.939067 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m18:20:43.941076 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd3c3aa7e-7140-40f7-aa6c-b50efac47310', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024ACD7CE570>]}
[0m18:20:43.944078 [info ] [MainThread]: 
[0m18:20:43.946066 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:20:43.948065 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:20:43.966065 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:20:43.967066 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:20:43.968067 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:20:44.029064 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:20:44.030097 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:20:44.031069 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:20:44.039067 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:20:44.041063 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:20:44.042063 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:20:44.051062 [debug] [MainThread]: Using postgres connection "master"
[0m18:20:44.052063 [debug] [MainThread]: On master: BEGIN
[0m18:20:44.053065 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:20:44.102065 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:20:44.103067 [debug] [MainThread]: Using postgres connection "master"
[0m18:20:44.104065 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:20:44.114062 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:20:44.116067 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd3c3aa7e-7140-40f7-aa6c-b50efac47310', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024ACD63B5F0>]}
[0m18:20:44.117066 [debug] [MainThread]: On master: ROLLBACK
[0m18:20:44.118064 [debug] [MainThread]: On master: Close
[0m18:20:44.120066 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:20:44.129095 [info ] [MainThread]: 
[0m18:20:44.133064 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:20:44.135065 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13'
[0m18:20:44.135065 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:20:44.152071 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13"
[0m18:20:44.154066 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (compile): 18:20:44.136063 => 18:20:44.153064
[0m18:20:44.155070 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:20:44.156067 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (execute): 18:20:44.156067 => 18:20:44.156067
[0m18:20:44.158069 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:20:44.161066 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:20:44.162097 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:20:44.163070 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13' was properly closed.
[0m18:20:44.164065 [debug] [MainThread]: Command end result
[0m18:20:44.176069 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_month_13' is:





CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_13`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
        SELECT
        siteid as siteid,
        id,
        date as fdate,
		CASE
			WHEN userneeds like "%Opdater mig%" then "Opdater mig"
            WHEN userneeds like "%Forbind mig%" then "Forbind mig"
            WHEN userneeds like "%Help mig med at forsta%" then "Help mig med at forsta"
            WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
            WHEN userneeds like "%Underhold mig%" then "Underhold mig"
            WHEN userneeds like "%Inspirer migg%" then "Inspirer migg"
            ELSE ''others''
		END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '), 
    
    last_30_days_article_published_second as
    (
        SELECT
        siteid as siteid,
        id,
        date as fdate,
		CASE
			WHEN Categories like "%Long read%" then "Long read"
            WHEN Categories like "%Kort og godt%" then "Kort og godt"
            WHEN Categories like "%Q&amp%" then "Q&amp"
            WHEN Categories like "%Best Practice%" then "Best Practice"
            WHEN Categories like "%Viden og forskning%" then "Viden og forskning"
            ELSE ''others''
		END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '), 
    
    last_30_days_article_published_third as
    (
        SELECT
        siteid as siteid,
        id,
        date as fdate,
		CASE
			WHEN Tags like "%order_statement_second%" then "order_statement_second"
            ELSE ''others''
		END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    
[0m18:20:44.181073 [debug] [MainThread]: Command `dbt compile` succeeded at 18:20:44.181073 after 1.13 seconds
[0m18:20:44.182079 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024ACD148860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024ACD295910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024ACD2961B0>]}
[0m18:20:44.183072 [debug] [MainThread]: Flushing usage events
[0m18:21:59.459177 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF4A9A1BB0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF4A9A38F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF4A9A3200>]}


============================== 18:21:59.465175 | 233a2e9f-e2a4-436a-bcbe-5be2b049de54 ==============================
[0m18:21:59.465175 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:21:59.468180 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'send_anonymous_usage_stats': 'True'}
[0m18:21:59.733172 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '233a2e9f-e2a4-436a-bcbe-5be2b049de54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF4A7ED8B0>]}
[0m18:21:59.853269 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '233a2e9f-e2a4-436a-bcbe-5be2b049de54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF4A983F80>]}
[0m18:21:59.855267 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:21:59.870296 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:21:59.971393 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:21:59.972397 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m18:22:00.179180 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '233a2e9f-e2a4-436a-bcbe-5be2b049de54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF4AF2E810>]}
[0m18:22:00.194209 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '233a2e9f-e2a4-436a-bcbe-5be2b049de54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF4AD99760>]}
[0m18:22:00.195209 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m18:22:00.196220 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '233a2e9f-e2a4-436a-bcbe-5be2b049de54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF4AF38800>]}
[0m18:22:00.200180 [info ] [MainThread]: 
[0m18:22:00.201187 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:22:00.204177 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:22:00.222270 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:22:00.223271 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:22:00.224275 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:22:00.284124 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:22:00.284124 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:22:00.285124 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:22:00.294011 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:22:00.296011 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:22:00.296011 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:22:00.303531 [debug] [MainThread]: Using postgres connection "master"
[0m18:22:00.304535 [debug] [MainThread]: On master: BEGIN
[0m18:22:00.305534 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:22:00.354552 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:22:00.355553 [debug] [MainThread]: Using postgres connection "master"
[0m18:22:00.356553 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:22:00.365550 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:22:00.367549 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '233a2e9f-e2a4-436a-bcbe-5be2b049de54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF4AD990A0>]}
[0m18:22:00.368551 [debug] [MainThread]: On master: ROLLBACK
[0m18:22:00.369551 [debug] [MainThread]: On master: Close
[0m18:22:00.371557 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:22:00.373557 [info ] [MainThread]: 
[0m18:22:00.377556 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:22:00.379551 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13'
[0m18:22:00.379551 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:22:00.395549 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13"
[0m18:22:00.397552 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (compile): 18:22:00.380552 => 18:22:00.397552
[0m18:22:00.399555 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:22:00.401569 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (execute): 18:22:00.400553 => 18:22:00.400553
[0m18:22:00.404590 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:22:00.405552 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:22:00.406551 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:22:00.407553 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13' was properly closed.
[0m18:22:00.408553 [debug] [MainThread]: Command end result
[0m18:22:00.420556 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_month_13' is:





CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_13`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN userneeds like "%Opdater mig%" then "Opdater mig"
                WHEN userneeds like "%Forbind mig%" then "Forbind mig"
                WHEN userneeds like "%Help mig med at forsta%" then "Help mig med at forsta"
                WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
                WHEN userneeds like "%Underhold mig%" then "Underhold mig"
                WHEN userneeds like "%Inspirer migg%" then "Inspirer migg"
                ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '), 
    
    last_30_days_article_published_second as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Categories like "%Long read%" then "Long read"
                WHEN Categories like "%Kort og godt%" then "Kort og godt"
                WHEN Categories like "%Q&amp%" then "Q&amp"
                WHEN Categories like "%Best Practice%" then "Best Practice"
                WHEN Categories like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '), 
    
    last_30_days_article_published_third as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Tags like "%order_statement_second%" then "order_statement_second"
                ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    
[0m18:22:00.435619 [debug] [MainThread]: Command `dbt compile` succeeded at 18:22:00.435619 after 1.13 seconds
[0m18:22:00.437629 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF4A983EC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF442B5460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF4A5A1DC0>]}
[0m18:22:00.439658 [debug] [MainThread]: Flushing usage events
[0m18:22:37.118152 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D15022780>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D14EDB320>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D15022480>]}


============================== 18:22:37.124153 | a581ca89-ab67-4334-b20d-cf4b9e9627ff ==============================
[0m18:22:37.124153 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:22:37.126157 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m18:22:37.386746 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a581ca89-ab67-4334-b20d-cf4b9e9627ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D150E9100>]}
[0m18:22:37.508507 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a581ca89-ab67-4334-b20d-cf4b9e9627ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D15003EF0>]}
[0m18:22:37.510489 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:22:37.527319 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:22:37.629550 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:22:37.630550 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m18:22:37.831146 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a581ca89-ab67-4334-b20d-cf4b9e9627ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D15626240>]}
[0m18:22:37.845149 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a581ca89-ab67-4334-b20d-cf4b9e9627ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D154198E0>]}
[0m18:22:37.847151 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m18:22:37.849152 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a581ca89-ab67-4334-b20d-cf4b9e9627ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D1553B7A0>]}
[0m18:22:37.851153 [info ] [MainThread]: 
[0m18:22:37.852146 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:22:37.855148 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:22:37.872146 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:22:37.873149 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:22:37.873149 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:22:38.027251 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:22:38.028252 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:22:38.029250 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:22:38.037253 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:22:38.039736 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:22:38.040735 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:22:38.051904 [debug] [MainThread]: Using postgres connection "master"
[0m18:22:38.052903 [debug] [MainThread]: On master: BEGIN
[0m18:22:38.053902 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:22:38.105454 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:22:38.106477 [debug] [MainThread]: Using postgres connection "master"
[0m18:22:38.107459 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:22:38.116453 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:22:38.118456 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a581ca89-ab67-4334-b20d-cf4b9e9627ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D1541B620>]}
[0m18:22:38.119455 [debug] [MainThread]: On master: ROLLBACK
[0m18:22:38.120458 [debug] [MainThread]: On master: Close
[0m18:22:38.122460 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:22:38.123463 [info ] [MainThread]: 
[0m18:22:38.128455 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:22:38.130458 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13'
[0m18:22:38.131464 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:22:38.147475 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13"
[0m18:22:38.152460 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (compile): 18:22:38.132462 => 18:22:38.151485
[0m18:22:38.153461 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:22:38.155460 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (execute): 18:22:38.154461 => 18:22:38.154461
[0m18:22:38.158461 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:22:38.161456 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:22:38.163478 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:22:38.165456 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13' was properly closed.
[0m18:22:38.167457 [debug] [MainThread]: Command end result
[0m18:22:38.183459 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_month_13' is:





CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_13`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    
			    WHEN userneeds like "%Opdater mig%" then "Opdater mig"
                
			    WHEN userneeds like "%Forbind mig%" then "Forbind mig"
                
			    WHEN userneeds like "%Help mig med at forsta%" then "Help mig med at forsta"
                
			    WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
                
			    WHEN userneeds like "%Underhold mig%" then "Underhold mig"
                
			    WHEN userneeds like "%Inspirer migg%" then "Inspirer migg"
                ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '), 
    
    last_30_days_article_published_second as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    
			    WHEN Categories like "%Long read%" then "Long read"
                
			    WHEN Categories like "%Kort og godt%" then "Kort og godt"
                
			    WHEN Categories like "%Q&amp%" then "Q&amp"
                
			    WHEN Categories like "%Best Practice%" then "Best Practice"
                
			    WHEN Categories like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '), 
    
    last_30_days_article_published_third as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    
			    WHEN Tags like "%order_statement_second%" then "order_statement_second"
                ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    
[0m18:22:38.191463 [debug] [MainThread]: Command `dbt compile` succeeded at 18:22:38.190460 after 1.23 seconds
[0m18:22:38.193462 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D1435F830>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D14E6EF00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D0EA75460>]}
[0m18:22:38.194475 [debug] [MainThread]: Flushing usage events
[0m18:23:53.405176 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000170B43B3680>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000170B43B3B30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000170B43B2D80>]}


============================== 18:23:53.411176 | 15802d16-1ecd-437e-a85e-741669f0e11d ==============================
[0m18:23:53.411176 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:23:53.413187 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:23:53.810709 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '15802d16-1ecd-437e-a85e-741669f0e11d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000170B4408740>]}
[0m18:23:53.954703 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '15802d16-1ecd-437e-a85e-741669f0e11d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000170B428FBF0>]}
[0m18:23:53.956706 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:23:53.970354 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:23:54.067353 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:23:54.068365 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m18:23:54.269281 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '15802d16-1ecd-437e-a85e-741669f0e11d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000170B4A46270>]}
[0m18:23:54.283281 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '15802d16-1ecd-437e-a85e-741669f0e11d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000170B47F11F0>]}
[0m18:23:54.285282 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m18:23:54.286287 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '15802d16-1ecd-437e-a85e-741669f0e11d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000170B4409100>]}
[0m18:23:54.289294 [info ] [MainThread]: 
[0m18:23:54.290284 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:23:54.293280 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:23:54.311284 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:23:54.311284 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:23:54.312285 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:23:54.478930 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:23:54.479933 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:23:54.480933 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:23:54.488947 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:23:54.490945 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:23:54.491943 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:23:54.498946 [debug] [MainThread]: Using postgres connection "master"
[0m18:23:54.499945 [debug] [MainThread]: On master: BEGIN
[0m18:23:54.500945 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:23:54.551585 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:23:54.552588 [debug] [MainThread]: Using postgres connection "master"
[0m18:23:54.552588 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:23:54.562587 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:23:54.564584 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '15802d16-1ecd-437e-a85e-741669f0e11d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000170B47F2AE0>]}
[0m18:23:54.565585 [debug] [MainThread]: On master: ROLLBACK
[0m18:23:54.566586 [debug] [MainThread]: On master: Close
[0m18:23:54.568588 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:23:54.570597 [info ] [MainThread]: 
[0m18:23:54.576584 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:23:54.577585 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13'
[0m18:23:54.578588 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:23:54.595585 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13"
[0m18:23:54.597604 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (compile): 18:23:54.579585 => 18:23:54.597604
[0m18:23:54.599586 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:23:54.600589 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (execute): 18:23:54.600589 => 18:23:54.600589
[0m18:23:54.602588 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:23:54.604585 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:23:54.605609 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:23:54.606586 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13' was properly closed.
[0m18:23:54.607586 [debug] [MainThread]: Command end result
[0m18:23:54.619586 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_month_13' is:





CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_13`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN userneeds like "%Opdater mig%" then "Opdater mig"
                WHEN userneeds like "%Forbind mig%" then "Forbind mig"
                WHEN userneeds like "%Help mig med at forsta%" then "Help mig med at forsta"
                WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
                WHEN userneeds like "%Underhold mig%" then "Underhold mig"
                WHEN userneeds like "%Inspirer migg%" then "Inspirer migg"
                ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '), 
    
    last_30_days_article_published_second as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Categories like "%Long read%" then "Long read"
                WHEN Categories like "%Kort og godt%" then "Kort og godt"
                WHEN Categories like "%Q&amp%" then "Q&amp"
                WHEN Categories like "%Best Practice%" then "Best Practice"
                WHEN Categories like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '), 
    
    last_30_days_article_published_third as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Tags like "%order_statement_second%" then "order_statement_second"
                ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    
[0m18:23:54.624585 [debug] [MainThread]: Command `dbt compile` succeeded at 18:23:54.623584 after 1.37 seconds
[0m18:23:54.625585 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000170B36EF830>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000170B43B3680>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000170B43B3B30>]}
[0m18:23:54.627599 [debug] [MainThread]: Flushing usage events
[0m18:27:01.966890 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202CF6C2030>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202CF6C3B90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202CF6C23C0>]}


============================== 18:27:01.972888 | 5d899d6d-a8ed-4275-9bfe-04376426e33d ==============================
[0m18:27:01.972888 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:27:01.974890 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'send_anonymous_usage_stats': 'True'}
[0m18:27:02.236464 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '5d899d6d-a8ed-4275-9bfe-04376426e33d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202CF6C01A0>]}
[0m18:27:02.361458 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '5d899d6d-a8ed-4275-9bfe-04376426e33d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202CF789C40>]}
[0m18:27:02.363462 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:27:02.378501 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:27:02.481055 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:27:02.482055 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m18:27:02.684257 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '5d899d6d-a8ed-4275-9bfe-04376426e33d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202CF6C1730>]}
[0m18:27:02.699265 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '5d899d6d-a8ed-4275-9bfe-04376426e33d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202CFA21940>]}
[0m18:27:02.700265 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m18:27:02.702263 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '5d899d6d-a8ed-4275-9bfe-04376426e33d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202CFA23890>]}
[0m18:27:02.704261 [info ] [MainThread]: 
[0m18:27:02.706263 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:27:02.708336 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:27:02.726328 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:27:02.727331 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:27:02.727331 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:27:02.785288 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:27:02.786289 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:27:02.786289 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:27:02.795809 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:27:02.797807 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:27:02.798811 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:27:02.806810 [debug] [MainThread]: Using postgres connection "master"
[0m18:27:02.807811 [debug] [MainThread]: On master: BEGIN
[0m18:27:02.808812 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:27:02.859336 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:27:02.860337 [debug] [MainThread]: Using postgres connection "master"
[0m18:27:02.861335 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:27:02.870336 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:27:02.873338 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '5d899d6d-a8ed-4275-9bfe-04376426e33d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202CFA20F80>]}
[0m18:27:02.873338 [debug] [MainThread]: On master: ROLLBACK
[0m18:27:02.874336 [debug] [MainThread]: On master: Close
[0m18:27:02.876341 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:27:02.877347 [info ] [MainThread]: 
[0m18:27:02.892336 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:27:02.894338 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13'
[0m18:27:02.894338 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:27:02.911855 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13"
[0m18:27:02.913849 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (compile): 18:27:02.895338 => 18:27:02.912850
[0m18:27:02.914849 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:27:02.916850 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (execute): 18:27:02.915851 => 18:27:02.915851
[0m18:27:02.918850 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:27:02.920850 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:27:02.921852 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:27:02.922850 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13' was properly closed.
[0m18:27:02.923849 [debug] [MainThread]: Command end result
[0m18:27:02.933847 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_month_13' is:





CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_13`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN userneeds like "%Opdater mig%" then "Opdater mig"
                WHEN userneeds like "%Forbind mig%" then "Forbind mig"
                WHEN userneeds like "%Help mig med at forsta%" then "Help mig med at forsta"
                WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
                WHEN userneeds like "%Underhold mig%" then "Underhold mig"
                WHEN userneeds like "%Inspirer migg%" then "Inspirer migg"
                ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		), 
    
    last_30_days_article_published_second as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Categories like "%Long read%" then "Long read"
                WHEN Categories like "%Kort og godt%" then "Kort og godt"
                WHEN Categories like "%Q&amp%" then "Q&amp"
                WHEN Categories like "%Best Practice%" then "Best Practice"
                WHEN Categories like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_second  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		), 
    
    last_30_days_article_published_third as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Tags like "%order_statement_second%" then "order_statement_second"
                ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_third  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		)
    
[0m18:27:02.940853 [debug] [MainThread]: Command `dbt compile` succeeded at 18:27:02.940853 after 1.18 seconds
[0m18:27:02.941854 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202CF0BF830>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202CF6C3B90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202CF6C23C0>]}
[0m18:27:02.942859 [debug] [MainThread]: Flushing usage events
[0m18:30:10.365660 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021703121820>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021703121310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021703121880>]}


============================== 18:30:10.371681 | 7c45ed0a-ebf4-49cd-a4d0-10cd6dd53199 ==============================
[0m18:30:10.371681 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:30:10.373687 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:30:10.634331 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '7c45ed0a-ebf4-49cd-a4d0-10cd6dd53199', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021702F6E9F0>]}
[0m18:30:10.756366 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '7c45ed0a-ebf4-49cd-a4d0-10cd6dd53199', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021702F0ADE0>]}
[0m18:30:10.757370 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:30:10.771622 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:30:10.875315 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:30:10.876315 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m18:30:11.077769 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '7c45ed0a-ebf4-49cd-a4d0-10cd6dd53199', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002170349C260>]}
[0m18:30:11.091790 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '7c45ed0a-ebf4-49cd-a4d0-10cd6dd53199', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217035017F0>]}
[0m18:30:11.092789 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m18:30:11.094794 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7c45ed0a-ebf4-49cd-a4d0-10cd6dd53199', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002170361D070>]}
[0m18:30:11.096787 [info ] [MainThread]: 
[0m18:30:11.097791 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:30:11.099803 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:30:11.117819 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:30:11.118835 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:30:11.120860 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:30:11.179159 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:30:11.180162 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:30:11.181164 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:30:11.190164 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:30:11.192166 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:30:11.193163 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:30:11.199175 [debug] [MainThread]: Using postgres connection "master"
[0m18:30:11.200162 [debug] [MainThread]: On master: BEGIN
[0m18:30:11.201165 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:30:11.253197 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:30:11.253197 [debug] [MainThread]: Using postgres connection "master"
[0m18:30:11.254180 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:30:11.263200 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:30:11.266205 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7c45ed0a-ebf4-49cd-a4d0-10cd6dd53199', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217035017F0>]}
[0m18:30:11.266205 [debug] [MainThread]: On master: ROLLBACK
[0m18:30:11.267205 [debug] [MainThread]: On master: Close
[0m18:30:11.269203 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:30:11.270201 [info ] [MainThread]: 
[0m18:30:11.275200 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:30:11.276203 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13'
[0m18:30:11.277201 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:30:11.294232 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13"
[0m18:30:11.297235 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (compile): 18:30:11.278201 => 18:30:11.296231
[0m18:30:11.298234 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:30:11.299261 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (execute): 18:30:11.299261 => 18:30:11.299261
[0m18:30:11.301233 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:30:11.303232 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:30:11.304267 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:30:11.305233 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13' was properly closed.
[0m18:30:11.306236 [debug] [MainThread]: Command end result
[0m18:30:11.318278 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_month_13' is:





CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_13`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN userneeds like "%Opdater mig%" then "Opdater mig"
                WHEN userneeds like "%Forbind mig%" then "Forbind mig"
                WHEN userneeds like "%Help mig med at forsta%" then "Help mig med at forsta"
                WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
                WHEN userneeds like "%Underhold mig%" then "Underhold mig"
                WHEN userneeds like "%Inspirer migg%" then "Inspirer migg"
                ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article  e
			where  e.siteid = ', site, '
			group by 1,2,3

		), 
    
    last_30_days_article_published_second as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Categories like "%Long read%" then "Long read"
                WHEN Categories like "%Kort og godt%" then "Kort og godt"
                WHEN Categories like "%Q&amp%" then "Q&amp"
                WHEN Categories like "%Best Practice%" then "Best Practice"
                WHEN Categories like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_second as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_second  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_second as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_second  e
			where  e.siteid = ', site, '
			group by 1,2,3

		), 
    
    last_30_days_article_published_third as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Tags like "%order_statement_second%" then "order_statement_second"
                ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_third as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_third  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_third as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_third  e
			where  e.siteid = ', site, '
			group by 1,2,3

		)
    
[0m18:30:11.327269 [debug] [MainThread]: Command `dbt compile` succeeded at 18:30:11.326272 after 1.16 seconds
[0m18:30:11.328270 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002170232F440>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021702DB4A70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021702E4CBF0>]}
[0m18:30:11.329278 [debug] [MainThread]: Flushing usage events
[0m18:34:52.791006 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD07F46BA0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD07F47320>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD07F47F50>]}


============================== 18:34:52.797005 | 84959e90-f423-4fff-899f-eefd6ba6656b ==============================
[0m18:34:52.797005 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:34:52.799016 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:34:53.056004 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '84959e90-f423-4fff-899f-eefd6ba6656b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD07F986E0>]}
[0m18:34:53.173005 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '84959e90-f423-4fff-899f-eefd6ba6656b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD07D8D8B0>]}
[0m18:34:53.175005 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:34:53.189008 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:34:53.292004 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:34:53.293005 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m18:34:53.490008 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '84959e90-f423-4fff-899f-eefd6ba6656b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD080E7980>]}
[0m18:34:53.505007 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '84959e90-f423-4fff-899f-eefd6ba6656b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD08329760>]}
[0m18:34:53.507009 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m18:34:53.508024 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '84959e90-f423-4fff-899f-eefd6ba6656b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD081FC140>]}
[0m18:34:53.511013 [info ] [MainThread]: 
[0m18:34:53.513021 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:34:53.515007 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:34:53.533005 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:34:53.534007 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:34:53.535007 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:34:53.589007 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:34:53.590008 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:34:53.591007 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:34:53.599006 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:34:53.601006 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:34:53.602007 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:34:53.611010 [debug] [MainThread]: Using postgres connection "master"
[0m18:34:53.611010 [debug] [MainThread]: On master: BEGIN
[0m18:34:53.612009 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:34:53.662008 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:34:53.663009 [debug] [MainThread]: Using postgres connection "master"
[0m18:34:53.664007 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:34:53.674005 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:34:53.676007 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '84959e90-f423-4fff-899f-eefd6ba6656b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD0832BAD0>]}
[0m18:34:53.677006 [debug] [MainThread]: On master: ROLLBACK
[0m18:34:53.678005 [debug] [MainThread]: On master: Close
[0m18:34:53.679008 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:34:53.681019 [info ] [MainThread]: 
[0m18:34:53.685004 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:34:53.687006 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13'
[0m18:34:53.688007 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:34:53.705009 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13"
[0m18:34:53.707009 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (compile): 18:34:53.688007 => 18:34:53.706011
[0m18:34:53.708010 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:34:53.709010 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (execute): 18:34:53.708010 => 18:34:53.708010
[0m18:34:53.711016 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:34:53.713007 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:34:53.714009 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:34:53.715036 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13' was properly closed.
[0m18:34:53.717007 [debug] [MainThread]: Command end result
[0m18:34:53.729009 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_month_13' is:





CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_13`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    
			    WHEN userneeds like "%Opdater mig%" then "Opdater mig"
                
			    WHEN userneeds like "%Forbind mig%" then "Forbind mig"
                
			    WHEN userneeds like "%Help mig med at forsta%" then "Help mig med at forsta"
                
			    WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
                
			    WHEN userneeds like "%Underhold mig%" then "Underhold mig"
                
			    WHEN userneeds like "%Inspirer migg%" then "Inspirer migg"
                ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article
		where siteid = ', site, '
		group by 1,2
		), 
    
    last_30_days_article_published_second as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    
			    WHEN Categories like "%Long read%" then "Long read"
                
			    WHEN Categories like "%Kort og godt%" then "Kort og godt"
                
			    WHEN Categories like "%Q&amp%" then "Q&amp"
                
			    WHEN Categories like "%Best Practice%" then "Best Practice"
                
			    WHEN Categories like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_second as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_second  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_second as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_second  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_second as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_second
		where siteid = ', site, '
		group by 1,2
		), 
    
    last_30_days_article_published_third as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    
			    WHEN Tags like "%order_statement_second%" then "order_statement_second"
                ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_third as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_third  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_third as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_third  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_third as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_third
		where siteid = ', site, '
		group by 1,2
		)
    
[0m18:34:53.745047 [debug] [MainThread]: Command `dbt compile` succeeded at 18:34:53.745047 after 1.16 seconds
[0m18:34:53.747027 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD07C6D640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD07F47320>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD07CDCBF0>]}
[0m18:34:53.748028 [debug] [MainThread]: Flushing usage events
[0m18:35:45.483567 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021502FD3E30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021502FD37A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021502FD2FF0>]}


============================== 18:35:45.488565 | a8a89ce3-4233-4c8a-b917-6bd955165588 ==============================
[0m18:35:45.488565 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:35:45.490573 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m18:35:45.910566 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a8a89ce3-4233-4c8a-b917-6bd955165588', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021503028410>]}
[0m18:35:46.032565 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a8a89ce3-4233-4c8a-b917-6bd955165588', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021502A1C170>]}
[0m18:35:46.034568 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:35:46.048566 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:35:46.149418 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:35:46.150419 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m18:35:46.319422 [error] [MainThread]: Encountered an error:
Compilation Error in model tactical_userneeds_pageviews_chart_month_13 (models\tactical_userneeds_pageviews_chart_month_13.sql)
  tag name expected
    line 29
      {% -for j in range(diction2[i] | length)%}
[0m18:35:46.331086 [debug] [MainThread]: Command `dbt compile` failed at 18:35:46.331086 after 0.98 seconds
[0m18:35:46.332092 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021502BD2F00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021502C30C80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021503211FD0>]}
[0m18:35:46.333093 [debug] [MainThread]: Flushing usage events
[0m18:36:04.910613 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA6C2131A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA6C2136E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA6C2128A0>]}


============================== 18:36:04.916614 | 6d14ace2-4104-48e9-96eb-969f0c7ad631 ==============================
[0m18:36:04.916614 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:36:04.918622 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:36:05.172614 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6d14ace2-4104-48e9-96eb-969f0c7ad631', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA6C3DD580>]}
[0m18:36:05.294612 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6d14ace2-4104-48e9-96eb-969f0c7ad631', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA6B8A4170>]}
[0m18:36:05.295614 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:36:05.309632 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:36:05.408617 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:36:05.409620 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m18:36:05.571621 [error] [MainThread]: Encountered an error:
Compilation Error in model tactical_userneeds_pageviews_chart_month_13 (models\tactical_userneeds_pageviews_chart_month_13.sql)
  Encountered unknown tag 'endfor'.
    line 78
      {% endfor %}
[0m18:36:05.573635 [debug] [MainThread]: Command `dbt compile` failed at 18:36:05.573635 after 0.80 seconds
[0m18:36:05.574623 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA6BFF8860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA6C40D9A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA6C23BAD0>]}
[0m18:36:05.575625 [debug] [MainThread]: Flushing usage events
[0m18:36:53.204512 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B47C821940>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B47C8218E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B47C823FB0>]}


============================== 18:36:53.209507 | 6a8d9a2e-6414-4074-a576-b786786f2ee4 ==============================
[0m18:36:53.209507 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:36:53.211527 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:36:53.464516 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6a8d9a2e-6414-4074-a576-b786786f2ee4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B47C8230E0>]}
[0m18:36:53.583543 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6a8d9a2e-6414-4074-a576-b786786f2ee4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B47C8464B0>]}
[0m18:36:53.585522 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:36:53.602518 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:36:53.693520 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:36:53.694520 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m18:36:53.893517 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6a8d9a2e-6414-4074-a576-b786786f2ee4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B47CBB76E0>]}
[0m18:36:53.909521 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6a8d9a2e-6414-4074-a576-b786786f2ee4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B47CC40EC0>]}
[0m18:36:53.910521 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m18:36:53.911525 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6a8d9a2e-6414-4074-a576-b786786f2ee4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B47C608470>]}
[0m18:36:53.914524 [info ] [MainThread]: 
[0m18:36:53.915520 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:36:53.917522 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:36:53.935539 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:36:53.936536 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:36:53.937536 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:36:53.992519 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:36:53.993523 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:36:53.994520 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:36:54.002519 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:36:54.004519 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:36:54.005518 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:36:54.014523 [debug] [MainThread]: Using postgres connection "master"
[0m18:36:54.015529 [debug] [MainThread]: On master: BEGIN
[0m18:36:54.015529 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:36:54.065520 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:36:54.066522 [debug] [MainThread]: Using postgres connection "master"
[0m18:36:54.067519 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:36:54.077522 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:36:54.080025 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6a8d9a2e-6414-4074-a576-b786786f2ee4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B47CC42AB0>]}
[0m18:36:54.080025 [debug] [MainThread]: On master: ROLLBACK
[0m18:36:54.081042 [debug] [MainThread]: On master: Close
[0m18:36:54.083040 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:36:54.085052 [info ] [MainThread]: 
[0m18:36:54.090042 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:36:54.091038 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13'
[0m18:36:54.092037 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:36:54.111053 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13"
[0m18:36:54.114087 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (compile): 18:36:54.093038 => 18:36:54.113037
[0m18:36:54.115042 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:36:54.116040 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (execute): 18:36:54.116040 => 18:36:54.116040
[0m18:36:54.118038 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:36:54.120038 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:36:54.121038 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:36:54.121038 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13' was properly closed.
[0m18:36:54.122037 [debug] [MainThread]: Command end result
[0m18:36:54.135039 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_month_13' is:





CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_13`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN userneeds like "%Opdater mig%" then "Opdater mig"
                
			    WHEN userneeds like "%Forbind mig%" then "Forbind mig"
                
			    WHEN userneeds like "%Help mig med at forsta%" then "Help mig med at forsta"
                
			    WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
                
			    WHEN userneeds like "%Underhold mig%" then "Underhold mig"
                
			    WHEN userneeds like "%Inspirer migg%" then "Inspirer migg"
                ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article
		where siteid = ', site, '
		group by 1,2
		), 
    
    last_30_days_article_published_second as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Categories like "%Long read%" then "Long read"
                
			    WHEN Categories like "%Kort og godt%" then "Kort og godt"
                
			    WHEN Categories like "%Q&amp%" then "Q&amp"
                
			    WHEN Categories like "%Best Practice%" then "Best Practice"
                
			    WHEN Categories like "%Viden og forskning%" then "Viden og forskning"
                ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_second as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_second  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_second as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_second  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_second as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_second
		where siteid = ', site, '
		group by 1,2
		), 
    
    last_30_days_article_published_third as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Tags like "%order_statement_second%" then "order_statement_second"
                ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_third as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_third  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_third as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_third  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_third as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_third
		where siteid = ', site, '
		group by 1,2
		)
    
[0m18:36:54.145038 [debug] [MainThread]: Command `dbt compile` succeeded at 18:36:54.144070 after 1.09 seconds
[0m18:36:54.146040 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B47C823FB0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B47C8218E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B47C6FCA70>]}
[0m18:36:54.147042 [debug] [MainThread]: Flushing usage events
[0m18:37:48.822429 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EFDB8A3590>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EFDABDEC60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EFDB8A0CB0>]}


============================== 18:37:48.828428 | 2026062a-cc1d-4c72-9a83-4657b0c6dd92 ==============================
[0m18:37:48.828428 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:37:48.830435 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:37:49.087427 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2026062a-cc1d-4c72-9a83-4657b0c6dd92', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EFDB535130>]}
[0m18:37:49.206430 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2026062a-cc1d-4c72-9a83-4657b0c6dd92', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EFDB688980>]}
[0m18:37:49.208433 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:37:49.221426 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:37:49.329859 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:37:49.331863 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m18:37:49.535867 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2026062a-cc1d-4c72-9a83-4657b0c6dd92', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EFDBC7E000>]}
[0m18:37:49.550863 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2026062a-cc1d-4c72-9a83-4657b0c6dd92', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EFDBD29460>]}
[0m18:37:49.551867 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m18:37:49.552865 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2026062a-cc1d-4c72-9a83-4657b0c6dd92', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EFDBE46AB0>]}
[0m18:37:49.555864 [info ] [MainThread]: 
[0m18:37:49.557872 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:37:49.559865 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:37:49.576866 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:37:49.577868 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:37:49.578863 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:37:49.641862 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:37:49.642865 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:37:49.642865 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:37:49.651862 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:37:49.652864 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:37:49.654862 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:37:49.660858 [debug] [MainThread]: Using postgres connection "master"
[0m18:37:49.661860 [debug] [MainThread]: On master: BEGIN
[0m18:37:49.662862 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:37:49.712863 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:37:49.712863 [debug] [MainThread]: Using postgres connection "master"
[0m18:37:49.713865 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:37:49.723866 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:37:49.726861 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2026062a-cc1d-4c72-9a83-4657b0c6dd92', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EFDBD2B710>]}
[0m18:37:49.727862 [debug] [MainThread]: On master: ROLLBACK
[0m18:37:49.727862 [debug] [MainThread]: On master: Close
[0m18:37:49.729862 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:37:49.731871 [info ] [MainThread]: 
[0m18:37:49.736865 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:37:49.737862 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13'
[0m18:37:49.738880 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:37:49.756879 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13"
[0m18:37:49.759893 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (compile): 18:37:49.739876 => 18:37:49.758868
[0m18:37:49.761865 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:37:49.762865 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (execute): 18:37:49.762865 => 18:37:49.762865
[0m18:37:49.764863 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m18:37:49.766865 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:37:49.767862 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:37:49.767862 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13' was properly closed.
[0m18:37:49.769866 [debug] [MainThread]: Command end result
[0m18:37:49.782861 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_month_13' is:





CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_13`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN userneeds like "%Opdater mig%" then "Opdater mig"
			    WHEN userneeds like "%Forbind mig%" then "Forbind mig"
			    WHEN userneeds like "%Help mig med at forsta%" then "Help mig med at forsta"
			    WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
			    WHEN userneeds like "%Underhold mig%" then "Underhold mig"
			    WHEN userneeds like "%Inspirer migg%" then "Inspirer migg"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article
		where siteid = ', site, '
		group by 1,2
		), 
    
    last_30_days_article_published_second as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Categories like "%Long read%" then "Long read"
			    WHEN Categories like "%Kort og godt%" then "Kort og godt"
			    WHEN Categories like "%Q&amp%" then "Q&amp"
			    WHEN Categories like "%Best Practice%" then "Best Practice"
			    WHEN Categories like "%Viden og forskning%" then "Viden og forskning"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_second as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_second  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_second as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_second  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_second as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_second
		where siteid = ', site, '
		group by 1,2
		), 
    
    last_30_days_article_published_third as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Tags like "%order_statement_second%" then "order_statement_second"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_third as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_third  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_third as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_third  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_third as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_third
		where siteid = ', site, '
		group by 1,2
		)
    
[0m18:37:49.790865 [debug] [MainThread]: Command `dbt compile` succeeded at 18:37:49.790865 after 1.10 seconds
[0m18:37:49.791872 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EFD52D5610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EFDB759460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EFDB8A3590>]}
[0m18:37:49.792868 [debug] [MainThread]: Flushing usage events
[0m19:00:11.894533 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E623701820>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6237017F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6237019A0>]}


============================== 19:00:11.901534 | deb884e4-24ea-4336-8583-33d59d603572 ==============================
[0m19:00:11.901534 [info ] [MainThread]: Running with dbt=1.7.13
[0m19:00:11.903543 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'send_anonymous_usage_stats': 'True'}
[0m19:00:12.172009 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'deb884e4-24ea-4336-8583-33d59d603572', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6234B56A0>]}
[0m19:00:12.291012 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'deb884e4-24ea-4336-8583-33d59d603572', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E623611820>]}
[0m19:00:12.293016 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m19:00:12.307013 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m19:00:12.439356 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:00:12.440357 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m19:00:12.639087 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'deb884e4-24ea-4336-8583-33d59d603572', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E623CBE810>]}
[0m19:00:12.654091 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'deb884e4-24ea-4336-8583-33d59d603572', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E623B29A90>]}
[0m19:00:12.655094 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m19:00:12.657098 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'deb884e4-24ea-4336-8583-33d59d603572', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E623BFFF50>]}
[0m19:00:12.659094 [info ] [MainThread]: 
[0m19:00:12.661093 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m19:00:12.663091 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m19:00:12.681105 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m19:00:12.682100 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m19:00:12.683113 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:00:12.748090 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m19:00:12.749092 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m19:00:12.750091 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m19:00:12.761089 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m19:00:12.763089 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m19:00:12.764091 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m19:00:12.773092 [debug] [MainThread]: Using postgres connection "master"
[0m19:00:12.774092 [debug] [MainThread]: On master: BEGIN
[0m19:00:12.774092 [debug] [MainThread]: Opening a new connection, currently in state init
[0m19:00:12.824092 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m19:00:12.825093 [debug] [MainThread]: Using postgres connection "master"
[0m19:00:12.826090 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m19:00:12.837091 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m19:00:12.840089 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'deb884e4-24ea-4336-8583-33d59d603572', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E623B29A90>]}
[0m19:00:12.840089 [debug] [MainThread]: On master: ROLLBACK
[0m19:00:12.841092 [debug] [MainThread]: On master: Close
[0m19:00:12.843093 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m19:00:12.844101 [info ] [MainThread]: 
[0m19:00:12.850091 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m19:00:12.852092 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13'
[0m19:00:12.853093 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m19:00:12.871094 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13"
[0m19:00:12.873901 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (compile): 19:00:12.853093 => 19:00:12.872883
[0m19:00:12.873901 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m19:00:12.875897 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (execute): 19:00:12.874898 => 19:00:12.874898
[0m19:00:12.876897 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m19:00:12.878896 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:00:12.879908 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m19:00:12.880918 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13' was properly closed.
[0m19:00:12.882904 [debug] [MainThread]: Command end result
[0m19:00:12.901894 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_month_13' is:





CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_13`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN userneeds like "%Opdater mig%" then "Opdater mig"
			    WHEN userneeds like "%Forbind mig%" then "Forbind mig"
			    WHEN userneeds like "%Help mig med at forsta%" then "Help mig med at forsta"
			    WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
			    WHEN userneeds like "%Underhold mig%" then "Underhold mig"
			    WHEN userneeds like "%Inspirer migg%" then "Inspirer migg"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data
			group by 1,2
		),
        hits_by_tags as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data
		   where siteid = ',site,'
		   group by 1,2), 
    
    last_30_days_article_published_second as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Categories like "%Long read%" then "Long read"
			    WHEN Categories like "%Kort og godt%" then "Kort og godt"
			    WHEN Categories like "%Q&amp%" then "Q&amp"
			    WHEN Categories like "%Best Practice%" then "Best Practice"
			    WHEN Categories like "%Viden og forskning%" then "Viden og forskning"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_second as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_second  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_second as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_second  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_second as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_second
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_second as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_second l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_second as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_second
			group by 1,2
		),
        hits_by_tags_second as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_second
		   where siteid = ',site,'
		   group by 1,2), 
    
    last_30_days_article_published_third as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Tags like "%order_statement_second%" then "order_statement_second"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_third as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_third  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_third as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_third  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_third as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_third
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_third as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_third l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_third as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_third
			group by 1,2
		),
        hits_by_tags_third as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_third
		   where siteid = ',site,'
		   group by 1,2)
    
[0m19:00:12.919902 [debug] [MainThread]: Command `dbt compile` succeeded at 19:00:12.919902 after 1.25 seconds
[0m19:00:12.920899 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E62363D9D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6237019A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E623703EC0>]}
[0m19:00:12.922917 [debug] [MainThread]: Flushing usage events
[0m10:47:44.552677 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C27FB36210>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C27FB35AC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C27FB36630>]}


============================== 10:47:44.559676 | 1555c5f4-590e-46bf-b5fb-dca26997c815 ==============================
[0m10:47:44.559676 [info ] [MainThread]: Running with dbt=1.7.13
[0m10:47:44.561687 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'send_anonymous_usage_stats': 'True'}
[0m10:47:44.867552 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1555c5f4-590e-46bf-b5fb-dca26997c815', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C27FA0D130>]}
[0m10:47:44.988549 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1555c5f4-590e-46bf-b5fb-dca26997c815', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C27FA432C0>]}
[0m10:47:44.991347 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m10:47:45.006057 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m10:47:45.140399 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m10:47:45.142404 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m10:47:45.351151 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1555c5f4-590e-46bf-b5fb-dca26997c815', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C200177E30>]}
[0m10:47:45.367153 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1555c5f4-590e-46bf-b5fb-dca26997c815', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C27FF69940>]}
[0m10:47:45.368155 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m10:47:45.370160 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1555c5f4-590e-46bf-b5fb-dca26997c815', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C20019C8C0>]}
[0m10:47:45.373155 [info ] [MainThread]: 
[0m10:47:45.375154 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m10:47:45.377152 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m10:47:45.395157 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m10:47:45.395157 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m10:47:45.397158 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:47:45.475154 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m10:47:45.476151 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m10:47:45.477151 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m10:47:45.491150 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m10:47:45.493150 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m10:47:45.495152 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m10:47:45.508152 [debug] [MainThread]: Using postgres connection "master"
[0m10:47:45.510153 [debug] [MainThread]: On master: BEGIN
[0m10:47:45.511156 [debug] [MainThread]: Opening a new connection, currently in state init
[0m10:47:45.597155 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m10:47:45.599154 [debug] [MainThread]: Using postgres connection "master"
[0m10:47:45.601154 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m10:47:45.624154 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m10:47:45.629159 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1555c5f4-590e-46bf-b5fb-dca26997c815', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C27FF6B440>]}
[0m10:47:45.631155 [debug] [MainThread]: On master: ROLLBACK
[0m10:47:45.633156 [debug] [MainThread]: On master: Close
[0m10:47:45.635155 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m10:47:45.637163 [info ] [MainThread]: 
[0m10:47:45.647164 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m10:47:45.651157 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13'
[0m10:47:45.653157 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m10:47:45.714157 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13"
[0m10:47:45.717155 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (compile): 10:47:45.654155 => 10:47:45.717155
[0m10:47:45.719153 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m10:47:45.721154 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (execute): 10:47:45.720154 => 10:47:45.720154
[0m10:47:45.724153 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m10:47:45.728152 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:47:45.730154 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m10:47:45.731154 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13' was properly closed.
[0m10:47:45.734154 [debug] [MainThread]: Command end result
[0m10:47:45.754150 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_month_13' is:





CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_13`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN userneeds like "%Opdater mig%" then "Opdater mig"
			    WHEN userneeds like "%Forbind mig%" then "Forbind mig"
			    WHEN userneeds like "%Help mig med at forsta%" then "Help mig med at forsta"
			    WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
			    WHEN userneeds like "%Underhold mig%" then "Underhold mig"
			    WHEN userneeds like "%Inspirer migg%" then "Inspirer migg"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data
			group by 1,2
		),
        hits_by_tags as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_third_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data
		group by 1,2,3
		),
        categories as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d
		),
        json_data as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories
		), 
    
    last_30_days_article_published_second as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Categories like "%Long read%" then "Long read"
			    WHEN Categories like "%Kort og godt%" then "Kort og godt"
			    WHEN Categories like "%Q&amp%" then "Q&amp"
			    WHEN Categories like "%Best Practice%" then "Best Practice"
			    WHEN Categories like "%Viden og forskning%" then "Viden og forskning"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_second as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_second  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_second as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_second  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_second as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_second
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_second as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_second l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_second as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_second
			group by 1,2
		),
        hits_by_tags_second as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_second
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits_second as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_second
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data_second as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_second h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_third_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d_second as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_second
		group by 1,2,3
		),
        categories_second as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_second
		),
        json_data_second as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_second
		), 
    
    last_30_days_article_published_third as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Tags like "%order_statement_second%" then "order_statement_second"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_third as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_third  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_third as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_third  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_third as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_third
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_third as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_third l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_third as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_third
			group by 1,2
		),
        hits_by_tags_third as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_third
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits_third as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_third
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data_third as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_third h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_third_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d_third as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_third
		group by 1,2,3
		),
        categories_third as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_third
		),
        json_data_third as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_third
		)
    

    SELECT 
		CONCAT(
        ''{'',
            ''"site":'',jd.siteid,'','',
            ''"data": {'',
                ''"label": "'', jd.lab, ''",'',
                ''"categories": ['', jd.cat, ''],'',
                ''"series": ['', jd.series, '']'',
                '',"defaultTitle":"',dtitle,'"'',
                '',"additional":[ ''
                
                ,''{'',
                ''"title":"',title1,'",'',
                ''"data": {'',
                ''"label": "'',json_data_second.lab, ''",'',
                ''"categories": ['', json_data_second.cat, ''],'',
                ''"series": ['', json_data_second.series, '']'',
                ''}}''
                
                , '',''
                
                
                ,''{'',
                ''"title":"',title2,'",'',
                ''"data": {'',
                ''"label": "'',json_data_third.lab, ''",'',
                ''"categories": ['', json_data_third.cat, ''],'',
                ''"series": ['', json_data_third.series, '']'',
                ''}}''
                
                
        '']}}''
    
			) as json_data
		  FROM json_data jd
          
          CROSS join json_data_second
          
          CROSS join json_data_third
          ;
[0m10:47:45.784155 [debug] [MainThread]: Command `dbt compile` succeeded at 10:47:45.783168 after 1.46 seconds
[0m10:47:45.784155 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C27F9C5970>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C27F9EB110>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C27F9E9670>]}
[0m10:47:45.786165 [debug] [MainThread]: Flushing usage events
[0m11:21:17.780480 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028EA94B7D70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028EA94B5C70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028EA94B7B60>]}


============================== 11:21:17.786480 | 95855015-4eda-46f4-81f2-383de9c77ee1 ==============================
[0m11:21:17.786480 [info ] [MainThread]: Running with dbt=1.7.13
[0m11:21:17.788493 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m11:21:18.046477 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '95855015-4eda-46f4-81f2-383de9c77ee1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028EA9746150>]}
[0m11:21:18.166482 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '95855015-4eda-46f4-81f2-383de9c77ee1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028EA94DA780>]}
[0m11:21:18.168486 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m11:21:18.183485 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m11:21:18.284482 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m11:21:18.285484 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m11:21:18.490479 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '95855015-4eda-46f4-81f2-383de9c77ee1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028EA9B45B80>]}
[0m11:21:18.505483 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '95855015-4eda-46f4-81f2-383de9c77ee1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028EA993A330>]}
[0m11:21:18.506485 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m11:21:18.508483 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '95855015-4eda-46f4-81f2-383de9c77ee1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028EA9A0FCB0>]}
[0m11:21:18.511481 [info ] [MainThread]: 
[0m11:21:18.513486 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m11:21:18.515479 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m11:21:18.533484 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:21:18.534485 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m11:21:18.535481 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:21:18.596484 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m11:21:18.597481 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:21:18.599488 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m11:21:18.613481 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m11:21:18.616482 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m11:21:18.618482 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m11:21:18.628479 [debug] [MainThread]: Using postgres connection "master"
[0m11:21:18.629479 [debug] [MainThread]: On master: BEGIN
[0m11:21:18.630479 [debug] [MainThread]: Opening a new connection, currently in state init
[0m11:21:18.682481 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m11:21:18.682481 [debug] [MainThread]: Using postgres connection "master"
[0m11:21:18.683479 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m11:21:18.692479 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m11:21:18.695479 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '95855015-4eda-46f4-81f2-383de9c77ee1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028EA993BF80>]}
[0m11:21:18.695479 [debug] [MainThread]: On master: ROLLBACK
[0m11:21:18.696481 [debug] [MainThread]: On master: Close
[0m11:21:18.698482 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:21:18.699513 [info ] [MainThread]: 
[0m11:21:18.704479 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m11:21:18.706482 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13'
[0m11:21:18.707480 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m11:21:18.735480 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13"
[0m11:21:18.737483 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (compile): 11:21:18.707480 => 11:21:18.736480
[0m11:21:18.738484 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m11:21:18.739482 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (execute): 11:21:18.739482 => 11:21:18.739482
[0m11:21:18.741480 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m11:21:18.743479 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:21:18.744483 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m11:21:18.745528 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13' was properly closed.
[0m11:21:18.747480 [debug] [MainThread]: Command end result
[0m11:21:18.760480 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_month_13' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_13`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN userneeds like "%Opdater mig%" then "Opdater mig"
			    WHEN userneeds like "%Forbind mig%" then "Forbind mig"
			    WHEN userneeds like "%Help mig med at forsta%" then "Help mig med at forsta"
			    WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
			    WHEN userneeds like "%Underhold mig%" then "Underhold mig"
			    WHEN userneeds like "%Inspirer migg%" then "Inspirer migg"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data
			group by 1,2
		),
        hits_by_tags as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data
		group by 1,2,3
		),
        categories as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d
		),
        json_data as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories
		), 
    
    last_30_days_article_published_second as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Categories like "%Long read%" then "Long read"
			    WHEN Categories like "%Kort og godt%" then "Kort og godt"
			    WHEN Categories like "%Q&amp%" then "Q&amp"
			    WHEN Categories like "%Best Practice%" then "Best Practice"
			    WHEN Categories like "%Viden og forskning%" then "Viden og forskning"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_second as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_second  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_second as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_second  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_second as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_second
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_second as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_second l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_second as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_second
			group by 1,2
		),
        hits_by_tags_second as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_second
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits_second as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_second
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data_second as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_second h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_second_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d_second as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_second
		group by 1,2,3
		),
        categories_second as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_second
		),
        json_data_second as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_second
		), 
    
    last_30_days_article_published_third as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Tags like "%order_statement_second%" then "order_statement_second"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_third as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_third  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_third as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_third  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_third as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_third
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_third as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_third l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_third as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_third
			group by 1,2
		),
        hits_by_tags_third as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_third
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits_third as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_third
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data_third as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_third h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_third_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d_third as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_third
		group by 1,2,3
		),
        categories_third as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_third
		),
        json_data_third as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_third
		)
    

    SELECT 
		CONCAT(
        ''{'',
            ''"site":'',jd.siteid,'','',
            ''"data": {'',
                ''"label": "'', jd.lab, ''",'',
                ''"categories": ['', jd.cat, ''],'',
                ''"series": ['', jd.series, '']'',
                '',"defaultTitle":"',dtitle,'"'',
                '',"additional":[ ''
                
                ,''{'',
                ''"title":"',title1,'",'',
                ''"data": {'',
                ''"label": "'',json_data_second.lab, ''",'',
                ''"categories": ['', json_data_second.cat, ''],'',
                ''"series": ['', json_data_second.series, '']'',
                ''}}''
                
                , '',''
                
                
                ,''{'',
                ''"title":"',title2,'",'',
                ''"data": {'',
                ''"label": "'',json_data_third.lab, ''",'',
                ''"categories": ['', json_data_third.cat, ''],'',
                ''"series": ['', json_data_third.series, '']'',
                ''}}''
                
                
        '']}}''
    
			) as json_data
		  FROM json_data jd
          
          CROSS join json_data_second
          
          CROSS join json_data_third
          ;
[0m11:21:18.789481 [debug] [MainThread]: Command `dbt compile` succeeded at 11:21:18.789481 after 1.21 seconds
[0m11:21:18.790480 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028EA92FE750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028EA94B7D70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028EA94B5C70>]}
[0m11:21:18.791482 [debug] [MainThread]: Flushing usage events
[0m11:29:55.050811 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028D71B12330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028D71B13860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028D71B13C20>]}


============================== 11:29:55.056813 | c13d4695-8ea5-4ed6-aa3d-3cbb5bb07475 ==============================
[0m11:29:55.056813 [info ] [MainThread]: Running with dbt=1.7.13
[0m11:29:55.058817 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m11:29:55.338511 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c13d4695-8ea5-4ed6-aa3d-3cbb5bb07475', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028D71BD92B0>]}
[0m11:29:55.458523 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c13d4695-8ea5-4ed6-aa3d-3cbb5bb07475', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028D70EA4170>]}
[0m11:29:55.459524 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m11:29:55.475528 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m11:29:55.578521 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m11:29:55.579523 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m11:29:55.796615 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c13d4695-8ea5-4ed6-aa3d-3cbb5bb07475', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028D7202A7B0>]}
[0m11:29:55.811622 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c13d4695-8ea5-4ed6-aa3d-3cbb5bb07475', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028D71F08230>]}
[0m11:29:55.812619 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m11:29:55.814629 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c13d4695-8ea5-4ed6-aa3d-3cbb5bb07475', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028D7209DF40>]}
[0m11:29:55.817616 [info ] [MainThread]: 
[0m11:29:55.818619 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m11:29:55.820617 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m11:29:55.837618 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:29:55.837618 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m11:29:55.839622 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:29:55.909558 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m11:29:55.910560 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:29:55.910560 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m11:29:55.921558 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m11:29:55.923561 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m11:29:55.925560 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m11:29:55.931559 [debug] [MainThread]: Using postgres connection "master"
[0m11:29:55.932559 [debug] [MainThread]: On master: BEGIN
[0m11:29:55.932559 [debug] [MainThread]: Opening a new connection, currently in state init
[0m11:29:55.985559 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m11:29:55.986564 [debug] [MainThread]: Using postgres connection "master"
[0m11:29:55.986564 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m11:29:55.997557 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m11:29:56.000561 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c13d4695-8ea5-4ed6-aa3d-3cbb5bb07475', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028D71F0BC50>]}
[0m11:29:56.000561 [debug] [MainThread]: On master: ROLLBACK
[0m11:29:56.001560 [debug] [MainThread]: On master: Close
[0m11:29:56.003563 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:29:56.005575 [info ] [MainThread]: 
[0m11:29:56.010558 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m11:29:56.012560 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13'
[0m11:29:56.013558 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m11:29:56.037559 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13"
[0m11:29:56.040565 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (compile): 11:29:56.013558 => 11:29:56.039562
[0m11:29:56.042562 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m11:29:56.044558 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (execute): 11:29:56.043565 => 11:29:56.043565
[0m11:29:56.046559 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m11:29:56.048559 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:29:56.049559 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m11:29:56.049559 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13' was properly closed.
[0m11:29:56.051560 [debug] [MainThread]: Command end result
[0m11:29:56.065561 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_month_13' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_13`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN userneeds like "%Opdater mig%" then "Opdater mig"
			    WHEN userneeds like "%Forbind mig%" then "Forbind mig"
			    WHEN userneeds like "%Help mig med at forsta%" then "Help mig med at forsta"
			    WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
			    WHEN userneeds like "%Underhold mig%" then "Underhold mig"
			    WHEN userneeds like "%Inspirer migg%" then "Inspirer migg"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data
			group by 1,2
		),
        hits_by_tags as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data
		group by 1,2,3
		),
        categories as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d
		),
        json_data as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories
		), 
    
    last_30_days_article_published_second as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Categories like "%Long read%" then "Long read"
			    WHEN Categories like "%Kort og godt%" then "Kort og godt"
			    WHEN Categories like "%Q&amp%" then "Q&amp"
			    WHEN Categories like "%Best Practice%" then "Best Practice"
			    WHEN Categories like "%Viden og forskning%" then "Viden og forskning"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_second as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_second  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_second as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_second  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_second as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_second
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_second as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_second l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_second as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_second
			group by 1,2
		),
        hits_by_tags_second as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_second
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits_second as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_second
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data_second as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_second h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d_second as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_second
		group by 1,2,3
		),
        categories_second as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_second
		),
        json_data_second as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_second
		), 
    
    last_30_days_article_published_third as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Tags like "%order_statement_second%" then "order_statement_second"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, ')
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_third as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_third  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_third as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_third  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_third as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_third
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_third as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_third l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_third as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_third
			group by 1,2
		),
        hits_by_tags_third as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_third
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits_third as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_third
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data_third as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_third h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d_third as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_third
		group by 1,2,3
		),
        categories_third as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_third
		),
        json_data_third as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_third
		)
    

    SELECT 
		CONCAT(
        ''{'',
            ''"site":'',jd.siteid,'','',
            ''"data": {'',
                ''"label": "'', jd.lab, ''",'',
                ''"categories": ['', jd.cat, ''],'',
                ''"series": ['', jd.series, '']'',
                '',"defaultTitle":"',dtitle,'"'',
                '',"additional":[ ''
                
                ,''{'',
                ''"title":"',title1,'",'',
                ''"data": {'',
                ''"label": "'',json_data_second.lab, ''",'',
                ''"categories": ['', json_data_second.cat, ''],'',
                ''"series": ['', json_data_second.series, '']'',
                ''}}''
                
                , '',''
                
                
                ,''{'',
                ''"title":"',title2,'",'',
                ''"data": {'',
                ''"label": "'',json_data_third.lab, ''",'',
                ''"categories": ['', json_data_third.cat, ''],'',
                ''"series": ['', json_data_third.series, '']'',
                ''}}''
                
                
        '']}}''
    
			) as json_data
		  FROM json_data jd
          
          CROSS join json_data_second
          
          CROSS join json_data_third
          ;
[0m11:29:56.093573 [debug] [MainThread]: Command `dbt compile` succeeded at 11:29:56.092562 after 1.24 seconds
[0m11:29:56.094565 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028D6B4F55E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028D71B37AA0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028D70F36F30>]}
[0m11:29:56.095566 [debug] [MainThread]: Flushing usage events
[0m11:38:58.430948 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A94FB63B90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A94FB63A10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A94FB62840>]}


============================== 11:38:58.436947 | 6b12ac9c-add9-42c5-b534-03dd21554dd5 ==============================
[0m11:38:58.436947 [info ] [MainThread]: Running with dbt=1.7.13
[0m11:38:58.438950 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m11:38:58.695489 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6b12ac9c-add9-42c5-b534-03dd21554dd5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A94FBB8620>]}
[0m11:38:58.816491 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6b12ac9c-add9-42c5-b534-03dd21554dd5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A94FED6150>]}
[0m11:38:58.818495 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m11:38:58.833491 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m11:38:58.946887 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m11:38:58.947892 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m11:38:59.155897 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6b12ac9c-add9-42c5-b534-03dd21554dd5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A9501602C0>]}
[0m11:38:59.171892 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6b12ac9c-add9-42c5-b534-03dd21554dd5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A94FF69A90>]}
[0m11:38:59.173894 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m11:38:59.174904 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6b12ac9c-add9-42c5-b534-03dd21554dd5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A94FE01130>]}
[0m11:38:59.176896 [info ] [MainThread]: 
[0m11:38:59.178893 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m11:38:59.180890 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m11:38:59.196901 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:38:59.197891 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m11:38:59.198900 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:38:59.254890 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m11:38:59.255893 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:38:59.255893 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m11:38:59.264890 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m11:38:59.266890 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m11:38:59.266890 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m11:38:59.274888 [debug] [MainThread]: Using postgres connection "master"
[0m11:38:59.274888 [debug] [MainThread]: On master: BEGIN
[0m11:38:59.275889 [debug] [MainThread]: Opening a new connection, currently in state init
[0m11:38:59.323891 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m11:38:59.324893 [debug] [MainThread]: Using postgres connection "master"
[0m11:38:59.325892 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m11:38:59.335888 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m11:38:59.337891 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6b12ac9c-add9-42c5-b534-03dd21554dd5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A950094110>]}
[0m11:38:59.338892 [debug] [MainThread]: On master: ROLLBACK
[0m11:38:59.339890 [debug] [MainThread]: On master: Close
[0m11:38:59.340894 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:38:59.342905 [info ] [MainThread]: 
[0m11:38:59.347891 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m11:38:59.348893 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13'
[0m11:38:59.349891 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m11:38:59.376899 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13"
[0m11:38:59.379893 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (compile): 11:38:59.349891 => 11:38:59.378928
[0m11:38:59.380894 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m11:38:59.382891 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (execute): 11:38:59.381893 => 11:38:59.381893
[0m11:38:59.384893 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m11:38:59.386891 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:38:59.386891 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m11:38:59.387890 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13' was properly closed.
[0m11:38:59.388890 [debug] [MainThread]: Command end result
[0m11:38:59.401893 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_month_13' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_13`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN userneeds like "%Opdater mig%" then "Opdater mig"
			    WHEN userneeds like "%Forbind mig%" then "Forbind mig"
			    WHEN userneeds like "%Help mig med at forsta%" then "Help mig med at forsta"
			    WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
			    WHEN userneeds like "%Underhold mig%" then "Underhold mig"
			    WHEN userneeds like "%Inspirer migg%" then "Inspirer migg"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data
			group by 1,2
		),
        hits_by_tags as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data
		group by 1,2,3
		),
        categories as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d
		),
        json_data as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories
		), 
    
    last_30_days_article_published_second as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Categories like "%Long read%" then "Long read"
			    WHEN Categories like "%Kort og godt%" then "Kort og godt"
			    WHEN Categories like "%Q&amp%" then "Q&amp"
			    WHEN Categories like "%Best Practice%" then "Best Practice"
			    WHEN Categories like "%Viden og forskning%" then "Viden og forskning"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_second as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_second  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_second as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_second  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_second as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_second
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_second as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_second l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_second as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_second
			group by 1,2
		),
        hits_by_tags_second as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_second
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits_second as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_second
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data_second as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_second h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d_second as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_second
		group by 1,2,3
		),
        categories_second as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_second
		),
        json_data_second as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_second
		), 
    
    last_30_days_article_published_third as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Tags like "%order_statement_second%" then "order_statement_second"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_third as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_third  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_third as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_third  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_third as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_third
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_third as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_third l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_third as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_third
			group by 1,2
		),
        hits_by_tags_third as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_third
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits_third as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_third
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data_third as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_third h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d_third as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_third
		group by 1,2,3
		),
        categories_third as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_third
		),
        json_data_third as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_third
		)
    

    SELECT 
		CONCAT(
        ''{'',
            ''"site":'',jd.siteid,'','',
            ''"data": {'',
                ''"label": "'', jd.lab, ''",'',
                ''"categories": ['', jd.cat, ''],'',
                ''"series": ['', jd.series, '']'',
                '',"defaultTitle":"',dtitle,'"'',
                '',"additional":[ ''
                
                ,''{'',
                ''"title":"',title1,'",'',
                ''"data": {'',
                ''"label": "'',json_data_second.lab, ''",'',
                ''"categories": ['', json_data_second.cat, ''],'',
                ''"series": ['', json_data_second.series, '']'',
                ''}}''
                
                , '',''
                
                
                ,''{'',
                ''"title":"',title2,'",'',
                ''"data": {'',
                ''"label": "'',json_data_third.lab, ''",'',
                ''"categories": ['', json_data_third.cat, ''],'',
                ''"series": ['', json_data_third.series, '']'',
                ''}}''
                
                
        '']}}''
    
			) as json_data
		  FROM json_data jd
          
          CROSS join json_data_second
          
          CROSS join json_data_third
          ;
[0m11:38:59.425893 [debug] [MainThread]: Command `dbt compile` succeeded at 11:38:59.424930 after 1.19 seconds
[0m11:38:59.426894 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A94F7F7830>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A94FB43CE0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A94FB43EC0>]}
[0m11:38:59.427893 [debug] [MainThread]: Flushing usage events
[0m12:09:32.741751 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C1E5742F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C1E575D00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C1E576A20>]}


============================== 12:09:32.748750 | 89770ad1-02dc-4fe7-9877-23be107d9861 ==============================
[0m12:09:32.748750 [info ] [MainThread]: Running with dbt=1.7.13
[0m12:09:32.750757 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'send_anonymous_usage_stats': 'True'}
[0m12:09:33.071946 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '89770ad1-02dc-4fe7-9877-23be107d9861', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C1E5C8770>]}
[0m12:09:33.191950 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '89770ad1-02dc-4fe7-9877-23be107d9861', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C1E474170>]}
[0m12:09:33.193949 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m12:09:33.216951 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m12:09:33.916623 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m12:09:33.917625 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m12:09:33.924625 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '89770ad1-02dc-4fe7-9877-23be107d9861', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C1E7E0C20>]}
[0m12:09:33.953628 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '89770ad1-02dc-4fe7-9877-23be107d9861', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C1E949640>]}
[0m12:09:33.955629 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m12:09:33.957635 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '89770ad1-02dc-4fe7-9877-23be107d9861', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C1E7561E0>]}
[0m12:09:33.960624 [info ] [MainThread]: 
[0m12:09:33.962628 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m12:09:33.964634 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m12:09:33.980633 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m12:09:33.981641 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m12:09:33.982644 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:09:34.042625 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m12:09:34.043628 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m12:09:34.044626 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m12:09:34.055625 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m12:09:34.057626 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m12:09:34.058626 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m12:09:34.065626 [debug] [MainThread]: Using postgres connection "master"
[0m12:09:34.065626 [debug] [MainThread]: On master: BEGIN
[0m12:09:34.066627 [debug] [MainThread]: Opening a new connection, currently in state init
[0m12:09:34.114628 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m12:09:34.114628 [debug] [MainThread]: Using postgres connection "master"
[0m12:09:34.115629 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m12:09:34.127625 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m12:09:34.129626 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '89770ad1-02dc-4fe7-9877-23be107d9861', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C1E8F0710>]}
[0m12:09:34.130624 [debug] [MainThread]: On master: ROLLBACK
[0m12:09:34.131625 [debug] [MainThread]: On master: Close
[0m12:09:34.132627 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m12:09:34.134641 [info ] [MainThread]: 
[0m12:09:34.140625 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m12:09:34.141627 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13'
[0m12:09:34.142628 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m12:09:34.170626 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13"
[0m12:09:34.172648 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (compile): 12:09:34.143627 => 12:09:34.171626
[0m12:09:34.173630 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m12:09:34.175628 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (execute): 12:09:34.174630 => 12:09:34.174630
[0m12:09:34.176629 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m12:09:34.178626 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:09:34.179629 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m12:09:34.181628 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13' was properly closed.
[0m12:09:34.182627 [debug] [MainThread]: Command end result
[0m12:09:34.194628 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_month_13' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_13`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN userneeds like "%Opdater mig%" then "Opdater mig"
			    WHEN userneeds like "%Forbind mig%" then "Forbind mig"
			    WHEN userneeds like "%Help mig med at forsta%" then "Help mig med at forsta"
			    WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
			    WHEN userneeds like "%Underhold mig%" then "Underhold mig"
			    WHEN userneeds like "%Inspirer migg%" then "Inspirer migg"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data
			group by 1,2
		),
        hits_by_tags as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data
		group by 1,2,3
		),
        categories as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d
		),
        json_data as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories
		), 
    
    last_30_days_article_published_second as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Categories like "%Long read%" then "Long read"
			    WHEN Categories like "%Kort og godt%" then "Kort og godt"
			    WHEN Categories like "%Q&amp%" then "Q&amp"
			    WHEN Categories like "%Best Practice%" then "Best Practice"
			    WHEN Categories like "%Viden og forskning%" then "Viden og forskning"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_second as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_second  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_second as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_second  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_second as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_second
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_second as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_second l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_second as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_second
			group by 1,2
		),
        hits_by_tags_second as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_second
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits_second as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_second
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data_second as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_second h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d_second as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_second
		group by 1,2,3
		),
        categories_second as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_second
		),
        json_data_second as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_second
		), 
    
    last_30_days_article_published_third as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Tags like "%order_statement_second%" then "order_statement_second"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_third as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_third  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_third as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_third  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_third as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_third
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_third as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_third l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_third as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_third
			group by 1,2
		),
        hits_by_tags_third as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_third
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits_third as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_third
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data_third as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_third h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d_third as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_third
		group by 1,2,3
		),
        categories_third as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_third
		),
        json_data_third as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_third
		)
    

    SELECT 
		CONCAT(
        ''{'',
            ''"site":'',jd.siteid,'','',
            ''"data": {'',
                ''"label": "'', jd.lab, ''",'',
                ''"categories": ['', jd.cat, ''],'',
                ''"series": ['', jd.series, '']'',
                '',"defaultTitle":"',dtitle,'"'',
                '',"additional":[ ''
                
                ,''{'',
                ''"title":"',title1,'",'',
                ''"data": {'',
                ''"label": "'',json_data_second.lab, ''",'',
                ''"categories": ['', json_data_second.cat, ''],'',
                ''"series": ['', json_data_second.series, '']'',
                ''}}''
                
                , '',''
                
                
                ,''{'',
                ''"title":"',title2,'",'',
                ''"data": {'',
                ''"label": "'',json_data_third.lab, ''",'',
                ''"categories": ['', json_data_third.cat, ''],'',
                ''"series": ['', json_data_third.series, '']'',
                ''}}''
                
                
        '']}}''
    
			) as json_data
		  FROM json_data jd
          
          CROSS join json_data_second
          
          CROSS join json_data_third
          ;
[0m12:09:34.218626 [debug] [MainThread]: Command `dbt compile` succeeded at 12:09:34.218626 after 1.70 seconds
[0m12:09:34.219628 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C1B675A90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C1E139D00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C1E139D90>]}
[0m12:09:34.220629 [debug] [MainThread]: Flushing usage events
[0m12:33:14.362001 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C1AE555970>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C1AE463320>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C1AE557E60>]}


============================== 12:33:14.367009 | c3255f50-98bb-41a0-8b9a-081b8c6d1e48 ==============================
[0m12:33:14.367009 [info ] [MainThread]: Running with dbt=1.7.13
[0m12:33:14.369014 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m12:33:14.630998 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c3255f50-98bb-41a0-8b9a-081b8c6d1e48', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C1AE5A8D40>]}
[0m12:33:14.750000 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c3255f50-98bb-41a0-8b9a-081b8c6d1e48', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C1AE63AB10>]}
[0m12:33:14.752000 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m12:33:14.774018 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m12:33:14.867017 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m12:33:14.868020 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m12:33:15.086473 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c3255f50-98bb-41a0-8b9a-081b8c6d1e48', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C1AE786C90>]}
[0m12:33:15.100474 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c3255f50-98bb-41a0-8b9a-081b8c6d1e48', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C1AE969970>]}
[0m12:33:15.101475 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m12:33:15.103483 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c3255f50-98bb-41a0-8b9a-081b8c6d1e48', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C1AEAAB800>]}
[0m12:33:15.106473 [info ] [MainThread]: 
[0m12:33:15.107475 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m12:33:15.109474 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m12:33:15.125472 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m12:33:15.127479 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m12:33:15.128475 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:33:15.186472 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m12:33:15.187478 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m12:33:15.187478 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m12:33:15.196475 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m12:33:15.198474 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m12:33:15.199473 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m12:33:15.208473 [debug] [MainThread]: Using postgres connection "master"
[0m12:33:15.208473 [debug] [MainThread]: On master: BEGIN
[0m12:33:15.209473 [debug] [MainThread]: Opening a new connection, currently in state init
[0m12:33:15.261476 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m12:33:15.262475 [debug] [MainThread]: Using postgres connection "master"
[0m12:33:15.263475 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m12:33:15.272474 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m12:33:15.274472 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c3255f50-98bb-41a0-8b9a-081b8c6d1e48', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C1AE96B1A0>]}
[0m12:33:15.275473 [debug] [MainThread]: On master: ROLLBACK
[0m12:33:15.276478 [debug] [MainThread]: On master: Close
[0m12:33:15.278478 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m12:33:15.279474 [info ] [MainThread]: 
[0m12:33:15.285475 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m12:33:15.286475 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13'
[0m12:33:15.287473 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m12:33:15.314476 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13"
[0m12:33:15.317488 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (compile): 12:33:15.288475 => 12:33:15.316483
[0m12:33:15.318476 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m12:33:15.319481 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (execute): 12:33:15.319481 => 12:33:15.319481
[0m12:33:15.321474 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m12:33:15.323475 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:33:15.324474 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m12:33:15.324474 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13' was properly closed.
[0m12:33:15.325475 [debug] [MainThread]: Command end result
[0m12:33:15.337484 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_month_13' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_13`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN userneeds like "%Opdater mig%" then "Opdater mig"
			    WHEN userneeds like "%Forbind mig%" then "Forbind mig"
			    WHEN userneeds like "%Help mig med at forsta%" then "Help mig med at forsta"
			    WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
			    WHEN userneeds like "%Underhold mig%" then "Underhold mig"
			    WHEN userneeds like "%Inspirer migg%" then "Inspirer migg"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data
			group by 1,2
		),
        hits_by_tags as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data
		group by 1,2,3
		),
        categories as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d
		),
        json_data as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories
		), 
    
    last_30_days_article_published_second as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Categories like "%order_statement_second%" then "order_statement_second"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_second as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_second  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_second as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_second  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_second as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_second
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_second as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_second l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_second as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_second
			group by 1,2
		),
        hits_by_tags_second as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_second
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits_second as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_second
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data_second as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_second h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d_second as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_second
		group by 1,2,3
		),
        categories_second as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_second
		),
        json_data_second as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_second
		), 
    
    last_30_days_article_published_third as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Tags like "%Long read%" then "Long read"
			    WHEN Tags like "%Kort og godt%" then "Kort og godt"
			    WHEN Tags like "%Q&amp%" then "Q&amp"
			    WHEN Tags like "%Best Practice%" then "Best Practice"
			    WHEN Tags like "%Viden og forskning%" then "Viden og forskning"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_third as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_third  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_third as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_third  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_third as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_third
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_third as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_third l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_third as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_third
			group by 1,2
		),
        hits_by_tags_third as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_third
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits_third as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_third
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data_third as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_third h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d_third as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_third
		group by 1,2,3
		),
        categories_third as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_third
		),
        json_data_third as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_third
		)
    

    SELECT 
		CONCAT(
        ''{'',
            ''"site":'',jd.siteid,'','',
            ''"data": {'',
                ''"label": "'', jd.lab, ''",'',
                ''"categories": ['', jd.cat, ''],'',
                ''"series": ['', jd.series, '']'',
                '',"defaultTitle":"',dtitle,'"'',
                '',"additional":[ ''
                
                ,''{'',
                ''"title":"',title1,'",'',
                ''"data": {'',
                ''"label": "'',json_data_second.lab, ''",'',
                ''"categories": ['', json_data_second.cat, ''],'',
                ''"series": ['', json_data_second.series, '']'',
                ''}}''
                
                , '',''
                
                
                ,''{'',
                ''"title":"',title2,'",'',
                ''"data": {'',
                ''"label": "'',json_data_third.lab, ''",'',
                ''"categories": ['', json_data_third.cat, ''],'',
                ''"series": ['', json_data_third.series, '']'',
                ''}}''
                
                
        '']}}''
    
			) as json_data
		  FROM json_data jd
          
          CROSS join json_data_second
          
          CROSS join json_data_third
          ;
[0m12:33:15.361474 [debug] [MainThread]: Command `dbt compile` succeeded at 12:33:15.360473 after 1.21 seconds
[0m12:33:15.361474 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C1AE557E60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C1AE463320>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C1AD8351C0>]}
[0m12:33:15.363476 [debug] [MainThread]: Flushing usage events
[0m12:41:56.558984 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C9A7330E90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C9A6EBC9B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C9A7331970>]}


============================== 12:41:56.563984 | f298537b-41a1-4fa7-9ed6-1e74efa0e98f ==============================
[0m12:41:56.563984 [info ] [MainThread]: Running with dbt=1.7.13
[0m12:41:56.565994 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m12:41:56.854001 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f298537b-41a1-4fa7-9ed6-1e74efa0e98f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C9A7388440>]}
[0m12:41:56.973025 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f298537b-41a1-4fa7-9ed6-1e74efa0e98f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C9A63DEE70>]}
[0m12:41:56.975026 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m12:41:56.991052 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m12:41:57.514024 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m12:41:57.515026 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m12:41:57.673026 [error] [MainThread]: Encountered an error:
Compilation Error in model tactical_userneeds_pageviews_chart_month_13 (models\tactical_userneeds_pageviews_chart_month_13.sql)
  expected token ',', got 'string'
    line 4
      {% set diction2 = {0: ['Opdater mig', 'Forbind mig', 'Help mig med at forsta', 'Giv mig en fordel','Underhold mig','Inspirer migg'],  2: ['Slagterindustri', Fødevareindustri', 'Mejeri', 'Butik', 'Alle brancher'],1: ['order_statement_second']} %}
[0m12:41:57.676032 [debug] [MainThread]: Command `dbt compile` failed at 12:41:57.676032 after 1.33 seconds
[0m12:41:57.677030 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C9A0D85610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C9A7119460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C9A7672690>]}
[0m12:41:57.678038 [debug] [MainThread]: Flushing usage events
[0m12:43:30.514541 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000209E3392780>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000209E3391A90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000209E3393DA0>]}


============================== 12:43:30.520540 | 0d7529ef-dddc-431b-8a52-6dd27a4476ce ==============================
[0m12:43:30.520540 [info ] [MainThread]: Running with dbt=1.7.13
[0m12:43:30.522546 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m12:43:30.775537 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0d7529ef-dddc-431b-8a52-6dd27a4476ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000209E33E85F0>]}
[0m12:43:30.893538 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0d7529ef-dddc-431b-8a52-6dd27a4476ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000209E33BA810>]}
[0m12:43:30.895537 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m12:43:30.908537 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m12:43:31.010537 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m12:43:31.011540 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m12:43:31.170540 [error] [MainThread]: Encountered an error:
Compilation Error in model tactical_userneeds_pageviews_chart_month_13 (models\tactical_userneeds_pageviews_chart_month_13.sql)
  expected token ',', got 'string'
    line 4
      {% set diction2 = {0: ['Opdater mig', 'Forbind mig', 'Help mig med at forsta', 'Giv mig en fordel','Underhold mig','Inspirer migg'],1: ['order_statement_second'],  2: ['Slagterindustri', Fødevareindustri', 'Mejeri', 'Butik', 'Alle brancher']} %}
[0m12:43:31.173555 [debug] [MainThread]: Command `dbt compile` failed at 12:43:31.172549 after 0.85 seconds
[0m12:43:31.173555 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000209E3027830>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000209E35D4C80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000209E3506DB0>]}
[0m12:43:31.175557 [debug] [MainThread]: Flushing usage events
[0m12:44:41.625396 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001132D820440>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001132D822870>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001132D822AE0>]}


============================== 12:44:41.631407 | 116466b4-d855-4a1c-b9f9-bf783daae42e ==============================
[0m12:44:41.631407 [info ] [MainThread]: Running with dbt=1.7.13
[0m12:44:41.633404 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m12:44:41.888395 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '116466b4-d855-4a1c-b9f9-bf783daae42e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001132D879070>]}
[0m12:44:42.010396 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '116466b4-d855-4a1c-b9f9-bf783daae42e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001132D8CB110>]}
[0m12:44:42.012397 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m12:44:42.025400 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m12:44:42.119399 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m12:44:42.120400 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m12:44:42.327397 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '116466b4-d855-4a1c-b9f9-bf783daae42e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001132DE3A0C0>]}
[0m12:44:42.342401 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '116466b4-d855-4a1c-b9f9-bf783daae42e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001132DC29CA0>]}
[0m12:44:42.344401 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m12:44:42.345405 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '116466b4-d855-4a1c-b9f9-bf783daae42e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001132D822300>]}
[0m12:44:42.348401 [info ] [MainThread]: 
[0m12:44:42.350400 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m12:44:42.352397 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m12:44:42.370396 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m12:44:42.370396 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m12:44:42.371397 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:44:42.427397 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m12:44:42.428400 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m12:44:42.429398 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m12:44:42.437397 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m12:44:42.438396 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m12:44:42.440399 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m12:44:42.448397 [debug] [MainThread]: Using postgres connection "master"
[0m12:44:42.449397 [debug] [MainThread]: On master: BEGIN
[0m12:44:42.449397 [debug] [MainThread]: Opening a new connection, currently in state init
[0m12:44:42.503409 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m12:44:42.504401 [debug] [MainThread]: Using postgres connection "master"
[0m12:44:42.505400 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m12:44:42.514396 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m12:44:42.516398 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '116466b4-d855-4a1c-b9f9-bf783daae42e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001132DC2BEF0>]}
[0m12:44:42.517399 [debug] [MainThread]: On master: ROLLBACK
[0m12:44:42.518398 [debug] [MainThread]: On master: Close
[0m12:44:42.520400 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m12:44:42.523409 [info ] [MainThread]: 
[0m12:44:42.530400 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m12:44:42.532398 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13'
[0m12:44:42.533396 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m12:44:42.557396 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13"
[0m12:44:42.561399 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (compile): 12:44:42.533396 => 12:44:42.560400
[0m12:44:42.562399 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m12:44:42.563398 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (execute): 12:44:42.562399 => 12:44:42.562399
[0m12:44:42.564397 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m12:44:42.566397 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:44:42.567396 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m12:44:42.568397 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13' was properly closed.
[0m12:44:42.569397 [debug] [MainThread]: Command end result
[0m12:44:42.581396 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_month_13' is:







CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_13`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN userneeds like "%Opdater mig%" then "Opdater mig"
			    WHEN userneeds like "%Forbind mig%" then "Forbind mig"
			    WHEN userneeds like "%Help mig med at forsta%" then "Help mig med at forsta"
			    WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
			    WHEN userneeds like "%Underhold mig%" then "Underhold mig"
			    WHEN userneeds like "%Inspirer migg%" then "Inspirer migg"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data
			group by 1,2
		),
        hits_by_tags as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data
		group by 1,2,3
		),
        categories as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d
		),
        json_data as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories
		), 
    
    last_30_days_article_published_second as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Categories like "%order_statement_second%" then "order_statement_second"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_second as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_second  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_second as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_second  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_second as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_second
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_second as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_second l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_second as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_second
			group by 1,2
		),
        hits_by_tags_second as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_second
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits_second as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_second
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data_second as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_second h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d_second as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_second
		group by 1,2,3
		),
        categories_second as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_second
		),
        json_data_second as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_second
		), 
    
    last_30_days_article_published_third as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Tags like "%Slagterindustri%" then "Slagterindustri"
			    WHEN Tags like "%Fødevareindustri%" then "Fødevareindustri"
			    WHEN Tags like "%Mejeri%" then "Mejeri"
			    WHEN Tags like "%Butik%" then "Butik"
			    WHEN Tags like "%Alle brancher%" then "Alle brancher"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_third as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_third  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_third as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_third  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_third as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_third
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_third as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_third l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_third as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_third
			group by 1,2
		),
        hits_by_tags_third as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_third
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits_third as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_third
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data_third as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_third h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d_third as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_third
		group by 1,2,3
		),
        categories_third as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_third
		),
        json_data_third as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_third
		)
    

    SELECT 
		CONCAT(
        ''{'',
            ''"site":'',jd.siteid,'','',
            ''"data": {'',
                ''"label": "'', jd.lab, ''",'',
                ''"categories": ['', jd.cat, ''],'',
                ''"series": ['', jd.series, '']'',
                '',"defaultTitle":"',dtitle,'"'',
                '',"additional":[ ''
                
                ,''{'',
                ''"title":"',title1,'",'',
                ''"data": {'',
                ''"label": "'',json_data_second.lab, ''",'',
                ''"categories": ['', json_data_second.cat, ''],'',
                ''"series": ['', json_data_second.series, '']'',
                ''}}''
                
                , '',''
                
                
                ,''{'',
                ''"title":"',title2,'",'',
                ''"data": {'',
                ''"label": "'',json_data_third.lab, ''",'',
                ''"categories": ['', json_data_third.cat, ''],'',
                ''"series": ['', json_data_third.series, '']'',
                ''}}''
                
                
        '']}}''
    
			) as json_data
		  FROM json_data jd
          
          CROSS join json_data_second
          
          CROSS join json_data_third
          ;
[0m12:44:42.605399 [debug] [MainThread]: Command `dbt compile` succeeded at 12:44:42.605399 after 1.13 seconds
[0m12:44:42.606398 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000113272B5610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001132CCEEF30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001132D8479B0>]}
[0m12:44:42.607399 [debug] [MainThread]: Flushing usage events
[0m13:02:15.801498 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F87F083860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F87F081CA0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F87F0830B0>]}


============================== 13:02:15.807500 | ac851f86-a8b9-4837-bb3c-a40aa3f9ec2c ==============================
[0m13:02:15.807500 [info ] [MainThread]: Running with dbt=1.7.13
[0m13:02:15.809503 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m13:02:16.064493 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ac851f86-a8b9-4837-bb3c-a40aa3f9ec2c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F87EF38B60>]}
[0m13:02:16.183496 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ac851f86-a8b9-4837-bb3c-a40aa3f9ec2c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F87EDAC170>]}
[0m13:02:16.185498 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m13:02:16.209210 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m13:02:16.304205 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m13:02:16.305208 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m13:02:16.511206 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ac851f86-a8b9-4837-bb3c-a40aa3f9ec2c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F87F5FDCA0>]}
[0m13:02:16.526209 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ac851f86-a8b9-4837-bb3c-a40aa3f9ec2c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F87F4B9BB0>]}
[0m13:02:16.527208 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m13:02:16.529215 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ac851f86-a8b9-4837-bb3c-a40aa3f9ec2c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F87F650530>]}
[0m13:02:16.531211 [info ] [MainThread]: 
[0m13:02:16.533206 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m13:02:16.535534 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m13:02:16.555297 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m13:02:16.555297 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m13:02:16.556297 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:02:16.615299 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m13:02:16.615299 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m13:02:16.616298 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m13:02:16.624297 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m13:02:16.626298 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m13:02:16.627296 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m13:02:16.635295 [debug] [MainThread]: Using postgres connection "master"
[0m13:02:16.636296 [debug] [MainThread]: On master: BEGIN
[0m13:02:16.637298 [debug] [MainThread]: Opening a new connection, currently in state init
[0m13:02:16.685297 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m13:02:16.686299 [debug] [MainThread]: Using postgres connection "master"
[0m13:02:16.687298 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m13:02:16.697297 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m13:02:16.699297 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ac851f86-a8b9-4837-bb3c-a40aa3f9ec2c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F87F4BBE30>]}
[0m13:02:16.700297 [debug] [MainThread]: On master: ROLLBACK
[0m13:02:16.700297 [debug] [MainThread]: On master: Close
[0m13:02:16.702299 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m13:02:16.703297 [info ] [MainThread]: 
[0m13:02:16.708296 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m13:02:16.710298 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13'
[0m13:02:16.712298 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m13:02:16.745328 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13"
[0m13:02:16.748298 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (compile): 13:02:16.713309 => 13:02:16.747296
[0m13:02:16.749297 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m13:02:16.750297 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (execute): 13:02:16.749297 => 13:02:16.749297
[0m13:02:16.752298 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m13:02:16.753298 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:02:16.754313 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m13:02:16.754313 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13' was properly closed.
[0m13:02:16.756299 [debug] [MainThread]: Command end result
[0m13:02:16.770296 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_month_13' is:







CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_13`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN userneeds like "%Opdater mig%" then "Opdater mig"
			    WHEN userneeds like "%Forbind mig%" then "Forbind mig"
			    WHEN userneeds like "%Help mig med at forsta%" then "Help mig med at forsta"
			    WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
			    WHEN userneeds like "%Underhold mig%" then "Underhold mig"
			    WHEN userneeds like "%Inspirer migg%" then "Inspirer migg"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data
			group by 1,2
		),
        hits_by_tags as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts h
			join total_hits t on h.siteid=t.siteid
			join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data
		group by 1,2,3
		),
        categories as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d
		),
        json_data as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories
		), 
    
    last_30_days_article_published_second as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Categories like "%order_statement_second%" then "order_statement_second"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_second as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_second  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_second as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_second  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_second as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_second
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_second as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_second l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_second as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_second
			group by 1,2
		),
        hits_by_tags_second as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_second
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits_second as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_second
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data_second as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_second h
			join total_hits_second t on h.siteid=t.siteid
			join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d_second as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_second
		group by 1,2,3
		),
        categories_second as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_second
		),
        json_data_second as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_second
		), 
    
    last_30_days_article_published_third as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Tags like "%Slagterindustri%" then "Slagterindustri"
			    WHEN Tags like "%Fødevareindustri%" then "Fødevareindustri"
			    WHEN Tags like "%Mejeri%" then "Mejeri"
			    WHEN Tags like "%Butik%" then "Butik"
			    WHEN Tags like "%Alle brancher%" then "Alle brancher"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_third as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_third  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_third as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_third  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_third as(
		select siteid as siteid,tags,sum(val) as agg_sum from  cta_per_article_third
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_third as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_third l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_third as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_third
			group by 1,2
		),
        hits_by_tags_third as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_third
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits_third as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_third
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data_third as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_third h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d_third as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_third
		group by 1,2,3
		),
        categories_third as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_third
		),
        json_data_third as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_third
		)
    

    SELECT 
		CONCAT(
        ''{'',
            ''"site":'',jd.siteid,'','',
            ''"data": {'',
                ''"label": "'', jd.lab, ''",'',
                ''"categories": ['', jd.cat, ''],'',
                ''"series": ['', jd.series, '']'',
                '',"defaultTitle":"',dtitle,'"'',
                '',"additional":[ ''
                
                ,''{'',
                ''"title":"',title1,'",'',
                ''"data": {'',
                ''"label": "'',json_data_second.lab, ''",'',
                ''"categories": ['', json_data_second.cat, ''],'',
                ''"series": ['', json_data_second.series, '']'',
                ''}}''
                
                , '',''
                
                
                ,''{'',
                ''"title":"',title2,'",'',
                ''"data": {'',
                ''"label": "'',json_data_third.lab, ''",'',
                ''"categories": ['', json_data_third.cat, ''],'',
                ''"series": ['', json_data_third.series, '']'',
                ''}}''
                
                
        '']}}''
    
			) as json_data
		  FROM json_data jd
          
          CROSS join json_data_second
          
          CROSS join json_data_third
          ;
[0m13:02:16.797321 [debug] [MainThread]: Command `dbt compile` succeeded at 13:02:16.797321 after 1.20 seconds
[0m13:02:16.798320 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F87EE68680>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F87F083860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F87F6ABBF0>]}
[0m13:02:16.799320 [debug] [MainThread]: Flushing usage events
[0m14:37:07.218235 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FE407B30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FE407BC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FE407530>]}


============================== 14:37:07.230241 | 90a6c25e-484c-4373-83d8-920a714d4b67 ==============================
[0m14:37:07.230241 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:37:07.233235 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_13', 'send_anonymous_usage_stats': 'True'}
[0m14:37:07.738216 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '90a6c25e-484c-4373-83d8-920a714d4b67', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FE458BF0>]}
[0m14:37:07.978571 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '90a6c25e-484c-4373-83d8-920a714d4b67', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FE426750>]}
[0m14:37:07.981568 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:37:08.010642 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:37:08.243315 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m14:37:08.245316 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m14:37:08.628140 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '90a6c25e-484c-4373-83d8-920a714d4b67', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FE5FA0F0>]}
[0m14:37:08.656137 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '90a6c25e-484c-4373-83d8-920a714d4b67', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FE859820>]}
[0m14:37:08.657140 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m14:37:08.659520 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '90a6c25e-484c-4373-83d8-920a714d4b67', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FE77EAB0>]}
[0m14:37:08.664143 [info ] [MainThread]: 
[0m14:37:08.667140 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m14:37:08.669139 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m14:37:08.692472 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:37:08.693693 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m14:37:08.695312 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:37:08.785269 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m14:37:08.786270 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:37:08.787271 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m14:37:08.802943 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m14:37:08.805944 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m14:37:08.806942 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m14:37:08.816949 [debug] [MainThread]: Using postgres connection "master"
[0m14:37:08.818236 [debug] [MainThread]: On master: BEGIN
[0m14:37:08.818946 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:37:08.888947 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m14:37:08.890949 [debug] [MainThread]: Using postgres connection "master"
[0m14:37:08.891945 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m14:37:08.907765 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m14:37:08.911843 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '90a6c25e-484c-4373-83d8-920a714d4b67', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FE85BE30>]}
[0m14:37:08.912769 [debug] [MainThread]: On master: ROLLBACK
[0m14:37:08.914769 [debug] [MainThread]: On master: Close
[0m14:37:08.916003 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:37:08.918769 [info ] [MainThread]: 
[0m14:37:08.925763 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m14:37:08.928778 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13'
[0m14:37:08.929764 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m14:37:08.968763 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13"
[0m14:37:08.971778 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (compile): 14:37:08.931380 => 14:37:08.970769
[0m14:37:08.973763 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m14:37:08.974926 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (execute): 14:37:08.974926 => 14:37:08.974926
[0m14:37:08.977762 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m14:37:08.979766 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:37:08.980955 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m14:37:08.981766 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13' was properly closed.
[0m14:37:08.983767 [debug] [MainThread]: Command end result
[0m14:37:08.999763 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_month_13' is:








CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`tactical_userneeds_pageviews_chart_month_13`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN userneeds like "%Opdater mig%" then "Opdater mig"
			    WHEN userneeds like "%Forbind mig%" then "Forbind mig"
			    WHEN userneeds like "%Help mig med at forsta%" then "Hjælp mig med at forstå"
			    WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
			    WHEN userneeds like "%Underhold mig%" then "Underhold mig"
			    WHEN userneeds like "%Inspirer migg%" then "Inspirer migg"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article as(
		select siteid as siteid,tags,sum(val) as agg_sum from
        cta_per_article
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data
			group by 1,2
		),
        hits_by_tags as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts h
			join total_hits t on h.siteid=t.siteid
			join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data
		group by 1,2,3
		),
        categories as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d
		),
        json_data as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories
		), 
    
    last_30_days_article_published_second as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Categories like "%Nyhed%" then "Nyhed"
			    WHEN Categories like "%Medlemsinfo%" then "Medlemsinfo"
			    WHEN Categories like "%Reportage%" then "Reportage"
			    WHEN Categories like "%Artikel%" then "Artikel"
			    WHEN Categories like "%Det ku ske for dig%" then "Det ku ske for dig"
			    WHEN Categories like "%Jeg mener%" then "Jeg mener"
			    WHEN Categories like "%Videoartikel%" then "Videoartikel"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_second as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_second  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_second as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_second  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_second as(
		select siteid as siteid,tags,sum(val) as agg_sum from
        cta_per_article_second
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_second as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_second l
		join cta_per_article_second a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_second as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_second
			group by 1,2
		),
        hits_by_tags_second as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_second
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits_second as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_second
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data_second as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_second h
			join total_hits_second t on h.siteid=t.siteid
			join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d_second as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_second
		group by 1,2,3
		),
        categories_second as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_second
		),
        json_data_second as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_second
		), 
    
    last_30_days_article_published_third as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Tags like "%Slagterindustri%" then "Slagterindustri"
			    WHEN Tags like "%Fødevareindustri%" then "Fødevareindustri"
			    WHEN Tags like "%Mejeri%" then "Mejeri"
			    WHEN Tags like "%Butik%" then "Butik"
			    WHEN Tags like "%Alle brancher%" then "Alle brancher"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)         
        
        AND siteid = ', site, '),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_third as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_third  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_third as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_third  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_third as(
		select siteid as siteid,tags,sum(val) as agg_sum from
        cta_per_article_third
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_third as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_third l
		join cta_per_article_third a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_third as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_third
			group by 1,2
		),
        hits_by_tags_third as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_third
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits_third as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_third
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data_third as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_third h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d_third as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_third
		group by 1,2,3
		),
        categories_third as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_third
		),
        json_data_third as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_third
		)
    

    SELECT 
		CONCAT(
        ''{'',
            ''"site":'',jd.siteid,'','',
            ''"data": {'',
                ''"label": "'', jd.lab, ''",'',
                ''"categories": ['', jd.cat, ''],'',
                ''"series": ['', jd.series, '']'',
                '',"defaultTitle":"',dtitle,'"'',
                '',"additional":[ ''
                
                ,''{'',
                ''"title":"',title1,'",'',
                ''"data": {'',
                ''"label": "'',json_data_second.lab, ''",'',
                ''"categories": ['', json_data_second.cat, ''],'',
                ''"series": ['', json_data_second.series, '']'',
                ''}}''
                
                , '',''
                
                
                ,''{'',
                ''"title":"',title2,'",'',
                ''"data": {'',
                ''"label": "'',json_data_third.lab, ''",'',
                ''"categories": ['', json_data_third.cat, ''],'',
                ''"series": ['', json_data_third.series, '']'',
                ''}}''
                
                
        '']}}''
    
			) as json_data
		  FROM json_data jd
          
          CROSS join json_data_second
          
          CROSS join json_data_third
          ;
[0m14:37:09.037140 [debug] [MainThread]: Command `dbt compile` succeeded at 14:37:09.036548 after 2.16 seconds
[0m14:37:09.039141 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FD2F8470>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FE427C20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6FE3E3EC0>]}
[0m14:37:09.040138 [debug] [MainThread]: Flushing usage events
[0m11:52:26.284532 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002205ECD17C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002205ECD1910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002205ECD19D0>]}


============================== 11:52:26.291532 | 01d0e43b-c03e-46db-b112-14d4d0015a7d ==============================
[0m11:52:26.291532 [info ] [MainThread]: Running with dbt=1.7.13
[0m11:52:26.293538 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m11:52:26.705529 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '01d0e43b-c03e-46db-b112-14d4d0015a7d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002205EA861E0>]}
[0m11:52:26.844530 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '01d0e43b-c03e-46db-b112-14d4d0015a7d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002205E0CC770>]}
[0m11:52:26.847533 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m11:52:26.875534 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m11:52:27.946532 [debug] [MainThread]: Partial parsing enabled: 1 files deleted, 1 files added, 1 files changed.
[0m11:52:27.946532 [debug] [MainThread]: Partial parsing: added file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m11:52:27.947532 [debug] [MainThread]: Partial parsing: deleted file: dbt_project_test_kasper://models\test2.sql
[0m11:52:27.948537 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_13.sql
[0m11:52:28.268534 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '01d0e43b-c03e-46db-b112-14d4d0015a7d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002205F23AAB0>]}
[0m11:52:28.301534 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '01d0e43b-c03e-46db-b112-14d4d0015a7d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002205F060CB0>]}
[0m11:52:28.302533 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m11:52:28.304557 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '01d0e43b-c03e-46db-b112-14d4d0015a7d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002205F24C8F0>]}
[0m11:52:28.308542 [info ] [MainThread]: 
[0m11:52:28.309533 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m11:52:28.311532 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m11:52:28.331531 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:52:28.332530 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m11:52:28.333534 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:52:28.401530 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m11:52:28.402532 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:52:28.403533 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m11:52:28.436531 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m11:52:28.438533 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m11:52:28.439532 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m11:52:28.446532 [debug] [MainThread]: Using postgres connection "master"
[0m11:52:28.447533 [debug] [MainThread]: On master: BEGIN
[0m11:52:28.448533 [debug] [MainThread]: Opening a new connection, currently in state init
[0m11:52:28.512532 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m11:52:28.513536 [debug] [MainThread]: Using postgres connection "master"
[0m11:52:28.515535 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m11:52:28.532531 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m11:52:28.535531 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '01d0e43b-c03e-46db-b112-14d4d0015a7d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002205EE769C0>]}
[0m11:52:28.537533 [debug] [MainThread]: On master: ROLLBACK
[0m11:52:28.538533 [debug] [MainThread]: On master: Close
[0m11:52:28.540538 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:52:28.542549 [info ] [MainThread]: 
[0m11:52:28.548531 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m11:52:28.549535 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m11:52:28.550533 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m11:52:28.565531 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m11:52:28.568535 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 11:52:28.551532 => 11:52:28.567535
[0m11:52:28.569534 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m11:52:28.571535 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 11:52:28.570536 => 11:52:28.570536
[0m11:52:28.576570 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m11:52:28.579533 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:52:28.580535 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m11:52:28.581537 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m11:52:28.584536 [debug] [MainThread]: Command end result
[0m11:52:28.602534 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:










CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    referrers AS

    ,
    categories AS (
            SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site, 
            UNION ALL SELECT 'Others'
        '), 
    
    referrers_second AS

    ,
    categories AS (
            SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site, 
            UNION ALL SELECT 'Others'
        '), 
    
    referrers_third AS

    ,
    categories AS (
            SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site, 
            UNION ALL SELECT 'Others'
        ')
    
[0m11:52:28.614536 [debug] [MainThread]: Command `dbt compile` succeeded at 11:52:28.614536 after 2.56 seconds
[0m11:52:28.615535 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002205E00F830>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002205ECD17C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002205ECD1910>]}
[0m11:52:28.616534 [debug] [MainThread]: Flushing usage events
[0m15:24:05.528309 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017C80D03260>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017C80D035C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017C80D02F60>]}


============================== 15:24:05.536255 | 944f0768-9ebc-4f46-abd4-306163881715 ==============================
[0m15:24:05.536255 [info ] [MainThread]: Running with dbt=1.7.13
[0m15:24:05.538274 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m15:24:05.857604 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '944f0768-9ebc-4f46-abd4-306163881715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017C80D58BC0>]}
[0m15:24:05.974603 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '944f0768-9ebc-4f46-abd4-306163881715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017C80CE3F80>]}
[0m15:24:05.976604 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m15:24:05.999607 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m15:24:06.589884 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:24:06.591885 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m15:24:06.785887 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '944f0768-9ebc-4f46-abd4-306163881715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017C80F1F890>]}
[0m15:24:06.809915 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '944f0768-9ebc-4f46-abd4-306163881715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017C810B9AC0>]}
[0m15:24:06.810914 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m15:24:06.812919 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '944f0768-9ebc-4f46-abd4-306163881715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017C811DAD80>]}
[0m15:24:06.814919 [info ] [MainThread]: 
[0m15:24:06.816913 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m15:24:06.818912 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m15:24:06.834914 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m15:24:06.835915 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m15:24:06.836914 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:24:06.904913 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m15:24:06.905922 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m15:24:06.905922 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m15:24:06.936402 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m15:24:06.938426 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m15:24:06.940180 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m15:24:06.947194 [debug] [MainThread]: Using postgres connection "master"
[0m15:24:06.948193 [debug] [MainThread]: On master: BEGIN
[0m15:24:06.948193 [debug] [MainThread]: Opening a new connection, currently in state init
[0m15:24:07.005193 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m15:24:07.006198 [debug] [MainThread]: Using postgres connection "master"
[0m15:24:07.007193 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m15:24:07.022191 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m15:24:07.024196 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '944f0768-9ebc-4f46-abd4-306163881715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017C810BBD10>]}
[0m15:24:07.025194 [debug] [MainThread]: On master: ROLLBACK
[0m15:24:07.026205 [debug] [MainThread]: On master: Close
[0m15:24:07.029200 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:24:07.031202 [info ] [MainThread]: 
[0m15:24:07.037196 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m15:24:07.039193 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m15:24:07.040191 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m15:24:07.057194 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m15:24:07.059196 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 15:24:07.041195 => 15:24:07.058193
[0m15:24:07.062195 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m15:24:07.063193 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 15:24:07.062195 => 15:24:07.062195
[0m15:24:07.065193 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m15:24:07.067193 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:24:07.067193 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m15:24:07.068195 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m15:24:07.069194 [debug] [MainThread]: Command end result
[0m15:24:07.080195 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:










CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    referrers AS

    ,
    categories AS (
            SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', diction30, ') and siteid = ', site, 
            UNION ALL SELECT 'Others'
        '), 
    
    referrers_second AS

    ,
    categories AS (
            SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', diction31, ') and siteid = ', site, 
            UNION ALL SELECT 'Others'
        '), 
    
    referrers_third AS

    ,
    categories AS (
            SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', diction32, ') and siteid = ', site, 
            UNION ALL SELECT 'Others'
        ')
    
[0m15:24:07.086198 [debug] [MainThread]: Command `dbt compile` succeeded at 15:24:07.085196 after 1.77 seconds
[0m15:24:07.087195 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017CFA905610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017C80D03260>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017C80D27B00>]}
[0m15:24:07.089195 [debug] [MainThread]: Flushing usage events
[0m15:24:49.712922 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9F1322C00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9F1323CB0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9F1323C20>]}


============================== 15:24:49.718920 | e02b9888-42c4-45ee-964f-3490d679053a ==============================
[0m15:24:49.718920 [info ] [MainThread]: Running with dbt=1.7.13
[0m15:24:49.720928 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m15:24:49.974919 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e02b9888-42c4-45ee-964f-3490d679053a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9F1378650>]}
[0m15:24:50.094953 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e02b9888-42c4-45ee-964f-3490d679053a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9F03CF020>]}
[0m15:24:50.095954 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m15:24:50.109951 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m15:24:50.211955 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:24:50.212976 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m15:24:50.380075 [error] [MainThread]: Encountered an error:
Compilation Error in model pageview_weeks_dummy_2_3__site__13 (models\pageview_weeks_dummy_2_3__site__13.sql)
  expected token 'end of print statement', got '{'
    line 31
      WHERE Categories IN (', {{diction3{{i}}}}, ') and siteid = ', site,
[0m15:24:50.383089 [debug] [MainThread]: Command `dbt compile` failed at 15:24:50.383089 after 0.85 seconds
[0m15:24:50.384103 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9F125DB80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9EAF81C70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9F1303F80>]}
[0m15:24:50.385095 [debug] [MainThread]: Flushing usage events
[0m15:25:33.994611 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012921486A50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000129214878F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000129214861B0>]}


============================== 15:25:33.999609 | fc1d6848-c0ce-4049-8c91-6e8dfdc556ca ==============================
[0m15:25:33.999609 [info ] [MainThread]: Running with dbt=1.7.13
[0m15:25:34.001619 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m15:25:34.259629 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'fc1d6848-c0ce-4049-8c91-6e8dfdc556ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000129211B0BC0>]}
[0m15:25:34.379630 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'fc1d6848-c0ce-4049-8c91-6e8dfdc556ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000129213611C0>]}
[0m15:25:34.381634 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m15:25:34.395631 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m15:25:34.486628 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:25:34.487633 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m15:25:34.687632 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'fc1d6848-c0ce-4049-8c91-6e8dfdc556ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000129219BE210>]}
[0m15:25:34.702644 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'fc1d6848-c0ce-4049-8c91-6e8dfdc556ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001292177FF20>]}
[0m15:25:34.703635 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m15:25:34.705636 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fc1d6848-c0ce-4049-8c91-6e8dfdc556ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012921392300>]}
[0m15:25:34.710634 [info ] [MainThread]: 
[0m15:25:34.711631 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m15:25:34.713628 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m15:25:34.730631 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m15:25:34.730631 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m15:25:34.731632 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:25:34.792629 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m15:25:34.793631 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m15:25:34.794630 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m15:25:34.805631 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m15:25:34.806632 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m15:25:34.807630 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m15:25:34.814628 [debug] [MainThread]: Using postgres connection "master"
[0m15:25:34.815630 [debug] [MainThread]: On master: BEGIN
[0m15:25:34.816632 [debug] [MainThread]: Opening a new connection, currently in state init
[0m15:25:34.869633 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m15:25:34.870638 [debug] [MainThread]: Using postgres connection "master"
[0m15:25:34.872633 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m15:25:34.906633 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m15:25:34.910633 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fc1d6848-c0ce-4049-8c91-6e8dfdc556ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000129219F7C50>]}
[0m15:25:34.912638 [debug] [MainThread]: On master: ROLLBACK
[0m15:25:34.913640 [debug] [MainThread]: On master: Close
[0m15:25:34.916637 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:25:34.918650 [info ] [MainThread]: 
[0m15:25:34.980631 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m15:25:34.981632 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m15:25:34.982636 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m15:25:35.012632 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m15:25:35.015633 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 15:25:34.983634 => 15:25:35.014631
[0m15:25:35.016632 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m15:25:35.017635 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 15:25:35.016632 => 15:25:35.016632
[0m15:25:35.019636 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m15:25:35.021630 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:25:35.021630 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m15:25:35.022628 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m15:25:35.024631 [debug] [MainThread]: Command end result
[0m15:25:35.040632 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:










CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    referrers AS

    ,
    categories AS (
            SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site, 
            UNION ALL SELECT 'Others'
        '), 
    
    referrers_second AS

    ,
    categories AS (
            SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site, 
            UNION ALL SELECT 'Others'
        '), 
    
    referrers_third AS

    ,
    categories AS (
            SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site, 
            UNION ALL SELECT 'Others'
        ')
    
[0m15:25:35.045631 [debug] [MainThread]: Command `dbt compile` succeeded at 15:25:35.044635 after 1.19 seconds
[0m15:25:35.046632 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001291AF45610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000129214AF920>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012921935490>]}
[0m15:25:35.047635 [debug] [MainThread]: Flushing usage events
[0m15:34:57.165119 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB209F7F20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB209F6AB0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB209F7110>]}


============================== 15:34:57.170117 | cc0a343d-5d68-4d74-8a3d-b8bb5e2e3a0d ==============================
[0m15:34:57.170117 [info ] [MainThread]: Running with dbt=1.7.13
[0m15:34:57.172129 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m15:34:57.427115 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'cc0a343d-5d68-4d74-8a3d-b8bb5e2e3a0d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB20A9B290>]}
[0m15:34:57.544116 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'cc0a343d-5d68-4d74-8a3d-b8bb5e2e3a0d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB2083D8B0>]}
[0m15:34:57.546120 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m15:34:57.561117 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m15:34:57.669117 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:34:57.670120 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m15:34:57.866117 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'cc0a343d-5d68-4d74-8a3d-b8bb5e2e3a0d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB20D3BD40>]}
[0m15:34:57.881120 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'cc0a343d-5d68-4d74-8a3d-b8bb5e2e3a0d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB20DAD850>]}
[0m15:34:57.882119 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m15:34:57.884129 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cc0a343d-5d68-4d74-8a3d-b8bb5e2e3a0d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB20A14200>]}
[0m15:34:57.886120 [info ] [MainThread]: 
[0m15:34:57.888120 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m15:34:57.890124 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m15:34:57.907135 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m15:34:57.908132 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m15:34:57.909143 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:34:57.967120 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m15:34:57.968122 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m15:34:57.969123 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m15:34:57.979119 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m15:34:57.981123 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m15:34:57.982124 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m15:34:57.988118 [debug] [MainThread]: Using postgres connection "master"
[0m15:34:57.990120 [debug] [MainThread]: On master: BEGIN
[0m15:34:57.990120 [debug] [MainThread]: Opening a new connection, currently in state init
[0m15:34:58.038142 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m15:34:58.039119 [debug] [MainThread]: Using postgres connection "master"
[0m15:34:58.040119 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m15:34:58.049116 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m15:34:58.052122 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cc0a343d-5d68-4d74-8a3d-b8bb5e2e3a0d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB20A49D60>]}
[0m15:34:58.053119 [debug] [MainThread]: On master: ROLLBACK
[0m15:34:58.055119 [debug] [MainThread]: On master: Close
[0m15:34:58.057122 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:34:58.059125 [info ] [MainThread]: 
[0m15:34:58.063120 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m15:34:58.065120 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m15:34:58.065120 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m15:34:58.082117 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m15:34:58.084122 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 15:34:58.066118 => 15:34:58.083119
[0m15:34:58.085121 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m15:34:58.086121 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 15:34:58.086121 => 15:34:58.086121
[0m15:34:58.088120 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m15:34:58.090132 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:34:58.091121 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m15:34:58.092129 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m15:34:58.093119 [debug] [MainThread]: Command end result
[0m15:34:58.103120 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:










CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    referrers AS

    ,
    categories AS (
            SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site, 
            UNION ALL SELECT 'Others'
        ')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        )
        ,
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,, 
    
    referrers_second AS

    ,
    categories_second AS (
            SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site, 
            UNION ALL SELECT 'Others'
        ')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        )
        ,
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,, 
    
    referrers_third AS

    ,
    categories_third AS (
            SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site, 
            UNION ALL SELECT 'Others'
        ')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        )
        ,
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
    
[0m15:34:58.119153 [debug] [MainThread]: Command `dbt compile` succeeded at 15:34:58.118153 after 1.15 seconds
[0m15:34:58.120141 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB20A17B60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB2071CA70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB208869F0>]}
[0m15:34:58.122147 [debug] [MainThread]: Flushing usage events
[0m16:51:41.905982 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F6AECB2D80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F6AECB3AA0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F6AECB2B10>]}


============================== 16:51:41.911981 | 4a4a0c4f-7da4-4203-a8f1-22b6d91cc89f ==============================
[0m16:51:41.911981 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:51:41.913988 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'send_anonymous_usage_stats': 'True'}
[0m16:51:42.173982 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4a4a0c4f-7da4-4203-a8f1-22b6d91cc89f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F6AED78410>]}
[0m16:51:42.292983 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4a4a0c4f-7da4-4203-a8f1-22b6d91cc89f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F6AED08560>]}
[0m16:51:42.295015 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:51:42.308981 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:51:42.423005 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:51:42.424008 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m16:51:42.623005 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4a4a0c4f-7da4-4203-a8f1-22b6d91cc89f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F6AF1EEC60>]}
[0m16:51:42.638012 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4a4a0c4f-7da4-4203-a8f1-22b6d91cc89f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F6AF059B20>]}
[0m16:51:42.639011 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m16:51:42.641016 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4a4a0c4f-7da4-4203-a8f1-22b6d91cc89f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F6AF12E390>]}
[0m16:51:42.645018 [info ] [MainThread]: 
[0m16:51:42.647009 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m16:51:42.649006 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m16:51:42.666005 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:51:42.667006 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m16:51:42.668008 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:51:42.724006 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m16:51:42.725007 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:51:42.726006 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m16:51:42.748006 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m16:51:42.750004 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m16:51:42.751008 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m16:51:42.759007 [debug] [MainThread]: Using postgres connection "master"
[0m16:51:42.760008 [debug] [MainThread]: On master: BEGIN
[0m16:51:42.761008 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:51:42.915825 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:51:42.916840 [debug] [MainThread]: Using postgres connection "master"
[0m16:51:42.918821 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m16:51:42.935822 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m16:51:42.939824 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4a4a0c4f-7da4-4203-a8f1-22b6d91cc89f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F6AF05BBF0>]}
[0m16:51:42.940820 [debug] [MainThread]: On master: ROLLBACK
[0m16:51:42.941820 [debug] [MainThread]: On master: Close
[0m16:51:42.943822 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:51:42.945829 [info ] [MainThread]: 
[0m16:51:42.958821 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m16:51:42.961830 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m16:51:42.963825 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m16:51:43.003821 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m16:51:43.006823 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 16:51:42.964824 => 16:51:43.005820
[0m16:51:43.008824 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m16:51:43.009824 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 16:51:43.008824 => 16:51:43.008824
[0m16:51:43.011823 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m16:51:43.013820 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:51:43.014822 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m16:51:43.015820 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m16:51:43.017831 [debug] [MainThread]: Command end result
[0m16:51:43.033821 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:










CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    referrers AS

    ,
    categories AS (
            SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site, 
            UNION ALL SELECT 'Others'
        ')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        )
        ,
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        )
        ,
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        ,
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        )
        ,
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        )
        ,
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		)
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third, 
    
    referrers_second AS

    ,
    categories_second AS (
            SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site, 
            UNION ALL SELECT 'Others'
        ')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        )
        ,
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_second, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        )
        ,
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        ,
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        )
        ,
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        )
        ,
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		)
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third, 
    
    referrers_third AS

    ,
    categories_third AS (
            SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site, 
            UNION ALL SELECT 'Others'
        ')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        )
        ,
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_third, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        )
        ,
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        ,
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        )
        ,
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        )
        ,
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third
    
[0m16:51:43.049820 [debug] [MainThread]: Command `dbt compile` succeeded at 16:51:43.049820 after 1.34 seconds
[0m16:51:43.051819 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F6AECDBB60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F6AEFA6030>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F6A8685460>]}
[0m16:51:43.052825 [debug] [MainThread]: Flushing usage events
[0m17:15:39.207705 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A7A4A70AD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A7A4A71790>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A7A4A71670>]}


============================== 17:15:39.214703 | 0e5980fa-33a4-47cb-9c76-3244abb5e227 ==============================
[0m17:15:39.214703 [info ] [MainThread]: Running with dbt=1.7.13
[0m17:15:39.216712 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:15:39.473701 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0e5980fa-33a4-47cb-9c76-3244abb5e227', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A7A4BD5730>]}
[0m17:15:39.599706 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0e5980fa-33a4-47cb-9c76-3244abb5e227', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A7A4AC8560>]}
[0m17:15:39.602708 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m17:15:39.622706 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m17:15:39.743223 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:15:39.744224 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m17:15:39.910223 [error] [MainThread]: Encountered an error:
Compilation Error in model pageview_weeks_dummy_2_3__site__13 (models\pageview_weeks_dummy_2_3__site__13.sql)
  Encountered unknown tag 'end'. Jinja was looking for the following tags: 'elif' or 'else' or 'endif'. The innermost block that needs to be closed is 'if'.
    line 81
      {%end if%}
[0m17:15:39.913230 [debug] [MainThread]: Command `dbt compile` failed at 17:15:39.912241 after 0.96 seconds
[0m17:15:39.914224 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A79E4C5610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A7A4C6DD30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A7A4F9E870>]}
[0m17:15:39.914224 [debug] [MainThread]: Flushing usage events
[0m17:16:50.862686 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002466FC03230>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002466FC03CE0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002466FC03710>]}


============================== 17:16:50.868686 | 3429d608-d661-4f4c-8c34-910ecfb43d70 ==============================
[0m17:16:50.868686 [info ] [MainThread]: Running with dbt=1.7.13
[0m17:16:50.870694 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m17:16:51.121684 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3429d608-d661-4f4c-8c34-910ecfb43d70', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002466FCAB290>]}
[0m17:16:51.238688 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3429d608-d661-4f4c-8c34-910ecfb43d70', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002466FC58440>]}
[0m17:16:51.240694 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m17:16:51.253685 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m17:16:51.345683 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:16:51.346685 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m17:16:51.508688 [error] [MainThread]: Encountered an error:
Compilation Error in model pageview_weeks_dummy_2_3__site__13 (models\pageview_weeks_dummy_2_3__site__13.sql)
  Encountered unknown tag 'end'. Jinja was looking for the following tags: 'elif' or 'else' or 'endif'. The innermost block that needs to be closed is 'if'.
    line 81
      {% end if %}
[0m17:16:51.510690 [debug] [MainThread]: Command `dbt compile` failed at 17:16:51.510690 after 0.79 seconds
[0m17:16:51.511686 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002466F9E9490>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002466FFB4B30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002467012F620>]}
[0m17:16:51.512688 [debug] [MainThread]: Flushing usage events
[0m17:17:18.205355 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002545FC06C30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002545FC06B70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002545FC065A0>]}


============================== 17:17:18.211355 | a442d553-4412-44af-8c73-75acc7bf7a56 ==============================
[0m17:17:18.211355 [info ] [MainThread]: Running with dbt=1.7.13
[0m17:17:18.213376 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:17:18.462358 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a442d553-4412-44af-8c73-75acc7bf7a56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002545F930BC0>]}
[0m17:17:18.582354 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a442d553-4412-44af-8c73-75acc7bf7a56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002545FC26420>]}
[0m17:17:18.583357 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m17:17:18.598355 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m17:17:18.690357 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:17:18.691358 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m17:17:18.905387 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a442d553-4412-44af-8c73-75acc7bf7a56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002545F7CD9A0>]}
[0m17:17:18.920391 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a442d553-4412-44af-8c73-75acc7bf7a56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002545FFA9610>]}
[0m17:17:18.922391 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m17:17:18.923396 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a442d553-4412-44af-8c73-75acc7bf7a56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002545FC58860>]}
[0m17:17:18.926388 [info ] [MainThread]: 
[0m17:17:18.928402 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m17:17:18.930390 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m17:17:18.947413 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:17:18.948389 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m17:17:18.949388 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:17:19.006388 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m17:17:19.007393 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:17:19.007393 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m17:17:19.016389 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m17:17:19.018388 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m17:17:19.019387 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m17:17:19.028387 [debug] [MainThread]: Using postgres connection "master"
[0m17:17:19.029388 [debug] [MainThread]: On master: BEGIN
[0m17:17:19.029388 [debug] [MainThread]: Opening a new connection, currently in state init
[0m17:17:19.080388 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m17:17:19.081394 [debug] [MainThread]: Using postgres connection "master"
[0m17:17:19.081394 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m17:17:19.091386 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m17:17:19.093388 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a442d553-4412-44af-8c73-75acc7bf7a56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002545FF583E0>]}
[0m17:17:19.094389 [debug] [MainThread]: On master: ROLLBACK
[0m17:17:19.096389 [debug] [MainThread]: On master: Close
[0m17:17:19.098391 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:17:19.099397 [info ] [MainThread]: 
[0m17:17:19.104794 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m17:17:19.106796 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m17:17:19.106796 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m17:17:19.127815 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m17:17:19.130830 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 17:17:19.107794 => 17:17:19.128805
[0m17:17:19.131796 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m17:17:19.133795 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 17:17:19.132796 => 17:17:19.132796
[0m17:17:19.135797 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m17:17:19.136796 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:17:19.137794 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m17:17:19.138796 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m17:17:19.139795 [debug] [MainThread]: Command end result
[0m17:17:19.151794 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:










CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    referrers AS

    ,
    categories AS (
            SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site, 
            UNION ALL SELECT 'Others'
        ')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        )
        ,
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        )
        ,
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        
        ,
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        )
        ,
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        )
        ,
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		)
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third, 
    
    referrers_second AS

    ,
    categories_second AS (
            SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site, 
            UNION ALL SELECT 'Others'
        ')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        )
        ,
        
        ,
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        )
        ,
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        )
        ,
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		)
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third, 
    
    referrers_third AS

    ,
    categories_third AS (
            SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site, 
            UNION ALL SELECT 'Others'
        ')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        )
        ,
        
        ,
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        )
        ,
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        )
        ,
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third
    
[0m17:17:19.163799 [debug] [MainThread]: Command `dbt compile` succeeded at 17:17:19.163799 after 1.09 seconds
[0m17:17:19.165797 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002545F8D4BF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002545FA94A70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002545FA956A0>]}
[0m17:17:19.167796 [debug] [MainThread]: Flushing usage events
[0m17:20:55.869035 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2BA3A6CF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2BA2B0B90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2BA3A74D0>]}


============================== 17:20:55.874034 | 35574c7a-93bd-40b3-bfff-7bbcc3aa47d0 ==============================
[0m17:20:55.874034 [info ] [MainThread]: Running with dbt=1.7.13
[0m17:20:55.876040 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'send_anonymous_usage_stats': 'True'}
[0m17:20:56.131037 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '35574c7a-93bd-40b3-bfff-7bbcc3aa47d0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2BA3A5CD0>]}
[0m17:20:56.247035 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '35574c7a-93bd-40b3-bfff-7bbcc3aa47d0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2BA2358B0>]}
[0m17:20:56.249036 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m17:20:56.262034 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m17:20:56.368036 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:20:56.370039 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m17:20:56.588081 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '35574c7a-93bd-40b3-bfff-7bbcc3aa47d0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2BA91EC90>]}
[0m17:20:56.603076 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '35574c7a-93bd-40b3-bfff-7bbcc3aa47d0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2BA789490>]}
[0m17:20:56.604075 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m17:20:56.606084 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '35574c7a-93bd-40b3-bfff-7bbcc3aa47d0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2BA3F8E30>]}
[0m17:20:56.608071 [info ] [MainThread]: 
[0m17:20:56.610073 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m17:20:56.612071 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m17:20:56.628072 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:20:56.629072 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m17:20:56.630079 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:20:56.688075 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m17:20:56.688075 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:20:56.689075 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m17:20:56.698071 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m17:20:56.700071 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m17:20:56.701076 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m17:20:56.708072 [debug] [MainThread]: Using postgres connection "master"
[0m17:20:56.708072 [debug] [MainThread]: On master: BEGIN
[0m17:20:56.709073 [debug] [MainThread]: Opening a new connection, currently in state init
[0m17:20:56.757070 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m17:20:56.758075 [debug] [MainThread]: Using postgres connection "master"
[0m17:20:56.758075 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m17:20:56.768069 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m17:20:56.770073 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '35574c7a-93bd-40b3-bfff-7bbcc3aa47d0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2BA78B5C0>]}
[0m17:20:56.771079 [debug] [MainThread]: On master: ROLLBACK
[0m17:20:56.772072 [debug] [MainThread]: On master: Close
[0m17:20:56.773072 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:20:56.775077 [info ] [MainThread]: 
[0m17:20:56.780071 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m17:20:56.782077 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m17:20:56.783084 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m17:20:56.805073 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m17:20:56.807077 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 17:20:56.784074 => 17:20:56.807077
[0m17:20:56.808075 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m17:20:56.809074 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 17:20:56.809074 => 17:20:56.809074
[0m17:20:56.811074 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m17:20:56.813073 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:20:56.815099 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m17:20:56.816073 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m17:20:56.817073 [debug] [MainThread]: Command end result
[0m17:20:56.827074 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:










CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    referrers AS

    ,
    categories AS (
            SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site, 
            UNION ALL SELECT 'Others'
        ')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        )
        ,
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        )
        ,
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        

        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        )
        ,
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        )
        ,
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		)
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third, 
    
    referrers_second AS

    ,
    categories_second AS (
            SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site, 
            UNION ALL SELECT 'Others'
        ')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        )
        ,
        

        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        )
        ,
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        )
        ,
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		)
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third, 
    
    referrers_third AS

    ,
    categories_third AS (
            SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site, 
            UNION ALL SELECT 'Others'
        ')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        )
        ,
        

        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        )
        ,
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        )
        ,
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third
    
[0m17:20:56.847096 [debug] [MainThread]: Command `dbt compile` succeeded at 17:20:56.847096 after 1.18 seconds
[0m17:20:56.849093 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2BA3A74D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2BA3A6CF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2BA159DC0>]}
[0m17:20:56.850096 [debug] [MainThread]: Flushing usage events
[0m18:01:01.022823 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017729C71340>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017729C70230>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017729C714C0>]}


============================== 18:01:01.029826 | b5894dea-cbb1-4d0d-884b-b2ba340005f3 ==============================
[0m18:01:01.029826 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:01:01.031826 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m18:01:01.317821 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'b5894dea-cbb1-4d0d-884b-b2ba340005f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017728EAD160>]}
[0m18:01:01.452820 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'b5894dea-cbb1-4d0d-884b-b2ba340005f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017729C947A0>]}
[0m18:01:01.454827 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:01:01.470822 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:01:01.579824 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:01:01.581826 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m18:01:01.807821 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'b5894dea-cbb1-4d0d-884b-b2ba340005f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001772A1AE7B0>]}
[0m18:01:01.822823 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'b5894dea-cbb1-4d0d-884b-b2ba340005f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001772A019A60>]}
[0m18:01:01.823832 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m18:01:01.824826 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b5894dea-cbb1-4d0d-884b-b2ba340005f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017729EB1B80>]}
[0m18:01:01.828828 [info ] [MainThread]: 
[0m18:01:01.831823 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:01:01.833821 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:01:01.854820 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:01:01.855822 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:01:01.856822 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:01:01.920821 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:01:01.921826 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:01:01.921826 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:01:01.933824 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:01:01.936821 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:01:01.937820 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:01:01.944824 [debug] [MainThread]: Using postgres connection "master"
[0m18:01:01.946822 [debug] [MainThread]: On master: BEGIN
[0m18:01:01.947822 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:01:02.001826 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:01:02.002825 [debug] [MainThread]: Using postgres connection "master"
[0m18:01:02.004826 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:01:02.020823 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:01:02.022825 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b5894dea-cbb1-4d0d-884b-b2ba340005f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001772A019640>]}
[0m18:01:02.023823 [debug] [MainThread]: On master: ROLLBACK
[0m18:01:02.024823 [debug] [MainThread]: On master: Close
[0m18:01:02.026825 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:01:02.028827 [info ] [MainThread]: 
[0m18:01:02.037825 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:01:02.039821 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m18:01:02.041825 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:01:02.071820 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m18:01:02.073822 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 18:01:02.042830 => 18:01:02.072823
[0m18:01:02.074822 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:01:02.075820 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 18:01:02.075820 => 18:01:02.075820
[0m18:01:02.079822 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:01:02.081821 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:01:02.081821 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:01:02.082820 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m18:01:02.083822 [debug] [MainThread]: Command end result
[0m18:01:02.095822 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ','SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site','
        UNION ALL SELECT ''Others''
    )
    
    
    ,
    categories AS (
            categories AS (
            ','SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site', '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        )
        ,
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        )
        ,
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        

        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        )
        ,
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        )
        ,
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		)
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third, 
    
    
    ,
    categories_second AS (
            categories AS (
            ',    SET @categories_sql_first = CONCAT(
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', {{diction[i]}}, ') and siteid = ', site
    , '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        )
        ,
        

        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        )
        ,
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        )
        ,
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		)
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third, 
    
    
    ,
    categories_third AS (
            categories AS (
            ',Tags, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        )
        ,
        

        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        )
        ,
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        )
        ,
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third
    
[0m18:01:02.111825 [debug] [MainThread]: Command `dbt compile` succeeded at 18:01:02.110828 after 1.30 seconds
[0m18:01:02.112851 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017729C53EC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017723595460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001772A15D4C0>]}
[0m18:01:02.115822 [debug] [MainThread]: Flushing usage events
[0m18:03:37.432241 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002748ED97440>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002748ED97980>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002748ED94D70>]}


============================== 18:03:37.437236 | 66b2c726-3348-433f-bef4-c76f13965887 ==============================
[0m18:03:37.437236 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:03:37.439244 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:03:37.701235 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '66b2c726-3348-433f-bef4-c76f13965887', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002748EDE8BC0>]}
[0m18:03:37.820239 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '66b2c726-3348-433f-bef4-c76f13965887', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002748DE3F2C0>]}
[0m18:03:37.822244 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:03:37.839246 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:03:37.943234 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:03:37.944238 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m18:03:38.144235 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '66b2c726-3348-433f-bef4-c76f13965887', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002748F3DA420>]}
[0m18:03:38.158239 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '66b2c726-3348-433f-bef4-c76f13965887', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002748F1C9400>]}
[0m18:03:38.159239 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m18:03:38.161254 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '66b2c726-3348-433f-bef4-c76f13965887', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002748F29EAB0>]}
[0m18:03:38.163241 [info ] [MainThread]: 
[0m18:03:38.165236 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:03:38.167236 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:03:38.184235 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:03:38.185237 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:03:38.186237 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:03:38.246268 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:03:38.247241 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:03:38.247241 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:03:38.259240 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:03:38.261241 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:03:38.263239 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:03:38.273239 [debug] [MainThread]: Using postgres connection "master"
[0m18:03:38.274237 [debug] [MainThread]: On master: BEGIN
[0m18:03:38.275238 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:03:38.437680 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:03:38.438688 [debug] [MainThread]: Using postgres connection "master"
[0m18:03:38.438688 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:03:38.448680 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:03:38.450680 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '66b2c726-3348-433f-bef4-c76f13965887', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002748F1CB3B0>]}
[0m18:03:38.451682 [debug] [MainThread]: On master: ROLLBACK
[0m18:03:38.452680 [debug] [MainThread]: On master: Close
[0m18:03:38.453687 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:03:38.455689 [info ] [MainThread]: 
[0m18:03:38.461681 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:03:38.462696 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m18:03:38.463683 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:03:38.483680 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m18:03:38.484679 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 18:03:38.463683 => 18:03:38.484679
[0m18:03:38.485704 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:03:38.486683 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 18:03:38.486683 => 18:03:38.486683
[0m18:03:38.488683 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:03:38.490680 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:03:38.492683 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:03:38.492683 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m18:03:38.494681 [debug] [MainThread]: Command end result
[0m18:03:38.505681 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ','SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site','
        UNION ALL SELECT ''Others''
    )
    
    
    ,
    categories AS (
            categories AS (
            ',    SET @categories_sql_first = CONCAT(
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', {{diction[i]}}, ') and siteid = ', site
    , '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        )
        ,
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        )
        ,
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        

        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        )
        ,
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        )
        ,
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		)
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third, 
    
    
    ,
    categories_second AS (
            categories AS (
            ',    SET @categories_sql_first = CONCAT(
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', {{diction[i]}}, ') and siteid = ', site
    , '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        )
        ,
        

        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        )
        ,
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        )
        ,
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		)
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third, 
    
    
    ,
    categories_third AS (
            categories AS (
            ',    SET @categories_sql_first = CONCAT(
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', {{diction[i]}}, ') and siteid = ', site
    , '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        )
        ,
        

        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        )
        ,
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        )
        ,
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third
    
[0m18:03:38.521679 [debug] [MainThread]: Command `dbt compile` succeeded at 18:03:38.521679 after 1.30 seconds
[0m18:03:38.523687 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002748ECA3230>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002748ECA1190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002748ECA2300>]}
[0m18:03:38.524682 [debug] [MainThread]: Flushing usage events
[0m18:07:36.103480 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000271CE721400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000271CE720110>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000271CE721340>]}


============================== 18:07:36.110483 | 8b1864df-568f-4e24-a07f-952b81551c0e ==============================
[0m18:07:36.110483 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:07:36.112489 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m18:07:36.401478 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '8b1864df-568f-4e24-a07f-952b81551c0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000271CE720320>]}
[0m18:07:36.533481 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '8b1864df-568f-4e24-a07f-952b81551c0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000271CE778E30>]}
[0m18:07:36.535479 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:07:36.551479 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:07:36.667482 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:07:36.668484 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m18:07:36.893482 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '8b1864df-568f-4e24-a07f-952b81551c0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000271CED75EE0>]}
[0m18:07:36.906485 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '8b1864df-568f-4e24-a07f-952b81551c0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000271CEACBFE0>]}
[0m18:07:36.908484 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m18:07:36.910488 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8b1864df-568f-4e24-a07f-952b81551c0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000271CED0E840>]}
[0m18:07:36.913481 [info ] [MainThread]: 
[0m18:07:36.914482 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:07:36.916483 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:07:36.935481 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:07:36.936480 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:07:36.936480 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:07:36.997485 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:07:36.998483 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:07:36.999482 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:07:37.009481 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:07:37.011483 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:07:37.012480 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:07:37.021482 [debug] [MainThread]: Using postgres connection "master"
[0m18:07:37.022483 [debug] [MainThread]: On master: BEGIN
[0m18:07:37.023481 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:07:37.076480 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:07:37.077483 [debug] [MainThread]: Using postgres connection "master"
[0m18:07:37.078483 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:07:37.096483 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:07:37.099482 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8b1864df-568f-4e24-a07f-952b81551c0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000271CEACAD20>]}
[0m18:07:37.101483 [debug] [MainThread]: On master: ROLLBACK
[0m18:07:37.101483 [debug] [MainThread]: On master: Close
[0m18:07:37.103481 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:07:37.105539 [info ] [MainThread]: 
[0m18:07:37.113480 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:07:37.114482 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m18:07:37.115482 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:07:37.140484 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m18:07:37.145481 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 18:07:37.115482 => 18:07:37.144489
[0m18:07:37.147486 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:07:37.148485 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 18:07:37.148485 => 18:07:37.148485
[0m18:07:37.151482 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:07:37.152479 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:07:37.153482 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:07:37.154480 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m18:07:37.155484 [debug] [MainThread]: Command end result
[0m18:07:37.169481 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ','SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site','
        UNION ALL SELECT ''Others''
    )
    
    
    ,
    categories AS (
            categories AS (
            ',    SET @categories_sql_first = CONCAT(
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site
    , '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        )
        ,
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        )
        ,
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        

        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        )
        ,
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        )
        ,
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		)
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third, 
    
    
    ,
    categories_second AS (
            categories AS (
            ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        )
        ,
        

        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        )
        ,
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        )
        ,
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		)
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third, 
    
    
    ,
    categories_third AS (
            categories AS (
            ',SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        )
        ,
        

        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        )
        ,
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        )
        ,
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third
    
[0m18:07:37.183483 [debug] [MainThread]: Command `dbt compile` succeeded at 18:07:37.183483 after 1.30 seconds
[0m18:07:37.184486 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000271CDC47830>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000271CE721340>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000271CE721460>]}
[0m18:07:37.186489 [debug] [MainThread]: Flushing usage events
[0m18:08:34.742800 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C6903F2A80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C6903F37A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C6903F3EF0>]}


============================== 18:08:34.748789 | d5b1a51f-05d9-4892-87f0-34a1e3cbfe81 ==============================
[0m18:08:34.748789 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:08:34.750793 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m18:08:35.033789 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd5b1a51f-05d9-4892-87f0-34a1e3cbfe81', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C6903D3DA0>]}
[0m18:08:35.168792 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd5b1a51f-05d9-4892-87f0-34a1e3cbfe81', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C68FFF2F30>]}
[0m18:08:35.171790 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:08:35.184793 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:08:35.297932 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:08:35.298935 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m18:08:35.520935 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd5b1a51f-05d9-4892-87f0-34a1e3cbfe81', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C69092E2D0>]}
[0m18:08:35.537937 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd5b1a51f-05d9-4892-87f0-34a1e3cbfe81', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C690799A60>]}
[0m18:08:35.538937 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m18:08:35.540941 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd5b1a51f-05d9-4892-87f0-34a1e3cbfe81', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C6906667B0>]}
[0m18:08:35.542934 [info ] [MainThread]: 
[0m18:08:35.544935 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:08:35.546937 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:08:35.564935 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:08:35.565942 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:08:35.568998 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:08:35.633940 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:08:35.635938 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:08:35.636936 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:08:35.644934 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:08:35.646936 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:08:35.647934 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:08:35.658933 [debug] [MainThread]: Using postgres connection "master"
[0m18:08:35.659936 [debug] [MainThread]: On master: BEGIN
[0m18:08:35.659936 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:08:35.719938 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:08:35.721944 [debug] [MainThread]: Using postgres connection "master"
[0m18:08:35.723938 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:08:35.737935 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:08:35.739936 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd5b1a51f-05d9-4892-87f0-34a1e3cbfe81', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C69079BB30>]}
[0m18:08:35.740938 [debug] [MainThread]: On master: ROLLBACK
[0m18:08:35.741937 [debug] [MainThread]: On master: Close
[0m18:08:35.743935 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:08:35.745946 [info ] [MainThread]: 
[0m18:08:35.754938 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:08:35.756942 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m18:08:35.757936 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:08:35.791939 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m18:08:35.793935 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 18:08:35.757936 => 18:08:35.792935
[0m18:08:35.794947 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:08:35.796937 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 18:08:35.795938 => 18:08:35.795938
[0m18:08:35.798934 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:08:35.800937 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:08:35.801940 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:08:35.802935 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m18:08:35.804935 [debug] [MainThread]: Command end result
[0m18:08:35.814937 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ','SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site','
        UNION ALL SELECT ''Others''
    )
    
    
    ,
    categories AS (
            categories AS (
            ',    SET @categories_sql_first = CONCAT(
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site
    , '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        )
        ,
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        )
        ,
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        

        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        )
        ,
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        )
        ,
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    
    ,
    categories_second AS (
            categories AS (
            ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        )
        ,
        

        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        )
        ,
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        )
        ,
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		), 
    
    
    ,
    categories_third AS (
            categories AS (
            ',SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        )
        ,
        

        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        )
        ,
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        )
        ,
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
    
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third
[0m18:08:35.836938 [debug] [MainThread]: Command `dbt compile` succeeded at 18:08:35.835940 after 1.24 seconds
[0m18:08:35.837943 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C6902AACC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C69098FA10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C690938AA0>]}
[0m18:08:35.839935 [debug] [MainThread]: Flushing usage events
[0m18:25:59.536158 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024547B33050>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024547B33500>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024547B30BC0>]}


============================== 18:25:59.542158 | 79767c7e-f36f-4c27-811f-cdd4aff0b0de ==============================
[0m18:25:59.542158 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:25:59.544174 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:25:59.796157 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '79767c7e-f36f-4c27-811f-cdd4aff0b0de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024547DC9A60>]}
[0m18:25:59.914157 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '79767c7e-f36f-4c27-811f-cdd4aff0b0de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024547B5A720>]}
[0m18:25:59.916158 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:25:59.929158 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:26:00.046159 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:26:00.047159 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m18:26:00.263167 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '79767c7e-f36f-4c27-811f-cdd4aff0b0de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002454803E390>]}
[0m18:26:00.288164 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '79767c7e-f36f-4c27-811f-cdd4aff0b0de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024547F0E180>]}
[0m18:26:00.290178 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m18:26:00.292177 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '79767c7e-f36f-4c27-811f-cdd4aff0b0de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024547E022D0>]}
[0m18:26:00.295159 [info ] [MainThread]: 
[0m18:26:00.298167 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:26:00.301160 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:26:00.317158 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:26:00.319160 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:26:00.319160 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:26:00.375158 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:26:00.376161 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:26:00.377159 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:26:00.385160 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:26:00.388159 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:26:00.389159 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:26:00.396157 [debug] [MainThread]: Using postgres connection "master"
[0m18:26:00.396157 [debug] [MainThread]: On master: BEGIN
[0m18:26:00.397168 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:26:00.446160 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:26:00.447161 [debug] [MainThread]: Using postgres connection "master"
[0m18:26:00.448161 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:26:00.457158 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:26:00.459158 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '79767c7e-f36f-4c27-811f-cdd4aff0b0de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024547F64BC0>]}
[0m18:26:00.460159 [debug] [MainThread]: On master: ROLLBACK
[0m18:26:00.461160 [debug] [MainThread]: On master: Close
[0m18:26:00.463163 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:26:00.464161 [info ] [MainThread]: 
[0m18:26:00.469159 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:26:00.470158 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m18:26:00.471157 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:26:00.491159 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m18:26:00.493161 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 18:26:00.472160 => 18:26:00.493161
[0m18:26:00.495160 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:26:00.496163 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 18:26:00.496163 => 18:26:00.496163
[0m18:26:00.498175 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:26:00.501159 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:26:00.502158 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:26:00.503160 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m18:26:00.504159 [debug] [MainThread]: Command end result
[0m18:26:00.516160 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site',
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
            categories AS (
                SET @categories_sql_first = CONCAT(
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site
    , 
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        )
        ,
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        )
        ,
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        

        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        )
        ,
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    ,
    categories_second AS (
            categories AS (
            'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site, 
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        )
        ,
        

        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        )
        ,
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		), 
    
    ,
    categories_third AS (
            categories AS (
            SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site, 
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        )
        ,
        

        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        )
        ,
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
    
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third
[0m18:26:00.538917 [debug] [MainThread]: Command `dbt compile` succeeded at 18:26:00.538917 after 1.20 seconds
[0m18:26:00.539936 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002454797C5C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024547A8CB60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024547B89BE0>]}
[0m18:26:00.541909 [debug] [MainThread]: Flushing usage events
[0m18:43:54.698455 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015022E13DA0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015022E13D40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015022E12BA0>]}


============================== 18:43:54.704455 | 8fc1c6d0-a98c-4897-bda2-f3bb3fafccbc ==============================
[0m18:43:54.704455 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:43:54.706462 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m18:43:54.965452 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '8fc1c6d0-a98c-4897-bda2-f3bb3fafccbc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015022EF5A30>]}
[0m18:43:55.085453 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '8fc1c6d0-a98c-4897-bda2-f3bb3fafccbc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015022BAD1F0>]}
[0m18:43:55.087455 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:43:55.100454 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:43:55.202453 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:43:55.203456 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m18:43:55.407454 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '8fc1c6d0-a98c-4897-bda2-f3bb3fafccbc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000150233874D0>]}
[0m18:43:55.422457 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '8fc1c6d0-a98c-4897-bda2-f3bb3fafccbc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000150231B65D0>]}
[0m18:43:55.423461 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m18:43:55.425459 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8fc1c6d0-a98c-4897-bda2-f3bb3fafccbc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015022CCB0B0>]}
[0m18:43:55.428461 [info ] [MainThread]: 
[0m18:43:55.430467 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:43:55.432454 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:43:55.449460 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:43:55.450455 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:43:55.450455 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:43:55.507456 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:43:55.508459 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:43:55.509460 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:43:55.518457 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:43:55.520453 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:43:55.521455 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:43:55.528457 [debug] [MainThread]: Using postgres connection "master"
[0m18:43:55.528457 [debug] [MainThread]: On master: BEGIN
[0m18:43:55.529456 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:43:55.578459 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:43:55.578459 [debug] [MainThread]: Using postgres connection "master"
[0m18:43:55.579460 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:43:55.595456 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:43:55.598457 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8fc1c6d0-a98c-4897-bda2-f3bb3fafccbc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015022EB9D60>]}
[0m18:43:55.599456 [debug] [MainThread]: On master: ROLLBACK
[0m18:43:55.600479 [debug] [MainThread]: On master: Close
[0m18:43:55.602457 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:43:55.604474 [info ] [MainThread]: 
[0m18:43:55.609454 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:43:55.612474 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m18:43:55.615457 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:43:55.646456 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m18:43:55.647458 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 18:43:55.616456 => 18:43:55.647458
[0m18:43:55.648457 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:43:55.649456 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 18:43:55.649456 => 18:43:55.649456
[0m18:43:55.651457 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:43:55.653454 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:43:55.653454 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:43:55.654456 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m18:43:55.655454 [debug] [MainThread]: Command end result
[0m18:43:55.667457 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ','SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site','
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
            categories AS (
            ',    SET @categories_sql_first = CONCAT(
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site
    , '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        )
        ,
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        )
        ,
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        

        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        )
        ,
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    ,
    categories_second AS (
            categories AS (
            ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        )
        ,
        

        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        )
        ,
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		), 
    
    ,
    categories_third AS (
            categories AS (
            ',SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        )
        ,
        

        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        )
        ,
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
    
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third
[0m18:43:55.688455 [debug] [MainThread]: Command `dbt compile` succeeded at 18:43:55.688455 after 1.21 seconds
[0m18:43:55.689454 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015022AA7830>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015022E13D40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015022E12BA0>]}
[0m18:43:55.691458 [debug] [MainThread]: Flushing usage events
[0m18:49:22.292957 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC5F6B2390>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC5F6B36E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC5F6B2840>]}


============================== 18:49:22.297961 | f646947c-7f72-48c5-bcb7-067e4e861f3b ==============================
[0m18:49:22.297961 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:49:22.308983 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m18:49:22.558974 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f646947c-7f72-48c5-bcb7-067e4e861f3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC5F6D8E60>]}
[0m18:49:22.679979 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f646947c-7f72-48c5-bcb7-067e4e861f3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC5EBA9880>]}
[0m18:49:22.682045 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:49:22.703998 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:49:22.805999 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:49:22.808001 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m18:49:23.007002 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f646947c-7f72-48c5-bcb7-067e4e861f3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC5FA433E0>]}
[0m18:49:23.022000 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f646947c-7f72-48c5-bcb7-067e4e861f3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC5FB189E0>]}
[0m18:49:23.023006 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m18:49:23.024004 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f646947c-7f72-48c5-bcb7-067e4e861f3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC5FBEF350>]}
[0m18:49:23.026999 [info ] [MainThread]: 
[0m18:49:23.029000 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:49:23.031004 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:49:23.047003 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:49:23.048004 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:49:23.048004 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:49:23.106001 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:49:23.107002 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:49:23.107002 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:49:23.116004 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:49:23.117999 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:49:23.118999 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:49:23.126002 [debug] [MainThread]: Using postgres connection "master"
[0m18:49:23.127004 [debug] [MainThread]: On master: BEGIN
[0m18:49:23.128002 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:49:23.177001 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:49:23.177001 [debug] [MainThread]: Using postgres connection "master"
[0m18:49:23.177998 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:49:23.187998 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:49:23.190004 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f646947c-7f72-48c5-bcb7-067e4e861f3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC5FCEBEF0>]}
[0m18:49:23.191004 [debug] [MainThread]: On master: ROLLBACK
[0m18:49:23.192014 [debug] [MainThread]: On master: Close
[0m18:49:23.194000 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:49:23.196007 [info ] [MainThread]: 
[0m18:49:23.200002 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:49:23.202005 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m18:49:23.202005 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:49:23.223000 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m18:49:23.226016 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 18:49:23.203004 => 18:49:23.225030
[0m18:49:23.228039 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:49:23.229004 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 18:49:23.229004 => 18:49:23.229004
[0m18:49:23.231004 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:49:23.233002 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:49:23.233002 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:49:23.234002 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m18:49:23.235002 [debug] [MainThread]: Command end result
[0m18:49:23.246998 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ','SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site','
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
            categories AS (
            ',    SET @categories_sql_first = CONCAT(
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site
    , '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        )
        ,
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        )
        ,
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        

        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        )
        ,
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		)
        ,, 
    
    ,
    categories_second AS (
            categories AS (
            ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        )
        ,
        

        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        )
        ,
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		)
        ,, 
    
    ,
    categories_third AS (
            categories AS (
            ',SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        )
        ,
        

        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        )
        ,
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
        ,
    
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third
[0m18:49:23.269497 [debug] [MainThread]: Command `dbt compile` succeeded at 18:49:23.269497 after 1.18 seconds
[0m18:49:23.271493 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC59150620>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC59075460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC5EBF6F30>]}
[0m18:49:23.273505 [debug] [MainThread]: Flushing usage events
[0m18:52:30.698616 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229BC991880>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229BC9915B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229BC991970>]}


============================== 18:52:30.703613 | 662f31c1-f38d-427c-b8da-f20009eed87c ==============================
[0m18:52:30.703613 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:52:30.706616 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m18:52:30.956612 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '662f31c1-f38d-427c-b8da-f20009eed87c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229BC389F70>]}
[0m18:52:31.114614 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '662f31c1-f38d-427c-b8da-f20009eed87c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229BC3DE5A0>]}
[0m18:52:31.115618 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:52:31.130616 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:52:31.223611 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m18:52:31.224614 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m18:52:31.231612 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '662f31c1-f38d-427c-b8da-f20009eed87c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229BCB5F710>]}
[0m18:52:31.246616 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '662f31c1-f38d-427c-b8da-f20009eed87c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229BCDD9130>]}
[0m18:52:31.247614 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m18:52:31.249624 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '662f31c1-f38d-427c-b8da-f20009eed87c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229BC9E8CB0>]}
[0m18:52:31.251617 [info ] [MainThread]: 
[0m18:52:31.253614 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:52:31.255614 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:52:31.271612 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:52:31.272614 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:52:31.273618 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:52:31.330614 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:52:31.331615 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:52:31.332614 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:52:31.340613 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:52:31.342616 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:52:31.343615 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:52:31.350612 [debug] [MainThread]: Using postgres connection "master"
[0m18:52:31.351615 [debug] [MainThread]: On master: BEGIN
[0m18:52:31.352617 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:52:31.400616 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:52:31.401616 [debug] [MainThread]: Using postgres connection "master"
[0m18:52:31.402622 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:52:31.413615 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:52:31.415615 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '662f31c1-f38d-427c-b8da-f20009eed87c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229BCD8C1A0>]}
[0m18:52:31.416614 [debug] [MainThread]: On master: ROLLBACK
[0m18:52:31.417614 [debug] [MainThread]: On master: Close
[0m18:52:31.419614 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:52:31.420650 [info ] [MainThread]: 
[0m18:52:31.434035 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:52:31.436039 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m18:52:31.436039 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:52:31.459035 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m18:52:31.461049 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 18:52:31.437036 => 18:52:31.461049
[0m18:52:31.462040 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:52:31.463041 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 18:52:31.463041 => 18:52:31.463041
[0m18:52:31.465039 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:52:31.466037 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:52:31.467037 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:52:31.468038 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m18:52:31.469039 [debug] [MainThread]: Command end result
[0m18:52:31.481039 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ','SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site','
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
            categories AS (
            ',    SET @categories_sql_first = CONCAT(
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site
    , '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        )
        ,
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        )
        ,
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        

        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        )
        ,
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		)
        ,, 
    
    ,
    categories_second AS (
            categories AS (
            ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        )
        ,
        

        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        )
        ,
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		)
        ,, 
    
    ,
    categories_third AS (
            categories AS (
            ',SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        )
        ,
        

        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        )
        ,
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
        ,
    
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third
[0m18:52:31.495040 [debug] [MainThread]: Command `dbt compile` succeeded at 18:52:31.495040 after 0.99 seconds
[0m18:52:31.497039 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229BBED69F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229BC7DC6E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229BBF051C0>]}
[0m18:52:31.498039 [debug] [MainThread]: Flushing usage events
[0m18:54:17.692567 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DA5BA19D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DA5BA1850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DA5BA1760>]}


============================== 18:54:17.698565 | ada7acc8-658a-497b-ba19-16af745b3460 ==============================
[0m18:54:17.698565 [info ] [MainThread]: Running with dbt=1.7.13
[0m18:54:17.700579 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:54:17.955566 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ada7acc8-658a-497b-ba19-16af745b3460', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DA5BA3200>]}
[0m18:54:18.072568 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ada7acc8-658a-497b-ba19-16af745b3460', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DA5A7D4F0>]}
[0m18:54:18.074570 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m18:54:18.090569 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m18:54:18.172567 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:54:18.173569 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m18:54:18.372568 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ada7acc8-658a-497b-ba19-16af745b3460', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DA61F9D30>]}
[0m18:54:18.386570 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ada7acc8-658a-497b-ba19-16af745b3460', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DA5FE9A60>]}
[0m18:54:18.388574 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m18:54:18.389573 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ada7acc8-658a-497b-ba19-16af745b3460', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DA5E867B0>]}
[0m18:54:18.392567 [info ] [MainThread]: 
[0m18:54:18.393567 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:54:18.395568 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:54:18.412568 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:54:18.413570 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:54:18.413570 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:54:18.472578 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:54:18.473572 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:54:18.473572 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:54:18.482567 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:54:18.484567 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:54:18.485568 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:54:18.493567 [debug] [MainThread]: Using postgres connection "master"
[0m18:54:18.494568 [debug] [MainThread]: On master: BEGIN
[0m18:54:18.495571 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:54:18.543571 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:54:18.543571 [debug] [MainThread]: Using postgres connection "master"
[0m18:54:18.544573 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:54:18.561567 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:54:18.563570 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ada7acc8-658a-497b-ba19-16af745b3460', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DA5FEBFB0>]}
[0m18:54:18.564570 [debug] [MainThread]: On master: ROLLBACK
[0m18:54:18.565573 [debug] [MainThread]: On master: Close
[0m18:54:18.567573 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:54:18.569577 [info ] [MainThread]: 
[0m18:54:18.575570 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:54:18.576571 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m18:54:18.577571 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:54:18.604574 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m18:54:18.606572 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 18:54:18.578568 => 18:54:18.606572
[0m18:54:18.607571 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:54:18.609570 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 18:54:18.608570 => 18:54:18.608570
[0m18:54:18.611569 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m18:54:18.613568 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:54:18.614570 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:54:18.614570 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m18:54:18.615569 [debug] [MainThread]: Command end result
[0m18:54:18.627570 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ','SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site','
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
        categories AS (
            ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site
    , '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        )
        ,
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        )
        ,
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        

        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        )
        ,
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		)
        ,, 
    
    ,
    categories_second AS (
        categories AS (
            ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        )
        ,
        

        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        )
        ,
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		)
        ,, 
    
    ,
    categories_third AS (
        categories AS (
            ',SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        )
        ,
        

        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        )
        ,
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
        ,
    
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third
[0m18:54:18.641570 [debug] [MainThread]: Command `dbt compile` succeeded at 18:54:18.641570 after 1.15 seconds
[0m18:54:18.643571 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DA5BA3C80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DA5BA19D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015DA5BA1850>]}
[0m18:54:18.644571 [debug] [MainThread]: Flushing usage events
[0m19:00:21.330041 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021C84E233E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021C84E234A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021C84E22750>]}


============================== 19:00:21.336039 | ba73da88-af06-4d44-81d4-d13d2cf2a1fe ==============================
[0m19:00:21.336039 [info ] [MainThread]: Running with dbt=1.7.13
[0m19:00:21.338068 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m19:00:21.591039 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ba73da88-af06-4d44-81d4-d13d2cf2a1fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021C84E788C0>]}
[0m19:00:21.706040 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ba73da88-af06-4d44-81d4-d13d2cf2a1fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021C84E02BD0>]}
[0m19:00:21.708046 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m19:00:21.722038 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m19:00:21.824037 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:00:21.825039 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m19:00:22.030039 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ba73da88-af06-4d44-81d4-d13d2cf2a1fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021C85449FA0>]}
[0m19:00:22.045048 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ba73da88-af06-4d44-81d4-d13d2cf2a1fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021C85238140>]}
[0m19:00:22.046046 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m19:00:22.048051 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ba73da88-af06-4d44-81d4-d13d2cf2a1fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021C84818980>]}
[0m19:00:22.050043 [info ] [MainThread]: 
[0m19:00:22.052043 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m19:00:22.054040 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m19:00:22.070041 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m19:00:22.071041 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m19:00:22.071041 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:00:22.132039 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m19:00:22.133045 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m19:00:22.134040 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m19:00:22.142043 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m19:00:22.144042 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m19:00:22.145041 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m19:00:22.154040 [debug] [MainThread]: Using postgres connection "master"
[0m19:00:22.155043 [debug] [MainThread]: On master: BEGIN
[0m19:00:22.155043 [debug] [MainThread]: Opening a new connection, currently in state init
[0m19:00:22.204041 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m19:00:22.205047 [debug] [MainThread]: Using postgres connection "master"
[0m19:00:22.206045 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m19:00:22.216040 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m19:00:22.218041 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ba73da88-af06-4d44-81d4-d13d2cf2a1fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021C8523A2A0>]}
[0m19:00:22.219041 [debug] [MainThread]: On master: ROLLBACK
[0m19:00:22.219041 [debug] [MainThread]: On master: Close
[0m19:00:22.221044 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m19:00:22.223059 [info ] [MainThread]: 
[0m19:00:22.227041 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m19:00:22.229041 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m19:00:22.230041 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m19:00:22.250039 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m19:00:22.252045 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 19:00:22.230041 => 19:00:22.251042
[0m19:00:22.253049 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m19:00:22.254043 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 19:00:22.253049 => 19:00:22.253049
[0m19:00:22.255046 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m19:00:22.257040 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:00:22.258040 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m19:00:22.258040 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m19:00:22.259042 [debug] [MainThread]: Command end result
[0m19:00:22.272050 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ','SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site','
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
        categories AS (
            ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site
    , '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        )
        ,
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        )
        ,
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        

        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        )
        ,
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    ,
    categories_second AS (
        categories AS (
            ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        )
        ,
        

        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        )
        ,
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		), 
    
    ,
    categories_third AS (
        categories AS (
            ',SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        )
        ,
        

        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        )
        ,
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
    
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third
[0m19:00:22.292949 [debug] [MainThread]: Command `dbt compile` succeeded at 19:00:22.291948 after 1.15 seconds
[0m19:00:22.293951 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021C84CD9730>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021C84A21DC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021CFE7D5460>]}
[0m19:00:22.295957 [debug] [MainThread]: Flushing usage events
[0m19:02:06.996441 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B8D5FF2A80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B8D5FF2C90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B8D5FF1B50>]}


============================== 19:02:07.002440 | ee3060dc-5ecf-411b-83d0-1b96e185c79c ==============================
[0m19:02:07.002440 [info ] [MainThread]: Running with dbt=1.7.13
[0m19:02:07.004447 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m19:02:07.255442 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ee3060dc-5ecf-411b-83d0-1b96e185c79c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B8D5D1CDA0>]}
[0m19:02:07.376443 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ee3060dc-5ecf-411b-83d0-1b96e185c79c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B8D6048590>]}
[0m19:02:07.378444 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m19:02:07.391443 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m19:02:07.505472 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:02:07.506488 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m19:02:07.704513 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ee3060dc-5ecf-411b-83d0-1b96e185c79c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B8D660EB10>]}
[0m19:02:07.720529 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ee3060dc-5ecf-411b-83d0-1b96e185c79c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B8D6479C10>]}
[0m19:02:07.721522 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m19:02:07.723528 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ee3060dc-5ecf-411b-83d0-1b96e185c79c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B8D6478110>]}
[0m19:02:07.727522 [info ] [MainThread]: 
[0m19:02:07.730519 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m19:02:07.733516 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m19:02:07.749514 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m19:02:07.750516 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m19:02:07.751516 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:02:07.807517 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m19:02:07.807517 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m19:02:07.808515 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m19:02:07.817516 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m19:02:07.819516 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m19:02:07.820515 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m19:02:07.826513 [debug] [MainThread]: Using postgres connection "master"
[0m19:02:07.827515 [debug] [MainThread]: On master: BEGIN
[0m19:02:07.828516 [debug] [MainThread]: Opening a new connection, currently in state init
[0m19:02:07.877515 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m19:02:07.877515 [debug] [MainThread]: Using postgres connection "master"
[0m19:02:07.878515 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m19:02:07.890523 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m19:02:07.894516 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ee3060dc-5ecf-411b-83d0-1b96e185c79c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B8D647BBC0>]}
[0m19:02:07.895520 [debug] [MainThread]: On master: ROLLBACK
[0m19:02:07.897517 [debug] [MainThread]: On master: Close
[0m19:02:07.899521 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m19:02:07.900524 [info ] [MainThread]: 
[0m19:02:07.908516 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m19:02:07.909518 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m19:02:07.911529 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m19:02:07.932516 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m19:02:07.934518 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 19:02:07.911529 => 19:02:07.933516
[0m19:02:07.935517 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m19:02:07.937517 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 19:02:07.936516 => 19:02:07.936516
[0m19:02:07.939519 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m19:02:07.941515 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:02:07.941515 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m19:02:07.943539 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m19:02:07.944518 [debug] [MainThread]: Command end result
[0m19:02:07.955517 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ','SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site','
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
            ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site
    , '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        )
        ,
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        )
        ,
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        

        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        )
        ,
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    ,
    categories_second AS (
            ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        )
        ,
        

        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        )
        ,
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		), 
    
    ,
    categories_third AS (
            ',SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        )
        ,
        

        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        )
        ,
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
    
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third
[0m19:02:07.975515 [debug] [MainThread]: Command `dbt compile` succeeded at 19:02:07.975515 after 1.17 seconds
[0m19:02:07.976517 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B8D5E869F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B8D5FF1B50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B8D5FF1C10>]}
[0m19:02:07.977522 [debug] [MainThread]: Flushing usage events
[0m11:09:50.964376 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000236A7786A20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000236A7786630>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000236A7786F00>]}


============================== 11:09:50.978496 | c26e44e2-53bf-4526-bda1-f9591e114ac2 ==============================
[0m11:09:50.978496 [info ] [MainThread]: Running with dbt=1.7.13
[0m11:09:50.981497 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m11:09:51.544726 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c26e44e2-53bf-4526-bda1-f9591e114ac2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000236A7784770>]}
[0m11:09:51.750734 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c26e44e2-53bf-4526-bda1-f9591e114ac2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000236A77D88C0>]}
[0m11:09:51.756402 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m11:09:51.792405 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m11:09:53.441255 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m11:09:53.444262 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m11:09:53.757136 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c26e44e2-53bf-4526-bda1-f9591e114ac2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000236A7CBC890>]}
[0m11:09:53.798277 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c26e44e2-53bf-4526-bda1-f9591e114ac2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000236A7B7A4E0>]}
[0m11:09:53.800275 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m11:09:53.803278 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c26e44e2-53bf-4526-bda1-f9591e114ac2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000236A7B78200>]}
[0m11:09:53.808364 [info ] [MainThread]: 
[0m11:09:53.811366 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m11:09:53.814467 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m11:09:53.848438 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:09:53.850436 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m11:09:53.852443 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:09:53.976891 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m11:09:53.978525 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:09:53.979881 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m11:09:54.035065 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m11:09:54.040979 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m11:09:54.043883 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m11:09:54.058086 [debug] [MainThread]: Using postgres connection "master"
[0m11:09:54.058086 [debug] [MainThread]: On master: BEGIN
[0m11:09:54.063940 [debug] [MainThread]: Opening a new connection, currently in state init
[0m11:09:54.165566 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m11:09:54.167097 [debug] [MainThread]: Using postgres connection "master"
[0m11:09:54.168280 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m11:09:54.193404 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m11:09:54.197650 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c26e44e2-53bf-4526-bda1-f9591e114ac2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000236A7B7BA10>]}
[0m11:09:54.198646 [debug] [MainThread]: On master: ROLLBACK
[0m11:09:54.201399 [debug] [MainThread]: On master: Close
[0m11:09:54.204317 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:09:54.207360 [info ] [MainThread]: 
[0m11:09:54.217619 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m11:09:54.223301 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m11:09:54.224963 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m11:09:54.269423 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m11:09:54.272419 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 11:09:54.226096 => 11:09:54.271425
[0m11:09:54.274504 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m11:09:54.277455 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 11:09:54.275427 => 11:09:54.275427
[0m11:09:54.280455 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m11:09:54.284450 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:09:54.286349 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m11:09:54.288007 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m11:09:54.290268 [debug] [MainThread]: Command end result
[0m11:09:54.313643 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
            ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site
    , '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        )
        ,
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        )
        ,
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        

        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        )
        ,
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    ,
    categories_second AS (
            ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        )
        ,
        

        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        )
        ,
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		), 
    
    ,
    categories_third AS (
            ',SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        )
        ,
        

        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        )
        ,
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
    
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third
[0m11:09:54.342752 [debug] [MainThread]: Command `dbt compile` succeeded at 11:09:54.341752 after 3.81 seconds
[0m11:09:54.345756 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000236A1222870>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000236A7763F20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000236A7763FE0>]}
[0m11:09:54.349350 [debug] [MainThread]: Flushing usage events
[0m11:11:13.494233 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018D63156A20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018D631576E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018D63157D40>]}


============================== 11:11:13.506260 | e4abb7dd-c374-4b78-bc4d-176c70b084ec ==============================
[0m11:11:13.506260 [info ] [MainThread]: Running with dbt=1.7.13
[0m11:11:13.509306 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m11:11:13.952307 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e4abb7dd-c374-4b78-bc4d-176c70b084ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018D62F38410>]}
[0m11:11:14.190031 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e4abb7dd-c374-4b78-bc4d-176c70b084ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018D62F9EC60>]}
[0m11:11:14.193029 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m11:11:14.218614 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m11:11:14.402005 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m11:11:14.403451 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m11:11:14.652582 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e4abb7dd-c374-4b78-bc4d-176c70b084ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018D6367EFC0>]}
[0m11:11:14.673442 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e4abb7dd-c374-4b78-bc4d-176c70b084ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018D63578590>]}
[0m11:11:14.675030 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m11:11:14.677084 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e4abb7dd-c374-4b78-bc4d-176c70b084ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018D63750D70>]}
[0m11:11:14.680084 [info ] [MainThread]: 
[0m11:11:14.682083 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m11:11:14.685197 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m11:11:14.707259 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:11:14.708672 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m11:11:14.709256 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:11:14.780326 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m11:11:14.781323 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:11:14.782324 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m11:11:14.792392 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m11:11:14.795445 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m11:11:14.796647 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m11:11:14.807139 [debug] [MainThread]: Using postgres connection "master"
[0m11:11:14.808142 [debug] [MainThread]: On master: BEGIN
[0m11:11:14.809139 [debug] [MainThread]: Opening a new connection, currently in state init
[0m11:11:14.877699 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m11:11:14.878688 [debug] [MainThread]: Using postgres connection "master"
[0m11:11:14.880685 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m11:11:14.895701 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m11:11:14.899737 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e4abb7dd-c374-4b78-bc4d-176c70b084ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018D631560C0>]}
[0m11:11:14.900736 [debug] [MainThread]: On master: ROLLBACK
[0m11:11:14.902736 [debug] [MainThread]: On master: Close
[0m11:11:14.904734 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:11:14.907044 [info ] [MainThread]: 
[0m11:11:14.913371 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m11:11:14.915370 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m11:11:14.917954 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m11:11:14.954985 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m11:11:14.958134 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 11:11:14.918948 => 11:11:14.957113
[0m11:11:14.960010 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m11:11:14.962017 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 11:11:14.961011 => 11:11:14.961011
[0m11:11:14.964088 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m11:11:14.966011 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:11:14.968044 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m11:11:14.969014 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m11:11:14.971019 [debug] [MainThread]: Command end result
[0m11:11:14.991236 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site,
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
            ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site
    , '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        )
        ,
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        )
        ,
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        

        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        )
        ,
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    ,
    categories_second AS (
            ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        )
        ,
        

        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        )
        ,
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		), 
    
    ,
    categories_third AS (
            ',SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        )
        ,
        

        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        )
        ,
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
    
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third
[0m11:11:15.023039 [debug] [MainThread]: Command `dbt compile` succeeded at 11:11:15.022582 after 1.83 seconds
[0m11:11:15.024987 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018D631559D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018D631576E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018D63157D40>]}
[0m11:11:15.027053 [debug] [MainThread]: Flushing usage events
[0m11:12:40.193476 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF51B323C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF51B32CF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF51B33A10>]}


============================== 11:12:40.205561 | 13d535d8-b3b9-42e3-b36a-1418464290f6 ==============================
[0m11:12:40.205561 [info ] [MainThread]: Running with dbt=1.7.13
[0m11:12:40.208704 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m11:12:40.632042 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '13d535d8-b3b9-42e3-b36a-1418464290f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF51B882F0>]}
[0m11:12:40.778318 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '13d535d8-b3b9-42e3-b36a-1418464290f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF519EB0E0>]}
[0m11:12:40.780329 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m11:12:40.798273 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m11:12:40.958379 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m11:12:40.960388 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m11:12:41.308775 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '13d535d8-b3b9-42e3-b36a-1418464290f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF5202DB50>]}
[0m11:12:41.328788 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '13d535d8-b3b9-42e3-b36a-1418464290f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF51EE9880>]}
[0m11:12:41.330789 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m11:12:41.332994 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '13d535d8-b3b9-42e3-b36a-1418464290f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF5207EAB0>]}
[0m11:12:41.337139 [info ] [MainThread]: 
[0m11:12:41.339222 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m11:12:41.342957 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m11:12:41.368397 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:12:41.368397 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m11:12:41.372238 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:12:41.472089 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m11:12:41.473926 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:12:41.475507 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m11:12:41.488590 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m11:12:41.488590 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m11:12:41.494475 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m11:12:41.506466 [debug] [MainThread]: Using postgres connection "master"
[0m11:12:41.508474 [debug] [MainThread]: On master: BEGIN
[0m11:12:41.508474 [debug] [MainThread]: Opening a new connection, currently in state init
[0m11:12:41.591580 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m11:12:41.593067 [debug] [MainThread]: Using postgres connection "master"
[0m11:12:41.594271 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m11:12:41.608498 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m11:12:41.614370 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '13d535d8-b3b9-42e3-b36a-1418464290f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF51EEB6B0>]}
[0m11:12:41.615367 [debug] [MainThread]: On master: ROLLBACK
[0m11:12:41.616431 [debug] [MainThread]: On master: Close
[0m11:12:41.619804 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:12:41.621894 [info ] [MainThread]: 
[0m11:12:41.630090 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m11:12:41.632097 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m11:12:41.632097 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m11:12:41.673472 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m11:12:41.677049 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 11:12:41.632097 => 11:12:41.675522
[0m11:12:41.678494 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m11:12:41.679494 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 11:12:41.679494 => 11:12:41.679494
[0m11:12:41.683403 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m11:12:41.685711 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:12:41.686800 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m11:12:41.688924 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m11:12:41.691201 [debug] [MainThread]: Command end result
[0m11:12:41.708475 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site,
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
            ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site
    , '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        )
        ,
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        )
        ,
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        

        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        )
        ,
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		'), 
    
    ,
    categories_second AS (
            ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        )
        ,
        

        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        )
        ,
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		'), 
    
    ,
    categories_third AS (
            ',SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site, '
            UNION ALL SELECT ''Others'
        ')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        )
        ,
        

        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        )
        ,
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		')
    
        select * from final_one
        union all
        select * from final_second
        union all
        select * from final_third
[0m11:12:41.740182 [debug] [MainThread]: Command `dbt compile` succeeded at 11:12:41.740182 after 1.83 seconds
[0m11:12:41.745838 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF50A28410>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF4EC35370>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF5207EB70>]}
[0m11:12:41.747772 [debug] [MainThread]: Flushing usage events
[0m13:06:32.375468 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154A8AC3860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154A8AC3770>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154A8AC30B0>]}


============================== 13:06:32.384030 | 94b72043-c2cb-4c5b-8722-95bbdafd6e25 ==============================
[0m13:06:32.384030 [info ] [MainThread]: Running with dbt=1.7.13
[0m13:06:32.384030 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'send_anonymous_usage_stats': 'True'}
[0m13:06:32.699123 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '94b72043-c2cb-4c5b-8722-95bbdafd6e25', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154A7E57D70>]}
[0m13:06:32.815513 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '94b72043-c2cb-4c5b-8722-95bbdafd6e25', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154A8B19A00>]}
[0m13:06:32.815513 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m13:06:32.843888 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m13:06:33.479244 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m13:06:33.480257 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m13:06:33.686636 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '94b72043-c2cb-4c5b-8722-95bbdafd6e25', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154A908E7B0>]}
[0m13:06:33.703454 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '94b72043-c2cb-4c5b-8722-95bbdafd6e25', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154A8EF9B20>]}
[0m13:06:33.704693 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m13:06:33.705689 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '94b72043-c2cb-4c5b-8722-95bbdafd6e25', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154A90186E0>]}
[0m13:06:33.708688 [info ] [MainThread]: 
[0m13:06:33.709687 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m13:06:33.712977 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m13:06:33.730053 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m13:06:33.730997 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m13:06:33.733020 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:06:33.802155 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m13:06:33.803157 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m13:06:33.803157 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m13:06:33.835285 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m13:06:33.835285 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m13:06:33.835285 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m13:06:33.844369 [debug] [MainThread]: Using postgres connection "master"
[0m13:06:33.844369 [debug] [MainThread]: On master: BEGIN
[0m13:06:33.844369 [debug] [MainThread]: Opening a new connection, currently in state init
[0m13:06:33.901640 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m13:06:33.902643 [debug] [MainThread]: Using postgres connection "master"
[0m13:06:33.903644 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m13:06:33.917162 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m13:06:33.919163 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '94b72043-c2cb-4c5b-8722-95bbdafd6e25', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154A8EA8950>]}
[0m13:06:33.920164 [debug] [MainThread]: On master: ROLLBACK
[0m13:06:33.921165 [debug] [MainThread]: On master: Close
[0m13:06:33.923166 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m13:06:33.925175 [info ] [MainThread]: 
[0m13:06:33.931118 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m13:06:33.932113 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m13:06:33.933114 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m13:06:33.955137 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m13:06:33.957102 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 13:06:33.934115 => 13:06:33.957102
[0m13:06:33.959100 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m13:06:33.960100 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 13:06:33.959100 => 13:06:33.959100
[0m13:06:33.961098 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m13:06:33.964099 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:06:33.965101 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m13:06:33.966097 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m13:06:33.967098 [debug] [MainThread]: Command end result
[0m13:06:33.979138 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ',SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', 'site',,
        'UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
            ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site
    ,
            'UNION ALL SELECT ''Others'')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        ,
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		'), 
    
    ,
    categories_second AS (
            ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site,
            'UNION ALL SELECT ''Others'')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers_second r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        ),
        ,
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		'), 
    
    ,
    categories_third AS (
            ',SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,
            'UNION ALL SELECT ''Others'')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers_third r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        ),
        ,
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		')
    
[0m13:06:33.993785 [debug] [MainThread]: Command `dbt compile` succeeded at 13:06:33.985188 after 1.78 seconds
[0m13:06:33.995854 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154A87969F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154A899CA70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154A899E300>]}
[0m13:06:33.995854 [debug] [MainThread]: Flushing usage events
[0m13:09:22.794417 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CFA886F90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CFA886C90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CFA8869F0>]}


============================== 13:09:22.795346 | f4b2d523-992b-4575-9ffe-5cb0dd1230e7 ==============================
[0m13:09:22.795346 [info ] [MainThread]: Running with dbt=1.7.13
[0m13:09:22.795346 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m13:09:23.063943 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f4b2d523-992b-4575-9ffe-5cb0dd1230e7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CFAB6E480>]}
[0m13:09:23.210092 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f4b2d523-992b-4575-9ffe-5cb0dd1230e7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CFA8AE2D0>]}
[0m13:09:23.212102 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m13:09:23.225116 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m13:09:23.333989 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m13:09:23.333989 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m13:09:23.545557 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f4b2d523-992b-4575-9ffe-5cb0dd1230e7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CFAC35BE0>]}
[0m13:09:23.561445 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f4b2d523-992b-4575-9ffe-5cb0dd1230e7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CFACC0CE0>]}
[0m13:09:23.562463 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m13:09:23.563503 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f4b2d523-992b-4575-9ffe-5cb0dd1230e7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CFAE9EAB0>]}
[0m13:09:23.565593 [info ] [MainThread]: 
[0m13:09:23.567645 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m13:09:23.567645 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m13:09:23.587906 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m13:09:23.588907 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m13:09:23.589907 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:09:23.645055 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m13:09:23.645055 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m13:09:23.645055 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m13:09:23.654120 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m13:09:23.654120 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m13:09:23.654120 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m13:09:23.665171 [debug] [MainThread]: Using postgres connection "master"
[0m13:09:23.665171 [debug] [MainThread]: On master: BEGIN
[0m13:09:23.665171 [debug] [MainThread]: Opening a new connection, currently in state init
[0m13:09:23.724096 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m13:09:23.725099 [debug] [MainThread]: Using postgres connection "master"
[0m13:09:23.725099 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m13:09:23.735100 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m13:09:23.737096 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f4b2d523-992b-4575-9ffe-5cb0dd1230e7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CFACC2870>]}
[0m13:09:23.738099 [debug] [MainThread]: On master: ROLLBACK
[0m13:09:23.739097 [debug] [MainThread]: On master: Close
[0m13:09:23.741097 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m13:09:23.743155 [info ] [MainThread]: 
[0m13:09:23.748116 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m13:09:23.750115 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m13:09:23.750115 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m13:09:23.773113 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m13:09:23.775724 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 13:09:23.751113 => 13:09:23.774719
[0m13:09:23.776717 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m13:09:23.778721 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 13:09:23.777714 => 13:09:23.777714
[0m13:09:23.780716 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m13:09:23.782716 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:09:23.783717 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m13:09:23.783717 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m13:09:23.785798 [debug] [MainThread]: Command end result
[0m13:09:23.797058 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ',SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', 'site',,
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
            ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site
    ,
            UNION ALL SELECT ''Others'')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        ,
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		'), 
    
    ,
    categories_second AS (
            ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site,
            UNION ALL SELECT ''Others'')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers_second r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        ),
        ,
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		'), 
    
    ,
    categories_third AS (
            ',SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,
            UNION ALL SELECT ''Others'')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers_third r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        ),
        ,
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		')
    
[0m13:09:23.810610 [debug] [MainThread]: Command `dbt compile` succeeded at 13:09:23.810610 after 1.23 seconds
[0m13:09:23.811604 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CFA715970>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CFAC58740>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CFA949280>]}
[0m13:09:23.813603 [debug] [MainThread]: Flushing usage events
[0m13:14:43.110714 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000288AD2710D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000288AD273A10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000288AD272E40>]}


============================== 13:14:43.124716 | 504524e0-fe15-44c8-9072-c66b08cc4e7e ==============================
[0m13:14:43.124716 [info ] [MainThread]: Running with dbt=1.7.13
[0m13:14:43.157729 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m13:14:43.995841 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '504524e0-fe15-44c8-9072-c66b08cc4e7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000288AD2C9C10>]}
[0m13:14:44.251713 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '504524e0-fe15-44c8-9072-c66b08cc4e7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000288AD29C710>]}
[0m13:14:44.256703 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m13:14:44.289262 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m13:14:44.565271 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m13:14:44.565271 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m13:14:44.835768 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '504524e0-fe15-44c8-9072-c66b08cc4e7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000288AD29E7B0>]}
[0m13:14:44.853781 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '504524e0-fe15-44c8-9072-c66b08cc4e7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000288AD587890>]}
[0m13:14:44.854781 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m13:14:44.856792 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '504524e0-fe15-44c8-9072-c66b08cc4e7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000288AD585AF0>]}
[0m13:14:44.861787 [info ] [MainThread]: 
[0m13:14:44.863779 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m13:14:44.868665 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m13:14:44.885883 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m13:14:44.886719 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m13:14:44.887719 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:14:44.947487 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m13:14:44.948487 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m13:14:44.948487 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m13:14:44.957488 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m13:14:44.959487 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m13:14:44.960486 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m13:14:44.967660 [debug] [MainThread]: Using postgres connection "master"
[0m13:14:44.968662 [debug] [MainThread]: On master: BEGIN
[0m13:14:44.969661 [debug] [MainThread]: Opening a new connection, currently in state init
[0m13:14:45.013993 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m13:14:45.013993 [debug] [MainThread]: Using postgres connection "master"
[0m13:14:45.013993 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m13:14:45.025449 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m13:14:45.033999 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '504524e0-fe15-44c8-9072-c66b08cc4e7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000288AD7F3C80>]}
[0m13:14:45.033999 [debug] [MainThread]: On master: ROLLBACK
[0m13:14:45.033999 [debug] [MainThread]: On master: Close
[0m13:14:45.033999 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m13:14:45.033999 [info ] [MainThread]: 
[0m13:14:45.044311 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m13:14:45.044311 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m13:14:45.044311 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m13:14:45.074585 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m13:14:45.076583 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 13:14:45.044311 => 13:14:45.075580
[0m13:14:45.077584 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m13:14:45.078586 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 13:14:45.078586 => 13:14:45.078586
[0m13:14:45.082583 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m13:14:45.084059 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:14:45.085028 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m13:14:45.086029 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m13:14:45.086952 [debug] [MainThread]: Command end result
[0m13:14:45.098959 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
            ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
            UNION ALL SELECT ''Others'')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        ,
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		'), 
    
    ,
    categories_second AS (
            ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
            UNION ALL SELECT ''Others'')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers_second r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        ),
        ,
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		'), 
    
    ,
    categories_third AS (
            ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
            UNION ALL SELECT ''Others'')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers_third r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        ),
        ,
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		')
    
[0m13:14:45.113203 [debug] [MainThread]: Command `dbt compile` succeeded at 13:14:45.112208 after 2.31 seconds
[0m13:14:45.115202 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000288AC3ED280>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000288AD104C20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000288A6BB5460>]}
[0m13:14:45.116222 [debug] [MainThread]: Flushing usage events
[0m13:51:57.024410 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BA641760F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BA64055190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BA641777A0>]}


============================== 13:51:57.024410 | 27240f27-6c7a-4ab8-b482-9e81f5ff192c ==============================
[0m13:51:57.024410 [info ] [MainThread]: Running with dbt=1.7.13
[0m13:51:57.024410 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m13:51:57.348663 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '27240f27-6c7a-4ab8-b482-9e81f5ff192c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BA641759A0>]}
[0m13:51:57.467664 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '27240f27-6c7a-4ab8-b482-9e81f5ff192c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BA640AC170>]}
[0m13:51:57.469667 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m13:51:57.484668 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m13:51:57.609848 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m13:51:57.609848 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m13:51:57.808936 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '27240f27-6c7a-4ab8-b482-9e81f5ff192c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BA64658E90>]}
[0m13:51:57.808936 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '27240f27-6c7a-4ab8-b482-9e81f5ff192c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BA644BC050>]}
[0m13:51:57.824569 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m13:51:57.824569 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '27240f27-6c7a-4ab8-b482-9e81f5ff192c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BA6423AA50>]}
[0m13:51:57.824569 [info ] [MainThread]: 
[0m13:51:57.824569 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m13:51:57.824569 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m13:51:57.840199 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m13:51:57.840199 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m13:51:57.840199 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:51:57.908721 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m13:51:57.908721 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m13:51:57.908721 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m13:51:57.957132 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m13:51:57.960137 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m13:51:57.962138 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m13:51:57.971135 [debug] [MainThread]: Using postgres connection "master"
[0m13:51:57.971135 [debug] [MainThread]: On master: BEGIN
[0m13:51:57.972136 [debug] [MainThread]: Opening a new connection, currently in state init
[0m13:51:58.024136 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m13:51:58.024136 [debug] [MainThread]: Using postgres connection "master"
[0m13:51:58.026138 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m13:51:58.040505 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m13:51:58.042505 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '27240f27-6c7a-4ab8-b482-9e81f5ff192c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BA644BF440>]}
[0m13:51:58.043505 [debug] [MainThread]: On master: ROLLBACK
[0m13:51:58.043505 [debug] [MainThread]: On master: Close
[0m13:51:58.045520 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m13:51:58.047515 [info ] [MainThread]: 
[0m13:51:58.053505 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m13:51:58.054505 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m13:51:58.055507 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m13:51:58.077504 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m13:51:58.079511 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 13:51:58.056504 => 13:51:58.078504
[0m13:51:58.080508 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m13:51:58.081507 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 13:51:58.080508 => 13:51:58.080508
[0m13:51:58.083509 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m13:51:58.085508 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:51:58.086507 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m13:51:58.087517 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m13:51:58.088507 [debug] [MainThread]: Command end result
[0m13:51:58.102506 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
            ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
            UNION ALL SELECT ''Others'')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        ,
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    ,
    categories_second AS (
            ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
            UNION ALL SELECT ''Others'')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers_second r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        ),
        ,
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		), 
    
    ,
    categories_third AS (
            ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
            UNION ALL SELECT ''Others'')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers_third r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        ),
        ,
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
    
[0m13:51:58.117563 [debug] [MainThread]: Command `dbt compile` succeeded at 13:51:58.117563 after 1.29 seconds
[0m13:51:58.118564 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BA636E7830>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BA64153EC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BA63B68BC0>]}
[0m13:51:58.119557 [debug] [MainThread]: Flushing usage events
[0m13:57:16.822966 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E31A2747D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E31A277590>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E31A277530>]}


============================== 13:57:16.828970 | 4f685b04-a6b5-4cf8-9b8e-9788d661ba53 ==============================
[0m13:57:16.828970 [info ] [MainThread]: Running with dbt=1.7.13
[0m13:57:16.830969 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m13:57:17.105505 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4f685b04-a6b5-4cf8-9b8e-9788d661ba53', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E31A180BC0>]}
[0m13:57:17.223575 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4f685b04-a6b5-4cf8-9b8e-9788d661ba53', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E31A2C9130>]}
[0m13:57:17.225578 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m13:57:17.238589 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m13:57:17.344434 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m13:57:17.344434 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m13:57:17.549573 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4f685b04-a6b5-4cf8-9b8e-9788d661ba53', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E31A5E4890>]}
[0m13:57:17.564577 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4f685b04-a6b5-4cf8-9b8e-9788d661ba53', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E31A6982F0>]}
[0m13:57:17.565576 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m13:57:17.575887 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4f685b04-a6b5-4cf8-9b8e-9788d661ba53', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E319F44770>]}
[0m13:57:17.577881 [info ] [MainThread]: 
[0m13:57:17.579884 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m13:57:17.580882 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m13:57:17.594207 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m13:57:17.594207 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m13:57:17.594207 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:57:17.656821 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m13:57:17.657825 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m13:57:17.658825 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m13:57:17.666822 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m13:57:17.668823 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m13:57:17.669823 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m13:57:17.676825 [debug] [MainThread]: Using postgres connection "master"
[0m13:57:17.677827 [debug] [MainThread]: On master: BEGIN
[0m13:57:17.678826 [debug] [MainThread]: Opening a new connection, currently in state init
[0m13:57:17.728822 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m13:57:17.729975 [debug] [MainThread]: Using postgres connection "master"
[0m13:57:17.729975 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m13:57:17.729975 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m13:57:17.729975 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4f685b04-a6b5-4cf8-9b8e-9788d661ba53', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E31A69BFB0>]}
[0m13:57:17.729975 [debug] [MainThread]: On master: ROLLBACK
[0m13:57:17.729975 [debug] [MainThread]: On master: Close
[0m13:57:17.745608 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m13:57:17.745608 [info ] [MainThread]: 
[0m13:57:17.745608 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m13:57:17.745608 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m13:57:17.745608 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m13:57:17.774769 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m13:57:17.774769 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 13:57:17.745608 => 13:57:17.774769
[0m13:57:17.774769 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m13:57:17.774769 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 13:57:17.774769 => 13:57:17.774769
[0m13:57:17.774769 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m13:57:17.774769 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:57:17.774769 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m13:57:17.774769 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m13:57:17.790842 [debug] [MainThread]: Command end result
[0m13:57:17.802838 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
            ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
            UNION ALL SELECT ''Others'')
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        )
        
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    ,
    categories_second AS (
            ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
            UNION ALL SELECT ''Others'')
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers_second r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        ),
        
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		), 
    
    ,
    categories_third AS (
            ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
            UNION ALL SELECT ''Others'')
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers_third r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        ),
        
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
    
[0m13:57:17.817937 [debug] [MainThread]: Command `dbt compile` succeeded at 13:57:17.817937 after 1.20 seconds
[0m13:57:17.819935 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E319797830>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E31A853D70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E31A5E60F0>]}
[0m13:57:17.820946 [debug] [MainThread]: Flushing usage events
[0m14:00:23.987715 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000253E0997CB0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000253E08A3320>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000253E0994200>]}


============================== 14:00:23.987715 | f4e00f4a-0159-4c75-bb6e-32f75a6c21cd ==============================
[0m14:00:23.987715 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:00:23.987715 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m14:00:24.267554 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f4e00f4a-0159-4c75-bb6e-32f75a6c21cd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000253E0BC74A0>]}
[0m14:00:24.396709 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f4e00f4a-0159-4c75-bb6e-32f75a6c21cd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000253E0C616A0>]}
[0m14:00:24.398716 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:00:24.412351 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:00:24.516837 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m14:00:24.518857 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m14:00:24.721922 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f4e00f4a-0159-4c75-bb6e-32f75a6c21cd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000253E0BC6390>]}
[0m14:00:24.737609 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f4e00f4a-0159-4c75-bb6e-32f75a6c21cd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000253E0DB8740>]}
[0m14:00:24.737609 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m14:00:24.737609 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f4e00f4a-0159-4c75-bb6e-32f75a6c21cd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000253E0F8E840>]}
[0m14:00:24.737609 [info ] [MainThread]: 
[0m14:00:24.737609 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m14:00:24.747944 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m14:00:24.762091 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:00:24.762091 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m14:00:24.767125 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:00:24.829891 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m14:00:24.830895 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:00:24.831894 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m14:00:24.840536 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m14:00:24.842535 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m14:00:24.843549 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m14:00:24.851544 [debug] [MainThread]: Using postgres connection "master"
[0m14:00:24.852545 [debug] [MainThread]: On master: BEGIN
[0m14:00:24.853546 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:00:24.908442 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m14:00:24.909472 [debug] [MainThread]: Using postgres connection "master"
[0m14:00:24.910437 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m14:00:24.920290 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m14:00:24.922295 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f4e00f4a-0159-4c75-bb6e-32f75a6c21cd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000253E0E04050>]}
[0m14:00:24.923293 [debug] [MainThread]: On master: ROLLBACK
[0m14:00:24.924292 [debug] [MainThread]: On master: Close
[0m14:00:24.926294 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:00:24.927298 [info ] [MainThread]: 
[0m14:00:24.932292 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:00:24.933292 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m14:00:24.934295 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:00:24.959588 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m14:00:24.959588 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 14:00:24.934295 => 14:00:24.959588
[0m14:00:24.959588 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:00:24.959588 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 14:00:24.959588 => 14:00:24.959588
[0m14:00:24.967119 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:00:24.967636 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:00:24.967636 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m14:00:24.967636 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m14:00:24.967636 [debug] [MainThread]: Command end result
[0m14:00:24.978912 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    
    categories AS (
            ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
            UNION ALL SELECT ''Others''
            )
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        ),
        
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    
    categories_second AS (
            ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
            UNION ALL SELECT ''Others''
            )
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers_second r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        ),
        
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		), 
    
    
    categories_third AS (
            ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
            UNION ALL SELECT ''Others''
            )
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers_third r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        ),
        
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
    
[0m14:00:25.008757 [debug] [MainThread]: Command `dbt compile` succeeded at 14:00:25.008757 after 1.23 seconds
[0m14:00:25.009762 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000253E077E300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000253E07AE9F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000253DA365460>]}
[0m14:00:25.010758 [debug] [MainThread]: Flushing usage events
[0m14:01:03.991700 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013531A86870>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013531A87980>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013531A849E0>]}


============================== 14:01:03.997698 | 6ff97353-6665-4e10-bbd7-eb001f082f88 ==============================
[0m14:01:03.997698 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:01:03.999706 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'send_anonymous_usage_stats': 'True'}
[0m14:01:04.249222 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6ff97353-6665-4e10-bbd7-eb001f082f88', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000135318A8BC0>]}
[0m14:01:04.368994 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6ff97353-6665-4e10-bbd7-eb001f082f88', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013530B2F080>]}
[0m14:01:04.377582 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:01:04.388834 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:01:04.504931 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m14:01:04.505937 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m14:01:04.707693 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6ff97353-6665-4e10-bbd7-eb001f082f88', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013531B66390>]}
[0m14:01:04.719090 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6ff97353-6665-4e10-bbd7-eb001f082f88', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013531EA98B0>]}
[0m14:01:04.719090 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m14:01:04.719090 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6ff97353-6665-4e10-bbd7-eb001f082f88', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013531682A50>]}
[0m14:01:04.727654 [info ] [MainThread]: 
[0m14:01:04.727654 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m14:01:04.727654 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m14:01:04.751096 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:01:04.752085 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m14:01:04.753110 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:01:04.812074 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m14:01:04.813070 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:01:04.814072 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m14:01:04.823419 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m14:01:04.825418 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m14:01:04.826420 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m14:01:04.833234 [debug] [MainThread]: Using postgres connection "master"
[0m14:01:04.833234 [debug] [MainThread]: On master: BEGIN
[0m14:01:04.834236 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:01:04.883721 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m14:01:04.884722 [debug] [MainThread]: Using postgres connection "master"
[0m14:01:04.884722 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m14:01:04.894722 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m14:01:04.897720 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6ff97353-6665-4e10-bbd7-eb001f082f88', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013531EA92B0>]}
[0m14:01:04.897720 [debug] [MainThread]: On master: ROLLBACK
[0m14:01:04.899718 [debug] [MainThread]: On master: Close
[0m14:01:04.900723 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:01:04.902729 [info ] [MainThread]: 
[0m14:01:04.907722 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:01:04.908718 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m14:01:04.909723 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:01:04.931991 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m14:01:04.934993 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 14:01:04.910729 => 14:01:04.934008
[0m14:01:04.936986 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:01:04.937986 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 14:01:04.936986 => 14:01:04.936986
[0m14:01:04.940003 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:01:04.941005 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:01:04.942003 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m14:01:04.943004 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m14:01:04.944006 [debug] [MainThread]: Command end result
[0m14:01:04.956917 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
            ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
            UNION ALL SELECT ''Others''
            )
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        ),
        
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    
    categories_second AS (
            ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
            UNION ALL SELECT ''Others''
            )
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers_second r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        ),
        
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		), 
    
    
    categories_third AS (
            ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
            UNION ALL SELECT ''Others''
            )
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers_third r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        ),
        
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        )
        ,
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        )
        ,
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
    
[0m14:01:04.973623 [debug] [MainThread]: Command `dbt compile` succeeded at 14:01:04.973623 after 1.12 seconds
[0m14:01:04.975622 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000135319936B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000135319915B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013531992060>]}
[0m14:01:04.976624 [debug] [MainThread]: Flushing usage events
[0m14:05:36.308877 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B365E07410>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B365E07500>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B365E070B0>]}


============================== 14:05:36.313871 | 87e3d355-c71a-48c3-b757-f322c199d80e ==============================
[0m14:05:36.313871 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:05:36.316894 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'send_anonymous_usage_stats': 'True'}
[0m14:05:36.571995 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '87e3d355-c71a-48c3-b757-f322c199d80e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B3653276E0>]}
[0m14:05:36.826953 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '87e3d355-c71a-48c3-b757-f322c199d80e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B365D137A0>]}
[0m14:05:36.829058 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:05:36.858041 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:05:37.061072 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m14:05:37.067138 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m14:05:37.412438 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '87e3d355-c71a-48c3-b757-f322c199d80e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B365C4EC90>]}
[0m14:05:37.437188 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '87e3d355-c71a-48c3-b757-f322c199d80e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B3661B94C0>]}
[0m14:05:37.439239 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m14:05:37.439239 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '87e3d355-c71a-48c3-b757-f322c199d80e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B36628E1B0>]}
[0m14:05:37.439239 [info ] [MainThread]: 
[0m14:05:37.447280 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m14:05:37.452314 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m14:05:37.484744 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:05:37.485745 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m14:05:37.486746 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:05:37.558783 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m14:05:37.558783 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:05:37.558783 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m14:05:37.569926 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m14:05:37.569926 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m14:05:37.569926 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m14:05:37.579034 [debug] [MainThread]: Using postgres connection "master"
[0m14:05:37.587758 [debug] [MainThread]: On master: BEGIN
[0m14:05:37.588751 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:05:37.649751 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m14:05:37.650755 [debug] [MainThread]: Using postgres connection "master"
[0m14:05:37.651753 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m14:05:37.664756 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m14:05:37.668760 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '87e3d355-c71a-48c3-b757-f322c199d80e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B3661BB2F0>]}
[0m14:05:37.669749 [debug] [MainThread]: On master: ROLLBACK
[0m14:05:37.671753 [debug] [MainThread]: On master: Close
[0m14:05:37.673752 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:05:37.675760 [info ] [MainThread]: 
[0m14:05:37.684847 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:05:37.686839 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m14:05:37.687836 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:05:37.728848 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m14:05:37.732838 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 14:05:37.688835 => 14:05:37.731834
[0m14:05:37.733834 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:05:37.735837 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 14:05:37.734833 => 14:05:37.734833
[0m14:05:37.738834 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:05:37.740834 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:05:37.741835 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m14:05:37.742836 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m14:05:37.743836 [debug] [MainThread]: Command end result
[0m14:05:37.759834 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
            ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
            UNION ALL SELECT ''Others''
            )
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        ),
        
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    
    categories_second AS (
            ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
            UNION ALL SELECT ''Others''
            )
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers_second r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        ),
        
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		), 
    
    
    categories_third AS (
            ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
            UNION ALL SELECT ''Others''
            )
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers_third r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        ),
        
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
    
[0m14:05:37.775836 [debug] [MainThread]: Command `dbt compile` succeeded at 14:05:37.775836 after 1.68 seconds
[0m14:05:37.776838 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B365BEE9F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B365E07500>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B365E070B0>]}
[0m14:05:37.778870 [debug] [MainThread]: Flushing usage events
[0m14:07:36.011219 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FBA10F3F50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FBA10F3290>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FBA10F2DE0>]}


============================== 14:07:36.017219 | 8eb46a0b-7422-4e80-9648-b14096308e80 ==============================
[0m14:07:36.017219 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:07:36.020224 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m14:07:36.277772 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '8eb46a0b-7422-4e80-9648-b14096308e80', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FBA10D3DA0>]}
[0m14:07:36.404537 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '8eb46a0b-7422-4e80-9648-b14096308e80', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FBA0F1B950>]}
[0m14:07:36.406535 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:07:36.422535 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:07:36.519537 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m14:07:36.520537 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m14:07:36.733834 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '8eb46a0b-7422-4e80-9648-b14096308e80', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FBA16828D0>]}
[0m14:07:36.748185 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '8eb46a0b-7422-4e80-9648-b14096308e80', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FBA14874A0>]}
[0m14:07:36.748185 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m14:07:36.748185 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8eb46a0b-7422-4e80-9648-b14096308e80', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FBA16CDC40>]}
[0m14:07:36.748185 [info ] [MainThread]: 
[0m14:07:36.748185 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m14:07:36.757230 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m14:07:36.772030 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:07:36.772030 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m14:07:36.772030 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:07:36.827597 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m14:07:36.827597 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:07:36.827597 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m14:07:36.838732 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m14:07:36.838732 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m14:07:36.847791 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m14:07:36.847791 [debug] [MainThread]: Using postgres connection "master"
[0m14:07:36.856924 [debug] [MainThread]: On master: BEGIN
[0m14:07:36.857947 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:07:36.907658 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m14:07:36.907658 [debug] [MainThread]: Using postgres connection "master"
[0m14:07:36.907658 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m14:07:36.918123 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m14:07:36.918123 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8eb46a0b-7422-4e80-9648-b14096308e80', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FBA170B920>]}
[0m14:07:36.918123 [debug] [MainThread]: On master: ROLLBACK
[0m14:07:36.918123 [debug] [MainThread]: On master: Close
[0m14:07:36.918123 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:07:36.918123 [info ] [MainThread]: 
[0m14:07:36.929054 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:07:36.929054 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m14:07:36.929054 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:07:36.949653 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m14:07:36.957702 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 14:07:36.929054 => 14:07:36.957178
[0m14:07:36.957702 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:07:36.957702 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 14:07:36.957702 => 14:07:36.957702
[0m14:07:36.957702 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:07:36.957702 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:07:36.957702 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m14:07:36.957702 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m14:07:36.967874 [debug] [MainThread]: Command end result
[0m14:07:36.977558 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13_dbt_test`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
            ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
            UNION ALL SELECT ''Others''
            )
        ,
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        ),
        
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    
    categories_second AS (
            ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
            UNION ALL SELECT ''Others''
            )
        ,
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers_second r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        ),
        
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		), 
    
    
    categories_third AS (
            ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
            UNION ALL SELECT ''Others''
            )
        ,
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers_third r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        ),
        
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
    
[0m14:07:36.988730 [debug] [MainThread]: Command `dbt compile` succeeded at 14:07:36.988730 after 1.18 seconds
[0m14:07:36.994288 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FBA0B27830>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FBA10F3290>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FBA0F869F0>]}
[0m14:07:36.994288 [debug] [MainThread]: Flushing usage events
[0m14:09:29.357896 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002ADC60618E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002ADC6061940>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002ADC6063D70>]}


============================== 14:09:29.363895 | d0307440-60f8-4c41-a643-69dccd0913eb ==============================
[0m14:09:29.363895 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:09:29.365899 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m14:09:29.628606 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd0307440-60f8-4c41-a643-69dccd0913eb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002ADC60B9220>]}
[0m14:09:29.748606 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd0307440-60f8-4c41-a643-69dccd0913eb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002ADC6085430>]}
[0m14:09:29.748606 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:09:29.757760 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:09:29.879604 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m14:09:29.880606 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m14:09:30.086909 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd0307440-60f8-4c41-a643-69dccd0913eb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002ADC664E390>]}
[0m14:09:30.101921 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd0307440-60f8-4c41-a643-69dccd0913eb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002ADC64B9340>]}
[0m14:09:30.102922 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m14:09:30.104189 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd0307440-60f8-4c41-a643-69dccd0913eb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002ADC6407AD0>]}
[0m14:09:30.107227 [info ] [MainThread]: 
[0m14:09:30.108771 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m14:09:30.108771 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m14:09:30.127194 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:09:30.128221 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m14:09:30.129229 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:09:30.189191 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m14:09:30.189191 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:09:30.189191 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m14:09:30.207945 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m14:09:30.207945 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m14:09:30.207945 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m14:09:30.218924 [debug] [MainThread]: Using postgres connection "master"
[0m14:09:30.218924 [debug] [MainThread]: On master: BEGIN
[0m14:09:30.218924 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:09:30.279842 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m14:09:30.280844 [debug] [MainThread]: Using postgres connection "master"
[0m14:09:30.281842 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m14:09:30.292005 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m14:09:30.292005 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd0307440-60f8-4c41-a643-69dccd0913eb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002ADC64642F0>]}
[0m14:09:30.292005 [debug] [MainThread]: On master: ROLLBACK
[0m14:09:30.292005 [debug] [MainThread]: On master: Close
[0m14:09:30.297050 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:09:30.299087 [info ] [MainThread]: 
[0m14:09:30.299087 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:09:30.299087 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m14:09:30.307713 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:09:30.327713 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m14:09:30.327713 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 14:09:30.307713 => 14:09:30.327713
[0m14:09:30.327713 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:09:30.332224 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 14:09:30.332224 => 14:09:30.332224
[0m14:09:30.332224 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:09:30.332224 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:09:30.332224 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m14:09:30.337249 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m14:09:30.339597 [debug] [MainThread]: Command end result
[0m14:09:30.347699 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13_dbt_test`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
        ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
        UNION ALL SELECT ''Others''
        ),
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        ),
        
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    
    categories_second AS (
        ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
        UNION ALL SELECT ''Others''
        ),
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers_second r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        ),
        
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		), 
    
    
    categories_third AS (
        ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
        UNION ALL SELECT ''Others''
        ),
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers_third r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        ),
        
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
    
[0m14:09:30.358720 [debug] [MainThread]: Command `dbt compile` succeeded at 14:09:30.358720 after 1.21 seconds
[0m14:09:30.367302 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002ADC6061940>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002ADC6063D70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002ADC6063BC0>]}
[0m14:09:30.367831 [debug] [MainThread]: Flushing usage events
[0m14:12:33.185712 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011B58073020>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011B57F4D190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011B58073410>]}


============================== 14:12:33.189857 | 8f061a0d-eee0-4b77-a57f-df4241bdb8fa ==============================
[0m14:12:33.189857 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:12:33.189857 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m14:12:33.458859 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '8f061a0d-eee0-4b77-a57f-df4241bdb8fa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011B58341A60>]}
[0m14:12:33.578845 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '8f061a0d-eee0-4b77-a57f-df4241bdb8fa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011B581390D0>]}
[0m14:12:33.578845 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:12:33.587913 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:12:33.698147 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m14:12:33.699148 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m14:12:33.910842 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '8f061a0d-eee0-4b77-a57f-df4241bdb8fa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011B585F4050>]}
[0m14:12:33.924865 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '8f061a0d-eee0-4b77-a57f-df4241bdb8fa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011B584D99A0>]}
[0m14:12:33.925865 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m14:12:33.927974 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8f061a0d-eee0-4b77-a57f-df4241bdb8fa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011B585C1E20>]}
[0m14:12:33.930958 [info ] [MainThread]: 
[0m14:12:33.931958 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m14:12:33.933959 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m14:12:33.950974 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:12:33.951974 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m14:12:33.952974 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:12:34.009717 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m14:12:34.010722 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:12:34.011721 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m14:12:34.020720 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m14:12:34.022718 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m14:12:34.023719 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m14:12:34.029857 [debug] [MainThread]: Using postgres connection "master"
[0m14:12:34.030856 [debug] [MainThread]: On master: BEGIN
[0m14:12:34.030856 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:12:34.078182 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m14:12:34.078182 [debug] [MainThread]: Using postgres connection "master"
[0m14:12:34.078182 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m14:12:34.088728 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m14:12:34.088728 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8f061a0d-eee0-4b77-a57f-df4241bdb8fa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011B584DB380>]}
[0m14:12:34.088728 [debug] [MainThread]: On master: ROLLBACK
[0m14:12:34.097787 [debug] [MainThread]: On master: Close
[0m14:12:34.097787 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:12:34.097787 [info ] [MainThread]: 
[0m14:12:34.097787 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:12:34.107938 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m14:12:34.109023 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:12:34.130844 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m14:12:34.132842 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 14:12:34.109023 => 14:12:34.131846
[0m14:12:34.133842 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:12:34.135842 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 14:12:34.134844 => 14:12:34.134844
[0m14:12:34.137867 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:12:34.139863 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:12:34.141863 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m14:12:34.141863 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m14:12:34.142862 [debug] [MainThread]: Command end result
[0m14:12:34.155840 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13_dbt_test`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
        ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
        UNION ALL SELECT ''Others''
        ),
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        ),
        
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    
    categories_second AS (
        ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
        UNION ALL SELECT ''Others''
        ),
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers_second r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        ),
        
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		), 
    
    
    categories_third AS (
        ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
        UNION ALL SELECT ''Others''
        ),
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers_third r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        ),
        
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
    
[0m14:12:34.176435 [debug] [MainThread]: Command `dbt compile` succeeded at 14:12:34.175434 after 1.19 seconds
[0m14:12:34.177435 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011B57CACA70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011B5809BA40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011B57E0CBF0>]}
[0m14:12:34.179599 [debug] [MainThread]: Flushing usage events
[0m14:16:39.842691 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C2709F3860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C2709F3B00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C2709F30E0>]}


============================== 14:16:39.847689 | 0cd8161a-76c9-461d-826a-5107a5bbd7ad ==============================
[0m14:16:39.847689 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:16:39.849920 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m14:16:40.117912 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0cd8161a-76c9-461d-826a-5107a5bbd7ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C270B57860>]}
[0m14:16:40.240579 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0cd8161a-76c9-461d-826a-5107a5bbd7ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C270A48620>]}
[0m14:16:40.242599 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:16:40.256631 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:16:40.370754 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m14:16:40.371761 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m14:16:40.575092 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0cd8161a-76c9-461d-826a-5107a5bbd7ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C270FAE390>]}
[0m14:16:40.590060 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0cd8161a-76c9-461d-826a-5107a5bbd7ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C270D678C0>]}
[0m14:16:40.591059 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m14:16:40.593062 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0cd8161a-76c9-461d-826a-5107a5bbd7ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C270A9B0E0>]}
[0m14:16:40.595059 [info ] [MainThread]: 
[0m14:16:40.596057 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m14:16:40.598846 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m14:16:40.615861 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:16:40.616869 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m14:16:40.619140 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:16:40.677210 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m14:16:40.677210 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:16:40.678620 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m14:16:40.687581 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m14:16:40.689583 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m14:16:40.690583 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m14:16:40.697584 [debug] [MainThread]: Using postgres connection "master"
[0m14:16:40.697584 [debug] [MainThread]: On master: BEGIN
[0m14:16:40.698957 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:16:40.748790 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m14:16:40.749792 [debug] [MainThread]: Using postgres connection "master"
[0m14:16:40.750789 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m14:16:40.760789 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m14:16:40.762789 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0cd8161a-76c9-461d-826a-5107a5bbd7ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C270FD3C50>]}
[0m14:16:40.763790 [debug] [MainThread]: On master: ROLLBACK
[0m14:16:40.764789 [debug] [MainThread]: On master: Close
[0m14:16:40.765791 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:16:40.768794 [info ] [MainThread]: 
[0m14:16:40.772787 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:16:40.774791 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m14:16:40.774791 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:16:40.795800 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m14:16:40.797797 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 14:16:40.775793 => 14:16:40.796802
[0m14:16:40.798883 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:16:40.800843 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 14:16:40.799800 => 14:16:40.799800
[0m14:16:40.802806 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:16:40.805797 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:16:40.805797 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m14:16:40.806797 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m14:16:40.807798 [debug] [MainThread]: Command end result
[0m14:16:40.820797 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13_dbt_test`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
        ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
        UNION ALL SELECT ''Others''
        ),
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        ),
        
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_first, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    
    categories_second AS (
        ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
        UNION ALL SELECT ''Others''
        ),
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        ),
        
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		), 
    
    
    categories_third AS (
        ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
        UNION ALL SELECT ''Others''
        ),
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        ),
        
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_third, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
    
[0m14:16:40.841924 [debug] [MainThread]: Command `dbt compile` succeeded at 14:16:40.841924 after 1.21 seconds
[0m14:16:40.843918 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C27092C380>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C270466570>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C2709D3EC0>]}
[0m14:16:40.844919 [debug] [MainThread]: Flushing usage events
[0m14:47:54.201839 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015773036AE0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015773037A70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015773037530>]}


============================== 14:47:54.210519 | 8ca0df5c-67c2-4b77-a821-62c20626945d ==============================
[0m14:47:54.210519 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:47:54.212537 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'send_anonymous_usage_stats': 'True'}
[0m14:47:54.499852 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '8ca0df5c-67c2-4b77-a821-62c20626945d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015772EC5250>]}
[0m14:47:54.621929 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '8ca0df5c-67c2-4b77-a821-62c20626945d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015773088D40>]}
[0m14:47:54.623928 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:47:54.639434 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:47:54.761886 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m14:47:54.763897 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m14:47:55.010643 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '8ca0df5c-67c2-4b77-a821-62c20626945d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015773306210>]}
[0m14:47:55.037172 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '8ca0df5c-67c2-4b77-a821-62c20626945d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000157733D96D0>]}
[0m14:47:55.039172 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m14:47:55.041178 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8ca0df5c-67c2-4b77-a821-62c20626945d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015773088A10>]}
[0m14:47:55.045172 [info ] [MainThread]: 
[0m14:47:55.048172 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m14:47:55.053193 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m14:47:55.082802 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:47:55.083803 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m14:47:55.084842 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:47:55.156799 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m14:47:55.157801 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:47:55.158802 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m14:47:55.188914 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m14:47:55.188914 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m14:47:55.188914 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m14:47:55.197984 [debug] [MainThread]: Using postgres connection "master"
[0m14:47:55.197984 [debug] [MainThread]: On master: BEGIN
[0m14:47:55.197984 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:47:55.257642 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m14:47:55.258643 [debug] [MainThread]: Using postgres connection "master"
[0m14:47:55.258643 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m14:47:55.273180 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m14:47:55.275182 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8ca0df5c-67c2-4b77-a821-62c20626945d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000157731A69C0>]}
[0m14:47:55.276180 [debug] [MainThread]: On master: ROLLBACK
[0m14:47:55.277182 [debug] [MainThread]: On master: Close
[0m14:47:55.278582 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:47:55.280607 [info ] [MainThread]: 
[0m14:47:55.286957 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:47:55.287955 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m14:47:55.288956 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:47:55.310956 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m14:47:55.312957 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 14:47:55.289958 => 14:47:55.311955
[0m14:47:55.313960 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:47:55.314958 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 14:47:55.314958 => 14:47:55.314958
[0m14:47:55.317992 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:47:55.319983 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:47:55.320989 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m14:47:55.320989 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m14:47:55.322985 [debug] [MainThread]: Command end result
[0m14:47:55.334933 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13_dbt_test`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
        ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
        UNION ALL SELECT ''Others''
        ),
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',tag_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        ),
        
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN userneeds IN (', tag_statement_first, ') THEN  userneeds
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    
    categories_second AS (
        ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
        UNION ALL SELECT ''Others''
        ),
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_second, ', "Others")
        ),
        
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_second, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_second, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		), 
    
    
    categories_third AS (
        ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
        UNION ALL SELECT ''Others''
        ),
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',tag_statement_third, ', "Others")
        ),
        
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Tags IN (', tag_statement_third, ') THEN  Tags
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_third, ') THEN UserNeeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', tag_statement_third, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
    
[0m14:47:55.347281 [debug] [MainThread]: Command `dbt compile` succeeded at 14:47:55.346280 after 1.36 seconds
[0m14:47:55.348303 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015772EC56A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015772EC4A70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015773013B60>]}
[0m14:47:55.350831 [debug] [MainThread]: Flushing usage events
[0m17:04:48.558821 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000222F3A27470>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000222F3A26F30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000222F3A26F60>]}


============================== 17:04:48.565804 | 2fac2d97-7d1d-4b06-b794-9a977da1152e ==============================
[0m17:04:48.565804 [info ] [MainThread]: Running with dbt=1.7.13
[0m17:04:48.568806 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'send_anonymous_usage_stats': 'True'}
[0m17:04:48.838338 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2fac2d97-7d1d-4b06-b794-9a977da1152e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000222F3A79070>]}
[0m17:04:48.948635 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2fac2d97-7d1d-4b06-b794-9a977da1152e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000222F346CC20>]}
[0m17:04:48.948635 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m17:04:48.964278 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m17:04:49.091652 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:04:49.092653 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m17:04:49.294749 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2fac2d97-7d1d-4b06-b794-9a977da1152e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000222F3C0C260>]}
[0m17:04:49.309994 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2fac2d97-7d1d-4b06-b794-9a977da1152e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000222F3E49940>]}
[0m17:04:49.311999 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m17:04:49.314001 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2fac2d97-7d1d-4b06-b794-9a977da1152e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000222F3E48140>]}
[0m17:04:49.315993 [info ] [MainThread]: 
[0m17:04:49.317996 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m17:04:49.320006 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m17:04:49.335993 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:04:49.336995 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m17:04:49.338001 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:04:49.411059 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m17:04:49.412066 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:04:49.412066 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m17:04:49.444604 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m17:04:49.446616 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m17:04:49.447903 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m17:04:49.455914 [debug] [MainThread]: Using postgres connection "master"
[0m17:04:49.456915 [debug] [MainThread]: On master: BEGIN
[0m17:04:49.457915 [debug] [MainThread]: Opening a new connection, currently in state init
[0m17:04:49.508916 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m17:04:49.509920 [debug] [MainThread]: Using postgres connection "master"
[0m17:04:49.510917 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m17:04:49.524769 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m17:04:49.526770 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2fac2d97-7d1d-4b06-b794-9a977da1152e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000222F3E4BC50>]}
[0m17:04:49.527769 [debug] [MainThread]: On master: ROLLBACK
[0m17:04:49.528770 [debug] [MainThread]: On master: Close
[0m17:04:49.529772 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:04:49.531777 [info ] [MainThread]: 
[0m17:04:49.537997 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m17:04:49.539005 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m17:04:49.539996 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m17:04:49.560995 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m17:04:49.562998 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 17:04:49.540996 => 17:04:49.561996
[0m17:04:49.563998 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m17:04:49.564996 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 17:04:49.564996 => 17:04:49.564996
[0m17:04:49.566999 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m17:04:49.569003 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:04:49.570007 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m17:04:49.571006 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m17:04:49.571995 [debug] [MainThread]: Command end result
[0m17:04:49.585009 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13_dbt_test`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
        ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
        UNION ALL SELECT ''Others''
        ),
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',order_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        ),
        
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN userneeds IN (', tag_statement_first, ') THEN  userneeds
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN {0: 'userneeds', 1: 'Categories', 2: 'Tags'} IN (',  tag_statement_first, ') THEN userneeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    
    categories_second AS (
        ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
        UNION ALL SELECT ''Others''
        ),
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN {0: 'userneeds', 1: 'Categories', 2: 'Tags'} IN (',  tag_statement_second, ') THEN Categories
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		), 
    
    
    categories_third AS (
        ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
        UNION ALL SELECT ''Others''
        ),
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Tags IN (', tag_statement_third, ') THEN  Tags
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN {0: 'userneeds', 1: 'Categories', 2: 'Tags'} IN (',  tag_statement_third, ') THEN Tags
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
    
[0m17:04:49.598997 [debug] [MainThread]: Command `dbt compile` succeeded at 17:04:49.598997 after 1.24 seconds
[0m17:04:49.600996 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000222F37D9DC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000222F35E9DF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000222ED550620>]}
[0m17:04:49.602004 [debug] [MainThread]: Flushing usage events
[0m17:07:41.876481 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000156B8A57B00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000156B8A57830>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000156B8A57320>]}


============================== 17:07:41.876481 | 1935259b-f38b-4893-ae9c-4128993a02bb ==============================
[0m17:07:41.876481 [info ] [MainThread]: Running with dbt=1.7.13
[0m17:07:41.876481 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m17:07:42.146358 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1935259b-f38b-4893-ae9c-4128993a02bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000156B8AA8650>]}
[0m17:07:42.264359 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1935259b-f38b-4893-ae9c-4128993a02bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000156B8B39EB0>]}
[0m17:07:42.266362 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m17:07:42.278362 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m17:07:42.378851 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:07:42.378851 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m17:07:42.593119 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1935259b-f38b-4893-ae9c-4128993a02bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000156B8D21070>]}
[0m17:07:42.608119 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1935259b-f38b-4893-ae9c-4128993a02bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000156B8DF9820>]}
[0m17:07:42.609118 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m17:07:42.610118 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1935259b-f38b-4893-ae9c-4128993a02bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000156B8ECE570>]}
[0m17:07:42.613117 [info ] [MainThread]: 
[0m17:07:42.615119 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m17:07:42.617123 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m17:07:42.632230 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:07:42.633242 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m17:07:42.633242 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:07:42.687344 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m17:07:42.688342 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:07:42.689344 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m17:07:42.697342 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m17:07:42.699348 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m17:07:42.700347 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m17:07:42.709346 [debug] [MainThread]: Using postgres connection "master"
[0m17:07:42.710342 [debug] [MainThread]: On master: BEGIN
[0m17:07:42.710342 [debug] [MainThread]: Opening a new connection, currently in state init
[0m17:07:42.759349 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m17:07:42.759349 [debug] [MainThread]: Using postgres connection "master"
[0m17:07:42.760344 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m17:07:42.770341 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m17:07:42.772345 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1935259b-f38b-4893-ae9c-4128993a02bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000156B8DFB650>]}
[0m17:07:42.773349 [debug] [MainThread]: On master: ROLLBACK
[0m17:07:42.774369 [debug] [MainThread]: On master: Close
[0m17:07:42.775344 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:07:42.776344 [info ] [MainThread]: 
[0m17:07:42.781342 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m17:07:42.782344 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m17:07:42.783343 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m17:07:42.803343 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m17:07:42.805346 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 17:07:42.783343 => 17:07:42.804344
[0m17:07:42.806344 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m17:07:42.808343 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 17:07:42.807343 => 17:07:42.807343
[0m17:07:42.810346 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m17:07:42.811342 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:07:42.812343 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m17:07:42.813343 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m17:07:42.814343 [debug] [MainThread]: Command end result
[0m17:07:42.826344 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13_dbt_test`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
        ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
        UNION ALL SELECT ''Others''
        ),
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',order_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        ),
        
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN userneeds IN (', tag_statement_first, ') THEN  userneeds
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN userneeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    
    categories_second AS (
        ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
        UNION ALL SELECT ''Others''
        ),
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN Categories IN (',  tag_statement_second, ') THEN Categories
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		), 
    
    
    categories_third AS (
        ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
        UNION ALL SELECT ''Others''
        ),
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Tags IN (', tag_statement_third, ') THEN  Tags
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN Tags IN (',  tag_statement_third, ') THEN Tags
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
    
[0m17:07:42.836343 [debug] [MainThread]: Command `dbt compile` succeeded at 17:07:42.836343 after 1.15 seconds
[0m17:07:42.837341 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000156B886E9F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000156B8A56B10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000156B8A57B00>]}
[0m17:07:42.838343 [debug] [MainThread]: Flushing usage events
[0m17:17:43.429397 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ACE7403770>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ACE7401970>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ACE7403B60>]}


============================== 17:17:43.445026 | 3385e55d-927c-4a59-8533-4e67e26e3b84 ==============================
[0m17:17:43.445026 [info ] [MainThread]: Running with dbt=1.7.13
[0m17:17:43.445026 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt compile -s pageview_weeks_dummy_2_3__site__13', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:17:43.699080 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3385e55d-927c-4a59-8533-4e67e26e3b84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ACE74AB290>]}
[0m17:17:43.821271 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3385e55d-927c-4a59-8533-4e67e26e3b84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ACE71E8620>]}
[0m17:17:43.823270 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m17:17:43.844278 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m17:17:43.984903 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m17:17:43.984903 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m17:17:44.000532 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3385e55d-927c-4a59-8533-4e67e26e3b84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ACE76ADF10>]}
[0m17:17:44.031784 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3385e55d-927c-4a59-8533-4e67e26e3b84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ACE77E94F0>]}
[0m17:17:44.031784 [info ] [MainThread]: Found 4 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m17:17:44.031784 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3385e55d-927c-4a59-8533-4e67e26e3b84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ACE74E6540>]}
[0m17:17:44.031784 [info ] [MainThread]: 
[0m17:17:44.031784 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m17:17:44.051107 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m17:17:44.087099 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:17:44.089095 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m17:17:44.090094 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:17:44.148093 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m17:17:44.149094 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:17:44.150093 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m17:17:44.159093 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m17:17:44.161093 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m17:17:44.162093 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m17:17:44.170092 [debug] [MainThread]: Using postgres connection "master"
[0m17:17:44.171093 [debug] [MainThread]: On master: BEGIN
[0m17:17:44.172094 [debug] [MainThread]: Opening a new connection, currently in state init
[0m17:17:44.221132 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m17:17:44.222096 [debug] [MainThread]: Using postgres connection "master"
[0m17:17:44.223096 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m17:17:44.233091 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m17:17:44.235094 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3385e55d-927c-4a59-8533-4e67e26e3b84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ACE77EB140>]}
[0m17:17:44.236095 [debug] [MainThread]: On master: ROLLBACK
[0m17:17:44.237094 [debug] [MainThread]: On master: Close
[0m17:17:44.239099 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:17:44.240095 [info ] [MainThread]: 
[0m17:17:44.245097 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m17:17:44.247097 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m17:17:44.248101 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m17:17:44.270094 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m17:17:44.272093 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 17:17:44.248101 => 17:17:44.272093
[0m17:17:44.274096 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m17:17:44.275094 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 17:17:44.275094 => 17:17:44.275094
[0m17:17:44.278100 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m17:17:44.280096 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:17:44.281099 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m17:17:44.281099 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13' was properly closed.
[0m17:17:44.282097 [debug] [MainThread]: Command end result
[0m17:17:44.294095 [info ] [MainThread]: Compiled node 'pageview_weeks_dummy_2_3__site__13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `prod`.`pageview_weeks_dummy_2_3__site__13_dbt_test`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
        ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
        UNION ALL SELECT ''Others''
        ),
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',order_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        ),
        
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN userneeds IN (', tag_statement_first, ') THEN  userneeds
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN userneeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    
    categories_second AS (
        ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
        UNION ALL SELECT ''Others''
        ),
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN Categories IN (',  tag_statement_second, ') THEN Categories
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		), 
    
    
    categories_third AS (
        ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
        UNION ALL SELECT ''Others''
        ),
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Tags IN (', tag_statement_third, ') THEN  Tags
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN Tags IN (',  tag_statement_third, ') THEN Tags
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
    
[0m17:17:44.314052 [debug] [MainThread]: Command `dbt compile` succeeded at 17:17:44.313054 after 1.07 seconds
[0m17:17:44.315058 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ACE6977830>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ACE7061DC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ACE724CA70>]}
[0m17:17:44.317058 [debug] [MainThread]: Flushing usage events
[0m14:18:07.146250 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000133092A2240>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000133092A3170>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000133092A3A70>]}


============================== 14:18:07.152246 | 814b37b4-3639-4b46-90a2-d6d93eead754 ==============================
[0m14:18:07.152246 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:18:07.154256 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m14:18:07.520249 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '814b37b4-3639-4b46-90a2-d6d93eead754', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000133092F86E0>]}
[0m14:18:07.715248 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '814b37b4-3639-4b46-90a2-d6d93eead754', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013309369610>]}
[0m14:18:07.717246 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:18:07.742246 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:18:08.940805 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m14:18:08.941801 [debug] [MainThread]: Partial parsing: added file: dbt_project_test_kasper://models\pageview_month_13.sql
[0m14:18:09.182795 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '814b37b4-3639-4b46-90a2-d6d93eead754', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000133098C2360>]}
[0m14:18:09.216800 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '814b37b4-3639-4b46-90a2-d6d93eead754', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000133096B9790>]}
[0m14:18:09.217797 [info ] [MainThread]: Found 5 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m14:18:09.219817 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '814b37b4-3639-4b46-90a2-d6d93eead754', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001330908A120>]}
[0m14:18:09.225796 [info ] [MainThread]: 
[0m14:18:09.227799 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m14:18:09.231799 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m14:18:09.250795 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:18:09.251797 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m14:18:09.252797 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:18:09.349795 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m14:18:09.350798 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:18:09.351801 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m14:18:09.410799 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m14:18:09.413797 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m14:18:09.415797 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m14:18:09.425818 [debug] [MainThread]: Using postgres connection "master"
[0m14:18:09.426800 [debug] [MainThread]: On master: BEGIN
[0m14:18:09.427798 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:18:09.487799 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m14:18:09.488797 [debug] [MainThread]: Using postgres connection "master"
[0m14:18:09.490797 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m14:18:09.508794 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m14:18:09.511795 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '814b37b4-3639-4b46-90a2-d6d93eead754', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000133096BB8F0>]}
[0m14:18:09.512795 [debug] [MainThread]: On master: ROLLBACK
[0m14:18:09.513797 [debug] [MainThread]: On master: Close
[0m14:18:09.515796 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:18:09.516797 [info ] [MainThread]: 
[0m14:18:09.524798 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_month_13
[0m14:18:09.525798 [debug] [Thread-2 (]: Began running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:18:09.527797 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_month_13'
[0m14:18:09.530801 [debug] [Thread-2 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13'
[0m14:18:09.531799 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_month_13
[0m14:18:09.533797 [debug] [Thread-2 (]: Began compiling node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:18:09.554795 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_month_13"
[0m14:18:09.578796 [debug] [Thread-2 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13"
[0m14:18:09.580801 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_month_13 (compile): 14:18:09.533797 => 14:18:09.579799
[0m14:18:09.582800 [debug] [Thread-2 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (compile): 14:18:09.556863 => 14:18:09.581798
[0m14:18:09.583799 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_month_13
[0m14:18:09.584797 [debug] [Thread-2 (]: Began executing node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:18:09.586798 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_month_13 (execute): 14:18:09.585801 => 14:18:09.585801
[0m14:18:09.588802 [debug] [Thread-2 (]: Timing info for model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13 (execute): 14:18:09.587799 => 14:18:09.587799
[0m14:18:09.590795 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_month_13
[0m14:18:09.593799 [debug] [Thread-2 (]: Finished running node model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13
[0m14:18:09.593799 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m14:18:09.595797 [debug] [Thread-2 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_dropdown_dbt_test
[0m14:18:09.596796 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.dbt_project_test_kasper.pageview_month_13, now model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13)
[0m14:18:09.598797 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly model.dbt_project_test_kasper.pageview_weeks_dummy_2_3__site__13, now model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_dropdown_dbt_test)
[0m14:18:09.599797 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m14:18:09.600797 [debug] [Thread-2 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_dropdown_dbt_test
[0m14:18:09.628798 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13"
[0m14:18:09.649794 [debug] [Thread-2 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_dropdown_dbt_test"
[0m14:18:09.651798 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (compile): 14:18:09.601797 => 14:18:09.651798
[0m14:18:09.653798 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m14:18:09.654797 [debug] [Thread-2 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_dropdown_dbt_test (compile): 14:18:09.629797 => 14:18:09.653798
[0m14:18:09.656800 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13 (execute): 14:18:09.655797 => 14:18:09.655797
[0m14:18:09.657804 [debug] [Thread-2 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_dropdown_dbt_test
[0m14:18:09.660798 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13
[0m14:18:09.663799 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.test
[0m14:18:09.662798 [debug] [Thread-2 (]: Timing info for model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_dropdown_dbt_test (execute): 14:18:09.661797 => 14:18:09.661797
[0m14:18:09.665799 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_13, now model.dbt_project_test_kasper.test)
[0m14:18:09.668798 [debug] [Thread-2 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_dropdown_dbt_test
[0m14:18:09.670802 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.test
[0m14:18:09.716799 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.test"
[0m14:18:09.718800 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (compile): 14:18:09.671800 => 14:18:09.717802
[0m14:18:09.719799 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.test
[0m14:18:09.721804 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.test (execute): 14:18:09.720798 => 14:18:09.720798
[0m14:18:09.724798 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.test
[0m14:18:09.727802 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:18:09.729802 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m14:18:09.730801 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.test' was properly closed.
[0m14:18:09.731799 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_dropdown_dbt_test' was properly closed.
[0m14:18:09.735795 [debug] [MainThread]: Command end result
[0m14:18:09.755799 [debug] [MainThread]: Command `dbt compile` succeeded at 14:18:09.754799 after 2.82 seconds
[0m14:18:09.756798 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001330908A390>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000133098D7BC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000133098F56D0>]}
[0m14:18:09.757801 [debug] [MainThread]: Flushing usage events
[0m14:18:15.799209 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001883D2434A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001883D2415B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001883D243AA0>]}


============================== 14:18:15.805209 | 0915b74b-6123-4b4f-9c1e-8c30a558ac31 ==============================
[0m14:18:15.805209 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:18:15.806210 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --models pageview_month_13', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m14:18:16.115209 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0915b74b-6123-4b4f-9c1e-8c30a558ac31', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001883D2986B0>]}
[0m14:18:16.237208 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0915b74b-6123-4b4f-9c1e-8c30a558ac31', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001883C138050>]}
[0m14:18:16.240210 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:18:16.255209 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:18:16.386249 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m14:18:16.387247 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m14:18:16.397250 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0915b74b-6123-4b4f-9c1e-8c30a558ac31', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001883D5ABFB0>]}
[0m14:18:16.423252 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0915b74b-6123-4b4f-9c1e-8c30a558ac31', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001883D67C2F0>]}
[0m14:18:16.425257 [info ] [MainThread]: Found 5 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m14:18:16.429251 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0915b74b-6123-4b4f-9c1e-8c30a558ac31', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001883D67C1D0>]}
[0m14:18:16.437255 [info ] [MainThread]: 
[0m14:18:16.443254 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m14:18:16.446253 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper'
[0m14:18:16.465251 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper"
[0m14:18:16.467254 [debug] [ThreadPool]: On list_dbt_project_test_kasper: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper"} */

    select distinct nspname from pg_namespace
  
[0m14:18:16.468252 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:18:16.604256 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.0 seconds
[0m14:18:16.607246 [debug] [ThreadPool]: On list_dbt_project_test_kasper: Close
[0m14:18:16.610250 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m14:18:16.618248 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:18:16.619249 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m14:18:16.619249 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:18:16.698249 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m14:18:16.699257 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:18:16.700250 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m14:18:16.712248 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m14:18:16.715249 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m14:18:16.717249 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m14:18:16.725247 [debug] [MainThread]: Using postgres connection "master"
[0m14:18:16.726249 [debug] [MainThread]: On master: BEGIN
[0m14:18:16.727248 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:18:16.788249 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m14:18:16.790253 [debug] [MainThread]: Using postgres connection "master"
[0m14:18:16.791252 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m14:18:16.805247 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m14:18:16.807250 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0915b74b-6123-4b4f-9c1e-8c30a558ac31', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001883D5A9BB0>]}
[0m14:18:16.808251 [debug] [MainThread]: On master: ROLLBACK
[0m14:18:16.809249 [debug] [MainThread]: Using postgres connection "master"
[0m14:18:16.809249 [debug] [MainThread]: On master: BEGIN
[0m14:18:16.810252 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m14:18:16.811250 [debug] [MainThread]: On master: COMMIT
[0m14:18:16.812248 [debug] [MainThread]: Using postgres connection "master"
[0m14:18:16.813251 [debug] [MainThread]: On master: COMMIT
[0m14:18:16.814250 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m14:18:16.815250 [debug] [MainThread]: On master: Close
[0m14:18:16.817250 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:18:16.818252 [info ] [MainThread]: 
[0m14:18:16.825248 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_month_13
[0m14:18:16.826250 [info ] [Thread-1 (]: 1 of 1 START sql table model public.pageview_month_13 .......................... [RUN]
[0m14:18:16.829260 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_month_13'
[0m14:18:16.830250 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_month_13
[0m14:18:16.857245 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_month_13"
[0m14:18:16.859250 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_month_13 (compile): 14:18:16.831251 => 14:18:16.858246
[0m14:18:16.860250 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_month_13
[0m14:18:16.931247 [debug] [Thread-1 (]: Writing runtime sql for node "model.dbt_project_test_kasper.pageview_month_13"
[0m14:18:16.935252 [debug] [Thread-1 (]: Using postgres connection "model.dbt_project_test_kasper.pageview_month_13"
[0m14:18:16.936250 [debug] [Thread-1 (]: On model.dbt_project_test_kasper.pageview_month_13: BEGIN
[0m14:18:16.938248 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m14:18:17.009248 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m14:18:17.011250 [debug] [Thread-1 (]: Using postgres connection "model.dbt_project_test_kasper.pageview_month_13"
[0m14:18:17.012251 [debug] [Thread-1 (]: On model.dbt_project_test_kasper.pageview_month_13: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "node_id": "model.dbt_project_test_kasper.pageview_month_13"} */

  
    

  create  table "dbt_project_test_kasper"."public"."pageview_month_13__dbt_tmp"
  
  
    as
  
  (
    
CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`pageview_month_13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
  );
  
[0m14:18:17.017252 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near "CREATE"
LINE 13: CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`pageview_month_...
         ^

[0m14:18:17.019251 [debug] [Thread-1 (]: On model.dbt_project_test_kasper.pageview_month_13: ROLLBACK
[0m14:18:17.021249 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_month_13 (execute): 14:18:16.861248 => 14:18:17.020250
[0m14:18:17.022247 [debug] [Thread-1 (]: On model.dbt_project_test_kasper.pageview_month_13: Close
[0m14:18:17.249288 [debug] [Thread-1 (]: Database Error in model pageview_month_13 (models\pageview_month_13.sql)
  syntax error at or near "CREATE"
  LINE 13: CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`pageview_month_...
           ^
  compiled Code at target\run\dbt_project_test_kasper\models\pageview_month_13.sql
[0m14:18:17.252248 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0915b74b-6123-4b4f-9c1e-8c30a558ac31', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001883D62E7E0>]}
[0m14:18:17.254252 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model public.pageview_month_13 ................. [[31mERROR[0m in 0.43s]
[0m14:18:17.257261 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_month_13
[0m14:18:17.262253 [debug] [MainThread]: Using postgres connection "master"
[0m14:18:17.263249 [debug] [MainThread]: On master: BEGIN
[0m14:18:17.265258 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m14:18:17.359249 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m14:18:17.360267 [debug] [MainThread]: On master: COMMIT
[0m14:18:17.361245 [debug] [MainThread]: Using postgres connection "master"
[0m14:18:17.362248 [debug] [MainThread]: On master: COMMIT
[0m14:18:17.364251 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m14:18:17.365249 [debug] [MainThread]: On master: Close
[0m14:18:17.367252 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:18:17.369250 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper' was properly closed.
[0m14:18:17.370249 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m14:18:17.371250 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_month_13' was properly closed.
[0m14:18:17.372251 [info ] [MainThread]: 
[0m14:18:17.373250 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 0.93 seconds (0.93s).
[0m14:18:17.376259 [debug] [MainThread]: Command end result
[0m14:18:17.400262 [info ] [MainThread]: 
[0m14:18:17.404252 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m14:18:17.407283 [info ] [MainThread]: 
[0m14:18:17.410251 [error] [MainThread]:   Database Error in model pageview_month_13 (models\pageview_month_13.sql)
  syntax error at or near "CREATE"
  LINE 13: CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`pageview_month_...
           ^
  compiled Code at target\run\dbt_project_test_kasper\models\pageview_month_13.sql
[0m14:18:17.412249 [info ] [MainThread]: 
[0m14:18:17.415282 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m14:18:17.423255 [debug] [MainThread]: Command `dbt run` failed at 14:18:17.422252 after 1.76 seconds
[0m14:18:17.429251 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001883D25BFE0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001883D223DD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001883D06B950>]}
[0m14:18:17.433261 [debug] [MainThread]: Flushing usage events
[0m14:23:56.798645 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020244E52C90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020244E52DB0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020244E52A20>]}


============================== 14:23:56.804644 | 4734d5de-0025-4463-b39e-c68bf6974712 ==============================
[0m14:23:56.804644 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:23:56.805644 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt compile -s pageview_month_13', 'send_anonymous_usage_stats': 'True'}
[0m14:23:57.102647 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4734d5de-0025-4463-b39e-c68bf6974712', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020244EA8860>]}
[0m14:23:57.274644 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4734d5de-0025-4463-b39e-c68bf6974712', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020244EA85C0>]}
[0m14:23:57.283644 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:23:57.320649 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:23:57.436644 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m14:23:57.437650 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m14:23:57.449643 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4734d5de-0025-4463-b39e-c68bf6974712', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020244BF1A60>]}
[0m14:23:57.470647 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4734d5de-0025-4463-b39e-c68bf6974712', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202452481A0>]}
[0m14:23:57.472649 [info ] [MainThread]: Found 5 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m14:23:57.474647 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4734d5de-0025-4463-b39e-c68bf6974712', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020244C3E0C0>]}
[0m14:23:57.477648 [info ] [MainThread]: 
[0m14:23:57.480685 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m14:23:57.483647 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m14:23:57.501646 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:23:57.502691 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m14:23:57.503649 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:23:57.566644 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m14:23:57.567646 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:23:57.568646 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m14:23:57.576643 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m14:23:57.578645 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m14:23:57.580644 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m14:23:57.588644 [debug] [MainThread]: Using postgres connection "master"
[0m14:23:57.589646 [debug] [MainThread]: On master: BEGIN
[0m14:23:57.590656 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:23:57.640645 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m14:23:57.641645 [debug] [MainThread]: Using postgres connection "master"
[0m14:23:57.643647 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m14:23:57.654643 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m14:23:57.656646 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4734d5de-0025-4463-b39e-c68bf6974712', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000202451F0770>]}
[0m14:23:57.657647 [debug] [MainThread]: On master: ROLLBACK
[0m14:23:57.658649 [debug] [MainThread]: On master: Close
[0m14:23:57.660646 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:23:57.662646 [info ] [MainThread]: 
[0m14:23:57.667643 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_month_13
[0m14:23:57.668645 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_month_13'
[0m14:23:57.669643 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_month_13
[0m14:23:57.691645 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_month_13"
[0m14:23:57.693648 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_month_13 (compile): 14:23:57.669643 => 14:23:57.692645
[0m14:23:57.694646 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_month_13
[0m14:23:57.695647 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_month_13 (execute): 14:23:57.695647 => 14:23:57.695647
[0m14:23:57.697646 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_month_13
[0m14:23:57.699644 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:23:57.700644 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m14:23:57.701645 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_month_13' was properly closed.
[0m14:23:57.702645 [debug] [MainThread]: Command end result
[0m14:23:57.713648 [info ] [MainThread]: Compiled node 'pageview_month_13' is:

CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`pageview_month_13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
[0m14:23:57.716649 [debug] [MainThread]: Command `dbt compile` succeeded at 14:23:57.715650 after 1.11 seconds
[0m14:23:57.717647 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020241F55280>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002023E815520>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020244E6BB30>]}
[0m14:23:57.718648 [debug] [MainThread]: Flushing usage events
[0m14:27:17.245497 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E4042D3EC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E4042D3980>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E4042D1C40>]}


============================== 14:27:17.250493 | 86b70123-5b13-4f37-9d6c-9131ce00df3c ==============================
[0m14:27:17.250493 [info ] [MainThread]: Running with dbt=1.7.13
[0m14:27:17.251494 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt compile -s pageview_month_13', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m14:27:17.538613 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '86b70123-5b13-4f37-9d6c-9131ce00df3c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E404328B00>]}
[0m14:27:17.654615 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '86b70123-5b13-4f37-9d6c-9131ce00df3c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E4041D03B0>]}
[0m14:27:17.657614 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m14:27:17.669615 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m14:27:17.762616 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m14:27:17.762616 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_month_13.sql
[0m14:27:18.126614 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '86b70123-5b13-4f37-9d6c-9131ce00df3c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E4048BEF90>]}
[0m14:27:18.140616 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '86b70123-5b13-4f37-9d6c-9131ce00df3c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E4046CD9A0>]}
[0m14:27:18.141614 [info ] [MainThread]: Found 5 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m14:27:18.143614 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '86b70123-5b13-4f37-9d6c-9131ce00df3c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E4048C50D0>]}
[0m14:27:18.145613 [info ] [MainThread]: 
[0m14:27:18.147615 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m14:27:18.149613 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m14:27:18.165611 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:27:18.165611 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m14:27:18.166614 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:27:18.222614 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m14:27:18.222614 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m14:27:18.223612 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m14:27:18.232615 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m14:27:18.235614 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m14:27:18.236614 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m14:27:18.243612 [debug] [MainThread]: Using postgres connection "master"
[0m14:27:18.244613 [debug] [MainThread]: On master: BEGIN
[0m14:27:18.244613 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:27:18.302615 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m14:27:18.303614 [debug] [MainThread]: Using postgres connection "master"
[0m14:27:18.304614 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m14:27:18.313613 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m14:27:18.315611 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '86b70123-5b13-4f37-9d6c-9131ce00df3c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E4044F4110>]}
[0m14:27:18.317613 [debug] [MainThread]: On master: ROLLBACK
[0m14:27:18.317613 [debug] [MainThread]: On master: Close
[0m14:27:18.319613 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:27:18.321614 [info ] [MainThread]: 
[0m14:27:18.325612 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_month_13
[0m14:27:18.326615 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_month_13'
[0m14:27:18.327615 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_month_13
[0m14:27:18.350616 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_month_13"
[0m14:27:18.352615 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_month_13 (compile): 14:27:18.328615 => 14:27:18.352615
[0m14:27:18.353617 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_month_13
[0m14:27:18.355614 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_month_13 (execute): 14:27:18.354616 => 14:27:18.354616
[0m14:27:18.357618 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_month_13
[0m14:27:18.359614 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:27:18.360615 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m14:27:18.361616 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_month_13' was properly closed.
[0m14:27:18.363617 [debug] [MainThread]: Command end result
[0m14:27:18.377612 [info ] [MainThread]: Compiled node 'pageview_month_13' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`pageview_month_13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
        ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
        UNION ALL SELECT ''Others''
        ),
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',order_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date date between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        ),
        
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN userneeds IN (', tag_statement_first, ') THEN  userneeds
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN userneeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    
    categories_second AS (
        ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
        UNION ALL SELECT ''Others''
        ),
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN Categories IN (',  tag_statement_second, ') THEN Categories
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_second
			group by label,cat,hint
		), 
    
    
    categories_third AS (
        ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
        UNION ALL SELECT ''Others''
        ),
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Tags IN (', tag_statement_third, ') THEN  Tags
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN Tags IN (',  tag_statement_third, ') THEN Tags
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data_third
			group by label,cat,hint
		)
    
[0m14:27:18.389626 [debug] [MainThread]: Command `dbt compile` succeeded at 14:27:18.388619 after 1.33 seconds
[0m14:27:18.390621 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E4042D3B30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E4042D3980>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E4042D1C40>]}
[0m14:27:18.391620 [debug] [MainThread]: Flushing usage events
[0m16:48:34.158123 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFDF0016D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFDEF13320>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFDF0031A0>]}


============================== 16:48:34.166122 | aba2effd-c603-403e-8637-50bb97bb26d0 ==============================
[0m16:48:34.166122 [info ] [MainThread]: Running with dbt=1.7.13
[0m16:48:34.169126 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s pageview_month_13', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:48:34.468123 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'aba2effd-c603-403e-8637-50bb97bb26d0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFDF029130>]}
[0m16:48:34.635122 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'aba2effd-c603-403e-8637-50bb97bb26d0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFDF028BC0>]}
[0m16:48:34.637122 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m16:48:34.653124 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m16:48:34.803210 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 2 files changed.
[0m16:48:34.804209 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_month_13.sql
[0m16:48:34.805211 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m16:48:35.094209 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'aba2effd-c603-403e-8637-50bb97bb26d0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFDF30B6E0>]}
[0m16:48:35.110211 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'aba2effd-c603-403e-8637-50bb97bb26d0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFDF3D80E0>]}
[0m16:48:35.111212 [info ] [MainThread]: Found 5 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m16:48:35.113224 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'aba2effd-c603-403e-8637-50bb97bb26d0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFDF5ABB90>]}
[0m16:48:35.119212 [info ] [MainThread]: 
[0m16:48:35.121211 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m16:48:35.123210 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m16:48:35.142209 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:48:35.143211 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m16:48:35.143211 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:48:35.224214 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m16:48:35.225212 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m16:48:35.226211 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m16:48:35.260211 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m16:48:35.264219 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m16:48:35.266217 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m16:48:35.279216 [debug] [MainThread]: Using postgres connection "master"
[0m16:48:35.281216 [debug] [MainThread]: On master: BEGIN
[0m16:48:35.282215 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:48:35.439210 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:48:35.440211 [debug] [MainThread]: Using postgres connection "master"
[0m16:48:35.441211 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m16:48:35.456208 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m16:48:35.460211 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'aba2effd-c603-403e-8637-50bb97bb26d0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFDEA86C00>]}
[0m16:48:35.461210 [debug] [MainThread]: On master: ROLLBACK
[0m16:48:35.462211 [debug] [MainThread]: On master: Close
[0m16:48:35.464213 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:48:35.466221 [info ] [MainThread]: 
[0m16:48:35.476209 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_month_13
[0m16:48:35.478221 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_month_13'
[0m16:48:35.479207 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_month_13
[0m16:48:35.506211 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_month_13"
[0m16:48:35.508211 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_month_13 (compile): 16:48:35.480207 => 16:48:35.507214
[0m16:48:35.509211 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_month_13
[0m16:48:35.510214 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_month_13 (execute): 16:48:35.510214 => 16:48:35.510214
[0m16:48:35.513212 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_month_13
[0m16:48:35.516211 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:48:35.517212 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m16:48:35.517212 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_month_13' was properly closed.
[0m16:48:35.519211 [debug] [MainThread]: Command end result
[0m16:48:35.532209 [info ] [MainThread]: Compiled node 'pageview_month_13' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`pageview_month_13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
        ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
        UNION ALL SELECT ''Others''
        ),
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',order_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date date between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        ),
        
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN userneeds IN (', tag_statement_first, ') THEN  userneeds
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN userneeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    
    categories_second AS (
        ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
        UNION ALL SELECT ''Others''
        ),
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN Categories IN (',  tag_statement_second, ') THEN Categories
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories_second,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile_second
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile_second, ''}''), '']'') AS series_second
			FROM pivoted_data_second
			group by label,cat_second,hint
		), 
    
    
    categories_third AS (
        ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
        UNION ALL SELECT ''Others''
        ),
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Tags IN (', tag_statement_third, ') THEN  Tags
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN Tags IN (',  tag_statement_third, ') THEN Tags
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories_third,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile_third
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile_third, ''}''), '']'') AS series_third
			FROM pivoted_data_third
			group by label,cat_third,hint
		)
    
[0m16:48:35.545214 [debug] [MainThread]: Command `dbt compile` succeeded at 16:48:35.545214 after 1.60 seconds
[0m16:48:35.546214 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFDE575640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFDEF13320>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFDEF116D0>]}
[0m16:48:35.548215 [debug] [MainThread]: Flushing usage events
[0m17:25:09.777818 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015A7F8903E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015A7F9913A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015A7F990200>]}


============================== 17:25:09.784115 | 73e89da1-13b3-450b-aff2-8671d3a10fe7 ==============================
[0m17:25:09.784115 [info ] [MainThread]: Running with dbt=1.7.13
[0m17:25:09.786135 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s pageview_month_13', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:25:10.084478 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '73e89da1-13b3-450b-aff2-8671d3a10fe7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015A7FC3D3D0>]}
[0m17:25:10.227482 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '73e89da1-13b3-450b-aff2-8671d3a10fe7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015A7F9BA840>]}
[0m17:25:10.229481 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m17:25:10.246480 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m17:25:10.388476 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 1 files changed.
[0m17:25:10.389477 [debug] [MainThread]: Partial parsing: added file: dbt_project_test_kasper://models\pageview_ytd_13.sql
[0m17:25:10.390480 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_month_13.sql
[0m17:25:10.762476 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '73e89da1-13b3-450b-aff2-8671d3a10fe7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015A0002BC50>]}
[0m17:25:10.780482 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '73e89da1-13b3-450b-aff2-8671d3a10fe7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015A7FE099D0>]}
[0m17:25:10.781480 [info ] [MainThread]: Found 6 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m17:25:10.783493 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '73e89da1-13b3-450b-aff2-8671d3a10fe7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015A7FCA22D0>]}
[0m17:25:10.786486 [info ] [MainThread]: 
[0m17:25:10.789478 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m17:25:10.792483 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m17:25:10.814479 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:25:10.815479 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m17:25:10.816480 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:25:10.915479 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m17:25:10.916482 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:25:10.918480 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m17:25:10.954480 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m17:25:10.957481 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m17:25:10.959481 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m17:25:10.969476 [debug] [MainThread]: Using postgres connection "master"
[0m17:25:10.970482 [debug] [MainThread]: On master: BEGIN
[0m17:25:10.971480 [debug] [MainThread]: Opening a new connection, currently in state init
[0m17:25:11.042480 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m17:25:11.044481 [debug] [MainThread]: Using postgres connection "master"
[0m17:25:11.045482 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m17:25:11.066479 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m17:25:11.069478 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '73e89da1-13b3-450b-aff2-8671d3a10fe7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015A7F990F50>]}
[0m17:25:11.071483 [debug] [MainThread]: On master: ROLLBACK
[0m17:25:11.072480 [debug] [MainThread]: On master: Close
[0m17:25:11.074480 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:25:11.076489 [info ] [MainThread]: 
[0m17:25:11.086479 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_month_13
[0m17:25:11.088481 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_month_13'
[0m17:25:11.089481 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_month_13
[0m17:25:11.135479 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_month_13"
[0m17:25:11.138481 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_month_13 (compile): 17:25:11.090481 => 17:25:11.137481
[0m17:25:11.139482 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_month_13
[0m17:25:11.141484 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_month_13 (execute): 17:25:11.140482 => 17:25:11.140482
[0m17:25:11.144480 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_month_13
[0m17:25:11.146481 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:25:11.147481 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m17:25:11.148485 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_month_13' was properly closed.
[0m17:25:11.150479 [debug] [MainThread]: Command end result
[0m17:25:11.170478 [info ] [MainThread]: Compiled node 'pageview_month_13' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`pageview_month_13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
        ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
        UNION ALL SELECT ''Others''
        ),
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',order_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        ),
        
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN userneeds IN (', tag_statement_first, ') THEN  userneeds
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN userneeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    
    categories_second AS (
        ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
        UNION ALL SELECT ''Others''
        ),
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN Categories IN (',  tag_statement_second, ') THEN Categories
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories_second,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile_second
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories_second AS cat_second, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile_second, ''}''), '']'') AS series_second
			FROM pivoted_data_second
			group by label,cat_second,hint
		), 
    
    
    categories_third AS (
        ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
        UNION ALL SELECT ''Others''
        ),
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Tags IN (', tag_statement_third, ') THEN  Tags
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN Tags IN (',  tag_statement_third, ') THEN Tags
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories_third,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile_third
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories_third AS cat_third, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile_third, ''}''), '']'') AS series_third
			FROM pivoted_data_third
			group by label,cat_third,hint
		)
    
[0m17:25:11.186485 [debug] [MainThread]: Command `dbt compile` succeeded at 17:25:11.186485 after 1.61 seconds
[0m17:25:11.187481 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015A7EB0C380>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015A7F9913A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015A7F990200>]}
[0m17:25:11.190478 [debug] [MainThread]: Flushing usage events
[0m17:27:27.145922 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017F76B637A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017F76B62C60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017F76B626C0>]}


============================== 17:27:27.151946 | 0c626e0a-31e3-476c-b398-a7f6683b8e6b ==============================
[0m17:27:27.151946 [info ] [MainThread]: Running with dbt=1.7.13
[0m17:27:27.153969 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s pageview_ytd_13', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:27:27.467133 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0c626e0a-31e3-476c-b398-a7f6683b8e6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017F76BB8680>]}
[0m17:27:27.631753 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0c626e0a-31e3-476c-b398-a7f6683b8e6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017F76A3E3C0>]}
[0m17:27:27.633757 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m17:27:27.652886 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m17:27:27.771873 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m17:27:27.772863 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m17:27:27.780864 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0c626e0a-31e3-476c-b398-a7f6683b8e6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017F75C0F050>]}
[0m17:27:27.798863 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0c626e0a-31e3-476c-b398-a7f6683b8e6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017F76F89D00>]}
[0m17:27:27.799862 [info ] [MainThread]: Found 6 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m17:27:27.801870 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0c626e0a-31e3-476c-b398-a7f6683b8e6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017F75F1E0C0>]}
[0m17:27:27.806880 [info ] [MainThread]: 
[0m17:27:27.808865 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m17:27:27.811861 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m17:27:27.832862 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:27:27.833865 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m17:27:27.834873 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:27:27.903862 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m17:27:27.903862 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:27:27.904868 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m17:27:27.916861 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m17:27:27.918863 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m17:27:27.919860 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m17:27:27.928860 [debug] [MainThread]: Using postgres connection "master"
[0m17:27:27.928860 [debug] [MainThread]: On master: BEGIN
[0m17:27:27.929869 [debug] [MainThread]: Opening a new connection, currently in state init
[0m17:27:28.002865 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m17:27:28.004866 [debug] [MainThread]: Using postgres connection "master"
[0m17:27:28.006863 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m17:27:28.024864 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m17:27:28.028866 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0c626e0a-31e3-476c-b398-a7f6683b8e6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017F76F892E0>]}
[0m17:27:28.029866 [debug] [MainThread]: On master: ROLLBACK
[0m17:27:28.031912 [debug] [MainThread]: On master: Close
[0m17:27:28.033862 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:27:28.035865 [info ] [MainThread]: 
[0m17:27:28.044866 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_ytd_13
[0m17:27:28.047863 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_ytd_13'
[0m17:27:28.048865 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_ytd_13
[0m17:27:28.092859 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_ytd_13"
[0m17:27:28.094862 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_ytd_13 (compile): 17:27:28.049864 => 17:27:28.094862
[0m17:27:28.096863 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_ytd_13
[0m17:27:28.097862 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_ytd_13 (execute): 17:27:28.097862 => 17:27:28.097862
[0m17:27:28.101859 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_ytd_13
[0m17:27:28.103862 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:27:28.104878 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m17:27:28.105863 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_ytd_13' was properly closed.
[0m17:27:28.107862 [debug] [MainThread]: Command end result
[0m17:27:28.124860 [info ] [MainThread]: Compiled node 'pageview_ytd_13' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`pageview_ytd_13_dbt_test`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
        ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
        UNION ALL SELECT ''Others''
        ),
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, '  AND date BETWEEN  MAKEDATE(EXTRACT(YEAR FROM CURDATE()), 1) AND DATE_SUB(CAST(NOW() AS DATE), INTERVAL 1 DAY)
                AND r.realreferrer IN (',order_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN MAKEDATE(EXTRACT(YEAR FROM CURDATE()), 1) AND DATE_SUB(CAST(NOW() AS DATE), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        ),
        
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN userneeds IN (', tag_statement_first, ') THEN  userneeds
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN userneeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    
    categories_second AS (
        ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
        UNION ALL SELECT ''Others''
        ),
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN Categories IN (',  tag_statement_second, ') THEN Categories
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories_second,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile_second
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories_second AS cat_second, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile_second, ''}''), '']'') AS series_second
			FROM pivoted_data_second
			group by label,cat_second,hint
		), 
    
    
    categories_third AS (
        ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
        UNION ALL SELECT ''Others''
        ),
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Tags IN (', tag_statement_third, ') THEN  Tags
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN Tags IN (',  tag_statement_third, ') THEN Tags
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories_third,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile_third
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories_third AS cat_third, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile_third, ''}''), '']'') AS series_third
			FROM pivoted_data_third
			group by label,cat_third,hint
		)
    
[0m17:27:28.138872 [debug] [MainThread]: Command `dbt compile` succeeded at 17:27:28.137865 after 1.22 seconds
[0m17:27:28.139867 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017F768FC980>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017F7697F3E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017F76761E50>]}
[0m17:27:28.141874 [debug] [MainThread]: Flushing usage events
[0m10:49:29.798326 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB12763A10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB12762690>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB127634D0>]}


============================== 10:49:29.810198 | 42ff64cc-47d3-4224-998f-07f709dc4213 ==============================
[0m10:49:29.810198 [info ] [MainThread]: Running with dbt=1.7.13
[0m10:49:29.813208 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s pageview_ytd_13', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m10:49:30.271303 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '42ff64cc-47d3-4224-998f-07f709dc4213', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB12760B60>]}
[0m10:49:30.418302 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '42ff64cc-47d3-4224-998f-07f709dc4213', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB12515E50>]}
[0m10:49:30.420304 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m10:49:30.461867 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m10:49:32.340766 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m10:49:32.341770 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m10:49:32.356769 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '42ff64cc-47d3-4224-998f-07f709dc4213', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB12A7A510>]}
[0m10:49:32.403328 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '42ff64cc-47d3-4224-998f-07f709dc4213', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB12B48FE0>]}
[0m10:49:32.405327 [info ] [MainThread]: Found 6 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m10:49:32.408330 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '42ff64cc-47d3-4224-998f-07f709dc4213', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB127B9CD0>]}
[0m10:49:32.414100 [info ] [MainThread]: 
[0m10:49:32.418328 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m10:49:32.422334 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m10:49:32.457328 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m10:49:32.458340 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m10:49:32.460328 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:49:32.582322 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m10:49:32.583325 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m10:49:32.584385 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m10:49:32.620646 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m10:49:32.625653 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m10:49:32.628649 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m10:49:32.644657 [debug] [MainThread]: Using postgres connection "master"
[0m10:49:32.645655 [debug] [MainThread]: On master: BEGIN
[0m10:49:32.646656 [debug] [MainThread]: Opening a new connection, currently in state init
[0m10:49:32.744886 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m10:49:32.746868 [debug] [MainThread]: Using postgres connection "master"
[0m10:49:32.747701 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m10:49:32.781870 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m10:49:32.784870 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '42ff64cc-47d3-4224-998f-07f709dc4213', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB12B4B1D0>]}
[0m10:49:32.786898 [debug] [MainThread]: On master: ROLLBACK
[0m10:49:32.788869 [debug] [MainThread]: On master: Close
[0m10:49:32.792126 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m10:49:32.794951 [info ] [MainThread]: 
[0m10:49:32.805940 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_ytd_13
[0m10:49:32.808950 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_ytd_13'
[0m10:49:32.810943 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_ytd_13
[0m10:49:32.859943 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_ytd_13"
[0m10:49:32.863945 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_ytd_13 (compile): 10:49:32.811942 => 10:49:32.862863
[0m10:49:32.865946 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_ytd_13
[0m10:49:32.867949 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_ytd_13 (execute): 10:49:32.866945 => 10:49:32.866945
[0m10:49:32.872943 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_ytd_13
[0m10:49:32.875947 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:49:32.877952 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m10:49:32.878951 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_ytd_13' was properly closed.
[0m10:49:32.881943 [debug] [MainThread]: Command end result
[0m10:49:32.900942 [info ] [MainThread]: Compiled node 'pageview_ytd_13' is:






CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`pageview_ytd_13_dbt_test`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
        ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
        UNION ALL SELECT ''Others''
        ),
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, '  AND date BETWEEN  MAKEDATE(EXTRACT(YEAR FROM CURDATE()), 1) AND DATE_SUB(CAST(NOW() AS DATE), INTERVAL 1 DAY)
                AND r.realreferrer IN (',order_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN MAKEDATE(EXTRACT(YEAR FROM CURDATE()), 1) AND DATE_SUB(CAST(NOW() AS DATE), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        ),
        
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN userneeds IN (', tag_statement_first, ') THEN  userneeds
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN userneeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    
    categories_second AS (
        ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
        UNION ALL SELECT ''Others''
        ),
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN Categories IN (',  tag_statement_second, ') THEN Categories
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories_second,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile_second
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories_second AS cat_second, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile_second, ''}''), '']'') AS series_second
			FROM pivoted_data_second
			group by label,cat_second,hint
		), 
    
    
    categories_third AS (
        ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
        UNION ALL SELECT ''Others''
        ),
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Tags IN (', tag_statement_third, ') THEN  Tags
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN Tags IN (',  tag_statement_third, ') THEN Tags
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories_third,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile_third
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories_third AS cat_third, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile_third, ''}''), '']'') AS series_third
			FROM pivoted_data_third
			group by label,cat_third,hint
		)
    
[0m10:49:32.915943 [debug] [MainThread]: Command `dbt compile` succeeded at 10:49:32.915943 after 3.37 seconds
[0m10:49:32.916942 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB119CE540>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB12434CB0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB12C30260>]}
[0m10:49:32.918974 [debug] [MainThread]: Flushing usage events
[0m11:43:07.474737 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A56E12030>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A56E13860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A56E12000>]}


============================== 11:43:07.484275 | 76ae0f6d-cacf-447f-8591-fb2a5e27d40c ==============================
[0m11:43:07.484275 [info ] [MainThread]: Running with dbt=1.7.13
[0m11:43:07.487275 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt compile -s pageview_ytd_13', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m11:43:07.828558 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '76ae0f6d-cacf-447f-8591-fb2a5e27d40c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A56D23830>]}
[0m11:43:08.166713 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '76ae0f6d-cacf-447f-8591-fb2a5e27d40c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A56BC9E20>]}
[0m11:43:08.169709 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m11:43:08.196219 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m11:43:08.324515 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m11:43:08.325516 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_ytd_13.sql
[0m11:43:08.562001 [error] [MainThread]: Encountered an error:
Compilation Error in model pageview_ytd_13 (models\pageview_ytd_13.sql)
  unexpected ':'
    line 15
      {%set dictionTable={0:'site_archive_post',1:'site_archive_post',:2'split_tags_test'}%}
[0m11:43:08.565711 [debug] [MainThread]: Command `dbt compile` failed at 11:43:08.565711 after 1.44 seconds
[0m11:43:08.567571 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A56D20DD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A571535C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A572F87D0>]}
[0m11:43:08.569580 [debug] [MainThread]: Flushing usage events
[0m11:44:21.608352 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021554172DE0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021556923800>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021556920C20>]}


============================== 11:44:21.619090 | 2162bd8b-eddc-427b-8ea8-1ca0c30a93ab ==============================
[0m11:44:21.619090 [info ] [MainThread]: Running with dbt=1.7.13
[0m11:44:21.622389 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt compile -s pageview_ytd_13', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m11:44:22.063560 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2162bd8b-eddc-427b-8ea8-1ca0c30a93ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021556A07860>]}
[0m11:44:22.210451 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2162bd8b-eddc-427b-8ea8-1ca0c30a93ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021556922690>]}
[0m11:44:22.212713 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m11:44:22.229889 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m11:44:22.361430 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m11:44:22.362503 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_ytd_13.sql
[0m11:44:22.834626 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2162bd8b-eddc-427b-8ea8-1ca0c30a93ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021556BFE870>]}
[0m11:44:22.860632 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2162bd8b-eddc-427b-8ea8-1ca0c30a93ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021556CF96A0>]}
[0m11:44:22.863485 [info ] [MainThread]: Found 6 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m11:44:22.865497 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2162bd8b-eddc-427b-8ea8-1ca0c30a93ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000215569222D0>]}
[0m11:44:22.871681 [info ] [MainThread]: 
[0m11:44:22.875792 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m11:44:22.882772 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m11:44:22.916600 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:44:22.918000 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m11:44:22.919607 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:44:23.029656 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m11:44:23.030659 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:44:23.032758 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m11:44:23.056929 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m11:44:23.060263 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m11:44:23.062237 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m11:44:23.077282 [debug] [MainThread]: Using postgres connection "master"
[0m11:44:23.079594 [debug] [MainThread]: On master: BEGIN
[0m11:44:23.080278 [debug] [MainThread]: Opening a new connection, currently in state init
[0m11:44:23.189122 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m11:44:23.190085 [debug] [MainThread]: Using postgres connection "master"
[0m11:44:23.192047 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m11:44:23.209552 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m11:44:23.215572 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2162bd8b-eddc-427b-8ea8-1ca0c30a93ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021556E967B0>]}
[0m11:44:23.217572 [debug] [MainThread]: On master: ROLLBACK
[0m11:44:23.219567 [debug] [MainThread]: On master: Close
[0m11:44:23.222598 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:44:23.225588 [info ] [MainThread]: 
[0m11:44:23.237520 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_ytd_13
[0m11:44:23.239525 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_ytd_13'
[0m11:44:23.241520 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_ytd_13
[0m11:44:23.299644 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_ytd_13"
[0m11:44:23.303970 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_ytd_13 (compile): 11:44:23.245829 => 11:44:23.301837
[0m11:44:23.306566 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_ytd_13
[0m11:44:23.308567 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_ytd_13 (execute): 11:44:23.307564 => 11:44:23.307564
[0m11:44:23.311567 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_ytd_13
[0m11:44:23.315650 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:44:23.317650 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m11:44:23.318649 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_ytd_13' was properly closed.
[0m11:44:23.320651 [debug] [MainThread]: Command end result
[0m11:44:23.347819 [info ] [MainThread]: Compiled node 'pageview_ytd_13' is:










CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`pageview_ytd_13_dbt_test`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
        ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
        UNION ALL SELECT ''Others''
        ),
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, '  AND date BETWEEN  MAKEDATE(EXTRACT(YEAR FROM CURDATE()), 1) AND DATE_SUB(CAST(NOW() AS DATE), INTERVAL 1 DAY)
                AND r.realreferrer IN (',order_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date BETWEEN MAKEDATE(EXTRACT(YEAR FROM CURDATE()), 1) AND DATE_SUB(CAST(NOW() AS DATE), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        ),
        
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN userneeds IN (', tag_statement_first, ') THEN  userneeds
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN userneeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    
    categories_second AS (
        ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
        UNION ALL SELECT ''Others''
        ),
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN Categories IN (',  tag_statement_second, ') THEN Categories
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories_second,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile_second
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories_second AS cat_second, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile_second, ''}''), '']'') AS series_second
			FROM pivoted_data_second
			group by label,cat_second,hint
		), 
    
    
    categories_third AS (
        ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
        UNION ALL SELECT ''Others''
        ),
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Tags IN (', tag_statement_third, ') THEN  Tags
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.split_tags_test p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN Tags IN (',  tag_statement_third, ') THEN Tags
                    ELSE ''Others''
                END AS tag
            FROM prod.split_tags_test s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories_third,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile_third
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories_third AS cat_third, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile_third, ''}''), '']'') AS series_third
			FROM pivoted_data_third
			group by label,cat_third,hint
		)
    
[0m11:44:23.371979 [debug] [MainThread]: Command `dbt compile` succeeded at 11:44:23.371071 after 1.98 seconds
[0m11:44:23.375036 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021556831370>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021556E18950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021556E1A5A0>]}
[0m11:44:23.377534 [debug] [MainThread]: Flushing usage events
[0m12:28:36.227504 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E92EF70B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E92EF7B30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E92EF7860>]}


============================== 12:28:36.237563 | 2bbd8192-2c9a-42fe-acef-417d148934ee ==============================
[0m12:28:36.237563 [info ] [MainThread]: Running with dbt=1.7.13
[0m12:28:36.241276 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt compile -s pageview_month_13', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m12:28:36.689457 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2bbd8192-2c9a-42fe-acef-417d148934ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E92EF62A0>]}
[0m12:28:36.864584 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2bbd8192-2c9a-42fe-acef-417d148934ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E92CDC2F0>]}
[0m12:28:36.867586 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m12:28:36.890800 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m12:28:37.149281 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 2 files changed.
[0m12:28:37.150600 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_month_13.sql
[0m12:28:37.152594 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_weeks_dummy_2_3__site__13.sql
[0m12:28:37.577075 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2bbd8192-2c9a-42fe-acef-417d148934ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E93435C70>]}
[0m12:28:37.597704 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2bbd8192-2c9a-42fe-acef-417d148934ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E93299700>]}
[0m12:28:37.598705 [info ] [MainThread]: Found 6 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m12:28:37.600780 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2bbd8192-2c9a-42fe-acef-417d148934ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E9346FAA0>]}
[0m12:28:37.607347 [info ] [MainThread]: 
[0m12:28:37.609354 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m12:28:37.613349 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m12:28:37.639081 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m12:28:37.640605 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m12:28:37.641587 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:28:37.723416 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m12:28:37.725019 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m12:28:37.726019 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m12:28:37.740629 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m12:28:37.744586 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m12:28:37.746589 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m12:28:37.760752 [debug] [MainThread]: Using postgres connection "master"
[0m12:28:37.762766 [debug] [MainThread]: On master: BEGIN
[0m12:28:37.764219 [debug] [MainThread]: Opening a new connection, currently in state init
[0m12:28:37.831481 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m12:28:37.832417 [debug] [MainThread]: Using postgres connection "master"
[0m12:28:37.833438 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m12:28:37.847396 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m12:28:37.850082 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2bbd8192-2c9a-42fe-acef-417d148934ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E9329B800>]}
[0m12:28:37.851598 [debug] [MainThread]: On master: ROLLBACK
[0m12:28:37.853252 [debug] [MainThread]: On master: Close
[0m12:28:37.855599 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m12:28:37.857600 [info ] [MainThread]: 
[0m12:28:37.864911 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_month_13
[0m12:28:37.866925 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_month_13'
[0m12:28:37.867914 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_month_13
[0m12:28:37.900329 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_month_13"
[0m12:28:37.905547 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_month_13 (compile): 12:28:37.868915 => 12:28:37.904548
[0m12:28:37.907551 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_month_13
[0m12:28:37.910182 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_month_13 (execute): 12:28:37.908548 => 12:28:37.909549
[0m12:28:37.913713 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_month_13
[0m12:28:37.916707 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:28:37.918707 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m12:28:37.919744 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_month_13' was properly closed.
[0m12:28:37.921845 [debug] [MainThread]: Command end result
[0m12:28:37.937335 [info ] [MainThread]: Compiled node 'pageview_month_13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`pageview_month_13`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
        ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
        UNION ALL SELECT ''Others''
        ),
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',order_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        ),
        
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN userneeds IN (', tag_statement_first, ') THEN  userneeds
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN userneeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    
    categories_second AS (
        ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
        UNION ALL SELECT ''Others''
        ),
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN Categories IN (',  tag_statement_second, ') THEN Categories
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories_second,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile_second
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories_second AS cat_second, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile_second, ''}''), '']'') AS series_second
			FROM pivoted_data_second
			group by label,cat_second,hint
		), 
    
    
    categories_third AS (
        ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
        UNION ALL SELECT ''Others''
        ),
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Tags IN (', tag_statement_third, ') THEN  Tags
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.split_tags_test p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN Tags IN (',  tag_statement_third, ') THEN Tags
                    ELSE ''Others''
                END AS tag
            FROM prod.split_tags_test s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories_third,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile_third
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories_third AS cat_third, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile_third, ''}''), '']'') AS series_third
			FROM pivoted_data_third
			group by label,cat_third,hint
		)
    
        select * from final
        union all
        select * from final_second
        union all
        select * from final_third
    ');

    PREPARE dynamic_query FROM @sql_query;
    EXECUTE dynamic_query;
    DEALLOCATE PREPARE dynamic_query;
[0m12:28:37.951607 [debug] [MainThread]: Command `dbt compile` succeeded at 12:28:37.950534 after 2.10 seconds
[0m12:28:37.953532 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E92EF6960>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E92EF7B30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E92EF7860>]}
[0m12:28:37.955530 [debug] [MainThread]: Flushing usage events
[0m11:37:16.904789 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026E6C683E30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026E6C681880>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026E6C682E10>]}


============================== 11:37:16.913358 | bd36351a-b85c-4e40-aa35-0d42d704a2ca ==============================
[0m11:37:16.913358 [info ] [MainThread]: Running with dbt=1.7.13
[0m11:37:16.915388 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\hp\\Dot Labs\\DBT_Transformation', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt compile -s pageview_month_13', 'send_anonymous_usage_stats': 'True'}
[0m11:37:17.492013 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'bd36351a-b85c-4e40-aa35-0d42d704a2ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026E6C7F7860>]}
[0m11:37:17.661524 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'bd36351a-b85c-4e40-aa35-0d42d704a2ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026E6C698BF0>]}
[0m11:37:17.667068 [info ] [MainThread]: Registered adapter: postgres=1.7.13
[0m11:37:17.707775 [debug] [MainThread]: checksum: 6c24e2ee36a42cedd7e5de2827d214776eb7a8e8f425f6d8acb06c31add0afef, vars: {}, profile: , target: , version: 1.7.13
[0m11:37:19.401535 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m11:37:19.402536 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\pageview_month_13.sql
[0m11:37:19.659973 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'bd36351a-b85c-4e40-aa35-0d42d704a2ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026E6CB49460>]}
[0m11:37:19.710321 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'bd36351a-b85c-4e40-aa35-0d42d704a2ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026E6CA293D0>]}
[0m11:37:19.713324 [info ] [MainThread]: Found 6 models, 0 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m11:37:19.716338 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bd36351a-b85c-4e40-aa35-0d42d704a2ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026E6CBC3230>]}
[0m11:37:19.722957 [info ] [MainThread]: 
[0m11:37:19.725965 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m11:37:19.731686 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m11:37:19.770393 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:37:19.772507 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m11:37:19.773526 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:37:19.899140 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m11:37:19.900697 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m11:37:19.902259 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m11:37:19.953153 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m11:37:19.958148 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m11:37:19.959975 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m11:37:19.974800 [debug] [MainThread]: Using postgres connection "master"
[0m11:37:19.976816 [debug] [MainThread]: On master: BEGIN
[0m11:37:19.977814 [debug] [MainThread]: Opening a new connection, currently in state init
[0m11:37:20.086508 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m11:37:20.088554 [debug] [MainThread]: Using postgres connection "master"
[0m11:37:20.091925 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.13", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m11:37:20.113792 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m11:37:20.116791 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bd36351a-b85c-4e40-aa35-0d42d704a2ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026E6CA2BFE0>]}
[0m11:37:20.118794 [debug] [MainThread]: On master: ROLLBACK
[0m11:37:20.119791 [debug] [MainThread]: On master: Close
[0m11:37:20.122863 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:37:20.124803 [info ] [MainThread]: 
[0m11:37:20.135268 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_month_13
[0m11:37:20.138267 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_month_13'
[0m11:37:20.139274 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_month_13
[0m11:37:20.184929 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_month_13"
[0m11:37:20.189599 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_month_13 (compile): 11:37:20.140264 => 11:37:20.188752
[0m11:37:20.192726 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_month_13
[0m11:37:20.194725 [debug] [Thread-1 (]: Timing info for model.dbt_project_test_kasper.pageview_month_13 (execute): 11:37:20.193728 => 11:37:20.193728
[0m11:37:20.199729 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_month_13
[0m11:37:20.202329 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:37:20.203709 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m11:37:20.204342 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_month_13' was properly closed.
[0m11:37:20.206341 [debug] [MainThread]: Command end result
[0m11:37:20.226293 [info ] [MainThread]: Compiled node 'pageview_month_13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`pageview_month_13_dbt_test`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
        ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
        UNION ALL SELECT ''Others''
        ),
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',order_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        ),
        
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN userneeds IN (', tag_statement_first, ') THEN  userneeds
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN userneeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    
    categories_second AS (
        ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
        UNION ALL SELECT ''Others''
        ),
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN Categories IN (',  tag_statement_second, ') THEN Categories
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories_second,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile_second
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories_second AS cat_second, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile_second, ''}''), '']'') AS series_second
			FROM pivoted_data_second
			group by label,cat_second,hint
		), 
    
    
    categories_third AS (
        ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
        UNION ALL SELECT ''Others''
        ),
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Tags IN (', tag_statement_third, ') THEN  Tags
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.split_tags_test p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN Tags IN (',  tag_statement_third, ') THEN Tags
                    ELSE ''Others''
                END AS tag
            FROM prod.split_tags_test s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories_third,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile_third
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories_third AS cat_third, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile_third, ''}''), '']'') AS series_third
			FROM pivoted_data_third
			group by label,cat_third,hint
		)
    
        select * from final
        union all
        select * from final_second
        union all
        select * from final_third
    ');

    PREPARE dynamic_query FROM @sql_query;
    EXECUTE dynamic_query;
    DEALLOCATE PREPARE dynamic_query;
    END
[0m11:37:20.252463 [debug] [MainThread]: Command `dbt compile` succeeded at 11:37:20.251372 after 3.71 seconds
[0m11:37:20.254477 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026E6C4CEBD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026E6C7661B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026E6CC3B410>]}
[0m11:37:20.256649 [debug] [MainThread]: Flushing usage events
[0m17:29:49.906540 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012F6966F6D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012F69657950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012F6936A450>]}


============================== 17:29:49.919503 | 52faf989-b6a6-42b9-91ba-55bd91bf7585 ==============================
[0m17:29:49.919503 [info ] [MainThread]: Running with dbt=1.8.1
[0m17:29:49.922189 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\DBT\\DBT_Transformation', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'E:\\DBT\\DBT_Transformation\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s pageview_month_13', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:29:50.479194 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '52faf989-b6a6-42b9-91ba-55bd91bf7585', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012F699FA8D0>]}
[0m17:29:50.568953 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '52faf989-b6a6-42b9-91ba-55bd91bf7585', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012F66940ED0>]}
[0m17:29:50.571945 [info ] [MainThread]: Registered adapter: postgres=1.8.0
[0m17:29:50.613994 [debug] [MainThread]: checksum: ebc509fb14e151ea268e89b60fd5abf912ed99129f87516462718fa2f14f4838, vars: {}, profile: , target: , version: 1.8.1
[0m17:29:50.762359 [info ] [MainThread]: Unable to do partial parsing because of a version mismatch
[0m17:29:50.764350 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '52faf989-b6a6-42b9-91ba-55bd91bf7585', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012F67402D50>]}
[0m17:29:54.385959 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '52faf989-b6a6-42b9-91ba-55bd91bf7585', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012F69652990>]}
[0m17:29:54.664395 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '52faf989-b6a6-42b9-91ba-55bd91bf7585', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012F69CF8390>]}
[0m17:29:54.666689 [info ] [MainThread]: Found 6 models, 413 macros
[0m17:29:54.668947 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '52faf989-b6a6-42b9-91ba-55bd91bf7585', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012F69ACBC10>]}
[0m17:29:54.673851 [info ] [MainThread]: 
[0m17:29:54.676843 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m17:29:54.689434 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m17:29:59.133022 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:29:59.134018 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m17:29:59.136028 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:29:59.237289 [debug] [ThreadPool]: Postgres adapter: Got a retryable error when attempting to open a postgres connection.
1 attempts remaining. Retrying in 0 seconds.
Error:
connection to server at "localhost" (::1), port 5432 failed: FATAL:  password authentication failed for user "postgres"

[0m17:29:59.465373 [debug] [ThreadPool]: Postgres adapter: Error running SQL: BEGIN
[0m17:29:59.468367 [debug] [ThreadPool]: Postgres adapter: Rolling back transaction.
[0m17:29:59.471357 [debug] [ThreadPool]: Postgres adapter: Error running SQL: macro list_relations_without_caching
[0m17:29:59.473352 [debug] [ThreadPool]: Postgres adapter: Rolling back transaction.
[0m17:29:59.475343 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: No close available on handle
[0m17:29:59.479333 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:29:59.481383 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m17:29:59.483385 [error] [MainThread]: Encountered an error:
Database Error
  connection to server at "localhost" (::1), port 5432 failed: FATAL:  password authentication failed for user "postgres"
  
[0m17:29:59.493360 [debug] [MainThread]: Command `dbt compile` failed at 17:29:59.492361 after 9.73 seconds
[0m17:29:59.495355 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012F696919D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012F69C8F090>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012F69693F90>]}
[0m17:29:59.497348 [debug] [MainThread]: Flushing usage events
[0m17:30:36.116111 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261B5479BD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261B8158750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261B8186F90>]}


============================== 17:30:36.124091 | e82ac43b-14b9-4ebd-ac0b-068ffbba8839 ==============================
[0m17:30:36.124091 [info ] [MainThread]: Running with dbt=1.8.1
[0m17:30:36.126336 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\DBT\\DBT_Transformation', 'version_check': 'True', 'debug': 'False', 'log_path': 'E:\\DBT\\DBT_Transformation\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s pageview_month_13', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:30:36.492586 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e82ac43b-14b9-4ebd-ac0b-068ffbba8839', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261B847F790>]}
[0m17:30:36.604676 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e82ac43b-14b9-4ebd-ac0b-068ffbba8839', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261B5470ED0>]}
[0m17:30:36.606793 [info ] [MainThread]: Registered adapter: postgres=1.8.0
[0m17:30:36.622822 [debug] [MainThread]: checksum: ebc509fb14e151ea268e89b60fd5abf912ed99129f87516462718fa2f14f4838, vars: {}, profile: , target: , version: 1.8.1
[0m17:30:36.905138 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m17:30:36.907134 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m17:30:36.963982 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e82ac43b-14b9-4ebd-ac0b-068ffbba8839', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261B865DA50>]}
[0m17:30:37.163264 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e82ac43b-14b9-4ebd-ac0b-068ffbba8839', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261B85FF6D0>]}
[0m17:30:37.165973 [info ] [MainThread]: Found 6 models, 413 macros
[0m17:30:37.168962 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e82ac43b-14b9-4ebd-ac0b-068ffbba8839', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261B8520150>]}
[0m17:30:37.173949 [info ] [MainThread]: 
[0m17:30:37.177385 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m17:30:37.190905 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m17:30:37.378575 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:30:37.379572 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m17:30:37.380671 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:30:37.610364 [debug] [ThreadPool]: Postgres adapter: Got a retryable error when attempting to open a postgres connection.
1 attempts remaining. Retrying in 0 seconds.
Error:
connection to server at "localhost" (::1), port 5432 failed: FATAL:  database "dbt_project_test_kasper" does not exist

[0m17:30:37.746993 [debug] [ThreadPool]: Postgres adapter: Error running SQL: BEGIN
[0m17:30:37.750055 [debug] [ThreadPool]: Postgres adapter: Rolling back transaction.
[0m17:30:37.753209 [debug] [ThreadPool]: Postgres adapter: Error running SQL: macro list_relations_without_caching
[0m17:30:37.756967 [debug] [ThreadPool]: Postgres adapter: Rolling back transaction.
[0m17:30:37.759959 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: No close available on handle
[0m17:30:37.763968 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:30:37.766125 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m17:30:37.768937 [error] [MainThread]: Encountered an error:
Database Error
  connection to server at "localhost" (::1), port 5432 failed: FATAL:  database "dbt_project_test_kasper" does not exist
  
[0m17:30:37.774914 [debug] [MainThread]: Command `dbt compile` failed at 17:30:37.774490 after 1.82 seconds
[0m17:30:37.776909 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261B81C3A90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261B8B64290>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261B87CF4D0>]}
[0m17:30:37.778903 [debug] [MainThread]: Flushing usage events
[0m17:30:45.578850 [debug] [MainThread]: Error sending anonymous usage statistics. Disabling tracking for this execution. If you wish to permanently disable tracking, see: https://docs.getdbt.com/reference/global-configs#send-anonymous-usage-stats.
[0m17:31:51.128776 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDE69EB290>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEA708750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEA70B910>]}


============================== 17:31:51.136783 | f45055ab-8d74-485f-b7e0-4a8e93f9a37f ==============================
[0m17:31:51.136783 [info ] [MainThread]: Running with dbt=1.8.1
[0m17:31:51.139171 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\DBT\\DBT_Transformation', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'E:\\DBT\\DBT_Transformation\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s pageview_month_13', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:31:51.451534 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f45055ab-8d74-485f-b7e0-4a8e93f9a37f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEA74E3D0>]}
[0m17:31:51.547477 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f45055ab-8d74-485f-b7e0-4a8e93f9a37f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDE7A310D0>]}
[0m17:31:51.550479 [info ] [MainThread]: Registered adapter: postgres=1.8.0
[0m17:31:51.568609 [debug] [MainThread]: checksum: ebc509fb14e151ea268e89b60fd5abf912ed99129f87516462718fa2f14f4838, vars: {}, profile: , target: , version: 1.8.1
[0m17:31:51.809931 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m17:31:51.810927 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m17:31:51.860023 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f45055ab-8d74-485f-b7e0-4a8e93f9a37f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEABC0150>]}
[0m17:31:52.006414 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f45055ab-8d74-485f-b7e0-4a8e93f9a37f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEA74FC90>]}
[0m17:31:52.008501 [info ] [MainThread]: Found 6 models, 413 macros
[0m17:31:52.011006 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f45055ab-8d74-485f-b7e0-4a8e93f9a37f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEAA10610>]}
[0m17:31:52.015990 [info ] [MainThread]: 
[0m17:31:52.017988 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m17:31:52.027965 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m17:31:52.181705 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:31:52.182702 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m17:31:52.183714 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:31:52.249141 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m17:31:52.249881 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m17:31:52.250925 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.8.1", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m17:31:52.267655 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m17:31:52.270649 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m17:31:52.271882 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m17:31:52.282616 [debug] [MainThread]: Using postgres connection "master"
[0m17:31:52.283614 [debug] [MainThread]: On master: BEGIN
[0m17:31:52.284717 [debug] [MainThread]: Opening a new connection, currently in state init
[0m17:31:52.521783 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m17:31:52.523715 [debug] [MainThread]: Using postgres connection "master"
[0m17:31:52.526665 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.1", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m17:31:52.560116 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m17:31:52.565102 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f45055ab-8d74-485f-b7e0-4a8e93f9a37f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEA7870D0>]}
[0m17:31:52.569087 [debug] [MainThread]: On master: ROLLBACK
[0m17:31:52.571469 [debug] [MainThread]: On master: Close
[0m17:31:52.575069 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:31:52.579062 [info ] [MainThread]: 
[0m17:31:52.592756 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.pageview_month_13
[0m17:31:52.597742 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.pageview_month_13'
[0m17:31:52.601725 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.pageview_month_13
[0m17:31:52.673532 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.pageview_month_13"
[0m17:31:52.676528 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.pageview_month_13
[0m17:31:52.680512 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.pageview_month_13
[0m17:31:52.684506 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:31:52.686500 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m17:31:52.687631 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.pageview_month_13' was properly closed.
[0m17:31:52.690489 [debug] [MainThread]: Command end result
[0m17:31:52.781242 [info ] [MainThread]: Compiled node 'pageview_month_13' is:









CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`pageview_month_13_dbt_test`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement_first  VARCHAR(2000),
    IN domain VARCHAR(200),
    IN tag_statement_first VARCHAR(2000),
    IN tag_statement_second VARCHAR(2000),
    IN tag_statement_third VARCHAR(2000)
)
BEGIN
    SET SESSION group_concat_max_len = 1000000;
    SET @sql_query = CONCAT('
    with 
    
    
    referrers AS(
        ', 'SELECT DISTINCT realreferrer FROM pre_stage.ref_value
        WHERE realreferrer IN (', order_statement_first, ') and siteid = ', site ,'
        UNION ALL SELECT ''Others''
    )
    ,
    categories AS (
        ', 
        'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_first, ') and siteid = ', site ,'
    
        UNION ALL SELECT ''Others''
        ),
        combinations AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        pageview AS (
            SELECT 
                siteid,
                r.realreferrer,
                postid,
                date AS visit_date,
                COUNT(*) AS visit
            FROM prod.traffic_channels AS t
            LEFT JOIN referrers r ON t.realreferrer = r.realreferrer
            WHERE siteid = ', site, ' AND date between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY)
                AND r.realreferrer IN (',order_statement_first, ')
                and t.postid is not null
            GROUP BY siteid, r.realreferrer, postid, date
        ),
        main AS (
            SELECT 
                postid,
                siteid,
                event_name,
                SUM(hits) AS t_totals
            FROM prod.events
            WHERE siteid = ',site,' AND Event_Action = ''Frontpage'' 
            and postid is not null
            AND date between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY)
            GROUP BY postid, siteid, event_name
        ),
        transformed_data AS (
            SELECT
                postid,
                siteid,
                t_totals,
                CASE 
                    WHEN event_name LIKE ''://%'' THEN CONCAT(',domain,', SUBSTRING(event_name, 5))
                    ELSE event_name
                END AS modifyurl
            FROM main
        ),
        
        final_transformed AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN userneeds IN (', tag_statement_first, ') THEN  userneeds
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN userneeds IN (',  tag_statement_first, ') THEN userneeds
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data As(
			select * from site_archive
            UNION
            select * from final_transformed
        ),
        summed_data AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations c
            LEFT JOIN total_data s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data
        ),
        pivoted_data AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS categories,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_first, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_first, ', "Others")), '']'') AS percentile
			FROM percent
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories AS cat, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile, ''}''), '']'') AS series
			FROM pivoted_data
			group by label,cat,hint
		), 
    
    
    categories_second AS (
        ','SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_second, ') and siteid = ', site ,' 
        UNION ALL SELECT ''Others''
        ),
        combinations_second AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_second c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_second AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Categories IN (', tag_statement_second, ') THEN  Categories
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.site_archive_post p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_second AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN Categories IN (',  tag_statement_second, ') THEN Categories
                    ELSE ''Others''
                END AS tag
            FROM prod.site_archive_post s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_second As(
			select * from site_archive_second
            UNION
            select * from final_transformed_second
        ),
        summed_data_second AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_second c
            LEFT JOIN total_data_second s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_second AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_second
        ),
        pivoted_data_second AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS categories_second,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_second, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_second, ', "Others")), '']'') AS percentile_second
			FROM percent_second
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_second as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories_second AS cat_second, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile_second, ''}''), '']'') AS series_second
			FROM pivoted_data_second
			group by label,cat_second,hint
		), 
    
    
    categories_third AS (
        ', 'SELECT DISTINCT Categories FROM pre_stage.ref_value 
        WHERE Categories IN (', tag_statement_third, ') and siteid = ', site,'
        UNION ALL SELECT ''Others''
        ),
        combinations_third AS (
            SELECT r.realreferrer, c.categories AS tag
            FROM referrers r
            CROSS JOIN categories_third c
            ORDER BY FIELD(r.realreferrer, ',order_statement_first, ', "Others")
        ),
        
        final_transformed_third AS (
            SELECT
                s.siteid AS siteid,
                p.id AS postid,
                ''Forside'' as realreferrer,
                s.t_totals as visits,
				CASE
                    WHEN Tags IN (', tag_statement_third, ') THEN  Tags
                    ELSE ''Others''
                END AS tag
            FROM transformed_data s
            LEFT JOIN prod.split_tags_test p ON s.siteid = p.siteid AND s.modifyurl = p.link
            WHERE p.id IS NOT NULL
            and s.siteid = ',site,' 
        ),
        site_archive_third AS (
            SELECT
                s.siteid AS siteid,
                s.id AS postid,
                p.realreferrer,
                p.visit AS visits,
                CASE
                    WHEN Tags IN (',  tag_statement_third, ') THEN Tags
                    ELSE ''Others''
                END AS tag
            FROM prod.split_tags_test s
            RIGHT JOIN pageview p ON s.id = p.postid AND s.siteid = p.siteid
            WHERE s.Siteid = ', site,'
        ),
        total_data_third As(
			select * from site_archive_third
            UNION
            select * from final_transformed_third
        ),
        summed_data_third AS (
            SELECT
                c.realreferrer AS realreferrer,
                c.tag AS tag,
                COALESCE(SUM(s.visits), 0) AS total_visits
            FROM combinations_third c
            LEFT JOIN total_data_third s ON c.realreferrer = s.realreferrer AND c.tag = s.tag
            GROUP BY c.realreferrer, c.tag
			ORDER BY FIELD(c.realreferrer, ', order_statement_first, ', "Others")
        ),
        percent_third AS (
            SELECT
                realreferrer,
                tag,
                total_visits,
                COALESCE((ROUND((total_visits * 100.0) / COALESCE(SUM(total_visits) OVER (PARTITION BY realreferrer), 0), 2)), 0) AS percentile,
                ROW_NUMBER() OVER (PARTITION BY realreferrer ORDER BY tag) AS tag_order
            FROM summed_data_third
        ),
        pivoted_data_third AS (
			SELECT
				realreferrer,
				CONCAT(''['', GROUP_CONCAT(DISTINCT CONCAT(''"'', tag, ''"'') ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS categories_third,
				GROUP_CONCAT(total_visits ORDER BY FIELD(tag, ',tag_statement_third, ', "Others")) AS total_visits,
				CONCAT(''['', GROUP_CONCAT((percentile) ORDER BY FIELD(tag, ', tag_statement_third, ', "Others")), '']'') AS percentile_third
			FROM percent_third
			GROUP BY realreferrer
             ORDER BY FIELD(realreferrer, ', order_statement_first, ', "Others")
		),
        final_third as(
			SELECT 	
				',label_val,' AS label,
                ',hint_val,' AS hint,
				categories_third AS cat_third, 
				CONCAT(''['', GROUP_CONCAT(''{"name": "'', realreferrer, ''","data":'', percentile_third, ''}''), '']'') AS series_third
			FROM pivoted_data_third
			group by label,cat_third,hint
		)
    
        select * from final
        union all
        select * from final_second
        union all
        select * from final_third
    ');

    PREPARE dynamic_query FROM @sql_query;
    EXECUTE dynamic_query;
    DEALLOCATE PREPARE dynamic_query;
    END
[0m17:31:52.800196 [debug] [MainThread]: Command `dbt compile` succeeded at 17:31:52.799433 after 1.78 seconds
[0m17:31:52.802189 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEA773E10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEA4D1C90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDE45E1BD0>]}
[0m17:31:52.803189 [debug] [MainThread]: Flushing usage events
[0m18:01:36.367986 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219FD0AD8D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219FD06B910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219FD0686D0>]}


============================== 18:01:36.373967 | 323cf077-7634-416a-bf63-adb557ed0605 ==============================
[0m18:01:36.373967 [info ] [MainThread]: Running with dbt=1.8.1
[0m18:01:36.375963 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'E:\\DBT\\DBT_Transformation', 'log_path': 'E:\\DBT\\DBT_Transformation\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_ytd_13', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:01:36.645680 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '323cf077-7634-416a-bf63-adb557ed0605', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219FD3E83D0>]}
[0m18:01:36.720480 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '323cf077-7634-416a-bf63-adb557ed0605', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219FA380E10>]}
[0m18:01:36.723322 [info ] [MainThread]: Registered adapter: postgres=1.8.0
[0m18:01:36.736272 [debug] [MainThread]: checksum: ebc509fb14e151ea268e89b60fd5abf912ed99129f87516462718fa2f14f4838, vars: {}, profile: , target: , version: 1.8.1
[0m18:01:36.909753 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m18:01:36.910751 [debug] [MainThread]: Partial parsing: added file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_ytd_13.sql
[0m18:01:37.211944 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '323cf077-7634-416a-bf63-adb557ed0605', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219FD083590>]}
[0m18:01:37.337317 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '323cf077-7634-416a-bf63-adb557ed0605', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219FD7FE410>]}
[0m18:01:37.339312 [info ] [MainThread]: Found 7 models, 413 macros
[0m18:01:37.340011 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '323cf077-7634-416a-bf63-adb557ed0605', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219FD5978D0>]}
[0m18:01:37.343006 [info ] [MainThread]: 
[0m18:01:37.343622 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:01:37.350889 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:01:37.472272 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:01:37.473269 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:01:37.474267 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:01:37.661014 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:01:37.662012 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:01:37.663009 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.8.1", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:01:37.676970 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:01:37.680960 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:01:37.681972 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:01:37.689937 [debug] [MainThread]: Using postgres connection "master"
[0m18:01:37.690934 [debug] [MainThread]: On master: BEGIN
[0m18:01:37.690934 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:01:37.742168 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:01:37.743164 [debug] [MainThread]: Using postgres connection "master"
[0m18:01:37.744186 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.1", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:01:37.755131 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:01:37.757126 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '323cf077-7634-416a-bf63-adb557ed0605', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219FD734450>]}
[0m18:01:37.758126 [debug] [MainThread]: On master: ROLLBACK
[0m18:01:37.758126 [debug] [MainThread]: On master: Close
[0m18:01:37.760120 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:01:37.761117 [info ] [MainThread]: 
[0m18:01:37.767134 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_ytd_13
[0m18:01:37.768096 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_ytd_13'
[0m18:01:37.769095 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_ytd_13
[0m18:01:37.797020 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_ytd_13"
[0m18:01:37.799015 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_ytd_13
[0m18:01:37.801008 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_ytd_13
[0m18:01:37.803005 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:01:37.804002 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:01:37.804002 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_ytd_13' was properly closed.
[0m18:01:37.806000 [debug] [MainThread]: Command end result
[0m18:01:37.849924 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_ytd_13' is:








CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_month_13_dbt_test`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_ytd_article_published as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN userneeds like "%Opdater mig%" then "Opdater mig"
			    WHEN userneeds like "%Forbind mig%" then "Forbind mig"
			    WHEN userneeds like "%Help mig med at forsta%" then "Hjælp mig med at forstå"
			    WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
			    WHEN userneeds like "%Underhold mig%" then "Underhold mig"
			    WHEN userneeds like "%Inspirer migg%" then "Inspirer mig"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date between MAKEDATE(EXTRACT(YEAR FROM CURDATE()),1)  and  DATE_SUB(cast(NOW() as date), INTERVAL 1 DAY)
        
        AND siteid = ', site, '),
    last_ytd_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_ytd_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_ytd_article_published  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article as(
		select siteid as siteid,tags,sum(val) as agg_sum from
        cta_per_article
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_ytd_article_published l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data
			group by 1,2
		),
        hits_by_tags as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts h
			join total_hits t on h.siteid=t.siteid
			join last_ytd_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data
		group by 1,2,3
		),
        categories as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d
		),
        json_data as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories
		), 
    
    last_ytd_article_published_second as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Categories like "%Nyhed%" then "Nyhed"
			    WHEN Categories like "%Medlemsinfo%" then "Medlemsinfo"
			    WHEN Categories like "%Reportage%" then "Reportage"
			    WHEN Categories like "%Artikel%" then "Artikel"
			    WHEN Categories like "%Det ku ske for dig%" then "Det ku ske for dig"
			    WHEN Categories like "%Jeg mener%" then "Jeg mener"
			    WHEN Categories like "%Videoartikel%" then "Videoartikel"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date between MAKEDATE(EXTRACT(YEAR FROM CURDATE()),1)  and  DATE_SUB(cast(NOW() as date), INTERVAL 1 DAY)
        
        AND siteid = ', site, '),
    last_ytd_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_ytd_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_second as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_ytd_article_published_second  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_second as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_second  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_second as(
		select siteid as siteid,tags,sum(val) as agg_sum from
        cta_per_article_second
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_second as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_ytd_article_published_second l
		join cta_per_article_second a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_second as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_second
			group by 1,2
		),
        hits_by_tags_second as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_second
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits_second as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_second
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data_second as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_second h
			join total_hits_second t on h.siteid=t.siteid
			join last_ytd_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d_second as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_second
		group by 1,2,3
		),
        categories_second as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_second
		),
        json_data_second as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_second
		), 
    
    last_ytd_article_published_third as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Tags like "%Slagterindustri%" then "Slagterindustri"
			    WHEN Tags like "%Fødevareindustri%" then "Fødevareindustri"
			    WHEN Tags like "%Mejeri%" then "Mejeri"
			    WHEN Tags like "%Butik%" then "Butik"
			    WHEN Tags like "%Alle brancher%" then "Alle brancher"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date between MAKEDATE(EXTRACT(YEAR FROM CURDATE()),1)  and  DATE_SUB(cast(NOW() as date), INTERVAL 1 DAY)
        
        AND siteid = ', site, '),
    last_ytd_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_ytd_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_third as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_ytd_article_published_third  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_third as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_third  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_third as(
		select siteid as siteid,tags,sum(val) as agg_sum from
        cta_per_article_third
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_third as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_ytd_article_published_third l
		join cta_per_article_third a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_third as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_third
			group by 1,2
		),
        hits_by_tags_third as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_third
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits_third as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_third
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data_third as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_third h
			join total_hits_third t on h.siteid=t.siteid
			join last_ytd_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d_third as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_third
		group by 1,2,3
		),
        categories_third as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_third
		),
        json_data_third as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_third
		)
    

    SELECT 
		CONCAT(
        ''{'',
            ''"site":'',jd.siteid,'','',
            ''"data": {'',
                ''"label": "'', jd.lab, ''",'',
                ''"categories": ['', jd.cat, ''],'',
                ''"series": ['', jd.series, '']'',
                '',"defaultTitle":"',dtitle,'"'',
                '',"additional":[ ''
                
                ,''{'',
                ''"title":"',title1,'",'',
                ''"data": {'',
                ''"label": "'',json_data_second.lab, ''",'',
                ''"categories": ['', json_data_second.cat, ''],'',
                ''"series": ['', json_data_second.series, '']'',
                ''}}''
                
                , '',''
                
                
                ,''{'',
                ''"title":"',title2,'",'',
                ''"data": {'',
                ''"label": "'',json_data_third.lab, ''",'',
                ''"categories": ['', json_data_third.cat, ''],'',
                ''"series": ['', json_data_third.series, '']'',
                ''}}''
                
                
        '']}}''
    
			) as json_data
		  FROM json_data jd
          
          CROSS join json_data_second
          
          CROSS join json_data_third
          ;
[0m18:01:37.872817 [debug] [MainThread]: Command `dbt compile` succeeded at 18:01:37.872817 after 1.59 seconds
[0m18:01:37.873813 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219F6BBC2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219F6BF7C50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219FD441210>]}
[0m18:01:37.874813 [debug] [MainThread]: Flushing usage events
[0m18:01:43.732943 [debug] [MainThread]: Error sending anonymous usage statistics. Disabling tracking for this execution. If you wish to permanently disable tracking, see: https://docs.getdbt.com/reference/global-configs#send-anonymous-usage-stats.
[0m18:28:54.126793 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229C1AF9250>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229C1ABB350>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229C1ABB9D0>]}


============================== 18:28:54.135770 | e7fb4476-6d48-48e9-b5a0-c83b5d3f33db ==============================
[0m18:28:54.135770 [info ] [MainThread]: Running with dbt=1.8.1
[0m18:28:54.137764 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'E:\\DBT\\DBT_Transformation', 'log_path': 'E:\\DBT\\DBT_Transformation\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt compile -s tactical_userneeds_pageviews_chart_month_11', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:28:54.472403 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e7fb4476-6d48-48e9-b5a0-c83b5d3f33db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229C1DDF250>]}
[0m18:28:54.554184 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e7fb4476-6d48-48e9-b5a0-c83b5d3f33db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229BEDD0E90>]}
[0m18:28:54.556542 [info ] [MainThread]: Registered adapter: postgres=1.8.0
[0m18:28:54.571771 [debug] [MainThread]: checksum: ebc509fb14e151ea268e89b60fd5abf912ed99129f87516462718fa2f14f4838, vars: {}, profile: , target: , version: 1.8.1
[0m18:28:54.786327 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 1 files changed.
[0m18:28:54.787324 [debug] [MainThread]: Partial parsing: added file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_month_11.sql
[0m18:28:54.788321 [debug] [MainThread]: Partial parsing: updated file: dbt_project_test_kasper://models\tactical_userneeds_pageviews_chart_ytd_13.sql
[0m18:28:55.221165 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e7fb4476-6d48-48e9-b5a0-c83b5d3f33db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229C1EFA990>]}
[0m18:28:55.364773 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e7fb4476-6d48-48e9-b5a0-c83b5d3f33db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229C1EF8C50>]}
[0m18:28:55.365766 [info ] [MainThread]: Found 8 models, 413 macros
[0m18:28:55.366761 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e7fb4476-6d48-48e9-b5a0-c83b5d3f33db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229C2213C10>]}
[0m18:28:55.368759 [info ] [MainThread]: 
[0m18:28:55.370241 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:28:55.377228 [debug] [ThreadPool]: Acquiring new postgres connection 'list_dbt_project_test_kasper_public'
[0m18:28:55.512941 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:28:55.513938 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: BEGIN
[0m18:28:55.515932 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:28:55.580581 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:28:55.581582 [debug] [ThreadPool]: Using postgres connection "list_dbt_project_test_kasper_public"
[0m18:28:55.582578 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: /* {"app": "dbt", "dbt_version": "1.8.1", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_dbt_project_test_kasper_public"} */
select
      'dbt_project_test_kasper' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'dbt_project_test_kasper' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m18:28:55.592789 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m18:28:55.595765 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: ROLLBACK
[0m18:28:55.596763 [debug] [ThreadPool]: On list_dbt_project_test_kasper_public: Close
[0m18:28:55.603745 [debug] [MainThread]: Using postgres connection "master"
[0m18:28:55.604744 [debug] [MainThread]: On master: BEGIN
[0m18:28:55.604744 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:28:55.785422 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:28:55.786420 [debug] [MainThread]: Using postgres connection "master"
[0m18:28:55.787416 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.1", "profile_name": "kasper", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:28:55.800654 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:28:55.802657 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e7fb4476-6d48-48e9-b5a0-c83b5d3f33db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229C1DA9450>]}
[0m18:28:55.803662 [debug] [MainThread]: On master: ROLLBACK
[0m18:28:55.804642 [debug] [MainThread]: On master: Close
[0m18:28:55.805641 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:28:55.808632 [info ] [MainThread]: 
[0m18:28:55.814615 [debug] [Thread-1 (]: Began running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_11
[0m18:28:55.815612 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_11'
[0m18:28:55.816610 [debug] [Thread-1 (]: Began compiling node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_11
[0m18:28:55.852513 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_11"
[0m18:28:55.854509 [debug] [Thread-1 (]: Began executing node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_11
[0m18:28:55.857502 [debug] [Thread-1 (]: Finished running node model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_11
[0m18:28:55.859495 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:28:55.860493 [debug] [MainThread]: Connection 'list_dbt_project_test_kasper_public' was properly closed.
[0m18:28:55.861491 [debug] [MainThread]: Connection 'model.dbt_project_test_kasper.tactical_userneeds_pageviews_chart_month_11' was properly closed.
[0m18:28:55.862488 [debug] [MainThread]: Command end result
[0m18:28:55.919336 [info ] [MainThread]: Compiled node 'tactical_userneeds_pageviews_chart_month_11' is:








CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_month_11_dbt_test`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
    IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_ytd_article_published as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN userneeds like "%Opdater mig%" then "Opdater mig"
			    WHEN userneeds like "%Forbind mig%" then "Forbind mig"
			    WHEN userneeds like "%Help mig med at forsta%" then "Hjælp mig med at forstå"
			    WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
			    WHEN userneeds like "%Underhold mig%" then "Underhold mig"
			    WHEN userneeds like "%Inspirer migg%" then "Inspirer mig"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date between MAKEDATE(EXTRACT(YEAR FROM CURDATE()),1)  and  DATE_SUB(cast(NOW() as date), INTERVAL 1 DAY)
        
        AND siteid = ', site, '
AND (
    (tags NOT LIKE "%billedkunst%" 
    AND tags NOT LIKE "%børnehaveklassen%" 
    AND tags NOT LIKE "%dsa%" 
    AND tags NOT LIKE "%engelsk%" 
    AND tags NOT LIKE "%håndværk og design%" 
    AND tags NOT LIKE "%idræt%" 
    AND tags NOT LIKE "%kulturfag%" 
    AND tags NOT LIKE "%lærersenior%" 
    AND tags NOT LIKE "%lærerstuderende%" 
    AND tags NOT LIKE "%madkundskab%" 
    AND tags NOT LIKE "%musik%" 
    AND tags   NOT LIKE "%naturfag%" 
    AND tags   NOT LIKE "%plc%" 
    AND tags   NOT LIKE "%ppr%" 
    AND tags  NOT LIKE "%praktik%" 
    AND tags  NOT LIKE "%sosu%" 
    AND tags  NOT LIKE "%tyskfransk%" 
    AND tags NOT LIKE "%uu%")
    OR 
    (tags LIKE "%dansk%" 
    OR tags LIKE "%it,%" 
    OR tags LIKE ",%it,%" 
    OR tags LIKE "%,it%" 
    OR tags LIKE "%matematik%" 
    OR tags LIKE "%specialpædagogik%" 
    OR tags LIKE "%Skolepolitik%" 
    OR tags LIKE "%DLF%" 
    OR tags LIKE "%Skoleledelse%" 
    OR tags LIKE "%Psykisk arbejdsmiljø%" 
    OR tags LIKE "%Forskning%"
    )
    OR
    (tags NOT LIKE "%billedkunst%" 
    AND tags NOT LIKE "%børnehaveklassen%" 
    AND tags NOT LIKE "%dsa%" 
    AND tags NOT LIKE "%engelsk%" 
    AND tags NOT LIKE "%håndværk og design%" 
    AND tags NOT LIKE "%idræt%" 
    AND tags NOT LIKE "%kulturfag%" 
    AND tags NOT LIKE "%lærersenior%" 
    AND tags NOT LIKE "%lærerstuderende%" 
    AND tags NOT LIKE "%madkundskab%" 
    AND tags NOT LIKE "%musik%" 
    AND tags NOT LIKE "%naturfag%" 
    AND tags NOT LIKE "%plc%" 
    AND tags NOT LIKE "%ppr%" 
    AND tags NOT LIKE "%praktik%" 
    AND tags NOT LIKE "%sosu%" 
    AND tags NOT LIKE "%tyskfransk%" 
    AND tags NOT LIKE "%uu%")
    AND 
    (tags NOT LIKE "%dansk%" 
    AND tags NOT LIKE "%it,%" 
    AND tags NOT LIKE ",%it,%" 
    AND tags NOT LIKE "%,it%" 
    AND tags NOT LIKE "%matematik%" 
    AND tags NOT LIKE "%specialpædagogik%" 
    AND tags NOT LIKE "%Skolepolitik%" 
    AND tags NOT LIKE "%DLF%" 
    AND tags NOT LIKE "%Skoleledelse%" 
    AND tags NOT LIKE "%Psykisk arbejdsmiljø%" 
    AND tags NOT LIKE "%Forskning%")
)
),
    last_ytd_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_ytd_article_published 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_ytd_article_published  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article as(
		select siteid as siteid,tags,sum(val) as agg_sum from
        cta_per_article
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_ytd_article_published l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data
			group by 1,2
		),
        hits_by_tags as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts h
			join total_hits t on h.siteid=t.siteid
			join last_ytd_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data
		group by 1,2,3
		),
        categories as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d
		),
        json_data as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories
		), 
    
    last_ytd_article_published_second as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Categories like "%Nyhed%" then "Nyhed"
			    WHEN Categories like "%Medlemsinfo%" then "Medlemsinfo"
			    WHEN Categories like "%Reportage%" then "Reportage"
			    WHEN Categories like "%Artikel%" then "Artikel"
			    WHEN Categories like "%Det ku ske for dig%" then "Det ku ske for dig"
			    WHEN Categories like "%Jeg mener%" then "Jeg mener"
			    WHEN Categories like "%Videoartikel%" then "Videoartikel"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date between MAKEDATE(EXTRACT(YEAR FROM CURDATE()),1)  and  DATE_SUB(cast(NOW() as date), INTERVAL 1 DAY)
        
        AND siteid = ', site, '
AND (
    (tags NOT LIKE "%billedkunst%" 
    AND tags NOT LIKE "%børnehaveklassen%" 
    AND tags NOT LIKE "%dsa%" 
    AND tags NOT LIKE "%engelsk%" 
    AND tags NOT LIKE "%håndværk og design%" 
    AND tags NOT LIKE "%idræt%" 
    AND tags NOT LIKE "%kulturfag%" 
    AND tags NOT LIKE "%lærersenior%" 
    AND tags NOT LIKE "%lærerstuderende%" 
    AND tags NOT LIKE "%madkundskab%" 
    AND tags NOT LIKE "%musik%" 
    AND tags   NOT LIKE "%naturfag%" 
    AND tags   NOT LIKE "%plc%" 
    AND tags   NOT LIKE "%ppr%" 
    AND tags  NOT LIKE "%praktik%" 
    AND tags  NOT LIKE "%sosu%" 
    AND tags  NOT LIKE "%tyskfransk%" 
    AND tags NOT LIKE "%uu%")
    OR 
    (tags LIKE "%dansk%" 
    OR tags LIKE "%it,%" 
    OR tags LIKE ",%it,%" 
    OR tags LIKE "%,it%" 
    OR tags LIKE "%matematik%" 
    OR tags LIKE "%specialpædagogik%" 
    OR tags LIKE "%Skolepolitik%" 
    OR tags LIKE "%DLF%" 
    OR tags LIKE "%Skoleledelse%" 
    OR tags LIKE "%Psykisk arbejdsmiljø%" 
    OR tags LIKE "%Forskning%"
    )
    OR
    (tags NOT LIKE "%billedkunst%" 
    AND tags NOT LIKE "%børnehaveklassen%" 
    AND tags NOT LIKE "%dsa%" 
    AND tags NOT LIKE "%engelsk%" 
    AND tags NOT LIKE "%håndværk og design%" 
    AND tags NOT LIKE "%idræt%" 
    AND tags NOT LIKE "%kulturfag%" 
    AND tags NOT LIKE "%lærersenior%" 
    AND tags NOT LIKE "%lærerstuderende%" 
    AND tags NOT LIKE "%madkundskab%" 
    AND tags NOT LIKE "%musik%" 
    AND tags NOT LIKE "%naturfag%" 
    AND tags NOT LIKE "%plc%" 
    AND tags NOT LIKE "%ppr%" 
    AND tags NOT LIKE "%praktik%" 
    AND tags NOT LIKE "%sosu%" 
    AND tags NOT LIKE "%tyskfransk%" 
    AND tags NOT LIKE "%uu%")
    AND 
    (tags NOT LIKE "%dansk%" 
    AND tags NOT LIKE "%it,%" 
    AND tags NOT LIKE ",%it,%" 
    AND tags NOT LIKE "%,it%" 
    AND tags NOT LIKE "%matematik%" 
    AND tags NOT LIKE "%specialpædagogik%" 
    AND tags NOT LIKE "%Skolepolitik%" 
    AND tags NOT LIKE "%DLF%" 
    AND tags NOT LIKE "%Skoleledelse%" 
    AND tags NOT LIKE "%Psykisk arbejdsmiljø%" 
    AND tags NOT LIKE "%Forskning%")
)
),
    last_ytd_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_ytd_article_published_second 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_second as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_ytd_article_published_second  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_second as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_second  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_second as(
		select siteid as siteid,tags,sum(val) as agg_sum from
        cta_per_article_second
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_second as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_ytd_article_published_second l
		join cta_per_article_second a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_second as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_second
			group by 1,2
		),
        hits_by_tags_second as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_second
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits_second as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_second
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data_second as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_second h
			join total_hits_second t on h.siteid=t.siteid
			join last_ytd_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d_second as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement_second,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_second
		group by 1,2,3
		),
        categories_second as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_second
		),
        json_data_second as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_second
		), 
    
    last_ytd_article_published_third as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Tags like "%Slagterindustri%" then "Slagterindustri"
			    WHEN Tags like "%Fødevareindustri%" then "Fødevareindustri"
			    WHEN Tags like "%Mejeri%" then "Mejeri"
			    WHEN Tags like "%Butik%" then "Butik"
			    WHEN Tags like "%Alle brancher%" then "Alle brancher"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date between MAKEDATE(EXTRACT(YEAR FROM CURDATE()),1)  and  DATE_SUB(cast(NOW() as date), INTERVAL 1 DAY)
        
        AND siteid = ', site, '
AND (
    (tags NOT LIKE "%billedkunst%" 
    AND tags NOT LIKE "%børnehaveklassen%" 
    AND tags NOT LIKE "%dsa%" 
    AND tags NOT LIKE "%engelsk%" 
    AND tags NOT LIKE "%håndværk og design%" 
    AND tags NOT LIKE "%idræt%" 
    AND tags NOT LIKE "%kulturfag%" 
    AND tags NOT LIKE "%lærersenior%" 
    AND tags NOT LIKE "%lærerstuderende%" 
    AND tags NOT LIKE "%madkundskab%" 
    AND tags NOT LIKE "%musik%" 
    AND tags   NOT LIKE "%naturfag%" 
    AND tags   NOT LIKE "%plc%" 
    AND tags   NOT LIKE "%ppr%" 
    AND tags  NOT LIKE "%praktik%" 
    AND tags  NOT LIKE "%sosu%" 
    AND tags  NOT LIKE "%tyskfransk%" 
    AND tags NOT LIKE "%uu%")
    OR 
    (tags LIKE "%dansk%" 
    OR tags LIKE "%it,%" 
    OR tags LIKE ",%it,%" 
    OR tags LIKE "%,it%" 
    OR tags LIKE "%matematik%" 
    OR tags LIKE "%specialpædagogik%" 
    OR tags LIKE "%Skolepolitik%" 
    OR tags LIKE "%DLF%" 
    OR tags LIKE "%Skoleledelse%" 
    OR tags LIKE "%Psykisk arbejdsmiljø%" 
    OR tags LIKE "%Forskning%"
    )
    OR
    (tags NOT LIKE "%billedkunst%" 
    AND tags NOT LIKE "%børnehaveklassen%" 
    AND tags NOT LIKE "%dsa%" 
    AND tags NOT LIKE "%engelsk%" 
    AND tags NOT LIKE "%håndværk og design%" 
    AND tags NOT LIKE "%idræt%" 
    AND tags NOT LIKE "%kulturfag%" 
    AND tags NOT LIKE "%lærersenior%" 
    AND tags NOT LIKE "%lærerstuderende%" 
    AND tags NOT LIKE "%madkundskab%" 
    AND tags NOT LIKE "%musik%" 
    AND tags NOT LIKE "%naturfag%" 
    AND tags NOT LIKE "%plc%" 
    AND tags NOT LIKE "%ppr%" 
    AND tags NOT LIKE "%praktik%" 
    AND tags NOT LIKE "%sosu%" 
    AND tags NOT LIKE "%tyskfransk%" 
    AND tags NOT LIKE "%uu%")
    AND 
    (tags NOT LIKE "%dansk%" 
    AND tags NOT LIKE "%it,%" 
    AND tags NOT LIKE ",%it,%" 
    AND tags NOT LIKE "%,it%" 
    AND tags NOT LIKE "%matematik%" 
    AND tags NOT LIKE "%specialpædagogik%" 
    AND tags NOT LIKE "%Skolepolitik%" 
    AND tags NOT LIKE "%DLF%" 
    AND tags NOT LIKE "%Skoleledelse%" 
    AND tags NOT LIKE "%Psykisk arbejdsmiljø%" 
    AND tags NOT LIKE "%Forskning%")
)
),
    last_ytd_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_ytd_article_published_third 
		where siteid = ', site, '
		group by 1,2
    ),
    agg_next_click_per_article_third as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_ytd_article_published_third  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = ',event_action,'
		where    e.siteid = ', site, '  
		group by 1,2,3
		),
        cta_per_article_third as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_third  e
			where  e.siteid = ', site, '
			group by 1,2,3

		),
        agg_cta_per_article_third as(
		select siteid as siteid,tags,sum(val) as agg_sum from
        cta_per_article_third
		where siteid = ', site, '
		group by 1,2
		),
        less_tg_data_third as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_ytd_article_published_third l
		join cta_per_article_third a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date  between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and g.site_id = ', site, '
		),
        counts_third as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_third
			group by 1,2
		),
        hits_by_tags_third as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_third
		   where siteid = ',site,'
		   group by 1,2)
           ,
           total_hits_third as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_third
			where  siteid = ',site,'
			group by 1)
            ,
            agg_data_third as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_third h
			join total_hits_third t on h.siteid=t.siteid
			join last_ytd_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = ',site,'
		),
        categories_d_third as (
			select 
				siteid as siteid ,
				 ',label_val,' as label,
                ',hint_val,' as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',order_statement_third,', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_third
		group by 1,2,3
		),
        categories_third as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_third
		),
        json_data_third as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_third
		)
    

    SELECT 
		CONCAT(
        ''{'',
            ''"site":'',jd.siteid,'','',
            ''"data": {'',
                ''"label": "'', jd.lab, ''",'',
                ''"categories": ['', jd.cat, ''],'',
                ''"series": ['', jd.series, '']'',
                '',"defaultTitle":"',dtitle,'"'',
                '',"additional":[ ''
                
                ,''{'',
                ''"title":"',title1,'",'',
                ''"data": {'',
                ''"label": "'',json_data_second.lab, ''",'',
                ''"categories": ['', json_data_second.cat, ''],'',
                ''"series": ['', json_data_second.series, '']'',
                ''}}''
                
                , '',''
                
                
                ,''{'',
                ''"title":"',title2,'",'',
                ''"data": {'',
                ''"label": "'',json_data_third.lab, ''",'',
                ''"categories": ['', json_data_third.cat, ''],'',
                ''"series": ['', json_data_third.series, '']'',
                ''}}''
                
                
        '']}}''
    
			) as json_data
		  FROM json_data jd
          
          CROSS join json_data_second
          
          CROSS join json_data_third
          ;
[0m18:28:56.046994 [debug] [MainThread]: Command `dbt compile` succeeded at 18:28:56.046994 after 2.03 seconds
[0m18:28:56.050984 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229C1881C90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229BB5B7CD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229BB5B7C50>]}
[0m18:28:56.051980 [debug] [MainThread]: Flushing usage events
[0m11:48:26.709157 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BDD86F0ED0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BDD86F35D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BDD86F00D0>]}


============================== 11:48:26.772183 | 60c81d0d-06e0-4f7f-a051-a6431659591c ==============================
[0m11:48:26.772183 [info ] [MainThread]: Running with dbt=1.8.1
[0m11:48:26.776173 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m11:48:26.794129 [error] [MainThread]: Encountered an error:
Runtime Error
  Could not find profile named 'sindri'
[0m11:48:26.799904 [debug] [MainThread]: Command `dbt run` failed at 11:48:26.799904 after 0.27 seconds
[0m11:48:26.801897 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BDD24D5DD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BDD873BF10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BDD873BED0>]}
[0m11:48:26.805886 [debug] [MainThread]: Flushing usage events
[0m11:49:14.453064 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019FFF223810>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019FFF2206D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019FFF220B50>]}


============================== 11:49:14.459046 | a74145f5-3edd-43f4-8ce8-415d9d053f2a ==============================
[0m11:49:14.459046 [info ] [MainThread]: Running with dbt=1.8.1
[0m11:49:14.461041 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m11:49:14.950459 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a74145f5-3edd-43f4-8ce8-415d9d053f2a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019FFF267B90>]}
[0m11:49:15.035256 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a74145f5-3edd-43f4-8ce8-415d9d053f2a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019FFC531010>]}
[0m11:49:15.037230 [info ] [MainThread]: Registered adapter: postgres=1.8.0
[0m11:49:15.066926 [debug] [MainThread]: checksum: ebc509fb14e151ea268e89b60fd5abf912ed99129f87516462718fa2f14f4838, vars: {}, profile: , target: , version: 1.8.1
[0m11:49:15.285270 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m11:49:15.287267 [info ] [MainThread]: Unable to do partial parsing because a project dependency has been added
[0m11:49:15.287839 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'a74145f5-3edd-43f4-8ce8-415d9d053f2a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019FFCFF2BD0>]}
[0m11:49:17.921949 [error] [MainThread]: Encountered an error:
Compilation Error
  dbt found two models with the name "example".
  
  Since these resources have the same name, dbt will be unable to find the correct resource
  when looking for ref("example").
  
  To fix this, change the name of one of these resources:
  - model.kasper_sindri_media.example (models\nextClick\example.sql)
  - model.kasper_sindri_media.example (models\example.sql)
[0m11:49:17.925939 [debug] [MainThread]: Command `dbt run` failed at 11:49:17.924939 after 3.58 seconds
[0m11:49:17.927942 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019FFF264B90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019FFF81F090>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019FF9035DD0>]}
[0m11:49:17.929928 [debug] [MainThread]: Flushing usage events
[0m11:50:51.603240 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EB85DE3990>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EB85E2A610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EB85E29050>]}


============================== 11:50:51.609221 | 0f4c24fc-b059-4683-afbe-d7e0e513c596 ==============================
[0m11:50:51.609221 [info ] [MainThread]: Running with dbt=1.8.1
[0m11:50:51.611218 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'version_check': 'True', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt run', 'send_anonymous_usage_stats': 'True'}
[0m11:50:51.900441 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0f4c24fc-b059-4683-afbe-d7e0e513c596', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EB861A5150>]}
[0m11:50:51.976241 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0f4c24fc-b059-4683-afbe-d7e0e513c596', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EB830F0F50>]}
[0m11:50:51.978236 [info ] [MainThread]: Registered adapter: postgres=1.8.0
[0m11:50:51.991202 [debug] [MainThread]: checksum: ebc509fb14e151ea268e89b60fd5abf912ed99129f87516462718fa2f14f4838, vars: {}, profile: , target: , version: 1.8.1
[0m11:50:52.076970 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m11:50:52.077967 [info ] [MainThread]: Unable to do partial parsing because a project dependency has been added
[0m11:50:52.079290 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '0f4c24fc-b059-4683-afbe-d7e0e513c596', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EB83BB2B10>]}
[0m11:50:54.154741 [error] [MainThread]: Encountered an error:
Compilation Error
  dbt found two models with the name "overview_sales_card_12".
  
  Since these resources have the same name, dbt will be unable to find the correct resource
  when looking for ref("overview_sales_card_12").
  
  To fix this, change the name of one of these resources:
  - model.kasper_sindri_media.overview_sales_card_12 (models\example\overview_sales_card_12.sql)
  - model.kasper_sindri_media.overview_sales_card_12 (models\overview_sales_card_12.sql)
[0m11:50:54.158730 [debug] [MainThread]: Command `dbt run` failed at 11:50:54.157735 after 2.65 seconds
[0m11:50:54.159730 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EB85E33D50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EB8624BB90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EB85E33ED0>]}
[0m11:50:54.160726 [debug] [MainThread]: Flushing usage events
[0m11:51:40.559908 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001602D8F0990>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001602D8F0AD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001602D8F3790>]}


============================== 11:51:40.568882 | 46d7c2b1-7c45-44c0-83bc-b181c01c978c ==============================
[0m11:51:40.568882 [info ] [MainThread]: Running with dbt=1.8.1
[0m11:51:40.570875 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'version_check': 'True', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m11:51:40.881048 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '46d7c2b1-7c45-44c0-83bc-b181c01c978c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001602DCC7B10>]}
[0m11:51:40.961831 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '46d7c2b1-7c45-44c0-83bc-b181c01c978c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001602AC00C10>]}
[0m11:51:40.964822 [info ] [MainThread]: Registered adapter: postgres=1.8.0
[0m11:51:40.979350 [debug] [MainThread]: checksum: ebc509fb14e151ea268e89b60fd5abf912ed99129f87516462718fa2f14f4838, vars: {}, profile: , target: , version: 1.8.1
[0m11:51:41.071105 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m11:51:41.072367 [info ] [MainThread]: Unable to do partial parsing because a project dependency has been added
[0m11:51:41.073634 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '46d7c2b1-7c45-44c0-83bc-b181c01c978c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001602B6C2DD0>]}
[0m11:51:42.607535 [error] [MainThread]: Encountered an error:
Compilation Error
  dbt found two models with the name "example".
  
  Since these resources have the same name, dbt will be unable to find the correct resource
  when looking for ref("example").
  
  To fix this, change the name of one of these resources:
  - model.kasper_sindri_media.example (models\nextClick\example.sql)
  - model.kasper_sindri_media.example (models\example.sql)
[0m11:51:42.610751 [debug] [MainThread]: Command `dbt run` failed at 11:51:42.609755 after 2.15 seconds
[0m11:51:42.610751 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001602D943E90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001602D9175D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001602D6B2550>]}
[0m11:51:42.611748 [debug] [MainThread]: Flushing usage events
[0m11:52:38.700371 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018AA3F4C390>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018AA3F4F3D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018AA3F4F390>]}


============================== 11:52:38.708351 | b4009cfa-9e0e-4b93-bd11-ab94e28dacde ==============================
[0m11:52:38.708351 [info ] [MainThread]: Running with dbt=1.8.1
[0m11:52:38.710343 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'debug': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m11:52:39.001563 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'b4009cfa-9e0e-4b93-bd11-ab94e28dacde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018AA4304A50>]}
[0m11:52:39.080395 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'b4009cfa-9e0e-4b93-bd11-ab94e28dacde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018AA1251050>]}
[0m11:52:39.082347 [info ] [MainThread]: Registered adapter: postgres=1.8.0
[0m11:52:39.095314 [debug] [MainThread]: checksum: ebc509fb14e151ea268e89b60fd5abf912ed99129f87516462718fa2f14f4838, vars: {}, profile: , target: , version: 1.8.1
[0m11:52:39.180087 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m11:52:39.181084 [info ] [MainThread]: Unable to do partial parsing because a project dependency has been added
[0m11:52:39.182080 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'b4009cfa-9e0e-4b93-bd11-ab94e28dacde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018AA4265C90>]}
[0m11:52:40.582340 [error] [MainThread]: Encountered an error:
Compilation Error
  dbt found two models with the name "test".
  
  Since these resources have the same name, dbt will be unable to find the correct resource
  when looking for ref("test").
  
  To fix this, change the name of one of these resources:
  - model.kasper_sindri_media.test (models\nextClick\test.sql)
  - model.kasper_sindri_media.test (models\test.sql)
[0m11:52:40.585705 [debug] [MainThread]: Command `dbt run` failed at 11:52:40.585705 after 1.98 seconds
[0m11:52:40.586704 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018AA3D01C90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018AA4421710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018A9DC40990>]}
[0m11:52:40.587700 [debug] [MainThread]: Flushing usage events
[0m11:53:15.794298 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2E14C1010>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2E14C1190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2E14C3550>]}


============================== 11:53:15.800283 | 1cb0741c-0a13-4cdc-9a61-9ef79b1b7f90 ==============================
[0m11:53:15.800283 [info ] [MainThread]: Running with dbt=1.8.1
[0m11:53:15.801280 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'version_check': 'True', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt run', 'send_anonymous_usage_stats': 'True'}
[0m11:53:16.092501 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1cb0741c-0a13-4cdc-9a61-9ef79b1b7f90', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2E182E450>]}
[0m11:53:16.170294 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1cb0741c-0a13-4cdc-9a61-9ef79b1b7f90', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2DE7D0D90>]}
[0m11:53:16.172711 [info ] [MainThread]: Registered adapter: postgres=1.8.0
[0m11:53:16.187523 [debug] [MainThread]: checksum: ebc509fb14e151ea268e89b60fd5abf912ed99129f87516462718fa2f14f4838, vars: {}, profile: , target: , version: 1.8.1
[0m11:53:16.271299 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m11:53:16.273295 [info ] [MainThread]: Unable to do partial parsing because a project dependency has been added
[0m11:53:16.275500 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '1cb0741c-0a13-4cdc-9a61-9ef79b1b7f90', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2DF292CD0>]}
[0m11:53:17.784456 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.dbt_test.example
[0m11:53:17.792429 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1cb0741c-0a13-4cdc-9a61-9ef79b1b7f90', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2E1B319D0>]}
[0m11:53:18.029671 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1cb0741c-0a13-4cdc-9a61-9ef79b1b7f90', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2DEDF5B10>]}
[0m11:53:18.030668 [info ] [MainThread]: Found 10 models, 413 macros
[0m11:53:18.032663 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1cb0741c-0a13-4cdc-9a61-9ef79b1b7f90', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2DEDF7C10>]}
[0m11:53:18.036682 [info ] [MainThread]: 
[0m11:53:18.038773 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m11:53:18.048361 [debug] [ThreadPool]: Acquiring new postgres connection 'list_kasper_sindri_media'
[0m11:53:21.120822 [debug] [ThreadPool]: Using postgres connection "list_kasper_sindri_media"
[0m11:53:21.121821 [debug] [ThreadPool]: On list_kasper_sindri_media: /* {"app": "dbt", "dbt_version": "1.8.1", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_kasper_sindri_media"} */

    select distinct nspname from pg_namespace
  
[0m11:53:21.121821 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:53:21.199362 [debug] [ThreadPool]: Postgres adapter: Got a retryable error when attempting to open a postgres connection.
1 attempts remaining. Retrying in 0 seconds.
Error:
connection to server at "localhost" (::1), port 5432 failed: FATAL:  database "kasper_sindri_media" does not exist

[0m11:53:21.254216 [debug] [ThreadPool]: Postgres adapter: Error running SQL: /* {"app": "dbt", "dbt_version": "1.8.1", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_kasper_sindri_media"} */

    select distinct nspname from pg_namespace
  
[0m11:53:21.255215 [debug] [ThreadPool]: Postgres adapter: Rolling back transaction.
[0m11:53:21.256212 [debug] [ThreadPool]: Postgres adapter: Error running SQL: macro list_schemas
[0m11:53:21.257209 [debug] [ThreadPool]: Postgres adapter: Rolling back transaction.
[0m11:53:21.258207 [debug] [ThreadPool]: On list_kasper_sindri_media: No close available on handle
[0m11:53:21.259204 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:53:21.260211 [debug] [MainThread]: Connection 'list_kasper_sindri_media' was properly closed.
[0m11:53:21.261198 [info ] [MainThread]: 
[0m11:53:21.262196 [info ] [MainThread]: Finished running  in 0 hours 0 minutes and 3.22 seconds (3.22s).
[0m11:53:21.263191 [error] [MainThread]: Encountered an error:
Database Error
  connection to server at "localhost" (::1), port 5432 failed: FATAL:  database "kasper_sindri_media" does not exist
  
[0m11:53:21.265186 [debug] [MainThread]: Command `dbt run` failed at 11:53:21.265186 after 5.57 seconds
[0m11:53:21.266183 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2E14E7650>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2E1281C90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2E19F7210>]}
[0m11:53:21.267180 [debug] [MainThread]: Flushing usage events
[0m12:02:56.625206 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028E39F1C450>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028E39F1F490>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028E39F1F450>]}


============================== 12:02:56.633184 | 772f7c2c-349d-4787-a76f-4e5a123af975 ==============================
[0m12:02:56.633184 [info ] [MainThread]: Running with dbt=1.8.1
[0m12:02:56.635180 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'debug': 'False', 'warn_error': 'None', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run', 'send_anonymous_usage_stats': 'True'}
[0m12:02:56.646149 [info ] [MainThread]: Error importing adapter: No module named 'dbt.adapters.mysql'
[0m12:02:56.648146 [error] [MainThread]: Encountered an error:
Runtime Error
  Credentials in profile "kasper", target "dev" invalid: Runtime Error
    Could not find adapter type mysql!
[0m12:02:56.650792 [debug] [MainThread]: Command `dbt run` failed at 12:02:56.649794 after 0.13 seconds
[0m12:02:56.651797 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028E39F37690>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028E39CD1C90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028E39F52710>]}
[0m12:02:56.651797 [debug] [MainThread]: Flushing usage events
[0m12:03:24.729922 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027D5F3A07D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027D5F38EDD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027D5F38F0D0>]}


============================== 12:03:24.738897 | d9b12da2-4138-4901-9802-fc0987c1e445 ==============================
[0m12:03:24.738897 [info ] [MainThread]: Running with dbt=1.8.1
[0m12:03:24.740894 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m12:03:24.747874 [error] [MainThread]: Encountered an error:
Runtime Error
  The profile 'kasper' does not have a target named 'site_dev'. The valid target names for this profile are:
   - dev
[0m12:03:24.750867 [debug] [MainThread]: Command `dbt run` failed at 12:03:24.750867 after 0.12 seconds
[0m12:03:24.751866 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027D5F3A35D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027D5F3E3150>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027D5F3E3A50>]}
[0m12:03:24.752862 [debug] [MainThread]: Flushing usage events
[0m12:06:57.685220 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026550C60950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026550C60BD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026550C63610>]}


============================== 12:06:57.694196 | 221a7f8f-fd26-4a99-ad86-b4f3a229eb42 ==============================
[0m12:06:57.694196 [info ] [MainThread]: Running with dbt=1.8.1
[0m12:06:57.695193 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'debug': 'False', 'version_check': 'True', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'invocation_command': 'dbt run', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m12:06:57.702177 [error] [MainThread]: Encountered an error:
Runtime Error
  The profile 'kasper' does not have a target named 'site_dev'. The valid target names for this profile are:
   - dev
[0m12:06:57.704370 [debug] [MainThread]: Command `dbt run` failed at 12:06:57.704370 after 0.12 seconds
[0m12:06:57.705368 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026550A21C90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002654AA65DD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026550C4EE90>]}
[0m12:06:57.706366 [debug] [MainThread]: Flushing usage events
[0m12:08:31.168207 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019F00F11490>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019F00F11590>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019F00F10310>]}


============================== 12:08:31.175188 | 6a58262f-fb8b-454e-a5d7-6faf04cd722c ==============================
[0m12:08:31.175188 [info ] [MainThread]: Running with dbt=1.8.1
[0m12:08:31.176189 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m12:08:31.185161 [error] [MainThread]: Encountered an error:
Runtime Error
  The profile 'kasper' does not have a target named 'site_dev'. The valid target names for this profile are:
   - dev
[0m12:08:31.187156 [debug] [MainThread]: Command `dbt run` failed at 12:08:31.187156 after 0.13 seconds
[0m12:08:31.188153 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019F7AC00950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019F00EFFFD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019F00EFDCD0>]}
[0m12:08:31.189151 [debug] [MainThread]: Flushing usage events
[0m12:10:24.266829 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E9DD230A10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E9DD230D90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E9DD230250>]}


============================== 12:10:24.275816 | 5a3c3db9-ddac-417a-8863-72a5e925ae88 ==============================
[0m12:10:24.275816 [info ] [MainThread]: Running with dbt=1.8.1
[0m12:10:24.277801 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m12:10:24.284782 [error] [MainThread]: Encountered an error:
Runtime Error
  The profile 'kasper' does not have a target named 'site_dev'. The valid target names for this profile are:
   - dev
[0m12:10:24.286788 [debug] [MainThread]: Command `dbt run` failed at 12:10:24.286788 after 0.14 seconds
[0m12:10:24.287773 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E9DD233590>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E9DD27FBD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E9D7045DD0>]}
[0m12:10:24.288770 [debug] [MainThread]: Flushing usage events
[0m12:10:58.046180 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024DD0600D10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024DD0646550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024DD0600E90>]}


============================== 12:10:58.055155 | df1dbc70-2c25-4a11-ba01-366207f6f1da ==============================
[0m12:10:58.055155 [info ] [MainThread]: Running with dbt=1.8.1
[0m12:10:58.057149 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run', 'send_anonymous_usage_stats': 'True'}
[0m12:10:58.066125 [info ] [MainThread]: Error importing adapter: No module named 'dbt.adapters.mysql'
[0m12:10:58.067124 [error] [MainThread]: Encountered an error:
Runtime Error
  Credentials in profile "kasper", target "dev" invalid: Runtime Error
    Could not find adapter type mysql!
[0m12:10:58.069118 [debug] [MainThread]: Command `dbt run` failed at 12:10:58.069118 after 0.13 seconds
[0m12:10:58.070115 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024DD05F96D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024DD05FA490>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024DCA425DD0>]}
[0m12:10:58.071113 [debug] [MainThread]: Flushing usage events
[0m12:12:05.013786 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000190DB8A6510>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000190DB8A76D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000190DB8A5AD0>]}


============================== 12:12:05.020767 | 117be3b3-4533-4ad2-8bcf-e7be1e1107ca ==============================
[0m12:12:05.020767 [info ] [MainThread]: Running with dbt=1.7.17
[0m12:12:05.022762 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'version_check': 'True', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m12:12:05.520144 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '117be3b3-4533-4ad2-8bcf-e7be1e1107ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000190DBA359D0>]}
[0m12:12:05.609902 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '117be3b3-4533-4ad2-8bcf-e7be1e1107ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000190DBAA7A10>]}
[0m12:12:05.611898 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m12:12:05.625860 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m12:12:05.648809 [info ] [MainThread]: Unable to do partial parsing because of a version mismatch
[0m12:12:05.650313 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '117be3b3-4533-4ad2-8bcf-e7be1e1107ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000190DBB1DCD0>]}
[0m12:12:07.785562 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.dbt_test.example
[0m12:12:07.797527 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '117be3b3-4533-4ad2-8bcf-e7be1e1107ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000190DBD93390>]}
[0m12:12:07.818472 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '117be3b3-4533-4ad2-8bcf-e7be1e1107ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000190DBA7D590>]}
[0m12:12:07.820468 [info ] [MainThread]: Found 10 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m12:12:07.822466 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '117be3b3-4533-4ad2-8bcf-e7be1e1107ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000190DBCBEE90>]}
[0m12:12:07.827447 [info ] [MainThread]: 
[0m12:12:07.829009 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m12:12:07.831996 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m12:12:07.846946 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m12:12:07.847944 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m12:12:07.848942 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:12:09.816802 [debug] [ThreadPool]: SQL status: SUCCESS 10 in 2.0 seconds
[0m12:12:09.826502 [debug] [ThreadPool]: On list_schemas: Close
[0m12:12:09.832487 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m12:12:09.836476 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m12:12:09.850437 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:12:09.851434 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m12:12:09.852432 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:12:11.623605 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:12:11.625598 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:12:11.627593 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m12:12:12.271319 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m12:12:12.277311 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m12:12:12.280303 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:12:12.283297 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m12:12:12.886588 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:12:12.889592 [debug] [ThreadPool]: On create__site_dev: Close
[0m12:12:12.900190 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m12:12:12.911160 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m12:12:12.912157 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m12:12:12.912157 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:12:14.491447 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:12:14.492448 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m12:12:14.493445 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m12:12:15.086461 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:12:15.094431 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m12:12:15.291599 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m12:12:15.297612 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '117be3b3-4533-4ad2-8bcf-e7be1e1107ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000190DBCA3010>]}
[0m12:12:15.299607 [debug] [MainThread]: Using mysql connection "master"
[0m12:12:15.301600 [debug] [MainThread]: On master: BEGIN
[0m12:12:15.302595 [debug] [MainThread]: Opening a new connection, currently in state init
[0m12:12:16.861603 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:12:16.863617 [debug] [MainThread]: On master: COMMIT
[0m12:12:16.864618 [debug] [MainThread]: Using mysql connection "master"
[0m12:12:16.866605 [debug] [MainThread]: On master: COMMIT
[0m12:12:17.439117 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:12:17.440117 [debug] [MainThread]: On master: Close
[0m12:12:17.443105 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m12:12:17.445102 [info ] [MainThread]: 
[0m12:12:17.451083 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.cards
[0m12:12:17.452080 [info ] [Thread-1 (]: 1 of 10 START sql view model site_dev.cards .................................... [RUN]
[0m12:12:17.454075 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.kasper_sindri_media.cards'
[0m12:12:17.455073 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.cards
[0m12:12:17.472031 [debug] [Thread-1 (]: Writing injected SQL for node "model.kasper_sindri_media.cards"
[0m12:12:17.474023 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.cards (compile): 12:12:17.456071 => 12:12:17.473025
[0m12:12:17.476017 [debug] [Thread-1 (]: Began executing node model.kasper_sindri_media.cards
[0m12:12:17.537850 [debug] [Thread-1 (]: Writing runtime sql for node "model.kasper_sindri_media.cards"
[0m12:12:17.544834 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.cards"
[0m12:12:17.545830 [debug] [Thread-1 (]: On model.kasper_sindri_media.cards: BEGIN
[0m12:12:17.546828 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m12:12:19.101680 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:12:19.103675 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.cards"
[0m12:12:19.105669 [debug] [Thread-1 (]: On model.kasper_sindri_media.cards: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.kasper_sindri_media.cards"} */

  create view `site_dev`.`cards__dbt_tmp`
    
    
  as (
    CREATE DEFINER=`Site`@`%` PROCEDURE `tactical_articles_card_month`(
IN site INT, IN label_val VARCHAR(200), IN hint_val text
)
BEGIN
with last_30_day as
(
SELECT siteId as siteId,count(date) as value FROM prod.site_archive_post
where 
date between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and siteid =site
group by 1
),
last_30_days_before as 
(
SELECT siteId as siteId,count(*) value  FROM prod.site_archive_post
where 
date between DATE_SUB(NOW(), INTERVAL 60 DAY) and DATE_SUB(NOW(), INTERVAL 30 DAY) and siteid =site
group by 1
)
select 
JSON_OBJECT(
'site',ld.siteId,'data',
JSON_OBJECT('label', label_val, 'hint',hint_val,'value',
COALESCE(ld.value,0),
'change',COALESCE(round(((ld.value-lb.value)/lb.value)*100,2),0), 
'progressCurrent','','progressTotal',''))AS json_data
from last_30_day ld
left join last_30_days_before lb
on ld.siteId=lb.siteId
;

END
  );
[0m12:12:19.690897 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `tactical_articles_card_month`(
IN site INT' at line 7
[0m12:12:19.692892 [debug] [Thread-1 (]: On model.kasper_sindri_media.cards: ROLLBACK
[0m12:12:19.888369 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.cards (execute): 12:12:17.477013 => 12:12:19.887371
[0m12:12:19.889367 [debug] [Thread-1 (]: On model.kasper_sindri_media.cards: Close
[0m12:12:19.977131 [debug] [Thread-1 (]: Database Error in model cards (models\cards.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `tactical_articles_card_month`(
  IN site INT' at line 7
  compiled Code at target\run\kasper_sindri_media\models\cards.sql
[0m12:12:19.978129 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '117be3b3-4533-4ad2-8bcf-e7be1e1107ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000190DBD82C50>]}
[0m12:12:19.980124 [error] [Thread-1 (]: 1 of 10 ERROR creating sql view model site_dev.cards ........................... [[31mERROR[0m in 2.53s]
[0m12:12:19.982119 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.cards
[0m12:12:19.983126 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.example_by
[0m12:12:19.985111 [info ] [Thread-1 (]: 2 of 10 START sql view model site_dev.example_by ............................... [RUN]
[0m12:12:19.987105 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.kasper_sindri_media.cards, now model.kasper_sindri_media.example_by)
[0m12:12:19.989100 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.example_by
[0m12:12:19.995086 [debug] [Thread-1 (]: Writing injected SQL for node "model.kasper_sindri_media.example_by"
[0m12:12:19.997079 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.example_by (compile): 12:12:19.990097 => 12:12:19.996082
[0m12:12:19.998077 [debug] [Thread-1 (]: Began executing node model.kasper_sindri_media.example_by
[0m12:12:20.005057 [debug] [Thread-1 (]: Writing runtime sql for node "model.kasper_sindri_media.example_by"
[0m12:12:20.011049 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.example_by"
[0m12:12:20.012039 [debug] [Thread-1 (]: On model.kasper_sindri_media.example_by: BEGIN
[0m12:12:20.014033 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m12:12:21.608985 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:12:21.609981 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.example_by"
[0m12:12:21.610980 [debug] [Thread-1 (]: On model.kasper_sindri_media.example_by: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.kasper_sindri_media.example_by"} */

  create view `site_dev`.`example_by__dbt_tmp`
    
    
  as (
    -- template.sql

CREATE PROCEDURE `example_procedure`(
    IN site_id INT,
    IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = '
    SELECT *
    FROM events
    WHERE site_id = 
    AND event_action = ""';
    
    PREPARE stmt FROM @sql_query;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
END;
  );
[0m12:12:22.200924 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `example_procedure`(
    IN site_id INT,
    IN event_action VA' at line 9
[0m12:12:22.204910 [debug] [Thread-1 (]: On model.kasper_sindri_media.example_by: ROLLBACK
[0m12:12:22.406204 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.example_by (execute): 12:12:19.999074 => 12:12:22.404196
[0m12:12:22.408192 [debug] [Thread-1 (]: On model.kasper_sindri_media.example_by: Close
[0m12:12:22.422158 [debug] [Thread-1 (]: Database Error in model example_by (models\example_by.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `example_procedure`(
      IN site_id INT,
      IN event_action VA' at line 9
  compiled Code at target\run\kasper_sindri_media\models\example_by.sql
[0m12:12:22.424155 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '117be3b3-4533-4ad2-8bcf-e7be1e1107ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000190DBAC1110>]}
[0m12:12:22.426164 [error] [Thread-1 (]: 2 of 10 ERROR creating sql view model site_dev.example_by ...................... [[31mERROR[0m in 2.44s]
[0m12:12:22.430134 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.example_by
[0m12:12:22.431135 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.example_by_me
[0m12:12:22.433126 [info ] [Thread-1 (]: 3 of 10 START sql view model site_dev.example_by_me ............................ [RUN]
[0m12:12:22.435122 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.kasper_sindri_media.example_by, now model.kasper_sindri_media.example_by_me)
[0m12:12:22.436118 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.example_by_me
[0m12:12:22.441105 [debug] [Thread-1 (]: Writing injected SQL for node "model.kasper_sindri_media.example_by_me"
[0m12:12:22.443099 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.example_by_me (compile): 12:12:22.437143 => 12:12:22.442101
[0m12:12:22.444095 [debug] [Thread-1 (]: Began executing node model.kasper_sindri_media.example_by_me
[0m12:12:22.452073 [debug] [Thread-1 (]: Writing runtime sql for node "model.kasper_sindri_media.example_by_me"
[0m12:12:22.454073 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.example_by_me"
[0m12:12:22.455066 [debug] [Thread-1 (]: On model.kasper_sindri_media.example_by_me: BEGIN
[0m12:12:22.456065 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m12:12:24.083511 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:12:24.085521 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.example_by_me"
[0m12:12:24.088498 [debug] [Thread-1 (]: On model.kasper_sindri_media.example_by_me: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.kasper_sindri_media.example_by_me"} */

  create view `site_dev`.`example_by_me__dbt_tmp`
    
    
  as (
    -- template.sql

CREATE PROCEDURE `example_procedure`(
    IN site_id INT,
    IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = '
    SELECT *
    FROM events
    WHERE site_id = 
    AND event_action = ""';
    
    PREPARE stmt FROM @sql_query;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
END;
  );
[0m12:12:24.685722 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `example_procedure`(
    IN site_id INT,
    IN event_action VA' at line 9
[0m12:12:24.688714 [debug] [Thread-1 (]: On model.kasper_sindri_media.example_by_me: ROLLBACK
[0m12:12:24.896297 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.example_by_me (execute): 12:12:22.445092 => 12:12:24.894285
[0m12:12:24.898285 [debug] [Thread-1 (]: On model.kasper_sindri_media.example_by_me: Close
[0m12:12:24.903272 [debug] [Thread-1 (]: Database Error in model example_by_me (models\nextClick\example_by_me.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `example_procedure`(
      IN site_id INT,
      IN event_action VA' at line 9
  compiled Code at target\run\kasper_sindri_media\models\nextClick\example_by_me.sql
[0m12:12:24.904265 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '117be3b3-4533-4ad2-8bcf-e7be1e1107ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000190DBB07ED0>]}
[0m12:12:24.905263 [error] [Thread-1 (]: 3 of 10 ERROR creating sql view model site_dev.example_by_me ................... [[31mERROR[0m in 2.47s]
[0m12:12:24.907272 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.example_by_me
[0m12:12:24.908255 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.overview_sales_card_12
[0m12:12:24.909260 [info ] [Thread-1 (]: 4 of 10 START sql view model site_dev.overview_sales_card_12 ................... [RUN]
[0m12:12:24.911147 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.kasper_sindri_media.example_by_me, now model.kasper_sindri_media.overview_sales_card_12)
[0m12:12:24.911147 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.overview_sales_card_12
[0m12:12:24.923191 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.overview_sales_card_12 (compile): 12:12:24.912144 => 12:12:24.922190
[0m12:12:24.927179 [debug] [Thread-1 (]: Compilation Error in model overview_sales_card_12 (models\example\overview_sales_card_12.sql)
  Required var 'date' not found in config:
  Vars supplied to overview_sales_card_12 = {
      "article_evaluation": {
          "over_both_goals": {
              "case": "((coalesce(coalesce(l.hits,0)/coalesce(l.pageviews,0)*100,0))>=coalesce(g.Min_CTA,0) and coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0) )",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          },
          "under_both_goal": {
              "case": "(coalesce((coalesce(l.hits,0)/coalesce(l.pageviews,0)*100),0)<coalesce(g.Min_CTA,0) and coalesce(l.pageviews,0)<coalesce(g.Min_pageviews,0) )",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          },
          "under_one_goal": {
              "case": "(coalesce( coalesce((coalesce(l.hits,0) / coalesce(l.pageviews,0)),0) * 100 , 0)>=coalesce(g.Min_CTA,0) or coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0)) and !((coalesce( coalesce((coalesce(l.hits,0) / coalesce(l.pageviews,0)),0) * 100 , 0))>=coalesce(g.Min_CTA,0) and  coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0) ) ",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          }
      },
      "date_month": "DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)",
      "date_week": "DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)",
      "date_year": "MAKEDATE(EXTRACT(YEAR FROM CURDATE()), 1) AND DATE_SUB(CAST(NOW() AS DATE), INTERVAL 1 DAY)",
      "event_action": "Next Click",
      "overview": {
          "overview_pageviews_card": {
              "hint": "Sidevisninger \u00e5r til dato ift sidste \u00e5r til dato og ift m\u00e5ls\u00e6tning",
              "label": "Sidevisninger"
          },
          "overview_sales_card": {
              "hint": "Gns. next click \u00e5r til dato ift. sidste \u00e5r",
              "label": "Next click (%)"
          },
          "overview_visits_card": {
              "hint": "Bes\u00f8g \u00e5r til dato ift sidste \u00e5r til dato og ift m\u00e5ls\u00e6tning",
              "label": "Bes\u00f8g"
          }
      },
      "site": 12,
      "tendency": {
          "tactical_articles_card": {
              "hint": "Artikler publiceret seneste 30 dage ift. forrige 30 dage",
              "label": "Artikler"
          },
          "tactical_clicks_card": {
              "hint": "Gns. next click p\u00e5 artikler publiceret seneste 30 dage ift. forrige 30 dage",
              "label": "Gns. next click (%)"
          },
          "tactical_pageviews_card": {
              "hint": "Gns. sidevisninger pr artikler publiceret \u00e5r til dato ift. sidste \u00e5r til dato",
              "label": "Gns. sidevisninger pr artikel"
          },
          "tactical_userneeds_pageviews_chart": {
              "dropdown_count": [
                  "",
                  "_second",
                  "_third"
              ],
              "dropdown_name": {
                  "Categories": "Categories",
                  "Tags": "Tags",
                  "userneeds": "userneeds"
              },
              "dropdown_val": {
                  "categories": [
                      "Nyheder",
                      "Debat",
                      "Inspiration",
                      "Anmeldelser"
                  ],
                  "tags": [
                      "skolepolitik",
                      "Psykisk arbejdsmilj\u00f8"
                  ],
                  "userneeds": [
                      "Opdater mig",
                      "Forbind mig",
                      "Hj\u00e6lp mig med at forst\u00e5",
                      "Giv mig en fordel",
                      "Underhold mig",
                      "Inspirer mig"
                  ]
              },
              "hint": "Artikler grupperet ift hvordan de har performet p\u00e5 next click",
              "label": "Artikler ift. next click m\u00e5l"
          }
      }
  }
[0m12:12:24.929174 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '117be3b3-4533-4ad2-8bcf-e7be1e1107ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000190DBBC81D0>]}
[0m12:12:24.930172 [error] [Thread-1 (]: 4 of 10 ERROR creating sql view model site_dev.overview_sales_card_12 .......... [[31mERROR[0m in 0.02s]
[0m12:12:24.931761 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.overview_sales_card_12
[0m12:12:24.931761 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.tactical_articles_cards
[0m12:12:24.933756 [info ] [Thread-1 (]: 5 of 10 START sql view model site_dev.tactical_articles_cards .................. [RUN]
[0m12:12:24.935482 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.kasper_sindri_media.overview_sales_card_12, now model.kasper_sindri_media.tactical_articles_cards)
[0m12:12:24.935482 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.tactical_articles_cards
[0m12:12:24.941465 [debug] [Thread-1 (]: Writing injected SQL for node "model.kasper_sindri_media.tactical_articles_cards"
[0m12:12:24.943462 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.tactical_articles_cards (compile): 12:12:24.936479 => 12:12:24.942463
[0m12:12:24.944458 [debug] [Thread-1 (]: Began executing node model.kasper_sindri_media.tactical_articles_cards
[0m12:12:24.950444 [debug] [Thread-1 (]: Writing runtime sql for node "model.kasper_sindri_media.tactical_articles_cards"
[0m12:12:24.952439 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.tactical_articles_cards"
[0m12:12:24.953436 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_cards: BEGIN
[0m12:12:24.954432 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m12:12:26.542795 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:12:26.545790 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.tactical_articles_cards"
[0m12:12:26.547784 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_cards: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.kasper_sindri_media.tactical_articles_cards"} */

  create view `site_dev`.`tactical_articles_cards__dbt_tmp`
    
    
  as (
    
  PREPARE stmt FROM @sql_query;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt;
END;
  );
[0m12:12:27.141791 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'PREPARE stmt FROM @sql_query;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt;
END;
  ' at line 8
[0m12:12:27.144779 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_cards: ROLLBACK
[0m12:12:27.346719 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.tactical_articles_cards (execute): 12:12:24.945456 => 12:12:27.344697
[0m12:12:27.349712 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_cards: Close
[0m12:12:27.358684 [debug] [Thread-1 (]: Database Error in model tactical_articles_cards (models\nextClick\tactical_articles_cards.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'PREPARE stmt FROM @sql_query;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
  END;
    ' at line 8
  compiled Code at target\run\kasper_sindri_media\models\nextClick\tactical_articles_cards.sql
[0m12:12:27.359694 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '117be3b3-4533-4ad2-8bcf-e7be1e1107ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000190DBB721D0>]}
[0m12:12:27.360679 [error] [Thread-1 (]: 5 of 10 ERROR creating sql view model site_dev.tactical_articles_cards ......... [[31mERROR[0m in 2.43s]
[0m12:12:27.362673 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.tactical_articles_cards
[0m12:12:27.364669 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.tactical_userneeds_pageviews_chart
[0m12:12:27.365665 [info ] [Thread-1 (]: 6 of 10 START sql view model site_dev.tactical_userneeds_pageviews_chart ....... [RUN]
[0m12:12:27.367660 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.kasper_sindri_media.tactical_articles_cards, now model.kasper_sindri_media.tactical_userneeds_pageviews_chart)
[0m12:12:27.368659 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.tactical_userneeds_pageviews_chart
[0m12:12:27.384617 [debug] [Thread-1 (]: Writing injected SQL for node "model.kasper_sindri_media.tactical_userneeds_pageviews_chart"
[0m12:12:27.386610 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.tactical_userneeds_pageviews_chart (compile): 12:12:27.369658 => 12:12:27.385611
[0m12:12:27.387607 [debug] [Thread-1 (]: Began executing node model.kasper_sindri_media.tactical_userneeds_pageviews_chart
[0m12:12:27.393591 [debug] [Thread-1 (]: Writing runtime sql for node "model.kasper_sindri_media.tactical_userneeds_pageviews_chart"
[0m12:12:27.400725 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.tactical_userneeds_pageviews_chart"
[0m12:12:27.401721 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_userneeds_pageviews_chart: BEGIN
[0m12:12:27.402718 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m12:12:28.970608 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:12:28.973595 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.tactical_userneeds_pageviews_chart"
[0m12:12:28.975586 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_userneeds_pageviews_chart: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.kasper_sindri_media.tactical_userneeds_pageviews_chart"} */

  create view `site_dev`.`tactical_userneeds_pageviews_chart__dbt_tmp`
    
    
  as (
    CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_month_11_dbt_test`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement VARCHAR(2000),
    IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
    IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
    IN event_action VARCHAR(255)
)
BEGIN
    DECLARE sql_query TEXT; -- Declare variable to hold dynamic SQL query

    -- Construct the dynamic SQL query
    SET @sql_query = CONCAT('
        WITH ')
         
    PREPARE stmt FROM @sql_query;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
END;
  );
[0m12:12:29.556408 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_' at line 7
[0m12:12:29.559399 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_userneeds_pageviews_chart: ROLLBACK
[0m12:12:29.755322 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.tactical_userneeds_pageviews_chart (execute): 12:12:27.388604 => 12:12:29.754324
[0m12:12:29.756319 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_userneeds_pageviews_chart: Close
[0m12:12:29.763298 [debug] [Thread-1 (]: Database Error in model tactical_userneeds_pageviews_chart (models\nextClick\tactical_userneeds_pageviews_chart.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_' at line 7
  compiled Code at target\run\kasper_sindri_media\models\nextClick\tactical_userneeds_pageviews_chart.sql
[0m12:12:29.765294 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '117be3b3-4533-4ad2-8bcf-e7be1e1107ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000190DBD50250>]}
[0m12:12:29.766289 [error] [Thread-1 (]: 6 of 10 ERROR creating sql view model site_dev.tactical_userneeds_pageviews_chart  [[31mERROR[0m in 2.40s]
[0m12:12:29.768284 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.tactical_userneeds_pageviews_chart
[0m12:12:29.769282 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13
[0m12:12:29.771276 [info ] [Thread-1 (]: 7 of 10 START sql view model site_dev.tactical_userneeds_pageviews_chart_month_13  [RUN]
[0m12:12:29.772815 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.kasper_sindri_media.tactical_userneeds_pageviews_chart, now model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13)
[0m12:12:29.772815 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13
[0m12:12:29.792762 [debug] [Thread-1 (]: Writing injected SQL for node "model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13"
[0m12:12:29.794758 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13 (compile): 12:12:29.773813 => 12:12:29.793759
[0m12:12:29.795754 [debug] [Thread-1 (]: Began executing node model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13
[0m12:12:29.802735 [debug] [Thread-1 (]: Writing runtime sql for node "model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13"
[0m12:12:29.804731 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13"
[0m12:12:29.805727 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13: BEGIN
[0m12:12:29.805727 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m12:12:31.373669 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:12:31.376653 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13"
[0m12:12:31.380651 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13"} */

  create view `site_dev`.`tactical_userneeds_pageviews_chart_month_13__dbt_tmp`
    
    
  as (
    CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_month_13_dbt_test`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    

    SELECT 
		CONCAT(
        ''{'',
            ''"site":'',jd.siteid,'','',
            ''"data": {'',
                ''"label": "'', jd.lab, ''",'',
                ''"categories": ['', jd.cat, ''],'',
                ''"series": ['', jd.series, '']'',
                '',"defaultTitle":"',dtitle,'"'',
                '',"additional":[ ''
                
        '']}}''
    
			) as json_data
		  FROM json_data jd
          ;
  );
[0m12:12:31.992003 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_' at line 7
[0m12:12:31.993991 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13: ROLLBACK
[0m12:12:32.200030 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13 (execute): 12:12:29.796756 => 12:12:32.199033
[0m12:12:32.202027 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13: Close
[0m12:12:32.213991 [debug] [Thread-1 (]: Database Error in model tactical_userneeds_pageviews_chart_month_13 (models\nextClick\tactical_userneeds_pageviews_chart_month_13.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_' at line 7
  compiled Code at target\run\kasper_sindri_media\models\nextClick\tactical_userneeds_pageviews_chart_month_13.sql
[0m12:12:32.215988 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '117be3b3-4533-4ad2-8bcf-e7be1e1107ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000190DCEF9110>]}
[0m12:12:32.217980 [error] [Thread-1 (]: 7 of 10 ERROR creating sql view model site_dev.tactical_userneeds_pageviews_chart_month_13  [[31mERROR[0m in 2.44s]
[0m12:12:32.219826 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13
[0m12:12:32.221819 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13.sql_output
[0m12:12:32.223816 [info ] [Thread-1 (]: 8 of 10 START sql view model site_dev.tactical_userneeds_pageviews_chart_month_13.sql_output  [RUN]
[0m12:12:32.225841 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13, now model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13.sql_output)
[0m12:12:32.226838 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13.sql_output
[0m12:12:32.236811 [debug] [Thread-1 (]: Writing injected SQL for node "model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13.sql_output"
[0m12:12:32.243801 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13.sql_output (compile): 12:12:32.226838 => 12:12:32.242802
[0m12:12:32.244797 [debug] [Thread-1 (]: Began executing node model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13.sql_output
[0m12:12:32.253773 [debug] [Thread-1 (]: Writing runtime sql for node "model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13.sql_output"
[0m12:12:32.256753 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13.sql_output"
[0m12:12:32.257749 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13.sql_output: BEGIN
[0m12:12:32.258747 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m12:12:33.856727 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:12:33.859715 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13.sql_output"
[0m12:12:33.866694 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13.sql_output: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13.sql_output"} */

  create view `site_dev`.`tactical_userneeds_pageviews_chart_month_13.sql_output__dbt_tmp`
    
    
  as (
    CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_month_13_dbt_test`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN userneeds like "%Opdater mig%" then "Opdater mig"
			    WHEN userneeds like "%Forbind mig%" then "Forbind mig"
			    WHEN userneeds like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
			    WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
			    WHEN userneeds like "%Underhold mig%" then "Underhold mig"
			    WHEN userneeds like "%Inspirer mig%" then "Inspirer mig"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN MAKEDATE(EXTRACT(YEAR FROM CURDATE()), 1) AND DATE_SUB(CURDATE(), INTERVAL 1 DAY) AND 12),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = 12
		group by 1,2
    ),
    agg_next_click_per_article as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = Next Click
		where    e.siteid = 12  
		group by 1,2,3
		),
        cta_per_article as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article  e
			where  e.siteid = 12
			group by 1,2,3

		),
        agg_cta_per_article as(
		select siteid as siteid,tags,sum(val) as agg_sum from
        cta_per_article
		where siteid = 12
		group by 1,2
		),
        less_tg_data as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date BETWEEN MAKEDATE(EXTRACT(YEAR FROM CURDATE()), 1) AND DATE_SUB(CURDATE(), INTERVAL 1 DAY) and g.site_id = 12
		),
        counts as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data
			group by 1,2
		),
        hits_by_tags as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data
		   where siteid = 12
		   group by 1,2)
           ,
           total_hits as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts
			where  siteid = 12
			group by 1)
            ,
            agg_data as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts h
			join total_hits t on h.siteid=t.siteid
			join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = 12
		),
        categories_d as (
			select 
				siteid as siteid ,
				 label data value as label,
                hint data value as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',['Opdater mig', 'Forbind mig', 'Hjælp mig med at forstå', 'Giv mig en fordel', 'Underhold mig', 'Inspirer mig'],', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',['Opdater mig', 'Forbind mig', 'Hjælp mig med at forstå', 'Giv mig en fordel', 'Underhold mig', 'Inspirer mig'],', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',['Opdater mig', 'Forbind mig', 'Hjælp mig med at forstå', 'Giv mig en fordel', 'Underhold mig', 'Inspirer mig'],', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',['Opdater mig', 'Forbind mig', 'Hjælp mig med at forstå', 'Giv mig en fordel', 'Underhold mig', 'Inspirer mig'],', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data
		group by 1,2,3
		),
        categories as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d
		),
        json_data as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories
		), 
    
    last_30_days_article_published_second as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Categories like "%Nyheder%" then "Nyheder"
			    WHEN Categories like "%Debat%" then "Debat"
			    WHEN Categories like "%Inspiration%" then "Inspiration"
			    WHEN Categories like "%Anmeldelser%" then "Anmeldelser"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date between MAKEDATE(EXTRACT(YEAR FROM CURDATE()),1)  and  DATE_SUB(cast(NOW() as date), INTERVAL 1 DAY) AND 12),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = 12
		group by 1,2
    ),
    agg_next_click_per_article_second as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_second  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = Next Click
		where    e.siteid = 12  
		group by 1,2,3
		),
        cta_per_article_second as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_second  e
			where  e.siteid = 12
			group by 1,2,3

		),
        agg_cta_per_article_second as(
		select siteid as siteid,tags,sum(val) as agg_sum from
        cta_per_article_second
		where siteid = 12
		group by 1,2
		),
        less_tg_data_second as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_second l
		join cta_per_article_second a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date between MAKEDATE(EXTRACT(YEAR FROM CURDATE()),1)  and  DATE_SUB(cast(NOW() as date), INTERVAL 1 DAY) and g.site_id = 12
		),
        counts_second as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_second
			group by 1,2
		),
        hits_by_tags_second as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_second
		   where siteid = 12
		   group by 1,2)
           ,
           total_hits_second as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_second
			where  siteid = 12
			group by 1)
            ,
            agg_data_second as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_second h
			join total_hits_second t on h.siteid=t.siteid
			join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = 12
		),
        categories_d_second as (
			select 
				siteid as siteid ,
				 label data value as label,
                hint data value as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',['Nyheder', 'Debat', 'Inspiration', 'Anmeldelser'],', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',['Nyheder', 'Debat', 'Inspiration', 'Anmeldelser'],', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',['Nyheder', 'Debat', 'Inspiration', 'Anmeldelser'],', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',['Nyheder', 'Debat', 'Inspiration', 'Anmeldelser'],', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_second
		group by 1,2,3
		),
        categories_second as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_second
		),
        json_data_second as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_second
		), 
    
    last_30_days_article_published_third as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Tags like "%skolepolitik%" then "skolepolitik"
			    WHEN Tags like "%Psykisk arbejdsmiljø%" then "Psykisk arbejdsmiljø"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE  AND 12),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = 12
		group by 1,2
    ),
    agg_next_click_per_article_third as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_third  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = Next Click
		where    e.siteid = 12  
		group by 1,2,3
		),
        cta_per_article_third as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_third  e
			where  e.siteid = 12
			group by 1,2,3

		),
        agg_cta_per_article_third as(
		select siteid as siteid,tags,sum(val) as agg_sum from
        cta_per_article_third
		where siteid = 12
		group by 1,2
		),
        less_tg_data_third as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_third l
		join cta_per_article_third a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where  and g.site_id = 12
		),
        counts_third as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_third
			group by 1,2
		),
        hits_by_tags_third as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_third
		   where siteid = 12
		   group by 1,2)
           ,
           total_hits_third as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_third
			where  siteid = 12
			group by 1)
            ,
            agg_data_third as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_third h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = 12
		),
        categories_d_third as (
			select 
				siteid as siteid ,
				 label data value as label,
                hint data value as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',['skolepolitik', 'Psykisk arbejdsmiljø'],', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',['skolepolitik', 'Psykisk arbejdsmiljø'],', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',['skolepolitik', 'Psykisk arbejdsmiljø'],', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',['skolepolitik', 'Psykisk arbejdsmiljø'],', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_third
		group by 1,2,3
		),
        categories_third as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_third
		),
        json_data_third as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_third
		)
    

    SELECT 
		CONCAT(
        ''{'',
            ''"site":'',jd.siteid,'','',
            ''"data": {'',
                ''"label": "'', jd.lab, ''",'',
                ''"categories": ['', jd.cat, ''],'',
                ''"series": ['', jd.series, '']'',
                '',"defaultTitle":"',dtitle,'"'',
                '',"additional":[ ''
                
                ,''{'',
                ''"title":"',title1,'",'',
                ''"data": {'',
                ''"label": "'',json_data_second.lab, ''",'',
                ''"categories": ['', json_data_second.cat, ''],'',
                ''"series": ['', json_data_second.series, '']'',
                ''}}''
                
                , '',''
                
                
                ,''{'',
                ''"title":"',title2,'",'',
                ''"data": {'',
                ''"label": "'',json_data_third.lab, ''",'',
                ''"categories": ['', json_data_third.cat, ''],'',
                ''"series": ['', json_data_third.series, '']'',
                ''}}''
                
                
        '']}}''
    
			) as json_data
		  FROM json_data jd
          
          CROSS join json_data_second
          
          CROSS join json_data_third
          ;
  );
[0m12:12:34.669077 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_' at line 7
[0m12:12:34.672064 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13.sql_output: ROLLBACK
[0m12:12:34.873204 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13.sql_output (execute): 12:12:32.245794 => 12:12:34.872193
[0m12:12:34.876191 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13.sql_output: Close
[0m12:12:34.887160 [debug] [Thread-1 (]: Database Error in model tactical_userneeds_pageviews_chart_month_13.sql_output (models\nextClick\tactical_userneeds_pageviews_chart_month_13.sql_output.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_' at line 7
  compiled Code at target\run\kasper_sindri_media\models\nextClick\tactical_userneeds_pageviews_chart_month_13.sql_output.sql
[0m12:12:34.889155 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '117be3b3-4533-4ad2-8bcf-e7be1e1107ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000190DCF30190>]}
[0m12:12:34.891150 [error] [Thread-1 (]: 8 of 10 ERROR creating sql view model site_dev.tactical_userneeds_pageviews_chart_month_13.sql_output  [[31mERROR[0m in 2.66s]
[0m12:12:34.893146 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13.sql_output
[0m12:12:34.895137 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.test
[0m12:12:34.896136 [info ] [Thread-1 (]: 9 of 10 START sql view model site_dev.test ..................................... [RUN]
[0m12:12:34.898130 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13.sql_output, now model.kasper_sindri_media.test)
[0m12:12:34.899127 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.test
[0m12:12:34.920070 [debug] [Thread-1 (]: Writing injected SQL for node "model.kasper_sindri_media.test"
[0m12:12:34.921068 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.test (compile): 12:12:34.900125 => 12:12:34.921068
[0m12:12:34.922065 [debug] [Thread-1 (]: Began executing node model.kasper_sindri_media.test
[0m12:12:34.929046 [debug] [Thread-1 (]: Writing runtime sql for node "model.kasper_sindri_media.test"
[0m12:12:34.931043 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.test"
[0m12:12:34.932039 [debug] [Thread-1 (]: On model.kasper_sindri_media.test: BEGIN
[0m12:12:34.932039 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m12:12:36.517469 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:12:36.519467 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.test"
[0m12:12:36.521454 [debug] [Thread-1 (]: On model.kasper_sindri_media.test: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.kasper_sindri_media.test"} */

  create view `site_dev`.`test__dbt_tmp`
    
    
  as (
    CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_month_13_dbt_test`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    

    SELECT 
		CONCAT(
        ''{'',
            ''"site":'',jd.siteid,'','',
            ''"data": {'',
                ''"label": "'', jd.lab, ''",'',
                ''"categories": ['', jd.cat, ''],'',
                ''"series": ['', jd.series, '']'',
                '',"defaultTitle":"',dtitle,'"'',
                '',"additional":[ ''
                
        '']}}''
    
			) as json_data
		  FROM json_data jd
          ;
  );
[0m12:12:37.118098 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_' at line 7
[0m12:12:37.120090 [debug] [Thread-1 (]: On model.kasper_sindri_media.test: ROLLBACK
[0m12:12:37.321182 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.test (execute): 12:12:34.923063 => 12:12:37.321182
[0m12:12:37.322185 [debug] [Thread-1 (]: On model.kasper_sindri_media.test: Close
[0m12:12:37.329165 [debug] [Thread-1 (]: Database Error in model test (models\test.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_' at line 7
  compiled Code at target\run\kasper_sindri_media\models\test.sql
[0m12:12:37.330161 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '117be3b3-4533-4ad2-8bcf-e7be1e1107ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000190DCF31AD0>]}
[0m12:12:37.331159 [error] [Thread-1 (]: 9 of 10 ERROR creating sql view model site_dev.test ............................ [[31mERROR[0m in 2.43s]
[0m12:12:37.333155 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.test
[0m12:12:37.334155 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.test_by
[0m12:12:37.336154 [info ] [Thread-1 (]: 10 of 10 START sql view model site_dev.test_by ................................. [RUN]
[0m12:12:37.337550 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.kasper_sindri_media.test, now model.kasper_sindri_media.test_by)
[0m12:12:37.338545 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.test_by
[0m12:12:37.362481 [debug] [Thread-1 (]: Writing injected SQL for node "model.kasper_sindri_media.test_by"
[0m12:12:37.364476 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.test_by (compile): 12:12:37.338545 => 12:12:37.363479
[0m12:12:37.365474 [debug] [Thread-1 (]: Began executing node model.kasper_sindri_media.test_by
[0m12:12:37.371457 [debug] [Thread-1 (]: Writing runtime sql for node "model.kasper_sindri_media.test_by"
[0m12:12:37.378255 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.test_by"
[0m12:12:37.379251 [debug] [Thread-1 (]: On model.kasper_sindri_media.test_by: BEGIN
[0m12:12:37.380248 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m12:12:38.934045 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:12:38.935044 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.test_by"
[0m12:12:38.936041 [debug] [Thread-1 (]: On model.kasper_sindri_media.test_by: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.kasper_sindri_media.test_by"} */

  create view `site_dev`.`test_by__dbt_tmp`
    
    
  as (
    CREATE DEFINER=`Site`@`%` PROCEDURE `tactical_category_pageviews_chart_month_13`(
	IN site INT,
  IN label_val VARCHAR(200),
  IN hint_val text,
  IN order_statement_first  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
  IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
  IN title1 VARCHAR(200),
  IN title2 VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    

    SELECT 
		CONCAT(
        ''{'',
            ''"site":'',jd.siteid,'','',
            ''"data": {'',
                ''"label": "'', jd.lab, ''",'',
                ''"categories": ['', jd.cat, ''],'',
                ''"series": ['', jd.series, '']'',
                '',"defaultTitle":"',,'"'',
                '',"additional":[ ''
                
        '']}}''
    
			) as json_data
		  FROM json_data jd
          ;
  );
[0m12:12:39.555687 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `tactical_category_pageviews_chart_month_13`' at line 7
[0m12:12:39.559682 [debug] [Thread-1 (]: On model.kasper_sindri_media.test_by: ROLLBACK
[0m12:12:39.756801 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.test_by (execute): 12:12:37.366471 => 12:12:39.754773
[0m12:12:39.758778 [debug] [Thread-1 (]: On model.kasper_sindri_media.test_by: Close
[0m12:12:39.764753 [debug] [Thread-1 (]: Database Error in model test_by (models\nextClick\test_by.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `tactical_category_pageviews_chart_month_13`' at line 7
  compiled Code at target\run\kasper_sindri_media\models\nextClick\test_by.sql
[0m12:12:39.765750 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '117be3b3-4533-4ad2-8bcf-e7be1e1107ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000190DBCF8CD0>]}
[0m12:12:39.766747 [error] [Thread-1 (]: 10 of 10 ERROR creating sql view model site_dev.test_by ........................ [[31mERROR[0m in 2.43s]
[0m12:12:39.768403 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.test_by
[0m12:12:39.770398 [debug] [MainThread]: Using mysql connection "master"
[0m12:12:39.771395 [debug] [MainThread]: On master: BEGIN
[0m12:12:39.772413 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m12:12:41.368683 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:12:41.371686 [debug] [MainThread]: On master: COMMIT
[0m12:12:41.374681 [debug] [MainThread]: Using mysql connection "master"
[0m12:12:41.375678 [debug] [MainThread]: On master: COMMIT
[0m12:12:41.985191 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:12:41.986191 [debug] [MainThread]: On master: Close
[0m12:12:41.988190 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:12:41.989183 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m12:12:41.990181 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m12:12:41.991178 [debug] [MainThread]: Connection 'model.kasper_sindri_media.test_by' was properly closed.
[0m12:12:41.992175 [info ] [MainThread]: 
[0m12:12:41.993175 [info ] [MainThread]: Finished running 10 view models in 0 hours 0 minutes and 34.16 seconds (34.16s).
[0m12:12:41.997080 [debug] [MainThread]: Command end result
[0m12:12:42.010047 [info ] [MainThread]: 
[0m12:12:42.011044 [info ] [MainThread]: [31mCompleted with 10 errors and 0 warnings:[0m
[0m12:12:42.013040 [info ] [MainThread]: 
[0m12:12:42.014045 [error] [MainThread]:   Database Error in model cards (models\cards.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `tactical_articles_card_month`(
  IN site INT' at line 7
  compiled Code at target\run\kasper_sindri_media\models\cards.sql
[0m12:12:42.016031 [info ] [MainThread]: 
[0m12:12:42.018103 [error] [MainThread]:   Database Error in model example_by (models\example_by.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `example_procedure`(
      IN site_id INT,
      IN event_action VA' at line 9
  compiled Code at target\run\kasper_sindri_media\models\example_by.sql
[0m12:12:42.019623 [info ] [MainThread]: 
[0m12:12:42.020618 [error] [MainThread]:   Database Error in model example_by_me (models\nextClick\example_by_me.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `example_procedure`(
      IN site_id INT,
      IN event_action VA' at line 9
  compiled Code at target\run\kasper_sindri_media\models\nextClick\example_by_me.sql
[0m12:12:42.022263 [info ] [MainThread]: 
[0m12:12:42.024261 [error] [MainThread]:   Compilation Error in model overview_sales_card_12 (models\example\overview_sales_card_12.sql)
  Required var 'date' not found in config:
  Vars supplied to overview_sales_card_12 = {
      "article_evaluation": {
          "over_both_goals": {
              "case": "((coalesce(coalesce(l.hits,0)/coalesce(l.pageviews,0)*100,0))>=coalesce(g.Min_CTA,0) and coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0) )",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          },
          "under_both_goal": {
              "case": "(coalesce((coalesce(l.hits,0)/coalesce(l.pageviews,0)*100),0)<coalesce(g.Min_CTA,0) and coalesce(l.pageviews,0)<coalesce(g.Min_pageviews,0) )",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          },
          "under_one_goal": {
              "case": "(coalesce( coalesce((coalesce(l.hits,0) / coalesce(l.pageviews,0)),0) * 100 , 0)>=coalesce(g.Min_CTA,0) or coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0)) and !((coalesce( coalesce((coalesce(l.hits,0) / coalesce(l.pageviews,0)),0) * 100 , 0))>=coalesce(g.Min_CTA,0) and  coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0) ) ",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          }
      },
      "date_month": "DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)",
      "date_week": "DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)",
      "date_year": "MAKEDATE(EXTRACT(YEAR FROM CURDATE()), 1) AND DATE_SUB(CAST(NOW() AS DATE), INTERVAL 1 DAY)",
      "event_action": "Next Click",
      "overview": {
          "overview_pageviews_card": {
              "hint": "Sidevisninger \u00e5r til dato ift sidste \u00e5r til dato og ift m\u00e5ls\u00e6tning",
              "label": "Sidevisninger"
          },
          "overview_sales_card": {
              "hint": "Gns. next click \u00e5r til dato ift. sidste \u00e5r",
              "label": "Next click (%)"
          },
          "overview_visits_card": {
              "hint": "Bes\u00f8g \u00e5r til dato ift sidste \u00e5r til dato og ift m\u00e5ls\u00e6tning",
              "label": "Bes\u00f8g"
          }
      },
      "site": 12,
      "tendency": {
          "tactical_articles_card": {
              "hint": "Artikler publiceret seneste 30 dage ift. forrige 30 dage",
              "label": "Artikler"
          },
          "tactical_clicks_card": {
              "hint": "Gns. next click p\u00e5 artikler publiceret seneste 30 dage ift. forrige 30 dage",
              "label": "Gns. next click (%)"
          },
          "tactical_pageviews_card": {
              "hint": "Gns. sidevisninger pr artikler publiceret \u00e5r til dato ift. sidste \u00e5r til dato",
              "label": "Gns. sidevisninger pr artikel"
          },
          "tactical_userneeds_pageviews_chart": {
              "dropdown_count": [
                  "",
                  "_second",
                  "_third"
              ],
              "dropdown_name": {
                  "Categories": "Categories",
                  "Tags": "Tags",
                  "userneeds": "userneeds"
              },
              "dropdown_val": {
                  "categories": [
                      "Nyheder",
                      "Debat",
                      "Inspiration",
                      "Anmeldelser"
                  ],
                  "tags": [
                      "skolepolitik",
                      "Psykisk arbejdsmilj\u00f8"
                  ],
                  "userneeds": [
                      "Opdater mig",
                      "Forbind mig",
                      "Hj\u00e6lp mig med at forst\u00e5",
                      "Giv mig en fordel",
                      "Underhold mig",
                      "Inspirer mig"
                  ]
              },
              "hint": "Artikler grupperet ift hvordan de har performet p\u00e5 next click",
              "label": "Artikler ift. next click m\u00e5l"
          }
      }
  }
[0m12:12:42.028460 [info ] [MainThread]: 
[0m12:12:42.033240 [error] [MainThread]:   Database Error in model tactical_articles_cards (models\nextClick\tactical_articles_cards.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'PREPARE stmt FROM @sql_query;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
  END;
    ' at line 8
  compiled Code at target\run\kasper_sindri_media\models\nextClick\tactical_articles_cards.sql
[0m12:12:42.034177 [info ] [MainThread]: 
[0m12:12:42.035466 [error] [MainThread]:   Database Error in model tactical_userneeds_pageviews_chart (models\nextClick\tactical_userneeds_pageviews_chart.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_' at line 7
  compiled Code at target\run\kasper_sindri_media\models\nextClick\tactical_userneeds_pageviews_chart.sql
[0m12:12:42.038461 [info ] [MainThread]: 
[0m12:12:42.039157 [error] [MainThread]:   Database Error in model tactical_userneeds_pageviews_chart_month_13 (models\nextClick\tactical_userneeds_pageviews_chart_month_13.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_' at line 7
  compiled Code at target\run\kasper_sindri_media\models\nextClick\tactical_userneeds_pageviews_chart_month_13.sql
[0m12:12:42.040846 [info ] [MainThread]: 
[0m12:12:42.042305 [error] [MainThread]:   Database Error in model tactical_userneeds_pageviews_chart_month_13.sql_output (models\nextClick\tactical_userneeds_pageviews_chart_month_13.sql_output.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_' at line 7
  compiled Code at target\run\kasper_sindri_media\models\nextClick\tactical_userneeds_pageviews_chart_month_13.sql_output.sql
[0m12:12:42.044303 [info ] [MainThread]: 
[0m12:12:42.049978 [error] [MainThread]:   Database Error in model test (models\test.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_' at line 7
  compiled Code at target\run\kasper_sindri_media\models\test.sql
[0m12:12:42.050868 [info ] [MainThread]: 
[0m12:12:42.052866 [error] [MainThread]:   Database Error in model test_by (models\nextClick\test_by.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `tactical_category_pageviews_chart_month_13`' at line 7
  compiled Code at target\run\kasper_sindri_media\models\nextClick\test_by.sql
[0m12:12:42.054861 [info ] [MainThread]: 
[0m12:12:42.055720 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=10 SKIP=0 TOTAL=10
[0m12:12:42.059222 [debug] [MainThread]: Command `dbt run` failed at 12:12:42.058225 after 37.13 seconds
[0m12:12:42.060220 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000190DB868C90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000190DB8A7350>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000190DB8A6210>]}
[0m12:12:42.062223 [debug] [MainThread]: Flushing usage events
[0m12:16:20.960679 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002768C75CDD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002768C78DA90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002768C75D190>]}


============================== 12:16:20.969654 | c1adbbcd-5c31-4d4d-95d1-093315851659 ==============================
[0m12:16:20.969654 [info ] [MainThread]: Running with dbt=1.7.17
[0m12:16:20.971650 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'fail_fast': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --models +example.run_overview_sales_card_12', 'send_anonymous_usage_stats': 'True'}
[0m12:16:21.261271 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c1adbbcd-5c31-4d4d-95d1-093315851659', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002768C7C20D0>]}
[0m12:16:21.348053 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c1adbbcd-5c31-4d4d-95d1-093315851659', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002768C99FA90>]}
[0m12:16:21.350664 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m12:16:21.363488 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m12:16:21.467271 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m12:16:21.468268 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m12:16:21.470264 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.dbt_test.example
[0m12:16:21.479241 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c1adbbcd-5c31-4d4d-95d1-093315851659', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002768C7C5050>]}
[0m12:16:21.498188 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c1adbbcd-5c31-4d4d-95d1-093315851659', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002768CA509D0>]}
[0m12:16:21.500184 [info ] [MainThread]: Found 10 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m12:16:21.502179 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c1adbbcd-5c31-4d4d-95d1-093315851659', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002768C9D6410>]}
[0m12:16:21.504173 [warn ] [MainThread]: The selection criterion '+example.run_overview_sales_card_12' does not match any nodes
[0m12:16:21.506168 [info ] [MainThread]: 
[0m12:16:21.507602 [warn ] [MainThread]: Nothing to do. Try checking your model configs and model specification args
[0m12:16:21.508642 [debug] [MainThread]: Command end result
[0m12:16:21.520612 [debug] [MainThread]: Command `dbt run` succeeded at 12:16:21.520612 after 0.65 seconds
[0m12:16:21.522608 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002768C79BA50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002768C390F10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027685C71650>]}
[0m12:16:21.523605 [debug] [MainThread]: Flushing usage events
[0m12:17:19.204590 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012BB2855710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012BB2C45BD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012BB26E7C50>]}


============================== 12:17:19.211586 | ce5a75a9-c310-4712-884e-6ebf41553b06 ==============================
[0m12:17:19.211586 [info ] [MainThread]: Running with dbt=1.7.17
[0m12:17:19.212569 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'version_check': 'True', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --models +example.run_overview_sales_card_12', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m12:17:19.553395 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ce5a75a9-c310-4712-884e-6ebf41553b06', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012BB2DCDA50>]}
[0m12:17:19.640165 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ce5a75a9-c310-4712-884e-6ebf41553b06', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012BB2C75E10>]}
[0m12:17:19.642442 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m12:17:19.655267 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m12:17:19.667237 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m12:17:19.668266 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'ce5a75a9-c310-4712-884e-6ebf41553b06', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012BB2FCDC90>]}
[0m12:17:21.206157 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.dbt_test.example
[0m12:17:21.216132 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ce5a75a9-c310-4712-884e-6ebf41553b06', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012BB06EA010>]}
[0m12:17:21.240064 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ce5a75a9-c310-4712-884e-6ebf41553b06', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012BB3115490>]}
[0m12:17:21.241063 [info ] [MainThread]: Found 10 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m12:17:21.242059 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ce5a75a9-c310-4712-884e-6ebf41553b06', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012BB2EA8CD0>]}
[0m12:17:21.243060 [warn ] [MainThread]: The selection criterion '+example.run_overview_sales_card_12' does not match any nodes
[0m12:17:21.246048 [info ] [MainThread]: 
[0m12:17:21.249043 [warn ] [MainThread]: Nothing to do. Try checking your model configs and model specification args
[0m12:17:21.251036 [debug] [MainThread]: Command end result
[0m12:17:21.268988 [debug] [MainThread]: Command `dbt run` succeeded at 12:17:21.267991 after 2.17 seconds
[0m12:17:21.270982 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012BB2039DD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012BB27C96D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012BB28557D0>]}
[0m12:17:21.272977 [debug] [MainThread]: Flushing usage events
[0m12:19:18.311737 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC1A195F90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC1A195D50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC1A15C110>]}


============================== 12:19:18.317723 | 0858b086-04b1-4bc8-abe0-ce2b1aba5543 ==============================
[0m12:19:18.317723 [info ] [MainThread]: Running with dbt=1.7.17
[0m12:19:18.319716 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models +example.run_overview_sales_card_12', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m12:19:18.594425 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0858b086-04b1-4bc8-abe0-ce2b1aba5543', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC1A37B910>]}
[0m12:19:18.676207 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0858b086-04b1-4bc8-abe0-ce2b1aba5543', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC1A36CFD0>]}
[0m12:19:18.678698 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m12:19:18.691667 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m12:19:18.715601 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m12:19:18.716600 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '0858b086-04b1-4bc8-abe0-ce2b1aba5543', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC1A51DF50>]}
[0m12:19:20.128821 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example
[0m12:19:20.138794 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0858b086-04b1-4bc8-abe0-ce2b1aba5543', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC1A68C2D0>]}
[0m12:19:20.158741 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0858b086-04b1-4bc8-abe0-ce2b1aba5543', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC1A668C50>]}
[0m12:19:20.159738 [info ] [MainThread]: Found 10 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m12:19:20.160735 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0858b086-04b1-4bc8-abe0-ce2b1aba5543', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC1A6DD690>]}
[0m12:19:20.161735 [warn ] [MainThread]: The selection criterion '+example.run_overview_sales_card_12' does not match any nodes
[0m12:19:20.165723 [info ] [MainThread]: 
[0m12:19:20.166496 [warn ] [MainThread]: Nothing to do. Try checking your model configs and model specification args
[0m12:19:20.167547 [debug] [MainThread]: Command end result
[0m12:19:20.182510 [debug] [MainThread]: Command `dbt run` succeeded at 12:19:20.181514 after 1.98 seconds
[0m12:19:20.183507 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC19D90F10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC13681550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC133E7ED0>]}
[0m12:19:20.184505 [debug] [MainThread]: Flushing usage events
[0m12:20:13.687912 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BC85C30D50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BC85C33450>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BC85C33950>]}


============================== 12:20:13.695892 | 989fe126-e787-4781-8c2a-1f670dd925dc ==============================
[0m12:20:13.695892 [info ] [MainThread]: Running with dbt=1.7.17
[0m12:20:13.697885 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'debug': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models +example.run_overview_sales_card_12', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m12:20:13.968090 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '989fe126-e787-4781-8c2a-1f670dd925dc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BC85E5DA90>]}
[0m12:20:14.050870 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '989fe126-e787-4781-8c2a-1f670dd925dc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BC85C496D0>]}
[0m12:20:14.053053 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m12:20:14.065023 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m12:20:14.086965 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m12:20:14.087962 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '989fe126-e787-4781-8c2a-1f670dd925dc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BC85EFE210>]}
[0m12:20:15.578024 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example.run_overview_sales_card_12
[0m12:20:15.587001 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '989fe126-e787-4781-8c2a-1f670dd925dc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BC8602CFD0>]}
[0m12:20:15.604951 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '989fe126-e787-4781-8c2a-1f670dd925dc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BC85EFF090>]}
[0m12:20:15.605950 [info ] [MainThread]: Found 10 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m12:20:15.607944 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '989fe126-e787-4781-8c2a-1f670dd925dc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BC8615AF50>]}
[0m12:20:15.608942 [warn ] [MainThread]: The selection criterion '+example.run_overview_sales_card_12' does not match any nodes
[0m12:20:15.611933 [info ] [MainThread]: 
[0m12:20:15.612542 [warn ] [MainThread]: Nothing to do. Try checking your model configs and model specification args
[0m12:20:15.614541 [debug] [MainThread]: Command end result
[0m12:20:15.629532 [debug] [MainThread]: Command `dbt run` succeeded at 12:20:15.628518 after 2.03 seconds
[0m12:20:15.630497 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BCFEEC7ED0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BC85F56910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BCFF161650>]}
[0m12:20:15.632492 [debug] [MainThread]: Flushing usage events
[0m12:20:47.013418 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000175C8325F90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000175C8325D50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000175C82F5150>]}


============================== 12:20:47.022393 | ebc559d3-393c-4c13-8006-d5c0b76baa0b ==============================
[0m12:20:47.022393 [info ] [MainThread]: Running with dbt=1.7.17
[0m12:20:47.024390 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'debug': 'False', 'warn_error': 'None', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run --models example.run_overview_sales_card_12', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m12:20:47.289691 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ebc559d3-393c-4c13-8006-d5c0b76baa0b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000175C84AFE10>]}
[0m12:20:47.368466 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ebc559d3-393c-4c13-8006-d5c0b76baa0b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000175C82EFD50>]}
[0m12:20:47.370462 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m12:20:47.382455 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m12:20:47.482162 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m12:20:47.483159 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m12:20:47.484157 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example.run_overview_sales_card_12
[0m12:20:47.494144 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ebc559d3-393c-4c13-8006-d5c0b76baa0b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000175C8671350>]}
[0m12:20:47.513079 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ebc559d3-393c-4c13-8006-d5c0b76baa0b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000175C85DA250>]}
[0m12:20:47.514077 [info ] [MainThread]: Found 10 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m12:20:47.516070 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ebc559d3-393c-4c13-8006-d5c0b76baa0b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000175C849B390>]}
[0m12:20:47.518071 [warn ] [MainThread]: The selection criterion 'example.run_overview_sales_card_12' does not match any nodes
[0m12:20:47.521060 [info ] [MainThread]: 
[0m12:20:47.522260 [warn ] [MainThread]: Nothing to do. Try checking your model configs and model specification args
[0m12:20:47.524591 [debug] [MainThread]: Command end result
[0m12:20:47.537553 [debug] [MainThread]: Command `dbt run` succeeded at 12:20:47.537553 after 0.61 seconds
[0m12:20:47.538549 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000175C7DB7A90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000175C18D1650>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000175C1637ED0>]}
[0m12:20:47.538549 [debug] [MainThread]: Flushing usage events
[0m12:22:42.909332 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014DB7845BD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014DB7846510>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014DB780BD90>]}


============================== 12:22:42.916314 | fc5ba6db-bc66-4d3f-8cfd-15eeb4c84d57 ==============================
[0m12:22:42.916314 [info ] [MainThread]: Running with dbt=1.7.17
[0m12:22:42.917312 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models example.overview_sales_card_12', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m12:22:43.189582 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'fc5ba6db-bc66-4d3f-8cfd-15eeb4c84d57', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014DB7440C10>]}
[0m12:22:43.269369 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'fc5ba6db-bc66-4d3f-8cfd-15eeb4c84d57', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014DB7871D50>]}
[0m12:22:43.272361 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m12:22:43.284329 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m12:22:43.375087 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m12:22:43.376086 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m12:22:43.377082 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example.run_overview_sales_card_12
[0m12:22:43.387054 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'fc5ba6db-bc66-4d3f-8cfd-15eeb4c84d57', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014DB7B606D0>]}
[0m12:22:43.407001 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'fc5ba6db-bc66-4d3f-8cfd-15eeb4c84d57', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014DB7AF9450>]}
[0m12:22:43.408996 [info ] [MainThread]: Found 10 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m12:22:43.409994 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fc5ba6db-bc66-4d3f-8cfd-15eeb4c84d57', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014DB7ACF9D0>]}
[0m12:22:43.412985 [info ] [MainThread]: 
[0m12:22:43.414649 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m12:22:43.418452 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m12:22:43.435406 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m12:22:43.436404 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m12:22:43.437402 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:22:45.012359 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m12:22:45.015361 [debug] [ThreadPool]: On list_schemas: Close
[0m12:22:45.017354 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m12:22:45.019350 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m12:22:45.026331 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:22:45.028325 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m12:22:45.028325 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:22:46.591001 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:22:46.594002 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:22:46.596983 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m12:22:47.189848 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m12:22:47.195832 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m12:22:47.197819 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:22:47.199816 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m12:22:47.788051 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:22:47.789057 [debug] [ThreadPool]: On create__site_dev: Close
[0m12:22:47.793043 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m12:22:47.801020 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m12:22:47.802019 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m12:22:47.803015 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:22:49.423886 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:22:49.425874 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m12:22:49.427867 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m12:22:50.029167 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:22:50.032164 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m12:22:50.231189 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m12:22:50.240162 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fc5ba6db-bc66-4d3f-8cfd-15eeb4c84d57', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014DB668A890>]}
[0m12:22:50.243157 [debug] [MainThread]: Using mysql connection "master"
[0m12:22:50.245148 [debug] [MainThread]: On master: BEGIN
[0m12:22:50.246145 [debug] [MainThread]: Opening a new connection, currently in state init
[0m12:22:51.778187 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:22:51.780180 [debug] [MainThread]: On master: COMMIT
[0m12:22:51.782176 [debug] [MainThread]: Using mysql connection "master"
[0m12:22:51.783175 [debug] [MainThread]: On master: COMMIT
[0m12:22:52.356637 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:22:52.358633 [debug] [MainThread]: On master: Close
[0m12:22:52.361625 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m12:22:52.362622 [info ] [MainThread]: 
[0m12:22:52.368606 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.overview_sales_card_12
[0m12:22:52.370601 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.overview_sales_card_12 .................... [RUN]
[0m12:22:52.373592 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.kasper_sindri_media.overview_sales_card_12'
[0m12:22:52.374590 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.overview_sales_card_12
[0m12:22:52.405508 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.overview_sales_card_12 (compile): 12:22:52.376585 => 12:22:52.404511
[0m12:22:52.414483 [debug] [Thread-1 (]: Compilation Error in model overview_sales_card_12 (models\example\overview_sales_card_12.sql)
  Required var 'date' not found in config:
  Vars supplied to overview_sales_card_12 = {
      "article_evaluation": {
          "over_both_goals": {
              "case": "((coalesce(coalesce(l.hits,0)/coalesce(l.pageviews,0)*100,0))>=coalesce(g.Min_CTA,0) and coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0) )",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          },
          "under_both_goal": {
              "case": "(coalesce((coalesce(l.hits,0)/coalesce(l.pageviews,0)*100),0)<coalesce(g.Min_CTA,0) and coalesce(l.pageviews,0)<coalesce(g.Min_pageviews,0) )",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          },
          "under_one_goal": {
              "case": "(coalesce( coalesce((coalesce(l.hits,0) / coalesce(l.pageviews,0)),0) * 100 , 0)>=coalesce(g.Min_CTA,0) or coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0)) and !((coalesce( coalesce((coalesce(l.hits,0) / coalesce(l.pageviews,0)),0) * 100 , 0))>=coalesce(g.Min_CTA,0) and  coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0) ) ",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          }
      },
      "date_month": "DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)",
      "date_week": "DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)",
      "date_year": "MAKEDATE(EXTRACT(YEAR FROM CURDATE()), 1) AND DATE_SUB(CAST(NOW() AS DATE), INTERVAL 1 DAY)",
      "event_action": "Next Click",
      "overview": {
          "overview_pageviews_card": {
              "hint": "Sidevisninger \u00e5r til dato ift sidste \u00e5r til dato og ift m\u00e5ls\u00e6tning",
              "label": "Sidevisninger"
          },
          "overview_sales_card": {
              "hint": "Gns. next click \u00e5r til dato ift. sidste \u00e5r",
              "label": "Next click (%)"
          },
          "overview_visits_card": {
              "hint": "Bes\u00f8g \u00e5r til dato ift sidste \u00e5r til dato og ift m\u00e5ls\u00e6tning",
              "label": "Bes\u00f8g"
          }
      },
      "site": 12,
      "tendency": {
          "tactical_articles_card": {
              "hint": "Artikler publiceret seneste 30 dage ift. forrige 30 dage",
              "label": "Artikler"
          },
          "tactical_clicks_card": {
              "hint": "Gns. next click p\u00e5 artikler publiceret seneste 30 dage ift. forrige 30 dage",
              "label": "Gns. next click (%)"
          },
          "tactical_pageviews_card": {
              "hint": "Gns. sidevisninger pr artikler publiceret \u00e5r til dato ift. sidste \u00e5r til dato",
              "label": "Gns. sidevisninger pr artikel"
          },
          "tactical_userneeds_pageviews_chart": {
              "dropdown_count": [
                  "",
                  "_second",
                  "_third"
              ],
              "dropdown_name": {
                  "Categories": "Categories",
                  "Tags": "Tags",
                  "userneeds": "userneeds"
              },
              "dropdown_val": {
                  "categories": [
                      "Nyheder",
                      "Debat",
                      "Inspiration",
                      "Anmeldelser"
                  ],
                  "tags": [
                      "skolepolitik",
                      "Psykisk arbejdsmilj\u00f8"
                  ],
                  "userneeds": [
                      "Opdater mig",
                      "Forbind mig",
                      "Hj\u00e6lp mig med at forst\u00e5",
                      "Giv mig en fordel",
                      "Underhold mig",
                      "Inspirer mig"
                  ]
              },
              "hint": "Artikler grupperet ift hvordan de har performet p\u00e5 next click",
              "label": "Artikler ift. next click m\u00e5l"
          }
      }
  }
[0m12:22:52.416479 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fc5ba6db-bc66-4d3f-8cfd-15eeb4c84d57', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014DB7BB42D0>]}
[0m12:22:52.418474 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.overview_sales_card_12 ........... [[31mERROR[0m in 0.04s]
[0m12:22:52.421465 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.overview_sales_card_12
[0m12:22:52.427448 [debug] [MainThread]: Using mysql connection "master"
[0m12:22:52.428446 [debug] [MainThread]: On master: BEGIN
[0m12:22:52.429443 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m12:22:53.985759 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:22:53.987753 [debug] [MainThread]: On master: COMMIT
[0m12:22:53.988751 [debug] [MainThread]: Using mysql connection "master"
[0m12:22:53.990746 [debug] [MainThread]: On master: COMMIT
[0m12:22:54.574339 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:22:54.577360 [debug] [MainThread]: On master: Close
[0m12:22:54.580362 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:22:54.580362 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m12:22:54.581347 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m12:22:54.582346 [debug] [MainThread]: Connection 'model.kasper_sindri_media.overview_sales_card_12' was properly closed.
[0m12:22:54.583346 [info ] [MainThread]: 
[0m12:22:54.584338 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 11.17 seconds (11.17s).
[0m12:22:54.587331 [debug] [MainThread]: Command end result
[0m12:22:54.601292 [info ] [MainThread]: 
[0m12:22:54.603312 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m12:22:54.603927 [info ] [MainThread]: 
[0m12:22:54.606923 [error] [MainThread]:   Compilation Error in model overview_sales_card_12 (models\example\overview_sales_card_12.sql)
  Required var 'date' not found in config:
  Vars supplied to overview_sales_card_12 = {
      "article_evaluation": {
          "over_both_goals": {
              "case": "((coalesce(coalesce(l.hits,0)/coalesce(l.pageviews,0)*100,0))>=coalesce(g.Min_CTA,0) and coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0) )",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          },
          "under_both_goal": {
              "case": "(coalesce((coalesce(l.hits,0)/coalesce(l.pageviews,0)*100),0)<coalesce(g.Min_CTA,0) and coalesce(l.pageviews,0)<coalesce(g.Min_pageviews,0) )",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          },
          "under_one_goal": {
              "case": "(coalesce( coalesce((coalesce(l.hits,0) / coalesce(l.pageviews,0)),0) * 100 , 0)>=coalesce(g.Min_CTA,0) or coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0)) and !((coalesce( coalesce((coalesce(l.hits,0) / coalesce(l.pageviews,0)),0) * 100 , 0))>=coalesce(g.Min_CTA,0) and  coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0) ) ",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          }
      },
      "date_month": "DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)",
      "date_week": "DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)",
      "date_year": "MAKEDATE(EXTRACT(YEAR FROM CURDATE()), 1) AND DATE_SUB(CAST(NOW() AS DATE), INTERVAL 1 DAY)",
      "event_action": "Next Click",
      "overview": {
          "overview_pageviews_card": {
              "hint": "Sidevisninger \u00e5r til dato ift sidste \u00e5r til dato og ift m\u00e5ls\u00e6tning",
              "label": "Sidevisninger"
          },
          "overview_sales_card": {
              "hint": "Gns. next click \u00e5r til dato ift. sidste \u00e5r",
              "label": "Next click (%)"
          },
          "overview_visits_card": {
              "hint": "Bes\u00f8g \u00e5r til dato ift sidste \u00e5r til dato og ift m\u00e5ls\u00e6tning",
              "label": "Bes\u00f8g"
          }
      },
      "site": 12,
      "tendency": {
          "tactical_articles_card": {
              "hint": "Artikler publiceret seneste 30 dage ift. forrige 30 dage",
              "label": "Artikler"
          },
          "tactical_clicks_card": {
              "hint": "Gns. next click p\u00e5 artikler publiceret seneste 30 dage ift. forrige 30 dage",
              "label": "Gns. next click (%)"
          },
          "tactical_pageviews_card": {
              "hint": "Gns. sidevisninger pr artikler publiceret \u00e5r til dato ift. sidste \u00e5r til dato",
              "label": "Gns. sidevisninger pr artikel"
          },
          "tactical_userneeds_pageviews_chart": {
              "dropdown_count": [
                  "",
                  "_second",
                  "_third"
              ],
              "dropdown_name": {
                  "Categories": "Categories",
                  "Tags": "Tags",
                  "userneeds": "userneeds"
              },
              "dropdown_val": {
                  "categories": [
                      "Nyheder",
                      "Debat",
                      "Inspiration",
                      "Anmeldelser"
                  ],
                  "tags": [
                      "skolepolitik",
                      "Psykisk arbejdsmilj\u00f8"
                  ],
                  "userneeds": [
                      "Opdater mig",
                      "Forbind mig",
                      "Hj\u00e6lp mig med at forst\u00e5",
                      "Giv mig en fordel",
                      "Underhold mig",
                      "Inspirer mig"
                  ]
              },
              "hint": "Artikler grupperet ift hvordan de har performet p\u00e5 next click",
              "label": "Artikler ift. next click m\u00e5l"
          }
      }
  }
[0m12:22:54.609913 [info ] [MainThread]: 
[0m12:22:54.615735 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m12:22:54.618042 [debug] [MainThread]: Command `dbt run` failed at 12:22:54.618042 after 11.81 seconds
[0m12:22:54.619038 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014DB0C90A50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014DB0C90A90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014DB7A85D50>]}
[0m12:22:54.620037 [debug] [MainThread]: Flushing usage events
[0m12:24:51.975316 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FBC9A88CD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FBC9A89110>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FBC9A88590>]}


============================== 12:24:51.984291 | 9e534736-6095-40be-9c0e-e81a76e1db91 ==============================
[0m12:24:51.984291 [info ] [MainThread]: Running with dbt=1.7.17
[0m12:24:51.986287 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models example.overview_sales_card_12', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m12:24:52.338344 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9e534736-6095-40be-9c0e-e81a76e1db91', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FBC9C543D0>]}
[0m12:24:52.423118 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9e534736-6095-40be-9c0e-e81a76e1db91', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FBC9C76850>]}
[0m12:24:52.425114 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m12:24:52.438084 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m12:24:52.543795 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m12:24:52.544793 [debug] [MainThread]: Partial parsing: updated file: kasper_sindri_media://models\example\overview_sales_card_12.sql
[0m12:24:52.800111 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example.run_overview_sales_card_12
[0m12:24:52.811082 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '9e534736-6095-40be-9c0e-e81a76e1db91', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FBC9D3CC10>]}
[0m12:24:52.831027 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '9e534736-6095-40be-9c0e-e81a76e1db91', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FBC9F8F710>]}
[0m12:24:52.832023 [info ] [MainThread]: Found 10 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m12:24:52.833021 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9e534736-6095-40be-9c0e-e81a76e1db91', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FBC9E54310>]}
[0m12:24:52.836013 [info ] [MainThread]: 
[0m12:24:52.838010 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m12:24:52.841003 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m12:24:52.855978 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m12:24:52.856959 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m12:24:52.857970 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:24:54.405571 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m12:24:54.413546 [debug] [ThreadPool]: On list_schemas: Close
[0m12:24:54.418530 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m12:24:54.421524 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m12:24:54.429533 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:24:54.430500 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m12:24:54.431499 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:24:56.013048 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:24:56.016038 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:24:56.020026 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m12:24:56.614214 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m12:24:56.616208 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m12:24:56.618203 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:24:56.619200 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m12:24:57.205119 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:24:57.206121 [debug] [ThreadPool]: On create__site_dev: Close
[0m12:24:57.210110 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m12:24:57.219085 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m12:24:57.220083 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m12:24:57.221092 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:24:58.813815 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:24:58.815808 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m12:24:58.818794 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m12:24:59.427795 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:24:59.433766 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m12:24:59.636202 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m12:24:59.638302 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9e534736-6095-40be-9c0e-e81a76e1db91', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FBC9D4B790>]}
[0m12:24:59.639305 [debug] [MainThread]: Using mysql connection "master"
[0m12:24:59.640302 [debug] [MainThread]: On master: BEGIN
[0m12:24:59.640302 [debug] [MainThread]: Opening a new connection, currently in state init
[0m12:25:01.206903 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:25:01.208895 [debug] [MainThread]: On master: COMMIT
[0m12:25:01.211885 [debug] [MainThread]: Using mysql connection "master"
[0m12:25:01.213883 [debug] [MainThread]: On master: COMMIT
[0m12:25:01.803635 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:25:01.804631 [debug] [MainThread]: On master: Close
[0m12:25:01.807625 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m12:25:01.809588 [info ] [MainThread]: 
[0m12:25:01.821558 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.overview_sales_card_12
[0m12:25:01.823553 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.overview_sales_card_12 .................... [RUN]
[0m12:25:01.826543 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.kasper_sindri_media.overview_sales_card_12'
[0m12:25:01.827537 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.overview_sales_card_12
[0m12:25:01.847908 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.overview_sales_card_12 (compile): 12:25:01.829535 => 12:25:01.846906
[0m12:25:01.853891 [debug] [Thread-1 (]: Compilation Error in model overview_sales_card_12 (models\example\overview_sales_card_12.sql)
  Required var 'json' not found in config:
  Vars supplied to overview_sales_card_12 = {
      "article_evaluation": {
          "over_both_goals": {
              "case": "((coalesce(coalesce(l.hits,0)/coalesce(l.pageviews,0)*100,0))>=coalesce(g.Min_CTA,0) and coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0) )",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          },
          "under_both_goal": {
              "case": "(coalesce((coalesce(l.hits,0)/coalesce(l.pageviews,0)*100),0)<coalesce(g.Min_CTA,0) and coalesce(l.pageviews,0)<coalesce(g.Min_pageviews,0) )",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          },
          "under_one_goal": {
              "case": "(coalesce( coalesce((coalesce(l.hits,0) / coalesce(l.pageviews,0)),0) * 100 , 0)>=coalesce(g.Min_CTA,0) or coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0)) and !((coalesce( coalesce((coalesce(l.hits,0) / coalesce(l.pageviews,0)),0) * 100 , 0))>=coalesce(g.Min_CTA,0) and  coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0) ) ",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          }
      },
      "date_month": "DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)",
      "date_week": "DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)",
      "date_year": "MAKEDATE(EXTRACT(YEAR FROM CURDATE()), 1) AND DATE_SUB(CAST(NOW() AS DATE), INTERVAL 1 DAY)",
      "event_action": "Next Click",
      "overview": {
          "overview_pageviews_card": {
              "hint": "Sidevisninger \u00e5r til dato ift sidste \u00e5r til dato og ift m\u00e5ls\u00e6tning",
              "label": "Sidevisninger"
          },
          "overview_sales_card": {
              "hint": "Gns. next click \u00e5r til dato ift. sidste \u00e5r",
              "label": "Next click (%)"
          },
          "overview_visits_card": {
              "hint": "Bes\u00f8g \u00e5r til dato ift sidste \u00e5r til dato og ift m\u00e5ls\u00e6tning",
              "label": "Bes\u00f8g"
          }
      },
      "site": 12,
      "tendency": {
          "tactical_articles_card": {
              "hint": "Artikler publiceret seneste 30 dage ift. forrige 30 dage",
              "label": "Artikler"
          },
          "tactical_clicks_card": {
              "hint": "Gns. next click p\u00e5 artikler publiceret seneste 30 dage ift. forrige 30 dage",
              "label": "Gns. next click (%)"
          },
          "tactical_pageviews_card": {
              "hint": "Gns. sidevisninger pr artikler publiceret \u00e5r til dato ift. sidste \u00e5r til dato",
              "label": "Gns. sidevisninger pr artikel"
          },
          "tactical_userneeds_pageviews_chart": {
              "dropdown_count": [
                  "",
                  "_second",
                  "_third"
              ],
              "dropdown_name": {
                  "Categories": "Categories",
                  "Tags": "Tags",
                  "userneeds": "userneeds"
              },
              "dropdown_val": {
                  "categories": [
                      "Nyheder",
                      "Debat",
                      "Inspiration",
                      "Anmeldelser"
                  ],
                  "tags": [
                      "skolepolitik",
                      "Psykisk arbejdsmilj\u00f8"
                  ],
                  "userneeds": [
                      "Opdater mig",
                      "Forbind mig",
                      "Hj\u00e6lp mig med at forst\u00e5",
                      "Giv mig en fordel",
                      "Underhold mig",
                      "Inspirer mig"
                  ]
              },
              "hint": "Artikler grupperet ift hvordan de har performet p\u00e5 next click",
              "label": "Artikler ift. next click m\u00e5l"
          }
      }
  }
[0m12:25:01.855886 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9e534736-6095-40be-9c0e-e81a76e1db91', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FBC9F8E790>]}
[0m12:25:01.856883 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.overview_sales_card_12 ........... [[31mERROR[0m in 0.03s]
[0m12:25:01.858877 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.overview_sales_card_12
[0m12:25:01.863864 [debug] [MainThread]: Using mysql connection "master"
[0m12:25:01.864861 [debug] [MainThread]: On master: BEGIN
[0m12:25:01.865858 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m12:25:03.419961 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:25:03.422981 [debug] [MainThread]: On master: COMMIT
[0m12:25:03.424975 [debug] [MainThread]: Using mysql connection "master"
[0m12:25:03.427968 [debug] [MainThread]: On master: COMMIT
[0m12:25:04.014980 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:25:04.016971 [debug] [MainThread]: On master: Close
[0m12:25:04.020962 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:25:04.022958 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m12:25:04.023957 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m12:25:04.025963 [debug] [MainThread]: Connection 'model.kasper_sindri_media.overview_sales_card_12' was properly closed.
[0m12:25:04.027944 [info ] [MainThread]: 
[0m12:25:04.029934 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 11.19 seconds (11.19s).
[0m12:25:04.032929 [debug] [MainThread]: Command end result
[0m12:25:04.046888 [info ] [MainThread]: 
[0m12:25:04.047886 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m12:25:04.049881 [info ] [MainThread]: 
[0m12:25:04.051876 [error] [MainThread]:   Compilation Error in model overview_sales_card_12 (models\example\overview_sales_card_12.sql)
  Required var 'json' not found in config:
  Vars supplied to overview_sales_card_12 = {
      "article_evaluation": {
          "over_both_goals": {
              "case": "((coalesce(coalesce(l.hits,0)/coalesce(l.pageviews,0)*100,0))>=coalesce(g.Min_CTA,0) and coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0) )",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          },
          "under_both_goal": {
              "case": "(coalesce((coalesce(l.hits,0)/coalesce(l.pageviews,0)*100),0)<coalesce(g.Min_CTA,0) and coalesce(l.pageviews,0)<coalesce(g.Min_pageviews,0) )",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          },
          "under_one_goal": {
              "case": "(coalesce( coalesce((coalesce(l.hits,0) / coalesce(l.pageviews,0)),0) * 100 , 0)>=coalesce(g.Min_CTA,0) or coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0)) and !((coalesce( coalesce((coalesce(l.hits,0) / coalesce(l.pageviews,0)),0) * 100 , 0))>=coalesce(g.Min_CTA,0) and  coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0) ) ",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          }
      },
      "date_month": "DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)",
      "date_week": "DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)",
      "date_year": "MAKEDATE(EXTRACT(YEAR FROM CURDATE()), 1) AND DATE_SUB(CAST(NOW() AS DATE), INTERVAL 1 DAY)",
      "event_action": "Next Click",
      "overview": {
          "overview_pageviews_card": {
              "hint": "Sidevisninger \u00e5r til dato ift sidste \u00e5r til dato og ift m\u00e5ls\u00e6tning",
              "label": "Sidevisninger"
          },
          "overview_sales_card": {
              "hint": "Gns. next click \u00e5r til dato ift. sidste \u00e5r",
              "label": "Next click (%)"
          },
          "overview_visits_card": {
              "hint": "Bes\u00f8g \u00e5r til dato ift sidste \u00e5r til dato og ift m\u00e5ls\u00e6tning",
              "label": "Bes\u00f8g"
          }
      },
      "site": 12,
      "tendency": {
          "tactical_articles_card": {
              "hint": "Artikler publiceret seneste 30 dage ift. forrige 30 dage",
              "label": "Artikler"
          },
          "tactical_clicks_card": {
              "hint": "Gns. next click p\u00e5 artikler publiceret seneste 30 dage ift. forrige 30 dage",
              "label": "Gns. next click (%)"
          },
          "tactical_pageviews_card": {
              "hint": "Gns. sidevisninger pr artikler publiceret \u00e5r til dato ift. sidste \u00e5r til dato",
              "label": "Gns. sidevisninger pr artikel"
          },
          "tactical_userneeds_pageviews_chart": {
              "dropdown_count": [
                  "",
                  "_second",
                  "_third"
              ],
              "dropdown_name": {
                  "Categories": "Categories",
                  "Tags": "Tags",
                  "userneeds": "userneeds"
              },
              "dropdown_val": {
                  "categories": [
                      "Nyheder",
                      "Debat",
                      "Inspiration",
                      "Anmeldelser"
                  ],
                  "tags": [
                      "skolepolitik",
                      "Psykisk arbejdsmilj\u00f8"
                  ],
                  "userneeds": [
                      "Opdater mig",
                      "Forbind mig",
                      "Hj\u00e6lp mig med at forst\u00e5",
                      "Giv mig en fordel",
                      "Underhold mig",
                      "Inspirer mig"
                  ]
              },
              "hint": "Artikler grupperet ift hvordan de har performet p\u00e5 next click",
              "label": "Artikler ift. next click m\u00e5l"
          }
      }
  }
[0m12:25:04.054866 [info ] [MainThread]: 
[0m12:25:04.056862 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m12:25:04.060853 [debug] [MainThread]: Command `dbt run` failed at 12:25:04.059856 after 12.21 seconds
[0m12:25:04.061849 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FBC2F20A50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FBC9A72310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FBC9A72210>]}
[0m12:25:04.062846 [debug] [MainThread]: Flushing usage events
[0m12:25:50.193629 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A8CAC27F90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A8CB15C310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A8CB15CA10>]}


============================== 12:25:50.201607 | 52e09c7d-b31e-4b73-941b-f76a23ebc5ba ==============================
[0m12:25:50.201607 [info ] [MainThread]: Running with dbt=1.7.17
[0m12:25:50.203604 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run --models example.overview_sales_card_12', 'send_anonymous_usage_stats': 'True'}
[0m12:25:50.485847 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '52e09c7d-b31e-4b73-941b-f76a23ebc5ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A8CB346750>]}
[0m12:25:50.567628 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '52e09c7d-b31e-4b73-941b-f76a23ebc5ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A8C46F20D0>]}
[0m12:25:50.569621 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m12:25:50.581591 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m12:25:50.604530 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m12:25:50.605543 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '52e09c7d-b31e-4b73-941b-f76a23ebc5ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A8CB360C10>]}
[0m12:25:52.015755 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example.run_overview_sales_card_12
[0m12:25:52.025728 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '52e09c7d-b31e-4b73-941b-f76a23ebc5ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A8CB342690>]}
[0m12:25:52.046679 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '52e09c7d-b31e-4b73-941b-f76a23ebc5ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A8CB6620D0>]}
[0m12:25:52.047667 [info ] [MainThread]: Found 10 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m12:25:52.049665 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '52e09c7d-b31e-4b73-941b-f76a23ebc5ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A8CB141E50>]}
[0m12:25:52.052655 [info ] [MainThread]: 
[0m12:25:52.054200 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m12:25:52.056564 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m12:25:52.071526 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m12:25:52.072524 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m12:25:52.073539 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:25:53.648005 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m12:25:53.652983 [debug] [ThreadPool]: On list_schemas: Close
[0m12:25:53.654988 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m12:25:53.655975 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m12:25:53.662958 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:25:53.662958 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m12:25:53.663954 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:25:55.261383 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:25:55.263374 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:25:55.265367 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m12:25:55.872524 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m12:25:55.877533 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m12:25:55.881508 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:25:55.883503 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m12:25:56.483132 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:25:56.486135 [debug] [ThreadPool]: On create__site_dev: Close
[0m12:25:56.496718 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m12:25:56.513672 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m12:25:56.514671 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m12:25:56.515665 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:25:58.089647 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:25:58.092664 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m12:25:58.094645 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m12:25:58.688154 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:25:58.692134 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m12:25:58.890269 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m12:25:58.895261 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '52e09c7d-b31e-4b73-941b-f76a23ebc5ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A8CB423E50>]}
[0m12:25:58.898248 [debug] [MainThread]: Using mysql connection "master"
[0m12:25:58.900240 [debug] [MainThread]: On master: BEGIN
[0m12:25:58.902235 [debug] [MainThread]: Opening a new connection, currently in state init
[0m12:26:00.455067 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:26:00.456066 [debug] [MainThread]: On master: COMMIT
[0m12:26:00.457068 [debug] [MainThread]: Using mysql connection "master"
[0m12:26:00.459058 [debug] [MainThread]: On master: COMMIT
[0m12:26:01.047725 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:26:01.050713 [debug] [MainThread]: On master: Close
[0m12:26:01.056695 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m12:26:01.261639 [info ] [MainThread]: 
[0m12:26:01.268693 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.overview_sales_card_12
[0m12:26:01.269690 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.overview_sales_card_12 .................... [RUN]
[0m12:26:01.272681 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.kasper_sindri_media.overview_sales_card_12'
[0m12:26:01.273679 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.overview_sales_card_12
[0m12:26:01.290042 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.overview_sales_card_12 (compile): 12:26:01.273679 => 12:26:01.289042
[0m12:26:01.295028 [debug] [Thread-1 (]: Compilation Error in model overview_sales_card_12 (models\example\overview_sales_card_12.sql)
  Required var 'json' not found in config:
  Vars supplied to overview_sales_card_12 = {
      "article_evaluation": {
          "over_both_goals": {
              "case": "((coalesce(coalesce(l.hits,0)/coalesce(l.pageviews,0)*100,0))>=coalesce(g.Min_CTA,0) and coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0) )",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          },
          "under_both_goal": {
              "case": "(coalesce((coalesce(l.hits,0)/coalesce(l.pageviews,0)*100),0)<coalesce(g.Min_CTA,0) and coalesce(l.pageviews,0)<coalesce(g.Min_pageviews,0) )",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          },
          "under_one_goal": {
              "case": "(coalesce( coalesce((coalesce(l.hits,0) / coalesce(l.pageviews,0)),0) * 100 , 0)>=coalesce(g.Min_CTA,0) or coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0)) and !((coalesce( coalesce((coalesce(l.hits,0) / coalesce(l.pageviews,0)),0) * 100 , 0))>=coalesce(g.Min_CTA,0) and  coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0) ) ",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          }
      },
      "date_month": "DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)",
      "date_week": "DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)",
      "date_year": "MAKEDATE(EXTRACT(YEAR FROM CURDATE()), 1) AND DATE_SUB(CAST(NOW() AS DATE), INTERVAL 1 DAY)",
      "event_action": "Next Click",
      "overview": {
          "overview_pageviews_card": {
              "hint": "Sidevisninger \u00e5r til dato ift sidste \u00e5r til dato og ift m\u00e5ls\u00e6tning",
              "label": "Sidevisninger"
          },
          "overview_sales_card": {
              "hint": "Gns. next click \u00e5r til dato ift. sidste \u00e5r",
              "label": "Next click (%)"
          },
          "overview_visits_card": {
              "hint": "Bes\u00f8g \u00e5r til dato ift sidste \u00e5r til dato og ift m\u00e5ls\u00e6tning",
              "label": "Bes\u00f8g"
          }
      },
      "site": 12,
      "tendency": {
          "tactical_articles_card": {
              "hint": "Artikler publiceret seneste 30 dage ift. forrige 30 dage",
              "label": "Artikler"
          },
          "tactical_clicks_card": {
              "hint": "Gns. next click p\u00e5 artikler publiceret seneste 30 dage ift. forrige 30 dage",
              "label": "Gns. next click (%)"
          },
          "tactical_pageviews_card": {
              "hint": "Gns. sidevisninger pr artikler publiceret \u00e5r til dato ift. sidste \u00e5r til dato",
              "label": "Gns. sidevisninger pr artikel"
          },
          "tactical_userneeds_pageviews_chart": {
              "dropdown_count": [
                  "",
                  "_second",
                  "_third"
              ],
              "dropdown_name": {
                  "Categories": "Categories",
                  "Tags": "Tags",
                  "userneeds": "userneeds"
              },
              "dropdown_val": {
                  "categories": [
                      "Nyheder",
                      "Debat",
                      "Inspiration",
                      "Anmeldelser"
                  ],
                  "tags": [
                      "skolepolitik",
                      "Psykisk arbejdsmilj\u00f8"
                  ],
                  "userneeds": [
                      "Opdater mig",
                      "Forbind mig",
                      "Hj\u00e6lp mig med at forst\u00e5",
                      "Giv mig en fordel",
                      "Underhold mig",
                      "Inspirer mig"
                  ]
              },
              "hint": "Artikler grupperet ift hvordan de har performet p\u00e5 next click",
              "label": "Artikler ift. next click m\u00e5l"
          }
      }
  }
[0m12:26:01.297023 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '52e09c7d-b31e-4b73-941b-f76a23ebc5ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A8CB665DD0>]}
[0m12:26:01.298020 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.overview_sales_card_12 ........... [[31mERROR[0m in 0.02s]
[0m12:26:01.299781 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.overview_sales_card_12
[0m12:26:01.303768 [debug] [MainThread]: Using mysql connection "master"
[0m12:26:01.304767 [debug] [MainThread]: On master: BEGIN
[0m12:26:01.304767 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m12:26:02.881145 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:26:02.882141 [debug] [MainThread]: On master: COMMIT
[0m12:26:02.883139 [debug] [MainThread]: Using mysql connection "master"
[0m12:26:02.885134 [debug] [MainThread]: On master: COMMIT
[0m12:26:03.479694 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:26:03.481686 [debug] [MainThread]: On master: Close
[0m12:26:03.487672 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:26:03.489666 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m12:26:03.493654 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m12:26:03.495648 [debug] [MainThread]: Connection 'model.kasper_sindri_media.overview_sales_card_12' was properly closed.
[0m12:26:03.498640 [info ] [MainThread]: 
[0m12:26:03.503626 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 11.44 seconds (11.44s).
[0m12:26:03.510613 [debug] [MainThread]: Command end result
[0m12:26:03.557484 [info ] [MainThread]: 
[0m12:26:03.560473 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m12:26:03.562466 [info ] [MainThread]: 
[0m12:26:03.564461 [error] [MainThread]:   Compilation Error in model overview_sales_card_12 (models\example\overview_sales_card_12.sql)
  Required var 'json' not found in config:
  Vars supplied to overview_sales_card_12 = {
      "article_evaluation": {
          "over_both_goals": {
              "case": "((coalesce(coalesce(l.hits,0)/coalesce(l.pageviews,0)*100,0))>=coalesce(g.Min_CTA,0) and coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0) )",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          },
          "under_both_goal": {
              "case": "(coalesce((coalesce(l.hits,0)/coalesce(l.pageviews,0)*100),0)<coalesce(g.Min_CTA,0) and coalesce(l.pageviews,0)<coalesce(g.Min_pageviews,0) )",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          },
          "under_one_goal": {
              "case": "(coalesce( coalesce((coalesce(l.hits,0) / coalesce(l.pageviews,0)),0) * 100 , 0)>=coalesce(g.Min_CTA,0) or coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0)) and !((coalesce( coalesce((coalesce(l.hits,0) / coalesce(l.pageviews,0)),0) * 100 , 0))>=coalesce(g.Min_CTA,0) and  coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0) ) ",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          }
      },
      "date_month": "DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)",
      "date_week": "DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)",
      "date_year": "MAKEDATE(EXTRACT(YEAR FROM CURDATE()), 1) AND DATE_SUB(CAST(NOW() AS DATE), INTERVAL 1 DAY)",
      "event_action": "Next Click",
      "overview": {
          "overview_pageviews_card": {
              "hint": "Sidevisninger \u00e5r til dato ift sidste \u00e5r til dato og ift m\u00e5ls\u00e6tning",
              "label": "Sidevisninger"
          },
          "overview_sales_card": {
              "hint": "Gns. next click \u00e5r til dato ift. sidste \u00e5r",
              "label": "Next click (%)"
          },
          "overview_visits_card": {
              "hint": "Bes\u00f8g \u00e5r til dato ift sidste \u00e5r til dato og ift m\u00e5ls\u00e6tning",
              "label": "Bes\u00f8g"
          }
      },
      "site": 12,
      "tendency": {
          "tactical_articles_card": {
              "hint": "Artikler publiceret seneste 30 dage ift. forrige 30 dage",
              "label": "Artikler"
          },
          "tactical_clicks_card": {
              "hint": "Gns. next click p\u00e5 artikler publiceret seneste 30 dage ift. forrige 30 dage",
              "label": "Gns. next click (%)"
          },
          "tactical_pageviews_card": {
              "hint": "Gns. sidevisninger pr artikler publiceret \u00e5r til dato ift. sidste \u00e5r til dato",
              "label": "Gns. sidevisninger pr artikel"
          },
          "tactical_userneeds_pageviews_chart": {
              "dropdown_count": [
                  "",
                  "_second",
                  "_third"
              ],
              "dropdown_name": {
                  "Categories": "Categories",
                  "Tags": "Tags",
                  "userneeds": "userneeds"
              },
              "dropdown_val": {
                  "categories": [
                      "Nyheder",
                      "Debat",
                      "Inspiration",
                      "Anmeldelser"
                  ],
                  "tags": [
                      "skolepolitik",
                      "Psykisk arbejdsmilj\u00f8"
                  ],
                  "userneeds": [
                      "Opdater mig",
                      "Forbind mig",
                      "Hj\u00e6lp mig med at forst\u00e5",
                      "Giv mig en fordel",
                      "Underhold mig",
                      "Inspirer mig"
                  ]
              },
              "hint": "Artikler grupperet ift hvordan de har performet p\u00e5 next click",
              "label": "Artikler ift. next click m\u00e5l"
          }
      }
  }
[0m12:26:03.569448 [info ] [MainThread]: 
[0m12:26:03.571442 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m12:26:03.579423 [debug] [MainThread]: Command `dbt run` failed at 12:26:03.579423 after 13.48 seconds
[0m12:26:03.580420 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A8CB19B310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A8CB19B110>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A8C4660A50>]}
[0m12:26:03.581417 [debug] [MainThread]: Flushing usage events
[0m12:37:52.893055 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021983E470D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219838E7CD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021983DF0BD0>]}


============================== 12:37:52.900040 | d7c2c1ec-1deb-4a54-8d50-0e66c3891fa5 ==============================
[0m12:37:52.900040 [info ] [MainThread]: Running with dbt=1.7.17
[0m12:37:52.902032 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models example.overview_sales_card_12', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m12:37:53.213024 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd7c2c1ec-1deb-4a54-8d50-0e66c3891fa5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021983E70F50>]}
[0m12:37:53.299787 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd7c2c1ec-1deb-4a54-8d50-0e66c3891fa5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021984043B90>]}
[0m12:37:53.303776 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m12:37:53.317387 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m12:37:53.474977 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m12:37:53.475972 [debug] [MainThread]: Partial parsing: added file: kasper_sindri_media://models\example\tactical_articles_card_month_12.sql
[0m12:37:53.729295 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example.run_overview_sales_card_12
[0m12:37:53.738273 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd7c2c1ec-1deb-4a54-8d50-0e66c3891fa5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021983FCDB50>]}
[0m12:37:53.758216 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd7c2c1ec-1deb-4a54-8d50-0e66c3891fa5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219841B4A50>]}
[0m12:37:53.760211 [info ] [MainThread]: Found 11 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m12:37:53.761207 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd7c2c1ec-1deb-4a54-8d50-0e66c3891fa5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021984305950>]}
[0m12:37:53.764200 [info ] [MainThread]: 
[0m12:37:53.766594 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m12:37:53.769009 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m12:37:53.782971 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m12:37:53.783970 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m12:37:53.784966 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:37:55.377964 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m12:37:55.381953 [debug] [ThreadPool]: On list_schemas: Close
[0m12:37:55.384948 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m12:37:55.386941 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m12:37:55.398911 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:37:55.399908 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m12:37:55.399908 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:37:56.945581 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:37:56.946586 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:37:56.947580 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m12:37:57.538730 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m12:37:57.543719 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m12:37:57.546711 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:37:57.548711 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m12:37:58.128376 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:37:58.130367 [debug] [ThreadPool]: On create__site_dev: Close
[0m12:37:58.144333 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m12:37:58.162285 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m12:37:58.163278 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m12:37:58.164295 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:37:59.704870 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:37:59.706871 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m12:37:59.707868 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m12:38:00.286116 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:38:00.289108 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m12:38:00.480469 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m12:38:00.483461 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd7c2c1ec-1deb-4a54-8d50-0e66c3891fa5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219842FCC90>]}
[0m12:38:00.484460 [debug] [MainThread]: Using mysql connection "master"
[0m12:38:00.486454 [debug] [MainThread]: On master: BEGIN
[0m12:38:00.487451 [debug] [MainThread]: Opening a new connection, currently in state init
[0m12:38:02.077748 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:38:02.079737 [debug] [MainThread]: On master: COMMIT
[0m12:38:02.082732 [debug] [MainThread]: Using mysql connection "master"
[0m12:38:02.084724 [debug] [MainThread]: On master: COMMIT
[0m12:38:02.683708 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:38:02.684710 [debug] [MainThread]: On master: Close
[0m12:38:02.686704 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m12:38:02.687702 [info ] [MainThread]: 
[0m12:38:02.694408 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.overview_sales_card_12
[0m12:38:02.695408 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.overview_sales_card_12 .................... [RUN]
[0m12:38:02.697550 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.kasper_sindri_media.overview_sales_card_12'
[0m12:38:02.698547 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.overview_sales_card_12
[0m12:38:02.715388 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.overview_sales_card_12 (compile): 12:38:02.698547 => 12:38:02.714388
[0m12:38:02.720375 [debug] [Thread-1 (]: Compilation Error in model overview_sales_card_12 (models\example\overview_sales_card_12.sql)
  Required var 'json' not found in config:
  Vars supplied to overview_sales_card_12 = {
      "article_evaluation": {
          "over_both_goals": {
              "case": "((coalesce(coalesce(l.hits,0)/coalesce(l.pageviews,0)*100,0))>=coalesce(g.Min_CTA,0) and coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0) )",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          },
          "under_both_goal": {
              "case": "(coalesce((coalesce(l.hits,0)/coalesce(l.pageviews,0)*100),0)<coalesce(g.Min_CTA,0) and coalesce(l.pageviews,0)<coalesce(g.Min_pageviews,0) )",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          },
          "under_one_goal": {
              "case": "(coalesce( coalesce((coalesce(l.hits,0) / coalesce(l.pageviews,0)),0) * 100 , 0)>=coalesce(g.Min_CTA,0) or coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0)) and !((coalesce( coalesce((coalesce(l.hits,0) / coalesce(l.pageviews,0)),0) * 100 , 0))>=coalesce(g.Min_CTA,0) and  coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0) ) ",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          }
      },
      "date_month": "DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)",
      "date_week": "DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)",
      "date_year": "MAKEDATE(EXTRACT(YEAR FROM CURDATE()), 1) AND DATE_SUB(CAST(NOW() AS DATE), INTERVAL 1 DAY)",
      "event_action": "Next Click",
      "overview": {
          "overview_pageviews_card": {
              "hint": "Sidevisninger \u00e5r til dato ift sidste \u00e5r til dato og ift m\u00e5ls\u00e6tning",
              "label": "Sidevisninger"
          },
          "overview_sales_card": {
              "hint": "Gns. next click \u00e5r til dato ift. sidste \u00e5r",
              "label": "Next click (%)"
          },
          "overview_visits_card": {
              "hint": "Bes\u00f8g \u00e5r til dato ift sidste \u00e5r til dato og ift m\u00e5ls\u00e6tning",
              "label": "Bes\u00f8g"
          }
      },
      "site": 12,
      "tendency": {
          "tactical_articles_card": {
              "hint": "Artikler publiceret seneste 30 dage ift. forrige 30 dage",
              "label": "Artikler"
          },
          "tactical_clicks_card": {
              "hint": "Gns. next click p\u00e5 artikler publiceret seneste 30 dage ift. forrige 30 dage",
              "label": "Gns. next click (%)"
          },
          "tactical_pageviews_card": {
              "hint": "Gns. sidevisninger pr artikler publiceret \u00e5r til dato ift. sidste \u00e5r til dato",
              "label": "Gns. sidevisninger pr artikel"
          },
          "tactical_userneeds_pageviews_chart": {
              "dropdown_count": [
                  "",
                  "_second",
                  "_third"
              ],
              "dropdown_name": {
                  "Categories": "Categories",
                  "Tags": "Tags",
                  "userneeds": "userneeds"
              },
              "dropdown_val": {
                  "categories": [
                      "Nyheder",
                      "Debat",
                      "Inspiration",
                      "Anmeldelser"
                  ],
                  "tags": [
                      "skolepolitik",
                      "Psykisk arbejdsmilj\u00f8"
                  ],
                  "userneeds": [
                      "Opdater mig",
                      "Forbind mig",
                      "Hj\u00e6lp mig med at forst\u00e5",
                      "Giv mig en fordel",
                      "Underhold mig",
                      "Inspirer mig"
                  ]
              },
              "hint": "Artikler grupperet ift hvordan de har performet p\u00e5 next click",
              "label": "Artikler ift. next click m\u00e5l"
          }
      }
  }
[0m12:38:02.721372 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd7c2c1ec-1deb-4a54-8d50-0e66c3891fa5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021984352B90>]}
[0m12:38:02.722369 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.overview_sales_card_12 ........... [[31mERROR[0m in 0.02s]
[0m12:38:02.724775 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.overview_sales_card_12
[0m12:38:02.727766 [debug] [MainThread]: Using mysql connection "master"
[0m12:38:02.728761 [debug] [MainThread]: On master: BEGIN
[0m12:38:02.729760 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m12:38:04.280553 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:38:04.283566 [debug] [MainThread]: On master: COMMIT
[0m12:38:04.285553 [debug] [MainThread]: Using mysql connection "master"
[0m12:38:04.287542 [debug] [MainThread]: On master: COMMIT
[0m12:38:04.872436 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:38:04.875456 [debug] [MainThread]: On master: Close
[0m12:38:04.877449 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:38:04.878445 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m12:38:04.879456 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m12:38:04.879456 [debug] [MainThread]: Connection 'model.kasper_sindri_media.overview_sales_card_12' was properly closed.
[0m12:38:04.880440 [info ] [MainThread]: 
[0m12:38:04.882435 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 11.11 seconds (11.11s).
[0m12:38:04.884446 [debug] [MainThread]: Command end result
[0m12:38:04.899389 [info ] [MainThread]: 
[0m12:38:04.900386 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m12:38:04.903383 [info ] [MainThread]: 
[0m12:38:04.905373 [error] [MainThread]:   Compilation Error in model overview_sales_card_12 (models\example\overview_sales_card_12.sql)
  Required var 'json' not found in config:
  Vars supplied to overview_sales_card_12 = {
      "article_evaluation": {
          "over_both_goals": {
              "case": "((coalesce(coalesce(l.hits,0)/coalesce(l.pageviews,0)*100,0))>=coalesce(g.Min_CTA,0) and coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0) )",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          },
          "under_both_goal": {
              "case": "(coalesce((coalesce(l.hits,0)/coalesce(l.pageviews,0)*100),0)<coalesce(g.Min_CTA,0) and coalesce(l.pageviews,0)<coalesce(g.Min_pageviews,0) )",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          },
          "under_one_goal": {
              "case": "(coalesce( coalesce((coalesce(l.hits,0) / coalesce(l.pageviews,0)),0) * 100 , 0)>=coalesce(g.Min_CTA,0) or coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0)) and !((coalesce( coalesce((coalesce(l.hits,0) / coalesce(l.pageviews,0)),0) * 100 , 0))>=coalesce(g.Min_CTA,0) and  coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0) ) ",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          }
      },
      "date_month": "DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)",
      "date_week": "DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)",
      "date_year": "MAKEDATE(EXTRACT(YEAR FROM CURDATE()), 1) AND DATE_SUB(CAST(NOW() AS DATE), INTERVAL 1 DAY)",
      "event_action": "Next Click",
      "overview": {
          "overview_pageviews_card": {
              "hint": "Sidevisninger \u00e5r til dato ift sidste \u00e5r til dato og ift m\u00e5ls\u00e6tning",
              "label": "Sidevisninger"
          },
          "overview_sales_card": {
              "hint": "Gns. next click \u00e5r til dato ift. sidste \u00e5r",
              "label": "Next click (%)"
          },
          "overview_visits_card": {
              "hint": "Bes\u00f8g \u00e5r til dato ift sidste \u00e5r til dato og ift m\u00e5ls\u00e6tning",
              "label": "Bes\u00f8g"
          }
      },
      "site": 12,
      "tendency": {
          "tactical_articles_card": {
              "hint": "Artikler publiceret seneste 30 dage ift. forrige 30 dage",
              "label": "Artikler"
          },
          "tactical_clicks_card": {
              "hint": "Gns. next click p\u00e5 artikler publiceret seneste 30 dage ift. forrige 30 dage",
              "label": "Gns. next click (%)"
          },
          "tactical_pageviews_card": {
              "hint": "Gns. sidevisninger pr artikler publiceret \u00e5r til dato ift. sidste \u00e5r til dato",
              "label": "Gns. sidevisninger pr artikel"
          },
          "tactical_userneeds_pageviews_chart": {
              "dropdown_count": [
                  "",
                  "_second",
                  "_third"
              ],
              "dropdown_name": {
                  "Categories": "Categories",
                  "Tags": "Tags",
                  "userneeds": "userneeds"
              },
              "dropdown_val": {
                  "categories": [
                      "Nyheder",
                      "Debat",
                      "Inspiration",
                      "Anmeldelser"
                  ],
                  "tags": [
                      "skolepolitik",
                      "Psykisk arbejdsmilj\u00f8"
                  ],
                  "userneeds": [
                      "Opdater mig",
                      "Forbind mig",
                      "Hj\u00e6lp mig med at forst\u00e5",
                      "Giv mig en fordel",
                      "Underhold mig",
                      "Inspirer mig"
                  ]
              },
              "hint": "Artikler grupperet ift hvordan de har performet p\u00e5 next click",
              "label": "Artikler ift. next click m\u00e5l"
          }
      }
  }
[0m12:38:04.908365 [info ] [MainThread]: 
[0m12:38:04.910361 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m12:38:04.914349 [debug] [MainThread]: Command `dbt run` failed at 12:38:04.914349 after 12.13 seconds
[0m12:38:04.916344 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021983A41010>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219FD310A50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219FD310A90>]}
[0m12:38:04.917341 [debug] [MainThread]: Flushing usage events
[0m12:38:37.603707 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EBC1551F90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EBC15A5D50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EBC1552890>]}


============================== 12:38:37.612680 | 78d97cbc-85d2-46ad-bcea-1cf294500fc6 ==============================
[0m12:38:37.612680 [info ] [MainThread]: Running with dbt=1.7.17
[0m12:38:37.614677 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'version_check': 'True', 'debug': 'False', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --models example.tactical_articles_card_month_12', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m12:38:37.909958 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '78d97cbc-85d2-46ad-bcea-1cf294500fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EBC1757ED0>]}
[0m12:38:37.996725 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '78d97cbc-85d2-46ad-bcea-1cf294500fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EBC156B1D0>]}
[0m12:38:37.998476 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m12:38:38.010449 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m12:38:38.034400 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m12:38:38.035238 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '78d97cbc-85d2-46ad-bcea-1cf294500fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EBC11B54D0>]}
[0m12:38:39.413506 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example.run_tactical_articles_card_month_12
[0m12:38:39.422482 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '78d97cbc-85d2-46ad-bcea-1cf294500fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EBC1A82E90>]}
[0m12:38:39.441430 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '78d97cbc-85d2-46ad-bcea-1cf294500fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EBC192F350>]}
[0m12:38:39.443426 [info ] [MainThread]: Found 11 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m12:38:39.444422 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '78d97cbc-85d2-46ad-bcea-1cf294500fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EBC1880910>]}
[0m12:38:39.448412 [info ] [MainThread]: 
[0m12:38:39.450406 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m12:38:39.452865 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m12:38:39.466850 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m12:38:39.467825 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m12:38:39.467825 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:38:41.062454 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m12:38:41.068442 [debug] [ThreadPool]: On list_schemas: Close
[0m12:38:41.075415 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m12:38:41.079413 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m12:38:41.093367 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:38:41.094363 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m12:38:41.095360 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:38:42.662291 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:38:42.665311 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:38:42.667305 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m12:38:43.260562 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m12:38:43.266535 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m12:38:43.268529 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:38:43.270521 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m12:38:43.856175 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:38:43.858168 [debug] [ThreadPool]: On create__site_dev: Close
[0m12:38:43.862890 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m12:38:43.871871 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m12:38:43.872868 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m12:38:43.872868 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:38:45.472932 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:38:45.474930 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m12:38:45.476922 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m12:38:46.067222 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:38:46.072206 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m12:38:46.268375 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m12:38:46.273369 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '78d97cbc-85d2-46ad-bcea-1cf294500fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EBC170C510>]}
[0m12:38:46.276360 [debug] [MainThread]: Using mysql connection "master"
[0m12:38:46.278345 [debug] [MainThread]: On master: BEGIN
[0m12:38:46.281340 [debug] [MainThread]: Opening a new connection, currently in state init
[0m12:38:47.846022 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:38:47.847016 [debug] [MainThread]: On master: COMMIT
[0m12:38:47.849010 [debug] [MainThread]: Using mysql connection "master"
[0m12:38:47.851005 [debug] [MainThread]: On master: COMMIT
[0m12:38:48.441387 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:38:48.444397 [debug] [MainThread]: On master: Close
[0m12:38:48.447414 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m12:38:48.448373 [info ] [MainThread]: 
[0m12:38:48.457351 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.tactical_articles_card_month_12
[0m12:38:48.458348 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.tactical_articles_card_month_12 ........... [RUN]
[0m12:38:48.466327 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.kasper_sindri_media.tactical_articles_card_month_12'
[0m12:38:48.472310 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.tactical_articles_card_month_12
[0m12:38:48.488267 [debug] [Thread-1 (]: Writing injected SQL for node "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m12:38:48.490263 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.tactical_articles_card_month_12 (compile): 12:38:48.473308 => 12:38:48.489266
[0m12:38:48.492258 [debug] [Thread-1 (]: Began executing node model.kasper_sindri_media.tactical_articles_card_month_12
[0m12:38:48.551101 [debug] [Thread-1 (]: Writing runtime sql for node "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m12:38:48.557525 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m12:38:48.558521 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: BEGIN
[0m12:38:48.559519 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m12:38:50.114565 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:38:50.117557 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m12:38:50.120548 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.kasper_sindri_media.tactical_articles_card_month_12"} */

  create view `site_dev`.`tactical_articles_card_month_12__dbt_tmp`
    
    
  as (
    






CREATE PROCEDURE `prod`.`tactical_articles_card_month_12`(
IN site INT, IN label_val VARCHAR(200), IN hint_val text
)
BEGIN
with last_30_day as
(
SELECT siteId as siteId,count(date) as value FROM prod.site_archive_post
where date between DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) 
and siteid = 12
group by 1
),
last_30_days_before as 
(
SELECT siteId as siteId,count(*) value  FROM prod.site_archive_post
where 
date between date between DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) 
and siteid = 12
group by 1
)
select 
JSON_OBJECT(
'site',ld.siteId,'data',
JSON_OBJECT('label', label_val, 'hint',hint_val,'value',
COALESCE(ld.value,0),
'change',COALESCE(round(((ld.value-lb.value)/lb.value)*100,2),0), 
'progressCurrent','','progressTotal',''))AS json_data
from last_30_day ld
left join last_30_days_before lb
on ld.siteId=lb.siteId
;

END
  );
[0m12:38:50.706482 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_month_12`(
IN site INT, IN label' at line 14
[0m12:38:50.709469 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: ROLLBACK
[0m12:38:50.908037 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.tactical_articles_card_month_12 (execute): 12:38:48.493257 => 12:38:50.907043
[0m12:38:50.910031 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: Close
[0m12:38:50.932971 [debug] [Thread-1 (]: Database Error in model tactical_articles_card_month_12 (models\example\tactical_articles_card_month_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_month_12`(
  IN site INT, IN label' at line 14
  compiled Code at target\run\kasper_sindri_media\models\example\tactical_articles_card_month_12.sql
[0m12:38:50.934964 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78d97cbc-85d2-46ad-bcea-1cf294500fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EBC198DE90>]}
[0m12:38:50.936959 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.tactical_articles_card_month_12 .. [[31mERROR[0m in 2.47s]
[0m12:38:50.938951 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.tactical_articles_card_month_12
[0m12:38:50.942942 [debug] [MainThread]: Using mysql connection "master"
[0m12:38:50.943936 [debug] [MainThread]: On master: BEGIN
[0m12:38:50.944937 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m12:38:52.488742 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:38:52.491744 [debug] [MainThread]: On master: COMMIT
[0m12:38:52.494741 [debug] [MainThread]: Using mysql connection "master"
[0m12:38:52.496730 [debug] [MainThread]: On master: COMMIT
[0m12:38:53.073884 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:38:53.075884 [debug] [MainThread]: On master: Close
[0m12:38:53.080875 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:38:53.082867 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m12:38:53.084869 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m12:38:53.087855 [debug] [MainThread]: Connection 'model.kasper_sindri_media.tactical_articles_card_month_12' was properly closed.
[0m12:38:53.088859 [info ] [MainThread]: 
[0m12:38:53.091614 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 13.64 seconds (13.64s).
[0m12:38:53.094721 [debug] [MainThread]: Command end result
[0m12:38:53.110677 [info ] [MainThread]: 
[0m12:38:53.112675 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m12:38:53.114667 [info ] [MainThread]: 
[0m12:38:53.115772 [error] [MainThread]:   Database Error in model tactical_articles_card_month_12 (models\example\tactical_articles_card_month_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_month_12`(
  IN site INT, IN label' at line 14
  compiled Code at target\run\kasper_sindri_media\models\example\tactical_articles_card_month_12.sql
[0m12:38:53.117512 [info ] [MainThread]: 
[0m12:38:53.119813 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m12:38:53.121425 [debug] [MainThread]: Command `dbt run` failed at 12:38:53.121425 after 15.62 seconds
[0m12:38:53.122422 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EBC0992B50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EBBAB21550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EBBAB21590>]}
[0m12:38:53.123419 [debug] [MainThread]: Flushing usage events
[0m12:41:15.000102 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000218BB5D0CD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000218BB625A50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000218BB625FD0>]}


============================== 12:41:15.006088 | 08d0861c-e048-4ea1-8251-bb8d9104b328 ==============================
[0m12:41:15.006088 [info ] [MainThread]: Running with dbt=1.7.17
[0m12:41:15.007085 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models example.tactical_articles_card_month_12', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m12:41:15.302294 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '08d0861c-e048-4ea1-8251-bb8d9104b328', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000218BB7F1650>]}
[0m12:41:15.420976 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '08d0861c-e048-4ea1-8251-bb8d9104b328', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000218BB5EBF50>]}
[0m12:41:15.423763 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m12:41:15.445707 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m12:41:15.611313 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m12:41:15.612312 [debug] [MainThread]: Partial parsing: updated file: kasper_sindri_media://models\example\tactical_articles_card_month_12.sql
[0m12:41:15.890566 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example.run_tactical_articles_card_month_12
[0m12:41:15.903531 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '08d0861c-e048-4ea1-8251-bb8d9104b328', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000218BBB13D90>]}
[0m12:41:15.928465 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '08d0861c-e048-4ea1-8251-bb8d9104b328', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000218BBB082D0>]}
[0m12:41:15.931457 [info ] [MainThread]: Found 11 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m12:41:15.933450 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '08d0861c-e048-4ea1-8251-bb8d9104b328', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000218BB8D1ED0>]}
[0m12:41:15.936448 [info ] [MainThread]: 
[0m12:41:15.939580 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m12:41:15.943567 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m12:41:15.962517 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m12:41:15.963529 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m12:41:15.963529 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:41:17.563820 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m12:41:17.566810 [debug] [ThreadPool]: On list_schemas: Close
[0m12:41:17.568742 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m12:41:17.571739 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m12:41:17.580715 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:41:17.581714 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m12:41:17.582712 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:41:19.161045 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:41:19.162048 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:41:19.163044 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m12:41:19.759375 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m12:41:19.765389 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m12:41:19.767383 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:41:19.770376 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m12:41:20.355971 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:41:20.357961 [debug] [ThreadPool]: On create__site_dev: Close
[0m12:41:20.362842 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m12:41:20.370827 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m12:41:20.370827 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m12:41:20.371822 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:41:21.909673 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:41:21.912680 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m12:41:21.914676 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m12:41:22.493789 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:41:22.498760 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m12:41:22.690382 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m12:41:22.695280 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '08d0861c-e048-4ea1-8251-bb8d9104b328', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000218BBA6AD90>]}
[0m12:41:22.696283 [debug] [MainThread]: Using mysql connection "master"
[0m12:41:22.697281 [debug] [MainThread]: On master: BEGIN
[0m12:41:22.698290 [debug] [MainThread]: Opening a new connection, currently in state init
[0m12:41:24.304763 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:41:24.307764 [debug] [MainThread]: On master: COMMIT
[0m12:41:24.309761 [debug] [MainThread]: Using mysql connection "master"
[0m12:41:24.310753 [debug] [MainThread]: On master: COMMIT
[0m12:41:24.907389 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:41:24.910409 [debug] [MainThread]: On master: Close
[0m12:41:24.912401 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m12:41:24.913755 [info ] [MainThread]: 
[0m12:41:24.920953 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.tactical_articles_card_month_12
[0m12:41:24.921953 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.tactical_articles_card_month_12 ........... [RUN]
[0m12:41:24.923918 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.kasper_sindri_media.tactical_articles_card_month_12'
[0m12:41:24.924915 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.tactical_articles_card_month_12
[0m12:41:24.936911 [debug] [Thread-1 (]: Writing injected SQL for node "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m12:41:24.938877 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.tactical_articles_card_month_12 (compile): 12:41:24.924915 => 12:41:24.937880
[0m12:41:24.938877 [debug] [Thread-1 (]: Began executing node model.kasper_sindri_media.tactical_articles_card_month_12
[0m12:41:24.985752 [debug] [Thread-1 (]: Writing runtime sql for node "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m12:41:24.987749 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m12:41:24.988746 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: BEGIN
[0m12:41:24.989742 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m12:41:26.563033 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:41:26.564034 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m12:41:26.565031 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.kasper_sindri_media.tactical_articles_card_month_12"} */

  create view `site_dev`.`tactical_articles_card_month_12__dbt_tmp`
    
    
  as (
    





CREATE PROCEDURE `prod`.`tactical_articles_card_month_12`(
    IN site INT, 
    IN label_val VARCHAR(200), 
    IN hint_val text
)
BEGIN
with last_30_day as
(
SELECT siteId as siteId,count(date) as value FROM prod.site_archive_post
where date between DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) 
and siteid = 12
group by 1
),
last_30_days_before as 
(
SELECT siteId as siteId,count(*) value  FROM prod.site_archive_post
where 
date between date between DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) 
and siteid = 12
group by 1
)
select 
JSON_OBJECT(
'site',ld.siteId,'data',
JSON_OBJECT('label', label_val, 'hint',hint_val,'value',
COALESCE(ld.value,0),
'change',COALESCE(round(((ld.value-lb.value)/lb.value)*100,2),0), 
'progressCurrent','','progressTotal',''))AS json_data
from last_30_day ld
left join last_30_days_before lb
on ld.siteId=lb.siteId
;

END
  );
[0m12:41:27.157026 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_month_12`(
    IN site INT, 
   ' at line 13
[0m12:41:27.159019 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: ROLLBACK
[0m12:41:27.363413 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.tactical_articles_card_month_12 (execute): 12:41:24.939880 => 12:41:27.361411
[0m12:41:27.365417 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: Close
[0m12:41:27.386362 [debug] [Thread-1 (]: Database Error in model tactical_articles_card_month_12 (models\example\tactical_articles_card_month_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_month_12`(
      IN site INT, 
     ' at line 13
  compiled Code at target\run\kasper_sindri_media\models\example\tactical_articles_card_month_12.sql
[0m12:41:27.387349 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '08d0861c-e048-4ea1-8251-bb8d9104b328', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000218BBB8E690>]}
[0m12:41:27.389365 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.tactical_articles_card_month_12 .. [[31mERROR[0m in 2.46s]
[0m12:41:27.391338 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.tactical_articles_card_month_12
[0m12:41:27.395327 [debug] [MainThread]: Using mysql connection "master"
[0m12:41:27.396324 [debug] [MainThread]: On master: BEGIN
[0m12:41:27.397321 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m12:41:29.183922 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:41:29.184928 [debug] [MainThread]: On master: COMMIT
[0m12:41:29.185925 [debug] [MainThread]: Using mysql connection "master"
[0m12:41:29.186924 [debug] [MainThread]: On master: COMMIT
[0m12:41:29.779706 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:41:29.782732 [debug] [MainThread]: On master: Close
[0m12:41:29.785714 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:41:29.785714 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m12:41:29.786713 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m12:41:29.787708 [debug] [MainThread]: Connection 'model.kasper_sindri_media.tactical_articles_card_month_12' was properly closed.
[0m12:41:29.788706 [info ] [MainThread]: 
[0m12:41:29.789703 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 13.85 seconds (13.85s).
[0m12:41:29.791316 [debug] [MainThread]: Command end result
[0m12:41:29.803285 [info ] [MainThread]: 
[0m12:41:29.804125 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m12:41:29.805372 [info ] [MainThread]: 
[0m12:41:29.806365 [error] [MainThread]:   Database Error in model tactical_articles_card_month_12 (models\example\tactical_articles_card_month_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_month_12`(
      IN site INT, 
     ' at line 13
  compiled Code at target\run\kasper_sindri_media\models\example\tactical_articles_card_month_12.sql
[0m12:41:29.807566 [info ] [MainThread]: 
[0m12:41:29.809929 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m12:41:29.812922 [debug] [MainThread]: Command `dbt run` failed at 12:41:29.811922 after 14.91 seconds
[0m12:41:29.813919 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000218BB5FC910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000218BB210F10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000218BBAE1450>]}
[0m12:41:29.814918 [debug] [MainThread]: Flushing usage events
[0m12:43:42.914968 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002551D769510>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002551D769150>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002551D76A850>]}


============================== 12:43:42.922953 | e9bd2962-4939-49f9-b60f-075be51480b2 ==============================
[0m12:43:42.922953 [info ] [MainThread]: Running with dbt=1.7.17
[0m12:43:42.925937 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --models example.tactical_articles_card_month_12', 'send_anonymous_usage_stats': 'True'}
[0m12:43:43.233252 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e9bd2962-4939-49f9-b60f-075be51480b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002551D99EFD0>]}
[0m12:43:43.320028 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e9bd2962-4939-49f9-b60f-075be51480b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002551D76B550>]}
[0m12:43:43.322806 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m12:43:43.336669 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m12:43:43.468561 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m12:43:43.469555 [debug] [MainThread]: Partial parsing: updated file: kasper_sindri_media://models\example\tactical_articles_card_month_12.sql
[0m12:43:43.694956 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example.run_tactical_articles_card_month_12
[0m12:43:43.705924 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e9bd2962-4939-49f9-b60f-075be51480b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002551DACCFD0>]}
[0m12:43:43.726868 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e9bd2962-4939-49f9-b60f-075be51480b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002551DC94510>]}
[0m12:43:43.728863 [info ] [MainThread]: Found 11 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m12:43:43.730858 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e9bd2962-4939-49f9-b60f-075be51480b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002551DA51FD0>]}
[0m12:43:43.734883 [info ] [MainThread]: 
[0m12:43:43.736845 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m12:43:43.739833 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m12:43:43.759780 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m12:43:43.760778 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m12:43:43.760778 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:43:45.490723 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m12:43:45.498706 [debug] [ThreadPool]: On list_schemas: Close
[0m12:43:45.504688 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m12:43:45.509672 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m12:43:45.521638 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:43:45.522636 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m12:43:45.523630 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:43:47.123104 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:43:47.125109 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:43:47.127102 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m12:43:47.730429 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m12:43:47.733424 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m12:43:47.734424 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:43:47.735421 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m12:43:48.330325 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:43:48.332333 [debug] [ThreadPool]: On create__site_dev: Close
[0m12:43:48.354257 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m12:43:48.382182 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m12:43:48.383180 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m12:43:48.385177 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:43:50.036537 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:43:50.039518 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m12:43:50.043506 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m12:43:50.636327 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:43:50.639323 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m12:43:50.835503 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m12:43:50.838504 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e9bd2962-4939-49f9-b60f-075be51480b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002551D7A8190>]}
[0m12:43:50.839496 [debug] [MainThread]: Using mysql connection "master"
[0m12:43:50.840491 [debug] [MainThread]: On master: BEGIN
[0m12:43:50.842486 [debug] [MainThread]: Opening a new connection, currently in state init
[0m12:43:52.406700 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:43:52.407704 [debug] [MainThread]: On master: COMMIT
[0m12:43:52.409697 [debug] [MainThread]: Using mysql connection "master"
[0m12:43:52.410695 [debug] [MainThread]: On master: COMMIT
[0m12:43:53.016249 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:43:53.019255 [debug] [MainThread]: On master: Close
[0m12:43:53.024241 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m12:43:53.027242 [info ] [MainThread]: 
[0m12:43:53.038055 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.tactical_articles_card_month_12
[0m12:43:53.039057 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.tactical_articles_card_month_12 ........... [RUN]
[0m12:43:53.041409 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.kasper_sindri_media.tactical_articles_card_month_12'
[0m12:43:53.042408 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.tactical_articles_card_month_12
[0m12:43:53.058382 [debug] [Thread-1 (]: Writing injected SQL for node "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m12:43:53.060357 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.tactical_articles_card_month_12 (compile): 12:43:53.042408 => 12:43:53.059359
[0m12:43:53.061353 [debug] [Thread-1 (]: Began executing node model.kasper_sindri_media.tactical_articles_card_month_12
[0m12:43:53.124184 [debug] [Thread-1 (]: Writing runtime sql for node "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m12:43:53.126180 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m12:43:53.127184 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: BEGIN
[0m12:43:53.127184 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m12:43:54.704234 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:43:54.705230 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m12:43:54.706228 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.kasper_sindri_media.tactical_articles_card_month_12"} */

  create view `site_dev`.`tactical_articles_card_month_12__dbt_tmp`
    
    
  as (
    





CREATE PROCEDURE `prod`.`tactical_articles_card_month_12`()
BEGIN
with last_30_day as
(
SELECT siteId as siteId,count(date) as value FROM prod.site_archive_post
where date between DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) 
and siteid = 12
group by 1
),
last_30_days_before as 
(
SELECT siteId as siteId,count(*) value  FROM prod.site_archive_post
where 
date between date between DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) 
and siteid = 12
group by 1
)
select 
JSON_OBJECT(
'site',ld.siteId,'data',
JSON_OBJECT('label', label_val, 'hint',hint_val,'value',
COALESCE(ld.value,0),
'change',COALESCE(round(((ld.value-lb.value)/lb.value)*100,2),0), 
'progressCurrent','','progressTotal',''))AS json_data
from last_30_day ld
left join last_30_days_before lb
on ld.siteId=lb.siteId
;

END
  );
[0m12:43:55.297562 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_month_12`()
BEGIN
with last_30_d' at line 13
[0m12:43:55.299562 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: ROLLBACK
[0m12:43:55.498687 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.tactical_articles_card_month_12 (execute): 12:43:53.062353 => 12:43:55.497689
[0m12:43:55.501676 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: Close
[0m12:43:55.522614 [debug] [Thread-1 (]: Database Error in model tactical_articles_card_month_12 (models\example\tactical_articles_card_month_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_month_12`()
  BEGIN
  with last_30_d' at line 13
  compiled Code at target\run\kasper_sindri_media\models\example\tactical_articles_card_month_12.sql
[0m12:43:55.524614 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9bd2962-4939-49f9-b60f-075be51480b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002551DC90710>]}
[0m12:43:55.525609 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.tactical_articles_card_month_12 .. [[31mERROR[0m in 2.48s]
[0m12:43:55.528600 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.tactical_articles_card_month_12
[0m12:43:55.531591 [debug] [MainThread]: Using mysql connection "master"
[0m12:43:55.532588 [debug] [MainThread]: On master: BEGIN
[0m12:43:55.533598 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m12:43:57.129288 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:43:57.132308 [debug] [MainThread]: On master: COMMIT
[0m12:43:57.134308 [debug] [MainThread]: Using mysql connection "master"
[0m12:43:57.136308 [debug] [MainThread]: On master: COMMIT
[0m12:43:57.733498 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:43:57.737487 [debug] [MainThread]: On master: Close
[0m12:43:57.743469 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:43:57.747461 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m12:43:57.751449 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m12:43:57.756434 [debug] [MainThread]: Connection 'model.kasper_sindri_media.tactical_articles_card_month_12' was properly closed.
[0m12:43:57.759434 [info ] [MainThread]: 
[0m12:43:57.762417 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 14.02 seconds (14.02s).
[0m12:43:57.768407 [debug] [MainThread]: Command end result
[0m12:43:57.790342 [info ] [MainThread]: 
[0m12:43:57.792337 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m12:43:57.794332 [info ] [MainThread]: 
[0m12:43:57.798268 [error] [MainThread]:   Database Error in model tactical_articles_card_month_12 (models\example\tactical_articles_card_month_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_month_12`()
  BEGIN
  with last_30_d' at line 13
  compiled Code at target\run\kasper_sindri_media\models\example\tactical_articles_card_month_12.sql
[0m12:43:57.801261 [info ] [MainThread]: 
[0m12:43:57.804252 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m12:43:57.808387 [debug] [MainThread]: Command `dbt run` failed at 12:43:57.807387 after 14.99 seconds
[0m12:43:57.809384 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025516C70B10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025516C70AD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002551DCFAF50>]}
[0m12:43:57.810382 [debug] [MainThread]: Flushing usage events
[0m12:45:00.230449 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E5735300D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E572952890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E573007C50>]}


============================== 12:45:00.239427 | 0b9f9c8c-6d63-47ba-8cd9-f907ecc44253 ==============================
[0m12:45:00.239427 [info ] [MainThread]: Running with dbt=1.7.17
[0m12:45:00.241422 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --models example.tactical_articles_card_month_12', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m12:45:00.596182 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0b9f9c8c-6d63-47ba-8cd9-f907ecc44253', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E5730103D0>]}
[0m12:45:00.783681 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0b9f9c8c-6d63-47ba-8cd9-f907ecc44253', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E57352A250>]}
[0m12:45:00.786673 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m12:45:00.807617 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m12:45:00.981153 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m12:45:00.983158 [debug] [MainThread]: Partial parsing: updated file: kasper_sindri_media://models\example\tactical_articles_card_month_12.sql
[0m12:45:01.303291 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example.run_tactical_articles_card_month_12
[0m12:45:01.315258 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0b9f9c8c-6d63-47ba-8cd9-f907ecc44253', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E5738949D0>]}
[0m12:45:01.335206 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0b9f9c8c-6d63-47ba-8cd9-f907ecc44253', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E5738D5A90>]}
[0m12:45:01.337199 [info ] [MainThread]: Found 11 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m12:45:01.338208 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0b9f9c8c-6d63-47ba-8cd9-f907ecc44253', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E573A2A2D0>]}
[0m12:45:01.341190 [info ] [MainThread]: 
[0m12:45:01.342197 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m12:45:01.345178 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m12:45:01.362132 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m12:45:01.363129 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m12:45:01.364129 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:45:02.929611 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m12:45:02.933609 [debug] [ThreadPool]: On list_schemas: Close
[0m12:45:02.937595 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m12:45:02.939591 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m12:45:02.949562 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:45:02.950560 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m12:45:02.950560 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:45:04.504608 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:45:04.505609 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:45:04.506606 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m12:45:05.193557 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m12:45:05.195554 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m12:45:05.196550 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:45:05.196550 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m12:45:05.777570 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:45:05.778569 [debug] [ThreadPool]: On create__site_dev: Close
[0m12:45:05.784551 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m12:45:05.791533 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m12:45:05.792529 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m12:45:05.794525 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:45:07.336650 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:45:07.337649 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m12:45:07.339643 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m12:45:07.921939 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:45:07.926966 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m12:45:08.123986 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m12:45:08.128983 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0b9f9c8c-6d63-47ba-8cd9-f907ecc44253', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E573A21790>]}
[0m12:45:08.130976 [debug] [MainThread]: Using mysql connection "master"
[0m12:45:08.133969 [debug] [MainThread]: On master: BEGIN
[0m12:45:08.136961 [debug] [MainThread]: Opening a new connection, currently in state init
[0m12:45:09.722042 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:45:09.723038 [debug] [MainThread]: On master: COMMIT
[0m12:45:09.725033 [debug] [MainThread]: Using mysql connection "master"
[0m12:45:09.726030 [debug] [MainThread]: On master: COMMIT
[0m12:45:10.422086 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:45:10.424093 [debug] [MainThread]: On master: Close
[0m12:45:10.429066 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m12:45:10.432058 [info ] [MainThread]: 
[0m12:45:10.445635 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.tactical_articles_card_month_12
[0m12:45:10.448635 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.tactical_articles_card_month_12 ........... [RUN]
[0m12:45:10.453433 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.kasper_sindri_media.tactical_articles_card_month_12'
[0m12:45:10.455428 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.tactical_articles_card_month_12
[0m12:45:10.477372 [debug] [Thread-1 (]: Writing injected SQL for node "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m12:45:10.479376 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.tactical_articles_card_month_12 (compile): 12:45:10.456425 => 12:45:10.479376
[0m12:45:10.480359 [debug] [Thread-1 (]: Began executing node model.kasper_sindri_media.tactical_articles_card_month_12
[0m12:45:10.532221 [debug] [Thread-1 (]: Writing runtime sql for node "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m12:45:10.533220 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m12:45:10.534214 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: BEGIN
[0m12:45:10.535215 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m12:45:12.128518 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:45:12.131510 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m12:45:12.134501 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.kasper_sindri_media.tactical_articles_card_month_12"} */

  create view `site_dev`.`tactical_articles_card_month_12__dbt_tmp`
    
    
  as (
    





CREATE PROCEDURE `prod`.`tactical_articles_card_month_12`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT
)
BEGIN
    WITH last_30_day AS (
        SELECT siteId as siteId, COUNT(date) as value 
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND siteid = 12
        GROUP BY 1
    ),
    last_30_days_before AS (
        SELECT siteId as siteId, COUNT(*) as value  
        FROM prod.site_archive_post
        WHERE date BETWEEN 
        AND siteid = 12
        GROUP BY 1
    )
    SELECT
        JSON_OBJECT(
            'site', ld.siteId,
            'data', JSON_OBJECT(
                'label', label_val,
                'hint', hint_val,
                'value', COALESCE(ld.value, 0),
                'change', COALESCE(ROUND(((ld.value - lb.value) / lb.value) * 100, 2), 0),
                'progressCurrent', '',
                'progressTotal', ''
            )
        ) AS json_data
    FROM last_30_day ld
    LEFT JOIN last_30_days_before lb ON ld.siteId = lb.siteId;
END;
  );
[0m12:45:12.735505 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_month_12`(
    IN site INT,
    ' at line 13
[0m12:45:12.736501 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: ROLLBACK
[0m12:45:12.936108 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.tactical_articles_card_month_12 (execute): 12:45:10.481360 => 12:45:12.936108
[0m12:45:12.937110 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: Close
[0m12:45:12.947083 [debug] [Thread-1 (]: Database Error in model tactical_articles_card_month_12 (models\example\tactical_articles_card_month_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_month_12`(
      IN site INT,
      ' at line 13
  compiled Code at target\run\kasper_sindri_media\models\example\tactical_articles_card_month_12.sql
[0m12:45:12.948080 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0b9f9c8c-6d63-47ba-8cd9-f907ecc44253', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E5739FA550>]}
[0m12:45:12.949079 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.tactical_articles_card_month_12 .. [[31mERROR[0m in 2.50s]
[0m12:45:12.950914 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.tactical_articles_card_month_12
[0m12:45:12.953904 [debug] [MainThread]: Using mysql connection "master"
[0m12:45:12.954901 [debug] [MainThread]: On master: BEGIN
[0m12:45:12.954901 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m12:45:14.490764 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:45:14.493762 [debug] [MainThread]: On master: COMMIT
[0m12:45:14.497744 [debug] [MainThread]: Using mysql connection "master"
[0m12:45:14.500738 [debug] [MainThread]: On master: COMMIT
[0m12:45:15.085120 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:45:15.086120 [debug] [MainThread]: On master: Close
[0m12:45:15.088112 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:45:15.089110 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m12:45:15.090106 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m12:45:15.091103 [debug] [MainThread]: Connection 'model.kasper_sindri_media.tactical_articles_card_month_12' was properly closed.
[0m12:45:15.091103 [info ] [MainThread]: 
[0m12:45:15.093104 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 13.75 seconds (13.75s).
[0m12:45:15.094096 [debug] [MainThread]: Command end result
[0m12:45:15.109057 [info ] [MainThread]: 
[0m12:45:15.111050 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m12:45:15.112143 [info ] [MainThread]: 
[0m12:45:15.113054 [error] [MainThread]:   Database Error in model tactical_articles_card_month_12 (models\example\tactical_articles_card_month_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_month_12`(
      IN site INT,
      ' at line 13
  compiled Code at target\run\kasper_sindri_media\models\example\tactical_articles_card_month_12.sql
[0m12:45:15.115054 [info ] [MainThread]: 
[0m12:45:15.118048 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m12:45:15.124028 [debug] [MainThread]: Command `dbt run` failed at 12:45:15.124028 after 14.99 seconds
[0m12:45:15.125028 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E57356B6D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E57356B890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E57356B750>]}
[0m12:45:15.127021 [debug] [MainThread]: Flushing usage events
[0m12:45:35.209838 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000137124E7F90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000137124E7C50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013712655710>]}


============================== 12:45:35.216816 | e7479a79-0faf-417c-9ab4-4480c6f3c88c ==============================
[0m12:45:35.216816 [info ] [MainThread]: Running with dbt=1.7.17
[0m12:45:35.218812 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'version_check': 'True', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models example.tactical_articles_card_month_12', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m12:45:35.519157 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e7479a79-0faf-417c-9ab4-4480c6f3c88c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013712BB8DD0>]}
[0m12:45:35.598944 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e7479a79-0faf-417c-9ab4-4480c6f3c88c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013712A0E550>]}
[0m12:45:35.601598 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m12:45:35.614411 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m12:45:35.724486 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m12:45:35.726481 [debug] [MainThread]: Partial parsing: updated file: kasper_sindri_media://models\example\tactical_articles_card_month_12.sql
[0m12:45:35.914977 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example.run_tactical_articles_card_month_12
[0m12:45:35.924950 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e7479a79-0faf-417c-9ab4-4480c6f3c88c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013712D91AD0>]}
[0m12:45:35.952876 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e7479a79-0faf-417c-9ab4-4480c6f3c88c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013712DC7510>]}
[0m12:45:35.953873 [info ] [MainThread]: Found 11 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m12:45:35.955871 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e7479a79-0faf-417c-9ab4-4480c6f3c88c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013712CF1F50>]}
[0m12:45:35.960854 [info ] [MainThread]: 
[0m12:45:35.963846 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m12:45:35.966845 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m12:45:35.995761 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m12:45:35.996758 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m12:45:35.997756 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:45:37.544931 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m12:45:37.550948 [debug] [ThreadPool]: On list_schemas: Close
[0m12:45:37.552902 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m12:45:37.553913 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m12:45:37.560881 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:45:37.560881 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m12:45:37.561878 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:45:39.154003 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:45:39.155993 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:45:39.157986 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m12:45:39.766837 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m12:45:39.771853 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m12:45:39.772846 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:45:39.773860 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m12:45:40.371902 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:45:40.373894 [debug] [ThreadPool]: On create__site_dev: Close
[0m12:45:40.378746 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m12:45:40.386728 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m12:45:40.387743 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m12:45:40.388724 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:45:41.982400 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:45:41.985424 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m12:45:41.987426 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m12:45:42.667790 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:45:42.672784 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m12:45:42.873121 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m12:45:42.878118 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e7479a79-0faf-417c-9ab4-4480c6f3c88c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013712D90C50>]}
[0m12:45:42.880110 [debug] [MainThread]: Using mysql connection "master"
[0m12:45:42.883102 [debug] [MainThread]: On master: BEGIN
[0m12:45:42.884099 [debug] [MainThread]: Opening a new connection, currently in state init
[0m12:45:44.424391 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:45:44.427397 [debug] [MainThread]: On master: COMMIT
[0m12:45:44.429398 [debug] [MainThread]: Using mysql connection "master"
[0m12:45:44.430383 [debug] [MainThread]: On master: COMMIT
[0m12:45:45.006773 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:45:45.008773 [debug] [MainThread]: On master: Close
[0m12:45:45.010768 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m12:45:45.012662 [info ] [MainThread]: 
[0m12:45:45.022415 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.tactical_articles_card_month_12
[0m12:45:45.024411 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.tactical_articles_card_month_12 ........... [RUN]
[0m12:45:45.027526 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.kasper_sindri_media.tactical_articles_card_month_12'
[0m12:45:45.028524 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.tactical_articles_card_month_12
[0m12:45:45.045478 [debug] [Thread-1 (]: Writing injected SQL for node "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m12:45:45.048468 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.tactical_articles_card_month_12 (compile): 12:45:45.029522 => 12:45:45.047468
[0m12:45:45.049465 [debug] [Thread-1 (]: Began executing node model.kasper_sindri_media.tactical_articles_card_month_12
[0m12:45:45.095365 [debug] [Thread-1 (]: Writing runtime sql for node "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m12:45:45.097334 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m12:45:45.098338 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: BEGIN
[0m12:45:45.099330 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m12:45:46.763708 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:45:46.765699 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m12:45:46.767693 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.kasper_sindri_media.tactical_articles_card_month_12"} */

  create view `site_dev`.`tactical_articles_card_month_12__dbt_tmp`
    
    
  as (
    





CREATE PROCEDURE `prod`.`tactical_articles_card_month_12`()
BEGIN
    WITH last_30_day AS (
        SELECT siteId as siteId, COUNT(date) as value 
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND siteid = 12
        GROUP BY 1
    ),
    last_30_days_before AS (
        SELECT siteId as siteId, COUNT(*) as value  
        FROM prod.site_archive_post
        WHERE date BETWEEN 
        AND siteid = 12
        GROUP BY 1
    )
    SELECT
        JSON_OBJECT(
            'site', ld.siteId,
            'data', JSON_OBJECT(
                'label', label_val,
                'hint', hint_val,
                'value', COALESCE(ld.value, 0),
                'change', COALESCE(ROUND(((ld.value - lb.value) / lb.value) * 100, 2), 0),
                'progressCurrent', '',
                'progressTotal', ''
            )
        ) AS json_data
    FROM last_30_day ld
    LEFT JOIN last_30_days_before lb ON ld.siteId = lb.siteId;
END;
  );
[0m12:45:47.364742 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_month_12`()
BEGIN
    WITH last_' at line 13
[0m12:45:47.366736 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: ROLLBACK
[0m12:45:47.567800 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.tactical_articles_card_month_12 (execute): 12:45:45.049465 => 12:45:47.566766
[0m12:45:47.570788 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: Close
[0m12:45:47.580754 [debug] [Thread-1 (]: Database Error in model tactical_articles_card_month_12 (models\example\tactical_articles_card_month_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_month_12`()
  BEGIN
      WITH last_' at line 13
  compiled Code at target\run\kasper_sindri_media\models\example\tactical_articles_card_month_12.sql
[0m12:45:47.582747 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e7479a79-0faf-417c-9ab4-4480c6f3c88c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013712F59290>]}
[0m12:45:47.583744 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.tactical_articles_card_month_12 .. [[31mERROR[0m in 2.56s]
[0m12:45:47.585742 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.tactical_articles_card_month_12
[0m12:45:47.590729 [debug] [MainThread]: Using mysql connection "master"
[0m12:45:47.591726 [debug] [MainThread]: On master: BEGIN
[0m12:45:47.592721 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m12:45:49.157127 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:45:49.160145 [debug] [MainThread]: On master: COMMIT
[0m12:45:49.162141 [debug] [MainThread]: Using mysql connection "master"
[0m12:45:49.162141 [debug] [MainThread]: On master: COMMIT
[0m12:45:49.750354 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:45:49.753371 [debug] [MainThread]: On master: Close
[0m12:45:49.755386 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:45:49.756372 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m12:45:49.757359 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m12:45:49.758361 [debug] [MainThread]: Connection 'model.kasper_sindri_media.tactical_articles_card_month_12' was properly closed.
[0m12:45:49.758361 [info ] [MainThread]: 
[0m12:45:49.760357 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 13.80 seconds (13.80s).
[0m12:45:49.763344 [debug] [MainThread]: Command end result
[0m12:45:49.776310 [info ] [MainThread]: 
[0m12:45:49.778307 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m12:45:49.779082 [info ] [MainThread]: 
[0m12:45:49.780408 [error] [MainThread]:   Database Error in model tactical_articles_card_month_12 (models\example\tactical_articles_card_month_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_month_12`()
  BEGIN
      WITH last_' at line 13
  compiled Code at target\run\kasper_sindri_media\models\example\tactical_articles_card_month_12.sql
[0m12:45:49.782073 [info ] [MainThread]: 
[0m12:45:49.786237 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m12:45:49.790748 [debug] [MainThread]: Command `dbt run` failed at 12:45:49.789757 after 14.67 seconds
[0m12:45:49.790748 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001370BF10B10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001370BF10AD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013712BF5910>]}
[0m12:45:49.791745 [debug] [MainThread]: Flushing usage events
[0m12:46:30.759043 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B41C2B1350>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B41C305C10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B41C2B0B90>]}


============================== 12:46:30.768035 | 976c79ee-035d-41ce-802a-c516c74ac10d ==============================
[0m12:46:30.768035 [info ] [MainThread]: Running with dbt=1.7.17
[0m12:46:30.770016 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run --models example.tactical_articles_card_month_12', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m12:46:31.066988 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '976c79ee-035d-41ce-802a-c516c74ac10d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B41C4B7F10>]}
[0m12:46:31.151762 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '976c79ee-035d-41ce-802a-c516c74ac10d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B41C2C9790>]}
[0m12:46:31.153913 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m12:46:31.166830 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m12:46:31.286228 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m12:46:31.287224 [debug] [MainThread]: Partial parsing: updated file: kasper_sindri_media://models\example\tactical_articles_card_month_12.sql
[0m12:46:31.482702 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example.run_tactical_articles_card_month_12
[0m12:46:31.493674 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '976c79ee-035d-41ce-802a-c516c74ac10d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B41C307E90>]}
[0m12:46:31.515625 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '976c79ee-035d-41ce-802a-c516c74ac10d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B41C6854D0>]}
[0m12:46:31.516614 [info ] [MainThread]: Found 11 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m12:46:31.518607 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '976c79ee-035d-41ce-802a-c516c74ac10d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B41C698310>]}
[0m12:46:31.522613 [info ] [MainThread]: 
[0m12:46:31.524517 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m12:46:31.527409 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m12:46:31.545362 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m12:46:31.546361 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m12:46:31.547358 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:46:33.118636 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m12:46:33.125618 [debug] [ThreadPool]: On list_schemas: Close
[0m12:46:33.132558 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m12:46:33.135552 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m12:46:33.145524 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:46:33.146519 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m12:46:33.147517 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:46:34.705426 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:46:34.706431 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:46:34.707427 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m12:46:35.307553 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m12:46:35.311543 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m12:46:35.314533 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:46:35.316532 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m12:46:35.913308 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:46:35.914305 [debug] [ThreadPool]: On create__site_dev: Close
[0m12:46:35.920289 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m12:46:35.936245 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m12:46:35.937243 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m12:46:35.938241 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:46:37.501586 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:46:37.503607 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m12:46:37.505600 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m12:46:38.095194 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:46:38.098190 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m12:46:38.293071 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m12:46:38.295064 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '976c79ee-035d-41ce-802a-c516c74ac10d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B41C523910>]}
[0m12:46:38.296063 [debug] [MainThread]: Using mysql connection "master"
[0m12:46:38.298057 [debug] [MainThread]: On master: BEGIN
[0m12:46:38.299055 [debug] [MainThread]: Opening a new connection, currently in state init
[0m12:46:39.858401 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:46:39.861427 [debug] [MainThread]: On master: COMMIT
[0m12:46:39.863421 [debug] [MainThread]: Using mysql connection "master"
[0m12:46:39.864412 [debug] [MainThread]: On master: COMMIT
[0m12:46:40.450659 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:46:40.453681 [debug] [MainThread]: On master: Close
[0m12:46:40.457670 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m12:46:40.459662 [info ] [MainThread]: 
[0m12:46:40.476063 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.tactical_articles_card_month_12
[0m12:46:40.479083 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.tactical_articles_card_month_12 ........... [RUN]
[0m12:46:40.483967 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.kasper_sindri_media.tactical_articles_card_month_12'
[0m12:46:40.485963 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.tactical_articles_card_month_12
[0m12:46:40.512889 [debug] [Thread-1 (]: Writing injected SQL for node "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m12:46:40.514883 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.tactical_articles_card_month_12 (compile): 12:46:40.487955 => 12:46:40.513884
[0m12:46:40.515878 [debug] [Thread-1 (]: Began executing node model.kasper_sindri_media.tactical_articles_card_month_12
[0m12:46:40.562753 [debug] [Thread-1 (]: Writing runtime sql for node "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m12:46:40.564747 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m12:46:40.564747 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: BEGIN
[0m12:46:40.565750 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m12:46:42.137193 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:46:42.139192 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m12:46:42.141187 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.kasper_sindri_media.tactical_articles_card_month_12"} */

  create view `site_dev`.`tactical_articles_card_month_12__dbt_tmp`
    
    
  as (
    





CREATE PROCEDURE `prod`.`tactical_articles_card_month_12`()
BEGIN
    WITH last_30_day AS (
        SELECT siteId as siteId, COUNT(date) as value 
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND siteid = 12
        GROUP BY 1
    ),
    last_30_days_before AS (
        SELECT siteId as siteId, COUNT(*) as value  
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND siteid = 12
        GROUP BY 1
    )
    SELECT
        JSON_OBJECT(
            'site', ld.siteId,
            'data', JSON_OBJECT(
                'label', label_val,
                'hint', hint_val,
                'value', COALESCE(ld.value, 0),
                'change', COALESCE(ROUND(((ld.value - lb.value) / lb.value) * 100, 2), 0),
                'progressCurrent', '',
                'progressTotal', ''
            )
        ) AS json_data
    FROM last_30_day ld
    LEFT JOIN last_30_days_before lb ON ld.siteId = lb.siteId;
END;
  );
[0m12:46:42.732900 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_month_12`()
BEGIN
    WITH last_' at line 13
[0m12:46:42.733903 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: ROLLBACK
[0m12:46:42.939888 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.tactical_articles_card_month_12 (execute): 12:46:40.516875 => 12:46:42.937866
[0m12:46:42.942880 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: Close
[0m12:46:42.962824 [debug] [Thread-1 (]: Database Error in model tactical_articles_card_month_12 (models\example\tactical_articles_card_month_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_month_12`()
  BEGIN
      WITH last_' at line 13
  compiled Code at target\run\kasper_sindri_media\models\example\tactical_articles_card_month_12.sql
[0m12:46:42.963822 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '976c79ee-035d-41ce-802a-c516c74ac10d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B41C81FFD0>]}
[0m12:46:42.965816 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.tactical_articles_card_month_12 .. [[31mERROR[0m in 2.48s]
[0m12:46:42.966813 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.tactical_articles_card_month_12
[0m12:46:42.970802 [debug] [MainThread]: Using mysql connection "master"
[0m12:46:42.971800 [debug] [MainThread]: On master: BEGIN
[0m12:46:42.971800 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m12:46:44.553054 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:46:44.554058 [debug] [MainThread]: On master: COMMIT
[0m12:46:44.555055 [debug] [MainThread]: Using mysql connection "master"
[0m12:46:44.557049 [debug] [MainThread]: On master: COMMIT
[0m12:46:45.153725 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:46:45.155714 [debug] [MainThread]: On master: Close
[0m12:46:45.158704 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:46:45.159704 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m12:46:45.159704 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m12:46:45.160699 [debug] [MainThread]: Connection 'model.kasper_sindri_media.tactical_articles_card_month_12' was properly closed.
[0m12:46:45.161696 [info ] [MainThread]: 
[0m12:46:45.162693 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 13.64 seconds (13.64s).
[0m12:46:45.164279 [debug] [MainThread]: Command end result
[0m12:46:45.177244 [info ] [MainThread]: 
[0m12:46:45.178167 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m12:46:45.179417 [info ] [MainThread]: 
[0m12:46:45.180399 [error] [MainThread]:   Database Error in model tactical_articles_card_month_12 (models\example\tactical_articles_card_month_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_month_12`()
  BEGIN
      WITH last_' at line 13
  compiled Code at target\run\kasper_sindri_media\models\example\tactical_articles_card_month_12.sql
[0m12:46:45.181709 [info ] [MainThread]: 
[0m12:46:45.182721 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m12:46:45.185725 [debug] [MainThread]: Command `dbt run` failed at 12:46:45.185725 after 14.52 seconds
[0m12:46:45.186719 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B41C2B80D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B415740B10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B415740AD0>]}
[0m12:46:45.188726 [debug] [MainThread]: Flushing usage events
[0m12:48:38.829934 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019419DB8750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019419DBA4D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019419DB9290>]}


============================== 12:48:38.835918 | 2709fddf-9e89-408c-94c2-01f5f8b20cc5 ==============================
[0m12:48:38.835918 [info ] [MainThread]: Running with dbt=1.7.17
[0m12:48:38.837913 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models example.tactical_articles_card_month_12', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m12:48:39.189104 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2709fddf-9e89-408c-94c2-01f5f8b20cc5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019419E20DD0>]}
[0m12:48:39.274875 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2709fddf-9e89-408c-94c2-01f5f8b20cc5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019418BBCAD0>]}
[0m12:48:39.276692 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m12:48:39.293651 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m12:48:39.414799 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m12:48:39.415794 [debug] [MainThread]: Partial parsing: updated file: kasper_sindri_media://models\example\tactical_articles_card_month_12.sql
[0m12:48:39.622242 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example.run_tactical_articles_card_month_12
[0m12:48:39.631974 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2709fddf-9e89-408c-94c2-01f5f8b20cc5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001941A284150>]}
[0m12:48:39.654900 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2709fddf-9e89-408c-94c2-01f5f8b20cc5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001941A327990>]}
[0m12:48:39.655898 [info ] [MainThread]: Found 11 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m12:48:39.658894 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2709fddf-9e89-408c-94c2-01f5f8b20cc5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001941A188250>]}
[0m12:48:39.662880 [info ] [MainThread]: 
[0m12:48:39.665873 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m12:48:39.669271 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m12:48:39.686225 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m12:48:39.687239 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m12:48:39.687239 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:48:41.291938 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m12:48:41.298937 [debug] [ThreadPool]: On list_schemas: Close
[0m12:48:41.304361 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m12:48:41.307351 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m12:48:41.316326 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:48:41.317323 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m12:48:41.318322 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:48:42.917570 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:48:42.919560 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:48:42.922552 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m12:48:43.551046 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m12:48:43.557025 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m12:48:43.559017 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:48:43.562011 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m12:48:44.213573 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:48:44.216561 [debug] [ThreadPool]: On create__site_dev: Close
[0m12:48:44.227534 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m12:48:44.240493 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m12:48:44.241491 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m12:48:44.241491 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:48:45.806070 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:48:45.808073 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m12:48:45.809067 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m12:48:46.400113 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:48:46.404105 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m12:48:46.602909 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m12:48:46.623838 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2709fddf-9e89-408c-94c2-01f5f8b20cc5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019419FD8190>]}
[0m12:48:46.626830 [debug] [MainThread]: Using mysql connection "master"
[0m12:48:46.628824 [debug] [MainThread]: On master: BEGIN
[0m12:48:46.630819 [debug] [MainThread]: Opening a new connection, currently in state init
[0m12:48:48.345341 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:48:48.347331 [debug] [MainThread]: On master: COMMIT
[0m12:48:48.349320 [debug] [MainThread]: Using mysql connection "master"
[0m12:48:48.350321 [debug] [MainThread]: On master: COMMIT
[0m12:48:49.153364 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:48:49.156363 [debug] [MainThread]: On master: Close
[0m12:48:49.160351 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m12:48:49.165340 [info ] [MainThread]: 
[0m12:48:49.174669 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.tactical_articles_card_month_12
[0m12:48:49.175686 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.tactical_articles_card_month_12 ........... [RUN]
[0m12:48:49.178682 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.kasper_sindri_media.tactical_articles_card_month_12'
[0m12:48:49.180673 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.tactical_articles_card_month_12
[0m12:48:49.193638 [debug] [Thread-1 (]: Writing injected SQL for node "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m12:48:49.196631 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.tactical_articles_card_month_12 (compile): 12:48:49.181671 => 12:48:49.195637
[0m12:48:49.197632 [debug] [Thread-1 (]: Began executing node model.kasper_sindri_media.tactical_articles_card_month_12
[0m12:48:49.252483 [debug] [Thread-1 (]: Writing runtime sql for node "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m12:48:49.253480 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m12:48:49.254478 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: BEGIN
[0m12:48:49.255475 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m12:48:50.968875 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:48:50.969877 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m12:48:50.970904 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.kasper_sindri_media.tactical_articles_card_month_12"} */

  create view `site_dev`.`tactical_articles_card_month_12__dbt_tmp`
    
    
  as (
    





CREATE PROCEDURE `prod`.`tactical_articles_card_month_12`()
BEGIN
    WITH last_30_day AS (
        SELECT siteId as siteId, COUNT(date) as value 
        FROM prod.site_archive_post
        WHERE date BETWEEN 'DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)'
        AND siteid = '12'
        GROUP BY 1
    ),
    last_30_days_before AS (
        SELECT siteId as siteId, COUNT(*) as value  
        FROM prod.site_archive_post
        WHERE date BETWEEN 'DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)'
        AND siteid = '12'
        GROUP BY 1
    )
    SELECT
        JSON_OBJECT(
            'site', ld.siteId,
            'data', JSON_OBJECT(
                'label', 'Artikler',
                'hint', 'Artikler publiceret seneste 30 dage ift. forrige 30 dage',
                'value', COALESCE(ld.value, 0),
                'change', COALESCE(ROUND(((ld.value - lb.value) / lb.value) * 100, 2), 0),
                'progressCurrent', '',
                'progressTotal', ''
            )
        ) AS json_data
    FROM last_30_day ld
    LEFT JOIN last_30_days_before lb ON ld.siteId = lb.siteId;
END;
  );
[0m12:48:51.733933 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_month_12`()
BEGIN
    WITH last_' at line 13
[0m12:48:51.735935 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: ROLLBACK
[0m12:48:51.946864 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.tactical_articles_card_month_12 (execute): 12:48:49.198626 => 12:48:51.945859
[0m12:48:51.949859 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: Close
[0m12:48:51.963816 [debug] [Thread-1 (]: Database Error in model tactical_articles_card_month_12 (models\example\tactical_articles_card_month_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_month_12`()
  BEGIN
      WITH last_' at line 13
  compiled Code at target\run\kasper_sindri_media\models\example\tactical_articles_card_month_12.sql
[0m12:48:51.965812 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2709fddf-9e89-408c-94c2-01f5f8b20cc5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001941A381290>]}
[0m12:48:51.966807 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.tactical_articles_card_month_12 .. [[31mERROR[0m in 2.79s]
[0m12:48:51.968801 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.tactical_articles_card_month_12
[0m12:48:51.972579 [debug] [MainThread]: Using mysql connection "master"
[0m12:48:51.973577 [debug] [MainThread]: On master: BEGIN
[0m12:48:51.974570 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m12:48:53.935591 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:48:53.937592 [debug] [MainThread]: On master: COMMIT
[0m12:48:53.938589 [debug] [MainThread]: Using mysql connection "master"
[0m12:48:53.939586 [debug] [MainThread]: On master: COMMIT
[0m12:48:54.625366 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:48:54.629365 [debug] [MainThread]: On master: Close
[0m12:48:54.637345 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:48:54.640336 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m12:48:54.642329 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m12:48:54.644323 [debug] [MainThread]: Connection 'model.kasper_sindri_media.tactical_articles_card_month_12' was properly closed.
[0m12:48:54.645324 [info ] [MainThread]: 
[0m12:48:54.647313 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 14.98 seconds (14.98s).
[0m12:48:54.650308 [debug] [MainThread]: Command end result
[0m12:48:54.667259 [info ] [MainThread]: 
[0m12:48:54.668257 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m12:48:54.669255 [info ] [MainThread]: 
[0m12:48:54.671249 [error] [MainThread]:   Database Error in model tactical_articles_card_month_12 (models\example\tactical_articles_card_month_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_month_12`()
  BEGIN
      WITH last_' at line 13
  compiled Code at target\run\kasper_sindri_media\models\example\tactical_articles_card_month_12.sql
[0m12:48:54.673244 [info ] [MainThread]: 
[0m12:48:54.674242 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m12:48:54.677235 [debug] [MainThread]: Command `dbt run` failed at 12:48:54.676238 after 15.94 seconds
[0m12:48:54.678232 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019413230B10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019413230AD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019419DDEA10>]}
[0m12:48:54.679229 [debug] [MainThread]: Flushing usage events
[0m12:50:41.997392 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0D1031E50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0D1033CD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0D1030F90>]}


============================== 12:50:42.006367 | 93bf6341-f19d-46c7-90cb-3b183299c351 ==============================
[0m12:50:42.006367 [info ] [MainThread]: Running with dbt=1.7.17
[0m12:50:42.008362 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'debug': 'False', 'warn_error': 'None', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m12:50:42.288159 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '93bf6341-f19d-46c7-90cb-3b183299c351', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0D1030DD0>]}
[0m12:50:42.368941 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '93bf6341-f19d-46c7-90cb-3b183299c351', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0D1049210>]}
[0m12:50:42.371739 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m12:50:42.383711 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m12:50:42.485960 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m12:50:42.486957 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m12:50:42.487954 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example.run_tactical_articles_card_month_12
[0m12:50:42.496127 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '93bf6341-f19d-46c7-90cb-3b183299c351', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0D047A2D0>]}
[0m12:50:42.515078 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '93bf6341-f19d-46c7-90cb-3b183299c351', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0D133D2D0>]}
[0m12:50:42.516076 [info ] [MainThread]: Found 11 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m12:50:42.518070 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '93bf6341-f19d-46c7-90cb-3b183299c351', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0D12A2CD0>]}
[0m12:50:42.522058 [info ] [MainThread]: 
[0m12:50:42.524563 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m12:50:42.527463 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m12:50:42.542424 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m12:50:42.543422 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m12:50:42.544418 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:50:44.254504 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m12:50:44.259481 [debug] [ThreadPool]: On list_schemas: Close
[0m12:50:44.261483 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m12:50:44.262483 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m12:50:44.269465 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:50:44.270462 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m12:50:44.270462 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:50:45.996350 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:50:45.997341 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:50:45.998343 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m12:50:46.591961 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m12:50:46.595950 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m12:50:46.597942 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:50:46.598938 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m12:50:47.193685 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:50:47.195666 [debug] [ThreadPool]: On create__site_dev: Close
[0m12:50:47.207812 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m12:50:47.222772 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m12:50:47.223768 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m12:50:47.224764 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:50:48.820674 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:50:48.822664 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m12:50:48.824657 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m12:50:49.412868 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:50:49.416852 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m12:50:49.613841 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m12:50:49.617837 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '93bf6341-f19d-46c7-90cb-3b183299c351', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0D1300410>]}
[0m12:50:49.619833 [debug] [MainThread]: Using mysql connection "master"
[0m12:50:49.620828 [debug] [MainThread]: On master: BEGIN
[0m12:50:49.622825 [debug] [MainThread]: Opening a new connection, currently in state init
[0m12:50:51.155765 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:50:51.158766 [debug] [MainThread]: On master: COMMIT
[0m12:50:51.161758 [debug] [MainThread]: Using mysql connection "master"
[0m12:50:51.166744 [debug] [MainThread]: On master: COMMIT
[0m12:50:51.744797 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:50:51.748785 [debug] [MainThread]: On master: Close
[0m12:50:51.753771 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m12:50:51.756761 [info ] [MainThread]: 
[0m12:50:51.766314 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.cards
[0m12:50:51.767311 [info ] [Thread-1 (]: 1 of 11 START sql view model site_dev.cards .................................... [RUN]
[0m12:50:51.769936 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.kasper_sindri_media.cards'
[0m12:50:51.770933 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.cards
[0m12:50:51.780906 [debug] [Thread-1 (]: Writing injected SQL for node "model.kasper_sindri_media.cards"
[0m12:50:51.782902 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.cards (compile): 12:50:51.771931 => 12:50:51.781903
[0m12:50:51.783897 [debug] [Thread-1 (]: Began executing node model.kasper_sindri_media.cards
[0m12:50:51.840746 [debug] [Thread-1 (]: Writing runtime sql for node "model.kasper_sindri_media.cards"
[0m12:50:51.843739 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.cards"
[0m12:50:51.844737 [debug] [Thread-1 (]: On model.kasper_sindri_media.cards: BEGIN
[0m12:50:51.845733 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m12:50:53.431502 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:50:53.433502 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.cards"
[0m12:50:53.434498 [debug] [Thread-1 (]: On model.kasper_sindri_media.cards: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.kasper_sindri_media.cards"} */

  create view `site_dev`.`cards__dbt_tmp`
    
    
  as (
    CREATE DEFINER=`Site`@`%` PROCEDURE `tactical_articles_card_month`(
IN site INT, IN label_val VARCHAR(200), IN hint_val text
)
BEGIN
with last_30_day as
(
SELECT siteId as siteId,count(date) as value FROM prod.site_archive_post
where 
date between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and siteid =site
group by 1
),
last_30_days_before as 
(
SELECT siteId as siteId,count(*) value  FROM prod.site_archive_post
where 
date between DATE_SUB(NOW(), INTERVAL 60 DAY) and DATE_SUB(NOW(), INTERVAL 30 DAY) and siteid =site
group by 1
)
select 
JSON_OBJECT(
'site',ld.siteId,'data',
JSON_OBJECT('label', label_val, 'hint',hint_val,'value',
COALESCE(ld.value,0),
'change',COALESCE(round(((ld.value-lb.value)/lb.value)*100,2),0), 
'progressCurrent','','progressTotal',''))AS json_data
from last_30_day ld
left join last_30_days_before lb
on ld.siteId=lb.siteId
;

END
  );
[0m12:50:54.027729 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `tactical_articles_card_month`(
IN site INT' at line 7
[0m12:50:54.031715 [debug] [Thread-1 (]: On model.kasper_sindri_media.cards: ROLLBACK
[0m12:50:54.232458 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.cards (execute): 12:50:51.784895 => 12:50:54.231454
[0m12:50:54.233452 [debug] [Thread-1 (]: On model.kasper_sindri_media.cards: Close
[0m12:50:54.244423 [debug] [Thread-1 (]: Database Error in model cards (models\cards.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `tactical_articles_card_month`(
  IN site INT' at line 7
  compiled Code at target\run\kasper_sindri_media\models\cards.sql
[0m12:50:54.246426 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93bf6341-f19d-46c7-90cb-3b183299c351', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0D14D2E10>]}
[0m12:50:54.247442 [error] [Thread-1 (]: 1 of 11 ERROR creating sql view model site_dev.cards ........................... [[31mERROR[0m in 2.48s]
[0m12:50:54.249412 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.cards
[0m12:50:54.250408 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.example_by
[0m12:50:54.253144 [info ] [Thread-1 (]: 2 of 11 START sql view model site_dev.example_by ............................... [RUN]
[0m12:50:54.255294 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.kasper_sindri_media.cards, now model.kasper_sindri_media.example_by)
[0m12:50:54.256289 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.example_by
[0m12:50:54.260316 [debug] [Thread-1 (]: Writing injected SQL for node "model.kasper_sindri_media.example_by"
[0m12:50:54.262274 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.example_by (compile): 12:50:54.257287 => 12:50:54.262274
[0m12:50:54.263270 [debug] [Thread-1 (]: Began executing node model.kasper_sindri_media.example_by
[0m12:50:54.269255 [debug] [Thread-1 (]: Writing runtime sql for node "model.kasper_sindri_media.example_by"
[0m12:50:54.271249 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.example_by"
[0m12:50:54.273245 [debug] [Thread-1 (]: On model.kasper_sindri_media.example_by: BEGIN
[0m12:50:54.274241 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m12:50:55.846030 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:50:55.848026 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.example_by"
[0m12:50:55.852015 [debug] [Thread-1 (]: On model.kasper_sindri_media.example_by: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.kasper_sindri_media.example_by"} */

  create view `site_dev`.`example_by__dbt_tmp`
    
    
  as (
    -- template.sql

CREATE PROCEDURE `example_procedure`(
    IN site_id INT,
    IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = '
    SELECT *
    FROM events
    WHERE site_id = 
    AND event_action = ""';
    
    PREPARE stmt FROM @sql_query;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
END;
  );
[0m12:50:56.542383 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `example_procedure`(
    IN site_id INT,
    IN event_action VA' at line 9
[0m12:50:56.545380 [debug] [Thread-1 (]: On model.kasper_sindri_media.example_by: ROLLBACK
[0m12:50:56.751222 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.example_by (execute): 12:50:54.263270 => 12:50:56.751222
[0m12:50:56.753218 [debug] [Thread-1 (]: On model.kasper_sindri_media.example_by: Close
[0m12:50:56.761217 [debug] [Thread-1 (]: Database Error in model example_by (models\example_by.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `example_procedure`(
      IN site_id INT,
      IN event_action VA' at line 9
  compiled Code at target\run\kasper_sindri_media\models\example_by.sql
[0m12:50:56.763192 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93bf6341-f19d-46c7-90cb-3b183299c351', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0D106CE10>]}
[0m12:50:56.764189 [error] [Thread-1 (]: 2 of 11 ERROR creating sql view model site_dev.example_by ...................... [[31mERROR[0m in 2.51s]
[0m12:50:56.767181 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.example_by
[0m12:50:56.768180 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.example_by_me
[0m12:50:56.770178 [info ] [Thread-1 (]: 3 of 11 START sql view model site_dev.example_by_me ............................ [RUN]
[0m12:50:56.772168 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.kasper_sindri_media.example_by, now model.kasper_sindri_media.example_by_me)
[0m12:50:56.773168 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.example_by_me
[0m12:50:56.778154 [debug] [Thread-1 (]: Writing injected SQL for node "model.kasper_sindri_media.example_by_me"
[0m12:50:56.780148 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.example_by_me (compile): 12:50:56.774165 => 12:50:56.779148
[0m12:50:56.780148 [debug] [Thread-1 (]: Began executing node model.kasper_sindri_media.example_by_me
[0m12:50:56.789125 [debug] [Thread-1 (]: Writing runtime sql for node "model.kasper_sindri_media.example_by_me"
[0m12:50:56.790122 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.example_by_me"
[0m12:50:56.792116 [debug] [Thread-1 (]: On model.kasper_sindri_media.example_by_me: BEGIN
[0m12:50:56.793111 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m12:50:58.365069 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:50:58.368075 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.example_by_me"
[0m12:50:58.371056 [debug] [Thread-1 (]: On model.kasper_sindri_media.example_by_me: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.kasper_sindri_media.example_by_me"} */

  create view `site_dev`.`example_by_me__dbt_tmp`
    
    
  as (
    -- template.sql

CREATE PROCEDURE `example_procedure`(
    IN site_id INT,
    IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = '
    SELECT *
    FROM events
    WHERE site_id = 
    AND event_action = ""';
    
    PREPARE stmt FROM @sql_query;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
END;
  );
[0m12:50:58.965553 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `example_procedure`(
    IN site_id INT,
    IN event_action VA' at line 9
[0m12:50:58.968547 [debug] [Thread-1 (]: On model.kasper_sindri_media.example_by_me: ROLLBACK
[0m12:50:59.168750 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.example_by_me (execute): 12:50:56.781146 => 12:50:59.167753
[0m12:50:59.171740 [debug] [Thread-1 (]: On model.kasper_sindri_media.example_by_me: Close
[0m12:50:59.184703 [debug] [Thread-1 (]: Database Error in model example_by_me (models\nextClick\example_by_me.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `example_procedure`(
      IN site_id INT,
      IN event_action VA' at line 9
  compiled Code at target\run\kasper_sindri_media\models\nextClick\example_by_me.sql
[0m12:50:59.186701 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93bf6341-f19d-46c7-90cb-3b183299c351', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0D14C9490>]}
[0m12:50:59.188693 [error] [Thread-1 (]: 3 of 11 ERROR creating sql view model site_dev.example_by_me ................... [[31mERROR[0m in 2.41s]
[0m12:50:59.191230 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.example_by_me
[0m12:50:59.192226 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.overview_sales_card_12
[0m12:50:59.193224 [info ] [Thread-1 (]: 4 of 11 START sql view model site_dev.overview_sales_card_12 ................... [RUN]
[0m12:50:59.195754 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.kasper_sindri_media.example_by_me, now model.kasper_sindri_media.overview_sales_card_12)
[0m12:50:59.196751 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.overview_sales_card_12
[0m12:50:59.206775 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.overview_sales_card_12 (compile): 12:50:59.197748 => 12:50:59.205774
[0m12:50:59.210763 [debug] [Thread-1 (]: Compilation Error in model overview_sales_card_12 (models\example\overview_sales_card_12.sql)
  Required var 'json' not found in config:
  Vars supplied to overview_sales_card_12 = {
      "article_evaluation": {
          "over_both_goals": {
              "case": "((coalesce(coalesce(l.hits,0)/coalesce(l.pageviews,0)*100,0))>=coalesce(g.Min_CTA,0) and coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0) )",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          },
          "under_both_goal": {
              "case": "(coalesce((coalesce(l.hits,0)/coalesce(l.pageviews,0)*100),0)<coalesce(g.Min_CTA,0) and coalesce(l.pageviews,0)<coalesce(g.Min_pageviews,0) )",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          },
          "under_one_goal": {
              "case": "(coalesce( coalesce((coalesce(l.hits,0) / coalesce(l.pageviews,0)),0) * 100 , 0)>=coalesce(g.Min_CTA,0) or coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0)) and !((coalesce( coalesce((coalesce(l.hits,0) / coalesce(l.pageviews,0)),0) * 100 , 0))>=coalesce(g.Min_CTA,0) and  coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0) ) ",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          }
      },
      "date_month": "DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)",
      "date_week": "DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)",
      "date_year": "MAKEDATE(EXTRACT(YEAR FROM CURDATE()), 1) AND DATE_SUB(CAST(NOW() AS DATE), INTERVAL 1 DAY)",
      "event_action": "Next Click",
      "overview": {
          "overview_pageviews_card": {
              "hint": "Sidevisninger \u00e5r til dato ift sidste \u00e5r til dato og ift m\u00e5ls\u00e6tning",
              "label": "Sidevisninger"
          },
          "overview_sales_card": {
              "hint": "Gns. next click \u00e5r til dato ift. sidste \u00e5r",
              "label": "Next click (%)"
          },
          "overview_visits_card": {
              "hint": "Bes\u00f8g \u00e5r til dato ift sidste \u00e5r til dato og ift m\u00e5ls\u00e6tning",
              "label": "Bes\u00f8g"
          }
      },
      "site": 12,
      "tendency": {
          "tactical_articles_card": {
              "hint": "Artikler publiceret seneste 30 dage ift. forrige 30 dage",
              "label": "Artikler"
          },
          "tactical_clicks_card": {
              "hint": "Gns. next click p\u00e5 artikler publiceret seneste 30 dage ift. forrige 30 dage",
              "label": "Gns. next click (%)"
          },
          "tactical_pageviews_card": {
              "hint": "Gns. sidevisninger pr artikler publiceret \u00e5r til dato ift. sidste \u00e5r til dato",
              "label": "Gns. sidevisninger pr artikel"
          },
          "tactical_userneeds_pageviews_chart": {
              "dropdown_count": [
                  "",
                  "_second",
                  "_third"
              ],
              "dropdown_name": {
                  "Categories": "Categories",
                  "Tags": "Tags",
                  "userneeds": "userneeds"
              },
              "dropdown_val": {
                  "categories": [
                      "Nyheder",
                      "Debat",
                      "Inspiration",
                      "Anmeldelser"
                  ],
                  "tags": [
                      "skolepolitik",
                      "Psykisk arbejdsmilj\u00f8"
                  ],
                  "userneeds": [
                      "Opdater mig",
                      "Forbind mig",
                      "Hj\u00e6lp mig med at forst\u00e5",
                      "Giv mig en fordel",
                      "Underhold mig",
                      "Inspirer mig"
                  ]
              },
              "hint": "Artikler grupperet ift hvordan de har performet p\u00e5 next click",
              "label": "Artikler ift. next click m\u00e5l"
          }
      }
  }
[0m12:50:59.212759 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93bf6341-f19d-46c7-90cb-3b183299c351', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0D15E5010>]}
[0m12:50:59.213756 [error] [Thread-1 (]: 4 of 11 ERROR creating sql view model site_dev.overview_sales_card_12 .......... [[31mERROR[0m in 0.02s]
[0m12:50:59.214753 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.overview_sales_card_12
[0m12:50:59.215751 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.tactical_articles_card_month_12
[0m12:50:59.216748 [info ] [Thread-1 (]: 5 of 11 START sql view model site_dev.tactical_articles_card_month_12 .......... [RUN]
[0m12:50:59.219144 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.kasper_sindri_media.overview_sales_card_12, now model.kasper_sindri_media.tactical_articles_card_month_12)
[0m12:50:59.221150 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.tactical_articles_card_month_12
[0m12:50:59.227122 [debug] [Thread-1 (]: Writing injected SQL for node "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m12:50:59.229117 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.tactical_articles_card_month_12 (compile): 12:50:59.221150 => 12:50:59.228121
[0m12:50:59.229117 [debug] [Thread-1 (]: Began executing node model.kasper_sindri_media.tactical_articles_card_month_12
[0m12:50:59.236098 [debug] [Thread-1 (]: Writing runtime sql for node "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m12:50:59.238094 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m12:50:59.239089 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: BEGIN
[0m12:50:59.241085 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m12:51:00.841880 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:51:00.844862 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m12:51:00.847865 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.kasper_sindri_media.tactical_articles_card_month_12"} */

  create view `site_dev`.`tactical_articles_card_month_12__dbt_tmp`
    
    
  as (
    





CREATE PROCEDURE `prod`.`tactical_articles_card_month_12`()
BEGIN
    WITH last_30_day AS (
        SELECT siteId as siteId, COUNT(date) as value 
        FROM prod.site_archive_post
        WHERE date BETWEEN 'DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)'
        AND siteid = '12'
        GROUP BY 1
    ),
    last_30_days_before AS (
        SELECT siteId as siteId, COUNT(*) as value  
        FROM prod.site_archive_post
        WHERE date BETWEEN 'DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)'
        AND siteid = '12'
        GROUP BY 1
    )
    SELECT
        JSON_OBJECT(
            'site', ld.siteId,
            'data', JSON_OBJECT(
                'label', 'Artikler',
                'hint', 'Artikler publiceret seneste 30 dage ift. forrige 30 dage',
                'value', COALESCE(ld.value, 0),
                'change', COALESCE(ROUND(((ld.value - lb.value) / lb.value) * 100, 2), 0),
                'progressCurrent', '',
                'progressTotal', ''
            )
        ) AS json_data
    FROM last_30_day ld
    LEFT JOIN last_30_days_before lb ON ld.siteId = lb.siteId;
END;
  );
[0m12:51:01.445277 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_month_12`()
BEGIN
    WITH last_' at line 13
[0m12:51:01.448270 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: ROLLBACK
[0m12:51:01.649133 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.tactical_articles_card_month_12 (execute): 12:50:59.230114 => 12:51:01.647134
[0m12:51:01.652123 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: Close
[0m12:51:01.662094 [debug] [Thread-1 (]: Database Error in model tactical_articles_card_month_12 (models\example\tactical_articles_card_month_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_month_12`()
  BEGIN
      WITH last_' at line 13
  compiled Code at target\run\kasper_sindri_media\models\example\tactical_articles_card_month_12.sql
[0m12:51:01.664090 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93bf6341-f19d-46c7-90cb-3b183299c351', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0D14A3550>]}
[0m12:51:01.665087 [error] [Thread-1 (]: 5 of 11 ERROR creating sql view model site_dev.tactical_articles_card_month_12 . [[31mERROR[0m in 2.44s]
[0m12:51:01.667082 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.tactical_articles_card_month_12
[0m12:51:01.668079 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.tactical_articles_cards
[0m12:51:01.669076 [info ] [Thread-1 (]: 6 of 11 START sql view model site_dev.tactical_articles_cards .................. [RUN]
[0m12:51:01.671560 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.kasper_sindri_media.tactical_articles_card_month_12, now model.kasper_sindri_media.tactical_articles_cards)
[0m12:51:01.672557 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.tactical_articles_cards
[0m12:51:01.677543 [debug] [Thread-1 (]: Writing injected SQL for node "model.kasper_sindri_media.tactical_articles_cards"
[0m12:51:01.679539 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.tactical_articles_cards (compile): 12:51:01.672557 => 12:51:01.678540
[0m12:51:01.680535 [debug] [Thread-1 (]: Began executing node model.kasper_sindri_media.tactical_articles_cards
[0m12:51:01.687518 [debug] [Thread-1 (]: Writing runtime sql for node "model.kasper_sindri_media.tactical_articles_cards"
[0m12:51:01.688515 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.tactical_articles_cards"
[0m12:51:01.689520 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_cards: BEGIN
[0m12:51:01.690520 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m12:51:03.256446 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:51:03.258439 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.tactical_articles_cards"
[0m12:51:03.260413 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_cards: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.kasper_sindri_media.tactical_articles_cards"} */

  create view `site_dev`.`tactical_articles_cards__dbt_tmp`
    
    
  as (
    
  PREPARE stmt FROM @sql_query;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt;
END;
  );
[0m12:51:03.848569 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'PREPARE stmt FROM @sql_query;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt;
END;
  ' at line 8
[0m12:51:03.851559 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_cards: ROLLBACK
[0m12:51:04.049229 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.tactical_articles_cards (execute): 12:51:01.680535 => 12:51:04.048228
[0m12:51:04.052222 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_cards: Close
[0m12:51:04.065181 [debug] [Thread-1 (]: Database Error in model tactical_articles_cards (models\nextClick\tactical_articles_cards.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'PREPARE stmt FROM @sql_query;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
  END;
    ' at line 8
  compiled Code at target\run\kasper_sindri_media\models\nextClick\tactical_articles_cards.sql
[0m12:51:04.067180 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93bf6341-f19d-46c7-90cb-3b183299c351', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0D1631610>]}
[0m12:51:04.069170 [error] [Thread-1 (]: 6 of 11 ERROR creating sql view model site_dev.tactical_articles_cards ......... [[31mERROR[0m in 2.40s]
[0m12:51:04.071954 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.tactical_articles_cards
[0m12:51:04.073947 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.tactical_userneeds_pageviews_chart
[0m12:51:04.074943 [info ] [Thread-1 (]: 7 of 11 START sql view model site_dev.tactical_userneeds_pageviews_chart ....... [RUN]
[0m12:51:04.076939 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.kasper_sindri_media.tactical_articles_cards, now model.kasper_sindri_media.tactical_userneeds_pageviews_chart)
[0m12:51:04.077936 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.tactical_userneeds_pageviews_chart
[0m12:51:04.092895 [debug] [Thread-1 (]: Writing injected SQL for node "model.kasper_sindri_media.tactical_userneeds_pageviews_chart"
[0m12:51:04.094890 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.tactical_userneeds_pageviews_chart (compile): 12:51:04.078934 => 12:51:04.093892
[0m12:51:04.094890 [debug] [Thread-1 (]: Began executing node model.kasper_sindri_media.tactical_userneeds_pageviews_chart
[0m12:51:04.102869 [debug] [Thread-1 (]: Writing runtime sql for node "model.kasper_sindri_media.tactical_userneeds_pageviews_chart"
[0m12:51:04.103866 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.tactical_userneeds_pageviews_chart"
[0m12:51:04.105862 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_userneeds_pageviews_chart: BEGIN
[0m12:51:04.106860 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m12:51:05.673050 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:51:05.674052 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.tactical_userneeds_pageviews_chart"
[0m12:51:05.675051 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_userneeds_pageviews_chart: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.kasper_sindri_media.tactical_userneeds_pageviews_chart"} */

  create view `site_dev`.`tactical_userneeds_pageviews_chart__dbt_tmp`
    
    
  as (
    CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_month_11_dbt_test`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement VARCHAR(2000),
    IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
    IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
    IN event_action VARCHAR(255)
)
BEGIN
    DECLARE sql_query TEXT; -- Declare variable to hold dynamic SQL query

    -- Construct the dynamic SQL query
    SET @sql_query = CONCAT('
        WITH ')
         
    PREPARE stmt FROM @sql_query;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
END;
  );
[0m12:51:06.268888 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_' at line 7
[0m12:51:06.271879 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_userneeds_pageviews_chart: ROLLBACK
[0m12:51:06.470844 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.tactical_userneeds_pageviews_chart (execute): 12:51:04.095887 => 12:51:06.468838
[0m12:51:06.472845 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_userneeds_pageviews_chart: Close
[0m12:51:06.483805 [debug] [Thread-1 (]: Database Error in model tactical_userneeds_pageviews_chart (models\nextClick\tactical_userneeds_pageviews_chart.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_' at line 7
  compiled Code at target\run\kasper_sindri_media\models\nextClick\tactical_userneeds_pageviews_chart.sql
[0m12:51:06.484804 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93bf6341-f19d-46c7-90cb-3b183299c351', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0D12E5650>]}
[0m12:51:06.486798 [error] [Thread-1 (]: 7 of 11 ERROR creating sql view model site_dev.tactical_userneeds_pageviews_chart  [[31mERROR[0m in 2.41s]
[0m12:51:06.488792 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.tactical_userneeds_pageviews_chart
[0m12:51:06.489789 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13
[0m12:51:06.491784 [info ] [Thread-1 (]: 8 of 11 START sql view model site_dev.tactical_userneeds_pageviews_chart_month_13  [RUN]
[0m12:51:06.492785 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.kasper_sindri_media.tactical_userneeds_pageviews_chart, now model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13)
[0m12:51:06.493780 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13
[0m12:51:06.517714 [debug] [Thread-1 (]: Writing injected SQL for node "model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13"
[0m12:51:06.519710 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13 (compile): 12:51:06.494779 => 12:51:06.518712
[0m12:51:06.520706 [debug] [Thread-1 (]: Began executing node model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13
[0m12:51:06.526691 [debug] [Thread-1 (]: Writing runtime sql for node "model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13"
[0m12:51:06.529688 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13"
[0m12:51:06.530681 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13: BEGIN
[0m12:51:06.532677 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m12:51:08.091887 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:51:08.092886 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13"
[0m12:51:08.093882 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13"} */

  create view `site_dev`.`tactical_userneeds_pageviews_chart_month_13__dbt_tmp`
    
    
  as (
    CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_month_13_dbt_test`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    

    SELECT 
		CONCAT(
        ''{'',
            ''"site":'',jd.siteid,'','',
            ''"data": {'',
                ''"label": "'', jd.lab, ''",'',
                ''"categories": ['', jd.cat, ''],'',
                ''"series": ['', jd.series, '']'',
                '',"defaultTitle":"',dtitle,'"'',
                '',"additional":[ ''
                
        '']}}''
    
			) as json_data
		  FROM json_data jd
          ;
  );
[0m12:51:08.685584 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_' at line 7
[0m12:51:08.686582 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13: ROLLBACK
[0m12:51:08.882060 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13 (execute): 12:51:06.521704 => 12:51:08.881065
[0m12:51:08.884058 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13: Close
[0m12:51:08.891034 [debug] [Thread-1 (]: Database Error in model tactical_userneeds_pageviews_chart_month_13 (models\nextClick\tactical_userneeds_pageviews_chart_month_13.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_' at line 7
  compiled Code at target\run\kasper_sindri_media\models\nextClick\tactical_userneeds_pageviews_chart_month_13.sql
[0m12:51:08.892032 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93bf6341-f19d-46c7-90cb-3b183299c351', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0D1658750>]}
[0m12:51:08.893029 [error] [Thread-1 (]: 8 of 11 ERROR creating sql view model site_dev.tactical_userneeds_pageviews_chart_month_13  [[31mERROR[0m in 2.40s]
[0m12:51:08.895033 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13
[0m12:51:08.896023 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13.sql_output
[0m12:51:08.897019 [info ] [Thread-1 (]: 9 of 11 START sql view model site_dev.tactical_userneeds_pageviews_chart_month_13.sql_output  [RUN]
[0m12:51:08.898018 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13, now model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13.sql_output)
[0m12:51:08.899016 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13.sql_output
[0m12:51:08.912975 [debug] [Thread-1 (]: Writing injected SQL for node "model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13.sql_output"
[0m12:51:08.914970 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13.sql_output (compile): 12:51:08.900013 => 12:51:08.913973
[0m12:51:08.916965 [debug] [Thread-1 (]: Began executing node model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13.sql_output
[0m12:51:08.927936 [debug] [Thread-1 (]: Writing runtime sql for node "model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13.sql_output"
[0m12:51:08.930928 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13.sql_output"
[0m12:51:08.931927 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13.sql_output: BEGIN
[0m12:51:08.933925 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m12:51:10.461496 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:51:10.463495 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13.sql_output"
[0m12:51:10.470470 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13.sql_output: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13.sql_output"} */

  create view `site_dev`.`tactical_userneeds_pageviews_chart_month_13.sql_output__dbt_tmp`
    
    
  as (
    CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_month_13_dbt_test`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN userneeds like "%Opdater mig%" then "Opdater mig"
			    WHEN userneeds like "%Forbind mig%" then "Forbind mig"
			    WHEN userneeds like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
			    WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
			    WHEN userneeds like "%Underhold mig%" then "Underhold mig"
			    WHEN userneeds like "%Inspirer mig%" then "Inspirer mig"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN MAKEDATE(EXTRACT(YEAR FROM CURDATE()), 1) AND DATE_SUB(CURDATE(), INTERVAL 1 DAY) AND 12),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = 12
		group by 1,2
    ),
    agg_next_click_per_article as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = Next Click
		where    e.siteid = 12  
		group by 1,2,3
		),
        cta_per_article as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article  e
			where  e.siteid = 12
			group by 1,2,3

		),
        agg_cta_per_article as(
		select siteid as siteid,tags,sum(val) as agg_sum from
        cta_per_article
		where siteid = 12
		group by 1,2
		),
        less_tg_data as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date BETWEEN MAKEDATE(EXTRACT(YEAR FROM CURDATE()), 1) AND DATE_SUB(CURDATE(), INTERVAL 1 DAY) and g.site_id = 12
		),
        counts as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data
			group by 1,2
		),
        hits_by_tags as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data
		   where siteid = 12
		   group by 1,2)
           ,
           total_hits as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts
			where  siteid = 12
			group by 1)
            ,
            agg_data as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts h
			join total_hits t on h.siteid=t.siteid
			join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = 12
		),
        categories_d as (
			select 
				siteid as siteid ,
				 label data value as label,
                hint data value as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',['Opdater mig', 'Forbind mig', 'Hjælp mig med at forstå', 'Giv mig en fordel', 'Underhold mig', 'Inspirer mig'],', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',['Opdater mig', 'Forbind mig', 'Hjælp mig med at forstå', 'Giv mig en fordel', 'Underhold mig', 'Inspirer mig'],', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',['Opdater mig', 'Forbind mig', 'Hjælp mig med at forstå', 'Giv mig en fordel', 'Underhold mig', 'Inspirer mig'],', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',['Opdater mig', 'Forbind mig', 'Hjælp mig med at forstå', 'Giv mig en fordel', 'Underhold mig', 'Inspirer mig'],', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data
		group by 1,2,3
		),
        categories as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d
		),
        json_data as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories
		), 
    
    last_30_days_article_published_second as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Categories like "%Nyheder%" then "Nyheder"
			    WHEN Categories like "%Debat%" then "Debat"
			    WHEN Categories like "%Inspiration%" then "Inspiration"
			    WHEN Categories like "%Anmeldelser%" then "Anmeldelser"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date between MAKEDATE(EXTRACT(YEAR FROM CURDATE()),1)  and  DATE_SUB(cast(NOW() as date), INTERVAL 1 DAY) AND 12),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = 12
		group by 1,2
    ),
    agg_next_click_per_article_second as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_second  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = Next Click
		where    e.siteid = 12  
		group by 1,2,3
		),
        cta_per_article_second as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_second  e
			where  e.siteid = 12
			group by 1,2,3

		),
        agg_cta_per_article_second as(
		select siteid as siteid,tags,sum(val) as agg_sum from
        cta_per_article_second
		where siteid = 12
		group by 1,2
		),
        less_tg_data_second as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_second l
		join cta_per_article_second a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date between MAKEDATE(EXTRACT(YEAR FROM CURDATE()),1)  and  DATE_SUB(cast(NOW() as date), INTERVAL 1 DAY) and g.site_id = 12
		),
        counts_second as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_second
			group by 1,2
		),
        hits_by_tags_second as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_second
		   where siteid = 12
		   group by 1,2)
           ,
           total_hits_second as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_second
			where  siteid = 12
			group by 1)
            ,
            agg_data_second as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_second h
			join total_hits_second t on h.siteid=t.siteid
			join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = 12
		),
        categories_d_second as (
			select 
				siteid as siteid ,
				 label data value as label,
                hint data value as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',['Nyheder', 'Debat', 'Inspiration', 'Anmeldelser'],', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',['Nyheder', 'Debat', 'Inspiration', 'Anmeldelser'],', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',['Nyheder', 'Debat', 'Inspiration', 'Anmeldelser'],', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',['Nyheder', 'Debat', 'Inspiration', 'Anmeldelser'],', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_second
		group by 1,2,3
		),
        categories_second as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_second
		),
        json_data_second as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_second
		), 
    
    last_30_days_article_published_third as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Tags like "%skolepolitik%" then "skolepolitik"
			    WHEN Tags like "%Psykisk arbejdsmiljø%" then "Psykisk arbejdsmiljø"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE  AND 12),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = 12
		group by 1,2
    ),
    agg_next_click_per_article_third as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_third  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = Next Click
		where    e.siteid = 12  
		group by 1,2,3
		),
        cta_per_article_third as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_third  e
			where  e.siteid = 12
			group by 1,2,3

		),
        agg_cta_per_article_third as(
		select siteid as siteid,tags,sum(val) as agg_sum from
        cta_per_article_third
		where siteid = 12
		group by 1,2
		),
        less_tg_data_third as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_third l
		join cta_per_article_third a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where  and g.site_id = 12
		),
        counts_third as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_third
			group by 1,2
		),
        hits_by_tags_third as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_third
		   where siteid = 12
		   group by 1,2)
           ,
           total_hits_third as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_third
			where  siteid = 12
			group by 1)
            ,
            agg_data_third as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_third h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = 12
		),
        categories_d_third as (
			select 
				siteid as siteid ,
				 label data value as label,
                hint data value as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',['skolepolitik', 'Psykisk arbejdsmiljø'],', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',['skolepolitik', 'Psykisk arbejdsmiljø'],', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',['skolepolitik', 'Psykisk arbejdsmiljø'],', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',['skolepolitik', 'Psykisk arbejdsmiljø'],', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_third
		group by 1,2,3
		),
        categories_third as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_third
		),
        json_data_third as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_third
		)
    

    SELECT 
		CONCAT(
        ''{'',
            ''"site":'',jd.siteid,'','',
            ''"data": {'',
                ''"label": "'', jd.lab, ''",'',
                ''"categories": ['', jd.cat, ''],'',
                ''"series": ['', jd.series, '']'',
                '',"defaultTitle":"',dtitle,'"'',
                '',"additional":[ ''
                
                ,''{'',
                ''"title":"',title1,'",'',
                ''"data": {'',
                ''"label": "'',json_data_second.lab, ''",'',
                ''"categories": ['', json_data_second.cat, ''],'',
                ''"series": ['', json_data_second.series, '']'',
                ''}}''
                
                , '',''
                
                
                ,''{'',
                ''"title":"',title2,'",'',
                ''"data": {'',
                ''"label": "'',json_data_third.lab, ''",'',
                ''"categories": ['', json_data_third.cat, ''],'',
                ''"series": ['', json_data_third.series, '']'',
                ''}}''
                
                
        '']}}''
    
			) as json_data
		  FROM json_data jd
          
          CROSS join json_data_second
          
          CROSS join json_data_third
          ;
  );
[0m12:51:11.256169 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_' at line 7
[0m12:51:11.257168 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13.sql_output: ROLLBACK
[0m12:51:11.449490 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13.sql_output (execute): 12:51:08.917963 => 12:51:11.448492
[0m12:51:11.451485 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13.sql_output: Close
[0m12:51:11.460460 [debug] [Thread-1 (]: Database Error in model tactical_userneeds_pageviews_chart_month_13.sql_output (models\nextClick\tactical_userneeds_pageviews_chart_month_13.sql_output.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_' at line 7
  compiled Code at target\run\kasper_sindri_media\models\nextClick\tactical_userneeds_pageviews_chart_month_13.sql_output.sql
[0m12:51:11.461457 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93bf6341-f19d-46c7-90cb-3b183299c351', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0D1653810>]}
[0m12:51:11.463452 [error] [Thread-1 (]: 9 of 11 ERROR creating sql view model site_dev.tactical_userneeds_pageviews_chart_month_13.sql_output  [[31mERROR[0m in 2.56s]
[0m12:51:11.465447 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13.sql_output
[0m12:51:11.467442 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.test
[0m12:51:11.468439 [info ] [Thread-1 (]: 10 of 11 START sql view model site_dev.test .................................... [RUN]
[0m12:51:11.470434 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.kasper_sindri_media.tactical_userneeds_pageviews_chart_month_13.sql_output, now model.kasper_sindri_media.test)
[0m12:51:11.472429 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.test
[0m12:51:11.510327 [debug] [Thread-1 (]: Writing injected SQL for node "model.kasper_sindri_media.test"
[0m12:51:11.512322 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.test (compile): 12:51:11.473426 => 12:51:11.512322
[0m12:51:11.514317 [debug] [Thread-1 (]: Began executing node model.kasper_sindri_media.test
[0m12:51:11.523294 [debug] [Thread-1 (]: Writing runtime sql for node "model.kasper_sindri_media.test"
[0m12:51:11.525287 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.test"
[0m12:51:11.526285 [debug] [Thread-1 (]: On model.kasper_sindri_media.test: BEGIN
[0m12:51:11.527281 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m12:51:13.091204 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:51:13.093223 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.test"
[0m12:51:13.096218 [debug] [Thread-1 (]: On model.kasper_sindri_media.test: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.kasper_sindri_media.test"} */

  create view `site_dev`.`test__dbt_tmp`
    
    
  as (
    CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_month_13_dbt_test`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    

    SELECT 
		CONCAT(
        ''{'',
            ''"site":'',jd.siteid,'','',
            ''"data": {'',
                ''"label": "'', jd.lab, ''",'',
                ''"categories": ['', jd.cat, ''],'',
                ''"series": ['', jd.series, '']'',
                '',"defaultTitle":"',dtitle,'"'',
                '',"additional":[ ''
                
        '']}}''
    
			) as json_data
		  FROM json_data jd
          ;
  );
[0m12:51:13.686518 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_' at line 7
[0m12:51:13.688515 [debug] [Thread-1 (]: On model.kasper_sindri_media.test: ROLLBACK
[0m12:51:13.893378 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.test (execute): 12:51:11.515314 => 12:51:13.891376
[0m12:51:13.896378 [debug] [Thread-1 (]: On model.kasper_sindri_media.test: Close
[0m12:51:13.903350 [debug] [Thread-1 (]: Database Error in model test (models\test.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_' at line 7
  compiled Code at target\run\kasper_sindri_media\models\test.sql
[0m12:51:13.904349 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93bf6341-f19d-46c7-90cb-3b183299c351', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0D1216A90>]}
[0m12:51:13.906347 [error] [Thread-1 (]: 10 of 11 ERROR creating sql view model site_dev.test ........................... [[31mERROR[0m in 2.43s]
[0m12:51:13.908337 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.test
[0m12:51:13.909334 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.test_by
[0m12:51:13.910330 [info ] [Thread-1 (]: 11 of 11 START sql view model site_dev.test_by ................................. [RUN]
[0m12:51:13.912197 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.kasper_sindri_media.test, now model.kasper_sindri_media.test_by)
[0m12:51:13.912197 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.test_by
[0m12:51:13.931147 [debug] [Thread-1 (]: Writing injected SQL for node "model.kasper_sindri_media.test_by"
[0m12:51:13.933141 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.test_by (compile): 12:51:13.913195 => 12:51:13.932144
[0m12:51:13.934138 [debug] [Thread-1 (]: Began executing node model.kasper_sindri_media.test_by
[0m12:51:13.940122 [debug] [Thread-1 (]: Writing runtime sql for node "model.kasper_sindri_media.test_by"
[0m12:51:13.942117 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.test_by"
[0m12:51:13.943115 [debug] [Thread-1 (]: On model.kasper_sindri_media.test_by: BEGIN
[0m12:51:13.945114 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m12:51:15.538154 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:51:15.539155 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.test_by"
[0m12:51:15.540153 [debug] [Thread-1 (]: On model.kasper_sindri_media.test_by: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.kasper_sindri_media.test_by"} */

  create view `site_dev`.`test_by__dbt_tmp`
    
    
  as (
    CREATE DEFINER=`Site`@`%` PROCEDURE `tactical_category_pageviews_chart_month_13`(
	IN site INT,
  IN label_val VARCHAR(200),
  IN hint_val text,
  IN order_statement_first  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
  IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
  IN title1 VARCHAR(200),
  IN title2 VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    

    SELECT 
		CONCAT(
        ''{'',
            ''"site":'',jd.siteid,'','',
            ''"data": {'',
                ''"label": "'', jd.lab, ''",'',
                ''"categories": ['', jd.cat, ''],'',
                ''"series": ['', jd.series, '']'',
                '',"defaultTitle":"',,'"'',
                '',"additional":[ ''
                
        '']}}''
    
			) as json_data
		  FROM json_data jd
          ;
  );
[0m12:51:16.137012 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `tactical_category_pageviews_chart_month_13`' at line 7
[0m12:51:16.139003 [debug] [Thread-1 (]: On model.kasper_sindri_media.test_by: ROLLBACK
[0m12:51:16.339880 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.test_by (execute): 12:51:13.934138 => 12:51:16.338868
[0m12:51:16.340867 [debug] [Thread-1 (]: On model.kasper_sindri_media.test_by: Close
[0m12:51:16.349846 [debug] [Thread-1 (]: Database Error in model test_by (models\nextClick\test_by.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `tactical_category_pageviews_chart_month_13`' at line 7
  compiled Code at target\run\kasper_sindri_media\models\nextClick\test_by.sql
[0m12:51:16.351840 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93bf6341-f19d-46c7-90cb-3b183299c351', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0D165C650>]}
[0m12:51:16.353833 [error] [Thread-1 (]: 11 of 11 ERROR creating sql view model site_dev.test_by ........................ [[31mERROR[0m in 2.44s]
[0m12:51:16.356827 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.test_by
[0m12:51:16.360814 [debug] [MainThread]: Using mysql connection "master"
[0m12:51:16.361813 [debug] [MainThread]: On master: BEGIN
[0m12:51:16.362808 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m12:51:17.899309 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:51:17.900310 [debug] [MainThread]: On master: COMMIT
[0m12:51:17.901311 [debug] [MainThread]: Using mysql connection "master"
[0m12:51:17.902304 [debug] [MainThread]: On master: COMMIT
[0m12:51:18.543649 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:51:18.545659 [debug] [MainThread]: On master: Close
[0m12:51:18.549641 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:51:18.549641 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m12:51:18.550637 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m12:51:18.551633 [debug] [MainThread]: Connection 'model.kasper_sindri_media.test_by' was properly closed.
[0m12:51:18.552631 [info ] [MainThread]: 
[0m12:51:18.553632 [info ] [MainThread]: Finished running 11 view models in 0 hours 0 minutes and 36.03 seconds (36.03s).
[0m12:51:18.557617 [debug] [MainThread]: Command end result
[0m12:51:18.571579 [info ] [MainThread]: 
[0m12:51:18.573159 [info ] [MainThread]: [31mCompleted with 11 errors and 0 warnings:[0m
[0m12:51:18.574307 [info ] [MainThread]: 
[0m12:51:18.575288 [error] [MainThread]:   Database Error in model cards (models\cards.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `tactical_articles_card_month`(
  IN site INT' at line 7
  compiled Code at target\run\kasper_sindri_media\models\cards.sql
[0m12:51:18.576296 [info ] [MainThread]: 
[0m12:51:18.577832 [error] [MainThread]:   Database Error in model example_by (models\example_by.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `example_procedure`(
      IN site_id INT,
      IN event_action VA' at line 9
  compiled Code at target\run\kasper_sindri_media\models\example_by.sql
[0m12:51:18.579604 [info ] [MainThread]: 
[0m12:51:18.581602 [error] [MainThread]:   Database Error in model example_by_me (models\nextClick\example_by_me.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `example_procedure`(
      IN site_id INT,
      IN event_action VA' at line 9
  compiled Code at target\run\kasper_sindri_media\models\nextClick\example_by_me.sql
[0m12:51:18.582600 [info ] [MainThread]: 
[0m12:51:18.584596 [error] [MainThread]:   Compilation Error in model overview_sales_card_12 (models\example\overview_sales_card_12.sql)
  Required var 'json' not found in config:
  Vars supplied to overview_sales_card_12 = {
      "article_evaluation": {
          "over_both_goals": {
              "case": "((coalesce(coalesce(l.hits,0)/coalesce(l.pageviews,0)*100,0))>=coalesce(g.Min_CTA,0) and coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0) )",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          },
          "under_both_goal": {
              "case": "(coalesce((coalesce(l.hits,0)/coalesce(l.pageviews,0)*100),0)<coalesce(g.Min_CTA,0) and coalesce(l.pageviews,0)<coalesce(g.Min_pageviews,0) )",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          },
          "under_one_goal": {
              "case": "(coalesce( coalesce((coalesce(l.hits,0) / coalesce(l.pageviews,0)),0) * 100 , 0)>=coalesce(g.Min_CTA,0) or coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0)) and !((coalesce( coalesce((coalesce(l.hits,0) / coalesce(l.pageviews,0)),0) * 100 , 0))>=coalesce(g.Min_CTA,0) and  coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0) ) ",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          }
      },
      "date_month": "DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)",
      "date_week": "DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)",
      "date_year": "MAKEDATE(EXTRACT(YEAR FROM CURDATE()), 1) AND DATE_SUB(CAST(NOW() AS DATE), INTERVAL 1 DAY)",
      "event_action": "Next Click",
      "overview": {
          "overview_pageviews_card": {
              "hint": "Sidevisninger \u00e5r til dato ift sidste \u00e5r til dato og ift m\u00e5ls\u00e6tning",
              "label": "Sidevisninger"
          },
          "overview_sales_card": {
              "hint": "Gns. next click \u00e5r til dato ift. sidste \u00e5r",
              "label": "Next click (%)"
          },
          "overview_visits_card": {
              "hint": "Bes\u00f8g \u00e5r til dato ift sidste \u00e5r til dato og ift m\u00e5ls\u00e6tning",
              "label": "Bes\u00f8g"
          }
      },
      "site": 12,
      "tendency": {
          "tactical_articles_card": {
              "hint": "Artikler publiceret seneste 30 dage ift. forrige 30 dage",
              "label": "Artikler"
          },
          "tactical_clicks_card": {
              "hint": "Gns. next click p\u00e5 artikler publiceret seneste 30 dage ift. forrige 30 dage",
              "label": "Gns. next click (%)"
          },
          "tactical_pageviews_card": {
              "hint": "Gns. sidevisninger pr artikler publiceret \u00e5r til dato ift. sidste \u00e5r til dato",
              "label": "Gns. sidevisninger pr artikel"
          },
          "tactical_userneeds_pageviews_chart": {
              "dropdown_count": [
                  "",
                  "_second",
                  "_third"
              ],
              "dropdown_name": {
                  "Categories": "Categories",
                  "Tags": "Tags",
                  "userneeds": "userneeds"
              },
              "dropdown_val": {
                  "categories": [
                      "Nyheder",
                      "Debat",
                      "Inspiration",
                      "Anmeldelser"
                  ],
                  "tags": [
                      "skolepolitik",
                      "Psykisk arbejdsmilj\u00f8"
                  ],
                  "userneeds": [
                      "Opdater mig",
                      "Forbind mig",
                      "Hj\u00e6lp mig med at forst\u00e5",
                      "Giv mig en fordel",
                      "Underhold mig",
                      "Inspirer mig"
                  ]
              },
              "hint": "Artikler grupperet ift hvordan de har performet p\u00e5 next click",
              "label": "Artikler ift. next click m\u00e5l"
          }
      }
  }
[0m12:51:18.591683 [info ] [MainThread]: 
[0m12:51:18.592675 [error] [MainThread]:   Database Error in model tactical_articles_card_month_12 (models\example\tactical_articles_card_month_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_month_12`()
  BEGIN
      WITH last_' at line 13
  compiled Code at target\run\kasper_sindri_media\models\example\tactical_articles_card_month_12.sql
[0m12:51:18.595047 [info ] [MainThread]: 
[0m12:51:18.596537 [error] [MainThread]:   Database Error in model tactical_articles_cards (models\nextClick\tactical_articles_cards.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'PREPARE stmt FROM @sql_query;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
  END;
    ' at line 8
  compiled Code at target\run\kasper_sindri_media\models\nextClick\tactical_articles_cards.sql
[0m12:51:18.597431 [info ] [MainThread]: 
[0m12:51:18.599431 [error] [MainThread]:   Database Error in model tactical_userneeds_pageviews_chart (models\nextClick\tactical_userneeds_pageviews_chart.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_' at line 7
  compiled Code at target\run\kasper_sindri_media\models\nextClick\tactical_userneeds_pageviews_chart.sql
[0m12:51:18.601425 [info ] [MainThread]: 
[0m12:51:18.607407 [error] [MainThread]:   Database Error in model tactical_userneeds_pageviews_chart_month_13 (models\nextClick\tactical_userneeds_pageviews_chart_month_13.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_' at line 7
  compiled Code at target\run\kasper_sindri_media\models\nextClick\tactical_userneeds_pageviews_chart_month_13.sql
[0m12:51:18.610130 [info ] [MainThread]: 
[0m12:51:18.611126 [error] [MainThread]:   Database Error in model tactical_userneeds_pageviews_chart_month_13.sql_output (models\nextClick\tactical_userneeds_pageviews_chart_month_13.sql_output.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_' at line 7
  compiled Code at target\run\kasper_sindri_media\models\nextClick\tactical_userneeds_pageviews_chart_month_13.sql_output.sql
[0m12:51:18.612358 [info ] [MainThread]: 
[0m12:51:18.613834 [error] [MainThread]:   Database Error in model test (models\test.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_' at line 7
  compiled Code at target\run\kasper_sindri_media\models\test.sql
[0m12:51:18.615467 [info ] [MainThread]: 
[0m12:51:18.618465 [error] [MainThread]:   Database Error in model test_by (models\nextClick\test_by.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `tactical_category_pageviews_chart_month_13`' at line 7
  compiled Code at target\run\kasper_sindri_media\models\nextClick\test_by.sql
[0m12:51:18.621454 [info ] [MainThread]: 
[0m12:51:18.623899 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=11 SKIP=0 TOTAL=11
[0m12:51:18.626894 [debug] [MainThread]: Command `dbt run` failed at 12:51:18.626894 after 36.72 seconds
[0m12:51:18.627907 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0D108B8D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0D108B790>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0D108B610>]}
[0m12:51:18.628889 [debug] [MainThread]: Flushing usage events
[0m12:51:27.880207 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028A5EE60310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028A5EE95E90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028A5EE95D50>]}


============================== 12:51:27.887191 | ca3452e4-ee9b-47b0-a4fc-77731b837328 ==============================
[0m12:51:27.887191 [info ] [MainThread]: Running with dbt=1.7.17
[0m12:51:27.888186 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'version_check': 'True', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --models example.tactical_articles_card_month_12', 'send_anonymous_usage_stats': 'True'}
[0m12:51:28.152661 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ca3452e4-ee9b-47b0-a4fc-77731b837328', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028A5F045D90>]}
[0m12:51:28.233446 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ca3452e4-ee9b-47b0-a4fc-77731b837328', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028A5F0882D0>]}
[0m12:51:28.235453 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m12:51:28.248418 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m12:51:28.338177 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m12:51:28.339175 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m12:51:28.341171 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example.run_tactical_articles_card_month_12
[0m12:51:28.350146 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ca3452e4-ee9b-47b0-a4fc-77731b837328', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028A5F21C250>]}
[0m12:51:28.370093 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ca3452e4-ee9b-47b0-a4fc-77731b837328', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028A5F1501D0>]}
[0m12:51:28.371115 [info ] [MainThread]: Found 11 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m12:51:28.373087 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ca3452e4-ee9b-47b0-a4fc-77731b837328', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028A5F0F1B90>]}
[0m12:51:28.377076 [info ] [MainThread]: 
[0m12:51:28.380071 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m12:51:28.383264 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m12:51:28.400219 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m12:51:28.400219 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m12:51:28.401217 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:51:30.038698 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m12:51:30.043671 [debug] [ThreadPool]: On list_schemas: Close
[0m12:51:30.045667 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m12:51:30.046665 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m12:51:30.053645 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:51:30.054643 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m12:51:30.055641 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:51:31.736361 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:51:31.738365 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:51:31.740370 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m12:51:32.341952 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m12:51:32.344948 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m12:51:32.345947 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:51:32.346945 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m12:51:32.946607 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:51:32.948599 [debug] [ThreadPool]: On create__site_dev: Close
[0m12:51:32.954206 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m12:51:32.962188 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m12:51:32.963186 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m12:51:32.963186 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:51:34.514981 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:51:34.517987 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m12:51:34.519986 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m12:51:35.105482 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:51:35.110462 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m12:51:35.306643 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m12:51:35.311166 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ca3452e4-ee9b-47b0-a4fc-77731b837328', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028A5F025310>]}
[0m12:51:35.314169 [debug] [MainThread]: Using mysql connection "master"
[0m12:51:35.316159 [debug] [MainThread]: On master: BEGIN
[0m12:51:35.318161 [debug] [MainThread]: Opening a new connection, currently in state init
[0m12:51:36.920743 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:51:36.923743 [debug] [MainThread]: On master: COMMIT
[0m12:51:36.924741 [debug] [MainThread]: Using mysql connection "master"
[0m12:51:36.925806 [debug] [MainThread]: On master: COMMIT
[0m12:51:37.542906 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:51:37.544932 [debug] [MainThread]: On master: Close
[0m12:51:37.547921 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m12:51:37.549914 [info ] [MainThread]: 
[0m12:51:37.557421 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.tactical_articles_card_month_12
[0m12:51:37.558421 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.tactical_articles_card_month_12 ........... [RUN]
[0m12:51:37.560165 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.kasper_sindri_media.tactical_articles_card_month_12'
[0m12:51:37.561162 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.tactical_articles_card_month_12
[0m12:51:37.576119 [debug] [Thread-1 (]: Writing injected SQL for node "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m12:51:37.578115 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.tactical_articles_card_month_12 (compile): 12:51:37.562159 => 12:51:37.577116
[0m12:51:37.579113 [debug] [Thread-1 (]: Began executing node model.kasper_sindri_media.tactical_articles_card_month_12
[0m12:51:37.624989 [debug] [Thread-1 (]: Writing runtime sql for node "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m12:51:37.626985 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m12:51:37.628008 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: BEGIN
[0m12:51:37.628008 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m12:51:39.165671 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:51:39.167663 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m12:51:39.169659 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.kasper_sindri_media.tactical_articles_card_month_12"} */

  create view `site_dev`.`tactical_articles_card_month_12__dbt_tmp`
    
    
  as (
    





CREATE PROCEDURE `prod`.`tactical_articles_card_month_12`()
BEGIN
    WITH last_30_day AS (
        SELECT siteId as siteId, COUNT(date) as value 
        FROM prod.site_archive_post
        WHERE date BETWEEN 'DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)'
        AND siteid = '12'
        GROUP BY 1
    ),
    last_30_days_before AS (
        SELECT siteId as siteId, COUNT(*) as value  
        FROM prod.site_archive_post
        WHERE date BETWEEN 'DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)'
        AND siteid = '12'
        GROUP BY 1
    )
    SELECT
        JSON_OBJECT(
            'site', ld.siteId,
            'data', JSON_OBJECT(
                'label', 'Artikler',
                'hint', 'Artikler publiceret seneste 30 dage ift. forrige 30 dage',
                'value', COALESCE(ld.value, 0),
                'change', COALESCE(ROUND(((ld.value - lb.value) / lb.value) * 100, 2), 0),
                'progressCurrent', '',
                'progressTotal', ''
            )
        ) AS json_data
    FROM last_30_day ld
    LEFT JOIN last_30_days_before lb ON ld.siteId = lb.siteId;
END;
  );
[0m12:51:39.745080 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_month_12`()
BEGIN
    WITH last_' at line 13
[0m12:51:39.748069 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: ROLLBACK
[0m12:51:39.941787 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.tactical_articles_card_month_12 (execute): 12:51:37.580110 => 12:51:39.940777
[0m12:51:39.944777 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: Close
[0m12:51:39.967713 [debug] [Thread-1 (]: Database Error in model tactical_articles_card_month_12 (models\example\tactical_articles_card_month_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_month_12`()
  BEGIN
      WITH last_' at line 13
  compiled Code at target\run\kasper_sindri_media\models\example\tactical_articles_card_month_12.sql
[0m12:51:39.969709 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ca3452e4-ee9b-47b0-a4fc-77731b837328', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028A5F0F6850>]}
[0m12:51:39.971705 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.tactical_articles_card_month_12 .. [[31mERROR[0m in 2.41s]
[0m12:51:39.974692 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.tactical_articles_card_month_12
[0m12:51:39.979681 [debug] [MainThread]: Using mysql connection "master"
[0m12:51:39.980679 [debug] [MainThread]: On master: BEGIN
[0m12:51:39.981678 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m12:51:41.553373 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:51:41.555399 [debug] [MainThread]: On master: COMMIT
[0m12:51:41.557395 [debug] [MainThread]: Using mysql connection "master"
[0m12:51:41.559398 [debug] [MainThread]: On master: COMMIT
[0m12:51:42.164200 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:51:42.166211 [debug] [MainThread]: On master: Close
[0m12:51:42.170193 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:51:42.172185 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m12:51:42.174198 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m12:51:42.176183 [debug] [MainThread]: Connection 'model.kasper_sindri_media.tactical_articles_card_month_12' was properly closed.
[0m12:51:42.178178 [info ] [MainThread]: 
[0m12:51:42.181170 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 13.80 seconds (13.80s).
[0m12:51:42.186489 [debug] [MainThread]: Command end result
[0m12:51:42.201441 [info ] [MainThread]: 
[0m12:51:42.203439 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m12:51:42.205443 [info ] [MainThread]: 
[0m12:51:42.207428 [error] [MainThread]:   Database Error in model tactical_articles_card_month_12 (models\example\tactical_articles_card_month_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_month_12`()
  BEGIN
      WITH last_' at line 13
  compiled Code at target\run\kasper_sindri_media\models\example\tactical_articles_card_month_12.sql
[0m12:51:42.208423 [info ] [MainThread]: 
[0m12:51:42.210420 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m12:51:42.215420 [debug] [MainThread]: Command `dbt run` failed at 12:51:42.215420 after 14.42 seconds
[0m12:51:42.216402 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028A5EE482D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028A58310B10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028A58310AD0>]}
[0m12:51:42.217399 [debug] [MainThread]: Flushing usage events
[0m12:54:45.889759 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000153AB5BC990>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000153AB5BCD50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000153AB5BD850>]}


============================== 12:54:45.898734 | 36731b80-b719-48e6-aecc-f0d5cdf29ecf ==============================
[0m12:54:45.898734 [info ] [MainThread]: Running with dbt=1.7.17
[0m12:54:45.901724 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'version_check': 'True', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run --models example.tactical_articles_card_month_12', 'send_anonymous_usage_stats': 'True'}
[0m12:54:46.225491 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '36731b80-b719-48e6-aecc-f0d5cdf29ecf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000153AB769350>]}
[0m12:54:46.315252 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '36731b80-b719-48e6-aecc-f0d5cdf29ecf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000153AB5DD890>]}
[0m12:54:46.317329 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m12:54:46.333290 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m12:54:46.453966 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m12:54:46.455964 [debug] [MainThread]: Partial parsing: updated file: kasper_sindri_media://models\example\tactical_articles_card_month_12.sql
[0m12:54:46.660414 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example.run_tactical_articles_card_month_12
[0m12:54:46.671384 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '36731b80-b719-48e6-aecc-f0d5cdf29ecf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000153AB8A0410>]}
[0m12:54:46.692336 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '36731b80-b719-48e6-aecc-f0d5cdf29ecf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000153AB974C50>]}
[0m12:54:46.694322 [info ] [MainThread]: Found 11 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m12:54:46.696318 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '36731b80-b719-48e6-aecc-f0d5cdf29ecf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000153AB87AB50>]}
[0m12:54:46.699348 [info ] [MainThread]: 
[0m12:54:46.701306 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m12:54:46.704462 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m12:54:46.719422 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m12:54:46.720420 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m12:54:46.721416 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:54:48.271486 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m12:54:48.274479 [debug] [ThreadPool]: On list_schemas: Close
[0m12:54:48.276475 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m12:54:48.277471 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m12:54:48.284454 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:54:48.285451 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m12:54:48.285451 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:54:49.837296 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:54:49.838294 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:54:49.839292 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m12:54:50.454644 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m12:54:50.457638 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m12:54:50.458635 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:54:50.458635 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m12:54:51.036091 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:54:51.037089 [debug] [ThreadPool]: On create__site_dev: Close
[0m12:54:51.041076 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m12:54:51.052049 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m12:54:51.052049 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m12:54:51.053046 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:54:52.624888 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:54:52.625886 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m12:54:52.627880 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m12:54:53.223288 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:54:53.226281 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m12:54:53.429735 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m12:54:53.431730 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '36731b80-b719-48e6-aecc-f0d5cdf29ecf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000153AB7861D0>]}
[0m12:54:53.432730 [debug] [MainThread]: Using mysql connection "master"
[0m12:54:53.433724 [debug] [MainThread]: On master: BEGIN
[0m12:54:53.434721 [debug] [MainThread]: Opening a new connection, currently in state init
[0m12:54:55.232715 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:54:55.235718 [debug] [MainThread]: On master: COMMIT
[0m12:54:55.238711 [debug] [MainThread]: Using mysql connection "master"
[0m12:54:55.240704 [debug] [MainThread]: On master: COMMIT
[0m12:54:55.852442 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:54:55.853439 [debug] [MainThread]: On master: Close
[0m12:54:55.856431 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m12:54:55.859425 [info ] [MainThread]: 
[0m12:54:55.866404 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.tactical_articles_card_month_12
[0m12:54:55.867402 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.tactical_articles_card_month_12 ........... [RUN]
[0m12:54:55.869398 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.kasper_sindri_media.tactical_articles_card_month_12'
[0m12:54:55.871391 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.tactical_articles_card_month_12
[0m12:54:55.892336 [debug] [Thread-1 (]: Writing injected SQL for node "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m12:54:55.894332 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.tactical_articles_card_month_12 (compile): 12:54:55.872413 => 12:54:55.893333
[0m12:54:55.895329 [debug] [Thread-1 (]: Began executing node model.kasper_sindri_media.tactical_articles_card_month_12
[0m12:54:55.966137 [debug] [Thread-1 (]: Writing runtime sql for node "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m12:54:55.987082 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m12:54:55.988079 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: BEGIN
[0m12:54:55.989076 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m12:54:57.562040 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:54:57.565031 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m12:54:57.567025 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.kasper_sindri_media.tactical_articles_card_month_12"} */

  create view `site_dev`.`tactical_articles_card_month_12__dbt_tmp`
    
    
  as (
    





CREATE PROCEDURE `prod`.`tactical_articles_card_month_12_test_dbt`()
BEGIN
    WITH last_30_day AS (
        SELECT siteId as siteId, COUNT(date) as value 
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND siteid = '12'
        GROUP BY 1
    ),
    last_30_days_before AS (
        SELECT siteId as siteId, COUNT(*) as value  
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND siteid = '12'
        GROUP BY 1
    )
    SELECT
        JSON_OBJECT(
            'site', ld.siteId,
            'data', JSON_OBJECT(
                'label', 'Artikler',
                'hint', 'Artikler publiceret seneste 30 dage ift. forrige 30 dage',
                'value', COALESCE(ld.value, 0),
                'change', COALESCE(ROUND(((ld.value - lb.value) / lb.value) * 100, 2), 0),
                'progressCurrent', '',
                'progressTotal', ''
            )
        ) AS json_data
    FROM last_30_day ld
    LEFT JOIN last_30_days_before lb ON ld.siteId = lb.siteId;
END;
  );
[0m12:54:58.154330 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_month_12_test_dbt`()
BEGIN
    W' at line 13
[0m12:54:58.156341 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: ROLLBACK
[0m12:54:58.356415 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.tactical_articles_card_month_12 (execute): 12:54:55.896326 => 12:54:58.354413
[0m12:54:58.358398 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: Close
[0m12:54:58.366378 [debug] [Thread-1 (]: Database Error in model tactical_articles_card_month_12 (models\example\tactical_articles_card_month_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_month_12_test_dbt`()
  BEGIN
      W' at line 13
  compiled Code at target\run\kasper_sindri_media\models\example\tactical_articles_card_month_12.sql
[0m12:54:58.367374 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '36731b80-b719-48e6-aecc-f0d5cdf29ecf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000153AB9431D0>]}
[0m12:54:58.369368 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.tactical_articles_card_month_12 .. [[31mERROR[0m in 2.50s]
[0m12:54:58.371390 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.tactical_articles_card_month_12
[0m12:54:58.374772 [debug] [MainThread]: Using mysql connection "master"
[0m12:54:58.375768 [debug] [MainThread]: On master: BEGIN
[0m12:54:58.375768 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m12:54:59.968448 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:54:59.970438 [debug] [MainThread]: On master: COMMIT
[0m12:54:59.972434 [debug] [MainThread]: Using mysql connection "master"
[0m12:54:59.975423 [debug] [MainThread]: On master: COMMIT
[0m12:55:00.577277 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:55:00.579270 [debug] [MainThread]: On master: Close
[0m12:55:00.584257 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:55:00.586255 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m12:55:00.589243 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m12:55:00.591243 [debug] [MainThread]: Connection 'model.kasper_sindri_media.tactical_articles_card_month_12' was properly closed.
[0m12:55:00.593236 [info ] [MainThread]: 
[0m12:55:00.595225 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 13.89 seconds (13.89s).
[0m12:55:00.598858 [debug] [MainThread]: Command end result
[0m12:55:00.614811 [info ] [MainThread]: 
[0m12:55:00.616808 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m12:55:00.618056 [info ] [MainThread]: 
[0m12:55:00.619067 [error] [MainThread]:   Database Error in model tactical_articles_card_month_12 (models\example\tactical_articles_card_month_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_month_12_test_dbt`()
  BEGIN
      W' at line 13
  compiled Code at target\run\kasper_sindri_media\models\example\tactical_articles_card_month_12.sql
[0m12:55:00.621823 [info ] [MainThread]: 
[0m12:55:00.622391 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m12:55:00.625879 [debug] [MainThread]: Command `dbt run` failed at 12:55:00.624851 after 14.87 seconds
[0m12:55:00.626844 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000153A4AA0B10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000153A4AA0AD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000153AB79E650>]}
[0m12:55:00.626844 [debug] [MainThread]: Flushing usage events
[0m12:57:11.174034 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026C2A808DD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026C2A4456D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026C2A808690>]}


============================== 12:57:11.181012 | fa8c5a05-6358-46ed-ba00-3a8b051b2a18 ==============================
[0m12:57:11.181012 [info ] [MainThread]: Running with dbt=1.7.17
[0m12:57:11.183007 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models example.tactical_articles_card_month_12', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m12:57:11.586927 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'fa8c5a05-6358-46ed-ba00-3a8b051b2a18', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026C2A9BBD90>]}
[0m12:57:11.709598 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'fa8c5a05-6358-46ed-ba00-3a8b051b2a18', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026C2AA380D0>]}
[0m12:57:11.711596 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m12:57:11.729545 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m12:57:11.756472 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m12:57:11.757470 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'fa8c5a05-6358-46ed-ba00-3a8b051b2a18', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026C2ABCED50>]}
[0m12:57:13.717229 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example.run_tactical_articles_card_month_12
[0m12:57:13.726205 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'fa8c5a05-6358-46ed-ba00-3a8b051b2a18', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026C2AD247D0>]}
[0m12:57:13.747147 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'fa8c5a05-6358-46ed-ba00-3a8b051b2a18', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026C2A848B90>]}
[0m12:57:13.749144 [info ] [MainThread]: Found 11 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m12:57:13.750148 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fa8c5a05-6358-46ed-ba00-3a8b051b2a18', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026C2ABBDA90>]}
[0m12:57:13.755128 [info ] [MainThread]: 
[0m12:57:13.758118 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m12:57:13.760789 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m12:57:13.780735 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m12:57:13.781731 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m12:57:13.782728 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:57:15.326251 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m12:57:15.336224 [debug] [ThreadPool]: On list_schemas: Close
[0m12:57:15.341213 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m12:57:15.343209 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m12:57:15.353180 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:57:15.354176 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m12:57:15.354176 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:57:16.950025 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:57:16.952029 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:57:16.954024 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m12:57:17.541612 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m12:57:17.546609 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m12:57:17.548610 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m12:57:17.550596 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m12:57:18.146716 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:57:18.149717 [debug] [ThreadPool]: On create__site_dev: Close
[0m12:57:18.153535 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m12:57:18.161516 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m12:57:18.161516 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m12:57:18.162514 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:57:19.742247 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:57:19.744253 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m12:57:19.747245 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m12:57:20.338875 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:57:20.343894 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m12:57:20.539849 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m12:57:20.544865 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fa8c5a05-6358-46ed-ba00-3a8b051b2a18', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026C2A848390>]}
[0m12:57:20.545859 [debug] [MainThread]: Using mysql connection "master"
[0m12:57:20.546856 [debug] [MainThread]: On master: BEGIN
[0m12:57:20.547854 [debug] [MainThread]: Opening a new connection, currently in state init
[0m12:57:22.106499 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:57:22.108527 [debug] [MainThread]: On master: COMMIT
[0m12:57:22.111501 [debug] [MainThread]: Using mysql connection "master"
[0m12:57:22.111501 [debug] [MainThread]: On master: COMMIT
[0m12:57:22.707991 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:57:22.708988 [debug] [MainThread]: On master: Close
[0m12:57:22.711980 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m12:57:22.712978 [info ] [MainThread]: 
[0m12:57:22.719959 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.tactical_articles_card_month_12
[0m12:57:22.720956 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.tactical_articles_card_month_12 ........... [RUN]
[0m12:57:22.723963 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.kasper_sindri_media.tactical_articles_card_month_12'
[0m12:57:22.724947 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.tactical_articles_card_month_12
[0m12:57:22.746886 [debug] [Thread-1 (]: Writing injected SQL for node "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m12:57:22.748881 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.tactical_articles_card_month_12 (compile): 12:57:22.725959 => 12:57:22.747884
[0m12:57:22.749878 [debug] [Thread-1 (]: Began executing node model.kasper_sindri_media.tactical_articles_card_month_12
[0m12:57:22.793761 [debug] [Thread-1 (]: Writing runtime sql for node "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m12:57:22.795758 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m12:57:22.796755 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: BEGIN
[0m12:57:22.797751 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m12:57:24.340400 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:57:24.342403 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m12:57:24.345379 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.kasper_sindri_media.tactical_articles_card_month_12"} */

  create view `site_dev`.`tactical_articles_card_month_12__dbt_tmp`
    
    
  as (
    





CREATE PROCEDURE `prod`.`tactical_articles_card_month_12_test_dbt`()
BEGIN
    WITH last_30_day AS (
        SELECT siteId as siteId, COUNT(date) as value 
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND siteid = '12'
        GROUP BY 1
    ),
    last_30_days_before AS (
        SELECT siteId as siteId, COUNT(*) as value  
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND siteid = '12'
        GROUP BY 1
    )
    SELECT
        JSON_OBJECT(
            'site', ld.siteId,
            'data', JSON_OBJECT(
                'label', 'Artikler',
                'hint', 'Artikler publiceret seneste 30 dage ift. forrige 30 dage',
                'value', COALESCE(ld.value, 0),
                'change', COALESCE(ROUND(((ld.value - lb.value) / lb.value) * 100, 2), 0),
                'progressCurrent', '',
                'progressTotal', ''
            )
        ) AS json_data
    FROM last_30_day ld
    LEFT JOIN last_30_days_before lb ON ld.siteId = lb.siteId;
END;
  );
[0m12:57:24.926662 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_month_12_test_dbt`()
BEGIN
    W' at line 13
[0m12:57:24.927661 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: ROLLBACK
[0m12:57:25.124348 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.tactical_articles_card_month_12 (execute): 12:57:22.750876 => 12:57:25.122326
[0m12:57:25.126346 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: Close
[0m12:57:25.136312 [debug] [Thread-1 (]: Database Error in model tactical_articles_card_month_12 (models\example\tactical_articles_card_month_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_month_12_test_dbt`()
  BEGIN
      W' at line 13
  compiled Code at target\run\kasper_sindri_media\models\example\tactical_articles_card_month_12.sql
[0m12:57:25.137309 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fa8c5a05-6358-46ed-ba00-3a8b051b2a18', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026C2AA12350>]}
[0m12:57:25.138306 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.tactical_articles_card_month_12 .. [[31mERROR[0m in 2.41s]
[0m12:57:25.139306 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.tactical_articles_card_month_12
[0m12:57:25.143313 [debug] [MainThread]: Using mysql connection "master"
[0m12:57:25.144327 [debug] [MainThread]: On master: BEGIN
[0m12:57:25.145294 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m12:57:26.722670 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m12:57:26.724673 [debug] [MainThread]: On master: COMMIT
[0m12:57:26.726665 [debug] [MainThread]: Using mysql connection "master"
[0m12:57:26.727662 [debug] [MainThread]: On master: COMMIT
[0m12:57:27.313175 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m12:57:27.315177 [debug] [MainThread]: On master: Close
[0m12:57:27.318174 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:57:27.319167 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m12:57:27.320162 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m12:57:27.321173 [debug] [MainThread]: Connection 'model.kasper_sindri_media.tactical_articles_card_month_12' was properly closed.
[0m12:57:27.322156 [info ] [MainThread]: 
[0m12:57:27.323155 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 13.56 seconds (13.56s).
[0m12:57:27.324861 [debug] [MainThread]: Command end result
[0m12:57:27.336830 [info ] [MainThread]: 
[0m12:57:27.339091 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m12:57:27.340091 [info ] [MainThread]: 
[0m12:57:27.342084 [error] [MainThread]:   Database Error in model tactical_articles_card_month_12 (models\example\tactical_articles_card_month_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_month_12_test_dbt`()
  BEGIN
      W' at line 13
  compiled Code at target\run\kasper_sindri_media\models\example\tactical_articles_card_month_12.sql
[0m12:57:27.343110 [info ] [MainThread]: 
[0m12:57:27.344720 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m12:57:27.347324 [debug] [MainThread]: Command `dbt run` failed at 12:57:27.347324 after 16.30 seconds
[0m12:57:27.348321 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026C2A4306D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026C23D21590>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026C23D21550>]}
[0m12:57:27.350318 [debug] [MainThread]: Flushing usage events
[0m13:11:31.475965 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029BDA386A10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029BD9E47C50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029BDA386150>]}


============================== 13:11:31.482946 | 7b06605a-748e-4d23-8618-e5e63d1f8b9f ==============================
[0m13:11:31.482946 [info ] [MainThread]: Running with dbt=1.7.17
[0m13:11:31.484941 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'version_check': 'True', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run --models example.Tactical_clicks_months_12', 'send_anonymous_usage_stats': 'True'}
[0m13:11:31.759138 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '7b06605a-748e-4d23-8618-e5e63d1f8b9f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029BDA3B7310>]}
[0m13:11:31.840919 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '7b06605a-748e-4d23-8618-e5e63d1f8b9f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029BDA39D990>]}
[0m13:11:31.843349 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m13:11:31.855319 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m13:11:31.879510 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m13:11:31.880516 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '7b06605a-748e-4d23-8618-e5e63d1f8b9f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029BDA360B50>]}
[0m13:11:33.365963 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example.run_Tactical_clicks_months_12
[0m13:11:33.373940 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '7b06605a-748e-4d23-8618-e5e63d1f8b9f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029BDA386290>]}
[0m13:11:33.394886 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '7b06605a-748e-4d23-8618-e5e63d1f8b9f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029BDA8CE4D0>]}
[0m13:11:33.395881 [info ] [MainThread]: Found 13 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m13:11:33.397879 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7b06605a-748e-4d23-8618-e5e63d1f8b9f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029BDA632AD0>]}
[0m13:11:33.399873 [info ] [MainThread]: 
[0m13:11:33.401867 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m13:11:33.404403 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m13:11:33.418364 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m13:11:33.418364 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m13:11:33.419362 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:11:34.976476 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m13:11:34.983454 [debug] [ThreadPool]: On list_schemas: Close
[0m13:11:34.986445 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m13:11:34.988439 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m13:11:34.998413 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:11:34.999412 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m13:11:35.001405 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:11:36.581181 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:11:36.585171 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:11:36.587166 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m13:11:37.184321 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m13:11:37.188308 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m13:11:37.189302 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:11:37.190319 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m13:11:37.778507 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:11:37.782509 [debug] [ThreadPool]: On create__site_dev: Close
[0m13:11:37.792891 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m13:11:37.802863 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m13:11:37.803861 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m13:11:37.804858 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:11:39.393906 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:11:39.396908 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m13:11:39.399896 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m13:11:40.001631 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:11:40.005612 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m13:11:40.207272 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m13:11:40.213266 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7b06605a-748e-4d23-8618-e5e63d1f8b9f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029BDA546610>]}
[0m13:11:40.216264 [debug] [MainThread]: Using mysql connection "master"
[0m13:11:40.220247 [debug] [MainThread]: On master: BEGIN
[0m13:11:40.222237 [debug] [MainThread]: Opening a new connection, currently in state init
[0m13:11:41.786702 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:11:41.787702 [debug] [MainThread]: On master: COMMIT
[0m13:11:41.788697 [debug] [MainThread]: Using mysql connection "master"
[0m13:11:41.789696 [debug] [MainThread]: On master: COMMIT
[0m13:11:42.372225 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:11:42.373228 [debug] [MainThread]: On master: Close
[0m13:11:42.374224 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m13:11:42.376219 [info ] [MainThread]: 
[0m13:11:42.383042 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.Tactical_clicks_months_12
[0m13:11:42.386033 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.Tactical_clicks_months_12 ................. [RUN]
[0m13:11:42.388026 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.kasper_sindri_media.Tactical_clicks_months_12'
[0m13:11:42.389025 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.Tactical_clicks_months_12
[0m13:11:42.405978 [debug] [Thread-1 (]: Writing injected SQL for node "model.kasper_sindri_media.Tactical_clicks_months_12"
[0m13:11:42.407973 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.Tactical_clicks_months_12 (compile): 13:11:42.389025 => 13:11:42.407973
[0m13:11:42.408971 [debug] [Thread-1 (]: Began executing node model.kasper_sindri_media.Tactical_clicks_months_12
[0m13:11:42.466816 [debug] [Thread-1 (]: Writing runtime sql for node "model.kasper_sindri_media.Tactical_clicks_months_12"
[0m13:11:42.469811 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.Tactical_clicks_months_12"
[0m13:11:42.470807 [debug] [Thread-1 (]: On model.kasper_sindri_media.Tactical_clicks_months_12: BEGIN
[0m13:11:42.471803 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m13:11:44.046864 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:11:44.048867 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.Tactical_clicks_months_12"
[0m13:11:44.051859 [debug] [Thread-1 (]: On model.kasper_sindri_media.Tactical_clicks_months_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.kasper_sindri_media.Tactical_clicks_months_12"} */

  create view `site_dev`.`Tactical_clicks_months_12__dbt_tmp`
    
    
  as (
    








CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
BEGIN


WITH 
curr_30_days_article_published AS (
    SELECT siteid, id
    FROM prod.site_archive_post
    WHERE DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
    AND   categories <> "Nyhedsoverblik"
    AND siteid = 12
),

agg_curr_30_days_events AS (
    SELECT 
        e.siteid AS siteid, 
        SUM(e.hits) AS next_clicks
    FROM prod.events e
    JOIN curr_30_days_article_published a ON a.id = e.postid
    WHERE e.date DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
    AND e.siteid = 12
    AND e.Event_Action = Next Click
    GROUP BY 1
),

agg_curr_30_days_pages AS
(
	select
		p.siteid,
        sum(p.unique_pageviews) as pageview_sum
	from prod.pages p
    left join curr_30_days_article_published a ON a.id = p.postid
    where p.siteid = 12
    and p.date DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
),

value_curr_30_days AS
(
	Select
		e.siteid,
		round(e.next_clicks/p.pageview_sum * 100,2) as value
        from agg_curr_30_days_events e
        left join agg_curr_30_days_pages p on e.siteid = p.siteid
),

last_30_days_article_published AS (
    SELECT siteid, id
    FROM prod.site_archive_post
    WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
    AND siteid = 12 AND  categories <> "Nyhedsoverblik"
),

agg_last_30_days_events AS (
    SELECT 
        e.siteid AS siteid, 
        SUM(e.hits) AS next_clicks_last
    FROM prod.events e
    JOIN last_30_days_article_published a ON a.id = e.postid
    WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
    AND e.siteid = 12
    AND e.Event_Action = Next Click
    GROUP BY 1
),

agg_last_30_days_pages AS
(
	select
		p.siteid,
        sum(p.unique_pageviews) as pageview_sum_last
	from prod.pages p
    left join last_30_days_article_published a ON a.id = p.postid
    where p.siteid = 12
    and p.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
),

value_last_30_days AS
(
	Select
		e.siteid,
		round(e.next_clicks_last/p.pageview_sum_last * 100,2) as value_last
        from agg_last_30_days_events e
        left join agg_last_30_days_pages p on e.siteid = p.siteid
)

SELECT 
    JSON_OBJECT(
        'site', al.siteid,
        'data', JSON_OBJECT(
        'label', 'Artikler',
        'hint', 'Artikler publiceret seneste 30 dage ift. forrige 30 dage',
        'value', COALESCE(value, 0),
        'change', COALESCE(value - value_last, 0),
        'progressCurrent', '',
        'progressTotal', ''
        )
    ) AS json_data
FROM value_curr_30_days al
LEFT JOIN value_last_30_days alb ON al.siteid = alb.siteid
WHERE al.siteid = site;

END
  );
[0m13:11:44.629902 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
BEGIN


WITH 
cur' at line 16
[0m13:11:44.630898 [debug] [Thread-1 (]: On model.kasper_sindri_media.Tactical_clicks_months_12: ROLLBACK
[0m13:11:44.827817 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.Tactical_clicks_months_12 (execute): 13:11:42.409969 => 13:11:44.825814
[0m13:11:44.830816 [debug] [Thread-1 (]: On model.kasper_sindri_media.Tactical_clicks_months_12: Close
[0m13:11:44.853745 [debug] [Thread-1 (]: Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
  BEGIN
  
  
  WITH 
  cur' at line 16
  compiled Code at target\run\kasper_sindri_media\models\example\Tactical_clicks_months_12.sql
[0m13:11:44.855769 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7b06605a-748e-4d23-8618-e5e63d1f8b9f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029BDA785A50>]}
[0m13:11:44.856739 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.Tactical_clicks_months_12 ........ [[31mERROR[0m in 2.47s]
[0m13:11:44.858731 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.Tactical_clicks_months_12
[0m13:11:44.862736 [debug] [MainThread]: Using mysql connection "master"
[0m13:11:44.863718 [debug] [MainThread]: On master: BEGIN
[0m13:11:44.865712 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m13:11:46.420668 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:11:46.422660 [debug] [MainThread]: On master: COMMIT
[0m13:11:46.424654 [debug] [MainThread]: Using mysql connection "master"
[0m13:11:46.426651 [debug] [MainThread]: On master: COMMIT
[0m13:11:47.013538 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:11:47.014534 [debug] [MainThread]: On master: Close
[0m13:11:47.017527 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:11:47.018525 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m13:11:47.019522 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m13:11:47.020520 [debug] [MainThread]: Connection 'model.kasper_sindri_media.Tactical_clicks_months_12' was properly closed.
[0m13:11:47.022515 [info ] [MainThread]: 
[0m13:11:47.023513 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 13.62 seconds (13.62s).
[0m13:11:47.025505 [debug] [MainThread]: Command end result
[0m13:11:47.042461 [info ] [MainThread]: 
[0m13:11:47.043458 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m13:11:47.044456 [info ] [MainThread]: 
[0m13:11:47.046457 [error] [MainThread]:   Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
  BEGIN
  
  
  WITH 
  cur' at line 16
  compiled Code at target\run\kasper_sindri_media\models\example\Tactical_clicks_months_12.sql
[0m13:11:47.048444 [info ] [MainThread]: 
[0m13:11:47.051438 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m13:11:47.054865 [debug] [MainThread]: Command `dbt run` failed at 13:11:47.054865 after 15.68 seconds
[0m13:11:47.055862 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029BDA3B85D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029BD38D0C10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029BDA361E90>]}
[0m13:11:47.056859 [debug] [MainThread]: Flushing usage events
[0m13:13:01.865725 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002427F8EF350>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002427F5FFE50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002427F8EC210>]}


============================== 13:13:01.873703 | 2ad38427-b0cb-401b-8a5a-261a5b95c3b8 ==============================
[0m13:13:01.873703 [info ] [MainThread]: Running with dbt=1.7.17
[0m13:13:01.876696 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'debug': 'False', 'version_check': 'True', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --models example.Tactical_clicks_months_12', 'send_anonymous_usage_stats': 'True'}
[0m13:13:02.143633 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2ad38427-b0cb-401b-8a5a-261a5b95c3b8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002427FAF1510>]}
[0m13:13:02.219430 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2ad38427-b0cb-401b-8a5a-261a5b95c3b8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002427FB2E590>]}
[0m13:13:02.221592 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m13:13:02.233564 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m13:13:02.350252 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m13:13:02.352249 [debug] [MainThread]: Partial parsing: updated file: kasper_sindri_media://models\example\Tactical_clicks_months_12.sql
[0m13:13:02.535755 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example.run_Tactical_clicks_months_12
[0m13:13:02.543734 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2ad38427-b0cb-401b-8a5a-261a5b95c3b8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002427FDFB090>]}
[0m13:13:02.563684 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2ad38427-b0cb-401b-8a5a-261a5b95c3b8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002427FC10850>]}
[0m13:13:02.564679 [info ] [MainThread]: Found 13 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m13:13:02.565675 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2ad38427-b0cb-401b-8a5a-261a5b95c3b8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002427FC7DD50>]}
[0m13:13:02.567671 [info ] [MainThread]: 
[0m13:13:02.570041 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m13:13:02.573032 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m13:13:02.587038 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m13:13:02.587990 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m13:13:02.589998 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:13:04.165886 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m13:13:04.168879 [debug] [ThreadPool]: On list_schemas: Close
[0m13:13:04.172868 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m13:13:04.174864 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m13:13:04.181843 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:13:04.182852 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m13:13:04.183838 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:13:05.751441 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:13:05.753432 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:13:05.756431 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m13:13:06.354608 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m13:13:06.358633 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m13:13:06.359620 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:13:06.360620 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m13:13:06.945797 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:13:06.948813 [debug] [ThreadPool]: On create__site_dev: Close
[0m13:13:06.959787 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m13:13:06.976737 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m13:13:06.977735 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m13:13:06.978731 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:13:08.634463 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:13:08.635460 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m13:13:08.636457 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m13:13:09.224244 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:13:09.227234 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m13:13:09.420526 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m13:13:09.423524 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2ad38427-b0cb-401b-8a5a-261a5b95c3b8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002427FB4F850>]}
[0m13:13:09.424523 [debug] [MainThread]: Using mysql connection "master"
[0m13:13:09.425520 [debug] [MainThread]: On master: BEGIN
[0m13:13:09.426516 [debug] [MainThread]: Opening a new connection, currently in state init
[0m13:13:10.989825 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:13:10.991814 [debug] [MainThread]: On master: COMMIT
[0m13:13:10.993813 [debug] [MainThread]: Using mysql connection "master"
[0m13:13:10.996810 [debug] [MainThread]: On master: COMMIT
[0m13:13:11.586021 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:13:11.589010 [debug] [MainThread]: On master: Close
[0m13:13:11.593000 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m13:13:11.596995 [info ] [MainThread]: 
[0m13:13:11.613150 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.Tactical_clicks_months_12
[0m13:13:11.615144 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.Tactical_clicks_months_12 ................. [RUN]
[0m13:13:11.618136 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.kasper_sindri_media.Tactical_clicks_months_12'
[0m13:13:11.620130 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.Tactical_clicks_months_12
[0m13:13:11.638082 [debug] [Thread-1 (]: Writing injected SQL for node "model.kasper_sindri_media.Tactical_clicks_months_12"
[0m13:13:11.640075 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.Tactical_clicks_months_12 (compile): 13:13:11.621127 => 13:13:11.639080
[0m13:13:11.641073 [debug] [Thread-1 (]: Began executing node model.kasper_sindri_media.Tactical_clicks_months_12
[0m13:13:11.691939 [debug] [Thread-1 (]: Writing runtime sql for node "model.kasper_sindri_media.Tactical_clicks_months_12"
[0m13:13:11.693932 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.Tactical_clicks_months_12"
[0m13:13:11.694927 [debug] [Thread-1 (]: On model.kasper_sindri_media.Tactical_clicks_months_12: BEGIN
[0m13:13:11.694927 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m13:13:13.243413 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:13:13.245406 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.Tactical_clicks_months_12"
[0m13:13:13.247401 [debug] [Thread-1 (]: On model.kasper_sindri_media.Tactical_clicks_months_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.kasper_sindri_media.Tactical_clicks_months_12"} */

  create view `site_dev`.`Tactical_clicks_months_12__dbt_tmp`
    
    
  as (
    








CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`(
    IN site INT,
    IN label VARCHAR(255),
    IN hint VARCHAR(255),
    IN event_name VARCHAR(255)
)
BEGIN

WITH curr_30_days_article_published AS (
    SELECT siteid, id
    FROM prod.site_archive_post
    WHERE DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
    AND   categories <> "Nyhedsoverblik"
    AND siteid = 12
),

agg_curr_30_days_events AS (
    SELECT 
        e.siteid AS siteid, 
        SUM(e.hits) AS next_clicks
    FROM prod.events e
    JOIN curr_30_days_article_published a ON a.id = e.postid
    WHERE e.date DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
    AND e.siteid = 12
    AND e.Event_Action = Next Click
    GROUP BY 1
),

agg_curr_30_days_pages AS
(
	select
		p.siteid,
        sum(p.unique_pageviews) as pageview_sum
	from prod.pages p
    left join curr_30_days_article_published a ON a.id = p.postid
    where p.siteid = 12
    and p.date DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
),

value_curr_30_days AS
(
	Select
		e.siteid,
		round(e.next_clicks/p.pageview_sum * 100,2) as value
        from agg_curr_30_days_events e
        left join agg_curr_30_days_pages p on e.siteid = p.siteid
),

last_30_days_article_published AS (
    SELECT siteid, id
    FROM prod.site_archive_post
    WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
    AND siteid = 12 AND  categories <> "Nyhedsoverblik"
),

agg_last_30_days_events AS (
    SELECT 
        e.siteid AS siteid, 
        SUM(e.hits) AS next_clicks_last
    FROM prod.events e
    JOIN last_30_days_article_published a ON a.id = e.postid
    WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
    AND e.siteid = 12
    AND e.Event_Action = Next Click
    GROUP BY 1
),

agg_last_30_days_pages AS
(
	select
		p.siteid,
        sum(p.unique_pageviews) as pageview_sum_last
	from prod.pages p
    left join last_30_days_article_published a ON a.id = p.postid
    where p.siteid = 12
    and p.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
),

value_last_30_days AS
(
	Select
		e.siteid,
		round(e.next_clicks_last/p.pageview_sum_last * 100,2) as value_last
        from agg_last_30_days_events e
        left join agg_last_30_days_pages p on e.siteid = p.siteid
)

SELECT 
    JSON_OBJECT(
        'site', al.siteid,
        'data', JSON_OBJECT(
        'label', 'Artikler',
        'hint', 'Artikler publiceret seneste 30 dage ift. forrige 30 dage',
        'value', COALESCE(value, 0),
        'change', COALESCE(value - value_last, 0),
        'progressCurrent', '',
        'progressTotal', ''
        )
    ) AS json_data
FROM value_curr_30_days al
LEFT JOIN value_last_30_days alb ON al.siteid = alb.siteid
WHERE al.siteid = site;

END
  );
[0m13:13:13.827731 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`(
    IN site INT,
 ' at line 16
[0m13:13:13.831722 [debug] [Thread-1 (]: On model.kasper_sindri_media.Tactical_clicks_months_12: ROLLBACK
[0m13:13:14.026300 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.Tactical_clicks_months_12 (execute): 13:13:11.642072 => 13:13:14.026300
[0m13:13:14.030293 [debug] [Thread-1 (]: On model.kasper_sindri_media.Tactical_clicks_months_12: Close
[0m13:13:14.042261 [debug] [Thread-1 (]: Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`(
      IN site INT,
   ' at line 16
  compiled Code at target\run\kasper_sindri_media\models\example\Tactical_clicks_months_12.sql
[0m13:13:14.044257 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2ad38427-b0cb-401b-8a5a-261a5b95c3b8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002427FE2A3D0>]}
[0m13:13:14.048245 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.Tactical_clicks_months_12 ........ [[31mERROR[0m in 2.43s]
[0m13:13:14.051236 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.Tactical_clicks_months_12
[0m13:13:14.055227 [debug] [MainThread]: Using mysql connection "master"
[0m13:13:14.056227 [debug] [MainThread]: On master: BEGIN
[0m13:13:14.057223 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m13:13:15.620199 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:13:15.624199 [debug] [MainThread]: On master: COMMIT
[0m13:13:15.627189 [debug] [MainThread]: Using mysql connection "master"
[0m13:13:15.631180 [debug] [MainThread]: On master: COMMIT
[0m13:13:16.216891 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:13:16.219914 [debug] [MainThread]: On master: Close
[0m13:13:16.222906 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:13:16.224899 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m13:13:16.227893 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m13:13:16.228887 [debug] [MainThread]: Connection 'model.kasper_sindri_media.Tactical_clicks_months_12' was properly closed.
[0m13:13:16.230889 [info ] [MainThread]: 
[0m13:13:16.233878 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 13.66 seconds (13.66s).
[0m13:13:16.240377 [debug] [MainThread]: Command end result
[0m13:13:16.264275 [info ] [MainThread]: 
[0m13:13:16.265270 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m13:13:16.268367 [info ] [MainThread]: 
[0m13:13:16.270368 [error] [MainThread]:   Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`(
      IN site INT,
   ' at line 16
  compiled Code at target\run\kasper_sindri_media\models\example\Tactical_clicks_months_12.sql
[0m13:13:16.272355 [info ] [MainThread]: 
[0m13:13:16.274262 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m13:13:16.277252 [debug] [MainThread]: Command `dbt run` failed at 13:13:16.276257 after 14.50 seconds
[0m13:13:16.278250 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002427F8EF750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002427F8ECB90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002427FBA0C10>]}
[0m13:13:16.278250 [debug] [MainThread]: Flushing usage events
[0m13:14:20.252693 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028FE651C210>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028FE6AA1010>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028FE6AA0F90>]}


============================== 13:14:20.258676 | 7c5c2fc1-1786-4458-9402-ddc057203546 ==============================
[0m13:14:20.258676 [info ] [MainThread]: Running with dbt=1.7.17
[0m13:14:20.260673 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'debug': 'False', 'warn_error': 'None', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models example.Tactical_clicks_months_12', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m13:14:20.552731 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '7c5c2fc1-1786-4458-9402-ddc057203546', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028FE6ACD990>]}
[0m13:14:20.639499 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '7c5c2fc1-1786-4458-9402-ddc057203546', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028FE651C350>]}
[0m13:14:20.641584 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m13:14:20.653554 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m13:14:20.773776 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m13:14:20.774773 [debug] [MainThread]: Partial parsing: updated file: kasper_sindri_media://models\example\Tactical_clicks_months_12.sql
[0m13:14:20.977233 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example.run_Tactical_clicks_months_12
[0m13:14:20.987206 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '7c5c2fc1-1786-4458-9402-ddc057203546', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028FE6FA8C90>]}
[0m13:14:21.007152 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '7c5c2fc1-1786-4458-9402-ddc057203546', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028FE6E72AD0>]}
[0m13:14:21.009150 [info ] [MainThread]: Found 13 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m13:14:21.010145 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7c5c2fc1-1786-4458-9402-ddc057203546', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028FE6E4D310>]}
[0m13:14:21.014136 [info ] [MainThread]: 
[0m13:14:21.016043 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m13:14:21.018664 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m13:14:21.033622 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m13:14:21.034619 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m13:14:21.035618 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:14:22.630052 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m13:14:22.638034 [debug] [ThreadPool]: On list_schemas: Close
[0m13:14:22.646014 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m13:14:22.649016 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m13:14:22.659969 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:14:22.660964 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m13:14:22.661961 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:14:24.214688 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:14:24.216678 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:14:24.218672 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m13:14:24.858087 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m13:14:24.864100 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m13:14:24.867093 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:14:24.869088 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m13:14:25.450394 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:14:25.452384 [debug] [ThreadPool]: On create__site_dev: Close
[0m13:14:25.458366 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m13:14:25.467341 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m13:14:25.468339 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m13:14:25.469336 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:14:27.051486 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:14:27.053480 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m13:14:27.056470 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m13:14:27.648110 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:14:27.654088 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m13:14:27.851403 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m13:14:27.853667 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7c5c2fc1-1786-4458-9402-ddc057203546', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028FE6AF8590>]}
[0m13:14:27.854669 [debug] [MainThread]: Using mysql connection "master"
[0m13:14:27.855665 [debug] [MainThread]: On master: BEGIN
[0m13:14:27.856662 [debug] [MainThread]: Opening a new connection, currently in state init
[0m13:14:29.459440 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:14:29.462443 [debug] [MainThread]: On master: COMMIT
[0m13:14:29.464439 [debug] [MainThread]: Using mysql connection "master"
[0m13:14:29.466452 [debug] [MainThread]: On master: COMMIT
[0m13:14:30.068480 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:14:30.070475 [debug] [MainThread]: On master: Close
[0m13:14:30.075462 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m13:14:30.078458 [info ] [MainThread]: 
[0m13:14:30.091429 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.Tactical_clicks_months_12
[0m13:14:30.093421 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.Tactical_clicks_months_12 ................. [RUN]
[0m13:14:30.097040 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.kasper_sindri_media.Tactical_clicks_months_12'
[0m13:14:30.098038 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.Tactical_clicks_months_12
[0m13:14:30.117985 [debug] [Thread-1 (]: Writing injected SQL for node "model.kasper_sindri_media.Tactical_clicks_months_12"
[0m13:14:30.120977 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.Tactical_clicks_months_12 (compile): 13:14:30.099035 => 13:14:30.119979
[0m13:14:30.121972 [debug] [Thread-1 (]: Began executing node model.kasper_sindri_media.Tactical_clicks_months_12
[0m13:14:30.169845 [debug] [Thread-1 (]: Writing runtime sql for node "model.kasper_sindri_media.Tactical_clicks_months_12"
[0m13:14:30.171841 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.Tactical_clicks_months_12"
[0m13:14:30.172840 [debug] [Thread-1 (]: On model.kasper_sindri_media.Tactical_clicks_months_12: BEGIN
[0m13:14:30.173835 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m13:14:31.751012 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:14:31.754002 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.Tactical_clicks_months_12"
[0m13:14:31.757035 [debug] [Thread-1 (]: On model.kasper_sindri_media.Tactical_clicks_months_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.kasper_sindri_media.Tactical_clicks_months_12"} */

  create view `site_dev`.`Tactical_clicks_months_12__dbt_tmp`
    
    
  as (
    








CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`(
    IN site INT,
    IN label VARCHAR(255),
    IN hint VARCHAR(255),
    IN event_name VARCHAR(255)
)
BEGIN WITH curr_30_days_article_published AS (
    SELECT siteid, id
    FROM prod.site_archive_post
    WHERE DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
    AND   categories <> "Nyhedsoverblik"
    AND siteid = 12
),

agg_curr_30_days_events AS (
    SELECT 
        e.siteid AS siteid, 
        SUM(e.hits) AS next_clicks
    FROM prod.events e
    JOIN curr_30_days_article_published a ON a.id = e.postid
    WHERE e.date DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
    AND e.siteid = 12
    AND e.Event_Action = Next Click
    GROUP BY 1
),

agg_curr_30_days_pages AS
(
	select
		p.siteid,
        sum(p.unique_pageviews) as pageview_sum
	from prod.pages p
    left join curr_30_days_article_published a ON a.id = p.postid
    where p.siteid = 12
    and p.date DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
),

value_curr_30_days AS
(
	Select
		e.siteid,
		round(e.next_clicks/p.pageview_sum * 100,2) as value
        from agg_curr_30_days_events e
        left join agg_curr_30_days_pages p on e.siteid = p.siteid
),

last_30_days_article_published AS (
    SELECT siteid, id
    FROM prod.site_archive_post
    WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
    AND siteid = 12 AND  categories <> "Nyhedsoverblik"
),

agg_last_30_days_events AS (
    SELECT 
        e.siteid AS siteid, 
        SUM(e.hits) AS next_clicks_last
    FROM prod.events e
    JOIN last_30_days_article_published a ON a.id = e.postid
    WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
    AND e.siteid = 12
    AND e.Event_Action = Next Click
    GROUP BY 1
),

agg_last_30_days_pages AS
(
	select
		p.siteid,
        sum(p.unique_pageviews) as pageview_sum_last
	from prod.pages p
    left join last_30_days_article_published a ON a.id = p.postid
    where p.siteid = 12
    and p.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
),

value_last_30_days AS
(
	Select
		e.siteid,
		round(e.next_clicks_last/p.pageview_sum_last * 100,2) as value_last
        from agg_last_30_days_events e
        left join agg_last_30_days_pages p on e.siteid = p.siteid
)

SELECT 
    JSON_OBJECT(
        'site', al.siteid,
        'data', JSON_OBJECT(
        'label', 'Artikler',
        'hint', 'Artikler publiceret seneste 30 dage ift. forrige 30 dage',
        'value', COALESCE(value, 0),
        'change', COALESCE(value - value_last, 0),
        'progressCurrent', '',
        'progressTotal', ''
        )
    ) AS json_data
FROM value_curr_30_days al
LEFT JOIN value_last_30_days alb ON al.siteid = alb.siteid
WHERE al.siteid = site;

END
  );
[0m13:14:32.332089 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`(
    IN site INT,
 ' at line 16
[0m13:14:32.335078 [debug] [Thread-1 (]: On model.kasper_sindri_media.Tactical_clicks_months_12: ROLLBACK
[0m13:14:32.537025 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.Tactical_clicks_months_12 (execute): 13:14:30.122970 => 13:14:32.536033
[0m13:14:32.540015 [debug] [Thread-1 (]: On model.kasper_sindri_media.Tactical_clicks_months_12: Close
[0m13:14:32.558966 [debug] [Thread-1 (]: Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`(
      IN site INT,
   ' at line 16
  compiled Code at target\run\kasper_sindri_media\models\example\Tactical_clicks_months_12.sql
[0m13:14:32.559963 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7c5c2fc1-1786-4458-9402-ddc057203546', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028FE6E42E50>]}
[0m13:14:32.561959 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.Tactical_clicks_months_12 ........ [[31mERROR[0m in 2.46s]
[0m13:14:32.563996 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.Tactical_clicks_months_12
[0m13:14:32.566990 [debug] [MainThread]: Using mysql connection "master"
[0m13:14:32.567986 [debug] [MainThread]: On master: BEGIN
[0m13:14:32.568984 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m13:14:34.140079 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:14:34.143080 [debug] [MainThread]: On master: COMMIT
[0m13:14:34.145072 [debug] [MainThread]: Using mysql connection "master"
[0m13:14:34.147070 [debug] [MainThread]: On master: COMMIT
[0m13:14:34.771005 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:14:34.774005 [debug] [MainThread]: On master: Close
[0m13:14:34.776989 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:14:34.776989 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m13:14:34.777987 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m13:14:34.778983 [debug] [MainThread]: Connection 'model.kasper_sindri_media.Tactical_clicks_months_12' was properly closed.
[0m13:14:34.779982 [info ] [MainThread]: 
[0m13:14:34.780494 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 13.76 seconds (13.76s).
[0m13:14:34.783489 [debug] [MainThread]: Command end result
[0m13:14:34.795459 [info ] [MainThread]: 
[0m13:14:34.796495 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m13:14:34.798495 [info ] [MainThread]: 
[0m13:14:34.800490 [error] [MainThread]:   Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`(
      IN site INT,
   ' at line 16
  compiled Code at target\run\kasper_sindri_media\models\example\Tactical_clicks_months_12.sql
[0m13:14:34.804771 [info ] [MainThread]: 
[0m13:14:34.807211 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m13:14:34.809200 [debug] [MainThread]: Command `dbt run` failed at 13:14:34.809200 after 14.65 seconds
[0m13:14:34.810197 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028FDFFA1550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028FDFFA1590>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028FE6AE6190>]}
[0m13:14:34.811194 [debug] [MainThread]: Flushing usage events
[0m13:16:56.318409 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258FE345B50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258FE2F2750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258FE2F0950>]}


============================== 13:16:56.326387 | 13673db4-afa3-4ccd-977a-20548ef8309e ==============================
[0m13:16:56.326387 [info ] [MainThread]: Running with dbt=1.7.17
[0m13:16:56.328382 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'debug': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models example.Tactical_clicks_months_12', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m13:16:56.597800 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '13673db4-afa3-4ccd-977a-20548ef8309e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258FE3484D0>]}
[0m13:16:56.678584 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '13673db4-afa3-4ccd-977a-20548ef8309e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258FE30D610>]}
[0m13:16:56.680283 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m13:16:56.694256 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m13:16:56.807946 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m13:16:56.809941 [debug] [MainThread]: Partial parsing: updated file: kasper_sindri_media://models\example\Tactical_clicks_months_12.sql
[0m13:16:57.000429 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example.run_Tactical_clicks_months_12
[0m13:16:57.012400 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '13673db4-afa3-4ccd-977a-20548ef8309e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258FE4CDD10>]}
[0m13:16:57.032345 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '13673db4-afa3-4ccd-977a-20548ef8309e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258FE8382D0>]}
[0m13:16:57.033342 [info ] [MainThread]: Found 13 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m13:16:57.035340 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '13673db4-afa3-4ccd-977a-20548ef8309e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258FE69DA10>]}
[0m13:16:57.037331 [info ] [MainThread]: 
[0m13:16:57.039690 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m13:16:57.043679 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m13:16:57.056645 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m13:16:57.057641 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m13:16:57.059636 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:16:58.603091 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m13:16:58.608097 [debug] [ThreadPool]: On list_schemas: Close
[0m13:16:58.610067 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m13:16:58.612059 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m13:16:58.618042 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:16:58.619041 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m13:16:58.619041 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:17:00.225464 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:17:00.228466 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:17:00.230461 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m13:17:00.852131 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m13:17:00.854132 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m13:17:00.855128 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:17:00.856126 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m13:17:01.458731 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:17:01.461733 [debug] [ThreadPool]: On create__site_dev: Close
[0m13:17:01.466497 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m13:17:01.474478 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m13:17:01.475476 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m13:17:01.476474 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:17:03.180787 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:17:03.183793 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m13:17:03.185790 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m13:17:03.785925 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:17:03.790890 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m13:17:03.988072 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m13:17:03.990070 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '13673db4-afa3-4ccd-977a-20548ef8309e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258FE572910>]}
[0m13:17:03.991066 [debug] [MainThread]: Using mysql connection "master"
[0m13:17:03.992064 [debug] [MainThread]: On master: BEGIN
[0m13:17:03.992064 [debug] [MainThread]: Opening a new connection, currently in state init
[0m13:17:05.547824 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:17:05.550827 [debug] [MainThread]: On master: COMMIT
[0m13:17:05.552827 [debug] [MainThread]: Using mysql connection "master"
[0m13:17:05.553817 [debug] [MainThread]: On master: COMMIT
[0m13:17:06.135267 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:17:06.137273 [debug] [MainThread]: On master: Close
[0m13:17:06.140266 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m13:17:06.144256 [info ] [MainThread]: 
[0m13:17:06.153984 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.Tactical_clicks_months_12
[0m13:17:06.154986 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.Tactical_clicks_months_12 ................. [RUN]
[0m13:17:06.156827 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.kasper_sindri_media.Tactical_clicks_months_12'
[0m13:17:06.157824 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.Tactical_clicks_months_12
[0m13:17:06.172784 [debug] [Thread-1 (]: Writing injected SQL for node "model.kasper_sindri_media.Tactical_clicks_months_12"
[0m13:17:06.174780 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.Tactical_clicks_months_12 (compile): 13:17:06.157824 => 13:17:06.173784
[0m13:17:06.175777 [debug] [Thread-1 (]: Began executing node model.kasper_sindri_media.Tactical_clicks_months_12
[0m13:17:06.221671 [debug] [Thread-1 (]: Writing runtime sql for node "model.kasper_sindri_media.Tactical_clicks_months_12"
[0m13:17:06.223647 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.Tactical_clicks_months_12"
[0m13:17:06.223647 [debug] [Thread-1 (]: On model.kasper_sindri_media.Tactical_clicks_months_12: BEGIN
[0m13:17:06.224647 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m13:17:07.771518 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:17:07.774508 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.Tactical_clicks_months_12"
[0m13:17:07.776494 [debug] [Thread-1 (]: On model.kasper_sindri_media.Tactical_clicks_months_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.kasper_sindri_media.Tactical_clicks_months_12"} */

  create view `site_dev`.`Tactical_clicks_months_12__dbt_tmp`
    
    
  as (
    








CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`(
    IN site INT,
    IN label VARCHAR(255),
    IN hint VARCHAR(255),
    IN event_name VARCHAR(255)
)
BEGIN
    WITH curr_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND categories <> "Nyhedsoverblik"
        AND siteid = site
    ),
    agg_curr_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks
        FROM prod.events e
        JOIN curr_30_days_article_published a ON a.id = e.postid
        WHERE e.date DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND e.siteid = site
        AND e.Event_Action = event_name
        GROUP BY 1
    ),
    agg_curr_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum
        FROM prod.pages p
        LEFT JOIN curr_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = site
        AND p.date DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        GROUP BY p.siteid
    ),
    value_curr_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks / p.pageview_sum * 100, 2) AS value
        FROM agg_curr_30_days_events e
        LEFT JOIN agg_curr_30_days_pages p ON e.siteid = p.siteid
    ),
    last_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        AND siteid = site
        AND categories <> "Nyhedsoverblik"
    ),
    agg_last_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks_last
        FROM prod.events e
        JOIN last_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        AND e.siteid = site
        AND e.Event_Action = event_name
        GROUP BY 1
    ),
    agg_last_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum_last
        FROM prod.pages p
        LEFT JOIN last_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = site
        AND p.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        GROUP BY p.siteid
    ),
    value_last_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks_last / p.pageview_sum_last * 100, 2) AS value_last
        FROM agg_last_30_days_events e
        LEFT JOIN agg_last_30_days_pages p ON e.siteid = p.siteid
    )
    SELECT 
        JSON_OBJECT(
            'site', al.siteid,
            'data', JSON_OBJECT(
                'label', 'Artikler',
                'hint', 'Artikler publiceret seneste 30 dage ift. forrige 30 dage',
                'value', COALESCE(value, 0),
                'change', COALESCE(value - value_last, 0),
                'progressCurrent', '',
                'progressTotal', ''
            )
        ) AS json_data
    FROM value_curr_30_days al
    LEFT JOIN value_last_30_days alb ON al.siteid = alb.siteid
    WHERE al.siteid = 12;
END;
  );
[0m13:17:08.355323 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`(
    IN site INT,
 ' at line 16
[0m13:17:08.358311 [debug] [Thread-1 (]: On model.kasper_sindri_media.Tactical_clicks_months_12: ROLLBACK
[0m13:17:08.563536 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.Tactical_clicks_months_12 (execute): 13:17:06.175777 => 13:17:08.562527
[0m13:17:08.566527 [debug] [Thread-1 (]: On model.kasper_sindri_media.Tactical_clicks_months_12: Close
[0m13:17:08.584475 [debug] [Thread-1 (]: Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`(
      IN site INT,
   ' at line 16
  compiled Code at target\run\kasper_sindri_media\models\example\Tactical_clicks_months_12.sql
[0m13:17:08.586471 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13673db4-afa3-4ccd-977a-20548ef8309e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258FE3477D0>]}
[0m13:17:08.587466 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.Tactical_clicks_months_12 ........ [[31mERROR[0m in 2.43s]
[0m13:17:08.590457 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.Tactical_clicks_months_12
[0m13:17:08.594142 [debug] [MainThread]: Using mysql connection "master"
[0m13:17:08.595139 [debug] [MainThread]: On master: BEGIN
[0m13:17:08.596136 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m13:17:10.150091 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:17:10.153086 [debug] [MainThread]: On master: COMMIT
[0m13:17:10.156076 [debug] [MainThread]: Using mysql connection "master"
[0m13:17:10.158080 [debug] [MainThread]: On master: COMMIT
[0m13:17:10.741610 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:17:10.743603 [debug] [MainThread]: On master: Close
[0m13:17:10.747590 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:17:10.749587 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m13:17:10.751581 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m13:17:10.753576 [debug] [MainThread]: Connection 'model.kasper_sindri_media.Tactical_clicks_months_12' was properly closed.
[0m13:17:10.755568 [info ] [MainThread]: 
[0m13:17:10.757607 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 13.72 seconds (13.72s).
[0m13:17:10.759596 [debug] [MainThread]: Command end result
[0m13:17:10.775553 [info ] [MainThread]: 
[0m13:17:10.776832 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m13:17:10.778987 [info ] [MainThread]: 
[0m13:17:10.779986 [error] [MainThread]:   Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`(
      IN site INT,
   ' at line 16
  compiled Code at target\run\kasper_sindri_media\models\example\Tactical_clicks_months_12.sql
[0m13:17:10.782188 [info ] [MainThread]: 
[0m13:17:10.782731 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m13:17:10.786426 [debug] [MainThread]: Command `dbt run` failed at 13:17:10.785430 after 14.55 seconds
[0m13:17:10.787423 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258F7840B10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258F7840AD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258FE5C0AD0>]}
[0m13:17:10.787423 [debug] [MainThread]: Flushing usage events
[0m13:20:55.859731 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C311191410>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C30E5D2990>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C3111C75D0>]}


============================== 13:20:55.867710 | bbff92b2-0a11-4ae5-91d8-cc55def5fdaa ==============================
[0m13:20:55.867710 [info ] [MainThread]: Running with dbt=1.7.17
[0m13:20:55.870703 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'version_check': 'True', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --models example.Tactical_clicks_months_12', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m13:20:56.147141 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'bbff92b2-0a11-4ae5-91d8-cc55def5fdaa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C30EB5FF50>]}
[0m13:20:56.223936 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'bbff92b2-0a11-4ae5-91d8-cc55def5fdaa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C3111CBBD0>]}
[0m13:20:56.226605 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m13:20:56.240490 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m13:20:56.365355 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m13:20:56.366353 [debug] [MainThread]: Partial parsing: updated file: kasper_sindri_media://models\example\Tactical_clicks_months_12.sql
[0m13:20:56.557839 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example.run_Tactical_clicks_months_12
[0m13:20:56.567837 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'bbff92b2-0a11-4ae5-91d8-cc55def5fdaa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C311614810>]}
[0m13:20:56.587758 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'bbff92b2-0a11-4ae5-91d8-cc55def5fdaa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C3117050D0>]}
[0m13:20:56.588756 [info ] [MainThread]: Found 13 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m13:20:56.589753 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bbff92b2-0a11-4ae5-91d8-cc55def5fdaa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C31151DA10>]}
[0m13:20:56.593744 [info ] [MainThread]: 
[0m13:20:56.595741 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m13:20:56.598657 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m13:20:56.613616 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m13:20:56.614619 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m13:20:56.615611 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:20:58.168349 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m13:20:58.175323 [debug] [ThreadPool]: On list_schemas: Close
[0m13:20:58.181392 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m13:20:58.184385 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m13:20:58.195354 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:20:58.196352 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m13:20:58.197351 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:20:59.792249 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:20:59.794241 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:20:59.796232 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m13:21:00.400041 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m13:21:00.405033 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m13:21:00.408020 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:21:00.411010 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m13:21:01.000200 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:21:01.003202 [debug] [ThreadPool]: On create__site_dev: Close
[0m13:21:01.014804 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m13:21:01.027770 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m13:21:01.028765 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m13:21:01.029763 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:21:02.606942 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:21:02.608934 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m13:21:02.611923 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m13:21:03.205295 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:21:03.210271 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m13:21:03.408766 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m13:21:03.413769 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bbff92b2-0a11-4ae5-91d8-cc55def5fdaa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C31143F490>]}
[0m13:21:03.415759 [debug] [MainThread]: Using mysql connection "master"
[0m13:21:03.417756 [debug] [MainThread]: On master: BEGIN
[0m13:21:03.419754 [debug] [MainThread]: Opening a new connection, currently in state init
[0m13:21:04.990910 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:21:04.993911 [debug] [MainThread]: On master: COMMIT
[0m13:21:04.995908 [debug] [MainThread]: Using mysql connection "master"
[0m13:21:04.996902 [debug] [MainThread]: On master: COMMIT
[0m13:21:05.584653 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:21:05.587639 [debug] [MainThread]: On master: Close
[0m13:21:05.592626 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m13:21:05.594621 [info ] [MainThread]: 
[0m13:21:05.606529 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.Tactical_clicks_months_12
[0m13:21:05.607524 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.Tactical_clicks_months_12 ................. [RUN]
[0m13:21:05.610126 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.kasper_sindri_media.Tactical_clicks_months_12'
[0m13:21:05.612120 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.Tactical_clicks_months_12
[0m13:21:05.628076 [debug] [Thread-1 (]: Writing injected SQL for node "model.kasper_sindri_media.Tactical_clicks_months_12"
[0m13:21:05.630079 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.Tactical_clicks_months_12 (compile): 13:21:05.612120 => 13:21:05.629074
[0m13:21:05.631069 [debug] [Thread-1 (]: Began executing node model.kasper_sindri_media.Tactical_clicks_months_12
[0m13:21:05.681934 [debug] [Thread-1 (]: Writing runtime sql for node "model.kasper_sindri_media.Tactical_clicks_months_12"
[0m13:21:05.683930 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.Tactical_clicks_months_12"
[0m13:21:05.684927 [debug] [Thread-1 (]: On model.kasper_sindri_media.Tactical_clicks_months_12: BEGIN
[0m13:21:05.685923 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m13:21:07.273857 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:21:07.275847 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.Tactical_clicks_months_12"
[0m13:21:07.278838 [debug] [Thread-1 (]: On model.kasper_sindri_media.Tactical_clicks_months_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.kasper_sindri_media.Tactical_clicks_months_12"} */

  create view `site_dev`.`Tactical_clicks_months_12__dbt_tmp`
    
    
  as (
    








CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
BEGIN
    WITH curr_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND categories <> "Nyhedsoverblik"
        AND siteid = site
    ),
    agg_curr_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks
        FROM prod.events e
        JOIN curr_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND e.siteid = site
        AND e.Event_Action = event_name
        GROUP BY 1
    ),
    agg_curr_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum
        FROM prod.pages p
        LEFT JOIN curr_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = site
        AND p.date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        GROUP BY p.siteid
    ),
    value_curr_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks / p.pageview_sum * 100, 2) AS value
        FROM agg_curr_30_days_events e
        LEFT JOIN agg_curr_30_days_pages p ON e.siteid = p.siteid
    ),
    last_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        AND siteid = site
        AND categories <> "Nyhedsoverblik"
    ),
    agg_last_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks_last
        FROM prod.events e
        JOIN last_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        AND e.siteid = site
        AND e.Event_Action = event_name
        GROUP BY 1
    ),
    agg_last_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum_last
        FROM prod.pages p
        LEFT JOIN last_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = site
        AND p.date BETWEEN BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        GROUP BY p.siteid
    ),
    value_last_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks_last / p.pageview_sum_last * 100, 2) AS value_last
        FROM agg_last_30_days_events e
        LEFT JOIN agg_last_30_days_pages p ON e.siteid = p.siteid
    )
    SELECT 
        JSON_OBJECT(
            'site', al.siteid,
            'data', JSON_OBJECT(
                'label', 'Artikler',
                'hint', 'Artikler publiceret seneste 30 dage ift. forrige 30 dage',
                'value', COALESCE(value, 0),
                'change', COALESCE(value - value_last, 0),
                'progressCurrent', '',
                'progressTotal', ''
            )
        ) AS json_data
    FROM value_curr_30_days al
    LEFT JOIN value_last_30_days alb ON al.siteid = alb.siteid
    WHERE al.siteid = 12;
END;
  );
[0m13:21:07.874791 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
BEGIN
    WITH cu' at line 16
[0m13:21:07.877783 [debug] [Thread-1 (]: On model.kasper_sindri_media.Tactical_clicks_months_12: ROLLBACK
[0m13:21:08.080983 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.Tactical_clicks_months_12 (execute): 13:21:05.632070 => 13:21:08.078980
[0m13:21:08.083975 [debug] [Thread-1 (]: On model.kasper_sindri_media.Tactical_clicks_months_12: Close
[0m13:21:08.099929 [debug] [Thread-1 (]: Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
  BEGIN
      WITH cu' at line 16
  compiled Code at target\run\kasper_sindri_media\models\example\Tactical_clicks_months_12.sql
[0m13:21:08.101924 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bbff92b2-0a11-4ae5-91d8-cc55def5fdaa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C31174C690>]}
[0m13:21:08.102921 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.Tactical_clicks_months_12 ........ [[31mERROR[0m in 2.49s]
[0m13:21:08.104916 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.Tactical_clicks_months_12
[0m13:21:08.107909 [debug] [MainThread]: Using mysql connection "master"
[0m13:21:08.108904 [debug] [MainThread]: On master: BEGIN
[0m13:21:08.109903 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m13:21:09.674506 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:21:09.676493 [debug] [MainThread]: On master: COMMIT
[0m13:21:09.678488 [debug] [MainThread]: Using mysql connection "master"
[0m13:21:09.679487 [debug] [MainThread]: On master: COMMIT
[0m13:21:10.287393 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:21:10.288391 [debug] [MainThread]: On master: Close
[0m13:21:10.291383 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:21:10.292381 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m13:21:10.293378 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m13:21:10.294375 [debug] [MainThread]: Connection 'model.kasper_sindri_media.Tactical_clicks_months_12' was properly closed.
[0m13:21:10.295372 [info ] [MainThread]: 
[0m13:21:10.296370 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 13.70 seconds (13.70s).
[0m13:21:10.298363 [debug] [MainThread]: Command end result
[0m13:21:10.319309 [info ] [MainThread]: 
[0m13:21:10.320305 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m13:21:10.321303 [info ] [MainThread]: 
[0m13:21:10.323298 [error] [MainThread]:   Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
  BEGIN
      WITH cu' at line 16
  compiled Code at target\run\kasper_sindri_media\models\example\Tactical_clicks_months_12.sql
[0m13:21:10.324300 [info ] [MainThread]: 
[0m13:21:10.326289 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m13:21:10.329281 [debug] [MainThread]: Command `dbt run` failed at 13:21:10.329281 after 14.56 seconds
[0m13:21:10.330282 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C30A650B10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C30A650AD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C31159FF50>]}
[0m13:21:10.331283 [debug] [MainThread]: Flushing usage events
[0m13:22:45.567421 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020636748550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020636227C10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020636395810>]}


============================== 13:22:45.575400 | 03dd57d6-eb5d-4421-bf98-4c758d6101fe ==============================
[0m13:22:45.575400 [info ] [MainThread]: Running with dbt=1.7.17
[0m13:22:45.577399 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'debug': 'False', 'warn_error': 'None', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models example.Tactical_clicks_months_12', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m13:22:45.857646 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '03dd57d6-eb5d-4421-bf98-4c758d6101fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020636915A50>]}
[0m13:22:45.939427 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '03dd57d6-eb5d-4421-bf98-4c758d6101fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020636937410>]}
[0m13:22:45.942418 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m13:22:45.956379 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m13:22:46.069329 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m13:22:46.070337 [debug] [MainThread]: Partial parsing: updated file: kasper_sindri_media://models\example\Tactical_clicks_months_12.sql
[0m13:22:46.261815 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example.run_Tactical_clicks_months_12
[0m13:22:46.272785 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '03dd57d6-eb5d-4421-bf98-4c758d6101fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020636C70950>]}
[0m13:22:46.292732 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '03dd57d6-eb5d-4421-bf98-4c758d6101fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020636C5FF90>]}
[0m13:22:46.293729 [info ] [MainThread]: Found 13 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m13:22:46.294727 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '03dd57d6-eb5d-4421-bf98-4c758d6101fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020636ADE290>]}
[0m13:22:46.297719 [info ] [MainThread]: 
[0m13:22:46.299630 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m13:22:46.303596 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m13:22:46.318562 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m13:22:46.319560 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m13:22:46.320551 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:22:47.898847 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m13:22:47.903822 [debug] [ThreadPool]: On list_schemas: Close
[0m13:22:47.905819 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m13:22:47.907815 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m13:22:47.914795 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:22:47.914795 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m13:22:47.915793 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:22:49.482770 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:22:49.484757 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:22:49.486749 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m13:22:50.163937 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m13:22:50.165932 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m13:22:50.166929 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:22:50.167929 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m13:22:50.745745 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:22:50.749734 [debug] [ThreadPool]: On create__site_dev: Close
[0m13:22:50.759946 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m13:22:50.773909 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m13:22:50.774907 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m13:22:50.775904 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:22:52.336110 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:22:52.337101 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m13:22:52.339099 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m13:22:52.939766 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:22:52.943777 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m13:22:53.140770 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m13:22:53.146783 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '03dd57d6-eb5d-4421-bf98-4c758d6101fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020636731F90>]}
[0m13:22:53.148778 [debug] [MainThread]: Using mysql connection "master"
[0m13:22:53.150770 [debug] [MainThread]: On master: BEGIN
[0m13:22:53.153773 [debug] [MainThread]: Opening a new connection, currently in state init
[0m13:22:54.758804 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:22:54.761785 [debug] [MainThread]: On master: COMMIT
[0m13:22:54.762782 [debug] [MainThread]: Using mysql connection "master"
[0m13:22:54.764781 [debug] [MainThread]: On master: COMMIT
[0m13:22:55.370157 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:22:55.371154 [debug] [MainThread]: On master: Close
[0m13:22:55.373148 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m13:22:55.376142 [info ] [MainThread]: 
[0m13:22:55.383122 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.Tactical_clicks_months_12
[0m13:22:55.385117 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.Tactical_clicks_months_12 ................. [RUN]
[0m13:22:55.388108 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.kasper_sindri_media.Tactical_clicks_months_12'
[0m13:22:55.389106 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.Tactical_clicks_months_12
[0m13:22:55.421021 [debug] [Thread-1 (]: Writing injected SQL for node "model.kasper_sindri_media.Tactical_clicks_months_12"
[0m13:22:55.426023 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.Tactical_clicks_months_12 (compile): 13:22:55.390103 => 13:22:55.423016
[0m13:22:55.428999 [debug] [Thread-1 (]: Began executing node model.kasper_sindri_media.Tactical_clicks_months_12
[0m13:22:55.522748 [debug] [Thread-1 (]: Writing runtime sql for node "model.kasper_sindri_media.Tactical_clicks_months_12"
[0m13:22:55.526738 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.Tactical_clicks_months_12"
[0m13:22:55.531725 [debug] [Thread-1 (]: On model.kasper_sindri_media.Tactical_clicks_months_12: BEGIN
[0m13:22:55.532722 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m13:22:57.210577 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:22:57.216553 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.Tactical_clicks_months_12"
[0m13:22:57.219558 [debug] [Thread-1 (]: On model.kasper_sindri_media.Tactical_clicks_months_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.kasper_sindri_media.Tactical_clicks_months_12"} */

  create view `site_dev`.`Tactical_clicks_months_12__dbt_tmp`
    
    
  as (
    








CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
BEGIN
    WITH curr_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND categories <> "Nyhedsoverblik"
        AND siteid = 12
    ),
    agg_curr_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks
        FROM prod.events e
        JOIN curr_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND e.siteid = 12
        AND e.Event_Action = Next Click
        GROUP BY 1
    ),
    agg_curr_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum
        FROM prod.pages p
        LEFT JOIN curr_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = 12
        AND p.date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        GROUP BY p.siteid
    ),
    value_curr_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks / p.pageview_sum * 100, 2) AS value
        FROM agg_curr_30_days_events e
        LEFT JOIN agg_curr_30_days_pages p ON e.siteid = p.siteid
    ),
    last_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        AND siteid = site
        AND categories <> "Nyhedsoverblik"
    ),
    agg_last_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks_last
        FROM prod.events e
        JOIN last_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        AND e.siteid = 12
        AND e.Event_Action = Next Click
        GROUP BY 1
    ),
    agg_last_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum_last
        FROM prod.pages p
        LEFT JOIN last_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = 12
        AND p.date BETWEEN BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        GROUP BY p.siteid
    ),
    value_last_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks_last / p.pageview_sum_last * 100, 2) AS value_last
        FROM agg_last_30_days_events e
        LEFT JOIN agg_last_30_days_pages p ON e.siteid = p.siteid
    )
    SELECT 
        JSON_OBJECT(
            'site', al.siteid,
            'data', JSON_OBJECT(
                'label', 'Artikler',
                'hint', 'Artikler publiceret seneste 30 dage ift. forrige 30 dage',
                'value', COALESCE(value, 0),
                'change', COALESCE(value - value_last, 0),
                'progressCurrent', '',
                'progressTotal', ''
            )
        ) AS json_data
    FROM value_curr_30_days al
    LEFT JOIN value_last_30_days alb ON al.siteid = alb.siteid
    WHERE al.siteid = 12;
END;
  );
[0m13:22:57.809004 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
BEGIN
    WITH cu' at line 16
[0m13:22:57.810998 [debug] [Thread-1 (]: On model.kasper_sindri_media.Tactical_clicks_months_12: ROLLBACK
[0m13:22:58.019101 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.Tactical_clicks_months_12 (execute): 13:22:55.429996 => 13:22:58.017108
[0m13:22:58.023088 [debug] [Thread-1 (]: On model.kasper_sindri_media.Tactical_clicks_months_12: Close
[0m13:22:58.039047 [debug] [Thread-1 (]: Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
  BEGIN
      WITH cu' at line 16
  compiled Code at target\run\kasper_sindri_media\models\example\Tactical_clicks_months_12.sql
[0m13:22:58.041041 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '03dd57d6-eb5d-4421-bf98-4c758d6101fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020636CE2990>]}
[0m13:22:58.045030 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.Tactical_clicks_months_12 ........ [[31mERROR[0m in 2.65s]
[0m13:22:58.047024 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.Tactical_clicks_months_12
[0m13:22:58.053008 [debug] [MainThread]: Using mysql connection "master"
[0m13:22:58.055003 [debug] [MainThread]: On master: BEGIN
[0m13:22:58.058034 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m13:22:59.658574 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:22:59.661574 [debug] [MainThread]: On master: COMMIT
[0m13:22:59.663570 [debug] [MainThread]: Using mysql connection "master"
[0m13:22:59.663570 [debug] [MainThread]: On master: COMMIT
[0m13:23:00.266863 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:23:00.270889 [debug] [MainThread]: On master: Close
[0m13:23:00.273879 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:23:00.275867 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m13:23:00.275867 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m13:23:00.276862 [debug] [MainThread]: Connection 'model.kasper_sindri_media.Tactical_clicks_months_12' was properly closed.
[0m13:23:00.277860 [info ] [MainThread]: 
[0m13:23:00.279858 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 13.98 seconds (13.98s).
[0m13:23:00.281892 [debug] [MainThread]: Command end result
[0m13:23:00.297850 [info ] [MainThread]: 
[0m13:23:00.299803 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m13:23:00.301469 [info ] [MainThread]: 
[0m13:23:00.304452 [error] [MainThread]:   Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
  BEGIN
      WITH cu' at line 16
  compiled Code at target\run\kasper_sindri_media\models\example\Tactical_clicks_months_12.sql
[0m13:23:00.305447 [info ] [MainThread]: 
[0m13:23:00.309865 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m13:23:00.313726 [debug] [MainThread]: Command `dbt run` failed at 13:23:00.312728 after 14.83 seconds
[0m13:23:00.313726 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020636749D90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020636789510>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000206367B16D0>]}
[0m13:23:00.315721 [debug] [MainThread]: Flushing usage events
[0m13:23:53.888011 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EE103427D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EE10384390>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EE10386950>]}


============================== 13:23:53.894992 | d558020f-150f-478a-a23c-17a73fd6d05b ==============================
[0m13:23:53.894992 [info ] [MainThread]: Running with dbt=1.7.17
[0m13:26:33.791768 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models example.Tactical_clicks_months_12', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m13:26:34.082367 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd558020f-150f-478a-a23c-17a73fd6d05b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EE0FE403D0>]}
[0m13:26:34.162153 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd558020f-150f-478a-a23c-17a73fd6d05b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EE10362190>]}
[0m13:26:34.164981 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m13:26:34.176926 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m13:26:34.291143 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m13:26:34.293121 [debug] [MainThread]: Partial parsing: updated file: kasper_sindri_media://models\example\Tactical_clicks_months_12.sql
[0m13:26:34.483613 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example.run_Tactical_clicks_months_12
[0m13:26:34.493586 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd558020f-150f-478a-a23c-17a73fd6d05b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EE107D7010>]}
[0m13:26:34.513531 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd558020f-150f-478a-a23c-17a73fd6d05b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EE1088C450>]}
[0m13:26:34.514529 [info ] [MainThread]: Found 13 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m13:26:34.515526 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd558020f-150f-478a-a23c-17a73fd6d05b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EE106EE110>]}
[0m13:26:34.518517 [info ] [MainThread]: 
[0m13:26:34.519514 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m13:26:34.522508 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m13:26:34.536481 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m13:26:34.536481 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m13:26:34.537469 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:26:36.160643 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m13:26:36.165622 [debug] [ThreadPool]: On list_schemas: Close
[0m13:26:36.167617 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m13:26:36.169611 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m13:26:36.176595 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:26:36.177591 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m13:26:36.178587 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:26:37.769476 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:26:37.771480 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:26:37.773476 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m13:26:38.365166 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m13:26:38.367164 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m13:26:38.368162 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:26:38.368162 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m13:26:39.230170 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:26:39.232165 [debug] [ThreadPool]: On create__site_dev: Close
[0m13:26:39.240144 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m13:26:39.254109 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m13:26:39.256101 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m13:26:39.257099 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:26:40.983396 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:26:40.987390 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m13:26:40.992374 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m13:26:41.585064 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:26:41.589055 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m13:26:41.784728 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m13:26:41.871574 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd558020f-150f-478a-a23c-17a73fd6d05b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EE10395950>]}
[0m13:26:41.873568 [debug] [MainThread]: Using mysql connection "master"
[0m13:26:41.874565 [debug] [MainThread]: On master: BEGIN
[0m13:26:41.875563 [debug] [MainThread]: Opening a new connection, currently in state init
[0m13:26:43.421769 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:26:43.424740 [debug] [MainThread]: On master: COMMIT
[0m13:26:43.427732 [debug] [MainThread]: Using mysql connection "master"
[0m13:26:43.430726 [debug] [MainThread]: On master: COMMIT
[0m13:26:44.015317 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:26:44.017320 [debug] [MainThread]: On master: Close
[0m13:26:44.019311 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m13:26:44.021305 [info ] [MainThread]: 
[0m13:26:44.027254 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.Tactical_clicks_months_12
[0m13:26:44.028255 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.Tactical_clicks_months_12 ................. [RUN]
[0m13:26:44.030136 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.kasper_sindri_media.Tactical_clicks_months_12'
[0m13:26:44.031133 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.Tactical_clicks_months_12
[0m13:26:44.046093 [debug] [Thread-1 (]: Writing injected SQL for node "model.kasper_sindri_media.Tactical_clicks_months_12"
[0m13:26:44.048088 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.Tactical_clicks_months_12 (compile): 13:26:44.031133 => 13:26:44.048088
[0m13:26:44.049085 [debug] [Thread-1 (]: Began executing node model.kasper_sindri_media.Tactical_clicks_months_12
[0m13:26:44.102942 [debug] [Thread-1 (]: Writing runtime sql for node "model.kasper_sindri_media.Tactical_clicks_months_12"
[0m13:26:44.104936 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.Tactical_clicks_months_12"
[0m13:26:44.105934 [debug] [Thread-1 (]: On model.kasper_sindri_media.Tactical_clicks_months_12: BEGIN
[0m13:26:44.106931 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m13:26:45.643580 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:26:45.645534 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.Tactical_clicks_months_12"
[0m13:26:45.647644 [debug] [Thread-1 (]: On model.kasper_sindri_media.Tactical_clicks_months_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.kasper_sindri_media.Tactical_clicks_months_12"} */

  create view `site_dev`.`Tactical_clicks_months_12__dbt_tmp`
    
    
  as (
    








CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
BEGIN
    WITH curr_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND categories <> "Nyhedsoverblik"
        AND siteid = 12
    ),
    agg_curr_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks
        FROM prod.events e
        JOIN curr_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND e.siteid = 12
        AND e.Event_Action = 'Next Click'
        GROUP BY 1
    ),
    agg_curr_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum
        FROM prod.pages p
        LEFT JOIN curr_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = 12
        AND p.date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        GROUP BY p.siteid
    ),
    value_curr_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks / p.pageview_sum * 100, 2) AS value
        FROM agg_curr_30_days_events e
        LEFT JOIN agg_curr_30_days_pages p ON e.siteid = p.siteid
    ),
    last_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        AND siteid = site
        AND categories <> "Nyhedsoverblik"
    ),
    agg_last_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks_last
        FROM prod.events e
        JOIN last_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        AND e.siteid = 12
        AND e.Event_Action = 'Next Click'
        GROUP BY 1
    ),
    agg_last_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum_last
        FROM prod.pages p
        LEFT JOIN last_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = 12
        AND p.date BETWEEN BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        GROUP BY p.siteid
    ),
    value_last_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks_last / p.pageview_sum_last * 100, 2) AS value_last
        FROM agg_last_30_days_events e
        LEFT JOIN agg_last_30_days_pages p ON e.siteid = p.siteid
    )
    SELECT 
        JSON_OBJECT(
            'site', al.siteid,
            'data', JSON_OBJECT(
                'label', 'Artikler',
                'hint', 'Artikler publiceret seneste 30 dage ift. forrige 30 dage',
                'value', COALESCE(value, 0),
                'change', COALESCE(value - value_last, 0),
                'progressCurrent', '',
                'progressTotal', ''
            )
        ) AS json_data
    FROM value_curr_30_days al
    LEFT JOIN value_last_30_days alb ON al.siteid = alb.siteid
    WHERE al.siteid = 12;
END;
  );
[0m13:26:46.225064 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
BEGIN
    WITH cu' at line 16
[0m13:26:46.228007 [debug] [Thread-1 (]: On model.kasper_sindri_media.Tactical_clicks_months_12: ROLLBACK
[0m13:26:46.425236 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.Tactical_clicks_months_12 (execute): 13:26:44.050083 => 13:26:46.423201
[0m13:26:46.427207 [debug] [Thread-1 (]: On model.kasper_sindri_media.Tactical_clicks_months_12: Close
[0m13:26:46.436173 [debug] [Thread-1 (]: Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
  BEGIN
      WITH cu' at line 16
  compiled Code at target\run\kasper_sindri_media\models\example\Tactical_clicks_months_12.sql
[0m13:26:46.437169 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd558020f-150f-478a-a23c-17a73fd6d05b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EE10931490>]}
[0m13:26:46.439165 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.Tactical_clicks_months_12 ........ [[31mERROR[0m in 2.41s]
[0m13:26:46.440162 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.Tactical_clicks_months_12
[0m13:26:46.443156 [debug] [MainThread]: Using mysql connection "master"
[0m13:26:46.444153 [debug] [MainThread]: On master: BEGIN
[0m13:26:46.445150 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m13:26:47.986718 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:26:47.988714 [debug] [MainThread]: On master: COMMIT
[0m13:26:47.989710 [debug] [MainThread]: Using mysql connection "master"
[0m13:26:47.992703 [debug] [MainThread]: On master: COMMIT
[0m13:26:48.572894 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:26:48.574887 [debug] [MainThread]: On master: Close
[0m13:26:48.579872 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:26:48.582865 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m13:26:48.585860 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m13:26:48.590845 [debug] [MainThread]: Connection 'model.kasper_sindri_media.Tactical_clicks_months_12' was properly closed.
[0m13:26:48.593835 [info ] [MainThread]: 
[0m13:26:48.599821 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 14.07 seconds (14.07s).
[0m13:26:48.605817 [debug] [MainThread]: Command end result
[0m13:26:48.632729 [info ] [MainThread]: 
[0m13:26:48.633729 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m13:26:48.635722 [info ] [MainThread]: 
[0m13:26:48.636719 [error] [MainThread]:   Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
  BEGIN
      WITH cu' at line 16
  compiled Code at target\run\kasper_sindri_media\models\example\Tactical_clicks_months_12.sql
[0m13:26:48.637715 [info ] [MainThread]: 
[0m13:26:48.638720 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m13:26:48.640708 [debug] [MainThread]: Command `dbt run` failed at 13:26:48.640708 after 174.84 seconds
[0m13:26:48.641705 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EE10359410>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EE1036D450>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EE097E0B10>]}
[0m13:26:48.642703 [debug] [MainThread]: Flushing usage events
[0m13:28:02.471914 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025ECAC37750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025ECD968050>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025ECD332890>]}


============================== 13:28:02.478894 | b3a702aa-a7f1-41bb-b899-0f795de6c652 ==============================
[0m13:28:02.478894 [info ] [MainThread]: Running with dbt=1.7.17
[0m13:28:02.480889 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models example.tactical_articles_card_month_12', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m13:28:02.781230 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'b3a702aa-a7f1-41bb-b899-0f795de6c652', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025ECE11D050>]}
[0m13:28:02.889938 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'b3a702aa-a7f1-41bb-b899-0f795de6c652', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025ECDF0E390>]}
[0m13:28:02.893305 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m13:28:02.908155 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m13:28:02.932590 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m13:28:02.934585 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'b3a702aa-a7f1-41bb-b899-0f795de6c652', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025ECE1C3F90>]}
[0m13:28:04.621074 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example.run_Tactical_clicks_months_12
[0m13:28:04.630047 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'b3a702aa-a7f1-41bb-b899-0f795de6c652', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025ECE25E950>]}
[0m13:28:04.650992 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'b3a702aa-a7f1-41bb-b899-0f795de6c652', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025ECE3FEDD0>]}
[0m13:28:04.651989 [info ] [MainThread]: Found 13 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m13:28:04.653984 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b3a702aa-a7f1-41bb-b899-0f795de6c652', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025ECE4586D0>]}
[0m13:28:04.657972 [info ] [MainThread]: 
[0m13:28:04.660292 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m13:28:04.662696 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m13:28:04.677681 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m13:28:04.678654 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m13:28:04.678654 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:28:06.221521 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m13:28:06.227506 [debug] [ThreadPool]: On list_schemas: Close
[0m13:28:06.232795 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m13:28:06.236783 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m13:28:06.247752 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:28:06.248751 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m13:28:06.249748 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:28:07.812067 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:28:07.813069 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:28:07.813069 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m13:28:08.397042 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m13:28:08.399035 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m13:28:08.400034 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:28:08.403026 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m13:28:08.980052 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:28:08.983039 [debug] [ThreadPool]: On create__site_dev: Close
[0m13:28:08.994926 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m13:28:09.018861 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m13:28:09.020855 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m13:28:09.021854 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:28:10.707784 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:28:10.710778 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m13:28:10.713769 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m13:28:11.307634 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:28:11.309629 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m13:28:11.523994 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m13:28:11.525990 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b3a702aa-a7f1-41bb-b899-0f795de6c652', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025ECE2FFD90>]}
[0m13:28:11.527983 [debug] [MainThread]: Using mysql connection "master"
[0m13:28:11.528980 [debug] [MainThread]: On master: BEGIN
[0m13:28:11.529977 [debug] [MainThread]: Opening a new connection, currently in state init
[0m13:28:13.230444 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:28:13.232423 [debug] [MainThread]: On master: COMMIT
[0m13:28:13.233422 [debug] [MainThread]: Using mysql connection "master"
[0m13:28:13.234421 [debug] [MainThread]: On master: COMMIT
[0m13:28:13.816859 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:28:13.818855 [debug] [MainThread]: On master: Close
[0m13:28:13.820849 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m13:28:13.825835 [info ] [MainThread]: 
[0m13:28:13.835808 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.tactical_articles_card_month_12
[0m13:28:13.838801 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.tactical_articles_card_month_12 ........... [RUN]
[0m13:28:13.842789 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.kasper_sindri_media.tactical_articles_card_month_12'
[0m13:28:13.844784 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.tactical_articles_card_month_12
[0m13:28:13.884678 [debug] [Thread-1 (]: Writing injected SQL for node "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m13:28:13.886672 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.tactical_articles_card_month_12 (compile): 13:28:13.847778 => 13:28:13.886672
[0m13:28:13.890663 [debug] [Thread-1 (]: Began executing node model.kasper_sindri_media.tactical_articles_card_month_12
[0m13:28:14.048241 [debug] [Thread-1 (]: Writing runtime sql for node "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m13:28:14.050235 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m13:28:14.052230 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: BEGIN
[0m13:28:14.054225 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m13:28:15.657941 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:28:15.658944 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.tactical_articles_card_month_12"
[0m13:28:15.660939 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.kasper_sindri_media.tactical_articles_card_month_12"} */

  create view `site_dev`.`tactical_articles_card_month_12__dbt_tmp`
    
    
  as (
    





CREATE PROCEDURE `prod`.`tactical_articles_card_month_12_test_dbt`()
BEGIN
    WITH last_30_day AS (
        SELECT siteId as siteId, COUNT(date) as value 
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND categories <> "Nyhedsoverblik"
        AND siteid = '12'
        GROUP BY 1
    ),
    last_30_days_before AS (
        SELECT siteId as siteId, COUNT(*) as value  
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND categories <> "Nyhedsoverblik"
        AND siteid = '12'
        GROUP BY 1
    )
    SELECT
        JSON_OBJECT(
            'site', ld.siteId,
            'data', JSON_OBJECT(
                'label', 'Artikler',
                'hint', 'Artikler publiceret seneste 30 dage ift. forrige 30 dage',
                'value', COALESCE(ld.value, 0),
                'change', COALESCE(ROUND(((ld.value - lb.value) / lb.value) * 100, 2), 0),
                'progressCurrent', '',
                'progressTotal', ''
            )
        ) AS json_data
    FROM last_30_day ld
    LEFT JOIN last_30_days_before lb ON ld.siteId = lb.siteId;
END;
  );
[0m13:28:16.252355 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_month_12_test_dbt`()
BEGIN
    W' at line 13
[0m13:28:16.254350 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: ROLLBACK
[0m13:28:16.453817 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.tactical_articles_card_month_12 (execute): 13:28:13.891663 => 13:28:16.452818
[0m13:28:16.454814 [debug] [Thread-1 (]: On model.kasper_sindri_media.tactical_articles_card_month_12: Close
[0m13:28:16.471767 [debug] [Thread-1 (]: Database Error in model tactical_articles_card_month_12 (models\example\tactical_articles_card_month_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_month_12_test_dbt`()
  BEGIN
      W' at line 13
  compiled Code at target\run\kasper_sindri_media\models\example\tactical_articles_card_month_12.sql
[0m13:28:16.472766 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b3a702aa-a7f1-41bb-b899-0f795de6c652', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025ECE2B0BD0>]}
[0m13:28:16.473762 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.tactical_articles_card_month_12 .. [[31mERROR[0m in 2.63s]
[0m13:28:16.476765 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.tactical_articles_card_month_12
[0m13:28:16.481741 [debug] [MainThread]: Using mysql connection "master"
[0m13:28:16.482738 [debug] [MainThread]: On master: BEGIN
[0m13:28:16.483736 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m13:28:18.299589 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:28:18.301578 [debug] [MainThread]: On master: COMMIT
[0m13:28:18.302574 [debug] [MainThread]: Using mysql connection "master"
[0m13:28:18.304570 [debug] [MainThread]: On master: COMMIT
[0m13:28:18.890945 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:28:18.893937 [debug] [MainThread]: On master: Close
[0m13:28:18.895930 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:28:18.896928 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m13:28:18.898924 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m13:28:18.899920 [debug] [MainThread]: Connection 'model.kasper_sindri_media.tactical_articles_card_month_12' was properly closed.
[0m13:28:18.901916 [info ] [MainThread]: 
[0m13:28:18.906901 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 14.24 seconds (14.24s).
[0m13:28:18.910892 [debug] [MainThread]: Command end result
[0m13:28:18.938818 [info ] [MainThread]: 
[0m13:28:18.942806 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m13:28:18.949788 [info ] [MainThread]: 
[0m13:28:18.953777 [error] [MainThread]:   Database Error in model tactical_articles_card_month_12 (models\example\tactical_articles_card_month_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_month_12_test_dbt`()
  BEGIN
      W' at line 13
  compiled Code at target\run\kasper_sindri_media\models\example\tactical_articles_card_month_12.sql
[0m13:28:18.955772 [info ] [MainThread]: 
[0m13:28:18.958763 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m13:28:18.964748 [debug] [MainThread]: Command `dbt run` failed at 13:28:18.963750 after 16.60 seconds
[0m13:28:18.966743 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025ECDF16310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025EC74A0B10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025EC74A0AD0>]}
[0m13:28:18.967739 [debug] [MainThread]: Flushing usage events
[0m13:28:59.828902 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B1E7ACA90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B1E3E10D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B1E7AC4D0>]}


============================== 13:28:59.834882 | 3415d709-7550-4958-98da-2e20c9b0a9ae ==============================
[0m13:28:59.834882 [info ] [MainThread]: Running with dbt=1.7.17
[0m13:28:59.837876 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models example.Tactical_clicks_months_12', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m13:29:00.132774 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3415d709-7550-4958-98da-2e20c9b0a9ae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B1E996D50>]}
[0m13:29:00.216549 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3415d709-7550-4958-98da-2e20c9b0a9ae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B1E7AC950>]}
[0m13:29:00.218341 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m13:29:00.232232 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m13:29:00.355515 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m13:29:00.356510 [debug] [MainThread]: Partial parsing: updated file: kasper_sindri_media://models\example\Tactical_clicks_months_12.sql
[0m13:29:00.549995 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example.run_Tactical_clicks_months_12
[0m13:29:00.559967 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3415d709-7550-4958-98da-2e20c9b0a9ae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B1ECD8C10>]}
[0m13:29:00.580912 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3415d709-7550-4958-98da-2e20c9b0a9ae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B1EB61850>]}
[0m13:29:00.581911 [info ] [MainThread]: Found 13 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m13:29:00.583910 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3415d709-7550-4958-98da-2e20c9b0a9ae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B1EB3AA90>]}
[0m13:29:00.587893 [info ] [MainThread]: 
[0m13:29:00.589888 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m13:29:00.592799 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m13:29:00.608783 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m13:29:00.609788 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m13:29:00.610750 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:29:02.348009 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m13:29:02.354950 [debug] [ThreadPool]: On list_schemas: Close
[0m13:29:02.361408 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m13:29:02.364398 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m13:29:02.375367 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:29:02.376364 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m13:29:02.377362 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:29:04.036299 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:29:04.040313 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:29:04.043304 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m13:29:04.709901 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m13:29:04.715881 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m13:29:04.717878 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:29:04.719873 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m13:29:05.381293 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:29:05.383296 [debug] [ThreadPool]: On create__site_dev: Close
[0m13:29:05.389276 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m13:29:05.397254 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m13:29:05.398252 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m13:29:05.398252 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:29:07.039686 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:29:07.041727 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m13:29:07.043686 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m13:29:07.667255 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:29:07.669250 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m13:29:07.867720 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m13:29:07.869717 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3415d709-7550-4958-98da-2e20c9b0a9ae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B1E976A90>]}
[0m13:29:07.871710 [debug] [MainThread]: Using mysql connection "master"
[0m13:29:07.872706 [debug] [MainThread]: On master: BEGIN
[0m13:29:07.873704 [debug] [MainThread]: Opening a new connection, currently in state init
[0m13:29:09.528958 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:29:09.529955 [debug] [MainThread]: On master: COMMIT
[0m13:29:09.531949 [debug] [MainThread]: Using mysql connection "master"
[0m13:29:09.532947 [debug] [MainThread]: On master: COMMIT
[0m13:29:10.121445 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:29:10.124451 [debug] [MainThread]: On master: Close
[0m13:29:10.127435 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m13:29:10.128441 [info ] [MainThread]: 
[0m13:29:10.134183 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.Tactical_clicks_months_12
[0m13:29:10.135185 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.Tactical_clicks_months_12 ................. [RUN]
[0m13:29:10.137036 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.kasper_sindri_media.Tactical_clicks_months_12'
[0m13:29:10.137036 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.Tactical_clicks_months_12
[0m13:29:10.151995 [debug] [Thread-1 (]: Writing injected SQL for node "model.kasper_sindri_media.Tactical_clicks_months_12"
[0m13:29:10.152993 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.Tactical_clicks_months_12 (compile): 13:29:10.138033 => 13:29:10.152993
[0m13:29:10.154988 [debug] [Thread-1 (]: Began executing node model.kasper_sindri_media.Tactical_clicks_months_12
[0m13:29:10.200864 [debug] [Thread-1 (]: Writing runtime sql for node "model.kasper_sindri_media.Tactical_clicks_months_12"
[0m13:29:10.202859 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.Tactical_clicks_months_12"
[0m13:29:10.203857 [debug] [Thread-1 (]: On model.kasper_sindri_media.Tactical_clicks_months_12: BEGIN
[0m13:29:10.204854 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m13:29:11.783610 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:29:11.784612 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.Tactical_clicks_months_12"
[0m13:29:11.785609 [debug] [Thread-1 (]: On model.kasper_sindri_media.Tactical_clicks_months_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.kasper_sindri_media.Tactical_clicks_months_12"} */

  create view `site_dev`.`Tactical_clicks_months_12__dbt_tmp`
    
    
  as (
    








CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
BEGIN
    WITH curr_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND categories <> "Nyhedsoverblik"
        AND siteid = '12'
    ),
    agg_curr_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks
        FROM prod.events e
        JOIN curr_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND e.siteid = '12'
        AND e.Event_Action = 'Next Click'
        GROUP BY 1
    ),
    agg_curr_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum
        FROM prod.pages p
        LEFT JOIN curr_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = '12'
        AND p.date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        GROUP BY p.siteid
    ),
    value_curr_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks / p.pageview_sum * 100, 2) AS value
        FROM agg_curr_30_days_events e
        LEFT JOIN agg_curr_30_days_pages p ON e.siteid = p.siteid
    ),
    last_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        AND siteid = site
        AND categories <> "Nyhedsoverblik"
    ),
    agg_last_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks_last
        FROM prod.events e
        JOIN last_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        AND e.siteid = '12'
        AND e.Event_Action = 'Next Click'
        GROUP BY 1
    ),
    agg_last_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum_last
        FROM prod.pages p
        LEFT JOIN last_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = '12'
        AND p.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        GROUP BY p.siteid
    ),
    value_last_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks_last / p.pageview_sum_last * 100, 2) AS value_last
        FROM agg_last_30_days_events e
        LEFT JOIN agg_last_30_days_pages p ON e.siteid = p.siteid
    )
    SELECT 
        JSON_OBJECT(
            'site', al.siteid,
            'data', JSON_OBJECT(
                'label', 'Artikler',
                'hint', 'Artikler publiceret seneste 30 dage ift. forrige 30 dage',
                'value', COALESCE(value, 0),
                'change', COALESCE(value - value_last, 0),
                'progressCurrent', '',
                'progressTotal', ''
            )
        ) AS json_data
    FROM value_curr_30_days al
    LEFT JOIN value_last_30_days alb ON al.siteid = alb.siteid
    WHERE al.siteid = '12';
END;
  );
[0m13:29:12.379539 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
BEGIN
    WITH cu' at line 16
[0m13:29:12.380539 [debug] [Thread-1 (]: On model.kasper_sindri_media.Tactical_clicks_months_12: ROLLBACK
[0m13:29:12.580243 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.Tactical_clicks_months_12 (execute): 13:29:10.155988 => 13:29:12.578238
[0m13:29:12.583235 [debug] [Thread-1 (]: On model.kasper_sindri_media.Tactical_clicks_months_12: Close
[0m13:29:12.601217 [debug] [Thread-1 (]: Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
  BEGIN
      WITH cu' at line 16
  compiled Code at target\run\kasper_sindri_media\models\example\Tactical_clicks_months_12.sql
[0m13:29:12.603183 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3415d709-7550-4958-98da-2e20c9b0a9ae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B1EC38310>]}
[0m13:29:12.605178 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.Tactical_clicks_months_12 ........ [[31mERROR[0m in 2.47s]
[0m13:29:12.607172 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.Tactical_clicks_months_12
[0m13:29:12.610579 [debug] [MainThread]: Using mysql connection "master"
[0m13:29:12.611577 [debug] [MainThread]: On master: BEGIN
[0m13:29:12.612570 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m13:29:14.152453 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:29:14.155429 [debug] [MainThread]: On master: COMMIT
[0m13:29:14.158421 [debug] [MainThread]: Using mysql connection "master"
[0m13:29:14.161425 [debug] [MainThread]: On master: COMMIT
[0m13:29:14.743027 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:29:14.746029 [debug] [MainThread]: On master: Close
[0m13:29:14.749024 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:29:14.750015 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m13:29:14.751013 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m13:29:14.751013 [debug] [MainThread]: Connection 'model.kasper_sindri_media.Tactical_clicks_months_12' was properly closed.
[0m13:29:14.752009 [info ] [MainThread]: 
[0m13:29:14.753008 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 14.16 seconds (14.16s).
[0m13:29:14.755241 [debug] [MainThread]: Command end result
[0m13:29:14.767211 [info ] [MainThread]: 
[0m13:29:14.768322 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m13:29:14.769476 [info ] [MainThread]: 
[0m13:29:14.770457 [error] [MainThread]:   Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
  BEGIN
      WITH cu' at line 16
  compiled Code at target\run\kasper_sindri_media\models\example\Tactical_clicks_months_12.sql
[0m13:29:14.772671 [info ] [MainThread]: 
[0m13:29:14.773240 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m13:29:14.776236 [debug] [MainThread]: Command `dbt run` failed at 13:29:14.776236 after 15.04 seconds
[0m13:29:14.777233 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B1E7ACED0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B17CB0B10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B17CB0AD0>]}
[0m13:29:14.777233 [debug] [MainThread]: Flushing usage events
[0m13:31:46.492470 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000214D9CFAA10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000214D9CF8DD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000214D9CFBB10>]}


============================== 13:31:46.499416 | c2475045-3de1-4773-b874-e6ed1c3fd816 ==============================
[0m13:31:46.499416 [info ] [MainThread]: Running with dbt=1.7.17
[0m13:31:46.501410 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'version_check': 'True', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models example.Tactical_clicks_months_12', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m13:31:46.775678 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c2475045-3de1-4773-b874-e6ed1c3fd816', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000214D9D2FA90>]}
[0m13:31:46.854467 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c2475045-3de1-4773-b874-e6ed1c3fd816', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000214D8B0C990>]}
[0m13:31:46.857459 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m13:31:46.868464 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m13:31:46.978135 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m13:31:46.978135 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m13:31:46.980149 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example.run_Tactical_clicks_months_12
[0m13:31:46.988207 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c2475045-3de1-4773-b874-e6ed1c3fd816', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000214DA0CD190>]}
[0m13:31:47.008153 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c2475045-3de1-4773-b874-e6ed1c3fd816', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000214D9FFC650>]}
[0m13:31:47.010147 [info ] [MainThread]: Found 13 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m13:31:47.011144 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c2475045-3de1-4773-b874-e6ed1c3fd816', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000214D9F63150>]}
[0m13:31:47.013139 [info ] [MainThread]: 
[0m13:31:47.016131 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m13:31:47.018834 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m13:31:47.032817 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m13:31:47.033832 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m13:31:47.034792 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:31:48.612947 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m13:31:48.617929 [debug] [ThreadPool]: On list_schemas: Close
[0m13:31:48.619922 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m13:31:48.621915 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m13:31:48.627899 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:31:48.628896 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m13:31:48.629895 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:31:50.236536 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:31:50.238524 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:31:50.241519 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m13:31:50.835801 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m13:31:50.840797 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m13:31:50.841791 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:31:50.842803 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m13:31:51.423420 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:31:51.425414 [debug] [ThreadPool]: On create__site_dev: Close
[0m13:31:51.430689 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m13:31:51.438670 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m13:31:51.439667 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m13:31:51.440666 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:31:53.008546 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:31:53.011573 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m13:31:53.013563 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m13:31:53.606228 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:31:53.610211 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m13:31:53.807079 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m13:31:53.812159 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c2475045-3de1-4773-b874-e6ed1c3fd816', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000214D9F95190>]}
[0m13:31:53.814162 [debug] [MainThread]: Using mysql connection "master"
[0m13:31:53.816157 [debug] [MainThread]: On master: BEGIN
[0m13:31:53.818150 [debug] [MainThread]: Opening a new connection, currently in state init
[0m13:31:55.373636 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:31:55.376637 [debug] [MainThread]: On master: COMMIT
[0m13:31:55.379635 [debug] [MainThread]: Using mysql connection "master"
[0m13:31:55.381622 [debug] [MainThread]: On master: COMMIT
[0m13:31:55.964797 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:31:55.968794 [debug] [MainThread]: On master: Close
[0m13:31:55.972795 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m13:31:55.976773 [info ] [MainThread]: 
[0m13:31:55.986786 [debug] [Thread-1 (]: Began running node model.kasper_sindri_media.Tactical_clicks_months_12
[0m13:31:55.988803 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.Tactical_clicks_months_12 ................. [RUN]
[0m13:31:55.991793 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.kasper_sindri_media.Tactical_clicks_months_12'
[0m13:31:55.992791 [debug] [Thread-1 (]: Began compiling node model.kasper_sindri_media.Tactical_clicks_months_12
[0m13:31:56.009745 [debug] [Thread-1 (]: Writing injected SQL for node "model.kasper_sindri_media.Tactical_clicks_months_12"
[0m13:31:56.012736 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.Tactical_clicks_months_12 (compile): 13:31:55.992791 => 13:31:56.011740
[0m13:31:56.013733 [debug] [Thread-1 (]: Began executing node model.kasper_sindri_media.Tactical_clicks_months_12
[0m13:31:56.071579 [debug] [Thread-1 (]: Writing runtime sql for node "model.kasper_sindri_media.Tactical_clicks_months_12"
[0m13:31:56.073574 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.Tactical_clicks_months_12"
[0m13:31:56.074573 [debug] [Thread-1 (]: On model.kasper_sindri_media.Tactical_clicks_months_12: BEGIN
[0m13:31:56.075573 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m13:31:57.638832 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:31:57.639827 [debug] [Thread-1 (]: Using mysql connection "model.kasper_sindri_media.Tactical_clicks_months_12"
[0m13:31:57.640830 [debug] [Thread-1 (]: On model.kasper_sindri_media.Tactical_clicks_months_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.kasper_sindri_media.Tactical_clicks_months_12"} */

  create view `site_dev`.`Tactical_clicks_months_12__dbt_tmp`
    
    
  as (
    








CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
BEGIN
    WITH curr_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND categories <> "Nyhedsoverblik"
        AND siteid = '12'
    ),
    agg_curr_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks
        FROM prod.events e
        JOIN curr_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND e.siteid = '12'
        AND e.Event_Action = 'Next Click'
        GROUP BY 1
    ),
    agg_curr_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum
        FROM prod.pages p
        LEFT JOIN curr_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = '12'
        AND p.date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        GROUP BY p.siteid
    ),
    value_curr_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks / p.pageview_sum * 100, 2) AS value
        FROM agg_curr_30_days_events e
        LEFT JOIN agg_curr_30_days_pages p ON e.siteid = p.siteid
    ),
    last_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        AND siteid = site
        AND categories <> "Nyhedsoverblik"
    ),
    agg_last_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks_last
        FROM prod.events e
        JOIN last_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        AND e.siteid = '12'
        AND e.Event_Action = 'Next Click'
        GROUP BY 1
    ),
    agg_last_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum_last
        FROM prod.pages p
        LEFT JOIN last_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = '12'
        AND p.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        GROUP BY p.siteid
    ),
    value_last_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks_last / p.pageview_sum_last * 100, 2) AS value_last
        FROM agg_last_30_days_events e
        LEFT JOIN agg_last_30_days_pages p ON e.siteid = p.siteid
    )
    SELECT 
        JSON_OBJECT(
            'site', al.siteid,
            'data', JSON_OBJECT(
                'label', 'Artikler',
                'hint', 'Artikler publiceret seneste 30 dage ift. forrige 30 dage',
                'value', COALESCE(value, 0),
                'change', COALESCE(value - value_last, 0),
                'progressCurrent', '',
                'progressTotal', ''
            )
        ) AS json_data
    FROM value_curr_30_days al
    LEFT JOIN value_last_30_days alb ON al.siteid = alb.siteid
    WHERE al.siteid = '12';
END;
  );
[0m13:31:58.226726 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
BEGIN
    WITH cu' at line 16
[0m13:31:58.229723 [debug] [Thread-1 (]: On model.kasper_sindri_media.Tactical_clicks_months_12: ROLLBACK
[0m13:31:58.427260 [debug] [Thread-1 (]: Timing info for model.kasper_sindri_media.Tactical_clicks_months_12 (execute): 13:31:56.014730 => 13:31:58.426276
[0m13:31:58.430275 [debug] [Thread-1 (]: On model.kasper_sindri_media.Tactical_clicks_months_12: Close
[0m13:31:58.454180 [debug] [Thread-1 (]: Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
  BEGIN
      WITH cu' at line 16
  compiled Code at target\run\kasper_sindri_media\models\example\Tactical_clicks_months_12.sql
[0m13:31:58.456176 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2475045-3de1-4773-b874-e6ed1c3fd816', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000214DA1335D0>]}
[0m13:31:58.458172 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.Tactical_clicks_months_12 ........ [[31mERROR[0m in 2.47s]
[0m13:31:58.461161 [debug] [Thread-1 (]: Finished running node model.kasper_sindri_media.Tactical_clicks_months_12
[0m13:31:58.464151 [debug] [MainThread]: Using mysql connection "master"
[0m13:31:58.465150 [debug] [MainThread]: On master: BEGIN
[0m13:31:58.466147 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m13:32:00.056998 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:32:00.062983 [debug] [MainThread]: On master: COMMIT
[0m13:32:00.066968 [debug] [MainThread]: Using mysql connection "master"
[0m13:32:00.070961 [debug] [MainThread]: On master: COMMIT
[0m13:32:00.652863 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:32:00.653861 [debug] [MainThread]: On master: Close
[0m13:32:00.654858 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:32:00.655855 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m13:32:00.657856 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m13:32:00.660841 [debug] [MainThread]: Connection 'model.kasper_sindri_media.Tactical_clicks_months_12' was properly closed.
[0m13:32:00.661837 [info ] [MainThread]: 
[0m13:32:00.664832 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 13.65 seconds (13.65s).
[0m13:32:00.667842 [debug] [MainThread]: Command end result
[0m13:32:00.689764 [info ] [MainThread]: 
[0m13:32:00.700735 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m13:32:00.702739 [info ] [MainThread]: 
[0m13:32:00.712702 [error] [MainThread]:   Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
  BEGIN
      WITH cu' at line 16
  compiled Code at target\run\kasper_sindri_media\models\example\Tactical_clicks_months_12.sql
[0m13:32:00.715694 [info ] [MainThread]: 
[0m13:32:00.717689 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m13:32:00.720679 [debug] [MainThread]: Command `dbt run` failed at 13:32:00.720679 after 14.32 seconds
[0m13:32:00.723672 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000214D9D4BB50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000214D3210B10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000214D3210AD0>]}
[0m13:32:00.727670 [debug] [MainThread]: Flushing usage events
[0m13:32:41.024012 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A52F59050>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A52F59490>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A52F58D90>]}


============================== 13:32:41.030991 | b0592a81-de32-4122-8fb8-ff65b7a19720 ==============================
[0m13:32:41.030991 [info ] [MainThread]: Running with dbt=1.7.17
[0m13:32:41.032988 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --models example.Tactical_clicks_months_12', 'send_anonymous_usage_stats': 'True'}
[0m13:32:41.317343 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'b0592a81-de32-4122-8fb8-ff65b7a19720', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A5314E510>]}
[0m13:32:41.405107 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'b0592a81-de32-4122-8fb8-ff65b7a19720', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A52F59A50>]}
[0m13:32:41.407071 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m13:32:41.419073 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m13:32:41.431009 [info ] [MainThread]: Unable to do partial parsing because a project dependency has been added
[0m13:32:41.432007 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'b0592a81-de32-4122-8fb8-ff65b7a19720', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A53324210>]}
[0m13:32:42.941012 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example.run_Tactical_clicks_months_12
[0m13:32:42.953976 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'b0592a81-de32-4122-8fb8-ff65b7a19720', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A531A3E90>]}
[0m13:32:42.973924 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'b0592a81-de32-4122-8fb8-ff65b7a19720', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A534423D0>]}
[0m13:32:42.974920 [info ] [MainThread]: Found 13 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m13:32:42.976915 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b0592a81-de32-4122-8fb8-ff65b7a19720', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A531D7890>]}
[0m13:32:42.979907 [info ] [MainThread]: 
[0m13:32:42.982902 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m13:32:42.986461 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m13:32:43.002419 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m13:32:43.003416 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m13:32:43.004413 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:32:44.606031 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m13:32:44.614008 [debug] [ThreadPool]: On list_schemas: Close
[0m13:32:44.620985 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m13:32:44.622981 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m13:32:44.635944 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:32:44.635944 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m13:32:44.636942 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:32:46.204672 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:32:46.207665 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:32:46.209655 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m13:32:46.806757 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m13:32:46.808759 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m13:32:46.809755 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:32:46.810753 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m13:32:47.401693 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:32:47.404690 [debug] [ThreadPool]: On create__site_dev: Close
[0m13:32:47.416649 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m13:32:47.427617 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m13:32:47.428615 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m13:32:47.428615 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:32:49.034919 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:32:49.037898 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m13:32:49.039884 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m13:32:49.643303 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:32:49.646299 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m13:32:49.847124 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m13:32:49.852107 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b0592a81-de32-4122-8fb8-ff65b7a19720', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A53133490>]}
[0m13:32:49.855101 [debug] [MainThread]: Using mysql connection "master"
[0m13:32:49.857090 [debug] [MainThread]: On master: BEGIN
[0m13:32:49.857090 [debug] [MainThread]: Opening a new connection, currently in state init
[0m13:32:51.388825 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:32:51.392824 [debug] [MainThread]: On master: COMMIT
[0m13:32:51.394830 [debug] [MainThread]: Using mysql connection "master"
[0m13:32:51.396817 [debug] [MainThread]: On master: COMMIT
[0m13:32:51.973223 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:32:51.974243 [debug] [MainThread]: On master: Close
[0m13:32:51.976240 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m13:32:54.520463 [info ] [MainThread]: 
[0m13:32:54.531444 [debug] [Thread-1 (]: Began running node model.site_dev.Tactical_clicks_months_12
[0m13:32:54.533427 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.Tactical_clicks_months_12 ................. [RUN]
[0m13:32:54.536419 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.site_dev.Tactical_clicks_months_12'
[0m13:32:54.538413 [debug] [Thread-1 (]: Began compiling node model.site_dev.Tactical_clicks_months_12
[0m13:32:54.565340 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.Tactical_clicks_months_12"
[0m13:32:54.652893 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_clicks_months_12 (compile): 13:32:54.539416 => 13:32:54.651898
[0m13:32:54.653887 [debug] [Thread-1 (]: Began executing node model.site_dev.Tactical_clicks_months_12
[0m13:32:54.707743 [debug] [Thread-1 (]: Writing runtime sql for node "model.site_dev.Tactical_clicks_months_12"
[0m13:32:54.710735 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_clicks_months_12"
[0m13:32:54.711741 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: BEGIN
[0m13:32:54.711741 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m13:32:56.264658 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:32:56.267638 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_clicks_months_12"
[0m13:32:56.270634 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.site_dev.Tactical_clicks_months_12"} */

  create view `site_dev`.`Tactical_clicks_months_12__dbt_tmp`
    
    
  as (
    








CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
BEGIN
    WITH curr_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND categories <> "Nyhedsoverblik"
        AND siteid = '12'
    ),
    agg_curr_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks
        FROM prod.events e
        JOIN curr_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND e.siteid = '12'
        AND e.Event_Action = 'Next Click'
        GROUP BY 1
    ),
    agg_curr_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum
        FROM prod.pages p
        LEFT JOIN curr_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = '12'
        AND p.date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        GROUP BY p.siteid
    ),
    value_curr_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks / p.pageview_sum * 100, 2) AS value
        FROM agg_curr_30_days_events e
        LEFT JOIN agg_curr_30_days_pages p ON e.siteid = p.siteid
    ),
    last_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        AND siteid = site
        AND categories <> "Nyhedsoverblik"
    ),
    agg_last_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks_last
        FROM prod.events e
        JOIN last_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        AND e.siteid = '12'
        AND e.Event_Action = 'Next Click'
        GROUP BY 1
    ),
    agg_last_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum_last
        FROM prod.pages p
        LEFT JOIN last_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = '12'
        AND p.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        GROUP BY p.siteid
    ),
    value_last_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks_last / p.pageview_sum_last * 100, 2) AS value_last
        FROM agg_last_30_days_events e
        LEFT JOIN agg_last_30_days_pages p ON e.siteid = p.siteid
    )
    SELECT 
        JSON_OBJECT(
            'site', al.siteid,
            'data', JSON_OBJECT(
                'label', 'Artikler',
                'hint', 'Artikler publiceret seneste 30 dage ift. forrige 30 dage',
                'value', COALESCE(value, 0),
                'change', COALESCE(value - value_last, 0),
                'progressCurrent', '',
                'progressTotal', ''
            )
        ) AS json_data
    FROM value_curr_30_days al
    LEFT JOIN value_last_30_days alb ON al.siteid = alb.siteid
    WHERE al.siteid = '12';
END;
  );
[0m13:32:56.854482 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
BEGIN
    WITH cu' at line 16
[0m13:32:56.857473 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: ROLLBACK
[0m13:32:57.054651 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_clicks_months_12 (execute): 13:32:54.655882 => 13:32:57.053655
[0m13:32:57.057643 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: Close
[0m13:32:57.066614 [debug] [Thread-1 (]: Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
  BEGIN
      WITH cu' at line 16
  compiled Code at target\run\site_dev\models\example\Tactical_clicks_months_12.sql
[0m13:32:57.067611 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0592a81-de32-4122-8fb8-ff65b7a19720', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A53491D90>]}
[0m13:32:57.069608 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.Tactical_clicks_months_12 ........ [[31mERROR[0m in 2.53s]
[0m13:32:57.071269 [debug] [Thread-1 (]: Finished running node model.site_dev.Tactical_clicks_months_12
[0m13:32:57.074261 [debug] [MainThread]: Using mysql connection "master"
[0m13:32:57.075286 [debug] [MainThread]: On master: BEGIN
[0m13:32:57.076257 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m13:32:58.617834 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:32:58.619829 [debug] [MainThread]: On master: COMMIT
[0m13:32:58.621824 [debug] [MainThread]: Using mysql connection "master"
[0m13:32:58.621824 [debug] [MainThread]: On master: COMMIT
[0m13:32:59.199251 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:32:59.201245 [debug] [MainThread]: On master: Close
[0m13:32:59.204237 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:32:59.205235 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m13:32:59.206231 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m13:32:59.207230 [debug] [MainThread]: Connection 'model.site_dev.Tactical_clicks_months_12' was properly closed.
[0m13:32:59.209227 [info ] [MainThread]: 
[0m13:32:59.212217 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 16.23 seconds (16.23s).
[0m13:32:59.219210 [debug] [MainThread]: Command end result
[0m13:32:59.268067 [info ] [MainThread]: 
[0m13:32:59.318931 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m13:32:59.321922 [info ] [MainThread]: 
[0m13:32:59.323918 [error] [MainThread]:   Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
  BEGIN
      WITH cu' at line 16
  compiled Code at target\run\site_dev\models\example\Tactical_clicks_months_12.sql
[0m13:32:59.326910 [info ] [MainThread]: 
[0m13:32:59.328904 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m13:32:59.343864 [debug] [MainThread]: Command `dbt run` failed at 13:32:59.343864 after 18.42 seconds
[0m13:32:59.345859 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A4C4B0FD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A4C4B0C10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A4C4B0B50>]}
[0m13:32:59.347854 [debug] [MainThread]: Flushing usage events
[0m13:36:50.100058 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000186170D9450>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018616BA7C50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000186170D9350>]}


============================== 13:36:50.108036 | 8b08b642-03b6-449d-b09c-1762a71301e2 ==============================
[0m13:36:50.108036 [info ] [MainThread]: Running with dbt=1.7.17
[0m13:36:50.111029 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --models example.Tactical_clicks_months_12', 'send_anonymous_usage_stats': 'True'}
[0m13:36:50.378904 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '8b08b642-03b6-449d-b09c-1762a71301e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018616AB9250>]}
[0m13:36:50.466643 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '8b08b642-03b6-449d-b09c-1762a71301e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001861731B750>]}
[0m13:36:50.468641 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m13:36:50.483597 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m13:36:50.510079 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m13:36:50.512076 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '8b08b642-03b6-449d-b09c-1762a71301e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000186174A5490>]}
[0m13:36:52.089855 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.site_dev.example.run_Tactical_clicks_months_12
[0m13:36:52.098861 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '8b08b642-03b6-449d-b09c-1762a71301e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000186174B7650>]}
[0m13:36:52.118776 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '8b08b642-03b6-449d-b09c-1762a71301e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001861730F790>]}
[0m13:36:52.119773 [info ] [MainThread]: Found 13 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m13:36:52.121777 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8b08b642-03b6-449d-b09c-1762a71301e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000186164F24D0>]}
[0m13:36:52.124760 [info ] [MainThread]: 
[0m13:36:52.126763 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m13:36:52.129748 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m13:36:52.145705 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m13:36:52.146700 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m13:36:52.146700 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:36:53.788864 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m13:36:53.791852 [debug] [ThreadPool]: On list_schemas: Close
[0m13:36:53.793847 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m13:36:53.795842 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m13:36:53.801827 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:36:53.802835 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m13:36:53.803823 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:36:55.389434 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:36:55.392437 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:36:55.393434 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m13:36:55.984285 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m13:36:55.989281 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m13:36:55.990274 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:36:55.991274 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m13:36:56.576258 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:36:56.579261 [debug] [ThreadPool]: On create__site_dev: Close
[0m13:36:56.584221 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m13:36:56.591205 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m13:36:56.592203 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m13:36:56.593200 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:36:58.130723 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:36:58.133731 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m13:36:58.135721 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m13:36:58.725566 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:36:58.728544 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m13:36:58.921972 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m13:36:58.926990 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8b08b642-03b6-449d-b09c-1762a71301e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000186175E5310>]}
[0m13:36:58.929990 [debug] [MainThread]: Using mysql connection "master"
[0m13:36:58.931979 [debug] [MainThread]: On master: BEGIN
[0m13:36:58.932970 [debug] [MainThread]: Opening a new connection, currently in state init
[0m13:37:00.499220 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:37:00.501214 [debug] [MainThread]: On master: COMMIT
[0m13:37:00.503209 [debug] [MainThread]: Using mysql connection "master"
[0m13:37:00.504203 [debug] [MainThread]: On master: COMMIT
[0m13:37:01.097080 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:37:01.100073 [debug] [MainThread]: On master: Close
[0m13:37:01.107053 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m13:37:01.111045 [info ] [MainThread]: 
[0m13:37:01.135975 [debug] [Thread-1 (]: Began running node model.site_dev.Tactical_clicks_months_12
[0m13:37:01.138968 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.Tactical_clicks_months_12 ................. [RUN]
[0m13:37:01.140463 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.site_dev.Tactical_clicks_months_12'
[0m13:37:01.142460 [debug] [Thread-1 (]: Began compiling node model.site_dev.Tactical_clicks_months_12
[0m13:37:01.169383 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.Tactical_clicks_months_12"
[0m13:37:01.171378 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_clicks_months_12 (compile): 13:37:01.143455 => 13:37:01.170380
[0m13:37:01.172375 [debug] [Thread-1 (]: Began executing node model.site_dev.Tactical_clicks_months_12
[0m13:37:01.238198 [debug] [Thread-1 (]: Writing runtime sql for node "model.site_dev.Tactical_clicks_months_12"
[0m13:37:01.240194 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_clicks_months_12"
[0m13:37:01.241190 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: BEGIN
[0m13:37:01.242188 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m13:37:02.889770 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:37:02.891765 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_clicks_months_12"
[0m13:37:02.894793 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.site_dev.Tactical_clicks_months_12"} */

  create view `site_dev`.`Tactical_clicks_months_12__dbt_tmp`
    
    
  as (
    








CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
BEGIN
    WITH curr_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND categories <> "Nyhedsoverblik"
        AND siteid = '12'
    ),
    agg_curr_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks
        FROM prod.events e
        JOIN curr_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND e.siteid = '12'
        AND e.Event_Action = 'Next Click'
        GROUP BY 1
    ),
    agg_curr_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum
        FROM prod.pages p
        LEFT JOIN curr_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = '12'
        AND p.date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        GROUP BY p.siteid
    ),
    value_curr_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks / p.pageview_sum * 100, 2) AS value
        FROM agg_curr_30_days_events e
        LEFT JOIN agg_curr_30_days_pages p ON e.siteid = p.siteid
    ),
    last_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        AND siteid = site
        AND categories <> "Nyhedsoverblik"
    ),
    agg_last_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks_last
        FROM prod.events e
        JOIN last_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        AND e.siteid = '12'
        AND e.Event_Action = 'Next Click'
        GROUP BY 1
    ),
    agg_last_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum_last
        FROM prod.pages p
        LEFT JOIN last_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = '12'
        AND p.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        GROUP BY p.siteid
    ),
    value_last_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks_last / p.pageview_sum_last * 100, 2) AS value_last
        FROM agg_last_30_days_events e
        LEFT JOIN agg_last_30_days_pages p ON e.siteid = p.siteid
    )
    SELECT 
        JSON_OBJECT(
            'site', al.siteid,
            'data', JSON_OBJECT(
                'label', 'Artikler',
                'hint', 'Artikler publiceret seneste 30 dage ift. forrige 30 dage',
                'value', COALESCE(value, 0),
                'change', COALESCE(value - value_last, 0),
                'progressCurrent', '',
                'progressTotal', ''
            )
        ) AS json_data
    FROM value_curr_30_days al
    LEFT JOIN value_last_30_days alb ON al.siteid = alb.siteid
    WHERE al.siteid = '12';
END;
  );
[0m13:37:03.478065 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
BEGIN
    WITH cu' at line 16
[0m13:37:03.481054 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: ROLLBACK
[0m13:37:03.675719 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_clicks_months_12 (execute): 13:37:01.173372 => 13:37:03.674716
[0m13:37:03.676716 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: Close
[0m13:37:03.686688 [debug] [Thread-1 (]: Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
  BEGIN
      WITH cu' at line 16
  compiled Code at target\run\site_dev\models\example\Tactical_clicks_months_12.sql
[0m13:37:03.688684 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8b08b642-03b6-449d-b09c-1762a71301e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018617604150>]}
[0m13:37:03.689681 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.Tactical_clicks_months_12 ........ [[31mERROR[0m in 2.55s]
[0m13:37:03.692776 [debug] [Thread-1 (]: Finished running node model.site_dev.Tactical_clicks_months_12
[0m13:37:03.696546 [debug] [MainThread]: Using mysql connection "master"
[0m13:37:03.697542 [debug] [MainThread]: On master: BEGIN
[0m13:37:03.698540 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m13:37:05.251227 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:37:05.254246 [debug] [MainThread]: On master: COMMIT
[0m13:37:05.257240 [debug] [MainThread]: Using mysql connection "master"
[0m13:37:05.260235 [debug] [MainThread]: On master: COMMIT
[0m13:37:05.845849 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:37:05.848845 [debug] [MainThread]: On master: Close
[0m13:37:05.853831 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:37:05.855825 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m13:37:05.859807 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m13:37:05.861802 [debug] [MainThread]: Connection 'model.site_dev.Tactical_clicks_months_12' was properly closed.
[0m13:37:05.863797 [info ] [MainThread]: 
[0m13:37:05.865967 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 13.74 seconds (13.74s).
[0m13:37:05.869954 [debug] [MainThread]: Command end result
[0m13:37:05.885908 [info ] [MainThread]: 
[0m13:37:05.887904 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m13:37:05.888899 [info ] [MainThread]: 
[0m13:37:05.891892 [error] [MainThread]:   Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
  BEGIN
      WITH cu' at line 16
  compiled Code at target\run\site_dev\models\example\Tactical_clicks_months_12.sql
[0m13:37:05.893476 [info ] [MainThread]: 
[0m13:37:05.895981 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m13:37:05.899540 [debug] [MainThread]: Command `dbt run` failed at 13:37:05.898538 after 15.90 seconds
[0m13:37:05.900534 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018610611550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018610611590>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000186170C2310>]}
[0m13:37:05.901534 [debug] [MainThread]: Flushing usage events
[0m13:39:28.728006 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021DB81E1090>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021DB85AF190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021DB85AC5D0>]}


============================== 13:39:28.733989 | 7ea1eec4-2385-403d-903f-6ddd6e50f107 ==============================
[0m13:39:28.733989 [info ] [MainThread]: Running with dbt=1.7.17
[0m13:39:28.736981 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'debug': 'False', 'version_check': 'True', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --models example.Tactical_clicks_months_12', 'send_anonymous_usage_stats': 'True'}
[0m13:39:29.035926 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '7ea1eec4-2385-403d-903f-6ddd6e50f107', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021DB8611BD0>]}
[0m13:39:29.120700 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '7ea1eec4-2385-403d-903f-6ddd6e50f107', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021DB87EF810>]}
[0m13:39:29.122996 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m13:39:29.135963 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m13:39:29.160694 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m13:39:29.161692 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '7ea1eec4-2385-403d-903f-6ddd6e50f107', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021DB87D8C10>]}
[0m13:39:30.677636 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.site_dev.example.run_Tactical_clicks_months_12
[0m13:39:30.688607 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '7ea1eec4-2385-403d-903f-6ddd6e50f107', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021DB88014D0>]}
[0m13:39:30.708554 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '7ea1eec4-2385-403d-903f-6ddd6e50f107', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021DB8906B10>]}
[0m13:39:30.709549 [info ] [MainThread]: Found 13 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m13:39:30.711544 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7ea1eec4-2385-403d-903f-6ddd6e50f107', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021DB8846650>]}
[0m13:39:30.713542 [info ] [MainThread]: 
[0m13:39:30.717530 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m13:39:30.720676 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m13:39:30.736631 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m13:39:30.736631 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m13:39:30.737628 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:39:32.309523 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m13:39:32.314504 [debug] [ThreadPool]: On list_schemas: Close
[0m13:39:32.316218 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m13:39:32.318215 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m13:39:32.323202 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:39:32.324199 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m13:39:32.325198 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:39:33.861394 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:39:33.864412 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:39:33.866406 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m13:39:34.458257 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m13:39:34.462242 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m13:39:34.464235 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:39:34.464235 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m13:39:35.040285 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:39:35.041289 [debug] [ThreadPool]: On create__site_dev: Close
[0m13:39:35.045367 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m13:39:35.052351 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m13:39:35.053348 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m13:39:35.054346 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:39:36.578156 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:39:36.581157 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m13:39:36.582161 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m13:39:37.156814 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:39:37.163790 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m13:39:37.355774 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m13:39:37.360769 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7ea1eec4-2385-403d-903f-6ddd6e50f107', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021DB893D9D0>]}
[0m13:39:37.363796 [debug] [MainThread]: Using mysql connection "master"
[0m13:39:37.365762 [debug] [MainThread]: On master: BEGIN
[0m13:39:37.366760 [debug] [MainThread]: Opening a new connection, currently in state init
[0m13:39:38.963305 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:39:38.966309 [debug] [MainThread]: On master: COMMIT
[0m13:39:38.968298 [debug] [MainThread]: Using mysql connection "master"
[0m13:39:38.970295 [debug] [MainThread]: On master: COMMIT
[0m13:39:39.572801 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:39:39.575806 [debug] [MainThread]: On master: Close
[0m13:39:39.579792 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m13:39:39.582781 [info ] [MainThread]: 
[0m13:39:39.595460 [debug] [Thread-1 (]: Began running node model.site_dev.Tactical_clicks_months_12
[0m13:39:39.597477 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.Tactical_clicks_months_12 ................. [RUN]
[0m13:39:39.600136 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.site_dev.Tactical_clicks_months_12'
[0m13:39:39.601133 [debug] [Thread-1 (]: Began compiling node model.site_dev.Tactical_clicks_months_12
[0m13:39:39.620084 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.Tactical_clicks_months_12"
[0m13:39:39.622076 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_clicks_months_12 (compile): 13:39:39.602130 => 13:39:39.621081
[0m13:39:39.623073 [debug] [Thread-1 (]: Began executing node model.site_dev.Tactical_clicks_months_12
[0m13:39:39.677927 [debug] [Thread-1 (]: Writing runtime sql for node "model.site_dev.Tactical_clicks_months_12"
[0m13:39:39.679924 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_clicks_months_12"
[0m13:39:39.679924 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: BEGIN
[0m13:39:39.680920 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m13:39:41.281849 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:39:41.283842 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_clicks_months_12"
[0m13:39:41.286833 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.site_dev.Tactical_clicks_months_12"} */

  create view `site_dev`.`Tactical_clicks_months_12__dbt_tmp`
    
    
  as (
    








CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
BEGIN
    WITH curr_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND categories <> "Nyhedsoverblik"
        AND siteid = '12'
    ),
    agg_curr_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks
        FROM prod.events e
        JOIN curr_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND e.siteid = '12'
        AND e.Event_Action = 'Next Click'
        GROUP BY 1
    ),
    agg_curr_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum
        FROM prod.pages p
        LEFT JOIN curr_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = '12'
        AND p.date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        GROUP BY p.siteid
    ),
    value_curr_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks / p.pageview_sum * 100, 2) AS value
        FROM agg_curr_30_days_events e
        LEFT JOIN agg_curr_30_days_pages p ON e.siteid = p.siteid
    ),
    last_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        AND siteid = site
        AND categories <> "Nyhedsoverblik"
    ),
    agg_last_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks_last
        FROM prod.events e
        JOIN last_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        AND e.siteid = '12'
        AND e.Event_Action = 'Next Click'
        GROUP BY 1
    ),
    agg_last_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum_last
        FROM prod.pages p
        LEFT JOIN last_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = '12'
        AND p.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        GROUP BY p.siteid
    ),
    value_last_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks_last / p.pageview_sum_last * 100, 2) AS value_last
        FROM agg_last_30_days_events e
        LEFT JOIN agg_last_30_days_pages p ON e.siteid = p.siteid
    )
    SELECT 
        JSON_OBJECT(
            'site', al.siteid,
            'data', JSON_OBJECT(
                'label', 'Artikler',
                'hint', 'Artikler publiceret seneste 30 dage ift. forrige 30 dage',
                'value', COALESCE(value, 0),
                'change', COALESCE(value - value_last, 0),
                'progressCurrent', '',
                'progressTotal', ''
            )
        ) AS json_data
    FROM value_curr_30_days al
    LEFT JOIN value_last_30_days alb ON al.siteid = alb.siteid
    WHERE al.siteid = '12';
END;
  );
[0m13:39:41.892184 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
BEGIN
    WITH cu' at line 16
[0m13:39:41.894170 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: ROLLBACK
[0m13:39:42.097073 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_clicks_months_12 (execute): 13:39:39.625071 => 13:39:42.095069
[0m13:39:42.099068 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: Close
[0m13:39:42.117019 [debug] [Thread-1 (]: Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
  BEGIN
      WITH cu' at line 16
  compiled Code at target\run\site_dev\models\example\Tactical_clicks_months_12.sql
[0m13:39:42.119012 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7ea1eec4-2385-403d-903f-6ddd6e50f107', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021DB8A967D0>]}
[0m13:39:42.120009 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.Tactical_clicks_months_12 ........ [[31mERROR[0m in 2.52s]
[0m13:39:42.122003 [debug] [Thread-1 (]: Finished running node model.site_dev.Tactical_clicks_months_12
[0m13:39:42.126991 [debug] [MainThread]: Using mysql connection "master"
[0m13:39:42.126991 [debug] [MainThread]: On master: BEGIN
[0m13:39:42.127988 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m13:39:43.664805 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:39:43.666796 [debug] [MainThread]: On master: COMMIT
[0m13:39:43.668788 [debug] [MainThread]: Using mysql connection "master"
[0m13:39:43.671783 [debug] [MainThread]: On master: COMMIT
[0m13:39:44.268651 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:39:44.270643 [debug] [MainThread]: On master: Close
[0m13:39:44.275630 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:39:44.277625 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m13:39:44.279617 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m13:39:44.281611 [debug] [MainThread]: Connection 'model.site_dev.Tactical_clicks_months_12' was properly closed.
[0m13:39:44.283608 [info ] [MainThread]: 
[0m13:39:44.286603 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 13.57 seconds (13.57s).
[0m13:39:44.289591 [debug] [MainThread]: Command end result
[0m13:39:44.306548 [info ] [MainThread]: 
[0m13:39:44.307980 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m13:39:44.310521 [info ] [MainThread]: 
[0m13:39:44.314313 [error] [MainThread]:   Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
  BEGIN
      WITH cu' at line 16
  compiled Code at target\run\site_dev\models\example\Tactical_clicks_months_12.sql
[0m13:39:44.315162 [info ] [MainThread]: 
[0m13:39:44.317159 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m13:39:44.321122 [debug] [MainThread]: Command `dbt run` failed at 13:39:44.320174 after 15.69 seconds
[0m13:39:44.322117 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021DB1A91550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021DB1A91590>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021DB8591F90>]}
[0m13:39:44.323114 [debug] [MainThread]: Flushing usage events
[0m13:41:54.976699 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D7B05F76D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D7B05A0190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D7B05A0710>]}


============================== 13:41:54.985675 | 69b2f54c-3794-4d95-a48f-36a7a27910c8 ==============================
[0m13:41:54.985675 [info ] [MainThread]: Running with dbt=1.7.17
[0m13:41:54.987670 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run', 'send_anonymous_usage_stats': 'True'}
[0m13:41:55.289045 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '69b2f54c-3794-4d95-a48f-36a7a27910c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D7B05FB850>]}
[0m13:41:55.378765 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '69b2f54c-3794-4d95-a48f-36a7a27910c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D7B073EBD0>]}
[0m13:41:55.381110 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m13:41:55.395342 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m13:41:55.420274 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m13:41:55.422275 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '69b2f54c-3794-4d95-a48f-36a7a27910c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D7B0984850>]}
[0m13:41:57.268331 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example
[0m13:41:57.279304 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '69b2f54c-3794-4d95-a48f-36a7a27910c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D7B0B43950>]}
[0m13:41:57.299248 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '69b2f54c-3794-4d95-a48f-36a7a27910c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D7B0AF0210>]}
[0m13:41:57.301243 [info ] [MainThread]: Found 13 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m13:41:57.303239 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '69b2f54c-3794-4d95-a48f-36a7a27910c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D7B05CFB50>]}
[0m13:41:57.308224 [info ] [MainThread]: 
[0m13:41:57.310310 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m13:41:57.313734 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m13:41:57.327697 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m13:41:57.328695 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m13:41:57.329692 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:41:58.928135 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m13:41:58.931129 [debug] [ThreadPool]: On list_schemas: Close
[0m13:41:58.933322 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m13:41:58.934322 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m13:41:58.941304 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:41:58.942303 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m13:41:58.942303 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:42:00.519539 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:42:00.521526 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:42:00.524521 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m13:42:01.201518 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m13:42:01.206514 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m13:42:01.209506 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:42:01.211502 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m13:42:01.805340 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:42:01.807340 [debug] [ThreadPool]: On create__site_dev: Close
[0m13:42:01.812885 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m13:42:01.820866 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m13:42:01.821864 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m13:42:01.822862 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:42:03.405983 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:42:03.409003 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m13:42:03.410998 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m13:42:04.009547 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:42:04.013595 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m13:42:04.216397 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m13:42:04.221230 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '69b2f54c-3794-4d95-a48f-36a7a27910c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D7B0B4E410>]}
[0m13:42:04.224234 [debug] [MainThread]: Using mysql connection "master"
[0m13:42:04.226229 [debug] [MainThread]: On master: BEGIN
[0m13:42:04.228224 [debug] [MainThread]: Opening a new connection, currently in state init
[0m13:42:05.840396 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:42:05.843402 [debug] [MainThread]: On master: COMMIT
[0m13:42:05.845392 [debug] [MainThread]: Using mysql connection "master"
[0m13:42:05.845392 [debug] [MainThread]: On master: COMMIT
[0m13:42:06.424445 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:42:06.427466 [debug] [MainThread]: On master: Close
[0m13:42:06.429462 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m13:42:06.431452 [info ] [MainThread]: 
[0m13:42:06.437506 [debug] [Thread-1 (]: Began running node model.site_dev.Tactical_clicks_months_12
[0m13:42:06.438507 [info ] [Thread-1 (]: 1 of 13 START sql view model site_dev.Tactical_clicks_months_12 ................ [RUN]
[0m13:42:06.440332 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.site_dev.Tactical_clicks_months_12'
[0m13:42:06.441330 [debug] [Thread-1 (]: Began compiling node model.site_dev.Tactical_clicks_months_12
[0m13:42:06.456288 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.Tactical_clicks_months_12"
[0m13:42:06.458284 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_clicks_months_12 (compile): 13:42:06.441330 => 13:42:06.458284
[0m13:42:06.460281 [debug] [Thread-1 (]: Began executing node model.site_dev.Tactical_clicks_months_12
[0m13:42:06.504161 [debug] [Thread-1 (]: Writing runtime sql for node "model.site_dev.Tactical_clicks_months_12"
[0m13:42:06.506156 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_clicks_months_12"
[0m13:42:06.507154 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: BEGIN
[0m13:42:06.507154 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m13:42:08.034819 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:42:08.037824 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_clicks_months_12"
[0m13:42:08.039819 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.site_dev.Tactical_clicks_months_12"} */

  create view `site_dev`.`Tactical_clicks_months_12__dbt_tmp`
    
    
  as (
    








CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
BEGIN
    WITH curr_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND categories <> "Nyhedsoverblik"
        AND siteid = '12'
    ),
    agg_curr_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks
        FROM prod.events e
        JOIN curr_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND e.siteid = '12'
        AND e.Event_Action = 'Next Click'
        GROUP BY 1
    ),
    agg_curr_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum
        FROM prod.pages p
        LEFT JOIN curr_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = '12'
        AND p.date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        GROUP BY p.siteid
    ),
    value_curr_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks / p.pageview_sum * 100, 2) AS value
        FROM agg_curr_30_days_events e
        LEFT JOIN agg_curr_30_days_pages p ON e.siteid = p.siteid
    ),
    last_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        AND siteid = site
        AND categories <> "Nyhedsoverblik"
    ),
    agg_last_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks_last
        FROM prod.events e
        JOIN last_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        AND e.siteid = '12'
        AND e.Event_Action = 'Next Click'
        GROUP BY 1
    ),
    agg_last_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum_last
        FROM prod.pages p
        LEFT JOIN last_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = '12'
        AND p.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        GROUP BY p.siteid
    ),
    value_last_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks_last / p.pageview_sum_last * 100, 2) AS value_last
        FROM agg_last_30_days_events e
        LEFT JOIN agg_last_30_days_pages p ON e.siteid = p.siteid
    )
    SELECT 
        JSON_OBJECT(
            'site', al.siteid,
            'data', JSON_OBJECT(
                'label', 'Artikler',
                'hint', 'Artikler publiceret seneste 30 dage ift. forrige 30 dage',
                'value', COALESCE(value, 0),
                'change', COALESCE(value - value_last, 0),
                'progressCurrent', '',
                'progressTotal', ''
            )
        ) AS json_data
    FROM value_curr_30_days al
    LEFT JOIN value_last_30_days alb ON al.siteid = alb.siteid
    WHERE al.siteid = '12';
END;
  );
[0m13:42:08.614152 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
BEGIN
    WITH cu' at line 16
[0m13:42:08.616152 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: ROLLBACK
[0m13:42:08.810774 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_clicks_months_12 (execute): 13:42:06.460281 => 13:42:08.809766
[0m13:42:08.813765 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: Close
[0m13:42:08.831724 [debug] [Thread-1 (]: Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
  BEGIN
      WITH cu' at line 16
  compiled Code at target\run\site_dev\models\example\Tactical_clicks_months_12.sql
[0m13:42:08.833711 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '69b2f54c-3794-4d95-a48f-36a7a27910c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D7B0B08550>]}
[0m13:42:08.834704 [error] [Thread-1 (]: 1 of 13 ERROR creating sql view model site_dev.Tactical_clicks_months_12 ....... [[31mERROR[0m in 2.39s]
[0m13:42:08.836700 [debug] [Thread-1 (]: Finished running node model.site_dev.Tactical_clicks_months_12
[0m13:42:08.837696 [debug] [Thread-1 (]: Began running node model.site_dev.cards
[0m13:42:08.839732 [info ] [Thread-1 (]: 2 of 13 START sql view model site_dev.cards .................................... [RUN]
[0m13:42:08.842114 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.site_dev.Tactical_clicks_months_12, now model.site_dev.cards)
[0m13:42:08.842114 [debug] [Thread-1 (]: Began compiling node model.site_dev.cards
[0m13:42:08.846113 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.cards"
[0m13:42:08.847102 [debug] [Thread-1 (]: Timing info for model.site_dev.cards (compile): 13:42:08.843111 => 13:42:08.847102
[0m13:42:08.848098 [debug] [Thread-1 (]: Began executing node model.site_dev.cards
[0m13:42:08.854108 [debug] [Thread-1 (]: Writing runtime sql for node "model.site_dev.cards"
[0m13:42:08.856079 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.cards"
[0m13:42:08.857076 [debug] [Thread-1 (]: On model.site_dev.cards: BEGIN
[0m13:42:08.858071 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m13:42:10.418969 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:42:10.420967 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.cards"
[0m13:42:10.423963 [debug] [Thread-1 (]: On model.site_dev.cards: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.site_dev.cards"} */

  create view `site_dev`.`cards__dbt_tmp`
    
    
  as (
    CREATE DEFINER=`Site`@`%` PROCEDURE `tactical_articles_card_month`(
IN site INT, IN label_val VARCHAR(200), IN hint_val text
)
BEGIN
with last_30_day as
(
SELECT siteId as siteId,count(date) as value FROM prod.site_archive_post
where 
date between DATE_SUB(NOW(), INTERVAL 31 DAY) and DATE_SUB(NOW(), INTERVAL 1 DAY) and siteid =site
group by 1
),
last_30_days_before as 
(
SELECT siteId as siteId,count(*) value  FROM prod.site_archive_post
where 
date between DATE_SUB(NOW(), INTERVAL 60 DAY) and DATE_SUB(NOW(), INTERVAL 30 DAY) and siteid =site
group by 1
)
select 
JSON_OBJECT(
'site',ld.siteId,'data',
JSON_OBJECT('label', label_val, 'hint',hint_val,'value',
COALESCE(ld.value,0),
'change',COALESCE(round(((ld.value-lb.value)/lb.value)*100,2),0), 
'progressCurrent','','progressTotal',''))AS json_data
from last_30_day ld
left join last_30_days_before lb
on ld.siteId=lb.siteId
;

END
  );
[0m13:42:11.032655 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `tactical_articles_card_month`(
IN site INT' at line 7
[0m13:42:11.035642 [debug] [Thread-1 (]: On model.site_dev.cards: ROLLBACK
[0m13:42:11.234000 [debug] [Thread-1 (]: Timing info for model.site_dev.cards (execute): 13:42:08.849094 => 13:42:11.231974
[0m13:42:11.236002 [debug] [Thread-1 (]: On model.site_dev.cards: Close
[0m13:42:11.240976 [debug] [Thread-1 (]: Database Error in model cards (models\cards.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `tactical_articles_card_month`(
  IN site INT' at line 7
  compiled Code at target\run\site_dev\models\cards.sql
[0m13:42:11.241974 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '69b2f54c-3794-4d95-a48f-36a7a27910c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D7B08C2CD0>]}
[0m13:42:11.242971 [error] [Thread-1 (]: 2 of 13 ERROR creating sql view model site_dev.cards ........................... [[31mERROR[0m in 2.40s]
[0m13:42:11.244968 [debug] [Thread-1 (]: Finished running node model.site_dev.cards
[0m13:42:11.245965 [debug] [Thread-1 (]: Began running node model.site_dev.example_by
[0m13:42:11.246960 [info ] [Thread-1 (]: 3 of 13 START sql view model site_dev.example_by ............................... [RUN]
[0m13:42:11.248830 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.site_dev.cards, now model.site_dev.example_by)
[0m13:42:11.248830 [debug] [Thread-1 (]: Began compiling node model.site_dev.example_by
[0m13:42:11.252819 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.example_by"
[0m13:42:11.258810 [debug] [Thread-1 (]: Timing info for model.site_dev.example_by (compile): 13:42:11.249827 => 13:42:11.257914
[0m13:42:11.259808 [debug] [Thread-1 (]: Began executing node model.site_dev.example_by
[0m13:42:11.265785 [debug] [Thread-1 (]: Writing runtime sql for node "model.site_dev.example_by"
[0m13:42:11.266782 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.example_by"
[0m13:42:11.267780 [debug] [Thread-1 (]: On model.site_dev.example_by: BEGIN
[0m13:42:11.268797 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m13:42:12.797861 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:42:12.799853 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.example_by"
[0m13:42:12.802853 [debug] [Thread-1 (]: On model.site_dev.example_by: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.site_dev.example_by"} */

  create view `site_dev`.`example_by__dbt_tmp`
    
    
  as (
    -- template.sql

CREATE PROCEDURE `example_procedure`(
    IN site_id INT,
    IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = '
    SELECT *
    FROM events
    WHERE site_id = 
    AND event_action = ""';
    
    PREPARE stmt FROM @sql_query;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
END;
  );
[0m13:42:13.385813 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `example_procedure`(
    IN site_id INT,
    IN event_action VA' at line 9
[0m13:42:13.388804 [debug] [Thread-1 (]: On model.site_dev.example_by: ROLLBACK
[0m13:42:13.583468 [debug] [Thread-1 (]: Timing info for model.site_dev.example_by (execute): 13:42:11.259808 => 13:42:13.581440
[0m13:42:13.585455 [debug] [Thread-1 (]: On model.site_dev.example_by: Close
[0m13:42:13.598423 [debug] [Thread-1 (]: Database Error in model example_by (models\example_by.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `example_procedure`(
      IN site_id INT,
      IN event_action VA' at line 9
  compiled Code at target\run\site_dev\models\example_by.sql
[0m13:42:13.600419 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '69b2f54c-3794-4d95-a48f-36a7a27910c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D7B0AF3D10>]}
[0m13:42:13.602411 [error] [Thread-1 (]: 3 of 13 ERROR creating sql view model site_dev.example_by ...................... [[31mERROR[0m in 2.35s]
[0m13:42:13.605413 [debug] [Thread-1 (]: Finished running node model.site_dev.example_by
[0m13:42:13.607395 [debug] [Thread-1 (]: Began running node model.site_dev.example_by_me
[0m13:42:13.609390 [info ] [Thread-1 (]: 4 of 13 START sql view model site_dev.example_by_me ............................ [RUN]
[0m13:42:13.611074 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.site_dev.example_by, now model.site_dev.example_by_me)
[0m13:42:13.611074 [debug] [Thread-1 (]: Began compiling node model.site_dev.example_by_me
[0m13:42:13.615062 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.example_by_me"
[0m13:42:13.617057 [debug] [Thread-1 (]: Timing info for model.site_dev.example_by_me (compile): 13:42:13.612071 => 13:42:13.617057
[0m13:42:13.618055 [debug] [Thread-1 (]: Began executing node model.site_dev.example_by_me
[0m13:42:13.625035 [debug] [Thread-1 (]: Writing runtime sql for node "model.site_dev.example_by_me"
[0m13:42:13.631290 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.example_by_me"
[0m13:42:13.632286 [debug] [Thread-1 (]: On model.site_dev.example_by_me: BEGIN
[0m13:42:13.633284 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m13:42:15.202943 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:42:15.205944 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.example_by_me"
[0m13:42:15.207939 [debug] [Thread-1 (]: On model.site_dev.example_by_me: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.site_dev.example_by_me"} */

  create view `site_dev`.`example_by_me__dbt_tmp`
    
    
  as (
    -- template.sql

CREATE PROCEDURE `example_procedure`(
    IN site_id INT,
    IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = '
    SELECT *
    FROM events
    WHERE site_id = 
    AND event_action = ""';
    
    PREPARE stmt FROM @sql_query;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
END;
  );
[0m13:42:15.795450 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `example_procedure`(
    IN site_id INT,
    IN event_action VA' at line 9
[0m13:42:15.797447 [debug] [Thread-1 (]: On model.site_dev.example_by_me: ROLLBACK
[0m13:42:16.001647 [debug] [Thread-1 (]: Timing info for model.site_dev.example_by_me (execute): 13:42:13.619056 => 13:42:16.001647
[0m13:42:16.003647 [debug] [Thread-1 (]: On model.site_dev.example_by_me: Close
[0m13:42:16.010629 [debug] [Thread-1 (]: Database Error in model example_by_me (models\nextClick\example_by_me.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `example_procedure`(
      IN site_id INT,
      IN event_action VA' at line 9
  compiled Code at target\run\site_dev\models\nextClick\example_by_me.sql
[0m13:42:16.011627 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '69b2f54c-3794-4d95-a48f-36a7a27910c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D7B0AE6E90>]}
[0m13:42:16.012624 [error] [Thread-1 (]: 4 of 13 ERROR creating sql view model site_dev.example_by_me ................... [[31mERROR[0m in 2.40s]
[0m13:42:16.013735 [debug] [Thread-1 (]: Finished running node model.site_dev.example_by_me
[0m13:42:16.015733 [debug] [Thread-1 (]: Began running node model.site_dev.overview_sales_card_12
[0m13:42:16.016730 [info ] [Thread-1 (]: 5 of 13 START sql view model site_dev.overview_sales_card_12 ................... [RUN]
[0m13:42:16.019287 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.site_dev.example_by_me, now model.site_dev.overview_sales_card_12)
[0m13:42:16.020287 [debug] [Thread-1 (]: Began compiling node model.site_dev.overview_sales_card_12
[0m13:42:16.033075 [debug] [Thread-1 (]: Timing info for model.site_dev.overview_sales_card_12 (compile): 13:42:16.021285 => 13:42:16.032063
[0m13:42:16.038051 [debug] [Thread-1 (]: Compilation Error in model overview_sales_card_12 (models\example\overview_sales_card_12.sql)
  Required var 'json' not found in config:
  Vars supplied to overview_sales_card_12 = {
      "article_evaluation": {
          "over_both_goals": {
              "case": "((coalesce(coalesce(l.hits,0)/coalesce(l.pageviews,0)*100,0))>=coalesce(g.Min_CTA,0) and coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0) )",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          },
          "under_both_goal": {
              "case": "(coalesce((coalesce(l.hits,0)/coalesce(l.pageviews,0)*100),0)<coalesce(g.Min_CTA,0) and coalesce(l.pageviews,0)<coalesce(g.Min_pageviews,0) )",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          },
          "under_one_goal": {
              "case": "(coalesce( coalesce((coalesce(l.hits,0) / coalesce(l.pageviews,0)),0) * 100 , 0)>=coalesce(g.Min_CTA,0) or coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0)) and !((coalesce( coalesce((coalesce(l.hits,0) / coalesce(l.pageviews,0)),0) * 100 , 0))>=coalesce(g.Min_CTA,0) and  coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0) ) ",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          }
      },
      "date_month": "DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)",
      "date_month_before": "DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) ",
      "date_week": "DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)",
      "date_year": "MAKEDATE(EXTRACT(YEAR FROM CURDATE()), 1) AND DATE_SUB(CAST(NOW() AS DATE), INTERVAL 1 DAY)",
      "event_action": "Next Click",
      "overview": {
          "overview_pageviews_card": {
              "hint": "Sidevisninger \u00e5r til dato ift sidste \u00e5r til dato og ift m\u00e5ls\u00e6tning",
              "label": "Sidevisninger"
          },
          "overview_sales_card": {
              "hint": "Gns. next click \u00e5r til dato ift. sidste \u00e5r",
              "label": "Next click (%)"
          },
          "overview_visits_card": {
              "hint": "Bes\u00f8g \u00e5r til dato ift sidste \u00e5r til dato og ift m\u00e5ls\u00e6tning",
              "label": "Bes\u00f8g"
          }
      },
      "site": 12,
      "tendency": {
          "tactical_articles_card": {
              "hint": "Artikler publiceret seneste 30 dage ift. forrige 30 dage",
              "label": "Artikler"
          },
          "tactical_clicks_card": {
              "hint": "Gns. next click p\u00e5 artikler publiceret seneste 30 dage ift. forrige 30 dage",
              "label": "Gns. next click (%)"
          },
          "tactical_pageviews_card": {
              "hint": "Gns. sidevisninger pr artikler publiceret \u00e5r til dato ift. sidste \u00e5r til dato",
              "label": "Gns. sidevisninger pr artikel"
          },
          "tactical_userneeds_pageviews_chart": {
              "dropdown_count": [
                  "",
                  "_second",
                  "_third"
              ],
              "dropdown_name": {
                  "Categories": "Categories",
                  "Tags": "Tags",
                  "userneeds": "userneeds"
              },
              "dropdown_val": {
                  "categories": [
                      "Nyheder",
                      "Debat",
                      "Inspiration",
                      "Anmeldelser"
                  ],
                  "tags": [
                      "skolepolitik",
                      "Psykisk arbejdsmilj\u00f8"
                  ],
                  "userneeds": [
                      "Opdater mig",
                      "Forbind mig",
                      "Hj\u00e6lp mig med at forst\u00e5",
                      "Giv mig en fordel",
                      "Underhold mig",
                      "Inspirer mig"
                  ]
              },
              "hint": "Artikler grupperet ift hvordan de har performet p\u00e5 next click",
              "label": "Artikler ift. next click m\u00e5l"
          }
      }
  }
[0m13:42:16.040052 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '69b2f54c-3794-4d95-a48f-36a7a27910c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D7B0AE7790>]}
[0m13:42:16.043038 [error] [Thread-1 (]: 5 of 13 ERROR creating sql view model site_dev.overview_sales_card_12 .......... [[31mERROR[0m in 0.02s]
[0m13:42:16.045036 [debug] [Thread-1 (]: Finished running node model.site_dev.overview_sales_card_12
[0m13:42:16.045036 [debug] [Thread-1 (]: Began running node model.site_dev.tactical_articles_card_month_12
[0m13:42:16.047030 [info ] [Thread-1 (]: 6 of 13 START sql view model site_dev.tactical_articles_card_month_12 .......... [RUN]
[0m13:42:16.048728 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.site_dev.overview_sales_card_12, now model.site_dev.tactical_articles_card_month_12)
[0m13:42:16.049724 [debug] [Thread-1 (]: Began compiling node model.site_dev.tactical_articles_card_month_12
[0m13:42:16.058701 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.tactical_articles_card_month_12"
[0m13:42:16.060694 [debug] [Thread-1 (]: Timing info for model.site_dev.tactical_articles_card_month_12 (compile): 13:42:16.050721 => 13:42:16.059698
[0m13:42:16.061697 [debug] [Thread-1 (]: Began executing node model.site_dev.tactical_articles_card_month_12
[0m13:42:16.069670 [debug] [Thread-1 (]: Writing runtime sql for node "model.site_dev.tactical_articles_card_month_12"
[0m13:42:16.072662 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.tactical_articles_card_month_12"
[0m13:42:16.073660 [debug] [Thread-1 (]: On model.site_dev.tactical_articles_card_month_12: BEGIN
[0m13:42:16.074657 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m13:42:17.667751 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:42:17.669752 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.tactical_articles_card_month_12"
[0m13:42:17.671744 [debug] [Thread-1 (]: On model.site_dev.tactical_articles_card_month_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.site_dev.tactical_articles_card_month_12"} */

  create view `site_dev`.`tactical_articles_card_month_12__dbt_tmp`
    
    
  as (
    





CREATE PROCEDURE `prod`.`tactical_articles_card_month_12_test_dbt`()
BEGIN
    WITH last_30_day AS (
        SELECT siteId as siteId, COUNT(date) as value 
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND categories <> "Nyhedsoverblik"
        AND siteid = '12'
        GROUP BY 1
    ),
    last_30_days_before AS (
        SELECT siteId as siteId, COUNT(*) as value  
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND categories <> "Nyhedsoverblik"
        AND siteid = '12'
        GROUP BY 1
    )
    SELECT
        JSON_OBJECT(
            'site', ld.siteId,
            'data', JSON_OBJECT(
                'label', 'Artikler',
                'hint', 'Artikler publiceret seneste 30 dage ift. forrige 30 dage',
                'value', COALESCE(ld.value, 0),
                'change', COALESCE(ROUND(((ld.value - lb.value) / lb.value) * 100, 2), 0),
                'progressCurrent', '',
                'progressTotal', ''
            )
        ) AS json_data
    FROM last_30_day ld
    LEFT JOIN last_30_days_before lb ON ld.siteId = lb.siteId;
END;
  );
[0m13:42:18.284102 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_month_12_test_dbt`()
BEGIN
    W' at line 13
[0m13:42:18.286098 [debug] [Thread-1 (]: On model.site_dev.tactical_articles_card_month_12: ROLLBACK
[0m13:42:18.491546 [debug] [Thread-1 (]: Timing info for model.site_dev.tactical_articles_card_month_12 (execute): 13:42:16.062690 => 13:42:18.490549
[0m13:42:18.493542 [debug] [Thread-1 (]: On model.site_dev.tactical_articles_card_month_12: Close
[0m13:42:18.504512 [debug] [Thread-1 (]: Database Error in model tactical_articles_card_month_12 (models\example\tactical_articles_card_month_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_month_12_test_dbt`()
  BEGIN
      W' at line 13
  compiled Code at target\run\site_dev\models\example\tactical_articles_card_month_12.sql
[0m13:42:18.506510 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '69b2f54c-3794-4d95-a48f-36a7a27910c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D7B0C78D10>]}
[0m13:42:18.508502 [error] [Thread-1 (]: 6 of 13 ERROR creating sql view model site_dev.tactical_articles_card_month_12 . [[31mERROR[0m in 2.46s]
[0m13:42:18.512491 [debug] [Thread-1 (]: Finished running node model.site_dev.tactical_articles_card_month_12
[0m13:42:18.513488 [debug] [Thread-1 (]: Began running node model.site_dev.tactical_articles_card_year_12_test_dbt
[0m13:42:18.515492 [info ] [Thread-1 (]: 7 of 13 START sql view model site_dev.tactical_articles_card_year_12_test_dbt .. [RUN]
[0m13:42:18.521466 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.site_dev.tactical_articles_card_month_12, now model.site_dev.tactical_articles_card_year_12_test_dbt)
[0m13:42:18.523462 [debug] [Thread-1 (]: Began compiling node model.site_dev.tactical_articles_card_year_12_test_dbt
[0m13:42:18.540416 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.tactical_articles_card_year_12_test_dbt"
[0m13:42:18.617210 [debug] [Thread-1 (]: Timing info for model.site_dev.tactical_articles_card_year_12_test_dbt (compile): 13:42:18.524460 => 13:42:18.616213
[0m13:42:18.620203 [debug] [Thread-1 (]: Began executing node model.site_dev.tactical_articles_card_year_12_test_dbt
[0m13:42:18.633169 [debug] [Thread-1 (]: Writing runtime sql for node "model.site_dev.tactical_articles_card_year_12_test_dbt"
[0m13:42:18.636160 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.tactical_articles_card_year_12_test_dbt"
[0m13:42:18.638156 [debug] [Thread-1 (]: On model.site_dev.tactical_articles_card_year_12_test_dbt: BEGIN
[0m13:42:18.640149 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m13:42:20.222033 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:42:20.224030 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.tactical_articles_card_year_12_test_dbt"
[0m13:42:20.227021 [debug] [Thread-1 (]: On model.site_dev.tactical_articles_card_year_12_test_dbt: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.site_dev.tactical_articles_card_year_12_test_dbt"} */

  create view `site_dev`.`tactical_articles_card_year_12_test_dbt__dbt_tmp`
    
    
  as (
    






CREATE PROCEDURE `prod`.`tactical_articles_card_year_12_test_dbt`()
BEGIN
    WITH last_30_day AS (
        SELECT siteId as siteId, COUNT(date) as value 
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND categories <> "Nyhedsoverblik"
        AND siteid = '12'
        GROUP BY 1
    ),
    last_30_days_before AS (
        SELECT siteId as siteId, COUNT(*) as value  
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY)  AND categories <> "Nyhedsoverblik"
        AND siteid = '12'
        GROUP BY 1
    )
    SELECT
        JSON_OBJECT(
            'site', ld.siteId,
            'data', JSON_OBJECT(
                'label', 'Artikler',
                'hint', 'Artikler publiceret seneste 30 dage ift. forrige 30 dage',
                'value', COALESCE(ld.value, 0),
                'change', COALESCE(ROUND(((ld.value - lb.value) / lb.value) * 100, 2), 0),
                'progressCurrent', '',
                'progressTotal', ''
            )
        ) AS json_data
    FROM last_30_day ld
    LEFT JOIN last_30_days_before lb ON ld.siteId = lb.siteId;
END;
  );
[0m13:42:20.881154 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_year_12_test_dbt`()
BEGIN
    WI' at line 14
[0m13:42:20.883155 [debug] [Thread-1 (]: On model.site_dev.tactical_articles_card_year_12_test_dbt: ROLLBACK
[0m13:42:21.091662 [debug] [Thread-1 (]: Timing info for model.site_dev.tactical_articles_card_year_12_test_dbt (execute): 13:42:18.621200 => 13:42:21.090656
[0m13:42:21.093654 [debug] [Thread-1 (]: On model.site_dev.tactical_articles_card_year_12_test_dbt: Close
[0m13:42:21.103628 [debug] [Thread-1 (]: Database Error in model tactical_articles_card_year_12_test_dbt (models\example\tactical_articles_card_year_12_test_dbt.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_year_12_test_dbt`()
  BEGIN
      WI' at line 14
  compiled Code at target\run\site_dev\models\example\tactical_articles_card_year_12_test_dbt.sql
[0m13:42:21.105626 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '69b2f54c-3794-4d95-a48f-36a7a27910c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D7B0C6EC10>]}
[0m13:42:21.106620 [error] [Thread-1 (]: 7 of 13 ERROR creating sql view model site_dev.tactical_articles_card_year_12_test_dbt  [[31mERROR[0m in 2.58s]
[0m13:42:21.108614 [debug] [Thread-1 (]: Finished running node model.site_dev.tactical_articles_card_year_12_test_dbt
[0m13:42:21.108614 [debug] [Thread-1 (]: Began running node model.site_dev.tactical_articles_cards
[0m13:42:21.109611 [info ] [Thread-1 (]: 8 of 13 START sql view model site_dev.tactical_articles_cards .................. [RUN]
[0m13:42:21.111606 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.site_dev.tactical_articles_card_year_12_test_dbt, now model.site_dev.tactical_articles_cards)
[0m13:42:21.112602 [debug] [Thread-1 (]: Began compiling node model.site_dev.tactical_articles_cards
[0m13:42:21.119585 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.tactical_articles_cards"
[0m13:42:21.121581 [debug] [Thread-1 (]: Timing info for model.site_dev.tactical_articles_cards (compile): 13:42:21.113599 => 13:42:21.120580
[0m13:42:21.122577 [debug] [Thread-1 (]: Began executing node model.site_dev.tactical_articles_cards
[0m13:42:21.128562 [debug] [Thread-1 (]: Writing runtime sql for node "model.site_dev.tactical_articles_cards"
[0m13:42:21.130556 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.tactical_articles_cards"
[0m13:42:21.131553 [debug] [Thread-1 (]: On model.site_dev.tactical_articles_cards: BEGIN
[0m13:42:21.132549 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m13:42:22.896340 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:42:22.898333 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.tactical_articles_cards"
[0m13:42:22.900322 [debug] [Thread-1 (]: On model.site_dev.tactical_articles_cards: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.site_dev.tactical_articles_cards"} */

  create view `site_dev`.`tactical_articles_cards__dbt_tmp`
    
    
  as (
    
  PREPARE stmt FROM @sql_query;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt;
END;
  );
[0m13:42:23.508990 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'PREPARE stmt FROM @sql_query;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt;
END;
  ' at line 8
[0m13:42:23.509997 [debug] [Thread-1 (]: On model.site_dev.tactical_articles_cards: ROLLBACK
[0m13:42:23.716123 [debug] [Thread-1 (]: Timing info for model.site_dev.tactical_articles_cards (execute): 13:42:21.123573 => 13:42:23.715129
[0m13:42:23.719114 [debug] [Thread-1 (]: On model.site_dev.tactical_articles_cards: Close
[0m13:42:23.734072 [debug] [Thread-1 (]: Database Error in model tactical_articles_cards (models\nextClick\tactical_articles_cards.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'PREPARE stmt FROM @sql_query;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
  END;
    ' at line 8
  compiled Code at target\run\site_dev\models\nextClick\tactical_articles_cards.sql
[0m13:42:23.738063 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '69b2f54c-3794-4d95-a48f-36a7a27910c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D7B0C71810>]}
[0m13:42:23.740057 [error] [Thread-1 (]: 8 of 13 ERROR creating sql view model site_dev.tactical_articles_cards ......... [[31mERROR[0m in 2.63s]
[0m13:42:23.743049 [debug] [Thread-1 (]: Finished running node model.site_dev.tactical_articles_cards
[0m13:42:23.744083 [debug] [Thread-1 (]: Began running node model.site_dev.tactical_userneeds_pageviews_chart
[0m13:42:23.747039 [info ] [Thread-1 (]: 9 of 13 START sql view model site_dev.tactical_userneeds_pageviews_chart ....... [RUN]
[0m13:42:23.748810 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.site_dev.tactical_articles_cards, now model.site_dev.tactical_userneeds_pageviews_chart)
[0m13:42:23.749807 [debug] [Thread-1 (]: Began compiling node model.site_dev.tactical_userneeds_pageviews_chart
[0m13:42:23.768756 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.tactical_userneeds_pageviews_chart"
[0m13:42:23.775184 [debug] [Thread-1 (]: Timing info for model.site_dev.tactical_userneeds_pageviews_chart (compile): 13:42:23.750804 => 13:42:23.774182
[0m13:42:23.776179 [debug] [Thread-1 (]: Began executing node model.site_dev.tactical_userneeds_pageviews_chart
[0m13:42:23.783160 [debug] [Thread-1 (]: Writing runtime sql for node "model.site_dev.tactical_userneeds_pageviews_chart"
[0m13:42:23.785156 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.tactical_userneeds_pageviews_chart"
[0m13:42:23.786154 [debug] [Thread-1 (]: On model.site_dev.tactical_userneeds_pageviews_chart: BEGIN
[0m13:42:23.787150 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m13:42:25.327975 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:42:25.329966 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.tactical_userneeds_pageviews_chart"
[0m13:42:25.331962 [debug] [Thread-1 (]: On model.site_dev.tactical_userneeds_pageviews_chart: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.site_dev.tactical_userneeds_pageviews_chart"} */

  create view `site_dev`.`tactical_userneeds_pageviews_chart__dbt_tmp`
    
    
  as (
    CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_month_11_dbt_test`(
    IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val TEXT,
    IN order_statement VARCHAR(2000),
    IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
    IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
    IN event_action VARCHAR(255)
)
BEGIN
    DECLARE sql_query TEXT; -- Declare variable to hold dynamic SQL query

    -- Construct the dynamic SQL query
    SET @sql_query = CONCAT('
        WITH ')
         
    PREPARE stmt FROM @sql_query;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
END;
  );
[0m13:42:25.912533 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_' at line 7
[0m13:42:25.915523 [debug] [Thread-1 (]: On model.site_dev.tactical_userneeds_pageviews_chart: ROLLBACK
[0m13:42:26.111121 [debug] [Thread-1 (]: Timing info for model.site_dev.tactical_userneeds_pageviews_chart (execute): 13:42:23.776179 => 13:42:26.109115
[0m13:42:26.114112 [debug] [Thread-1 (]: On model.site_dev.tactical_userneeds_pageviews_chart: Close
[0m13:42:26.128075 [debug] [Thread-1 (]: Database Error in model tactical_userneeds_pageviews_chart (models\nextClick\tactical_userneeds_pageviews_chart.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_' at line 7
  compiled Code at target\run\site_dev\models\nextClick\tactical_userneeds_pageviews_chart.sql
[0m13:42:26.130071 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '69b2f54c-3794-4d95-a48f-36a7a27910c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D7B08B2390>]}
[0m13:42:26.132061 [error] [Thread-1 (]: 9 of 13 ERROR creating sql view model site_dev.tactical_userneeds_pageviews_chart  [[31mERROR[0m in 2.38s]
[0m13:42:26.135051 [debug] [Thread-1 (]: Finished running node model.site_dev.tactical_userneeds_pageviews_chart
[0m13:42:26.136047 [debug] [Thread-1 (]: Began running node model.site_dev.tactical_userneeds_pageviews_chart_month_13
[0m13:42:26.138051 [info ] [Thread-1 (]: 10 of 13 START sql view model site_dev.tactical_userneeds_pageviews_chart_month_13  [RUN]
[0m13:42:26.140039 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.site_dev.tactical_userneeds_pageviews_chart, now model.site_dev.tactical_userneeds_pageviews_chart_month_13)
[0m13:42:26.141035 [debug] [Thread-1 (]: Began compiling node model.site_dev.tactical_userneeds_pageviews_chart_month_13
[0m13:42:26.162013 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.tactical_userneeds_pageviews_chart_month_13"
[0m13:42:26.163975 [debug] [Thread-1 (]: Timing info for model.site_dev.tactical_userneeds_pageviews_chart_month_13 (compile): 13:42:26.142033 => 13:42:26.163975
[0m13:42:26.164970 [debug] [Thread-1 (]: Began executing node model.site_dev.tactical_userneeds_pageviews_chart_month_13
[0m13:42:26.170954 [debug] [Thread-1 (]: Writing runtime sql for node "model.site_dev.tactical_userneeds_pageviews_chart_month_13"
[0m13:42:26.172950 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.tactical_userneeds_pageviews_chart_month_13"
[0m13:42:26.173952 [debug] [Thread-1 (]: On model.site_dev.tactical_userneeds_pageviews_chart_month_13: BEGIN
[0m13:42:26.173952 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m13:42:27.841553 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:42:27.843548 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.tactical_userneeds_pageviews_chart_month_13"
[0m13:42:27.845545 [debug] [Thread-1 (]: On model.site_dev.tactical_userneeds_pageviews_chart_month_13: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.site_dev.tactical_userneeds_pageviews_chart_month_13"} */

  create view `site_dev`.`tactical_userneeds_pageviews_chart_month_13__dbt_tmp`
    
    
  as (
    CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_month_13_dbt_test`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    

    SELECT 
		CONCAT(
        ''{'',
            ''"site":'',jd.siteid,'','',
            ''"data": {'',
                ''"label": "'', jd.lab, ''",'',
                ''"categories": ['', jd.cat, ''],'',
                ''"series": ['', jd.series, '']'',
                '',"defaultTitle":"',dtitle,'"'',
                '',"additional":[ ''
                
        '']}}''
    
			) as json_data
		  FROM json_data jd
          ;
  );
[0m13:42:28.431903 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_' at line 7
[0m13:42:28.433888 [debug] [Thread-1 (]: On model.site_dev.tactical_userneeds_pageviews_chart_month_13: ROLLBACK
[0m13:42:28.631707 [debug] [Thread-1 (]: Timing info for model.site_dev.tactical_userneeds_pageviews_chart_month_13 (execute): 13:42:26.165969 => 13:42:28.629716
[0m13:42:28.634705 [debug] [Thread-1 (]: On model.site_dev.tactical_userneeds_pageviews_chart_month_13: Close
[0m13:42:28.642674 [debug] [Thread-1 (]: Database Error in model tactical_userneeds_pageviews_chart_month_13 (models\nextClick\tactical_userneeds_pageviews_chart_month_13.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_' at line 7
  compiled Code at target\run\site_dev\models\nextClick\tactical_userneeds_pageviews_chart_month_13.sql
[0m13:42:28.644668 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '69b2f54c-3794-4d95-a48f-36a7a27910c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D7B0B10690>]}
[0m13:42:28.645664 [error] [Thread-1 (]: 10 of 13 ERROR creating sql view model site_dev.tactical_userneeds_pageviews_chart_month_13  [[31mERROR[0m in 2.50s]
[0m13:42:28.648661 [debug] [Thread-1 (]: Finished running node model.site_dev.tactical_userneeds_pageviews_chart_month_13
[0m13:42:28.650653 [debug] [Thread-1 (]: Began running node model.site_dev.tactical_userneeds_pageviews_chart_month_13.sql_output
[0m13:42:28.651658 [info ] [Thread-1 (]: 11 of 13 START sql view model site_dev.tactical_userneeds_pageviews_chart_month_13.sql_output  [RUN]
[0m13:42:28.654092 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.site_dev.tactical_userneeds_pageviews_chart_month_13, now model.site_dev.tactical_userneeds_pageviews_chart_month_13.sql_output)
[0m13:42:28.655089 [debug] [Thread-1 (]: Began compiling node model.site_dev.tactical_userneeds_pageviews_chart_month_13.sql_output
[0m13:42:28.662088 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.tactical_userneeds_pageviews_chart_month_13.sql_output"
[0m13:42:28.746265 [debug] [Thread-1 (]: Timing info for model.site_dev.tactical_userneeds_pageviews_chart_month_13.sql_output (compile): 13:42:28.656086 => 13:42:28.745266
[0m13:42:28.748258 [debug] [Thread-1 (]: Began executing node model.site_dev.tactical_userneeds_pageviews_chart_month_13.sql_output
[0m13:42:28.759228 [debug] [Thread-1 (]: Writing runtime sql for node "model.site_dev.tactical_userneeds_pageviews_chart_month_13.sql_output"
[0m13:42:28.763219 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.tactical_userneeds_pageviews_chart_month_13.sql_output"
[0m13:42:28.764215 [debug] [Thread-1 (]: On model.site_dev.tactical_userneeds_pageviews_chart_month_13.sql_output: BEGIN
[0m13:42:28.765213 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m13:42:30.327130 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:42:30.330119 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.tactical_userneeds_pageviews_chart_month_13.sql_output"
[0m13:42:30.336145 [debug] [Thread-1 (]: On model.site_dev.tactical_userneeds_pageviews_chart_month_13.sql_output: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.site_dev.tactical_userneeds_pageviews_chart_month_13.sql_output"} */

  create view `site_dev`.`tactical_userneeds_pageviews_chart_month_13.sql_output__dbt_tmp`
    
    
  as (
    CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_month_13_dbt_test`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    
    last_30_days_article_published as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN userneeds like "%Opdater mig%" then "Opdater mig"
			    WHEN userneeds like "%Forbind mig%" then "Forbind mig"
			    WHEN userneeds like "%Hjælp mig med at forstå%" then "Hjælp mig med at forstå"
			    WHEN userneeds like "%Giv mig en fordel%" then "Giv mig en fordel"
			    WHEN userneeds like "%Underhold mig%" then "Underhold mig"
			    WHEN userneeds like "%Inspirer mig%" then "Inspirer mig"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date BETWEEN MAKEDATE(EXTRACT(YEAR FROM CURDATE()), 1) AND DATE_SUB(CURDATE(), INTERVAL 1 DAY) AND 12),
    last_30_days_article_published_Agg as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published 
		where siteid = 12
		group by 1,2
    ),
    agg_next_click_per_article as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = Next Click
		where    e.siteid = 12  
		group by 1,2,3
		),
        cta_per_article as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article  e
			where  e.siteid = 12
			group by 1,2,3

		),
        agg_cta_per_article as(
		select siteid as siteid,tags,sum(val) as agg_sum from
        cta_per_article
		where siteid = 12
		group by 1,2
		),
        less_tg_data as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published l
		join cta_per_article a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date BETWEEN MAKEDATE(EXTRACT(YEAR FROM CURDATE()), 1) AND DATE_SUB(CURDATE(), INTERVAL 1 DAY) and g.site_id = 12
		),
        counts as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data
			group by 1,2
		),
        hits_by_tags as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data
		   where siteid = 12
		   group by 1,2)
           ,
           total_hits as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts
			where  siteid = 12
			group by 1)
            ,
            agg_data as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts h
			join total_hits t on h.siteid=t.siteid
			join last_30_days_article_published_Agg hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = 12
		),
        categories_d as (
			select 
				siteid as siteid ,
				 label data value as label,
                hint data value as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',['Opdater mig', 'Forbind mig', 'Hjælp mig med at forstå', 'Giv mig en fordel', 'Underhold mig', 'Inspirer mig'],', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',['Opdater mig', 'Forbind mig', 'Hjælp mig med at forstå', 'Giv mig en fordel', 'Underhold mig', 'Inspirer mig'],', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',['Opdater mig', 'Forbind mig', 'Hjælp mig med at forstå', 'Giv mig en fordel', 'Underhold mig', 'Inspirer mig'],', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',['Opdater mig', 'Forbind mig', 'Hjælp mig med at forstå', 'Giv mig en fordel', 'Underhold mig', 'Inspirer mig'],', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data
		group by 1,2,3
		),
        categories as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d
		),
        json_data as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories
		), 
    
    last_30_days_article_published_second as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Categories like "%Nyheder%" then "Nyheder"
			    WHEN Categories like "%Debat%" then "Debat"
			    WHEN Categories like "%Inspiration%" then "Inspiration"
			    WHEN Categories like "%Anmeldelser%" then "Anmeldelser"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE date between MAKEDATE(EXTRACT(YEAR FROM CURDATE()),1)  and  DATE_SUB(cast(NOW() as date), INTERVAL 1 DAY) AND 12),
    last_30_days_article_published_Agg_second as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_second 
		where siteid = 12
		group by 1,2
    ),
    agg_next_click_per_article_second as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_second  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = Next Click
		where    e.siteid = 12  
		group by 1,2,3
		),
        cta_per_article_second as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_second  e
			where  e.siteid = 12
			group by 1,2,3

		),
        agg_cta_per_article_second as(
		select siteid as siteid,tags,sum(val) as agg_sum from
        cta_per_article_second
		where siteid = 12
		group by 1,2
		),
        less_tg_data_second as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_second l
		join cta_per_article_second a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where date between MAKEDATE(EXTRACT(YEAR FROM CURDATE()),1)  and  DATE_SUB(cast(NOW() as date), INTERVAL 1 DAY) and g.site_id = 12
		),
        counts_second as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_second
			group by 1,2
		),
        hits_by_tags_second as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_second
		   where siteid = 12
		   group by 1,2)
           ,
           total_hits_second as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_second
			where  siteid = 12
			group by 1)
            ,
            agg_data_second as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_second h
			join total_hits_second t on h.siteid=t.siteid
			join last_30_days_article_published_Agg_second hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = 12
		),
        categories_d_second as (
			select 
				siteid as siteid ,
				 label data value as label,
                hint data value as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',['Nyheder', 'Debat', 'Inspiration', 'Anmeldelser'],', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',['Nyheder', 'Debat', 'Inspiration', 'Anmeldelser'],', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',['Nyheder', 'Debat', 'Inspiration', 'Anmeldelser'],', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',['Nyheder', 'Debat', 'Inspiration', 'Anmeldelser'],', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_second
		group by 1,2,3
		),
        categories_second as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_second
		),
        json_data_second as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_second
		), 
    
    last_30_days_article_published_third as
    (
        SELECT
            siteid as siteid,
            id,
            date as fdate,
		    CASE
			    WHEN Tags like "%skolepolitik%" then "skolepolitik"
			    WHEN Tags like "%Psykisk arbejdsmiljø%" then "Psykisk arbejdsmiljø"
			    ELSE ''others''
		    END AS tags
        FROM prod.site_archive_post   
        WHERE  AND 12),
    last_30_days_article_published_Agg_third as
    (
        SELECT
            siteid as siteid,tags,count(*) as agg
        from
        last_30_days_article_published_third 
		where siteid = 12
		group by 1,2
    ),
    agg_next_click_per_article_third as 
      (
		SELECT  
			e.siteid as siteid,
            e.id as postid,
            e.tags,
            coalesce(sum(hits),0) as val,
			coalesce(sum(unique_pageviews),0) as page_view 
		from last_30_days_article_published_third  e
		left join prod.pages p on p.postid=e.id and p.siteid =e.siteid
		left join prod.events  a on a.postid=e.id and a.siteid = e.siteid and a.event_action = Next Click
		where    e.siteid = 12  
		group by 1,2,3
		),
        cta_per_article_third as
		( 
			SELECT
              e.siteid as siteid,
              e.postid, e.tags,
			round(coalesce((coalesce(val,0)/coalesce(page_view,1)),0.0)*100.0,2) as val 
            from agg_next_click_per_article_third  e
			where  e.siteid = 12
			group by 1,2,3

		),
        agg_cta_per_article_third as(
		select siteid as siteid,tags,sum(val) as agg_sum from
        cta_per_article_third
		where siteid = 12
		group by 1,2
		),
        less_tg_data_third as(
		select 
		postid,l.tags ,val,min_cta
		,a.siteid,
		case when val<min_cta then 1 else 0 end as less_than_target
		,percent_rank() over ( order BY case when val>=min_cta then val-min_cta else 0 end) as percentile
		 from last_30_days_article_published_third l
		join cta_per_article_third a on l.siteid = a.siteid and l.id = a.postid and l.tags=a.tags
		join prod.goals g on a.siteid = g.site_id and g.Date = l.fdate
		 where  and g.site_id = 12
		),
        counts_third as (
			select 
				siteid,
				tags,
				sum(less_than_target) as less_than_target_count,
				sum(case when percentile <= 1 and percentile >= 0.9 then 1 else 0 end) as top_10_count,
				sum(case when percentile >= 0 and percentile < 0.9 and less_than_target = 0 then 1 else 0 end) as approved_count
			from less_tg_data_third
			group by 1,2
		),
        hits_by_tags_third as(
			select 
				siteid as siteid,
				tags,
				sum(less_than_target) as hits_tags,
				sum(case when percentile<=1 and percentile>=0.9 then val else 0 end) sum_by_top_10,
				sum(case when percentile>=0 and percentile<0.9 and less_than_target=0 then val else 0 end) sum_by_approved
		   from less_tg_data_third
		   where siteid = 12
		   group by 1,2)
           ,
           total_hits_third as(
			select 
				siteid as siteid ,
				sum(less_than_target_count) as total_tags_hit,
                sum(top_10_count) as agg_by_top_10,
                sum(approved_count) as agg_by_approved 
			from counts_third
			where  siteid = 12
			group by 1)
            ,
            agg_data_third as(
			select 
				h.siteid as siteid ,
				h.tags,
				coalesce(less_than_target_count/total_tags_hit,0)*100 as less_than_target ,
				coalesce(top_10_count/agg_by_top_10,0)*100 as top_10,
				coalesce(approved_count/agg_by_approved,0)*100 as  approved
			from counts_third h
			join total_hits_third t on h.siteid=t.siteid
			join last_30_days_article_published_Agg_third hbt on hbt.siteid=h.siteid and hbt.tags=h.tags
			where h.siteid  = 12
		),
        categories_d_third as (
			select 
				siteid as siteid ,
				 label data value as label,
                hint data value as hint,
				GROUP_CONCAT(tags ORDER BY FIELD(tags, ',['skolepolitik', 'Psykisk arbejdsmiljø'],', ''others'' ) SEPARATOR '','') AS cateogires,
				GROUP_CONCAT(COALESCE(less_than_target, 0) ORDER BY FIELD(tags, ',['skolepolitik', 'Psykisk arbejdsmiljø'],', ''others'' ) SEPARATOR '','') AS less_than_target,
			GROUP_CONCAT(approved ORDER BY FIELD(tags, ',['skolepolitik', 'Psykisk arbejdsmiljø'],', ''others'' ) SEPARATOR '','') AS approved,
			GROUP_CONCAT(top_10 ORDER BY FIELD(tags, ',['skolepolitik', 'Psykisk arbejdsmiljø'],', ''others'' ) SEPARATOR '','') AS top_10
		from agg_data_third
		group by 1,2,3
		),
        categories_third as (
		select siteid as siteid ,label as label, hint as hint,  
		 CONCAT(''"'', REPLACE(cateogires, '','', ''","''), ''"'') AS  cateogires,
		less_than_target as less_than_target ,
		approved as approved ,
		 top_10 as top_10 
		 from  categories_d_third
		),
        json_data_third as
		(
		select siteid,label as lab,hint as h,cateogires as cat,CONCAT(
		''{"name": "Under mål", "data": ['',cast(less_than_target as char),'']}''
		,'',{"name": "Over mål" ,"data": ['',cast(approved as char),'']}'','',
        {"name": "Top 10%" ,"data": ['',cast(top_10 as char),'']}'') 
        as series from categories_third
		)
    

    SELECT 
		CONCAT(
        ''{'',
            ''"site":'',jd.siteid,'','',
            ''"data": {'',
                ''"label": "'', jd.lab, ''",'',
                ''"categories": ['', jd.cat, ''],'',
                ''"series": ['', jd.series, '']'',
                '',"defaultTitle":"',dtitle,'"'',
                '',"additional":[ ''
                
                ,''{'',
                ''"title":"',title1,'",'',
                ''"data": {'',
                ''"label": "'',json_data_second.lab, ''",'',
                ''"categories": ['', json_data_second.cat, ''],'',
                ''"series": ['', json_data_second.series, '']'',
                ''}}''
                
                , '',''
                
                
                ,''{'',
                ''"title":"',title2,'",'',
                ''"data": {'',
                ''"label": "'',json_data_third.lab, ''",'',
                ''"categories": ['', json_data_third.cat, ''],'',
                ''"series": ['', json_data_third.series, '']'',
                ''}}''
                
                
        '']}}''
    
			) as json_data
		  FROM json_data jd
          
          CROSS join json_data_second
          
          CROSS join json_data_third
          ;
  );
[0m13:42:31.124228 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_' at line 7
[0m13:42:31.125230 [debug] [Thread-1 (]: On model.site_dev.tactical_userneeds_pageviews_chart_month_13.sql_output: ROLLBACK
[0m13:42:31.320658 [debug] [Thread-1 (]: Timing info for model.site_dev.tactical_userneeds_pageviews_chart_month_13.sql_output (execute): 13:42:28.749255 => 13:42:31.319664
[0m13:42:31.323653 [debug] [Thread-1 (]: On model.site_dev.tactical_userneeds_pageviews_chart_month_13.sql_output: Close
[0m13:42:31.337613 [debug] [Thread-1 (]: Database Error in model tactical_userneeds_pageviews_chart_month_13.sql_output (models\nextClick\tactical_userneeds_pageviews_chart_month_13.sql_output.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_' at line 7
  compiled Code at target\run\site_dev\models\nextClick\tactical_userneeds_pageviews_chart_month_13.sql_output.sql
[0m13:42:31.339609 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '69b2f54c-3794-4d95-a48f-36a7a27910c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D7B0AE70D0>]}
[0m13:42:31.342596 [error] [Thread-1 (]: 11 of 13 ERROR creating sql view model site_dev.tactical_userneeds_pageviews_chart_month_13.sql_output  [[31mERROR[0m in 2.69s]
[0m13:42:31.344440 [debug] [Thread-1 (]: Finished running node model.site_dev.tactical_userneeds_pageviews_chart_month_13.sql_output
[0m13:42:31.345436 [debug] [Thread-1 (]: Began running node model.site_dev.test
[0m13:42:31.347431 [info ] [Thread-1 (]: 12 of 13 START sql view model site_dev.test .................................... [RUN]
[0m13:42:31.349428 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.site_dev.tactical_userneeds_pageviews_chart_month_13.sql_output, now model.site_dev.test)
[0m13:42:31.350423 [debug] [Thread-1 (]: Began compiling node model.site_dev.test
[0m13:42:31.376353 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.test"
[0m13:42:31.378347 [debug] [Thread-1 (]: Timing info for model.site_dev.test (compile): 13:42:31.351422 => 13:42:31.377354
[0m13:42:31.379346 [debug] [Thread-1 (]: Began executing node model.site_dev.test
[0m13:42:31.385329 [debug] [Thread-1 (]: Writing runtime sql for node "model.site_dev.test"
[0m13:42:31.386328 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.test"
[0m13:42:31.387323 [debug] [Thread-1 (]: On model.site_dev.test: BEGIN
[0m13:42:31.389318 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m13:42:32.940306 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:42:32.944295 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.test"
[0m13:42:32.946287 [debug] [Thread-1 (]: On model.site_dev.test: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.site_dev.test"} */

  create view `site_dev`.`test__dbt_tmp`
    
    
  as (
    CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_month_13_dbt_test`(
	IN site INT,
    IN label_val VARCHAR(200),
    IN hint_val text,
    IN order_statement  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
    IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
    IN title1 VARCHAR(200),
    IN title2 VARCHAR(200),
   IN event_action VARCHAR(255)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    

    SELECT 
		CONCAT(
        ''{'',
            ''"site":'',jd.siteid,'','',
            ''"data": {'',
                ''"label": "'', jd.lab, ''",'',
                ''"categories": ['', jd.cat, ''],'',
                ''"series": ['', jd.series, '']'',
                '',"defaultTitle":"',dtitle,'"'',
                '',"additional":[ ''
                
        '']}}''
    
			) as json_data
		  FROM json_data jd
          ;
  );
[0m13:42:33.529952 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_' at line 7
[0m13:42:33.532944 [debug] [Thread-1 (]: On model.site_dev.test: ROLLBACK
[0m13:42:33.728508 [debug] [Thread-1 (]: Timing info for model.site_dev.test (execute): 13:42:31.379346 => 13:42:33.726502
[0m13:42:33.731495 [debug] [Thread-1 (]: On model.site_dev.test: Close
[0m13:42:33.743462 [debug] [Thread-1 (]: Database Error in model test (models\test.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_' at line 7
  compiled Code at target\run\site_dev\models\test.sql
[0m13:42:33.745457 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '69b2f54c-3794-4d95-a48f-36a7a27910c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D7B05F6CD0>]}
[0m13:42:33.747452 [error] [Thread-1 (]: 12 of 13 ERROR creating sql view model site_dev.test ........................... [[31mERROR[0m in 2.40s]
[0m13:42:33.749448 [debug] [Thread-1 (]: Finished running node model.site_dev.test
[0m13:42:33.750472 [debug] [Thread-1 (]: Began running node model.site_dev.test_by
[0m13:42:33.751477 [info ] [Thread-1 (]: 13 of 13 START sql view model site_dev.test_by ................................. [RUN]
[0m13:42:33.754152 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.site_dev.test, now model.site_dev.test_by)
[0m13:42:33.755150 [debug] [Thread-1 (]: Began compiling node model.site_dev.test_by
[0m13:42:33.773100 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.test_by"
[0m13:42:33.779413 [debug] [Thread-1 (]: Timing info for model.site_dev.test_by (compile): 13:42:33.755150 => 13:42:33.778407
[0m13:42:33.780411 [debug] [Thread-1 (]: Began executing node model.site_dev.test_by
[0m13:42:33.787390 [debug] [Thread-1 (]: Writing runtime sql for node "model.site_dev.test_by"
[0m13:42:33.789386 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.test_by"
[0m13:42:33.790389 [debug] [Thread-1 (]: On model.site_dev.test_by: BEGIN
[0m13:42:33.791380 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m13:42:35.339853 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:42:35.343850 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.test_by"
[0m13:42:35.345848 [debug] [Thread-1 (]: On model.site_dev.test_by: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.site_dev.test_by"} */

  create view `site_dev`.`test_by__dbt_tmp`
    
    
  as (
    CREATE DEFINER=`Site`@`%` PROCEDURE `tactical_category_pageviews_chart_month_13`(
	IN site INT,
  IN label_val VARCHAR(200),
  IN hint_val text,
  IN order_statement_first  VARCHAR(2000),
	IN order_statement_second VARCHAR(2000),
  IN order_statement_third VARCHAR(2000),
	IN dtitle VARCHAR(200),
  IN title1 VARCHAR(200),
  IN title2 VARCHAR(200)
)
BEGIN
    SET @sql_query = CONCAT('
    with 
    

    SELECT 
		CONCAT(
        ''{'',
            ''"site":'',jd.siteid,'','',
            ''"data": {'',
                ''"label": "'', jd.lab, ''",'',
                ''"categories": ['', jd.cat, ''],'',
                ''"series": ['', jd.series, '']'',
                '',"defaultTitle":"',,'"'',
                '',"additional":[ ''
                
        '']}}''
    
			) as json_data
		  FROM json_data jd
          ;
  );
[0m13:42:35.928055 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `tactical_category_pageviews_chart_month_13`' at line 7
[0m13:42:35.931044 [debug] [Thread-1 (]: On model.site_dev.test_by: ROLLBACK
[0m13:42:36.124736 [debug] [Thread-1 (]: Timing info for model.site_dev.test_by (execute): 13:42:33.781407 => 13:42:36.123726
[0m13:42:36.127726 [debug] [Thread-1 (]: On model.site_dev.test_by: Close
[0m13:42:36.139691 [debug] [Thread-1 (]: Database Error in model test_by (models\nextClick\test_by.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `tactical_category_pageviews_chart_month_13`' at line 7
  compiled Code at target\run\site_dev\models\nextClick\test_by.sql
[0m13:42:36.141686 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '69b2f54c-3794-4d95-a48f-36a7a27910c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D7B0A83E90>]}
[0m13:42:36.142681 [error] [Thread-1 (]: 13 of 13 ERROR creating sql view model site_dev.test_by ........................ [[31mERROR[0m in 2.39s]
[0m13:42:36.145675 [debug] [Thread-1 (]: Finished running node model.site_dev.test_by
[0m13:42:36.148665 [debug] [MainThread]: Using mysql connection "master"
[0m13:42:36.148665 [debug] [MainThread]: On master: BEGIN
[0m13:42:36.149662 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m13:42:37.706977 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:42:37.708968 [debug] [MainThread]: On master: COMMIT
[0m13:42:37.711966 [debug] [MainThread]: Using mysql connection "master"
[0m13:42:37.711966 [debug] [MainThread]: On master: COMMIT
[0m13:42:38.295191 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:42:38.298186 [debug] [MainThread]: On master: Close
[0m13:42:38.304169 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:42:38.306156 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m13:42:38.308153 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m13:42:38.311145 [debug] [MainThread]: Connection 'model.site_dev.test_by' was properly closed.
[0m13:42:38.313137 [info ] [MainThread]: 
[0m13:42:38.316130 [info ] [MainThread]: Finished running 13 view models in 0 hours 0 minutes and 41.00 seconds (41.00s).
[0m13:42:38.325121 [debug] [MainThread]: Command end result
[0m13:42:38.340064 [info ] [MainThread]: 
[0m13:42:38.342058 [info ] [MainThread]: [31mCompleted with 13 errors and 0 warnings:[0m
[0m13:42:38.342823 [info ] [MainThread]: 
[0m13:42:38.344739 [error] [MainThread]:   Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
  BEGIN
      WITH cu' at line 16
  compiled Code at target\run\site_dev\models\example\Tactical_clicks_months_12.sql
[0m13:42:38.345736 [info ] [MainThread]: 
[0m13:42:38.347929 [error] [MainThread]:   Database Error in model cards (models\cards.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `tactical_articles_card_month`(
  IN site INT' at line 7
  compiled Code at target\run\site_dev\models\cards.sql
[0m13:42:38.349924 [info ] [MainThread]: 
[0m13:42:38.352916 [error] [MainThread]:   Database Error in model example_by (models\example_by.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `example_procedure`(
      IN site_id INT,
      IN event_action VA' at line 9
  compiled Code at target\run\site_dev\models\example_by.sql
[0m13:42:38.357187 [info ] [MainThread]: 
[0m13:42:38.358185 [error] [MainThread]:   Database Error in model example_by_me (models\nextClick\example_by_me.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `example_procedure`(
      IN site_id INT,
      IN event_action VA' at line 9
  compiled Code at target\run\site_dev\models\nextClick\example_by_me.sql
[0m13:42:38.359754 [info ] [MainThread]: 
[0m13:42:38.362099 [error] [MainThread]:   Compilation Error in model overview_sales_card_12 (models\example\overview_sales_card_12.sql)
  Required var 'json' not found in config:
  Vars supplied to overview_sales_card_12 = {
      "article_evaluation": {
          "over_both_goals": {
              "case": "((coalesce(coalesce(l.hits,0)/coalesce(l.pageviews,0)*100,0))>=coalesce(g.Min_CTA,0) and coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0) )",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          },
          "under_both_goal": {
              "case": "(coalesce((coalesce(l.hits,0)/coalesce(l.pageviews,0)*100),0)<coalesce(g.Min_CTA,0) and coalesce(l.pageviews,0)<coalesce(g.Min_pageviews,0) )",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          },
          "under_one_goal": {
              "case": "(coalesce( coalesce((coalesce(l.hits,0) / coalesce(l.pageviews,0)),0) * 100 , 0)>=coalesce(g.Min_CTA,0) or coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0)) and !((coalesce( coalesce((coalesce(l.hits,0) / coalesce(l.pageviews,0)),0) * 100 , 0))>=coalesce(g.Min_CTA,0) and  coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0) ) ",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          }
      },
      "date_month": "DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)",
      "date_month_before": "DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) ",
      "date_week": "DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)",
      "date_year": "MAKEDATE(EXTRACT(YEAR FROM CURDATE()), 1) AND DATE_SUB(CAST(NOW() AS DATE), INTERVAL 1 DAY)",
      "event_action": "Next Click",
      "overview": {
          "overview_pageviews_card": {
              "hint": "Sidevisninger \u00e5r til dato ift sidste \u00e5r til dato og ift m\u00e5ls\u00e6tning",
              "label": "Sidevisninger"
          },
          "overview_sales_card": {
              "hint": "Gns. next click \u00e5r til dato ift. sidste \u00e5r",
              "label": "Next click (%)"
          },
          "overview_visits_card": {
              "hint": "Bes\u00f8g \u00e5r til dato ift sidste \u00e5r til dato og ift m\u00e5ls\u00e6tning",
              "label": "Bes\u00f8g"
          }
      },
      "site": 12,
      "tendency": {
          "tactical_articles_card": {
              "hint": "Artikler publiceret seneste 30 dage ift. forrige 30 dage",
              "label": "Artikler"
          },
          "tactical_clicks_card": {
              "hint": "Gns. next click p\u00e5 artikler publiceret seneste 30 dage ift. forrige 30 dage",
              "label": "Gns. next click (%)"
          },
          "tactical_pageviews_card": {
              "hint": "Gns. sidevisninger pr artikler publiceret \u00e5r til dato ift. sidste \u00e5r til dato",
              "label": "Gns. sidevisninger pr artikel"
          },
          "tactical_userneeds_pageviews_chart": {
              "dropdown_count": [
                  "",
                  "_second",
                  "_third"
              ],
              "dropdown_name": {
                  "Categories": "Categories",
                  "Tags": "Tags",
                  "userneeds": "userneeds"
              },
              "dropdown_val": {
                  "categories": [
                      "Nyheder",
                      "Debat",
                      "Inspiration",
                      "Anmeldelser"
                  ],
                  "tags": [
                      "skolepolitik",
                      "Psykisk arbejdsmilj\u00f8"
                  ],
                  "userneeds": [
                      "Opdater mig",
                      "Forbind mig",
                      "Hj\u00e6lp mig med at forst\u00e5",
                      "Giv mig en fordel",
                      "Underhold mig",
                      "Inspirer mig"
                  ]
              },
              "hint": "Artikler grupperet ift hvordan de har performet p\u00e5 next click",
              "label": "Artikler ift. next click m\u00e5l"
          }
      }
  }
[0m13:42:38.367019 [info ] [MainThread]: 
[0m13:42:38.372998 [error] [MainThread]:   Database Error in model tactical_articles_card_month_12 (models\example\tactical_articles_card_month_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_month_12_test_dbt`()
  BEGIN
      W' at line 13
  compiled Code at target\run\site_dev\models\example\tactical_articles_card_month_12.sql
[0m13:42:38.375153 [info ] [MainThread]: 
[0m13:42:38.376133 [error] [MainThread]:   Database Error in model tactical_articles_card_year_12_test_dbt (models\example\tactical_articles_card_year_12_test_dbt.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_year_12_test_dbt`()
  BEGIN
      WI' at line 14
  compiled Code at target\run\site_dev\models\example\tactical_articles_card_year_12_test_dbt.sql
[0m13:42:38.378129 [info ] [MainThread]: 
[0m13:42:38.379124 [error] [MainThread]:   Database Error in model tactical_articles_cards (models\nextClick\tactical_articles_cards.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'PREPARE stmt FROM @sql_query;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
  END;
    ' at line 8
  compiled Code at target\run\site_dev\models\nextClick\tactical_articles_cards.sql
[0m13:42:38.382123 [info ] [MainThread]: 
[0m13:42:38.388123 [error] [MainThread]:   Database Error in model tactical_userneeds_pageviews_chart (models\nextClick\tactical_userneeds_pageviews_chart.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_' at line 7
  compiled Code at target\run\site_dev\models\nextClick\tactical_userneeds_pageviews_chart.sql
[0m13:42:38.390109 [info ] [MainThread]: 
[0m13:42:38.391092 [error] [MainThread]:   Database Error in model tactical_userneeds_pageviews_chart_month_13 (models\nextClick\tactical_userneeds_pageviews_chart_month_13.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_' at line 7
  compiled Code at target\run\site_dev\models\nextClick\tactical_userneeds_pageviews_chart_month_13.sql
[0m13:42:38.393088 [info ] [MainThread]: 
[0m13:42:38.394084 [error] [MainThread]:   Database Error in model tactical_userneeds_pageviews_chart_month_13.sql_output (models\nextClick\tactical_userneeds_pageviews_chart_month_13.sql_output.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_' at line 7
  compiled Code at target\run\site_dev\models\nextClick\tactical_userneeds_pageviews_chart_month_13.sql_output.sql
[0m13:42:38.396081 [info ] [MainThread]: 
[0m13:42:38.398076 [error] [MainThread]:   Database Error in model test (models\test.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `stage`.`tactical_userneeds_pageviews_chart_' at line 7
  compiled Code at target\run\site_dev\models\test.sql
[0m13:42:38.403060 [info ] [MainThread]: 
[0m13:42:38.405054 [error] [MainThread]:   Database Error in model test_by (models\nextClick\test_by.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE DEFINER=`Site`@`%` PROCEDURE `tactical_category_pageviews_chart_month_13`' at line 7
  compiled Code at target\run\site_dev\models\nextClick\test_by.sql
[0m13:42:38.405763 [info ] [MainThread]: 
[0m13:42:38.407761 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=13 SKIP=0 TOTAL=13
[0m13:42:38.410798 [debug] [MainThread]: Command `dbt run` failed at 13:42:38.409800 after 43.54 seconds
[0m13:42:38.411815 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D7B01F5350>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D7A99F0050>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D7A99F0B90>]}
[0m13:42:38.412790 [debug] [MainThread]: Flushing usage events
[0m13:45:58.177002 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029026080B50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029026080D10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029026080B10>]}


============================== 13:45:58.186000 | 2c7a37bd-62f9-482f-88c4-f7a2e612f56a ==============================
[0m13:45:58.186000 [info ] [MainThread]: Running with dbt=1.7.17
[0m13:45:58.187974 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models example.Tactical_clicks_months_12', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m13:45:58.494524 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2c7a37bd-62f9-482f-88c4-f7a2e612f56a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000290260BED90>]}
[0m13:45:58.581292 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2c7a37bd-62f9-482f-88c4-f7a2e612f56a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002902609BF50>]}
[0m13:45:58.584044 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m13:45:58.596015 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m13:45:58.619781 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m13:45:58.620754 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m13:45:58.621631 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '2c7a37bd-62f9-482f-88c4-f7a2e612f56a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029026465090>]}
[0m13:46:00.394891 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example.run_Tactical_clicks_months_12
[0m13:46:00.406859 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2c7a37bd-62f9-482f-88c4-f7a2e612f56a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000290266151D0>]}
[0m13:46:00.461712 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2c7a37bd-62f9-482f-88c4-f7a2e612f56a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000290263AD9D0>]}
[0m13:46:00.463707 [info ] [MainThread]: Found 13 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m13:46:00.469692 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2c7a37bd-62f9-482f-88c4-f7a2e612f56a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029026329910>]}
[0m13:46:00.472684 [info ] [MainThread]: 
[0m13:46:00.474679 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m13:46:00.477670 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m13:46:00.504596 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m13:46:00.504596 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m13:46:00.505595 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:46:02.123883 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m13:46:02.133861 [debug] [ThreadPool]: On list_schemas: Close
[0m13:46:02.138649 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__prod)
[0m13:46:02.140645 [debug] [ThreadPool]: Creating schema "schema: "prod"
"
[0m13:46:02.150618 [debug] [ThreadPool]: Using mysql connection "create__prod"
[0m13:46:02.151615 [debug] [ThreadPool]: On create__prod: BEGIN
[0m13:46:02.152613 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:46:03.764195 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:46:03.766195 [debug] [ThreadPool]: Using mysql connection "create__prod"
[0m13:46:03.768184 [debug] [ThreadPool]: On create__prod: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "create__prod"} */
create schema if not exists `prod`
[0m13:46:04.388298 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m13:46:04.391298 [debug] [ThreadPool]: On create__prod: COMMIT
[0m13:46:04.392295 [debug] [ThreadPool]: Using mysql connection "create__prod"
[0m13:46:04.394290 [debug] [ThreadPool]: On create__prod: COMMIT
[0m13:46:04.980878 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:46:04.982874 [debug] [ThreadPool]: On create__prod: Close
[0m13:46:04.994432 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_prod'
[0m13:46:05.010387 [debug] [ThreadPool]: Using mysql connection "list_None_prod"
[0m13:46:05.012383 [debug] [ThreadPool]: On list_None_prod: BEGIN
[0m13:46:05.012383 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:46:06.556841 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:46:06.558833 [debug] [ThreadPool]: Using mysql connection "list_None_prod"
[0m13:46:06.561829 [debug] [ThreadPool]: On list_None_prod: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_None_prod"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'prod'
  
[0m13:46:07.155382 [debug] [ThreadPool]: SQL status: SUCCESS 144 in 1.0 seconds
[0m13:46:07.161336 [debug] [ThreadPool]: On list_None_prod: ROLLBACK
[0m13:46:07.354904 [debug] [ThreadPool]: On list_None_prod: Close
[0m13:46:07.361803 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:46:07.363777 [debug] [MainThread]: Connection 'create__prod' was properly closed.
[0m13:46:07.366776 [debug] [MainThread]: Connection 'list_None_prod' was properly closed.
[0m13:46:07.369760 [info ] [MainThread]: 
[0m13:46:07.372753 [info ] [MainThread]: Finished running  in 0 hours 0 minutes and 6.90 seconds (6.90s).
[0m13:46:07.377742 [error] [MainThread]: Encountered an error:
Field "type" of type Optional[RelationType] in MySQLRelation has invalid value "bytearray(b'view')"
[0m13:46:07.431676 [error] [MainThread]: Traceback (most recent call last):
  File "<string>", line 17, in __mashumaro_from_dict__
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\dataclass_schema.py", line 156, in _deserialize
    return cls(value)
           ^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\enum.py", line 695, in __call__
    return cls.__new__(cls, value)
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\enum.py", line 1111, in __new__
    raise ve_exc
ValueError: "bytearray(b'view')" is not a valid RelationType

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 91, in wrapper
    result, success = func(*args, **kwargs)
                      ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 76, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 169, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 198, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 245, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 278, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\main.py", line 626, in run
    results = task.run()
              ^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 502, in run
    result = self.execute_with_hooks(selected_uids)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 462, in execute_with_hooks
    self.before_run(adapter, selected_uids)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\run.py", line 451, in before_run
    self.populate_adapter_cache(adapter, required_schemas)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 440, in populate_adapter_cache
    adapter.set_relations_cache(self.manifest)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\impl.py", line 519, in set_relations_cache
    self._relations_cache_for_schemas(manifest, required_schemas)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\impl.py", line 495, in _relations_cache_for_schemas
    for relation in future.result():
                    ^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\_base.py", line 401, in __get_result
    raise self._exception
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\thread.py", line 58, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\utils.py", line 471, in connected
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\mysql\impl.py", line 82, in list_relations_without_caching
    relation = self.Relation.create(schema=_schema, identifier=name, type=relation_type)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\relation.py", line 299, in create
    return cls.from_dict(kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 19, in __mashumaro_from_dict__
mashumaro.exceptions.InvalidFieldValue: Field "type" of type Optional[RelationType] in MySQLRelation has invalid value "bytearray(b'view')"

[0m13:46:07.436305 [debug] [MainThread]: Command `dbt run` failed at 13:46:07.435310 after 9.37 seconds
[0m13:46:07.437304 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000290260C5FD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000290260DBED0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000290265FBC50>]}
[0m13:46:07.438300 [debug] [MainThread]: Flushing usage events
[0m13:46:43.849417 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000158A2FC5AD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000158A2BF1050>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000158A2A03ED0>]}


============================== 13:46:43.855402 | 7302363d-f3b9-4eeb-8a19-adc520a06d88 ==============================
[0m13:46:43.855402 [info ] [MainThread]: Running with dbt=1.7.17
[0m13:46:43.856400 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'debug': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models example.Tactical_clicks_months_12', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m13:46:44.167036 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '7302363d-f3b9-4eeb-8a19-adc520a06d88', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000158A317DB10>]}
[0m13:46:44.249814 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '7302363d-f3b9-4eeb-8a19-adc520a06d88', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000158A31A5090>]}
[0m13:46:44.252183 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m13:46:44.264153 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m13:46:44.287831 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m13:46:44.288829 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '7302363d-f3b9-4eeb-8a19-adc520a06d88', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000158A3385390>]}
[0m13:46:45.722995 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example.run_Tactical_clicks_months_12
[0m13:46:45.732966 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '7302363d-f3b9-4eeb-8a19-adc520a06d88', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000158A34F01D0>]}
[0m13:46:45.752915 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '7302363d-f3b9-4eeb-8a19-adc520a06d88', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000158A33C08D0>]}
[0m13:46:45.754909 [info ] [MainThread]: Found 13 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m13:46:45.755907 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7302363d-f3b9-4eeb-8a19-adc520a06d88', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000158A3185E90>]}
[0m13:46:45.758899 [info ] [MainThread]: 
[0m13:46:45.761382 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m13:46:45.763845 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m13:46:45.777807 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m13:46:45.778804 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m13:46:45.779801 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:46:47.540798 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m13:46:47.544781 [debug] [ThreadPool]: On list_schemas: Close
[0m13:46:47.547440 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m13:46:47.548440 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m13:46:47.555422 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:46:47.555422 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m13:46:47.556420 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:46:49.110676 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:46:49.113677 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:46:49.115688 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m13:46:49.702609 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m13:46:49.707626 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m13:46:49.708619 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:46:49.709618 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m13:46:50.293510 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:46:50.296511 [debug] [ThreadPool]: On create__site_dev: Close
[0m13:46:50.306483 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m13:46:50.315456 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m13:46:50.316454 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m13:46:50.317451 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:46:51.895149 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:46:51.897144 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m13:46:51.898143 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m13:46:52.500913 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:46:52.503896 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m13:46:52.708372 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m13:46:52.713358 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7302363d-f3b9-4eeb-8a19-adc520a06d88', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000158A3531490>]}
[0m13:46:52.717348 [debug] [MainThread]: Using mysql connection "master"
[0m13:46:52.720337 [debug] [MainThread]: On master: BEGIN
[0m13:46:52.723336 [debug] [MainThread]: Opening a new connection, currently in state init
[0m13:46:54.320433 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:46:54.323434 [debug] [MainThread]: On master: COMMIT
[0m13:46:54.325435 [debug] [MainThread]: Using mysql connection "master"
[0m13:46:54.325435 [debug] [MainThread]: On master: COMMIT
[0m13:46:54.957558 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:46:54.959562 [debug] [MainThread]: On master: Close
[0m13:46:54.962557 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m13:46:54.963547 [info ] [MainThread]: 
[0m13:46:54.970340 [debug] [Thread-1 (]: Began running node model.site_dev.Tactical_clicks_months_12
[0m13:46:54.971340 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.Tactical_clicks_months_12 ................. [RUN]
[0m13:46:54.973571 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.site_dev.Tactical_clicks_months_12'
[0m13:46:54.974568 [debug] [Thread-1 (]: Began compiling node model.site_dev.Tactical_clicks_months_12
[0m13:46:54.991521 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.Tactical_clicks_months_12"
[0m13:46:54.993518 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_clicks_months_12 (compile): 13:46:54.975566 => 13:46:54.992518
[0m13:46:54.994514 [debug] [Thread-1 (]: Began executing node model.site_dev.Tactical_clicks_months_12
[0m13:46:55.039402 [debug] [Thread-1 (]: Writing runtime sql for node "model.site_dev.Tactical_clicks_months_12"
[0m13:46:55.041390 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_clicks_months_12"
[0m13:46:55.042386 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: BEGIN
[0m13:46:55.042386 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m13:46:56.670994 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:46:56.674998 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_clicks_months_12"
[0m13:46:56.677986 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.site_dev.Tactical_clicks_months_12"} */

  create view `site_dev`.`Tactical_clicks_months_12__dbt_tmp`
    
    
  as (
    








CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
BEGIN
    WITH curr_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND categories <> "Nyhedsoverblik"
        AND siteid = '12'
    ),
    agg_curr_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks
        FROM prod.events e
        JOIN curr_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND e.siteid = '12'
        AND e.Event_Action = 'Next Click'
        GROUP BY 1
    ),
    agg_curr_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum
        FROM prod.pages p
        LEFT JOIN curr_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = '12'
        AND p.date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        GROUP BY p.siteid
    ),
    value_curr_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks / p.pageview_sum * 100, 2) AS value
        FROM agg_curr_30_days_events e
        LEFT JOIN agg_curr_30_days_pages p ON e.siteid = p.siteid
    ),
    last_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        AND siteid = site
        AND categories <> "Nyhedsoverblik"
    ),
    agg_last_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks_last
        FROM prod.events e
        JOIN last_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        AND e.siteid = '12'
        AND e.Event_Action = 'Next Click'
        GROUP BY 1
    ),
    agg_last_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum_last
        FROM prod.pages p
        LEFT JOIN last_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = '12'
        AND p.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        GROUP BY p.siteid
    ),
    value_last_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks_last / p.pageview_sum_last * 100, 2) AS value_last
        FROM agg_last_30_days_events e
        LEFT JOIN agg_last_30_days_pages p ON e.siteid = p.siteid
    )
    SELECT 
        JSON_OBJECT(
            'site', al.siteid,
            'data', JSON_OBJECT(
                'label', 'Artikler',
                'hint', 'Artikler publiceret seneste 30 dage ift. forrige 30 dage',
                'value', COALESCE(value, 0),
                'change', COALESCE(value - value_last, 0),
                'progressCurrent', '',
                'progressTotal', ''
            )
        ) AS json_data
    FROM value_curr_30_days al
    LEFT JOIN value_last_30_days alb ON al.siteid = alb.siteid
    WHERE al.siteid = '12';
END;
  );
[0m13:46:57.261206 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
BEGIN
    WITH cu' at line 16
[0m13:46:57.263197 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: ROLLBACK
[0m13:46:57.458675 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_clicks_months_12 (execute): 13:46:54.995513 => 13:46:57.458675
[0m13:46:57.460669 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: Close
[0m13:46:57.476629 [debug] [Thread-1 (]: Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
  BEGIN
      WITH cu' at line 16
  compiled Code at target\run\site_dev\models\example\Tactical_clicks_months_12.sql
[0m13:46:57.477624 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7302363d-f3b9-4eeb-8a19-adc520a06d88', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000158A3519650>]}
[0m13:46:57.479619 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.Tactical_clicks_months_12 ........ [[31mERROR[0m in 2.51s]
[0m13:46:57.482613 [debug] [Thread-1 (]: Finished running node model.site_dev.Tactical_clicks_months_12
[0m13:46:57.486600 [debug] [MainThread]: Using mysql connection "master"
[0m13:46:57.488595 [debug] [MainThread]: On master: BEGIN
[0m13:46:57.489592 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m13:46:59.095931 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:46:59.096926 [debug] [MainThread]: On master: COMMIT
[0m13:46:59.097924 [debug] [MainThread]: Using mysql connection "master"
[0m13:46:59.098921 [debug] [MainThread]: On master: COMMIT
[0m13:46:59.677764 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:46:59.679758 [debug] [MainThread]: On master: Close
[0m13:46:59.681752 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:46:59.682747 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m13:46:59.684745 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m13:46:59.685740 [debug] [MainThread]: Connection 'model.site_dev.Tactical_clicks_months_12' was properly closed.
[0m13:46:59.687734 [info ] [MainThread]: 
[0m13:46:59.689730 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 13.93 seconds (13.93s).
[0m13:46:59.691728 [debug] [MainThread]: Command end result
[0m13:46:59.706684 [info ] [MainThread]: 
[0m13:46:59.708679 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m13:46:59.709701 [info ] [MainThread]: 
[0m13:46:59.711010 [error] [MainThread]:   Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
  BEGIN
      WITH cu' at line 16
  compiled Code at target\run\site_dev\models\example\Tactical_clicks_months_12.sql
[0m13:46:59.713009 [info ] [MainThread]: 
[0m13:46:59.714008 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m13:46:59.717709 [debug] [MainThread]: Command `dbt run` failed at 13:46:59.716728 after 15.96 seconds
[0m13:46:59.718714 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000158A2FBCED0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001589C581550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001589C581590>]}
[0m13:46:59.719704 [debug] [MainThread]: Flushing usage events
[0m13:47:41.131891 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000231E5BB0F90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000231E5BB3BD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000231E5BB0E90>]}


============================== 13:47:41.138872 | 9192d034-9a3a-4dfa-ad90-15a1c86c4ef8 ==============================
[0m13:47:41.138872 [info ] [MainThread]: Running with dbt=1.7.17
[0m13:47:41.140868 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run --models example.Tactical_clicks_months_12', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m13:47:41.554762 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9192d034-9a3a-4dfa-ad90-15a1c86c4ef8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000231E569C050>]}
[0m13:47:41.647513 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9192d034-9a3a-4dfa-ad90-15a1c86c4ef8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000231E5BED490>]}
[0m13:47:41.650505 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m13:47:41.662472 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m13:47:41.776168 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m13:47:41.777165 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m13:47:41.782519 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example.run_Tactical_clicks_months_12
[0m13:47:41.794487 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '9192d034-9a3a-4dfa-ad90-15a1c86c4ef8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000231E4945690>]}
[0m13:47:41.817426 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '9192d034-9a3a-4dfa-ad90-15a1c86c4ef8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000231E5EBA910>]}
[0m13:47:41.819419 [info ] [MainThread]: Found 13 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m13:47:41.820418 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9192d034-9a3a-4dfa-ad90-15a1c86c4ef8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000231E5DB5CD0>]}
[0m13:47:41.823412 [info ] [MainThread]: 
[0m13:47:41.826402 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m13:47:41.830402 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m13:47:41.846352 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m13:47:41.847347 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m13:47:41.848344 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:47:43.416751 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m13:47:43.423717 [debug] [ThreadPool]: On list_schemas: Close
[0m13:47:43.429703 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m13:47:43.432695 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m13:47:43.442667 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:47:43.443663 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m13:47:43.444671 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:47:44.976273 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:47:44.978266 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:47:44.981263 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m13:47:45.577960 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m13:47:45.581954 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m13:47:45.582946 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m13:47:45.584941 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m13:47:46.160876 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:47:46.162877 [debug] [ThreadPool]: On create__site_dev: Close
[0m13:47:46.171853 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m13:47:46.187810 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m13:47:46.188810 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m13:47:46.189804 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:47:47.753994 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:47:47.756999 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m13:47:47.758993 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m13:47:48.351491 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:47:48.357487 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m13:47:48.556505 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m13:47:48.561481 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9192d034-9a3a-4dfa-ad90-15a1c86c4ef8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000231E4945550>]}
[0m13:47:48.564473 [debug] [MainThread]: Using mysql connection "master"
[0m13:47:48.565470 [debug] [MainThread]: On master: BEGIN
[0m13:47:48.566462 [debug] [MainThread]: Opening a new connection, currently in state init
[0m13:47:50.179834 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:47:50.181834 [debug] [MainThread]: On master: COMMIT
[0m13:47:50.183850 [debug] [MainThread]: Using mysql connection "master"
[0m13:47:50.186818 [debug] [MainThread]: On master: COMMIT
[0m13:47:50.812701 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:47:50.815705 [debug] [MainThread]: On master: Close
[0m13:47:50.820697 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m13:47:50.823684 [info ] [MainThread]: 
[0m13:47:50.833724 [debug] [Thread-1 (]: Began running node model.site_dev.Tactical_clicks_months_12
[0m13:47:50.834725 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.Tactical_clicks_months_12 ................. [RUN]
[0m13:47:50.836643 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.site_dev.Tactical_clicks_months_12'
[0m13:47:50.837640 [debug] [Thread-1 (]: Began compiling node model.site_dev.Tactical_clicks_months_12
[0m13:47:50.852600 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.Tactical_clicks_months_12"
[0m13:47:50.854594 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_clicks_months_12 (compile): 13:47:50.838638 => 13:47:50.853596
[0m13:47:50.855591 [debug] [Thread-1 (]: Began executing node model.site_dev.Tactical_clicks_months_12
[0m13:47:50.907453 [debug] [Thread-1 (]: Writing runtime sql for node "model.site_dev.Tactical_clicks_months_12"
[0m13:47:50.909449 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_clicks_months_12"
[0m13:47:50.910447 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: BEGIN
[0m13:47:50.910447 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m13:47:52.488431 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:47:52.491455 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_clicks_months_12"
[0m13:47:52.495438 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "node_id": "model.site_dev.Tactical_clicks_months_12"} */

  create view `site_dev`.`Tactical_clicks_months_12__dbt_tmp`
    
    
  as (
    








CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
BEGIN
    WITH curr_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND categories <> "Nyhedsoverblik"
        AND siteid = '12'
    ),
    agg_curr_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks
        FROM prod.events e
        JOIN curr_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND e.siteid = '12'
        AND e.Event_Action = 'Next Click'
        GROUP BY 1
    ),
    agg_curr_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum
        FROM prod.pages p
        LEFT JOIN curr_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = '12'
        AND p.date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        GROUP BY p.siteid
    ),
    value_curr_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks / p.pageview_sum * 100, 2) AS value
        FROM agg_curr_30_days_events e
        LEFT JOIN agg_curr_30_days_pages p ON e.siteid = p.siteid
    ),
    last_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        AND siteid = site
        AND categories <> "Nyhedsoverblik"
    ),
    agg_last_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks_last
        FROM prod.events e
        JOIN last_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        AND e.siteid = '12'
        AND e.Event_Action = 'Next Click'
        GROUP BY 1
    ),
    agg_last_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum_last
        FROM prod.pages p
        LEFT JOIN last_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = '12'
        AND p.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        GROUP BY p.siteid
    ),
    value_last_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks_last / p.pageview_sum_last * 100, 2) AS value_last
        FROM agg_last_30_days_events e
        LEFT JOIN agg_last_30_days_pages p ON e.siteid = p.siteid
    )
    SELECT 
        JSON_OBJECT(
            'site', al.siteid,
            'data', JSON_OBJECT(
                'label', 'Artikler',
                'hint', 'Artikler publiceret seneste 30 dage ift. forrige 30 dage',
                'value', COALESCE(value, 0),
                'change', COALESCE(value - value_last, 0),
                'progressCurrent', '',
                'progressTotal', ''
            )
        ) AS json_data
    FROM value_curr_30_days al
    LEFT JOIN value_last_30_days alb ON al.siteid = alb.siteid
    WHERE al.siteid = '12';
END;
  );
[0m13:47:53.109321 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
BEGIN
    WITH cu' at line 16
[0m13:47:53.113323 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: ROLLBACK
[0m13:47:53.313560 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_clicks_months_12 (execute): 13:47:50.856588 => 13:47:53.311567
[0m13:47:53.316552 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: Close
[0m13:47:53.335499 [debug] [Thread-1 (]: Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
  BEGIN
      WITH cu' at line 16
  compiled Code at target\run\site_dev\models\example\Tactical_clicks_months_12.sql
[0m13:47:53.336496 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9192d034-9a3a-4dfa-ad90-15a1c86c4ef8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000231E5F57790>]}
[0m13:47:53.338491 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.Tactical_clicks_months_12 ........ [[31mERROR[0m in 2.50s]
[0m13:47:53.340483 [debug] [Thread-1 (]: Finished running node model.site_dev.Tactical_clicks_months_12
[0m13:47:53.343476 [debug] [MainThread]: Using mysql connection "master"
[0m13:47:53.344473 [debug] [MainThread]: On master: BEGIN
[0m13:47:53.345471 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m13:47:54.987999 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:47:54.990000 [debug] [MainThread]: On master: COMMIT
[0m13:47:54.992996 [debug] [MainThread]: Using mysql connection "master"
[0m13:47:54.994990 [debug] [MainThread]: On master: COMMIT
[0m13:47:55.581160 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:47:55.583153 [debug] [MainThread]: On master: Close
[0m13:47:55.586141 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:47:55.586141 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m13:47:55.587139 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m13:47:55.588139 [debug] [MainThread]: Connection 'model.site_dev.Tactical_clicks_months_12' was properly closed.
[0m13:47:55.589154 [info ] [MainThread]: 
[0m13:47:55.590131 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 13.76 seconds (13.76s).
[0m13:47:55.592403 [debug] [MainThread]: Command end result
[0m13:47:55.606367 [info ] [MainThread]: 
[0m13:47:55.607365 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m13:47:55.608362 [info ] [MainThread]: 
[0m13:47:55.610355 [error] [MainThread]:   Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
  BEGIN
      WITH cu' at line 16
  compiled Code at target\run\site_dev\models\example\Tactical_clicks_months_12.sql
[0m13:47:55.612350 [info ] [MainThread]: 
[0m13:47:55.613347 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m13:47:55.616340 [debug] [MainThread]: Command `dbt run` failed at 13:47:55.616340 after 14.64 seconds
[0m13:47:55.617352 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000231E5BB8410>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000231DF080B10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000231DF080AD0>]}
[0m13:47:55.618336 [debug] [MainThread]: Flushing usage events
[0m13:56:31.992381 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000252E7427D10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000252E7426A50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000252E7025110>]}


============================== 13:56:31.997368 | afaa0584-3d24-4151-a901-438c90e11c5d ==============================
[0m13:56:31.997368 [info ] [MainThread]: Running with dbt=1.7.17
[0m13:56:31.999365 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --models example.Tactical_clicks_months_12', 'send_anonymous_usage_stats': 'True'}
[0m13:56:32.276631 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'afaa0584-3d24-4151-a901-438c90e11c5d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000252E7414290>]}
[0m13:56:32.354424 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'afaa0584-3d24-4151-a901-438c90e11c5d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000252E73EB790>]}
[0m13:56:32.356300 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m13:56:32.368141 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m13:56:32.380109 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m13:56:32.381106 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'afaa0584-3d24-4151-a901-438c90e11c5d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000252E761AB90>]}
[0m13:56:33.762416 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example.run_Tactical_clicks_months_12
[0m13:56:33.769392 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'afaa0584-3d24-4151-a901-438c90e11c5d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000252E7580C50>]}
[0m13:56:33.789340 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'afaa0584-3d24-4151-a901-438c90e11c5d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000252E769EE50>]}
[0m13:56:33.790338 [info ] [MainThread]: Found 13 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m13:56:33.791336 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'afaa0584-3d24-4151-a901-438c90e11c5d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000252E7909490>]}
[0m13:56:33.793331 [info ] [MainThread]: 
[0m13:56:33.795804 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m13:56:33.798795 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m13:56:33.812758 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m13:56:33.813756 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m13:56:33.814754 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:56:35.427117 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m13:56:35.429111 [debug] [ThreadPool]: On list_schemas: Close
[0m13:56:35.432103 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__pre_stage)
[0m13:56:35.434099 [debug] [ThreadPool]: Creating schema "schema: "pre_stage"
"
[0m13:56:35.441080 [debug] [ThreadPool]: Using mysql connection "create__pre_stage"
[0m13:56:35.442079 [debug] [ThreadPool]: On create__pre_stage: BEGIN
[0m13:56:35.443075 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:56:37.082627 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:56:37.083627 [debug] [ThreadPool]: Using mysql connection "create__pre_stage"
[0m13:56:37.084625 [debug] [ThreadPool]: On create__pre_stage: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "create__pre_stage"} */
create schema if not exists `pre_stage`
[0m13:56:37.783093 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m13:56:37.789088 [debug] [ThreadPool]: On create__pre_stage: COMMIT
[0m13:56:37.791084 [debug] [ThreadPool]: Using mysql connection "create__pre_stage"
[0m13:56:37.793086 [debug] [ThreadPool]: On create__pre_stage: COMMIT
[0m13:56:38.378458 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m13:56:38.381457 [debug] [ThreadPool]: On create__pre_stage: Close
[0m13:56:38.393377 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_pre_stage'
[0m13:56:38.407337 [debug] [ThreadPool]: Using mysql connection "list_None_pre_stage"
[0m13:56:38.408335 [debug] [ThreadPool]: On list_None_pre_stage: BEGIN
[0m13:56:38.408335 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:56:40.031280 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m13:56:40.033276 [debug] [ThreadPool]: Using mysql connection "list_None_pre_stage"
[0m13:56:40.035265 [debug] [ThreadPool]: On list_None_pre_stage: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "kasper", "target_name": "dev", "connection_name": "list_None_pre_stage"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'pre_stage'
  
[0m13:56:40.627235 [debug] [ThreadPool]: SQL status: SUCCESS 145 in 1.0 seconds
[0m13:56:40.631225 [debug] [ThreadPool]: On list_None_pre_stage: ROLLBACK
[0m13:56:40.825538 [debug] [ThreadPool]: On list_None_pre_stage: Close
[0m13:56:40.833543 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:56:40.836535 [debug] [MainThread]: Connection 'create__pre_stage' was properly closed.
[0m13:56:40.839527 [debug] [MainThread]: Connection 'list_None_pre_stage' was properly closed.
[0m13:56:40.842521 [info ] [MainThread]: 
[0m13:56:40.845516 [info ] [MainThread]: Finished running  in 0 hours 0 minutes and 7.05 seconds (7.05s).
[0m13:56:40.848045 [error] [MainThread]: Encountered an error:
Field "type" of type Optional[RelationType] in MySQLRelation has invalid value "bytearray(b'table')"
[0m13:56:40.860010 [error] [MainThread]: Traceback (most recent call last):
  File "<string>", line 17, in __mashumaro_from_dict__
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\dataclass_schema.py", line 156, in _deserialize
    return cls(value)
           ^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\enum.py", line 695, in __call__
    return cls.__new__(cls, value)
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\enum.py", line 1111, in __new__
    raise ve_exc
ValueError: "bytearray(b'table')" is not a valid RelationType

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 91, in wrapper
    result, success = func(*args, **kwargs)
                      ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 76, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 169, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 198, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 245, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 278, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\main.py", line 626, in run
    results = task.run()
              ^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 502, in run
    result = self.execute_with_hooks(selected_uids)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 462, in execute_with_hooks
    self.before_run(adapter, selected_uids)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\run.py", line 451, in before_run
    self.populate_adapter_cache(adapter, required_schemas)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 440, in populate_adapter_cache
    adapter.set_relations_cache(self.manifest)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\impl.py", line 519, in set_relations_cache
    self._relations_cache_for_schemas(manifest, required_schemas)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\impl.py", line 495, in _relations_cache_for_schemas
    for relation in future.result():
                    ^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\_base.py", line 401, in __get_result
    raise self._exception
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\thread.py", line 58, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\utils.py", line 471, in connected
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\mysql\impl.py", line 82, in list_relations_without_caching
    relation = self.Relation.create(schema=_schema, identifier=name, type=relation_type)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\relation.py", line 299, in create
    return cls.from_dict(kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 19, in __mashumaro_from_dict__
mashumaro.exceptions.InvalidFieldValue: Field "type" of type Optional[RelationType] in MySQLRelation has invalid value "bytearray(b'table')"

[0m13:56:40.865684 [debug] [MainThread]: Command `dbt run` failed at 13:56:40.864679 after 8.97 seconds
[0m13:56:40.866681 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000252E74279D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000252E0890B10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000252E0890AD0>]}
[0m13:56:40.867673 [debug] [MainThread]: Flushing usage events
[0m14:00:56.607188 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F403377F90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F4038A0910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F40389C110>]}


============================== 14:00:56.615168 | fb1a88b1-feda-4dff-a66d-033c3317b17a ==============================
[0m14:00:56.615168 [info ] [MainThread]: Running with dbt=1.7.17
[0m14:00:56.617162 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models example.Tactical_clicks_months_12', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m14:00:56.906388 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'fb1a88b1-feda-4dff-a66d-033c3317b17a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F4038D8190>]}
[0m14:00:56.991161 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'fb1a88b1-feda-4dff-a66d-033c3317b17a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F40389D810>]}
[0m14:00:56.994154 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m14:00:57.007119 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m14:00:57.031053 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m14:00:57.033049 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'fb1a88b1-feda-4dff-a66d-033c3317b17a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F403A56350>]}
[0m14:00:58.426323 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.site_dev.example.run_Tactical_clicks_months_12
[0m14:00:58.435298 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'fb1a88b1-feda-4dff-a66d-033c3317b17a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F403E13850>]}
[0m14:00:58.455244 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'fb1a88b1-feda-4dff-a66d-033c3317b17a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F403B26950>]}
[0m14:00:58.456242 [info ] [MainThread]: Found 13 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m14:00:58.457239 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fb1a88b1-feda-4dff-a66d-033c3317b17a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F403C66450>]}
[0m14:00:58.459234 [info ] [MainThread]: 
[0m14:00:58.461241 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m14:00:58.464233 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m14:00:58.479192 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m14:00:58.480189 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m14:00:58.481187 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:01:00.084011 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m14:01:00.086009 [debug] [ThreadPool]: On list_schemas: Close
[0m14:01:00.089000 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__pre_stage)
[0m14:01:00.089998 [debug] [ThreadPool]: Creating schema "schema: "pre_stage"
"
[0m14:01:00.096980 [debug] [ThreadPool]: Using mysql connection "create__pre_stage"
[0m14:01:00.097977 [debug] [ThreadPool]: On create__pre_stage: BEGIN
[0m14:01:00.097977 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:01:01.634632 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m14:01:01.637653 [debug] [ThreadPool]: Using mysql connection "create__pre_stage"
[0m14:01:01.640647 [debug] [ThreadPool]: On create__pre_stage: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "create__pre_stage"} */
create schema if not exists `pre_stage`
[0m14:01:02.238572 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m14:01:02.243557 [debug] [ThreadPool]: On create__pre_stage: COMMIT
[0m14:01:02.246550 [debug] [ThreadPool]: Using mysql connection "create__pre_stage"
[0m14:01:02.248543 [debug] [ThreadPool]: On create__pre_stage: COMMIT
[0m14:01:02.830229 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m14:01:02.833231 [debug] [ThreadPool]: On create__pre_stage: Close
[0m14:01:02.846204 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_pre_stage'
[0m14:01:02.862151 [debug] [ThreadPool]: Using mysql connection "list_None_pre_stage"
[0m14:01:02.863152 [debug] [ThreadPool]: On list_None_pre_stage: BEGIN
[0m14:01:02.863152 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:01:04.435718 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m14:01:04.440668 [debug] [ThreadPool]: Using mysql connection "list_None_pre_stage"
[0m14:01:04.441661 [debug] [ThreadPool]: On list_None_pre_stage: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_None_pre_stage"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'pre_stage'
  
[0m14:01:05.122510 [debug] [ThreadPool]: SQL status: SUCCESS 145 in 1.0 seconds
[0m14:01:05.144455 [debug] [ThreadPool]: On list_None_pre_stage: ROLLBACK
[0m14:01:05.502790 [debug] [ThreadPool]: On list_None_pre_stage: Close
[0m14:01:05.508802 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:01:05.511795 [debug] [MainThread]: Connection 'create__pre_stage' was properly closed.
[0m14:01:05.513789 [debug] [MainThread]: Connection 'list_None_pre_stage' was properly closed.
[0m14:01:05.517777 [info ] [MainThread]: 
[0m14:01:05.521774 [info ] [MainThread]: Finished running  in 0 hours 0 minutes and 7.06 seconds (7.06s).
[0m14:01:05.525759 [error] [MainThread]: Encountered an error:
Field "type" of type Optional[RelationType] in MySQLRelation has invalid value "bytearray(b'table')"
[0m14:01:05.547698 [error] [MainThread]: Traceback (most recent call last):
  File "<string>", line 17, in __mashumaro_from_dict__
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\dataclass_schema.py", line 156, in _deserialize
    return cls(value)
           ^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\enum.py", line 695, in __call__
    return cls.__new__(cls, value)
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\enum.py", line 1111, in __new__
    raise ve_exc
ValueError: "bytearray(b'table')" is not a valid RelationType

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 91, in wrapper
    result, success = func(*args, **kwargs)
                      ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 76, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 169, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 198, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 245, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 278, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\main.py", line 626, in run
    results = task.run()
              ^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 502, in run
    result = self.execute_with_hooks(selected_uids)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 462, in execute_with_hooks
    self.before_run(adapter, selected_uids)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\run.py", line 451, in before_run
    self.populate_adapter_cache(adapter, required_schemas)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 440, in populate_adapter_cache
    adapter.set_relations_cache(self.manifest)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\impl.py", line 519, in set_relations_cache
    self._relations_cache_for_schemas(manifest, required_schemas)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\impl.py", line 495, in _relations_cache_for_schemas
    for relation in future.result():
                    ^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\_base.py", line 401, in __get_result
    raise self._exception
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\thread.py", line 58, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\utils.py", line 471, in connected
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\mysql\impl.py", line 82, in list_relations_without_caching
    relation = self.Relation.create(schema=_schema, identifier=name, type=relation_type)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\relation.py", line 299, in create
    return cls.from_dict(kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 19, in __mashumaro_from_dict__
mashumaro.exceptions.InvalidFieldValue: Field "type" of type Optional[RelationType] in MySQLRelation has invalid value "bytearray(b'table')"

[0m14:01:05.554267 [debug] [MainThread]: Command `dbt run` failed at 14:01:05.554267 after 9.05 seconds
[0m14:01:05.555263 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F47CD80B10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F47CD80AD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F403CA2B50>]}
[0m14:01:05.556261 [debug] [MainThread]: Flushing usage events
[0m14:01:07.183081 [debug] [MainThread]: Error sending anonymous usage statistics. Disabling tracking for this execution. If you wish to permanently disable tracking, see: https://docs.getdbt.com/reference/global-configs#send-anonymous-usage-stats.
[0m14:02:21.213748 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002DBC7339610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002DBC7338810>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002DBC7338F50>]}


============================== 14:02:21.221726 | fbe7396c-a94f-4ee0-a017-f0066bd8f297 ==============================
[0m14:02:21.221726 [info ] [MainThread]: Running with dbt=1.7.17
[0m14:02:21.223721 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models example.Tactical_clicks_months_12', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m14:02:21.510958 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'fbe7396c-a94f-4ee0-a017-f0066bd8f297', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002DBC75779D0>]}
[0m14:02:21.594734 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'fbe7396c-a94f-4ee0-a017-f0066bd8f297', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002DBC7568990>]}
[0m14:02:21.597725 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m14:02:21.609699 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m14:02:21.717404 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m14:02:21.718402 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m14:02:21.720410 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.site_dev.example.run_Tactical_clicks_months_12
[0m14:02:21.731367 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'fbe7396c-a94f-4ee0-a017-f0066bd8f297', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002DBC5FF2110>]}
[0m14:02:21.751314 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'fbe7396c-a94f-4ee0-a017-f0066bd8f297', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002DBC762AD50>]}
[0m14:02:21.753308 [info ] [MainThread]: Found 13 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m14:02:21.755305 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fbe7396c-a94f-4ee0-a017-f0066bd8f297', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002DBC7597F10>]}
[0m14:02:21.760289 [info ] [MainThread]: 
[0m14:02:21.762438 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m14:02:21.765012 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m14:02:21.779972 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m14:02:21.780970 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m14:02:21.781967 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:02:23.392548 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m14:02:23.399522 [debug] [ThreadPool]: On list_schemas: Close
[0m14:02:23.405040 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__pre_stage)
[0m14:02:23.408031 [debug] [ThreadPool]: Creating schema "schema: "pre_stage"
"
[0m14:02:23.419000 [debug] [ThreadPool]: Using mysql connection "create__pre_stage"
[0m14:02:23.419998 [debug] [ThreadPool]: On create__pre_stage: BEGIN
[0m14:02:23.419998 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:02:25.048332 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m14:02:25.051324 [debug] [ThreadPool]: Using mysql connection "create__pre_stage"
[0m14:02:25.056625 [debug] [ThreadPool]: On create__pre_stage: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "create__pre_stage"} */
create schema if not exists `pre_stage`
[0m14:02:25.671998 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m14:02:25.676994 [debug] [ThreadPool]: On create__pre_stage: COMMIT
[0m14:02:25.677988 [debug] [ThreadPool]: Using mysql connection "create__pre_stage"
[0m14:02:25.677988 [debug] [ThreadPool]: On create__pre_stage: COMMIT
[0m14:02:26.285620 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m14:02:26.288625 [debug] [ThreadPool]: On create__pre_stage: Close
[0m14:02:26.293348 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_pre_stage'
[0m14:02:26.300332 [debug] [ThreadPool]: Using mysql connection "list_None_pre_stage"
[0m14:02:26.301330 [debug] [ThreadPool]: On list_None_pre_stage: BEGIN
[0m14:02:26.302340 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:02:27.922113 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m14:02:27.925118 [debug] [ThreadPool]: Using mysql connection "list_None_pre_stage"
[0m14:02:27.927119 [debug] [ThreadPool]: On list_None_pre_stage: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_None_pre_stage"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'pre_stage'
  
[0m14:02:28.532333 [debug] [ThreadPool]: SQL status: SUCCESS 145 in 1.0 seconds
[0m14:02:28.536325 [debug] [ThreadPool]: On list_None_pre_stage: ROLLBACK
[0m14:02:28.735473 [debug] [ThreadPool]: On list_None_pre_stage: Close
[0m14:02:28.741456 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:02:28.743446 [debug] [MainThread]: Connection 'create__pre_stage' was properly closed.
[0m14:02:28.745445 [debug] [MainThread]: Connection 'list_None_pre_stage' was properly closed.
[0m14:02:28.747439 [info ] [MainThread]: 
[0m14:02:28.750429 [info ] [MainThread]: Finished running  in 0 hours 0 minutes and 6.99 seconds (6.99s).
[0m14:02:28.752521 [error] [MainThread]: Encountered an error:
Field "type" of type Optional[RelationType] in MySQLRelation has invalid value "bytearray(b'table')"
[0m14:02:28.762747 [error] [MainThread]: Traceback (most recent call last):
  File "<string>", line 17, in __mashumaro_from_dict__
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\dataclass_schema.py", line 156, in _deserialize
    return cls(value)
           ^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\enum.py", line 695, in __call__
    return cls.__new__(cls, value)
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\enum.py", line 1111, in __new__
    raise ve_exc
ValueError: "bytearray(b'table')" is not a valid RelationType

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 91, in wrapper
    result, success = func(*args, **kwargs)
                      ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 76, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 169, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 198, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 245, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 278, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\main.py", line 626, in run
    results = task.run()
              ^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 502, in run
    result = self.execute_with_hooks(selected_uids)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 462, in execute_with_hooks
    self.before_run(adapter, selected_uids)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\run.py", line 451, in before_run
    self.populate_adapter_cache(adapter, required_schemas)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 440, in populate_adapter_cache
    adapter.set_relations_cache(self.manifest)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\impl.py", line 519, in set_relations_cache
    self._relations_cache_for_schemas(manifest, required_schemas)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\impl.py", line 495, in _relations_cache_for_schemas
    for relation in future.result():
                    ^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\_base.py", line 401, in __get_result
    raise self._exception
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\thread.py", line 58, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\utils.py", line 471, in connected
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\mysql\impl.py", line 82, in list_relations_without_caching
    relation = self.Relation.create(schema=_schema, identifier=name, type=relation_type)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\relation.py", line 299, in create
    return cls.from_dict(kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 19, in __mashumaro_from_dict__
mashumaro.exceptions.InvalidFieldValue: Field "type" of type Optional[RelationType] in MySQLRelation has invalid value "bytearray(b'table')"

[0m14:02:28.767734 [debug] [MainThread]: Command `dbt run` failed at 14:02:28.767734 after 7.65 seconds
[0m14:02:28.769728 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002DBC7329D10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002DBC7328190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002DBC7328990>]}
[0m14:02:28.770726 [debug] [MainThread]: Flushing usage events
[0m14:27:24.179212 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015EFB7A9410>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015EFB7A9190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015EFB7A8C10>]}


============================== 14:27:24.188188 | 9aa4b5c5-d4e4-4c43-b947-1c706bca1e59 ==============================
[0m14:27:24.188188 [info ] [MainThread]: Running with dbt=1.7.17
[0m14:27:24.190186 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run --models example.Tactical_clicks_months_12', 'send_anonymous_usage_stats': 'True'}
[0m14:27:24.485882 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9aa4b5c5-d4e4-4c43-b947-1c706bca1e59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015EFB9E7D10>]}
[0m14:27:24.593596 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9aa4b5c5-d4e4-4c43-b947-1c706bca1e59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015EFB7A80D0>]}
[0m14:27:24.596420 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m14:27:24.608331 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m14:27:24.622294 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m14:27:24.622860 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '9aa4b5c5-d4e4-4c43-b947-1c706bca1e59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015EFB7A9450>]}
[0m14:27:26.266469 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.site_dev.example.run_Tactical_clicks_months_12
[0m14:27:26.276785 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '9aa4b5c5-d4e4-4c43-b947-1c706bca1e59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015EFBAFB750>]}
[0m14:27:26.297730 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '9aa4b5c5-d4e4-4c43-b947-1c706bca1e59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015EFBA30BD0>]}
[0m14:27:26.298726 [info ] [MainThread]: Found 13 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m14:27:26.300721 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9aa4b5c5-d4e4-4c43-b947-1c706bca1e59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015EFBA6BCD0>]}
[0m14:27:26.302717 [info ] [MainThread]: 
[0m14:27:26.305158 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m14:27:26.307647 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m14:27:26.322608 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m14:27:26.323605 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m14:27:26.324603 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:27:27.871323 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m14:27:27.875318 [debug] [ThreadPool]: On list_schemas: Close
[0m14:27:27.878310 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__prod)
[0m14:27:27.880312 [debug] [ThreadPool]: Creating schema "schema: "prod"
"
[0m14:27:27.889280 [debug] [ThreadPool]: Using mysql connection "create__prod"
[0m14:27:27.890277 [debug] [ThreadPool]: On create__prod: BEGIN
[0m14:27:27.891275 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:27:29.447759 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m14:27:29.449747 [debug] [ThreadPool]: Using mysql connection "create__prod"
[0m14:27:29.452740 [debug] [ThreadPool]: On create__prod: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "create__prod"} */
create schema if not exists `prod`
[0m14:27:30.045477 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m14:27:30.054476 [debug] [ThreadPool]: On create__prod: COMMIT
[0m14:27:30.058457 [debug] [ThreadPool]: Using mysql connection "create__prod"
[0m14:27:30.060448 [debug] [ThreadPool]: On create__prod: COMMIT
[0m14:27:30.645461 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m14:27:30.646463 [debug] [ThreadPool]: On create__prod: Close
[0m14:27:30.652467 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_prod'
[0m14:27:30.664429 [debug] [ThreadPool]: Using mysql connection "list_None_prod"
[0m14:27:30.665412 [debug] [ThreadPool]: On list_None_prod: BEGIN
[0m14:27:30.665412 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:27:32.250385 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m14:27:32.252386 [debug] [ThreadPool]: Using mysql connection "list_None_prod"
[0m14:27:32.254374 [debug] [ThreadPool]: On list_None_prod: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_None_prod"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'prod'
  
[0m14:27:32.857307 [debug] [ThreadPool]: SQL status: SUCCESS 144 in 1.0 seconds
[0m14:27:32.861294 [debug] [ThreadPool]: On list_None_prod: ROLLBACK
[0m14:27:33.062215 [debug] [ThreadPool]: On list_None_prod: Close
[0m14:27:33.066212 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:27:33.067208 [debug] [MainThread]: Connection 'create__prod' was properly closed.
[0m14:27:33.068205 [debug] [MainThread]: Connection 'list_None_prod' was properly closed.
[0m14:27:33.069203 [info ] [MainThread]: 
[0m14:27:33.071200 [info ] [MainThread]: Finished running  in 0 hours 0 minutes and 6.77 seconds (6.77s).
[0m14:27:33.073193 [error] [MainThread]: Encountered an error:
Field "type" of type Optional[RelationType] in MySQLRelation has invalid value "bytearray(b'view')"
[0m14:27:33.083582 [error] [MainThread]: Traceback (most recent call last):
  File "<string>", line 17, in __mashumaro_from_dict__
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\dataclass_schema.py", line 156, in _deserialize
    return cls(value)
           ^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\enum.py", line 695, in __call__
    return cls.__new__(cls, value)
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\enum.py", line 1111, in __new__
    raise ve_exc
ValueError: "bytearray(b'view')" is not a valid RelationType

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 91, in wrapper
    result, success = func(*args, **kwargs)
                      ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 76, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 169, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 198, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 245, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 278, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\main.py", line 626, in run
    results = task.run()
              ^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 502, in run
    result = self.execute_with_hooks(selected_uids)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 462, in execute_with_hooks
    self.before_run(adapter, selected_uids)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\run.py", line 451, in before_run
    self.populate_adapter_cache(adapter, required_schemas)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 440, in populate_adapter_cache
    adapter.set_relations_cache(self.manifest)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\impl.py", line 519, in set_relations_cache
    self._relations_cache_for_schemas(manifest, required_schemas)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\impl.py", line 495, in _relations_cache_for_schemas
    for relation in future.result():
                    ^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\_base.py", line 401, in __get_result
    raise self._exception
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\thread.py", line 58, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\utils.py", line 471, in connected
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\mysql\impl.py", line 82, in list_relations_without_caching
    relation = self.Relation.create(schema=_schema, identifier=name, type=relation_type)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\relation.py", line 299, in create
    return cls.from_dict(kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 19, in __mashumaro_from_dict__
mashumaro.exceptions.InvalidFieldValue: Field "type" of type Optional[RelationType] in MySQLRelation has invalid value "bytearray(b'view')"

[0m14:27:33.088980 [debug] [MainThread]: Command `dbt run` failed at 14:27:33.088980 after 9.02 seconds
[0m14:27:33.089976 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015EFB7E8F10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015EFB79AB50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015EFB79B810>]}
[0m14:27:33.090974 [debug] [MainThread]: Flushing usage events
[0m14:29:09.443607 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028326998F90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028326999410>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028326998D90>]}


============================== 14:29:09.449590 | 4fb989b1-1119-4b62-a7cc-d905d2bdf765 ==============================
[0m14:29:09.449590 [info ] [MainThread]: Running with dbt=1.7.17
[0m14:29:09.451587 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --models example.Tactical_clicks_months_12', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m14:29:09.736859 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4fb989b1-1119-4b62-a7cc-d905d2bdf765', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028326A03750>]}
[0m14:29:09.820637 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4fb989b1-1119-4b62-a7cc-d905d2bdf765', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002832699A1D0>]}
[0m14:29:09.822628 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m14:29:09.836591 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m14:29:09.859377 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m14:29:09.860432 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '4fb989b1-1119-4b62-a7cc-d905d2bdf765', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000283269D85D0>]}
[0m14:29:11.395329 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example.run_Tactical_clicks_months_12
[0m14:29:11.406301 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4fb989b1-1119-4b62-a7cc-d905d2bdf765', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000283269D9410>]}
[0m14:29:11.429240 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4fb989b1-1119-4b62-a7cc-d905d2bdf765', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028326EFBC90>]}
[0m14:29:11.430238 [info ] [MainThread]: Found 13 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m14:29:11.432235 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4fb989b1-1119-4b62-a7cc-d905d2bdf765', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028326C506D0>]}
[0m14:29:11.435222 [info ] [MainThread]: 
[0m14:29:11.437407 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m14:29:11.442394 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m14:29:11.457352 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m14:29:11.460357 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m14:29:11.462342 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:29:13.093775 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m14:29:13.098760 [debug] [ThreadPool]: On list_schemas: Close
[0m14:29:13.102755 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__prod)
[0m14:29:13.106739 [debug] [ThreadPool]: Creating schema "schema: "prod"
"
[0m14:29:13.120703 [debug] [ThreadPool]: Using mysql connection "create__prod"
[0m14:29:13.121698 [debug] [ThreadPool]: On create__prod: BEGIN
[0m14:29:13.123694 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:29:14.690628 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m14:29:14.694617 [debug] [ThreadPool]: Using mysql connection "create__prod"
[0m14:29:14.698607 [debug] [ThreadPool]: On create__prod: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "create__prod"} */
create schema if not exists `prod`
[0m14:29:15.298643 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m14:29:15.299640 [debug] [ThreadPool]: On create__prod: COMMIT
[0m14:29:15.300637 [debug] [ThreadPool]: Using mysql connection "create__prod"
[0m14:29:15.301634 [debug] [ThreadPool]: On create__prod: COMMIT
[0m14:29:15.883357 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m14:29:15.884354 [debug] [ThreadPool]: On create__prod: Close
[0m14:29:15.892335 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_prod'
[0m14:29:15.909288 [debug] [ThreadPool]: Using mysql connection "list_None_prod"
[0m14:29:15.911283 [debug] [ThreadPool]: On list_None_prod: BEGIN
[0m14:29:15.912280 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:29:17.480191 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m14:29:17.481193 [debug] [ThreadPool]: Using mysql connection "list_None_prod"
[0m14:29:17.482189 [debug] [ThreadPool]: On list_None_prod: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_None_prod"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'prod'
  
[0m14:29:18.070213 [debug] [ThreadPool]: SQL status: SUCCESS 144 in 1.0 seconds
[0m14:29:18.077195 [debug] [ThreadPool]: On list_None_prod: ROLLBACK
[0m14:29:18.278389 [debug] [ThreadPool]: On list_None_prod: Close
[0m14:29:18.280384 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:29:18.281383 [debug] [MainThread]: Connection 'create__prod' was properly closed.
[0m14:29:18.282381 [debug] [MainThread]: Connection 'list_None_prod' was properly closed.
[0m14:29:18.283376 [info ] [MainThread]: 
[0m14:29:18.285381 [info ] [MainThread]: Finished running  in 0 hours 0 minutes and 6.84 seconds (6.84s).
[0m14:29:18.288364 [error] [MainThread]: Encountered an error:
Field "type" of type Optional[RelationType] in MySQLRelation has invalid value "bytearray(b'view')"
[0m14:29:18.298726 [error] [MainThread]: Traceback (most recent call last):
  File "<string>", line 17, in __mashumaro_from_dict__
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\dataclass_schema.py", line 156, in _deserialize
    return cls(value)
           ^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\enum.py", line 695, in __call__
    return cls.__new__(cls, value)
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\enum.py", line 1111, in __new__
    raise ve_exc
ValueError: "bytearray(b'view')" is not a valid RelationType

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 91, in wrapper
    result, success = func(*args, **kwargs)
                      ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 76, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 169, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 198, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 245, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 278, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\main.py", line 626, in run
    results = task.run()
              ^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 502, in run
    result = self.execute_with_hooks(selected_uids)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 462, in execute_with_hooks
    self.before_run(adapter, selected_uids)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\run.py", line 451, in before_run
    self.populate_adapter_cache(adapter, required_schemas)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 440, in populate_adapter_cache
    adapter.set_relations_cache(self.manifest)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\impl.py", line 519, in set_relations_cache
    self._relations_cache_for_schemas(manifest, required_schemas)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\impl.py", line 495, in _relations_cache_for_schemas
    for relation in future.result():
                    ^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\_base.py", line 401, in __get_result
    raise self._exception
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\thread.py", line 58, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\utils.py", line 471, in connected
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\mysql\impl.py", line 82, in list_relations_without_caching
    relation = self.Relation.create(schema=_schema, identifier=name, type=relation_type)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\relation.py", line 299, in create
    return cls.from_dict(kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 19, in __mashumaro_from_dict__
mashumaro.exceptions.InvalidFieldValue: Field "type" of type Optional[RelationType] in MySQLRelation has invalid value "bytearray(b'view')"

[0m14:29:18.304711 [debug] [MainThread]: Command `dbt run` failed at 14:29:18.304711 after 8.96 seconds
[0m14:29:18.306706 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028326989A50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028326988190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028326988950>]}
[0m14:29:18.307704 [debug] [MainThread]: Flushing usage events
[0m14:31:40.286425 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199B6D97F90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199B66E2890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199B66E29D0>]}


============================== 14:31:40.292409 | ef5ecb70-cc61-48d1-8f25-f71aa063223b ==============================
[0m14:31:40.292409 [info ] [MainThread]: Running with dbt=1.7.17
[0m14:31:40.294406 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'invocation_command': 'dbt run --models example.Tactical_clicks_months_12', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m14:31:40.632501 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ef5ecb70-cc61-48d1-8f25-f71aa063223b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199B747EA10>]}
[0m14:31:40.731235 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ef5ecb70-cc61-48d1-8f25-f71aa063223b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199B7324ED0>]}
[0m14:31:40.733931 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m14:31:40.749933 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m14:31:40.775961 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m14:31:40.778310 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'ef5ecb70-cc61-48d1-8f25-f71aa063223b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199B72E6010>]}
[0m14:31:42.431886 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example.run_Tactical_clicks_months_12
[0m14:31:42.440861 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ef5ecb70-cc61-48d1-8f25-f71aa063223b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199B7806BD0>]}
[0m14:31:42.467788 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ef5ecb70-cc61-48d1-8f25-f71aa063223b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199B66E2250>]}
[0m14:31:42.468790 [info ] [MainThread]: Found 13 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m14:31:42.470779 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ef5ecb70-cc61-48d1-8f25-f71aa063223b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199B747E050>]}
[0m14:31:42.476765 [info ] [MainThread]: 
[0m14:31:42.480755 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m14:31:42.484745 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m14:31:42.503690 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m14:31:42.505686 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m14:31:42.506685 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:31:44.096603 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m14:31:44.098599 [debug] [ThreadPool]: On list_schemas: Close
[0m14:31:44.101595 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m14:31:44.102585 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m14:31:44.113558 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m14:31:44.114557 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m14:31:44.115551 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:31:45.673175 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m14:31:45.676185 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m14:31:45.678179 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m14:31:46.273156 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m14:31:46.278142 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m14:31:46.282128 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m14:31:46.285127 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m14:31:46.876176 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m14:31:46.879198 [debug] [ThreadPool]: On create__site_dev: Close
[0m14:31:46.884235 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m14:31:46.892217 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m14:31:46.892217 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m14:31:46.893215 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:31:48.490703 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m14:31:48.492696 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m14:31:48.495689 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m14:31:49.107744 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m14:31:49.109742 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m14:31:49.317067 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m14:31:49.323062 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ef5ecb70-cc61-48d1-8f25-f71aa063223b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199B75C6F90>]}
[0m14:31:49.325054 [debug] [MainThread]: Using mysql connection "master"
[0m14:31:49.328057 [debug] [MainThread]: On master: BEGIN
[0m14:31:49.330042 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:31:50.875314 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m14:31:50.878322 [debug] [MainThread]: On master: COMMIT
[0m14:31:50.879312 [debug] [MainThread]: Using mysql connection "master"
[0m14:31:50.880309 [debug] [MainThread]: On master: COMMIT
[0m14:31:51.502145 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m14:31:51.506131 [debug] [MainThread]: On master: Close
[0m14:31:51.511109 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m14:31:51.513775 [info ] [MainThread]: 
[0m14:31:51.524987 [debug] [Thread-1 (]: Began running node model.site_dev.Tactical_clicks_months_12
[0m14:31:51.526989 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.Tactical_clicks_months_12 ................. [RUN]
[0m14:31:51.528942 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.site_dev.Tactical_clicks_months_12'
[0m14:31:51.529938 [debug] [Thread-1 (]: Began compiling node model.site_dev.Tactical_clicks_months_12
[0m14:31:51.549905 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.Tactical_clicks_months_12"
[0m14:31:51.552883 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_clicks_months_12 (compile): 14:31:51.530936 => 14:31:51.551881
[0m14:31:51.553875 [debug] [Thread-1 (]: Began executing node model.site_dev.Tactical_clicks_months_12
[0m14:31:51.606733 [debug] [Thread-1 (]: Writing runtime sql for node "model.site_dev.Tactical_clicks_months_12"
[0m14:31:51.607735 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_clicks_months_12"
[0m14:31:51.608727 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: BEGIN
[0m14:31:51.609726 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m14:31:53.182154 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m14:31:53.185155 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_clicks_months_12"
[0m14:31:53.188137 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "node_id": "model.site_dev.Tactical_clicks_months_12"} */

  create view `site_dev`.`Tactical_clicks_months_12__dbt_tmp`
    
    
  as (
    








CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
BEGIN
    WITH curr_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND categories <> "Nyhedsoverblik"
        AND siteid = '12'
    ),
    agg_curr_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks
        FROM prod.events e
        JOIN curr_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND e.siteid = '12'
        AND e.Event_Action = 'Next Click'
        GROUP BY 1
    ),
    agg_curr_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum
        FROM prod.pages p
        LEFT JOIN curr_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = '12'
        AND p.date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        GROUP BY p.siteid
    ),
    value_curr_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks / p.pageview_sum * 100, 2) AS value
        FROM agg_curr_30_days_events e
        LEFT JOIN agg_curr_30_days_pages p ON e.siteid = p.siteid
    ),
    last_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        AND siteid = site
        AND categories <> "Nyhedsoverblik"
    ),
    agg_last_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks_last
        FROM prod.events e
        JOIN last_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        AND e.siteid = '12'
        AND e.Event_Action = 'Next Click'
        GROUP BY 1
    ),
    agg_last_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum_last
        FROM prod.pages p
        LEFT JOIN last_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = '12'
        AND p.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        GROUP BY p.siteid
    ),
    value_last_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks_last / p.pageview_sum_last * 100, 2) AS value_last
        FROM agg_last_30_days_events e
        LEFT JOIN agg_last_30_days_pages p ON e.siteid = p.siteid
    )
    SELECT 
        JSON_OBJECT(
            'site', al.siteid,
            'data', JSON_OBJECT(
                'label', 'Artikler',
                'hint', 'Artikler publiceret seneste 30 dage ift. forrige 30 dage',
                'value', COALESCE(value, 0),
                'change', COALESCE(value - value_last, 0),
                'progressCurrent', '',
                'progressTotal', ''
            )
        ) AS json_data
    FROM value_curr_30_days al
    LEFT JOIN value_last_30_days alb ON al.siteid = alb.siteid
    WHERE al.siteid = '12';
END;
  );
[0m14:31:53.779903 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
BEGIN
    WITH cu' at line 16
[0m14:31:53.780900 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: ROLLBACK
[0m14:31:53.981637 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_clicks_months_12 (execute): 14:31:51.553875 => 14:31:53.980638
[0m14:31:53.982644 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: Close
[0m14:31:53.996596 [debug] [Thread-1 (]: Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
  BEGIN
      WITH cu' at line 16
  compiled Code at target\run\site_dev\models\example\Tactical_clicks_months_12.sql
[0m14:31:53.997596 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ef5ecb70-cc61-48d1-8f25-f71aa063223b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199B75E4110>]}
[0m14:31:53.999590 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.Tactical_clicks_months_12 ........ [[31mERROR[0m in 2.47s]
[0m14:31:54.001584 [debug] [Thread-1 (]: Finished running node model.site_dev.Tactical_clicks_months_12
[0m14:31:54.004576 [debug] [MainThread]: Using mysql connection "master"
[0m14:31:54.005571 [debug] [MainThread]: On master: BEGIN
[0m14:31:54.006569 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m14:31:55.777762 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m14:31:55.779751 [debug] [MainThread]: On master: COMMIT
[0m14:31:55.781746 [debug] [MainThread]: Using mysql connection "master"
[0m14:31:55.783739 [debug] [MainThread]: On master: COMMIT
[0m14:31:56.388646 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m14:31:56.390636 [debug] [MainThread]: On master: Close
[0m14:31:56.395623 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:31:56.397617 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m14:31:56.400609 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m14:31:56.402604 [debug] [MainThread]: Connection 'model.site_dev.Tactical_clicks_months_12' was properly closed.
[0m14:31:56.404599 [info ] [MainThread]: 
[0m14:31:56.406596 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 13.92 seconds (13.92s).
[0m14:31:56.410495 [debug] [MainThread]: Command end result
[0m14:31:56.426451 [info ] [MainThread]: 
[0m14:31:56.428982 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m14:31:56.429978 [info ] [MainThread]: 
[0m14:31:56.430978 [error] [MainThread]:   Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
  BEGIN
      WITH cu' at line 16
  compiled Code at target\run\site_dev\models\example\Tactical_clicks_months_12.sql
[0m14:31:56.433417 [info ] [MainThread]: 
[0m14:31:56.434123 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m14:31:56.436658 [debug] [MainThread]: Command `dbt run` failed at 14:31:56.436658 after 16.27 seconds
[0m14:31:56.437654 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199B72AADD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199B72A81D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199B72AAD10>]}
[0m14:31:56.438651 [debug] [MainThread]: Flushing usage events
[0m14:41:54.976369 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016760A45F90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001676092C150>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016760A45FD0>]}


============================== 14:41:54.983351 | 6c0619a0-e3c0-48ce-964e-35792de4ae2b ==============================
[0m14:41:54.983351 [info ] [MainThread]: Running with dbt=1.7.17
[0m14:41:54.985342 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'debug': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models example.Tactical_pageviews_card_ytd_12', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m14:41:55.259515 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6c0619a0-e3c0-48ce-964e-35792de4ae2b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016760A0DB10>]}
[0m14:41:55.342319 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6c0619a0-e3c0-48ce-964e-35792de4ae2b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016760A4B750>]}
[0m14:41:55.344347 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m14:41:55.357145 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m14:41:55.382079 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m14:41:55.382540 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '6c0619a0-e3c0-48ce-964e-35792de4ae2b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016760A47710>]}
[0m14:41:56.812838 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example.run_Tactical_pageviews_card_ytd_12
[0m14:41:56.824807 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6c0619a0-e3c0-48ce-964e-35792de4ae2b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016760D67790>]}
[0m14:41:56.846750 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6c0619a0-e3c0-48ce-964e-35792de4ae2b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016760F5FB50>]}
[0m14:41:56.848740 [info ] [MainThread]: Found 14 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m14:41:56.849738 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6c0619a0-e3c0-48ce-964e-35792de4ae2b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016760CBF2D0>]}
[0m14:41:56.853727 [info ] [MainThread]: 
[0m14:41:56.855320 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m14:41:56.859308 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m14:41:56.872274 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m14:41:56.873270 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m14:41:56.874270 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:41:58.444823 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m14:41:58.449798 [debug] [ThreadPool]: On list_schemas: Close
[0m14:41:58.451795 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m14:41:58.452791 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m14:41:58.459772 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m14:41:58.460769 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m14:41:58.461765 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:41:59.995449 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m14:41:59.996454 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m14:41:59.998449 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m14:42:00.580397 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m14:42:00.584381 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m14:42:00.585376 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m14:42:00.586376 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m14:42:01.160205 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m14:42:01.163207 [debug] [ThreadPool]: On create__site_dev: Close
[0m14:42:01.169190 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m14:42:01.178166 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m14:42:01.179164 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m14:42:01.179164 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:42:02.758737 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m14:42:02.761763 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m14:42:02.763752 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m14:42:03.363232 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m14:42:03.367225 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m14:42:03.567482 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m14:42:03.572202 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6c0619a0-e3c0-48ce-964e-35792de4ae2b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016760A73890>]}
[0m14:42:03.573206 [debug] [MainThread]: Using mysql connection "master"
[0m14:42:03.574203 [debug] [MainThread]: On master: BEGIN
[0m14:42:03.575214 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:42:05.137016 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m14:42:05.139019 [debug] [MainThread]: On master: COMMIT
[0m14:42:05.141011 [debug] [MainThread]: Using mysql connection "master"
[0m14:42:05.143044 [debug] [MainThread]: On master: COMMIT
[0m14:42:05.727472 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m14:42:05.730475 [debug] [MainThread]: On master: Close
[0m14:42:05.734466 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m14:42:05.737457 [info ] [MainThread]: 
[0m14:42:05.752386 [debug] [Thread-1 (]: Began running node model.site_dev.Tactical_pageviews_card_ytd_12
[0m14:42:05.754397 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.Tactical_pageviews_card_ytd_12 ............ [RUN]
[0m14:42:05.756462 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.site_dev.Tactical_pageviews_card_ytd_12'
[0m14:42:05.757458 [debug] [Thread-1 (]: Began compiling node model.site_dev.Tactical_pageviews_card_ytd_12
[0m14:42:05.775409 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.Tactical_pageviews_card_ytd_12"
[0m14:42:05.776418 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_pageviews_card_ytd_12 (compile): 14:42:05.758455 => 14:42:05.776418
[0m14:42:05.777402 [debug] [Thread-1 (]: Began executing node model.site_dev.Tactical_pageviews_card_ytd_12
[0m14:42:05.827268 [debug] [Thread-1 (]: Writing runtime sql for node "model.site_dev.Tactical_pageviews_card_ytd_12"
[0m14:42:05.829264 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_pageviews_card_ytd_12"
[0m14:42:05.830260 [debug] [Thread-1 (]: On model.site_dev.Tactical_pageviews_card_ytd_12: BEGIN
[0m14:42:05.831259 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m14:42:07.412686 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m14:42:07.414678 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_pageviews_card_ytd_12"
[0m14:42:07.416676 [debug] [Thread-1 (]: On model.site_dev.Tactical_pageviews_card_ytd_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "node_id": "model.site_dev.Tactical_pageviews_card_ytd_12"} */

  create view `site_dev`.`Tactical_pageviews_card_ytd_12__dbt_tmp`
    
    
  as (
    






CREATE PROCEDURE `prod`.`Tactical_pageviews_card_ytd_12_dbt_test`()
BEGIN
with last_ytd_article_published as(
SELECT siteid as siteid,id   FROM prod.site_archive_post
where date between MAKEDATE(EXTRACT(YEAR FROM CURDATE()), 1) AND DATE_SUB(CAST(NOW() AS DATE), INTERVAL 1 DAY) 
AND  categories <> "Nyhedsoverblik"
and siteid = 12
),
last_ytd_article_published_Agg as(
select siteid as siteid,count(*) as agg from  last_ytd_article_published
where  siteid = 12
group by 1
),
agg_last_ytd as (
select  e.siteid as siteid,sum(unique_pageviews)/agg as value from prod.pages e
join  last_ytd_article_published a on a.id=e.postid
join last_ytd_article_published_Agg agg on agg.siteid=a.siteid 
where e.date between MAKEDATE(EXTRACT(YEAR FROM CURDATE()), 1) AND DATE_SUB(CAST(NOW() AS DATE), INTERVAL 1 DAY) and e.siteid = 12
group by 1,agg
),
last_ytd_before_article_published as(
SELECT siteid as siteid,id   FROM prod.site_archive_post
where DATE_SUB(MAKEDATE(EXTRACT(YEAR FROM CURDATE()),1), INTERVAL 1 Year) and  DATE_SUB(DATE_SUB(cast(NOW() as date), INTERVAL 1 DAY),INTERVAL 1 Year) and siteid = 12
 AND  categories <> "Nyhedsoverblik"
),
last_ytd_before_article_published_Agg as(
select siteid as siteid,count(*) as agg from  last_ytd_before_article_published
where siteid = 12
group by 1
),
agg_last_ytd_before as(
select  e.siteid as siteid,sum(unique_pageviews)/agg as value from prod.pages e
join  last_ytd_before_article_published a on a.id=e.postid
join last_ytd_before_article_published_Agg agg on agg.siteid=a.siteid 
where DATE_SUB(MAKEDATE(EXTRACT(YEAR FROM CURDATE()),1), INTERVAL 1 Year) and  DATE_SUB(DATE_SUB(cast(NOW() as date), INTERVAL 1 DAY),INTERVAL 1 Year) and e.siteid = 12
group by 1,agg
),
json_data as( 
select al.siteid as site, label_val label, hint_val  hint, al.value as valu,((al.value-alb.value)/al.value)*100 as chang, '' as progressCurrent , '' as progresstotal
from agg_last_ytd al
left join agg_last_ytd_before alb on al.siteid=alb.siteid
where al.siteid = 12
)
select 
    JSON_OBJECT(
            'site',12,
            'data',JSON_OBJECT(
            'label', 'Artikler',
            'hint', 'Artikler publiceret seneste 30 dage ift. forrige 30 dage',
            'value',COALESCE(valu,0),
            'change',COALESCE(chang,0),
            'progressCurrent',progressCurrent, 
            'progressTotal',progressTotal
 )) AS json_data  from json_data;
 
 END
  );
[0m14:42:08.010120 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_pageviews_card_ytd_12_dbt_test`()
BEGIN
with l' at line 14
[0m14:42:08.012114 [debug] [Thread-1 (]: On model.site_dev.Tactical_pageviews_card_ytd_12: ROLLBACK
[0m14:42:08.212110 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_pageviews_card_ytd_12 (execute): 14:42:05.778399 => 14:42:08.211106
[0m14:42:08.212110 [debug] [Thread-1 (]: On model.site_dev.Tactical_pageviews_card_ytd_12: Close
[0m14:42:08.221085 [debug] [Thread-1 (]: Database Error in model Tactical_pageviews_card_ytd_12 (models\example\Tactical_pageviews_card_ytd_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_pageviews_card_ytd_12_dbt_test`()
  BEGIN
  with l' at line 14
  compiled Code at target\run\site_dev\models\example\Tactical_pageviews_card_ytd_12.sql
[0m14:42:08.222082 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6c0619a0-e3c0-48ce-964e-35792de4ae2b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016760F72590>]}
[0m14:42:08.223079 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.Tactical_pageviews_card_ytd_12 ... [[31mERROR[0m in 2.47s]
[0m14:42:08.225074 [debug] [Thread-1 (]: Finished running node model.site_dev.Tactical_pageviews_card_ytd_12
[0m14:42:08.229065 [debug] [MainThread]: Using mysql connection "master"
[0m14:42:08.230066 [debug] [MainThread]: On master: BEGIN
[0m14:42:08.231059 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m14:42:09.808896 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m14:42:09.810923 [debug] [MainThread]: On master: COMMIT
[0m14:42:09.812915 [debug] [MainThread]: Using mysql connection "master"
[0m14:42:09.813915 [debug] [MainThread]: On master: COMMIT
[0m14:42:10.391914 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m14:42:10.394937 [debug] [MainThread]: On master: Close
[0m14:42:10.396930 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:42:10.397922 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m14:42:10.398919 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m14:42:10.399916 [debug] [MainThread]: Connection 'model.site_dev.Tactical_pageviews_card_ytd_12' was properly closed.
[0m14:42:10.399916 [info ] [MainThread]: 
[0m14:42:10.401924 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 13.55 seconds (13.55s).
[0m14:42:10.404905 [debug] [MainThread]: Command end result
[0m14:42:10.419863 [info ] [MainThread]: 
[0m14:42:10.420859 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m14:42:10.422856 [info ] [MainThread]: 
[0m14:42:10.426185 [error] [MainThread]:   Database Error in model Tactical_pageviews_card_ytd_12 (models\example\Tactical_pageviews_card_ytd_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_pageviews_card_ytd_12_dbt_test`()
  BEGIN
  with l' at line 14
  compiled Code at target\run\site_dev\models\example\Tactical_pageviews_card_ytd_12.sql
[0m14:42:10.428646 [info ] [MainThread]: 
[0m14:42:10.430284 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m14:42:10.433274 [debug] [MainThread]: Command `dbt run` failed at 14:42:10.432276 after 15.55 seconds
[0m14:42:10.434270 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016760A4B690>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016760A4B910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001675F87F790>]}
[0m14:42:10.435267 [debug] [MainThread]: Flushing usage events
[0m14:44:51.796671 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC689295D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC68928510>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC68929350>]}


============================== 14:44:51.805653 | c832e5b9-c5f9-4d88-b3f7-bda35a479be3 ==============================
[0m14:44:51.805653 [info ] [MainThread]: Running with dbt=1.7.17
[0m14:44:51.807642 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --models example.Tactical_pageviews_card_month_12', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m14:44:52.077917 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c832e5b9-c5f9-4d88-b3f7-bda35a479be3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC68930110>]}
[0m14:44:52.160696 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c832e5b9-c5f9-4d88-b3f7-bda35a479be3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC6894DE10>]}
[0m14:44:52.162680 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m14:44:52.176539 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m14:44:52.289859 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m14:44:52.290857 [debug] [MainThread]: Partial parsing: added file: site_dev://models\example\Tactical_pageviews_card_month_12.sql
[0m14:44:52.483342 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example.run_Tactical_pageviews_card_ytd_12
[0m14:44:52.494310 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c832e5b9-c5f9-4d88-b3f7-bda35a479be3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC68E25690>]}
[0m14:44:52.515256 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c832e5b9-c5f9-4d88-b3f7-bda35a479be3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC68EC2590>]}
[0m14:44:52.516254 [info ] [MainThread]: Found 15 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m14:44:52.518247 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c832e5b9-c5f9-4d88-b3f7-bda35a479be3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC68CC40D0>]}
[0m14:44:52.521242 [info ] [MainThread]: 
[0m14:44:52.523327 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m14:44:52.526321 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m14:44:52.542277 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m14:44:52.543275 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m14:44:52.544272 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:44:54.100899 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m14:44:54.105885 [debug] [ThreadPool]: On list_schemas: Close
[0m14:44:54.111053 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m14:44:54.114044 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m14:44:54.125018 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m14:44:54.126014 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m14:44:54.127010 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:44:55.681632 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m14:44:55.685628 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m14:44:55.689613 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m14:44:56.279741 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m14:44:56.282736 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m14:44:56.283735 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m14:44:56.284731 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m14:44:56.877939 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m14:44:56.878945 [debug] [ThreadPool]: On create__site_dev: Close
[0m14:44:56.886565 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m14:44:56.895540 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m14:44:56.896539 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m14:44:56.897545 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:44:58.517947 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m14:44:58.520934 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m14:44:58.522927 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m14:44:59.178067 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m14:44:59.186040 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m14:44:59.391567 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m14:44:59.397543 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c832e5b9-c5f9-4d88-b3f7-bda35a479be3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC68CADC90>]}
[0m14:44:59.400539 [debug] [MainThread]: Using mysql connection "master"
[0m14:44:59.403532 [debug] [MainThread]: On master: BEGIN
[0m14:44:59.405523 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:45:01.637193 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m14:45:01.638219 [debug] [MainThread]: On master: COMMIT
[0m14:45:01.639195 [debug] [MainThread]: Using mysql connection "master"
[0m14:45:01.640192 [debug] [MainThread]: On master: COMMIT
[0m14:45:02.232067 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m14:45:02.235065 [debug] [MainThread]: On master: Close
[0m14:45:02.239060 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m14:45:02.243045 [info ] [MainThread]: 
[0m14:45:02.269597 [debug] [Thread-1 (]: Began running node model.site_dev.Tactical_pageviews_card_month_12
[0m14:45:02.272589 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.Tactical_pageviews_card_month_12 .......... [RUN]
[0m14:45:02.282569 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.site_dev.Tactical_pageviews_card_month_12'
[0m14:45:02.286556 [debug] [Thread-1 (]: Began compiling node model.site_dev.Tactical_pageviews_card_month_12
[0m14:45:02.321452 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.Tactical_pageviews_card_month_12"
[0m14:45:02.328099 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_pageviews_card_month_12 (compile): 14:45:02.288546 => 14:45:02.327104
[0m14:45:02.329098 [debug] [Thread-1 (]: Began executing node model.site_dev.Tactical_pageviews_card_month_12
[0m14:45:02.397913 [debug] [Thread-1 (]: Writing runtime sql for node "model.site_dev.Tactical_pageviews_card_month_12"
[0m14:45:02.401905 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_pageviews_card_month_12"
[0m14:45:02.403898 [debug] [Thread-1 (]: On model.site_dev.Tactical_pageviews_card_month_12: BEGIN
[0m14:45:02.404895 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m14:45:03.947474 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m14:45:03.949477 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_pageviews_card_month_12"
[0m14:45:03.950476 [debug] [Thread-1 (]: On model.site_dev.Tactical_pageviews_card_month_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "node_id": "model.site_dev.Tactical_pageviews_card_month_12"} */

  create view `site_dev`.`Tactical_pageviews_card_month_12__dbt_tmp`
    
    
  as (
    






CREATE PROCEDURE `prod`.`Tactical_pageviews_card_month_12_dbt_test`()
BEGIN
with last_month_article_published as(
SELECT siteid as siteid,id   FROM prod.site_archive_post
where date between DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) 
AND  categories <> "Nyhedsoverblik"
and siteid = 12
),
last_month_article_published_Agg as(
select siteid as siteid,count(*) as agg from  last_month_article_published
where  siteid = 12
group by 1
),
agg_last_month as (
select  e.siteid as siteid,sum(unique_pageviews)/agg as value from prod.pages e
join  last_month_article_published a on a.id=e.postid
join last_month_article_published_Agg agg on agg.siteid=a.siteid 
where e.date between DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) and e.siteid = 12
group by 1,agg
),
last_month_before_article_published as(
SELECT siteid as siteid,id   FROM prod.site_archive_post
where DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY)  and siteid = 12
 AND  categories <> "Nyhedsoverblik"
),
last_month_before_article_published_Agg as(
select siteid as siteid,count(*) as agg from  last_month_before_article_published
where siteid = 12
group by 1
),
agg_last_month_before as(
select  e.siteid as siteid,sum(unique_pageviews)/agg as value from prod.pages e
join  last_month_before_article_published a on a.id=e.postid
join last_month_before_article_published_Agg agg on agg.siteid=a.siteid 
where DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY)  and e.siteid = 12
group by 1,agg
),
json_data as( 
select al.siteid as site, label_val label, hint_val  hint, al.value as valu,((al.value-alb.value)/al.value)*100 as chang, '' as progressCurrent , '' as progresstotal
from agg_last_month al
left join agg_last_month_before alb on al.siteid=alb.siteid
where al.siteid = 12
)
select 
    JSON_OBJECT(
            'site',12,
            'data',JSON_OBJECT(
            'label', 'Artikler',
            'hint', 'Artikler publiceret seneste 30 dage ift. forrige 30 dage',
            'value',COALESCE(valu,0),
            'change',COALESCE(chang,0),
            'progressCurrent',progressCurrent, 
            'progressTotal',progressTotal
 )) AS json_data  from json_data;
 
 END
  );
[0m14:45:04.534365 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_pageviews_card_month_12_dbt_test`()
BEGIN
with' at line 14
[0m14:45:04.538352 [debug] [Thread-1 (]: On model.site_dev.Tactical_pageviews_card_month_12: ROLLBACK
[0m14:45:04.734363 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_pageviews_card_month_12 (execute): 14:45:02.333086 => 14:45:04.732358
[0m14:45:04.737358 [debug] [Thread-1 (]: On model.site_dev.Tactical_pageviews_card_month_12: Close
[0m14:45:04.757297 [debug] [Thread-1 (]: Database Error in model Tactical_pageviews_card_month_12 (models\example\Tactical_pageviews_card_month_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_pageviews_card_month_12_dbt_test`()
  BEGIN
  with' at line 14
  compiled Code at target\run\site_dev\models\example\Tactical_pageviews_card_month_12.sql
[0m14:45:04.759292 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c832e5b9-c5f9-4d88-b3f7-bda35a479be3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC68EF5410>]}
[0m14:45:04.760288 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.Tactical_pageviews_card_month_12 . [[31mERROR[0m in 2.48s]
[0m14:45:04.762287 [debug] [Thread-1 (]: Finished running node model.site_dev.Tactical_pageviews_card_month_12
[0m14:45:04.765675 [debug] [MainThread]: Using mysql connection "master"
[0m14:45:04.767683 [debug] [MainThread]: On master: BEGIN
[0m14:45:04.767683 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m14:45:06.357593 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m14:45:06.359587 [debug] [MainThread]: On master: COMMIT
[0m14:45:06.361582 [debug] [MainThread]: Using mysql connection "master"
[0m14:45:06.363578 [debug] [MainThread]: On master: COMMIT
[0m14:45:06.960419 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m14:45:06.961414 [debug] [MainThread]: On master: Close
[0m14:45:06.963410 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:45:06.965405 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m14:45:06.966404 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m14:45:06.967400 [debug] [MainThread]: Connection 'model.site_dev.Tactical_pageviews_card_month_12' was properly closed.
[0m14:45:06.968397 [info ] [MainThread]: 
[0m14:45:06.970392 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 14.45 seconds (14.45s).
[0m14:45:06.973385 [debug] [MainThread]: Command end result
[0m14:45:06.992334 [info ] [MainThread]: 
[0m14:45:06.993331 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m14:45:06.994844 [info ] [MainThread]: 
[0m14:45:06.996150 [error] [MainThread]:   Database Error in model Tactical_pageviews_card_month_12 (models\example\Tactical_pageviews_card_month_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_pageviews_card_month_12_dbt_test`()
  BEGIN
  with' at line 14
  compiled Code at target\run\site_dev\models\example\Tactical_pageviews_card_month_12.sql
[0m14:45:06.997383 [info ] [MainThread]: 
[0m14:45:06.998388 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m14:45:07.001383 [debug] [MainThread]: Command `dbt run` failed at 14:45:07.001383 after 15.29 seconds
[0m14:45:07.002381 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC6896B990>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC61DB0B10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC61DB0AD0>]}
[0m14:45:07.003378 [debug] [MainThread]: Flushing usage events
[0m14:50:13.882327 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C563015FD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C561BEED10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C562AB7C50>]}


============================== 14:50:13.888309 | dfed74c6-f760-40d9-ba0e-d0ae5b876406 ==============================
[0m14:50:13.888309 [info ] [MainThread]: Running with dbt=1.7.17
[0m14:50:13.890305 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models example.Tactical_pageviews_card_month_12', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m14:50:14.187600 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'dfed74c6-f760-40d9-ba0e-d0ae5b876406', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5631FAF90>]}
[0m14:50:14.274366 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'dfed74c6-f760-40d9-ba0e-d0ae5b876406', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C562FC1150>]}
[0m14:50:14.276217 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m14:50:14.292180 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m14:50:14.439789 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m14:50:14.441780 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m14:50:14.445769 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example.run_Tactical_pageviews_card_ytd_12
[0m14:50:14.461725 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'dfed74c6-f760-40d9-ba0e-d0ae5b876406', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C56339F650>]}
[0m14:50:14.492644 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'dfed74c6-f760-40d9-ba0e-d0ae5b876406', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5632435D0>]}
[0m14:50:14.494640 [info ] [MainThread]: Found 15 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m14:50:14.495636 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'dfed74c6-f760-40d9-ba0e-d0ae5b876406', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5631EDA50>]}
[0m14:50:14.499626 [info ] [MainThread]: 
[0m14:50:14.501619 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m14:50:14.507605 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m14:50:14.528546 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m14:50:14.529543 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m14:50:14.530542 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:50:16.147488 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m14:50:16.149482 [debug] [ThreadPool]: On list_schemas: Close
[0m14:50:16.153475 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m14:50:16.155466 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m14:50:16.166436 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m14:50:16.168432 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m14:50:16.169432 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:50:17.727596 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m14:50:17.730597 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m14:50:17.732591 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m14:50:18.357231 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m14:50:18.361222 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m14:50:18.362220 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m14:50:18.363216 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m14:50:19.055367 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m14:50:19.057358 [debug] [ThreadPool]: On create__site_dev: Close
[0m14:50:19.073766 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m14:50:19.091716 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m14:50:19.092713 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m14:50:19.093711 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:50:20.681670 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m14:50:20.683660 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m14:50:20.684660 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m14:50:21.281603 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m14:50:21.284597 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m14:50:21.479074 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m14:50:21.482066 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'dfed74c6-f760-40d9-ba0e-d0ae5b876406', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5631C7C90>]}
[0m14:50:21.484062 [debug] [MainThread]: Using mysql connection "master"
[0m14:50:21.485062 [debug] [MainThread]: On master: BEGIN
[0m14:50:21.487055 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:50:23.029485 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m14:50:23.031479 [debug] [MainThread]: On master: COMMIT
[0m14:50:23.032476 [debug] [MainThread]: Using mysql connection "master"
[0m14:50:23.033473 [debug] [MainThread]: On master: COMMIT
[0m14:50:23.618907 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m14:50:23.619909 [debug] [MainThread]: On master: Close
[0m14:50:23.620903 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m14:50:23.621898 [info ] [MainThread]: 
[0m14:50:23.627883 [debug] [Thread-1 (]: Began running node model.site_dev.Tactical_pageviews_card_month_12
[0m14:50:23.628881 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.Tactical_pageviews_card_month_12 .......... [RUN]
[0m14:50:23.630876 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.site_dev.Tactical_pageviews_card_month_12'
[0m14:50:23.631874 [debug] [Thread-1 (]: Began compiling node model.site_dev.Tactical_pageviews_card_month_12
[0m14:50:23.650823 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.Tactical_pageviews_card_month_12"
[0m14:50:23.657806 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_pageviews_card_month_12 (compile): 14:50:23.632872 => 14:50:23.656807
[0m14:50:23.658800 [debug] [Thread-1 (]: Began executing node model.site_dev.Tactical_pageviews_card_month_12
[0m14:50:23.736591 [debug] [Thread-1 (]: Writing runtime sql for node "model.site_dev.Tactical_pageviews_card_month_12"
[0m14:50:23.739585 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_pageviews_card_month_12"
[0m14:50:23.741579 [debug] [Thread-1 (]: On model.site_dev.Tactical_pageviews_card_month_12: BEGIN
[0m14:50:23.742577 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m14:50:25.456124 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m14:50:25.457122 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_pageviews_card_month_12"
[0m14:50:25.458119 [debug] [Thread-1 (]: On model.site_dev.Tactical_pageviews_card_month_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "node_id": "model.site_dev.Tactical_pageviews_card_month_12"} */

  create view `site_dev`.`Tactical_pageviews_card_month_12__dbt_tmp`
    
    
  as (
    






CREATE PROCEDURE `prod`.`Tactical_pageviews_card_month_12_dbt_test`()
BEGIN
with last_month_article_published as(
SELECT siteid as siteid,id   FROM prod.site_archive_post
where date between DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) 
AND  categories <> "Nyhedsoverblik"
and siteid = 12
),
last_month_article_published_Agg as(
select siteid as siteid,count(*) as agg from  last_month_article_published
where  siteid = 12
group by 1
),
agg_last_month as (
select  e.siteid as siteid,sum(unique_pageviews)/agg as value from prod.pages e
join  last_month_article_published a on a.id=e.postid
join last_month_article_published_Agg agg on agg.siteid=a.siteid 
where e.date between DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) and e.siteid = 12
group by 1,agg
),
last_month_before_article_published as(
SELECT siteid as siteid,id   FROM prod.site_archive_post
where DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY)  and siteid = 12
 AND  categories <> "Nyhedsoverblik"
),
last_month_before_article_published_Agg as(
select siteid as siteid,count(*) as agg from  last_month_before_article_published
where siteid = 12
group by 1
),
agg_last_month_before as(
select  e.siteid as siteid,sum(unique_pageviews)/agg as value from prod.pages e
join  last_month_before_article_published a on a.id=e.postid
join last_month_before_article_published_Agg agg on agg.siteid=a.siteid 
where DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY)  and e.siteid = 12
group by 1,agg
),
json_data as( 
select al.siteid as site, label_val label, hint_val  hint, al.value as valu,((al.value-alb.value)/al.value)*100 as chang, '' as progressCurrent , '' as progresstotal
from agg_last_month al
left join agg_last_month_before alb on al.siteid=alb.siteid
where al.siteid = 12
)
select 
    JSON_OBJECT(
            'site',12,
            'data',JSON_OBJECT(
            'label', 'Artikler',
            'hint', 'Artikler publiceret seneste 30 dage ift. forrige 30 dage',
            'value',COALESCE(valu,0),
            'change',COALESCE(chang,0),
            'progressCurrent',progressCurrent, 
            'progressTotal',progressTotal
 )) AS json_data  from json_data;
 
 END
  );
[0m14:50:26.046693 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_pageviews_card_month_12_dbt_test`()
BEGIN
with' at line 14
[0m14:50:26.049675 [debug] [Thread-1 (]: On model.site_dev.Tactical_pageviews_card_month_12: ROLLBACK
[0m14:50:26.245800 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_pageviews_card_month_12 (execute): 14:50:23.659798 => 14:50:26.245800
[0m14:50:26.247797 [debug] [Thread-1 (]: On model.site_dev.Tactical_pageviews_card_month_12: Close
[0m14:50:26.264751 [debug] [Thread-1 (]: Database Error in model Tactical_pageviews_card_month_12 (models\example\Tactical_pageviews_card_month_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_pageviews_card_month_12_dbt_test`()
  BEGIN
  with' at line 14
  compiled Code at target\run\site_dev\models\example\Tactical_pageviews_card_month_12.sql
[0m14:50:26.266745 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dfed74c6-f760-40d9-ba0e-d0ae5b876406', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C56328CE90>]}
[0m14:50:26.268739 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.Tactical_pageviews_card_month_12 . [[31mERROR[0m in 2.64s]
[0m14:50:26.278713 [debug] [Thread-1 (]: Finished running node model.site_dev.Tactical_pageviews_card_month_12
[0m14:50:26.283699 [debug] [MainThread]: Using mysql connection "master"
[0m14:50:26.285694 [debug] [MainThread]: On master: BEGIN
[0m14:50:26.286691 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m14:50:27.872946 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m14:50:27.874951 [debug] [MainThread]: On master: COMMIT
[0m14:50:27.876941 [debug] [MainThread]: Using mysql connection "master"
[0m14:50:27.877936 [debug] [MainThread]: On master: COMMIT
[0m14:50:28.463364 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m14:50:28.464384 [debug] [MainThread]: On master: Close
[0m14:50:28.466379 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:50:28.466379 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m14:50:28.467376 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m14:50:28.468374 [debug] [MainThread]: Connection 'model.site_dev.Tactical_pageviews_card_month_12' was properly closed.
[0m14:50:28.469371 [info ] [MainThread]: 
[0m14:50:28.470004 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 13.97 seconds (13.97s).
[0m14:50:28.472095 [debug] [MainThread]: Command end result
[0m14:50:28.491047 [info ] [MainThread]: 
[0m14:50:28.493043 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m14:50:28.494051 [info ] [MainThread]: 
[0m14:50:28.496031 [error] [MainThread]:   Database Error in model Tactical_pageviews_card_month_12 (models\example\Tactical_pageviews_card_month_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_pageviews_card_month_12_dbt_test`()
  BEGIN
  with' at line 14
  compiled Code at target\run\site_dev\models\example\Tactical_pageviews_card_month_12.sql
[0m14:50:28.499035 [info ] [MainThread]: 
[0m14:50:28.503020 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m14:50:28.506005 [debug] [MainThread]: Command `dbt run` failed at 14:50:28.505009 after 14.71 seconds
[0m14:50:28.508006 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C55C470B10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C55C470AD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5631ED790>]}
[0m14:50:28.508996 [debug] [MainThread]: Flushing usage events
[0m14:52:27.510186 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AC758B9110>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AC758B86D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AC758B9350>]}


============================== 14:52:27.519164 | 76c310d4-a220-416e-82b5-650526fc1cc0 ==============================
[0m14:52:27.519164 [info ] [MainThread]: Running with dbt=1.7.17
[0m14:52:27.521155 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'debug': 'False', 'version_check': 'True', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run --models example.Tactical_clicks_months_12', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m14:52:27.853706 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '76c310d4-a220-416e-82b5-650526fc1cc0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AC75A7FE50>]}
[0m14:52:27.936485 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '76c310d4-a220-416e-82b5-650526fc1cc0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AC74CD6F90>]}
[0m14:52:27.939066 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m14:52:27.951036 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m14:52:28.050771 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m14:52:28.051769 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m14:52:28.053763 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example.run_Tactical_pageviews_card_ytd_12
[0m14:52:28.063735 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '76c310d4-a220-416e-82b5-650526fc1cc0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AC75C7F690>]}
[0m14:52:28.084682 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '76c310d4-a220-416e-82b5-650526fc1cc0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AC75BD7A10>]}
[0m14:52:28.085679 [info ] [MainThread]: Found 15 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m14:52:28.086676 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '76c310d4-a220-416e-82b5-650526fc1cc0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AC75B22B10>]}
[0m14:52:28.088673 [info ] [MainThread]: 
[0m14:52:28.090665 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m14:52:28.094653 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m14:52:28.107617 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m14:52:28.109612 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m14:52:28.110610 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:52:29.658693 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m14:52:29.660688 [debug] [ThreadPool]: On list_schemas: Close
[0m14:52:29.662682 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m14:52:29.665674 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m14:52:29.678640 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m14:52:29.679638 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m14:52:29.680634 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:52:31.416219 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m14:52:31.418214 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m14:52:31.424196 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m14:52:32.023852 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m14:52:32.026845 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m14:52:32.028839 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m14:52:32.029837 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m14:52:32.622140 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m14:52:32.624130 [debug] [ThreadPool]: On create__site_dev: Close
[0m14:52:32.641079 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m14:52:32.671001 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m14:52:32.674999 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m14:52:32.677982 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:52:34.302076 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m14:52:34.303073 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m14:52:34.304072 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m14:52:34.901977 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m14:52:34.905961 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m14:52:35.112220 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m14:52:35.117200 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '76c310d4-a220-416e-82b5-650526fc1cc0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AC75308950>]}
[0m14:52:35.120192 [debug] [MainThread]: Using mysql connection "master"
[0m14:52:35.122181 [debug] [MainThread]: On master: BEGIN
[0m14:52:35.124177 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:52:36.756325 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m14:52:36.757326 [debug] [MainThread]: On master: COMMIT
[0m14:52:36.758323 [debug] [MainThread]: Using mysql connection "master"
[0m14:52:36.759320 [debug] [MainThread]: On master: COMMIT
[0m14:52:37.355887 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m14:52:37.358876 [debug] [MainThread]: On master: Close
[0m14:52:37.365857 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m14:52:37.368850 [info ] [MainThread]: 
[0m14:52:37.383371 [debug] [Thread-1 (]: Began running node model.site_dev.Tactical_clicks_months_12
[0m14:52:37.386362 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.Tactical_clicks_months_12 ................. [RUN]
[0m14:52:37.393345 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.site_dev.Tactical_clicks_months_12'
[0m14:52:37.397331 [debug] [Thread-1 (]: Began compiling node model.site_dev.Tactical_clicks_months_12
[0m14:52:37.434227 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.Tactical_clicks_months_12"
[0m14:52:37.437226 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_clicks_months_12 (compile): 14:52:37.400321 => 14:52:37.436223
[0m14:52:37.438220 [debug] [Thread-1 (]: Began executing node model.site_dev.Tactical_clicks_months_12
[0m14:52:37.487088 [debug] [Thread-1 (]: Writing runtime sql for node "model.site_dev.Tactical_clicks_months_12"
[0m14:52:37.489082 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_clicks_months_12"
[0m14:52:37.490079 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: BEGIN
[0m14:52:37.491076 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m14:52:39.042311 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m14:52:39.047294 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_clicks_months_12"
[0m14:52:39.054277 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "node_id": "model.site_dev.Tactical_clicks_months_12"} */

  create view `site_dev`.`Tactical_clicks_months_12__dbt_tmp`
    
    
  as (
    








CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
BEGIN
    WITH curr_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND categories <> "Nyhedsoverblik"
        AND siteid = '12'
    ),
    agg_curr_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks
        FROM prod.events e
        JOIN curr_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND e.siteid = '12'
        AND e.Event_Action = 'Next Click'
        GROUP BY 1
    ),
    agg_curr_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum
        FROM prod.pages p
        LEFT JOIN curr_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = '12'
        AND p.date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        GROUP BY p.siteid
    ),
    value_curr_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks / p.pageview_sum * 100, 2) AS value
        FROM agg_curr_30_days_events e
        LEFT JOIN agg_curr_30_days_pages p ON e.siteid = p.siteid
    ),
    last_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        AND siteid = site
        AND categories <> "Nyhedsoverblik"
    ),
    agg_last_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks_last
        FROM prod.events e
        JOIN last_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        AND e.siteid = '12'
        AND e.Event_Action = 'Next Click'
        GROUP BY 1
    ),
    agg_last_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum_last
        FROM prod.pages p
        LEFT JOIN last_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = '12'
        AND p.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        GROUP BY p.siteid
    ),
    value_last_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks_last / p.pageview_sum_last * 100, 2) AS value_last
        FROM agg_last_30_days_events e
        LEFT JOIN agg_last_30_days_pages p ON e.siteid = p.siteid
    )
    SELECT 
        JSON_OBJECT(
            'site', al.siteid,
            'data', JSON_OBJECT(
            'label', 'Artikler',
            'hint', 'Artikler publiceret seneste 30 dage ift. forrige 30 dage',
            'value', COALESCE(value, 0),
            'change', COALESCE(value - value_last, 0),
            'progressCurrent', '',
            'progressTotal', ''
            )
        ) AS json_data
    FROM value_curr_30_days al
    LEFT JOIN value_last_30_days alb ON al.siteid = alb.siteid
    WHERE al.siteid = '12';
END;
  );
[0m14:52:39.648559 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
BEGIN
    WITH cu' at line 16
[0m14:52:39.651553 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: ROLLBACK
[0m14:52:39.858933 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_clicks_months_12 (execute): 14:52:37.439216 => 14:52:39.857935
[0m14:52:39.860927 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: Close
[0m14:52:39.877882 [debug] [Thread-1 (]: Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
  BEGIN
      WITH cu' at line 16
  compiled Code at target\run\site_dev\models\example\Tactical_clicks_months_12.sql
[0m14:52:39.878879 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76c310d4-a220-416e-82b5-650526fc1cc0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AC75D80510>]}
[0m14:52:39.880874 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.Tactical_clicks_months_12 ........ [[31mERROR[0m in 2.49s]
[0m14:52:39.883868 [debug] [Thread-1 (]: Finished running node model.site_dev.Tactical_clicks_months_12
[0m14:52:39.888853 [debug] [MainThread]: Using mysql connection "master"
[0m14:52:39.889850 [debug] [MainThread]: On master: BEGIN
[0m14:52:39.891844 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m14:52:41.488792 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m14:52:41.489790 [debug] [MainThread]: On master: COMMIT
[0m14:52:41.491786 [debug] [MainThread]: Using mysql connection "master"
[0m14:52:41.492782 [debug] [MainThread]: On master: COMMIT
[0m14:52:42.081417 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m14:52:42.082417 [debug] [MainThread]: On master: Close
[0m14:52:42.084419 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:52:42.085410 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m14:52:42.086406 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m14:52:42.087403 [debug] [MainThread]: Connection 'model.site_dev.Tactical_clicks_months_12' was properly closed.
[0m14:52:42.088407 [info ] [MainThread]: 
[0m14:52:42.089398 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 14.00 seconds (14.00s).
[0m14:52:42.091393 [debug] [MainThread]: Command end result
[0m14:52:42.111339 [info ] [MainThread]: 
[0m14:52:42.113334 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m14:52:42.114334 [info ] [MainThread]: 
[0m14:52:42.115328 [error] [MainThread]:   Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
  BEGIN
      WITH cu' at line 16
  compiled Code at target\run\site_dev\models\example\Tactical_clicks_months_12.sql
[0m14:52:42.116327 [info ] [MainThread]: 
[0m14:52:42.117321 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m14:52:42.121312 [debug] [MainThread]: Command `dbt run` failed at 14:52:42.120315 after 14.71 seconds
[0m14:52:42.122317 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AC6ED81750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AC6ED72310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AC75B3E8D0>]}
[0m14:52:42.122317 [debug] [MainThread]: Flushing usage events
[0m14:58:23.704649 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029085ABC7D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029085AFA650>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029085ABCF10>]}


============================== 14:58:23.712627 | 6e726317-b96e-427e-b23d-7e9f1216cf26 ==============================
[0m14:58:23.712627 [info ] [MainThread]: Running with dbt=1.7.17
[0m14:58:23.713628 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --models example.Tactical_clicks_months_12', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m14:58:24.067680 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6e726317-b96e-427e-b23d-7e9f1216cf26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029085CBEFD0>]}
[0m14:58:24.191350 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6e726317-b96e-427e-b23d-7e9f1216cf26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000290833A3F90>]}
[0m14:58:24.194341 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m14:58:24.215163 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m14:58:25.313344 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m14:58:25.314332 [debug] [MainThread]: Partial parsing: updated file: site_dev://models\example\Tactical_clicks_months_12.sql
[0m14:58:25.512771 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example.run_Tactical_pageviews_card_ytd_12
[0m14:58:25.519753 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6e726317-b96e-427e-b23d-7e9f1216cf26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029085DF4890>]}
[0m14:58:25.551668 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6e726317-b96e-427e-b23d-7e9f1216cf26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029086047310>]}
[0m14:58:25.552664 [info ] [MainThread]: Found 15 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m14:58:25.553662 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6e726317-b96e-427e-b23d-7e9f1216cf26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029085E40D90>]}
[0m14:58:25.556670 [info ] [MainThread]: 
[0m14:58:25.558652 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m14:58:25.560644 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m14:58:25.574606 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m14:58:25.574606 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m14:58:25.575604 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:58:27.584965 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m14:58:27.588785 [debug] [ThreadPool]: On list_schemas: Close
[0m14:58:27.590779 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m14:58:27.592776 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m14:58:27.600754 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m14:58:27.600754 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m14:58:27.601750 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:58:29.382017 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m14:58:29.383018 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m14:58:29.384018 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m14:58:30.409718 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m14:58:30.415714 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m14:58:30.416706 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m14:58:30.417705 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m14:58:31.232235 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m14:58:31.235236 [debug] [ThreadPool]: On create__site_dev: Close
[0m14:58:31.240594 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m14:58:31.248587 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m14:58:31.249568 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m14:58:31.249568 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:58:32.838353 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m14:58:32.840354 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m14:58:32.842338 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m14:58:33.433739 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m14:58:33.436751 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m14:58:33.645487 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m14:58:33.647478 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6e726317-b96e-427e-b23d-7e9f1216cf26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029085D20E10>]}
[0m14:58:33.649477 [debug] [MainThread]: Using mysql connection "master"
[0m14:58:33.651471 [debug] [MainThread]: On master: BEGIN
[0m14:58:33.652470 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:58:35.244709 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m14:58:35.246711 [debug] [MainThread]: On master: COMMIT
[0m14:58:35.248695 [debug] [MainThread]: Using mysql connection "master"
[0m14:58:35.249686 [debug] [MainThread]: On master: COMMIT
[0m14:58:35.847806 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m14:58:35.850835 [debug] [MainThread]: On master: Close
[0m14:58:35.853816 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m14:58:35.854813 [info ] [MainThread]: 
[0m14:58:35.861439 [debug] [Thread-1 (]: Began running node model.site_dev.Tactical_clicks_months_12
[0m14:58:35.862438 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.Tactical_clicks_months_12 ................. [RUN]
[0m14:58:35.863436 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.site_dev.Tactical_clicks_months_12'
[0m14:58:35.864434 [debug] [Thread-1 (]: Began compiling node model.site_dev.Tactical_clicks_months_12
[0m14:58:35.879393 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.Tactical_clicks_months_12"
[0m14:58:35.881391 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_clicks_months_12 (compile): 14:58:35.865431 => 14:58:35.880391
[0m14:58:35.882385 [debug] [Thread-1 (]: Began executing node model.site_dev.Tactical_clicks_months_12
[0m14:58:35.927267 [debug] [Thread-1 (]: Writing runtime sql for node "model.site_dev.Tactical_clicks_months_12"
[0m14:58:35.928265 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_clicks_months_12"
[0m14:58:35.929263 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: BEGIN
[0m14:58:35.930259 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m14:58:37.770699 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m14:58:37.774687 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_clicks_months_12"
[0m14:58:37.775679 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "node_id": "model.site_dev.Tactical_clicks_months_12"} */

  create view `site_dev`.`Tactical_clicks_months_12__dbt_tmp`
    
    
  as (
    







DELIMITER //
CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
BEGIN
    WITH curr_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND categories <> "Nyhedsoverblik"
        AND siteid = '12'
    ),
    agg_curr_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks
        FROM prod.events e
        JOIN curr_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND e.siteid = '12'
        AND e.Event_Action = 'Next Click'
        GROUP BY 1
    ),
    agg_curr_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum
        FROM prod.pages p
        LEFT JOIN curr_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = '12'
        AND p.date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        GROUP BY p.siteid
    ),
    value_curr_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks / p.pageview_sum * 100, 2) AS value
        FROM agg_curr_30_days_events e
        LEFT JOIN agg_curr_30_days_pages p ON e.siteid = p.siteid
    ),
    last_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        AND siteid = site
        AND categories <> "Nyhedsoverblik"
    ),
    agg_last_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks_last
        FROM prod.events e
        JOIN last_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        AND e.siteid = '12'
        AND e.Event_Action = 'Next Click'
        GROUP BY 1
    ),
    agg_last_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum_last
        FROM prod.pages p
        LEFT JOIN last_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = '12'
        AND p.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        GROUP BY p.siteid
    ),
    value_last_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks_last / p.pageview_sum_last * 100, 2) AS value_last
        FROM agg_last_30_days_events e
        LEFT JOIN agg_last_30_days_pages p ON e.siteid = p.siteid
    )
    SELECT 
        JSON_OBJECT(
            'site', al.siteid,
            'data', JSON_OBJECT(
            'label', 'Artikler',
            'hint', 'Artikler publiceret seneste 30 dage ift. forrige 30 dage',
            'value', COALESCE(value, 0),
            'change', COALESCE(value - value_last, 0),
            'progressCurrent', '',
            'progressTotal', ''
            )
        ) AS json_data
    FROM value_curr_30_days al
    LEFT JOIN value_last_30_days alb ON al.siteid = alb.siteid
    WHERE al.siteid = '12';
END;
DELIMITER ;
  );
[0m14:58:38.497904 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'DELIMITER //
CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
BEGI' at line 15
[0m14:58:38.499874 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: ROLLBACK
[0m14:58:38.760472 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_clicks_months_12 (execute): 14:58:35.883384 => 14:58:38.759445
[0m14:58:38.763472 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: Close
[0m14:58:38.920497 [debug] [Thread-1 (]: Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'DELIMITER //
  CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
  BEGI' at line 15
  compiled Code at target\run\site_dev\models\example\Tactical_clicks_months_12.sql
[0m14:58:38.922490 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6e726317-b96e-427e-b23d-7e9f1216cf26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029086077510>]}
[0m14:58:38.924489 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.Tactical_clicks_months_12 ........ [[31mERROR[0m in 3.06s]
[0m14:58:38.927476 [debug] [Thread-1 (]: Finished running node model.site_dev.Tactical_clicks_months_12
[0m14:58:38.933461 [debug] [MainThread]: Using mysql connection "master"
[0m14:58:38.934458 [debug] [MainThread]: On master: BEGIN
[0m14:58:38.936452 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m14:58:40.549269 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m14:58:40.552289 [debug] [MainThread]: On master: COMMIT
[0m14:58:40.554281 [debug] [MainThread]: Using mysql connection "master"
[0m14:58:40.554281 [debug] [MainThread]: On master: COMMIT
[0m14:58:41.159416 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m14:58:41.162437 [debug] [MainThread]: On master: Close
[0m14:58:41.163431 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:58:41.164456 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m14:58:41.165427 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m14:58:41.166423 [debug] [MainThread]: Connection 'model.site_dev.Tactical_clicks_months_12' was properly closed.
[0m14:58:41.166423 [info ] [MainThread]: 
[0m14:58:41.167422 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 15.61 seconds (15.61s).
[0m14:58:41.169453 [debug] [MainThread]: Command end result
[0m14:58:41.182381 [info ] [MainThread]: 
[0m14:58:41.183380 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m14:58:41.184375 [info ] [MainThread]: 
[0m14:58:41.185371 [error] [MainThread]:   Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'DELIMITER //
  CREATE PROCEDURE `prod`.`Tactical_clicks_months_12_dbt_test`()
  BEGI' at line 15
  compiled Code at target\run\site_dev\models\example\Tactical_clicks_months_12.sql
[0m14:58:41.186370 [info ] [MainThread]: 
[0m14:58:41.187367 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m14:58:41.189363 [debug] [MainThread]: Command `dbt run` failed at 14:58:41.188365 after 17.61 seconds
[0m14:58:41.190359 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029085AF7410>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029085ABC550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029085D3B690>]}
[0m14:58:41.191370 [debug] [MainThread]: Flushing usage events
[0m15:05:42.592038 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E07104D4D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E070466ED0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E070466D90>]}


============================== 15:05:42.603009 | 75f46e40-b84b-47a9-8652-77774d689836 ==============================
[0m15:05:42.603009 [info ] [MainThread]: Running with dbt=1.7.17
[0m15:05:42.606001 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'debug': 'False', 'version_check': 'True', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --models example.Tactical_clicks_months_12', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m15:05:42.958058 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '75f46e40-b84b-47a9-8652-77774d689836', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E071075AD0>]}
[0m15:05:43.067766 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '75f46e40-b84b-47a9-8652-77774d689836', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0712164D0>]}
[0m15:05:43.070758 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m15:05:43.088710 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m15:05:43.271222 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 2 files changed.
[0m15:05:43.272218 [debug] [MainThread]: Partial parsing: updated file: site_dev://models\example\Tactical_clicks_months_12.sql
[0m15:05:43.273216 [debug] [MainThread]: Partial parsing: updated file: site_dev://models\cards.sql
[0m15:05:43.512578 [error] [MainThread]: Encountered an error:
Compilation Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  Unexpected end of template. Jinja was looking for the following tags: 'endcall'. The innermost block that needs to be closed is 'call'.
    line 106
      {% call create_stored_procedure() %}
[0m15:05:43.515568 [debug] [MainThread]: Command `dbt run` failed at 15:05:43.515568 after 1.18 seconds
[0m15:05:43.517564 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E071038550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E06A5E1750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E071031450>]}
[0m15:05:43.518561 [debug] [MainThread]: Flushing usage events
[0m15:06:02.274062 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023C5BB4D450>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023C5BB8B850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023C5BB8B990>]}


============================== 15:06:02.281042 | abb7bb30-8ef2-46f4-93f2-2ad5c72a6dd6 ==============================
[0m15:06:02.281042 [info ] [MainThread]: Running with dbt=1.7.17
[0m15:06:02.283037 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run --models example.Tactical_clicks_months_12', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m15:06:02.576792 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'abb7bb30-8ef2-46f4-93f2-2ad5c72a6dd6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023C5BD83B50>]}
[0m15:06:02.668546 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'abb7bb30-8ef2-46f4-93f2-2ad5c72a6dd6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023C5BD44750>]}
[0m15:06:02.670200 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m15:06:02.691147 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m15:06:02.805840 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 2 files changed.
[0m15:06:02.806837 [debug] [MainThread]: Partial parsing: updated file: site_dev://models\cards.sql
[0m15:06:02.808849 [debug] [MainThread]: Partial parsing: updated file: site_dev://models\example\Tactical_clicks_months_12.sql
[0m15:06:03.012554 [error] [MainThread]: Encountered an error:
Compilation Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  Unexpected end of template. Jinja was looking for the following tags: 'endcall'. The innermost block that needs to be closed is 'call'.
    line 106
      {% call create_stored_procedure() %}
[0m15:06:03.015549 [debug] [MainThread]: Command `dbt run` failed at 15:06:03.014551 after 0.84 seconds
[0m15:06:03.015549 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023C5BB8BBD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023C5C0804D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023C5B791CD0>]}
[0m15:06:03.016547 [debug] [MainThread]: Flushing usage events
[0m15:07:05.125758 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000240B41DC7D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000240B41DC950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000240B41DFD50>]}


============================== 15:07:05.134734 | 98e33b7b-5415-40db-9851-078e6411db3c ==============================
[0m15:07:05.134734 [info ] [MainThread]: Running with dbt=1.7.17
[0m15:07:05.136730 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'debug': 'False', 'warn_error': 'None', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models example.Tactical_clicks_months_12', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m15:07:05.491022 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '98e33b7b-5415-40db-9851-078e6411db3c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000240B439DA90>]}
[0m15:07:05.670538 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '98e33b7b-5415-40db-9851-078e6411db3c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000240B4408250>]}
[0m15:07:05.673532 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m15:07:05.687493 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m15:07:05.807174 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 2 files changed.
[0m15:07:05.808173 [debug] [MainThread]: Partial parsing: updated file: site_dev://models\cards.sql
[0m15:07:05.809170 [debug] [MainThread]: Partial parsing: updated file: site_dev://models\example\Tactical_clicks_months_12.sql
[0m15:07:06.038556 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example.run_Tactical_pageviews_card_ytd_12
[0m15:07:06.051522 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '98e33b7b-5415-40db-9851-078e6411db3c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000240B45A6250>]}
[0m15:07:06.074458 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '98e33b7b-5415-40db-9851-078e6411db3c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000240B458D890>]}
[0m15:07:06.075457 [info ] [MainThread]: Found 15 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m15:07:06.076453 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '98e33b7b-5415-40db-9851-078e6411db3c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000240B45707D0>]}
[0m15:07:06.081441 [info ] [MainThread]: 
[0m15:07:06.082438 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m15:07:06.085674 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m15:07:06.103626 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m15:07:06.104623 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m15:07:06.105620 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:07:07.651427 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m15:07:07.654397 [debug] [ThreadPool]: On list_schemas: Close
[0m15:07:07.656393 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m15:07:07.657390 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m15:07:07.668361 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m15:07:07.668361 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m15:07:07.669358 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:07:09.219097 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m15:07:09.221083 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m15:07:09.223078 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m15:07:09.845712 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m15:07:09.848765 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m15:07:09.850730 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m15:07:09.852719 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m15:07:10.441455 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m15:07:10.443445 [debug] [ThreadPool]: On create__site_dev: Close
[0m15:07:10.448314 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m15:07:10.456296 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m15:07:10.457293 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m15:07:10.458291 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:07:12.026224 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m15:07:12.029229 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m15:07:12.031217 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m15:07:12.624027 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m15:07:12.626025 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m15:07:12.821496 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m15:07:12.824488 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '98e33b7b-5415-40db-9851-078e6411db3c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000240B447EA50>]}
[0m15:07:12.826498 [debug] [MainThread]: Using mysql connection "master"
[0m15:07:12.827480 [debug] [MainThread]: On master: BEGIN
[0m15:07:12.829489 [debug] [MainThread]: Opening a new connection, currently in state init
[0m15:07:14.366673 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m15:07:14.369670 [debug] [MainThread]: On master: COMMIT
[0m15:07:14.374650 [debug] [MainThread]: Using mysql connection "master"
[0m15:07:14.377642 [debug] [MainThread]: On master: COMMIT
[0m15:07:14.954707 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m15:07:14.957701 [debug] [MainThread]: On master: Close
[0m15:07:14.962691 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m15:07:14.964684 [info ] [MainThread]: 
[0m15:07:14.979522 [debug] [Thread-1 (]: Began running node model.site_dev.Tactical_clicks_months_12
[0m15:07:14.982513 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.Tactical_clicks_months_12 ................. [RUN]
[0m15:07:14.987506 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.site_dev.Tactical_clicks_months_12'
[0m15:07:14.990500 [debug] [Thread-1 (]: Began compiling node model.site_dev.Tactical_clicks_months_12
[0m15:07:15.015424 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.Tactical_clicks_months_12"
[0m15:07:15.017419 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_clicks_months_12 (compile): 15:07:14.992489 => 15:07:15.016441
[0m15:07:15.018417 [debug] [Thread-1 (]: Began executing node model.site_dev.Tactical_clicks_months_12
[0m15:07:15.064292 [debug] [Thread-1 (]: Writing runtime sql for node "model.site_dev.Tactical_clicks_months_12"
[0m15:07:15.066287 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_clicks_months_12"
[0m15:07:15.067284 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: BEGIN
[0m15:07:15.068283 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m15:07:16.611900 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m15:07:16.613892 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_clicks_months_12"
[0m15:07:16.615885 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "node_id": "model.site_dev.Tactical_clicks_months_12"} */

  create view `site_dev`.`Tactical_clicks_months_12__dbt_tmp`
    
    
  as (
    







DELIMITER //
CREATE PROCEDURE `Tactical_clicks_months_12_dbt_test`()
BEGIN
    WITH curr_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND categories <> "Nyhedsoverblik"
        AND siteid = '12'
    ),
    agg_curr_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks
        FROM prod.events e
        JOIN curr_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND e.siteid = '12'
        AND e.Event_Action = 'Next Click'
        GROUP BY 1
    ),
    agg_curr_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum
        FROM prod.pages p
        LEFT JOIN curr_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = '12'
        AND p.date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        GROUP BY p.siteid
    ),
    value_curr_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks / p.pageview_sum * 100, 2) AS value
        FROM agg_curr_30_days_events e
        LEFT JOIN agg_curr_30_days_pages p ON e.siteid = p.siteid
    ),
    last_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        AND siteid = site
        AND categories <> "Nyhedsoverblik"
    ),
    agg_last_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks_last
        FROM prod.events e
        JOIN last_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        AND e.siteid = '12'
        AND e.Event_Action = 'Next Click'
        GROUP BY 1
    ),
    agg_last_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum_last
        FROM prod.pages p
        LEFT JOIN last_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = '12'
        AND p.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        GROUP BY p.siteid
    ),
    value_last_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks_last / p.pageview_sum_last * 100, 2) AS value_last
        FROM agg_last_30_days_events e
        LEFT JOIN agg_last_30_days_pages p ON e.siteid = p.siteid
    )
    SELECT 
        JSON_OBJECT(
            'site', al.siteid,
            'data', JSON_OBJECT(
            'label', 'Artikler',
            'hint', 'Artikler publiceret seneste 30 dage ift. forrige 30 dage',
            'value', COALESCE(value, 0),
            'change', COALESCE(value - value_last, 0),
            'progressCurrent', '',
            'progressTotal', ''
            )
        ) AS json_data
    FROM value_curr_30_days al
    LEFT JOIN value_last_30_days alb ON al.siteid = alb.siteid
    WHERE al.siteid = '12';
END;
DELIMITER ;
  );
[0m15:07:17.196391 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'DELIMITER //
CREATE PROCEDURE `Tactical_clicks_months_12_dbt_test`()
BEGIN
    W' at line 15
[0m15:07:17.198391 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: ROLLBACK
[0m15:07:17.392944 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_clicks_months_12 (execute): 15:07:15.018417 => 15:07:17.390918
[0m15:07:17.395944 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: Close
[0m15:07:17.412885 [debug] [Thread-1 (]: Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'DELIMITER //
  CREATE PROCEDURE `Tactical_clicks_months_12_dbt_test`()
  BEGIN
      W' at line 15
  compiled Code at target\run\site_dev\models\example\Tactical_clicks_months_12.sql
[0m15:07:17.414880 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98e33b7b-5415-40db-9851-078e6411db3c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000240B470D9D0>]}
[0m15:07:17.416876 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.Tactical_clicks_months_12 ........ [[31mERROR[0m in 2.43s]
[0m15:07:17.418869 [debug] [Thread-1 (]: Finished running node model.site_dev.Tactical_clicks_months_12
[0m15:07:17.422857 [debug] [MainThread]: Using mysql connection "master"
[0m15:07:17.423857 [debug] [MainThread]: On master: BEGIN
[0m15:07:17.424854 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m15:07:18.963184 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m15:07:18.966179 [debug] [MainThread]: On master: COMMIT
[0m15:07:18.969177 [debug] [MainThread]: Using mysql connection "master"
[0m15:07:18.971162 [debug] [MainThread]: On master: COMMIT
[0m15:07:19.550009 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m15:07:19.552007 [debug] [MainThread]: On master: Close
[0m15:07:19.555995 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:07:19.556990 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m15:07:19.557987 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m15:07:19.558984 [debug] [MainThread]: Connection 'model.site_dev.Tactical_clicks_months_12' was properly closed.
[0m15:07:19.559980 [info ] [MainThread]: 
[0m15:07:19.560979 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 13.48 seconds (13.48s).
[0m15:07:19.561976 [debug] [MainThread]: Command end result
[0m15:07:19.576935 [info ] [MainThread]: 
[0m15:07:19.577935 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m15:07:19.579928 [info ] [MainThread]: 
[0m15:07:19.580926 [error] [MainThread]:   Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'DELIMITER //
  CREATE PROCEDURE `Tactical_clicks_months_12_dbt_test`()
  BEGIN
      W' at line 15
  compiled Code at target\run\site_dev\models\example\Tactical_clicks_months_12.sql
[0m15:07:19.583918 [info ] [MainThread]: 
[0m15:07:19.584941 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m15:07:19.588925 [debug] [MainThread]: Command `dbt run` failed at 15:07:19.587906 after 14.57 seconds
[0m15:07:19.589901 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000240B2F65750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000240AD7D1710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000240AD7D14D0>]}
[0m15:07:19.591906 [debug] [MainThread]: Flushing usage events
[0m16:09:24.360061 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029509109750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002950913A410>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002950913A810>]}


============================== 16:09:24.368038 | 44d0056f-8601-42a1-95c0-6c47f2e0fdca ==============================
[0m16:09:24.368038 [info ] [MainThread]: Running with dbt=1.7.17
[0m16:09:24.370035 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --models example.Tactical_clicks_months_12.sql', 'send_anonymous_usage_stats': 'True'}
[0m16:09:24.557637 [error] [MainThread]: Encountered an error:
Runtime Error
  at path []: Additional properties are not allowed ('prod_in_site_dev', 'site_dev' were unexpected)

Error encountered in E:\Kasper_Sindri_Media\dbt_project.yml
[0m16:09:24.559632 [debug] [MainThread]: Command `dbt run` failed at 16:09:24.559632 after 0.30 seconds
[0m16:09:24.560630 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000295090E9A50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029509297D90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000295090E86D0>]}
[0m16:09:24.561627 [debug] [MainThread]: Flushing usage events
[0m16:09:44.702255 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F3EF12B190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F3EF17BF90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F3EF17BE90>]}


============================== 16:09:44.708236 | acc3ce74-1752-46ab-8ebf-e6db2d6ccc3b ==============================
[0m16:09:44.708236 [info ] [MainThread]: Running with dbt=1.7.17
[0m16:09:44.710233 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models Tactical_clicks_months_12.sql', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m16:09:44.923710 [error] [MainThread]: Encountered an error:
Runtime Error
  at path []: Additional properties are not allowed ('prod_in_site_dev', 'site_dev' were unexpected)

Error encountered in E:\Kasper_Sindri_Media\dbt_project.yml
[0m16:09:44.926702 [debug] [MainThread]: Command `dbt run` failed at 16:09:44.926702 after 0.33 seconds
[0m16:09:44.928699 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F3EE5666D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F3EF2E7D90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F3E8691790>]}
[0m16:09:44.929696 [debug] [MainThread]: Flushing usage events
[0m16:12:29.486997 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EB4053B110>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EB4058BBD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EB4058BB50>]}


============================== 16:12:29.494975 | 61ab77a9-3806-4a0e-820a-a32f57683fc8 ==============================
[0m16:12:29.494975 [info ] [MainThread]: Running with dbt=1.7.17
[0m16:12:29.497969 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'debug': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --models Tactical_clicks_months_12.sql', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m16:12:29.673498 [error] [MainThread]: Encountered an error:
Runtime Error
  at path []: Additional properties are not allowed ('prod_in_site_dev', 'site_dev' were unexpected)

Error encountered in E:\Kasper_Sindri_Media\dbt_project.yml
[0m16:12:29.676491 [debug] [MainThread]: Command `dbt run` failed at 16:12:29.676491 after 0.28 seconds
[0m16:12:29.677488 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EB39A41510>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EB39A41750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EB40532590>]}
[0m16:12:29.678486 [debug] [MainThread]: Flushing usage events
[0m16:14:37.472311 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001675F033490>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001675F08A650>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001675F032FD0>]}


============================== 16:14:37.479295 | 610f2cb1-9021-4f4e-b54c-400ef50e02c3 ==============================
[0m16:14:37.479295 [info ] [MainThread]: Running with dbt=1.7.17
[0m16:14:37.481288 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'invocation_command': 'dbt run --models Tactical_clicks_months_12.sql', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:14:37.662836 [error] [MainThread]: Encountered an error:
Runtime Error
  at path []: Additional properties are not allowed ('site_dev' was unexpected)

Error encountered in E:\Kasper_Sindri_Media\dbt_project.yml
[0m16:14:37.665830 [debug] [MainThread]: Command `dbt run` failed at 16:14:37.664833 after 0.32 seconds
[0m16:14:37.666826 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001675F038510>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001675F038CD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001675C53EF90>]}
[0m16:14:37.667823 [debug] [MainThread]: Flushing usage events
[0m16:15:04.469268 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D40429190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D4046B990>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D4046A810>]}


============================== 16:15:04.480240 | d8a5d08d-4fdc-4da5-94c5-87071e6c1705 ==============================
[0m16:15:04.480240 [info ] [MainThread]: Running with dbt=1.7.17
[0m16:15:04.482238 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models Tactical_clicks_months_12.sql', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:15:04.938016 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd8a5d08d-4fdc-4da5-94c5-87071e6c1705', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D3FF0C8D0>]}
[0m16:15:05.107561 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd8a5d08d-4fdc-4da5-94c5-87071e6c1705', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D4044E410>]}
[0m16:15:05.109556 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m16:15:05.134490 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m16:15:05.161419 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m16:15:05.162414 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'd8a5d08d-4fdc-4da5-94c5-87071e6c1705', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D406EB790>]}
[0m16:15:06.994513 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example
[0m16:15:07.002492 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd8a5d08d-4fdc-4da5-94c5-87071e6c1705', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D406C2D10>]}
[0m16:15:07.023438 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd8a5d08d-4fdc-4da5-94c5-87071e6c1705', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D408AE210>]}
[0m16:15:07.024436 [info ] [MainThread]: Found 15 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m16:15:07.025434 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd8a5d08d-4fdc-4da5-94c5-87071e6c1705', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D3C03FA90>]}
[0m16:15:07.028423 [info ] [MainThread]: 
[0m16:15:07.030418 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m16:15:07.032412 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m16:15:07.046375 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m16:15:07.047374 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m16:15:07.048371 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:15:08.574828 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m16:15:08.580814 [debug] [ThreadPool]: On list_schemas: Close
[0m16:15:08.586407 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m16:15:08.590396 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m16:15:08.603359 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m16:15:08.604358 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m16:15:08.605355 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:15:10.142679 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m16:15:10.144675 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m16:15:10.145673 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m16:15:10.728720 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m16:15:10.733739 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m16:15:10.735731 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m16:15:10.737723 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m16:15:11.314120 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m16:15:11.317138 [debug] [ThreadPool]: On create__site_dev: Close
[0m16:15:11.329115 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m16:15:11.344065 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m16:15:11.345062 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m16:15:11.346060 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:15:12.876850 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m16:15:12.878845 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m16:15:12.881836 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m16:15:13.459968 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m16:15:13.462965 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m16:15:13.655536 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m16:15:13.657534 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd8a5d08d-4fdc-4da5-94c5-87071e6c1705', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D40722A50>]}
[0m16:15:13.658534 [debug] [MainThread]: Using mysql connection "master"
[0m16:15:13.659529 [debug] [MainThread]: On master: BEGIN
[0m16:15:13.659529 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:15:15.226325 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m16:15:15.228320 [debug] [MainThread]: On master: COMMIT
[0m16:15:15.229316 [debug] [MainThread]: Using mysql connection "master"
[0m16:15:15.230314 [debug] [MainThread]: On master: COMMIT
[0m16:15:15.818196 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m16:15:15.821184 [debug] [MainThread]: On master: Close
[0m16:15:15.827169 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m16:15:15.829161 [info ] [MainThread]: 
[0m16:15:15.838372 [debug] [Thread-1 (]: Began running node model.site_dev.Tactical_clicks_months_12
[0m16:15:15.840367 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.Tactical_clicks_months_12 ................. [RUN]
[0m16:15:15.841364 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.site_dev.Tactical_clicks_months_12'
[0m16:15:15.842361 [debug] [Thread-1 (]: Began compiling node model.site_dev.Tactical_clicks_months_12
[0m16:15:15.861309 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.Tactical_clicks_months_12"
[0m16:15:15.864301 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_clicks_months_12 (compile): 16:15:15.843359 => 16:15:15.863303
[0m16:15:15.865299 [debug] [Thread-1 (]: Began executing node model.site_dev.Tactical_clicks_months_12
[0m16:15:15.932120 [debug] [Thread-1 (]: Writing runtime sql for node "model.site_dev.Tactical_clicks_months_12"
[0m16:15:15.934114 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_clicks_months_12"
[0m16:15:15.935112 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: BEGIN
[0m16:15:15.937107 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m16:15:17.474117 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m16:15:17.477101 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_clicks_months_12"
[0m16:15:17.481090 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "node_id": "model.site_dev.Tactical_clicks_months_12"} */

  create view `site_dev`.`Tactical_clicks_months_12__dbt_tmp`
    
    
  as (
    







DELIMITER //
CREATE PROCEDURE `Tactical_clicks_months_12_dbt_test`()
BEGIN
    WITH curr_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND categories <> "Nyhedsoverblik"
        AND siteid = '12'
    ),
    agg_curr_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks
        FROM prod.events e
        JOIN curr_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND e.siteid = '12'
        AND e.Event_Action = 'Next Click'
        GROUP BY 1
    ),
    agg_curr_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum
        FROM prod.pages p
        LEFT JOIN curr_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = '12'
        AND p.date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        GROUP BY p.siteid
    ),
    value_curr_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks / p.pageview_sum * 100, 2) AS value
        FROM agg_curr_30_days_events e
        LEFT JOIN agg_curr_30_days_pages p ON e.siteid = p.siteid
    ),
    last_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        AND siteid = site
        AND categories <> "Nyhedsoverblik"
    ),
    agg_last_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks_last
        FROM prod.events e
        JOIN last_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        AND e.siteid = '12'
        AND e.Event_Action = 'Next Click'
        GROUP BY 1
    ),
    agg_last_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum_last
        FROM prod.pages p
        LEFT JOIN last_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = '12'
        AND p.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        GROUP BY p.siteid
    ),
    value_last_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks_last / p.pageview_sum_last * 100, 2) AS value_last
        FROM agg_last_30_days_events e
        LEFT JOIN agg_last_30_days_pages p ON e.siteid = p.siteid
    )
    SELECT 
        JSON_OBJECT(
            'site', al.siteid,
            'data', JSON_OBJECT(
            'label', 'Artikler',
            'hint', 'Artikler publiceret seneste 30 dage ift. forrige 30 dage',
            'value', COALESCE(value, 0),
            'change', COALESCE(value - value_last, 0),
            'progressCurrent', '',
            'progressTotal', ''
            )
        ) AS json_data
    FROM value_curr_30_days al
    LEFT JOIN value_last_30_days alb ON al.siteid = alb.siteid
    WHERE al.siteid = '12';
END;
DELIMITER ;
  );
[0m16:15:18.305745 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'DELIMITER //
CREATE PROCEDURE `Tactical_clicks_months_12_dbt_test`()
BEGIN
    W' at line 15
[0m16:15:18.309718 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: ROLLBACK
[0m16:15:18.506732 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_clicks_months_12 (execute): 16:15:15.865299 => 16:15:18.503741
[0m16:15:18.512713 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: Close
[0m16:15:18.541637 [debug] [Thread-1 (]: Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'DELIMITER //
  CREATE PROCEDURE `Tactical_clicks_months_12_dbt_test`()
  BEGIN
      W' at line 15
  compiled Code at target\run\site_dev\models\example\Tactical_clicks_months_12.sql
[0m16:15:18.543633 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd8a5d08d-4fdc-4da5-94c5-87071e6c1705', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D408F1ED0>]}
[0m16:15:18.545627 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.Tactical_clicks_months_12 ........ [[31mERROR[0m in 2.70s]
[0m16:15:18.547618 [debug] [Thread-1 (]: Finished running node model.site_dev.Tactical_clicks_months_12
[0m16:15:18.553603 [debug] [MainThread]: Using mysql connection "master"
[0m16:15:18.555608 [debug] [MainThread]: On master: BEGIN
[0m16:15:18.556597 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m16:15:35.455584 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000296632FBC90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000296632FA710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000296632FA990>]}


============================== 16:15:35.461567 | 92aae461-3f2f-42cf-8286-292fc65a5ee8 ==============================
[0m16:15:35.461567 [info ] [MainThread]: Running with dbt=1.7.17
[0m16:15:35.463563 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --models Tactical_clicks_months_12.sql', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:15:35.753985 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '92aae461-3f2f-42cf-8286-292fc65a5ee8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000296634DFCD0>]}
[0m16:15:35.838761 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '92aae461-3f2f-42cf-8286-292fc65a5ee8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000296632DE2D0>]}
[0m16:15:35.840753 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m16:15:35.852721 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m16:15:35.874901 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m16:15:35.875899 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '92aae461-3f2f-42cf-8286-292fc65a5ee8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000296632FB350>]}
[0m16:15:38.601609 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example
[0m16:15:38.613577 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '92aae461-3f2f-42cf-8286-292fc65a5ee8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000296637EDA90>]}
[0m16:15:38.641502 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '92aae461-3f2f-42cf-8286-292fc65a5ee8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029663757150>]}
[0m16:15:38.643497 [info ] [MainThread]: Found 15 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m16:15:38.644494 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '92aae461-3f2f-42cf-8286-292fc65a5ee8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000296632EE890>]}
[0m16:15:38.647485 [info ] [MainThread]: 
[0m16:15:38.650476 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m16:15:38.654467 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m16:15:38.674411 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m16:15:38.675412 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m16:15:38.676408 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:15:40.252765 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m16:15:40.255758 [debug] [ThreadPool]: On list_schemas: Close
[0m16:15:40.258748 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m16:15:40.259749 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m16:15:40.271713 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m16:15:40.273708 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m16:15:40.273708 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:15:41.892006 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m16:15:41.893006 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m16:15:41.894008 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m16:15:42.530056 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m16:15:42.534039 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m16:15:42.535035 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m16:15:42.535035 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m16:15:43.120940 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m16:15:43.124960 [debug] [ThreadPool]: On create__site_dev: Close
[0m16:15:43.129501 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m16:15:43.137482 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m16:15:43.138481 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m16:15:43.139477 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:15:44.738763 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m16:15:44.741763 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m16:15:44.743774 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m16:15:45.351804 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m16:15:45.358789 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m16:15:45.562008 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m16:15:45.567021 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '92aae461-3f2f-42cf-8286-292fc65a5ee8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000296637A03D0>]}
[0m16:15:45.569013 [debug] [MainThread]: Using mysql connection "master"
[0m16:15:45.571007 [debug] [MainThread]: On master: BEGIN
[0m16:15:45.573001 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:15:47.185577 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m16:15:47.188576 [debug] [MainThread]: On master: COMMIT
[0m16:15:47.192562 [debug] [MainThread]: Using mysql connection "master"
[0m16:15:47.195548 [debug] [MainThread]: On master: COMMIT
[0m16:15:47.831181 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m16:15:47.833173 [debug] [MainThread]: On master: Close
[0m16:15:47.835169 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m16:15:47.837161 [info ] [MainThread]: 
[0m16:15:47.843840 [debug] [Thread-1 (]: Began running node model.site_dev.Tactical_clicks_months_12
[0m16:15:47.844842 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.Tactical_clicks_months_12 ................. [RUN]
[0m16:15:47.846836 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.site_dev.Tactical_clicks_months_12'
[0m16:15:47.847832 [debug] [Thread-1 (]: Began compiling node model.site_dev.Tactical_clicks_months_12
[0m16:15:47.887726 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.Tactical_clicks_months_12"
[0m16:15:47.895705 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_clicks_months_12 (compile): 16:15:47.848832 => 16:15:47.894707
[0m16:15:47.896702 [debug] [Thread-1 (]: Began executing node model.site_dev.Tactical_clicks_months_12
[0m16:15:47.945572 [debug] [Thread-1 (]: Writing runtime sql for node "model.site_dev.Tactical_clicks_months_12"
[0m16:15:47.946571 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_clicks_months_12"
[0m16:15:47.947567 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: BEGIN
[0m16:15:47.948564 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m16:15:49.528068 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m16:15:49.530064 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_clicks_months_12"
[0m16:15:49.532060 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "node_id": "model.site_dev.Tactical_clicks_months_12"} */

  create view `site_dev`.`Tactical_clicks_months_12__dbt_tmp`
    
    
  as (
    







DELIMITER //
CREATE PROCEDURE `Tactical_clicks_months_12_dbt_test`()
BEGIN
    WITH curr_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND categories <> "Nyhedsoverblik"
        AND siteid = '12'
    ),
    agg_curr_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks
        FROM prod.events e
        JOIN curr_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND e.siteid = '12'
        AND e.Event_Action = 'Next Click'
        GROUP BY 1
    ),
    agg_curr_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum
        FROM prod.pages p
        LEFT JOIN curr_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = '12'
        AND p.date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        GROUP BY p.siteid
    ),
    value_curr_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks / p.pageview_sum * 100, 2) AS value
        FROM agg_curr_30_days_events e
        LEFT JOIN agg_curr_30_days_pages p ON e.siteid = p.siteid
    ),
    last_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        AND siteid = site
        AND categories <> "Nyhedsoverblik"
    ),
    agg_last_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks_last
        FROM prod.events e
        JOIN last_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        AND e.siteid = '12'
        AND e.Event_Action = 'Next Click'
        GROUP BY 1
    ),
    agg_last_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum_last
        FROM prod.pages p
        LEFT JOIN last_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = '12'
        AND p.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        GROUP BY p.siteid
    ),
    value_last_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks_last / p.pageview_sum_last * 100, 2) AS value_last
        FROM agg_last_30_days_events e
        LEFT JOIN agg_last_30_days_pages p ON e.siteid = p.siteid
    )
    SELECT 
        JSON_OBJECT(
            'site', al.siteid,
            'data', JSON_OBJECT(
            'label', 'Artikler',
            'hint', 'Artikler publiceret seneste 30 dage ift. forrige 30 dage',
            'value', COALESCE(value, 0),
            'change', COALESCE(value - value_last, 0),
            'progressCurrent', '',
            'progressTotal', ''
            )
        ) AS json_data
    FROM value_curr_30_days al
    LEFT JOIN value_last_30_days alb ON al.siteid = alb.siteid
    WHERE al.siteid = '12';
END;
DELIMITER ;
  );
[0m16:15:50.124764 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'DELIMITER //
CREATE PROCEDURE `Tactical_clicks_months_12_dbt_test`()
BEGIN
    W' at line 15
[0m16:15:50.126758 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: ROLLBACK
[0m16:15:50.343180 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_clicks_months_12 (execute): 16:15:47.897701 => 16:15:50.342181
[0m16:15:50.344177 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: Close
[0m16:15:50.362130 [debug] [Thread-1 (]: Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'DELIMITER //
  CREATE PROCEDURE `Tactical_clicks_months_12_dbt_test`()
  BEGIN
      W' at line 15
  compiled Code at target\run\site_dev\models\example\Tactical_clicks_months_12.sql
[0m16:15:50.364124 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '92aae461-3f2f-42cf-8286-292fc65a5ee8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000296638071D0>]}
[0m16:15:50.366119 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.Tactical_clicks_months_12 ........ [[31mERROR[0m in 2.52s]
[0m16:15:50.369112 [debug] [Thread-1 (]: Finished running node model.site_dev.Tactical_clicks_months_12
[0m16:15:50.375096 [debug] [MainThread]: Using mysql connection "master"
[0m16:15:50.377090 [debug] [MainThread]: On master: BEGIN
[0m16:15:50.378087 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m16:15:51.965838 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m16:15:51.966836 [debug] [MainThread]: On master: COMMIT
[0m16:15:51.969828 [debug] [MainThread]: Using mysql connection "master"
[0m16:15:51.970826 [debug] [MainThread]: On master: COMMIT
[0m16:15:52.542701 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m16:15:52.543708 [debug] [MainThread]: On master: Close
[0m16:15:52.545692 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:15:52.547686 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m16:15:52.548686 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m16:15:52.550678 [debug] [MainThread]: Connection 'model.site_dev.Tactical_clicks_months_12' was properly closed.
[0m16:15:52.552674 [info ] [MainThread]: 
[0m16:15:52.553669 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 13.90 seconds (13.90s).
[0m16:15:52.554668 [debug] [MainThread]: Command end result
[0m16:15:52.577606 [info ] [MainThread]: 
[0m16:15:52.578604 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m16:15:52.579602 [info ] [MainThread]: 
[0m16:15:52.581596 [error] [MainThread]:   Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'DELIMITER //
  CREATE PROCEDURE `Tactical_clicks_months_12_dbt_test`()
  BEGIN
      W' at line 15
  compiled Code at target\run\site_dev\models\example\Tactical_clicks_months_12.sql
[0m16:15:52.582593 [info ] [MainThread]: 
[0m16:15:52.584588 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m16:15:52.588577 [debug] [MainThread]: Command `dbt run` failed at 16:15:52.587579 after 17.23 seconds
[0m16:15:52.590572 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002965C801790>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002965C801510>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000296634679D0>]}
[0m16:15:52.591569 [debug] [MainThread]: Flushing usage events
[0m16:17:38.475184 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F8F000AD10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F8EFAFCA10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F8F005B990>]}


============================== 16:17:38.483191 | fd61c581-2f7f-4835-a999-bf4af2d50da5 ==============================
[0m16:17:38.483191 [info ] [MainThread]: Running with dbt=1.7.17
[0m16:17:38.486156 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'debug': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --models Tactical_clicks_months_12.sql', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m16:17:38.803797 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'fd61c581-2f7f-4835-a999-bf4af2d50da5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F8F0209350>]}
[0m16:17:38.893555 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'fd61c581-2f7f-4835-a999-bf4af2d50da5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F8F001DE90>]}
[0m16:17:38.895864 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m16:17:38.908833 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m16:17:39.021537 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m16:17:39.022528 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m16:17:39.024523 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example
[0m16:17:39.034496 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'fd61c581-2f7f-4835-a999-bf4af2d50da5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F8F03DC890>]}
[0m16:17:39.055443 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'fd61c581-2f7f-4835-a999-bf4af2d50da5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F8F0337DD0>]}
[0m16:17:39.057435 [info ] [MainThread]: Found 15 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m16:17:39.059430 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fd61c581-2f7f-4835-a999-bf4af2d50da5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F8F0000550>]}
[0m16:17:39.063419 [info ] [MainThread]: 
[0m16:17:39.064422 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m16:17:39.067408 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m16:17:39.084364 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m16:17:39.085360 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m16:17:39.086361 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:17:40.695705 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m16:17:40.699695 [debug] [ThreadPool]: On list_schemas: Close
[0m16:17:40.703685 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m16:17:40.705680 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m16:17:40.713657 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m16:17:40.714654 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m16:17:40.715653 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:17:42.423585 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m16:17:42.425587 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m16:17:42.426585 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m16:17:43.020820 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m16:17:43.022819 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m16:17:43.023815 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m16:17:43.025811 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m16:17:43.612872 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m16:17:43.613869 [debug] [ThreadPool]: On create__site_dev: Close
[0m16:17:43.618854 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m16:17:43.631822 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m16:17:43.632819 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m16:17:43.633817 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:17:45.178379 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m16:17:45.181384 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m16:17:45.184376 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m16:17:45.802061 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m16:17:45.804058 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m16:17:45.996542 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m16:17:45.999533 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fd61c581-2f7f-4835-a999-bf4af2d50da5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F8F0277C10>]}
[0m16:17:46.000532 [debug] [MainThread]: Using mysql connection "master"
[0m16:17:46.002527 [debug] [MainThread]: On master: BEGIN
[0m16:17:46.003524 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:17:47.536544 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m16:17:47.538539 [debug] [MainThread]: On master: COMMIT
[0m16:17:47.540534 [debug] [MainThread]: Using mysql connection "master"
[0m16:17:47.542529 [debug] [MainThread]: On master: COMMIT
[0m16:17:48.122632 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m16:17:48.125622 [debug] [MainThread]: On master: Close
[0m16:17:48.131614 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m16:17:48.134602 [info ] [MainThread]: 
[0m16:17:48.145714 [debug] [Thread-1 (]: Began running node model.site_dev.Tactical_clicks_months_12
[0m16:17:48.147731 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.Tactical_clicks_months_12 ................. [RUN]
[0m16:17:48.149725 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.site_dev.Tactical_clicks_months_12'
[0m16:17:48.151721 [debug] [Thread-1 (]: Began compiling node model.site_dev.Tactical_clicks_months_12
[0m16:17:48.168674 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.Tactical_clicks_months_12"
[0m16:17:48.170671 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_clicks_months_12 (compile): 16:17:48.151721 => 16:17:48.169671
[0m16:17:48.172664 [debug] [Thread-1 (]: Began executing node model.site_dev.Tactical_clicks_months_12
[0m16:17:48.230509 [debug] [Thread-1 (]: Writing runtime sql for node "model.site_dev.Tactical_clicks_months_12"
[0m16:17:48.232505 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_clicks_months_12"
[0m16:17:48.233502 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: BEGIN
[0m16:17:48.234501 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m16:17:49.853274 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m16:17:49.857261 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_clicks_months_12"
[0m16:17:49.863246 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "node_id": "model.site_dev.Tactical_clicks_months_12"} */

  create view `site_dev`.`Tactical_clicks_months_12__dbt_tmp`
    
    
  as (
    







DELIMITER //
CREATE PROCEDURE `Tactical_clicks_months_12_dbt_test`()
BEGIN
    WITH curr_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND categories <> "Nyhedsoverblik"
        AND siteid = '12'
    ),
    agg_curr_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks
        FROM prod.events e
        JOIN curr_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND e.siteid = '12'
        AND e.Event_Action = 'Next Click'
        GROUP BY 1
    ),
    agg_curr_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum
        FROM prod.pages p
        LEFT JOIN curr_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = '12'
        AND p.date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        GROUP BY p.siteid
    ),
    value_curr_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks / p.pageview_sum * 100, 2) AS value
        FROM agg_curr_30_days_events e
        LEFT JOIN agg_curr_30_days_pages p ON e.siteid = p.siteid
    ),
    last_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        AND siteid = site
        AND categories <> "Nyhedsoverblik"
    ),
    agg_last_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks_last
        FROM prod.events e
        JOIN last_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        AND e.siteid = '12'
        AND e.Event_Action = 'Next Click'
        GROUP BY 1
    ),
    agg_last_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum_last
        FROM prod.pages p
        LEFT JOIN last_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = '12'
        AND p.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        GROUP BY p.siteid
    ),
    value_last_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks_last / p.pageview_sum_last * 100, 2) AS value_last
        FROM agg_last_30_days_events e
        LEFT JOIN agg_last_30_days_pages p ON e.siteid = p.siteid
    )
    SELECT 
        JSON_OBJECT(
            'site', al.siteid,
            'data', JSON_OBJECT(
            'label', 'Artikler',
            'hint', 'Artikler publiceret seneste 30 dage ift. forrige 30 dage',
            'value', COALESCE(value, 0),
            'change', COALESCE(value - value_last, 0),
            'progressCurrent', '',
            'progressTotal', ''
            )
        ) AS json_data
    FROM value_curr_30_days al
    LEFT JOIN value_last_30_days alb ON al.siteid = alb.siteid
    WHERE al.siteid = '12';
END;
DELIMITER ;
  );
[0m16:17:50.713086 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'DELIMITER //
CREATE PROCEDURE `Tactical_clicks_months_12_dbt_test`()
BEGIN
    W' at line 15
[0m16:17:50.714085 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: ROLLBACK
[0m16:17:50.917137 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_clicks_months_12 (execute): 16:17:48.173661 => 16:17:50.915146
[0m16:17:50.920128 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: Close
[0m16:17:50.939073 [debug] [Thread-1 (]: Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'DELIMITER //
  CREATE PROCEDURE `Tactical_clicks_months_12_dbt_test`()
  BEGIN
      W' at line 15
  compiled Code at target\run\site_dev\models\example\Tactical_clicks_months_12.sql
[0m16:17:50.940071 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fd61c581-2f7f-4835-a999-bf4af2d50da5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F8F04D4150>]}
[0m16:17:50.942065 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.Tactical_clicks_months_12 ........ [[31mERROR[0m in 2.79s]
[0m16:17:50.944061 [debug] [Thread-1 (]: Finished running node model.site_dev.Tactical_clicks_months_12
[0m16:17:50.947052 [debug] [MainThread]: Using mysql connection "master"
[0m16:17:50.948049 [debug] [MainThread]: On master: BEGIN
[0m16:17:50.949047 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m16:17:52.573660 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m16:17:52.576665 [debug] [MainThread]: On master: COMMIT
[0m16:17:52.579654 [debug] [MainThread]: Using mysql connection "master"
[0m16:17:52.581651 [debug] [MainThread]: On master: COMMIT
[0m16:17:53.229682 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m16:17:53.232666 [debug] [MainThread]: On master: Close
[0m16:17:53.235661 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:17:53.236653 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m16:17:53.236653 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m16:17:53.237651 [debug] [MainThread]: Connection 'model.site_dev.Tactical_clicks_months_12' was properly closed.
[0m16:17:53.238648 [info ] [MainThread]: 
[0m16:17:53.239646 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 14.17 seconds (14.17s).
[0m16:17:53.240644 [debug] [MainThread]: Command end result
[0m16:17:53.255609 [info ] [MainThread]: 
[0m16:17:53.256602 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m16:17:53.257600 [info ] [MainThread]: 
[0m16:17:53.258596 [error] [MainThread]:   Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'DELIMITER //
  CREATE PROCEDURE `Tactical_clicks_months_12_dbt_test`()
  BEGIN
      W' at line 15
  compiled Code at target\run\site_dev\models\example\Tactical_clicks_months_12.sql
[0m16:17:53.259594 [info ] [MainThread]: 
[0m16:17:53.260592 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m16:17:53.262585 [debug] [MainThread]: Command `dbt run` failed at 16:17:53.262585 after 14.88 seconds
[0m16:17:53.263581 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F8E9511750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F8E9511850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F8F0002610>]}
[0m16:17:53.264579 [debug] [MainThread]: Flushing usage events
[0m16:18:38.628245 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023B1DFB8A10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023B1DFFE690>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023B1DC119D0>]}


============================== 16:18:38.633232 | ee201466-ab4f-4c4a-a25f-00a20ef27a63 ==============================
[0m16:18:38.633232 [info ] [MainThread]: Running with dbt=1.7.17
[0m16:18:38.635227 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models Tactical_clicks_months_12.sql', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:18:38.912130 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ee201466-ab4f-4c4a-a25f-00a20ef27a63', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023B1E1B9B90>]}
[0m16:18:39.023829 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ee201466-ab4f-4c4a-a25f-00a20ef27a63', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023B1DFC9FD0>]}
[0m16:18:39.025825 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m16:18:39.037792 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m16:18:39.048764 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m16:18:39.051762 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'ee201466-ab4f-4c4a-a25f-00a20ef27a63', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023B1E396990>]}
[0m16:18:40.790105 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example
[0m16:18:40.799081 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ee201466-ab4f-4c4a-a25f-00a20ef27a63', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023B1E1A0210>]}
[0m16:18:40.818029 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ee201466-ab4f-4c4a-a25f-00a20ef27a63', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023B1E2B26D0>]}
[0m16:18:40.819029 [info ] [MainThread]: Found 15 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m16:18:40.820026 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ee201466-ab4f-4c4a-a25f-00a20ef27a63', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023B1E18A6D0>]}
[0m16:18:40.823017 [info ] [MainThread]: 
[0m16:18:40.825011 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m16:18:40.827005 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m16:18:40.840970 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m16:18:40.841966 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m16:18:40.841966 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:18:42.657056 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m16:18:42.662037 [debug] [ThreadPool]: On list_schemas: Close
[0m16:18:42.664032 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__prod)
[0m16:18:42.666027 [debug] [ThreadPool]: Creating schema "schema: "prod"
"
[0m16:18:42.672010 [debug] [ThreadPool]: Using mysql connection "create__prod"
[0m16:18:42.673008 [debug] [ThreadPool]: On create__prod: BEGIN
[0m16:18:42.674006 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:18:44.259267 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m16:18:44.262287 [debug] [ThreadPool]: Using mysql connection "create__prod"
[0m16:18:44.264283 [debug] [ThreadPool]: On create__prod: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "create__prod"} */
create schema if not exists `prod`
[0m16:18:44.869727 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m16:18:44.874706 [debug] [ThreadPool]: On create__prod: COMMIT
[0m16:18:44.875704 [debug] [ThreadPool]: Using mysql connection "create__prod"
[0m16:18:44.875704 [debug] [ThreadPool]: On create__prod: COMMIT
[0m16:18:45.469674 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m16:18:45.487624 [debug] [ThreadPool]: On create__prod: Close
[0m16:18:45.492611 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_prod'
[0m16:18:45.505578 [debug] [ThreadPool]: Using mysql connection "list_None_prod"
[0m16:18:45.507586 [debug] [ThreadPool]: On list_None_prod: BEGIN
[0m16:18:45.508569 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:18:47.080341 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m16:18:47.083343 [debug] [ThreadPool]: Using mysql connection "list_None_prod"
[0m16:18:47.085336 [debug] [ThreadPool]: On list_None_prod: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_None_prod"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'prod'
  
[0m16:18:47.692660 [debug] [ThreadPool]: SQL status: SUCCESS 144 in 1.0 seconds
[0m16:18:47.700640 [debug] [ThreadPool]: On list_None_prod: ROLLBACK
[0m16:18:47.899280 [debug] [ThreadPool]: On list_None_prod: Close
[0m16:18:47.906273 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:18:47.908264 [debug] [MainThread]: Connection 'create__prod' was properly closed.
[0m16:18:47.910262 [debug] [MainThread]: Connection 'list_None_prod' was properly closed.
[0m16:18:47.913251 [info ] [MainThread]: 
[0m16:18:47.917246 [info ] [MainThread]: Finished running  in 0 hours 0 minutes and 7.09 seconds (7.09s).
[0m16:18:47.921232 [error] [MainThread]: Encountered an error:
Field "type" of type Optional[RelationType] in MySQLRelation has invalid value "bytearray(b'view')"
[0m16:18:48.071293 [error] [MainThread]: Traceback (most recent call last):
  File "<string>", line 17, in __mashumaro_from_dict__
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\dataclass_schema.py", line 156, in _deserialize
    return cls(value)
           ^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\enum.py", line 695, in __call__
    return cls.__new__(cls, value)
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\enum.py", line 1111, in __new__
    raise ve_exc
ValueError: "bytearray(b'view')" is not a valid RelationType

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 91, in wrapper
    result, success = func(*args, **kwargs)
                      ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 76, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 169, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 198, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 245, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 278, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\main.py", line 626, in run
    results = task.run()
              ^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 502, in run
    result = self.execute_with_hooks(selected_uids)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 462, in execute_with_hooks
    self.before_run(adapter, selected_uids)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\run.py", line 451, in before_run
    self.populate_adapter_cache(adapter, required_schemas)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 440, in populate_adapter_cache
    adapter.set_relations_cache(self.manifest)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\impl.py", line 519, in set_relations_cache
    self._relations_cache_for_schemas(manifest, required_schemas)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\impl.py", line 495, in _relations_cache_for_schemas
    for relation in future.result():
                    ^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\_base.py", line 401, in __get_result
    raise self._exception
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\thread.py", line 58, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\utils.py", line 471, in connected
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\mysql\impl.py", line 82, in list_relations_without_caching
    relation = self.Relation.create(schema=_schema, identifier=name, type=relation_type)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\relation.py", line 299, in create
    return cls.from_dict(kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 19, in __mashumaro_from_dict__
mashumaro.exceptions.InvalidFieldValue: Field "type" of type Optional[RelationType] in MySQLRelation has invalid value "bytearray(b'view')"

[0m16:18:48.074285 [debug] [MainThread]: Command `dbt run` failed at 16:18:48.074285 after 9.54 seconds
[0m16:18:48.075282 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023B1E00BC90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023B1E007DD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023B1E007C90>]}
[0m16:18:48.076281 [debug] [MainThread]: Flushing usage events
[0m16:20:23.137021 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CA77271810>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CA772CA810>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CA772CB990>]}


============================== 16:20:23.145997 | 54a4b14c-3062-41f3-b33c-d2c13b076ccd ==============================
[0m16:20:23.145997 [info ] [MainThread]: Running with dbt=1.7.17
[0m16:20:23.147998 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'debug': 'False', 'version_check': 'True', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run --models Tactical_clicks_months_12.sql', 'send_anonymous_usage_stats': 'True'}
[0m16:20:23.417029 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '54a4b14c-3062-41f3-b33c-d2c13b076ccd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CA77446A50>]}
[0m16:20:23.498878 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '54a4b14c-3062-41f3-b33c-d2c13b076ccd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CA774C3D10>]}
[0m16:20:23.500875 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m16:20:23.512869 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m16:20:23.535780 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m16:20:23.536779 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '54a4b14c-3062-41f3-b33c-d2c13b076ccd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CA77653110>]}
[0m16:20:25.203318 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example
[0m16:20:25.214291 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '54a4b14c-3062-41f3-b33c-d2c13b076ccd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CA776F05D0>]}
[0m16:20:25.237230 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '54a4b14c-3062-41f3-b33c-d2c13b076ccd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CA77801110>]}
[0m16:20:25.238227 [info ] [MainThread]: Found 15 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m16:20:25.239225 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '54a4b14c-3062-41f3-b33c-d2c13b076ccd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CA772F2810>]}
[0m16:20:25.242216 [info ] [MainThread]: 
[0m16:20:25.243215 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m16:20:25.246205 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m16:20:25.259170 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m16:20:25.260169 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m16:20:25.261166 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:20:26.807319 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m16:20:26.812342 [debug] [ThreadPool]: On list_schemas: Close
[0m16:20:26.814321 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m16:20:26.815310 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m16:20:26.822278 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m16:20:26.823295 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m16:20:26.824273 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:20:28.388507 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m16:20:28.391511 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m16:20:28.393501 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m16:20:28.983991 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m16:20:28.989981 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m16:20:28.990979 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m16:20:28.991976 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m16:20:29.574747 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m16:20:29.575755 [debug] [ThreadPool]: On create__site_dev: Close
[0m16:20:29.580336 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m16:20:29.587317 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m16:20:29.588314 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m16:20:29.589313 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:20:31.299523 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m16:20:31.301513 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m16:20:31.303510 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m16:20:31.879695 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m16:20:31.884680 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m16:20:32.084456 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m16:20:32.088773 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '54a4b14c-3062-41f3-b33c-d2c13b076ccd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CA7749CA50>]}
[0m16:20:32.089777 [debug] [MainThread]: Using mysql connection "master"
[0m16:20:32.090771 [debug] [MainThread]: On master: BEGIN
[0m16:20:32.090771 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:20:33.691188 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m16:20:33.694212 [debug] [MainThread]: On master: COMMIT
[0m16:20:33.696204 [debug] [MainThread]: Using mysql connection "master"
[0m16:20:33.698217 [debug] [MainThread]: On master: COMMIT
[0m16:20:34.275656 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m16:20:34.278485 [debug] [MainThread]: On master: Close
[0m16:20:34.280476 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m16:20:34.281471 [info ] [MainThread]: 
[0m16:20:34.287448 [debug] [Thread-1 (]: Began running node model.site_dev.Tactical_clicks_months_12
[0m16:20:34.288459 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.Tactical_clicks_months_12 ................. [RUN]
[0m16:20:34.289444 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.site_dev.Tactical_clicks_months_12'
[0m16:20:34.290443 [debug] [Thread-1 (]: Began compiling node model.site_dev.Tactical_clicks_months_12
[0m16:20:34.309392 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.Tactical_clicks_months_12"
[0m16:20:34.311388 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_clicks_months_12 (compile): 16:20:34.291441 => 16:20:34.310390
[0m16:20:34.312384 [debug] [Thread-1 (]: Began executing node model.site_dev.Tactical_clicks_months_12
[0m16:20:34.359259 [debug] [Thread-1 (]: Writing runtime sql for node "model.site_dev.Tactical_clicks_months_12"
[0m16:20:34.361253 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_clicks_months_12"
[0m16:20:34.362250 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: BEGIN
[0m16:20:34.363248 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m16:20:35.946424 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m16:20:35.948416 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_clicks_months_12"
[0m16:20:35.951408 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "node_id": "model.site_dev.Tactical_clicks_months_12"} */

  create view `site_dev`.`Tactical_clicks_months_12__dbt_tmp`
    
    
  as (
    







DELIMITER //
CREATE PROCEDURE `Tactical_clicks_months_12_dbt_test`()
BEGIN
    WITH curr_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND categories <> "Nyhedsoverblik"
        AND siteid = '12'
    ),
    agg_curr_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks
        FROM prod.events e
        JOIN curr_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND e.siteid = '12'
        AND e.Event_Action = 'Next Click'
        GROUP BY 1
    ),
    agg_curr_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum
        FROM prod.pages p
        LEFT JOIN curr_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = '12'
        AND p.date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        GROUP BY p.siteid
    ),
    value_curr_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks / p.pageview_sum * 100, 2) AS value
        FROM agg_curr_30_days_events e
        LEFT JOIN agg_curr_30_days_pages p ON e.siteid = p.siteid
    ),
    last_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        AND siteid = site
        AND categories <> "Nyhedsoverblik"
    ),
    agg_last_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks_last
        FROM prod.events e
        JOIN last_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        AND e.siteid = '12'
        AND e.Event_Action = 'Next Click'
        GROUP BY 1
    ),
    agg_last_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum_last
        FROM prod.pages p
        LEFT JOIN last_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = '12'
        AND p.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        GROUP BY p.siteid
    ),
    value_last_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks_last / p.pageview_sum_last * 100, 2) AS value_last
        FROM agg_last_30_days_events e
        LEFT JOIN agg_last_30_days_pages p ON e.siteid = p.siteid
    )
    SELECT 
        JSON_OBJECT(
            'site', al.siteid,
            'data', JSON_OBJECT(
            'label', 'Artikler',
            'hint', 'Artikler publiceret seneste 30 dage ift. forrige 30 dage',
            'value', COALESCE(value, 0),
            'change', COALESCE(value - value_last, 0),
            'progressCurrent', '',
            'progressTotal', ''
            )
        ) AS json_data
    FROM value_curr_30_days al
    LEFT JOIN value_last_30_days alb ON al.siteid = alb.siteid
    WHERE al.siteid = '12';
END;
DELIMITER ;
  );
[0m16:20:36.548769 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'DELIMITER //
CREATE PROCEDURE `Tactical_clicks_months_12_dbt_test`()
BEGIN
    W' at line 15
[0m16:20:36.550769 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: ROLLBACK
[0m16:20:36.752070 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_clicks_months_12 (execute): 16:20:34.312384 => 16:20:36.751076
[0m16:20:36.754064 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: Close
[0m16:20:36.763037 [debug] [Thread-1 (]: Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'DELIMITER //
  CREATE PROCEDURE `Tactical_clicks_months_12_dbt_test`()
  BEGIN
      W' at line 15
  compiled Code at target\run\site_dev\models\example\Tactical_clicks_months_12.sql
[0m16:20:36.764035 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '54a4b14c-3062-41f3-b33c-d2c13b076ccd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CA776E1B50>]}
[0m16:20:36.765032 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.Tactical_clicks_months_12 ........ [[31mERROR[0m in 2.47s]
[0m16:20:36.767027 [debug] [Thread-1 (]: Finished running node model.site_dev.Tactical_clicks_months_12
[0m16:20:36.769843 [debug] [MainThread]: Using mysql connection "master"
[0m16:20:36.770802 [debug] [MainThread]: On master: BEGIN
[0m16:20:36.771801 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m16:20:38.350704 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m16:20:38.353704 [debug] [MainThread]: On master: COMMIT
[0m16:20:38.355702 [debug] [MainThread]: Using mysql connection "master"
[0m16:20:38.356702 [debug] [MainThread]: On master: COMMIT
[0m16:20:38.947985 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m16:20:38.950995 [debug] [MainThread]: On master: Close
[0m16:20:38.952980 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:20:38.953996 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m16:20:38.954974 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m16:20:38.955993 [debug] [MainThread]: Connection 'model.site_dev.Tactical_clicks_months_12' was properly closed.
[0m16:20:38.956966 [info ] [MainThread]: 
[0m16:20:38.957963 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 13.71 seconds (13.71s).
[0m16:20:38.958961 [debug] [MainThread]: Command end result
[0m16:20:38.972923 [info ] [MainThread]: 
[0m16:20:38.973922 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m16:20:38.973922 [info ] [MainThread]: 
[0m16:20:38.974920 [error] [MainThread]:   Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'DELIMITER //
  CREATE PROCEDURE `Tactical_clicks_months_12_dbt_test`()
  BEGIN
      W' at line 15
  compiled Code at target\run\site_dev\models\example\Tactical_clicks_months_12.sql
[0m16:20:38.975916 [info ] [MainThread]: 
[0m16:20:38.976913 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m16:20:38.978909 [debug] [MainThread]: Command `dbt run` failed at 16:20:38.978909 after 15.94 seconds
[0m16:20:38.979905 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CA772CA090>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CA772CB150>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CA776E1B50>]}
[0m16:20:38.980903 [debug] [MainThread]: Flushing usage events
[0m16:21:17.413685 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000263FA99B750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000263FA9EA810>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000263FA99A050>]}


============================== 16:21:17.421666 | ea48dcfc-3800-4790-ab1b-8e860fb07b47 ==============================
[0m16:21:17.421666 [info ] [MainThread]: Running with dbt=1.7.17
[0m16:21:17.422661 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'version_check': 'True', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --models Tactical_clicks_months_12.sql', 'send_anonymous_usage_stats': 'True'}
[0m16:21:17.917831 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ea48dcfc-3800-4790-ab1b-8e860fb07b47', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000263FA48C8D0>]}
[0m16:21:18.004601 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ea48dcfc-3800-4790-ab1b-8e860fb07b47', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000263FA9CE3D0>]}
[0m16:21:18.007593 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m16:21:18.020556 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m16:21:18.053467 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m16:21:18.055463 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'ea48dcfc-3800-4790-ab1b-8e860fb07b47', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000263FA9917D0>]}
[0m16:21:19.866621 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example
[0m16:21:19.875593 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ea48dcfc-3800-4790-ab1b-8e860fb07b47', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000263FAC9C050>]}
[0m16:21:19.897537 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ea48dcfc-3800-4790-ab1b-8e860fb07b47', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000263FAD4E5D0>]}
[0m16:21:19.899530 [info ] [MainThread]: Found 15 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m16:21:19.900527 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ea48dcfc-3800-4790-ab1b-8e860fb07b47', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000263FAC0C310>]}
[0m16:21:19.904517 [info ] [MainThread]: 
[0m16:21:19.906511 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m16:21:19.908836 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m16:21:19.924789 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m16:21:19.925786 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m16:21:19.926783 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:21:21.481606 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m16:21:21.487584 [debug] [ThreadPool]: On list_schemas: Close
[0m16:21:21.492766 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__prod)
[0m16:21:21.496755 [debug] [ThreadPool]: Creating schema "schema: "prod"
"
[0m16:21:21.509718 [debug] [ThreadPool]: Using mysql connection "create__prod"
[0m16:21:21.510715 [debug] [ThreadPool]: On create__prod: BEGIN
[0m16:21:21.511713 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:21:23.065290 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m16:21:23.066285 [debug] [ThreadPool]: Using mysql connection "create__prod"
[0m16:21:23.067297 [debug] [ThreadPool]: On create__prod: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "create__prod"} */
create schema if not exists `prod`
[0m16:21:23.685740 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m16:21:23.687735 [debug] [ThreadPool]: On create__prod: COMMIT
[0m16:21:23.688732 [debug] [ThreadPool]: Using mysql connection "create__prod"
[0m16:21:23.689729 [debug] [ThreadPool]: On create__prod: COMMIT
[0m16:21:24.270888 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m16:21:24.273909 [debug] [ThreadPool]: On create__prod: Close
[0m16:21:24.283885 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_prod'
[0m16:21:24.291880 [debug] [ThreadPool]: Using mysql connection "list_None_prod"
[0m16:21:24.292857 [debug] [ThreadPool]: On list_None_prod: BEGIN
[0m16:21:24.293852 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:21:25.885018 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m16:21:25.886016 [debug] [ThreadPool]: Using mysql connection "list_None_prod"
[0m16:21:25.888010 [debug] [ThreadPool]: On list_None_prod: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_None_prod"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'prod'
  
[0m16:21:26.483933 [debug] [ThreadPool]: SQL status: SUCCESS 144 in 1.0 seconds
[0m16:21:26.487922 [debug] [ThreadPool]: On list_None_prod: ROLLBACK
[0m16:21:26.684966 [debug] [ThreadPool]: On list_None_prod: Close
[0m16:21:26.691976 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:21:26.693968 [debug] [MainThread]: Connection 'create__prod' was properly closed.
[0m16:21:26.695965 [debug] [MainThread]: Connection 'list_None_prod' was properly closed.
[0m16:21:26.698957 [info ] [MainThread]: 
[0m16:21:26.700973 [info ] [MainThread]: Finished running  in 0 hours 0 minutes and 6.79 seconds (6.79s).
[0m16:21:26.703943 [error] [MainThread]: Encountered an error:
Field "type" of type Optional[RelationType] in MySQLRelation has invalid value "bytearray(b'view')"
[0m16:21:26.715908 [error] [MainThread]: Traceback (most recent call last):
  File "<string>", line 17, in __mashumaro_from_dict__
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\dataclass_schema.py", line 156, in _deserialize
    return cls(value)
           ^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\enum.py", line 695, in __call__
    return cls.__new__(cls, value)
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\enum.py", line 1111, in __new__
    raise ve_exc
ValueError: "bytearray(b'view')" is not a valid RelationType

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 91, in wrapper
    result, success = func(*args, **kwargs)
                      ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 76, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 169, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 198, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 245, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 278, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\main.py", line 626, in run
    results = task.run()
              ^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 502, in run
    result = self.execute_with_hooks(selected_uids)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 462, in execute_with_hooks
    self.before_run(adapter, selected_uids)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\run.py", line 451, in before_run
    self.populate_adapter_cache(adapter, required_schemas)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 440, in populate_adapter_cache
    adapter.set_relations_cache(self.manifest)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\impl.py", line 519, in set_relations_cache
    self._relations_cache_for_schemas(manifest, required_schemas)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\impl.py", line 495, in _relations_cache_for_schemas
    for relation in future.result():
                    ^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\_base.py", line 401, in __get_result
    raise self._exception
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\thread.py", line 58, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\utils.py", line 471, in connected
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\mysql\impl.py", line 82, in list_relations_without_caching
    relation = self.Relation.create(schema=_schema, identifier=name, type=relation_type)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\relation.py", line 299, in create
    return cls.from_dict(kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 19, in __mashumaro_from_dict__
mashumaro.exceptions.InvalidFieldValue: Field "type" of type Optional[RelationType] in MySQLRelation has invalid value "bytearray(b'view')"

[0m16:21:26.718901 [debug] [MainThread]: Command `dbt run` failed at 16:21:26.718901 after 9.40 seconds
[0m16:21:26.719897 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000263F964F0D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000263FA9E7E50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000263FA9E7F90>]}
[0m16:21:26.720895 [debug] [MainThread]: Flushing usage events
[0m16:24:35.259998 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002914FCD8BD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002914F931FD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002914F9319D0>]}


============================== 16:24:35.269972 | a2c6ee58-94ac-4504-a00b-4a132d9ce9b2 ==============================
[0m16:24:35.269972 [info ] [MainThread]: Running with dbt=1.7.17
[0m16:24:35.270969 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models Tactical_clicks_months_12.sql', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m16:24:35.702814 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a2c6ee58-94ac-4504-a00b-4a132d9ce9b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002914FD2A510>]}
[0m16:24:35.845432 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a2c6ee58-94ac-4504-a00b-4a132d9ce9b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002914FD55350>]}
[0m16:24:35.847427 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m16:24:35.866377 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m16:24:36.034925 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m16:24:36.035922 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m16:24:36.038937 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example
[0m16:24:36.051880 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a2c6ee58-94ac-4504-a00b-4a132d9ce9b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029150074D50>]}
[0m16:24:36.081800 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a2c6ee58-94ac-4504-a00b-4a132d9ce9b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029150003D90>]}
[0m16:24:36.082798 [info ] [MainThread]: Found 15 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m16:24:36.083795 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a2c6ee58-94ac-4504-a00b-4a132d9ce9b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002914FFABB50>]}
[0m16:24:36.090778 [info ] [MainThread]: 
[0m16:24:36.092782 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m16:24:36.095764 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m16:24:36.113714 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m16:24:36.114712 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m16:24:36.115719 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:24:37.691528 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m16:24:37.694521 [debug] [ThreadPool]: On list_schemas: Close
[0m16:24:37.696516 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__prod)
[0m16:24:37.698511 [debug] [ThreadPool]: Creating schema "schema: "prod"
"
[0m16:24:37.712475 [debug] [ThreadPool]: Using mysql connection "create__prod"
[0m16:24:37.713471 [debug] [ThreadPool]: On create__prod: BEGIN
[0m16:24:37.714469 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:24:51.124650 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000271FD87B350>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000271FD8CBCD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000271FD8CB990>]}


============================== 16:24:51.130634 | 30f60e97-aa0c-478e-9460-86c5bb8d8e11 ==============================
[0m16:24:51.130634 [info ] [MainThread]: Running with dbt=1.7.17
[0m16:24:51.131632 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run --models Tactical_clicks_months_12.sql', 'send_anonymous_usage_stats': 'True'}
[0m16:24:51.410311 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '30f60e97-aa0c-478e-9460-86c5bb8d8e11', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000271FD36C4D0>]}
[0m16:24:51.497079 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '30f60e97-aa0c-478e-9460-86c5bb8d8e11', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000271FDAB8090>]}
[0m16:24:51.499215 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m16:24:51.510187 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m16:24:51.607926 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m16:24:51.608923 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m16:24:51.610918 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example
[0m16:24:51.618897 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '30f60e97-aa0c-478e-9460-86c5bb8d8e11', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000271FDC4C7D0>]}
[0m16:24:51.637847 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '30f60e97-aa0c-478e-9460-86c5bb8d8e11', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000271FDBA7DD0>]}
[0m16:24:51.638845 [info ] [MainThread]: Found 15 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m16:24:51.639842 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '30f60e97-aa0c-478e-9460-86c5bb8d8e11', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000271FCCB7350>]}
[0m16:24:51.642833 [info ] [MainThread]: 
[0m16:24:51.644828 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m16:24:51.647240 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m16:24:51.662201 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m16:24:51.663211 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m16:24:51.664197 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:24:53.424017 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m16:24:53.430004 [debug] [ThreadPool]: On list_schemas: Close
[0m16:24:53.435980 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__prod)
[0m16:24:53.439970 [debug] [ThreadPool]: Creating schema "schema: "prod"
"
[0m16:24:53.452941 [debug] [ThreadPool]: Using mysql connection "create__prod"
[0m16:24:53.453931 [debug] [ThreadPool]: On create__prod: BEGIN
[0m16:24:53.454928 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:24:55.037249 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m16:24:55.038240 [debug] [ThreadPool]: Using mysql connection "create__prod"
[0m16:24:55.039238 [debug] [ThreadPool]: On create__prod: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "create__prod"} */
create schema if not exists `prod`
[0m16:24:55.707853 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m16:24:55.711833 [debug] [ThreadPool]: On create__prod: COMMIT
[0m16:24:55.714828 [debug] [ThreadPool]: Using mysql connection "create__prod"
[0m16:24:55.716819 [debug] [ThreadPool]: On create__prod: COMMIT
[0m16:24:56.311074 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m16:24:56.314075 [debug] [ThreadPool]: On create__prod: Close
[0m16:24:56.324309 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_prod'
[0m16:24:56.336278 [debug] [ThreadPool]: Using mysql connection "list_None_prod"
[0m16:24:56.337276 [debug] [ThreadPool]: On list_None_prod: BEGIN
[0m16:24:56.338272 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:24:57.979725 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m16:24:57.982737 [debug] [ThreadPool]: Using mysql connection "list_None_prod"
[0m16:24:57.985727 [debug] [ThreadPool]: On list_None_prod: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_None_prod"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'prod'
  
[0m16:24:58.604509 [debug] [ThreadPool]: SQL status: SUCCESS 144 in 1.0 seconds
[0m16:24:58.616475 [debug] [ThreadPool]: On list_None_prod: ROLLBACK
[0m16:24:58.817586 [debug] [ThreadPool]: On list_None_prod: Close
[0m16:24:58.819589 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:24:58.820585 [debug] [MainThread]: Connection 'create__prod' was properly closed.
[0m16:24:58.821602 [debug] [MainThread]: Connection 'list_None_prod' was properly closed.
[0m16:24:58.822579 [info ] [MainThread]: 
[0m16:24:58.823576 [info ] [MainThread]: Finished running  in 0 hours 0 minutes and 7.18 seconds (7.18s).
[0m16:24:58.824574 [error] [MainThread]: Encountered an error:
Field "type" of type Optional[RelationType] in MySQLRelation has invalid value "bytearray(b'view')"
[0m16:24:58.832583 [error] [MainThread]: Traceback (most recent call last):
  File "<string>", line 17, in __mashumaro_from_dict__
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\dataclass_schema.py", line 156, in _deserialize
    return cls(value)
           ^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\enum.py", line 695, in __call__
    return cls.__new__(cls, value)
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\enum.py", line 1111, in __new__
    raise ve_exc
ValueError: "bytearray(b'view')" is not a valid RelationType

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 91, in wrapper
    result, success = func(*args, **kwargs)
                      ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 76, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 169, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 198, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 245, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 278, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\main.py", line 626, in run
    results = task.run()
              ^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 502, in run
    result = self.execute_with_hooks(selected_uids)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 462, in execute_with_hooks
    self.before_run(adapter, selected_uids)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\run.py", line 451, in before_run
    self.populate_adapter_cache(adapter, required_schemas)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 440, in populate_adapter_cache
    adapter.set_relations_cache(self.manifest)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\impl.py", line 519, in set_relations_cache
    self._relations_cache_for_schemas(manifest, required_schemas)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\impl.py", line 495, in _relations_cache_for_schemas
    for relation in future.result():
                    ^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\_base.py", line 401, in __get_result
    raise self._exception
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\thread.py", line 58, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\utils.py", line 471, in connected
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\mysql\impl.py", line 82, in list_relations_without_caching
    relation = self.Relation.create(schema=_schema, identifier=name, type=relation_type)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\relation.py", line 299, in create
    return cls.from_dict(kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 19, in __mashumaro_from_dict__
mashumaro.exceptions.InvalidFieldValue: Field "type" of type Optional[RelationType] in MySQLRelation has invalid value "bytearray(b'view')"

[0m16:24:58.834547 [debug] [MainThread]: Command `dbt run` failed at 16:24:58.834547 after 7.80 seconds
[0m16:24:58.835544 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000271FC615610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000271FDBDC150>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000271FD878AD0>]}
[0m16:24:58.836553 [debug] [MainThread]: Flushing usage events
[0m16:26:12.089943 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001925CE58D90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001925CE59C10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001925CE58910>]}


============================== 16:26:12.095925 | e1b74537-2b21-49ec-b9d8-deeb1ff42519 ==============================
[0m16:26:12.095925 [info ] [MainThread]: Running with dbt=1.7.17
[0m16:26:12.097926 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --models Tactical_clicks_months_12.sql', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m16:26:12.103905 [error] [MainThread]: Encountered an error:
Runtime Error
  Could not find profile named 'dev'
[0m16:26:12.105900 [debug] [MainThread]: Command `dbt run` failed at 16:26:12.105900 after 0.12 seconds
[0m16:26:12.106909 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001925CE9B150>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001925C8AC690>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001925C8AC990>]}
[0m16:26:12.107897 [debug] [MainThread]: Flushing usage events
[0m16:27:20.078495 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002274DA71B10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002274DA73310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002274DA73990>]}


============================== 16:27:20.086473 | e15b57f9-5284-4593-9c32-7d118bfd2a8e ==============================
[0m16:27:20.086473 [info ] [MainThread]: Running with dbt=1.7.17
[0m16:27:20.087470 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'fail_fast': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models Tactical_clicks_months_12.sql', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:27:20.381576 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e15b57f9-5284-4593-9c32-7d118bfd2a8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002274DC2B890>]}
[0m16:27:20.483277 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e15b57f9-5284-4593-9c32-7d118bfd2a8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002274DC4D4D0>]}
[0m16:27:20.485615 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m16:27:20.497586 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m16:27:20.509558 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m16:27:20.510552 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'e15b57f9-5284-4593-9c32-7d118bfd2a8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002274DCEEC90>]}
[0m16:27:22.577023 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example
[0m16:27:22.584003 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e15b57f9-5284-4593-9c32-7d118bfd2a8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002274DF6D250>]}
[0m16:27:22.603951 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e15b57f9-5284-4593-9c32-7d118bfd2a8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002274DF8B890>]}
[0m16:27:22.604951 [info ] [MainThread]: Found 15 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m16:27:22.605948 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e15b57f9-5284-4593-9c32-7d118bfd2a8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002274DCFEF50>]}
[0m16:27:22.608939 [info ] [MainThread]: 
[0m16:27:22.610940 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m16:27:22.613472 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m16:27:22.629430 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m16:27:22.630429 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m16:27:22.631438 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:27:24.167758 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m16:27:24.171756 [debug] [ThreadPool]: On list_schemas: Close
[0m16:27:24.174731 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m16:27:24.175729 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m16:27:24.181712 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m16:27:24.182709 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m16:27:24.183708 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:27:25.763989 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m16:27:25.765951 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m16:27:25.767947 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m16:27:26.371970 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m16:27:26.375957 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m16:27:26.376952 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m16:27:26.377950 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m16:27:26.973713 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m16:27:26.975708 [debug] [ThreadPool]: On create__site_dev: Close
[0m16:27:26.985682 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m16:27:26.997649 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m16:27:26.998647 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m16:27:26.999643 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:27:28.575175 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m16:27:28.577182 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m16:27:28.579175 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m16:27:29.170492 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m16:27:29.174475 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m16:27:29.370909 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m16:27:29.375915 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e15b57f9-5284-4593-9c32-7d118bfd2a8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002274DDE2610>]}
[0m16:27:29.376899 [debug] [MainThread]: Using mysql connection "master"
[0m16:27:29.377898 [debug] [MainThread]: On master: BEGIN
[0m16:27:29.377898 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:27:31.048521 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m16:27:31.052512 [debug] [MainThread]: On master: COMMIT
[0m16:27:31.055502 [debug] [MainThread]: Using mysql connection "master"
[0m16:27:31.057495 [debug] [MainThread]: On master: COMMIT
[0m16:27:31.652477 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m16:27:31.655466 [debug] [MainThread]: On master: Close
[0m16:27:31.658457 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m16:27:31.660452 [info ] [MainThread]: 
[0m16:27:31.668689 [debug] [Thread-1 (]: Began running node model.site_dev.Tactical_clicks_months_12
[0m16:27:31.671683 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.Tactical_clicks_months_12 ................. [RUN]
[0m16:27:31.674674 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.site_dev.Tactical_clicks_months_12'
[0m16:27:31.675670 [debug] [Thread-1 (]: Began compiling node model.site_dev.Tactical_clicks_months_12
[0m16:27:31.693634 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.Tactical_clicks_months_12"
[0m16:27:31.695618 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_clicks_months_12 (compile): 16:27:31.675670 => 16:27:31.695618
[0m16:27:31.696614 [debug] [Thread-1 (]: Began executing node model.site_dev.Tactical_clicks_months_12
[0m16:27:31.753464 [debug] [Thread-1 (]: Writing runtime sql for node "model.site_dev.Tactical_clicks_months_12"
[0m16:27:31.755455 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_clicks_months_12"
[0m16:27:31.756454 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: BEGIN
[0m16:27:31.757450 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m16:27:33.320355 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m16:27:33.321355 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_clicks_months_12"
[0m16:27:33.322352 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "node_id": "model.site_dev.Tactical_clicks_months_12"} */

  create view `site_dev`.`Tactical_clicks_months_12__dbt_tmp`
    
    
  as (
    







DELIMITER //
CREATE PROCEDURE `Tactical_clicks_months_12_dbt_test`()
BEGIN
    WITH curr_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND categories <> "Nyhedsoverblik"
        AND siteid = '12'
    ),
    agg_curr_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks
        FROM prod.events e
        JOIN curr_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND e.siteid = '12'
        AND e.Event_Action = 'Next Click'
        GROUP BY 1
    ),
    agg_curr_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum
        FROM prod.pages p
        LEFT JOIN curr_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = '12'
        AND p.date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        GROUP BY p.siteid
    ),
    value_curr_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks / p.pageview_sum * 100, 2) AS value
        FROM agg_curr_30_days_events e
        LEFT JOIN agg_curr_30_days_pages p ON e.siteid = p.siteid
    ),
    last_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        AND siteid = site
        AND categories <> "Nyhedsoverblik"
    ),
    agg_last_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks_last
        FROM prod.events e
        JOIN last_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        AND e.siteid = '12'
        AND e.Event_Action = 'Next Click'
        GROUP BY 1
    ),
    agg_last_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum_last
        FROM prod.pages p
        LEFT JOIN last_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = '12'
        AND p.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) 
        GROUP BY p.siteid
    ),
    value_last_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks_last / p.pageview_sum_last * 100, 2) AS value_last
        FROM agg_last_30_days_events e
        LEFT JOIN agg_last_30_days_pages p ON e.siteid = p.siteid
    )
    SELECT 
        JSON_OBJECT(
            'site', al.siteid,
            'data', JSON_OBJECT(
            'label', 'Artikler',
            'hint', 'Artikler publiceret seneste 30 dage ift. forrige 30 dage',
            'value', COALESCE(value, 0),
            'change', COALESCE(value - value_last, 0),
            'progressCurrent', '',
            'progressTotal', ''
            )
        ) AS json_data
    FROM value_curr_30_days al
    LEFT JOIN value_last_30_days alb ON al.siteid = alb.siteid
    WHERE al.siteid = '12';
END;
DELIMITER ;
  );
[0m16:27:33.913839 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'DELIMITER //
CREATE PROCEDURE `Tactical_clicks_months_12_dbt_test`()
BEGIN
    W' at line 15
[0m16:27:33.914840 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: ROLLBACK
[0m16:27:34.115356 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_clicks_months_12 (execute): 16:27:31.697613 => 16:27:34.113354
[0m16:27:34.117352 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: Close
[0m16:27:34.131314 [debug] [Thread-1 (]: Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'DELIMITER //
  CREATE PROCEDURE `Tactical_clicks_months_12_dbt_test`()
  BEGIN
      W' at line 15
  compiled Code at target\run\site_dev\models\example\Tactical_clicks_months_12.sql
[0m16:27:34.132311 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e15b57f9-5284-4593-9c32-7d118bfd2a8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002274DF1E7D0>]}
[0m16:27:34.133314 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.Tactical_clicks_months_12 ........ [[31mERROR[0m in 2.46s]
[0m16:27:34.134304 [debug] [Thread-1 (]: Finished running node model.site_dev.Tactical_clicks_months_12
[0m16:27:34.138294 [debug] [MainThread]: Using mysql connection "master"
[0m16:27:34.139292 [debug] [MainThread]: On master: BEGIN
[0m16:27:34.139292 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m16:27:35.728840 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m16:27:35.730843 [debug] [MainThread]: On master: COMMIT
[0m16:27:35.731840 [debug] [MainThread]: Using mysql connection "master"
[0m16:27:35.732837 [debug] [MainThread]: On master: COMMIT
[0m16:27:36.325841 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m16:27:36.328844 [debug] [MainThread]: On master: Close
[0m16:27:36.331828 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:27:36.333821 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m16:27:36.334819 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m16:27:36.336814 [debug] [MainThread]: Connection 'model.site_dev.Tactical_clicks_months_12' was properly closed.
[0m16:27:36.338808 [info ] [MainThread]: 
[0m16:27:36.340803 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 13.73 seconds (13.73s).
[0m16:27:36.343797 [debug] [MainThread]: Command end result
[0m16:27:36.368728 [info ] [MainThread]: 
[0m16:27:36.370722 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m16:27:36.371720 [info ] [MainThread]: 
[0m16:27:36.373714 [error] [MainThread]:   Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'DELIMITER //
  CREATE PROCEDURE `Tactical_clicks_months_12_dbt_test`()
  BEGIN
      W' at line 15
  compiled Code at target\run\site_dev\models\example\Tactical_clicks_months_12.sql
[0m16:27:36.374710 [info ] [MainThread]: 
[0m16:27:36.375711 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m16:27:36.383689 [debug] [MainThread]: Command `dbt run` failed at 16:27:36.382709 after 16.42 seconds
[0m16:27:36.385682 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002274DA73150>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022746F01750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022746F01510>]}
[0m16:27:36.387677 [debug] [MainThread]: Flushing usage events
[0m16:28:52.549935 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E98C05D850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E98C05DED0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E98C05C5D0>]}


============================== 16:28:52.558912 | 847f7773-cd66-44f4-ad47-ceed4de9f486 ==============================
[0m16:28:52.558912 [info ] [MainThread]: Running with dbt=1.7.17
[0m16:28:52.560908 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models Tactical_clicks_months_12.sql', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:28:52.853404 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '847f7773-cd66-44f4-ad47-ceed4de9f486', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E98C21B810>]}
[0m16:28:52.960119 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '847f7773-cd66-44f4-ad47-ceed4de9f486', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E98C0C4F50>]}
[0m16:28:52.962424 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m16:28:52.974397 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m16:28:52.999328 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m16:28:53.000326 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '847f7773-cd66-44f4-ad47-ceed4de9f486', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E98C09AA10>]}
[0m16:28:54.700776 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example
[0m16:28:54.707758 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '847f7773-cd66-44f4-ad47-ceed4de9f486', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E98C57CF50>]}
[0m16:28:54.728703 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '847f7773-cd66-44f4-ad47-ceed4de9f486', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E98C4E7690>]}
[0m16:28:54.729702 [info ] [MainThread]: Found 15 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m16:28:54.730698 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '847f7773-cd66-44f4-ad47-ceed4de9f486', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E98C5E8790>]}
[0m16:28:54.733689 [info ] [MainThread]: 
[0m16:28:54.735683 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m16:28:54.738676 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m16:28:54.754632 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m16:28:54.755631 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m16:28:54.755631 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:28:56.308668 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m16:28:56.315650 [debug] [ThreadPool]: On list_schemas: Close
[0m16:28:56.322635 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__prod)
[0m16:28:56.326622 [debug] [ThreadPool]: Creating schema "schema: "prod"
"
[0m16:28:56.349561 [debug] [ThreadPool]: Using mysql connection "create__prod"
[0m16:28:56.352553 [debug] [ThreadPool]: On create__prod: BEGIN
[0m16:28:56.354542 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:28:57.907727 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m16:28:57.909707 [debug] [ThreadPool]: Using mysql connection "create__prod"
[0m16:28:57.912703 [debug] [ThreadPool]: On create__prod: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "create__prod"} */
create schema if not exists `prod`
[0m16:28:58.498436 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m16:28:58.500428 [debug] [ThreadPool]: On create__prod: COMMIT
[0m16:28:58.501428 [debug] [ThreadPool]: Using mysql connection "create__prod"
[0m16:28:58.503421 [debug] [ThreadPool]: On create__prod: COMMIT
[0m16:28:59.167200 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m16:28:59.168199 [debug] [ThreadPool]: On create__prod: Close
[0m16:28:59.173666 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_prod'
[0m16:28:59.185649 [debug] [ThreadPool]: Using mysql connection "list_None_prod"
[0m16:28:59.187634 [debug] [ThreadPool]: On list_None_prod: BEGIN
[0m16:28:59.192703 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:29:00.776803 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m16:29:00.779792 [debug] [ThreadPool]: Using mysql connection "list_None_prod"
[0m16:29:00.781785 [debug] [ThreadPool]: On list_None_prod: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_None_prod"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'prod'
  
[0m16:29:01.382443 [debug] [ThreadPool]: SQL status: SUCCESS 144 in 1.0 seconds
[0m16:29:01.386433 [debug] [ThreadPool]: On list_None_prod: ROLLBACK
[0m16:29:01.583917 [debug] [ThreadPool]: On list_None_prod: Close
[0m16:29:01.585630 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:29:01.586632 [debug] [MainThread]: Connection 'create__prod' was properly closed.
[0m16:29:01.587630 [debug] [MainThread]: Connection 'list_None_prod' was properly closed.
[0m16:29:01.589624 [info ] [MainThread]: 
[0m16:29:01.589624 [info ] [MainThread]: Finished running  in 0 hours 0 minutes and 6.85 seconds (6.85s).
[0m16:29:01.590622 [error] [MainThread]: Encountered an error:
Field "type" of type Optional[RelationType] in MySQLRelation has invalid value "bytearray(b'view')"
[0m16:29:01.599626 [error] [MainThread]: Traceback (most recent call last):
  File "<string>", line 17, in __mashumaro_from_dict__
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\dataclass_schema.py", line 156, in _deserialize
    return cls(value)
           ^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\enum.py", line 695, in __call__
    return cls.__new__(cls, value)
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\enum.py", line 1111, in __new__
    raise ve_exc
ValueError: "bytearray(b'view')" is not a valid RelationType

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 91, in wrapper
    result, success = func(*args, **kwargs)
                      ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 76, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 169, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 198, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 245, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 278, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\main.py", line 626, in run
    results = task.run()
              ^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 502, in run
    result = self.execute_with_hooks(selected_uids)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 462, in execute_with_hooks
    self.before_run(adapter, selected_uids)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\run.py", line 451, in before_run
    self.populate_adapter_cache(adapter, required_schemas)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 440, in populate_adapter_cache
    adapter.set_relations_cache(self.manifest)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\impl.py", line 519, in set_relations_cache
    self._relations_cache_for_schemas(manifest, required_schemas)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\impl.py", line 495, in _relations_cache_for_schemas
    for relation in future.result():
                    ^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\_base.py", line 401, in __get_result
    raise self._exception
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\thread.py", line 58, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\utils.py", line 471, in connected
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\mysql\impl.py", line 82, in list_relations_without_caching
    relation = self.Relation.create(schema=_schema, identifier=name, type=relation_type)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\relation.py", line 299, in create
    return cls.from_dict(kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 19, in __mashumaro_from_dict__
mashumaro.exceptions.InvalidFieldValue: Field "type" of type Optional[RelationType] in MySQLRelation has invalid value "bytearray(b'view')"

[0m16:29:01.602587 [debug] [MainThread]: Command `dbt run` failed at 16:29:01.601591 after 9.15 seconds
[0m16:29:01.603585 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E98C09A110>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E98C048310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E98C042850>]}
[0m16:29:01.604583 [debug] [MainThread]: Flushing usage events
[0m16:29:25.763499 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AB81B81290>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AB81BDAA90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AB81BDBC90>]}


============================== 16:29:25.772477 | 191c27a8-950c-44d2-ba2d-7f4c3f5ae2ef ==============================
[0m16:29:25.772477 [info ] [MainThread]: Running with dbt=1.7.17
[0m16:29:25.774471 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'version_check': 'True', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models Tactical_clicks_months_12.sql', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m16:29:26.108573 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '191c27a8-950c-44d2-ba2d-7f4c3f5ae2ef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AB81C02550>]}
[0m16:29:26.221280 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '191c27a8-950c-44d2-ba2d-7f4c3f5ae2ef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AB81B96490>]}
[0m16:29:26.223890 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m16:29:26.237857 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m16:29:26.264785 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m16:29:26.265783 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '191c27a8-950c-44d2-ba2d-7f4c3f5ae2ef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AB81B80A10>]}
[0m16:29:28.234515 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example
[0m16:29:28.244495 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '191c27a8-950c-44d2-ba2d-7f4c3f5ae2ef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AB81C05C50>]}
[0m16:29:28.269424 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '191c27a8-950c-44d2-ba2d-7f4c3f5ae2ef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AB81ED8F90>]}
[0m16:29:28.270418 [info ] [MainThread]: Found 15 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m16:29:28.271417 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '191c27a8-950c-44d2-ba2d-7f4c3f5ae2ef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AB82053C50>]}
[0m16:29:28.275406 [info ] [MainThread]: 
[0m16:29:28.276402 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m16:29:28.279555 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m16:29:28.297503 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m16:29:28.298500 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m16:29:28.299499 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:29:29.850861 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m16:29:29.855846 [debug] [ThreadPool]: On list_schemas: Close
[0m16:29:29.859853 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__prod)
[0m16:29:29.860834 [debug] [ThreadPool]: Creating schema "schema: "prod"
"
[0m16:29:29.870809 [debug] [ThreadPool]: Using mysql connection "create__prod"
[0m16:29:29.871806 [debug] [ThreadPool]: On create__prod: BEGIN
[0m16:29:29.872804 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:29:31.442605 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m16:29:31.443611 [debug] [ThreadPool]: Using mysql connection "create__prod"
[0m16:29:31.443611 [debug] [ThreadPool]: On create__prod: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "create__prod"} */
create schema if not exists `prod`
[0m16:29:32.043128 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m16:29:32.048133 [debug] [ThreadPool]: On create__prod: COMMIT
[0m16:29:32.051101 [debug] [ThreadPool]: Using mysql connection "create__prod"
[0m16:29:32.054090 [debug] [ThreadPool]: On create__prod: COMMIT
[0m16:29:32.648396 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m16:29:32.651384 [debug] [ThreadPool]: On create__prod: Close
[0m16:29:32.663529 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_prod'
[0m16:29:32.679486 [debug] [ThreadPool]: Using mysql connection "list_None_prod"
[0m16:29:32.680482 [debug] [ThreadPool]: On list_None_prod: BEGIN
[0m16:29:32.681480 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:29:34.242809 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m16:29:34.243810 [debug] [ThreadPool]: Using mysql connection "list_None_prod"
[0m16:29:34.244808 [debug] [ThreadPool]: On list_None_prod: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_None_prod"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'prod'
  
[0m16:29:34.842297 [debug] [ThreadPool]: SQL status: SUCCESS 144 in 1.0 seconds
[0m16:29:34.849280 [debug] [ThreadPool]: On list_None_prod: ROLLBACK
[0m16:29:35.045784 [debug] [ThreadPool]: On list_None_prod: Close
[0m16:29:35.049346 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:29:35.050365 [debug] [MainThread]: Connection 'create__prod' was properly closed.
[0m16:29:35.051362 [debug] [MainThread]: Connection 'list_None_prod' was properly closed.
[0m16:29:35.053357 [info ] [MainThread]: 
[0m16:29:35.054355 [info ] [MainThread]: Finished running  in 0 hours 0 minutes and 6.78 seconds (6.78s).
[0m16:29:35.055352 [error] [MainThread]: Encountered an error:
Field "type" of type Optional[RelationType] in MySQLRelation has invalid value "bytearray(b'view')"
[0m16:29:35.067320 [error] [MainThread]: Traceback (most recent call last):
  File "<string>", line 17, in __mashumaro_from_dict__
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\dataclass_schema.py", line 156, in _deserialize
    return cls(value)
           ^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\enum.py", line 695, in __call__
    return cls.__new__(cls, value)
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\enum.py", line 1111, in __new__
    raise ve_exc
ValueError: "bytearray(b'view')" is not a valid RelationType

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 91, in wrapper
    result, success = func(*args, **kwargs)
                      ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 76, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 169, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 198, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 245, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 278, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\main.py", line 626, in run
    results = task.run()
              ^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 502, in run
    result = self.execute_with_hooks(selected_uids)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 462, in execute_with_hooks
    self.before_run(adapter, selected_uids)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\run.py", line 451, in before_run
    self.populate_adapter_cache(adapter, required_schemas)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 440, in populate_adapter_cache
    adapter.set_relations_cache(self.manifest)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\impl.py", line 519, in set_relations_cache
    self._relations_cache_for_schemas(manifest, required_schemas)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\impl.py", line 495, in _relations_cache_for_schemas
    for relation in future.result():
                    ^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\_base.py", line 401, in __get_result
    raise self._exception
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\thread.py", line 58, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\utils.py", line 471, in connected
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\mysql\impl.py", line 82, in list_relations_without_caching
    relation = self.Relation.create(schema=_schema, identifier=name, type=relation_type)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\relation.py", line 299, in create
    return cls.from_dict(kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 19, in __mashumaro_from_dict__
mashumaro.exceptions.InvalidFieldValue: Field "type" of type Optional[RelationType] in MySQLRelation has invalid value "bytearray(b'view')"

[0m16:29:35.072304 [debug] [MainThread]: Command `dbt run` failed at 16:29:35.072304 after 9.45 seconds
[0m16:29:35.073305 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AB81B885D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AB81BD7D10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AB81E83DD0>]}
[0m16:29:35.074305 [debug] [MainThread]: Flushing usage events
[0m16:30:26.304058 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001748D123E90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001748D17BC10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001748D17B990>]}


============================== 16:30:26.310042 | 4a0447bd-f4ff-4a86-b8b5-1a2b69d4f153 ==============================
[0m16:30:26.310042 [info ] [MainThread]: Running with dbt=1.7.17
[0m16:30:26.312037 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'debug': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models Tactical_clicks_months_12.sql', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m16:30:26.681638 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4a0447bd-f4ff-4a86-b8b5-1a2b69d4f153', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001748D304A90>]}
[0m16:30:26.767397 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4a0447bd-f4ff-4a86-b8b5-1a2b69d4f153', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001748CC1C8D0>]}
[0m16:30:26.769534 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m16:30:26.780507 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m16:30:26.919761 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m16:30:26.920759 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m16:30:26.922753 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example
[0m16:30:26.937714 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4a0447bd-f4ff-4a86-b8b5-1a2b69d4f153', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001748D3FFF10>]}
[0m16:30:26.965638 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4a0447bd-f4ff-4a86-b8b5-1a2b69d4f153', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001748D457D90>]}
[0m16:30:26.967632 [info ] [MainThread]: Found 15 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m16:30:26.968630 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4a0447bd-f4ff-4a86-b8b5-1a2b69d4f153', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001748D2E91D0>]}
[0m16:30:26.971621 [info ] [MainThread]: 
[0m16:30:26.972619 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m16:30:26.975611 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m16:30:26.990572 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m16:30:26.991568 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m16:30:26.992566 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:30:28.591968 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m16:30:28.596947 [debug] [ThreadPool]: On list_schemas: Close
[0m16:30:28.598942 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__prod)
[0m16:30:28.599940 [debug] [ThreadPool]: Creating schema "schema: "prod"
"
[0m16:30:28.606921 [debug] [ThreadPool]: Using mysql connection "create__prod"
[0m16:30:28.607919 [debug] [ThreadPool]: On create__prod: BEGIN
[0m16:30:28.607919 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:30:30.173502 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m16:30:30.175501 [debug] [ThreadPool]: Using mysql connection "create__prod"
[0m16:30:30.176497 [debug] [ThreadPool]: On create__prod: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "create__prod"} */
create schema if not exists `prod`
[0m16:30:30.802156 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m16:30:30.804155 [debug] [ThreadPool]: On create__prod: COMMIT
[0m16:30:30.805153 [debug] [ThreadPool]: Using mysql connection "create__prod"
[0m16:30:30.807148 [debug] [ThreadPool]: On create__prod: COMMIT
[0m16:30:31.392624 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m16:30:31.393625 [debug] [ThreadPool]: On create__prod: Close
[0m16:30:31.397616 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_prod'
[0m16:30:31.405592 [debug] [ThreadPool]: Using mysql connection "list_None_prod"
[0m16:30:31.407590 [debug] [ThreadPool]: On list_None_prod: BEGIN
[0m16:30:31.408585 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:30:32.972733 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m16:30:32.974733 [debug] [ThreadPool]: Using mysql connection "list_None_prod"
[0m16:30:32.976723 [debug] [ThreadPool]: On list_None_prod: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_None_prod"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'prod'
  
[0m16:30:33.587749 [debug] [ThreadPool]: SQL status: SUCCESS 144 in 1.0 seconds
[0m16:30:33.594731 [debug] [ThreadPool]: On list_None_prod: ROLLBACK
[0m16:30:33.790933 [debug] [ThreadPool]: On list_None_prod: Close
[0m16:30:33.796937 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:30:33.799925 [debug] [MainThread]: Connection 'create__prod' was properly closed.
[0m16:30:33.800924 [debug] [MainThread]: Connection 'list_None_prod' was properly closed.
[0m16:30:33.801914 [info ] [MainThread]: 
[0m16:30:33.801914 [info ] [MainThread]: Finished running  in 0 hours 0 minutes and 6.83 seconds (6.83s).
[0m16:30:33.803909 [error] [MainThread]: Encountered an error:
Field "type" of type Optional[RelationType] in MySQLRelation has invalid value "bytearray(b'view')"
[0m16:30:33.810893 [error] [MainThread]: Traceback (most recent call last):
  File "<string>", line 17, in __mashumaro_from_dict__
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\dataclass_schema.py", line 156, in _deserialize
    return cls(value)
           ^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\enum.py", line 695, in __call__
    return cls.__new__(cls, value)
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\enum.py", line 1111, in __new__
    raise ve_exc
ValueError: "bytearray(b'view')" is not a valid RelationType

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 91, in wrapper
    result, success = func(*args, **kwargs)
                      ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 76, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 169, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 198, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 245, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 278, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\main.py", line 626, in run
    results = task.run()
              ^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 502, in run
    result = self.execute_with_hooks(selected_uids)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 462, in execute_with_hooks
    self.before_run(adapter, selected_uids)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\run.py", line 451, in before_run
    self.populate_adapter_cache(adapter, required_schemas)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 440, in populate_adapter_cache
    adapter.set_relations_cache(self.manifest)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\impl.py", line 519, in set_relations_cache
    self._relations_cache_for_schemas(manifest, required_schemas)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\impl.py", line 495, in _relations_cache_for_schemas
    for relation in future.result():
                    ^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\_base.py", line 401, in __get_result
    raise self._exception
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\thread.py", line 58, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\utils.py", line 471, in connected
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\mysql\impl.py", line 82, in list_relations_without_caching
    relation = self.Relation.create(schema=_schema, identifier=name, type=relation_type)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\relation.py", line 299, in create
    return cls.from_dict(kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 19, in __mashumaro_from_dict__
mashumaro.exceptions.InvalidFieldValue: Field "type" of type Optional[RelationType] in MySQLRelation has invalid value "bytearray(b'view')"

[0m16:30:33.813883 [debug] [MainThread]: Command `dbt run` failed at 16:30:33.813883 after 7.60 seconds
[0m16:30:33.814880 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001748D177950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001748D397090>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001748D4FDB90>]}
[0m16:30:33.815897 [debug] [MainThread]: Flushing usage events
[0m17:05:55.283773 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F7930B3790>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F7930B3910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F7930B3CD0>]}


============================== 17:05:55.291723 | a2d324a1-83fb-4f64-abeb-924d015d5219 ==============================
[0m17:05:55.291723 [info ] [MainThread]: Running with dbt=1.7.17
[0m17:05:55.294715 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --models Tactical_clicks_months_12.sql', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m17:05:55.672928 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a2d324a1-83fb-4f64-abeb-924d015d5219', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F7932B9AD0>]}
[0m17:05:55.766648 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a2d324a1-83fb-4f64-abeb-924d015d5219', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F7930C9DD0>]}
[0m17:05:55.769270 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m17:05:55.784475 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m17:05:56.843582 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 3 files changed.
[0m17:05:56.845578 [debug] [MainThread]: Partial parsing: added file: site_dev://models\example\Tactical_clicks_ytd_12.sql
[0m17:05:56.846576 [debug] [MainThread]: Partial parsing: updated file: site_dev://models\example\Tactical_clicks_months_12.sql
[0m17:05:56.846576 [debug] [MainThread]: Partial parsing: updated file: site_dev://models\example\tactical_articles_card_month_12.sql
[0m17:05:56.847573 [debug] [MainThread]: Partial parsing: updated file: site_dev://models\example\overview_sales_card_12.sql
[0m17:05:57.146772 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example
[0m17:05:57.159738 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a2d324a1-83fb-4f64-abeb-924d015d5219', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F7935C94D0>]}
[0m17:05:57.187058 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a2d324a1-83fb-4f64-abeb-924d015d5219', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F79348E890>]}
[0m17:05:57.188055 [info ] [MainThread]: Found 16 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m17:05:57.191044 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a2d324a1-83fb-4f64-abeb-924d015d5219', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F7934603D0>]}
[0m17:05:57.195035 [info ] [MainThread]: 
[0m17:05:57.196042 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m17:05:57.200020 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m17:05:57.217972 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m17:05:57.218968 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m17:05:57.219967 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:05:58.777747 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m17:05:58.780737 [debug] [ThreadPool]: On list_schemas: Close
[0m17:05:58.783730 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__prod)
[0m17:05:58.785724 [debug] [ThreadPool]: Creating schema "schema: "prod"
"
[0m17:05:58.796695 [debug] [ThreadPool]: Using mysql connection "create__prod"
[0m17:05:58.797694 [debug] [ThreadPool]: On create__prod: BEGIN
[0m17:05:58.799687 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:06:00.391922 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m17:06:00.396908 [debug] [ThreadPool]: Using mysql connection "create__prod"
[0m17:06:00.400898 [debug] [ThreadPool]: On create__prod: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "create__prod"} */
create schema if not exists `prod`
[0m17:06:01.009463 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m17:06:01.015464 [debug] [ThreadPool]: On create__prod: COMMIT
[0m17:06:01.017451 [debug] [ThreadPool]: Using mysql connection "create__prod"
[0m17:06:01.019448 [debug] [ThreadPool]: On create__prod: COMMIT
[0m17:06:01.622117 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m17:06:01.623117 [debug] [ThreadPool]: On create__prod: Close
[0m17:06:01.627667 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_prod'
[0m17:06:01.638643 [debug] [ThreadPool]: Using mysql connection "list_None_prod"
[0m17:06:01.640636 [debug] [ThreadPool]: On list_None_prod: BEGIN
[0m17:06:01.641634 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:06:03.202208 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m17:06:03.204209 [debug] [ThreadPool]: Using mysql connection "list_None_prod"
[0m17:06:03.206204 [debug] [ThreadPool]: On list_None_prod: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_None_prod"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'prod'
  
[0m17:06:03.799291 [debug] [ThreadPool]: SQL status: SUCCESS 144 in 1.0 seconds
[0m17:06:03.808266 [debug] [ThreadPool]: On list_None_prod: ROLLBACK
[0m17:06:04.003741 [debug] [ThreadPool]: On list_None_prod: Close
[0m17:06:04.006735 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:06:04.007731 [debug] [MainThread]: Connection 'create__prod' was properly closed.
[0m17:06:04.008728 [debug] [MainThread]: Connection 'list_None_prod' was properly closed.
[0m17:06:04.009726 [info ] [MainThread]: 
[0m17:06:04.010723 [info ] [MainThread]: Finished running  in 0 hours 0 minutes and 6.81 seconds (6.81s).
[0m17:06:04.011721 [error] [MainThread]: Encountered an error:
Field "type" of type Optional[RelationType] in MySQLRelation has invalid value "bytearray(b'view')"
[0m17:06:04.200216 [error] [MainThread]: Traceback (most recent call last):
  File "<string>", line 17, in __mashumaro_from_dict__
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\dataclass_schema.py", line 156, in _deserialize
    return cls(value)
           ^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\enum.py", line 695, in __call__
    return cls.__new__(cls, value)
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\enum.py", line 1111, in __new__
    raise ve_exc
ValueError: "bytearray(b'view')" is not a valid RelationType

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 91, in wrapper
    result, success = func(*args, **kwargs)
                      ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 76, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 169, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 198, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 245, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 278, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\main.py", line 626, in run
    results = task.run()
              ^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 502, in run
    result = self.execute_with_hooks(selected_uids)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 462, in execute_with_hooks
    self.before_run(adapter, selected_uids)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\run.py", line 451, in before_run
    self.populate_adapter_cache(adapter, required_schemas)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 440, in populate_adapter_cache
    adapter.set_relations_cache(self.manifest)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\impl.py", line 519, in set_relations_cache
    self._relations_cache_for_schemas(manifest, required_schemas)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\impl.py", line 495, in _relations_cache_for_schemas
    for relation in future.result():
                    ^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\_base.py", line 401, in __get_result
    raise self._exception
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\thread.py", line 58, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\utils.py", line 471, in connected
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\mysql\impl.py", line 82, in list_relations_without_caching
    relation = self.Relation.create(schema=_schema, identifier=name, type=relation_type)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\relation.py", line 299, in create
    return cls.from_dict(kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 19, in __mashumaro_from_dict__
mashumaro.exceptions.InvalidFieldValue: Field "type" of type Optional[RelationType] in MySQLRelation has invalid value "bytearray(b'view')"

[0m17:06:04.203210 [debug] [MainThread]: Command `dbt run` failed at 17:06:04.203210 after 9.04 seconds
[0m17:06:04.204207 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F7924E7250>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F793648190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F78C661790>]}
[0m17:06:04.205204 [debug] [MainThread]: Flushing usage events
[0m17:07:18.296305 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015402E91750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015402EE3950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015402EE38D0>]}


============================== 17:07:18.304286 | 50a97822-b61e-442f-ba8e-e2c0907399cf ==============================
[0m17:07:18.304286 [info ] [MainThread]: Running with dbt=1.7.17
[0m17:07:18.306277 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'invocation_command': 'dbt run --models Tactical_clicks_months_12.sql', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:07:18.595517 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '50a97822-b61e-442f-ba8e-e2c0907399cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001540308A7D0>]}
[0m17:07:18.680290 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '50a97822-b61e-442f-ba8e-e2c0907399cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015402EB8510>]}
[0m17:07:18.682861 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m17:07:18.693834 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m17:07:18.717932 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m17:07:18.718931 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '50a97822-b61e-442f-ba8e-e2c0907399cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015403267350>]}
[0m17:07:20.442320 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example
[0m17:07:20.452294 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '50a97822-b61e-442f-ba8e-e2c0907399cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154033914D0>]}
[0m17:07:20.472240 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '50a97822-b61e-442f-ba8e-e2c0907399cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001540314C750>]}
[0m17:07:20.474236 [info ] [MainThread]: Found 16 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m17:07:20.475233 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '50a97822-b61e-442f-ba8e-e2c0907399cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015403206A50>]}
[0m17:07:20.478227 [info ] [MainThread]: 
[0m17:07:20.480220 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m17:07:20.483211 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m17:07:20.496175 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m17:07:20.497174 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m17:07:20.498171 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:07:22.072261 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m17:07:22.077243 [debug] [ThreadPool]: On list_schemas: Close
[0m17:07:22.079478 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__prod)
[0m17:07:22.080479 [debug] [ThreadPool]: Creating schema "schema: "prod"
"
[0m17:07:22.087460 [debug] [ThreadPool]: Using mysql connection "create__prod"
[0m17:07:22.088460 [debug] [ThreadPool]: On create__prod: BEGIN
[0m17:07:22.088460 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:07:23.696364 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m17:07:23.699365 [debug] [ThreadPool]: Using mysql connection "create__prod"
[0m17:07:23.701359 [debug] [ThreadPool]: On create__prod: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "create__prod"} */
create schema if not exists `prod`
[0m17:07:24.340771 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m17:07:24.345776 [debug] [ThreadPool]: On create__prod: COMMIT
[0m17:07:24.346763 [debug] [ThreadPool]: Using mysql connection "create__prod"
[0m17:07:24.347760 [debug] [ThreadPool]: On create__prod: COMMIT
[0m17:07:24.959009 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m17:07:24.962012 [debug] [ThreadPool]: On create__prod: Close
[0m17:07:24.973056 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_prod'
[0m17:07:24.991005 [debug] [ThreadPool]: Using mysql connection "list_None_prod"
[0m17:07:24.992999 [debug] [ThreadPool]: On list_None_prod: BEGIN
[0m17:07:24.993998 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:07:26.560363 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m17:07:26.563386 [debug] [ThreadPool]: Using mysql connection "list_None_prod"
[0m17:07:26.565381 [debug] [ThreadPool]: On list_None_prod: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_None_prod"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'prod'
  
[0m17:07:27.161429 [debug] [ThreadPool]: SQL status: SUCCESS 144 in 1.0 seconds
[0m17:07:27.172401 [debug] [ThreadPool]: On list_None_prod: ROLLBACK
[0m17:07:27.368562 [debug] [ThreadPool]: On list_None_prod: Close
[0m17:07:27.372557 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:07:27.373554 [debug] [MainThread]: Connection 'create__prod' was properly closed.
[0m17:07:27.374553 [debug] [MainThread]: Connection 'list_None_prod' was properly closed.
[0m17:07:27.376547 [info ] [MainThread]: 
[0m17:07:27.377544 [info ] [MainThread]: Finished running  in 0 hours 0 minutes and 6.90 seconds (6.90s).
[0m17:07:27.380536 [error] [MainThread]: Encountered an error:
Field "type" of type Optional[RelationType] in MySQLRelation has invalid value "bytearray(b'view')"
[0m17:07:27.394499 [error] [MainThread]: Traceback (most recent call last):
  File "<string>", line 17, in __mashumaro_from_dict__
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\dataclass_schema.py", line 156, in _deserialize
    return cls(value)
           ^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\enum.py", line 695, in __call__
    return cls.__new__(cls, value)
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\enum.py", line 1111, in __new__
    raise ve_exc
ValueError: "bytearray(b'view')" is not a valid RelationType

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 91, in wrapper
    result, success = func(*args, **kwargs)
                      ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 76, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 169, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 198, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 245, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 278, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\main.py", line 626, in run
    results = task.run()
              ^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 502, in run
    result = self.execute_with_hooks(selected_uids)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 462, in execute_with_hooks
    self.before_run(adapter, selected_uids)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\run.py", line 451, in before_run
    self.populate_adapter_cache(adapter, required_schemas)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 440, in populate_adapter_cache
    adapter.set_relations_cache(self.manifest)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\impl.py", line 519, in set_relations_cache
    self._relations_cache_for_schemas(manifest, required_schemas)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\impl.py", line 495, in _relations_cache_for_schemas
    for relation in future.result():
                    ^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\_base.py", line 401, in __get_result
    raise self._exception
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\thread.py", line 58, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\utils.py", line 471, in connected
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\mysql\impl.py", line 82, in list_relations_without_caching
    relation = self.Relation.create(schema=_schema, identifier=name, type=relation_type)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\relation.py", line 299, in create
    return cls.from_dict(kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 19, in __mashumaro_from_dict__
mashumaro.exceptions.InvalidFieldValue: Field "type" of type Optional[RelationType] in MySQLRelation has invalid value "bytearray(b'view')"

[0m17:07:27.398487 [debug] [MainThread]: Command `dbt run` failed at 17:07:27.398487 after 9.22 seconds
[0m17:07:27.400482 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015402ECFC90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154022C7090>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001540335BD90>]}
[0m17:07:27.401478 [debug] [MainThread]: Flushing usage events
[0m17:09:44.845542 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D236330890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2363310D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D236330850>]}


============================== 17:09:44.851527 | 58e38f9a-60e4-4f8a-ad91-477f14fe63c1 ==============================
[0m17:09:44.851527 [info ] [MainThread]: Running with dbt=1.7.17
[0m17:09:44.852524 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt compile', 'send_anonymous_usage_stats': 'True'}
[0m17:09:45.132316 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '58e38f9a-60e4-4f8a-ad91-477f14fe63c1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D23656AB50>]}
[0m17:09:45.209110 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '58e38f9a-60e4-4f8a-ad91-477f14fe63c1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D23636DD10>]}
[0m17:09:45.211982 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m17:09:45.223792 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m17:09:45.334491 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m17:09:45.335488 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m17:09:45.336487 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example
[0m17:09:45.344809 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '58e38f9a-60e4-4f8a-ad91-477f14fe63c1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2363B36D0>]}
[0m17:09:45.366752 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '58e38f9a-60e4-4f8a-ad91-477f14fe63c1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D23665FC90>]}
[0m17:09:45.367749 [info ] [MainThread]: Found 16 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m17:09:45.368749 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '58e38f9a-60e4-4f8a-ad91-477f14fe63c1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2365A2690>]}
[0m17:09:45.371739 [info ] [MainThread]: 
[0m17:09:45.374216 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m17:09:45.377224 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_prod'
[0m17:09:45.391166 [debug] [ThreadPool]: Using mysql connection "list_None_prod"
[0m17:09:45.392165 [debug] [ThreadPool]: On list_None_prod: BEGIN
[0m17:09:45.393160 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:09:47.060682 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m17:09:47.063682 [debug] [ThreadPool]: Using mysql connection "list_None_prod"
[0m17:09:47.065680 [debug] [ThreadPool]: On list_None_prod: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_None_prod"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'prod'
  
[0m17:09:47.663696 [debug] [ThreadPool]: SQL status: SUCCESS 144 in 1.0 seconds
[0m17:09:47.667710 [debug] [ThreadPool]: On list_None_prod: ROLLBACK
[0m17:09:47.880546 [debug] [ThreadPool]: On list_None_prod: Close
[0m17:09:47.885540 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:09:47.886534 [debug] [MainThread]: Connection 'list_None_prod' was properly closed.
[0m17:09:47.887532 [error] [MainThread]: Encountered an error:
Field "type" of type Optional[RelationType] in MySQLRelation has invalid value "bytearray(b'view')"
[0m17:09:47.895512 [error] [MainThread]: Traceback (most recent call last):
  File "<string>", line 17, in __mashumaro_from_dict__
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\dataclass_schema.py", line 156, in _deserialize
    return cls(value)
           ^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\enum.py", line 695, in __call__
    return cls.__new__(cls, value)
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\enum.py", line 1111, in __new__
    raise ve_exc
ValueError: "bytearray(b'view')" is not a valid RelationType

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 91, in wrapper
    result, success = func(*args, **kwargs)
                      ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 76, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 169, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 198, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 245, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 278, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\main.py", line 372, in compile
    results = task.run()
              ^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 502, in run
    result = self.execute_with_hooks(selected_uids)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 462, in execute_with_hooks
    self.before_run(adapter, selected_uids)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 449, in before_run
    self.populate_adapter_cache(adapter)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 440, in populate_adapter_cache
    adapter.set_relations_cache(self.manifest)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\impl.py", line 519, in set_relations_cache
    self._relations_cache_for_schemas(manifest, required_schemas)
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\impl.py", line 495, in _relations_cache_for_schemas
    for relation in future.result():
                    ^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\_base.py", line 401, in __get_result
    raise self._exception
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\thread.py", line 58, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\utils.py", line 471, in connected
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\mysql\impl.py", line 82, in list_relations_without_caching
    relation = self.Relation.create(schema=_schema, identifier=name, type=relation_type)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Test\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\relation.py", line 299, in create
    return cls.from_dict(kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 19, in __mashumaro_from_dict__
mashumaro.exceptions.InvalidFieldValue: Field "type" of type Optional[RelationType] in MySQLRelation has invalid value "bytearray(b'view')"

[0m17:09:47.899142 [debug] [MainThread]: Command `dbt compile` failed at 17:09:47.899142 after 3.14 seconds
[0m17:09:47.900139 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D23638B690>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D23638B810>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D23638B6D0>]}
[0m17:09:47.901137 [debug] [MainThread]: Flushing usage events
[0m17:10:06.483850 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002880AEA01D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002880B3C8490>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002880B3C8B90>]}


============================== 17:10:06.489833 | cbca6e6d-72c5-4cc0-8209-3f02d512509a ==============================
[0m17:10:06.489833 [info ] [MainThread]: Running with dbt=1.7.17
[0m17:10:06.491829 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'debug': 'False', 'version_check': 'True', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt compile', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m17:10:06.757372 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'cbca6e6d-72c5-4cc0-8209-3f02d512509a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002880B406690>]}
[0m17:10:06.841148 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'cbca6e6d-72c5-4cc0-8209-3f02d512509a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002880A7EA350>]}
[0m17:10:06.843204 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m17:10:06.855176 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m17:10:06.869141 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m17:10:06.870136 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'cbca6e6d-72c5-4cc0-8209-3f02d512509a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002880B793310>]}
[0m17:10:08.427968 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example
[0m17:10:08.436945 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'cbca6e6d-72c5-4cc0-8209-3f02d512509a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002880B773850>]}
[0m17:10:08.461876 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'cbca6e6d-72c5-4cc0-8209-3f02d512509a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002880B5EAD10>]}
[0m17:10:08.462875 [info ] [MainThread]: Found 16 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m17:10:08.463872 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cbca6e6d-72c5-4cc0-8209-3f02d512509a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002880B434D10>]}
[0m17:10:08.468860 [info ] [MainThread]: 
[0m17:10:08.470480 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m17:10:08.473748 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m17:10:08.489724 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m17:10:08.490702 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m17:10:08.490702 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:10:10.070467 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m17:10:10.073455 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m17:10:10.075450 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m17:10:10.674364 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m17:10:10.680340 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m17:10:10.878935 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m17:10:10.881424 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cbca6e6d-72c5-4cc0-8209-3f02d512509a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028806FCF610>]}
[0m17:10:10.882425 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m17:10:10.883422 [info ] [MainThread]: 
[0m17:10:10.889734 [debug] [Thread-1 (]: Began running node model.site_dev.Tactical_clicks_months_12
[0m17:10:10.890717 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.site_dev.Tactical_clicks_months_12'
[0m17:10:10.891714 [debug] [Thread-1 (]: Began compiling node model.site_dev.Tactical_clicks_months_12
[0m17:10:10.907670 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.Tactical_clicks_months_12"
[0m17:10:10.910661 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_clicks_months_12 (compile): 17:10:10.892712 => 17:10:10.909668
[0m17:10:10.911660 [debug] [Thread-1 (]: Began executing node model.site_dev.Tactical_clicks_months_12
[0m17:10:10.912658 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_clicks_months_12 (execute): 17:10:10.912658 => 17:10:10.912658
[0m17:10:10.914656 [debug] [Thread-1 (]: Finished running node model.site_dev.Tactical_clicks_months_12
[0m17:10:10.915651 [debug] [Thread-1 (]: Began running node model.site_dev.Tactical_clicks_ytd_12
[0m17:10:10.916660 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.site_dev.Tactical_clicks_months_12, now model.site_dev.Tactical_clicks_ytd_12)
[0m17:10:10.917645 [debug] [Thread-1 (]: Began compiling node model.site_dev.Tactical_clicks_ytd_12
[0m17:10:10.927619 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.Tactical_clicks_ytd_12"
[0m17:10:10.929611 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_clicks_ytd_12 (compile): 17:10:10.918658 => 17:10:10.928614
[0m17:10:10.930608 [debug] [Thread-1 (]: Began executing node model.site_dev.Tactical_clicks_ytd_12
[0m17:10:10.931605 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_clicks_ytd_12 (execute): 17:10:10.931605 => 17:10:10.931605
[0m17:10:10.933602 [debug] [Thread-1 (]: Finished running node model.site_dev.Tactical_clicks_ytd_12
[0m17:10:10.934599 [debug] [Thread-1 (]: Began running node model.site_dev.Tactical_pageviews_card_month_12
[0m17:10:10.935598 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.site_dev.Tactical_clicks_ytd_12, now model.site_dev.Tactical_pageviews_card_month_12)
[0m17:10:10.936595 [debug] [Thread-1 (]: Began compiling node model.site_dev.Tactical_pageviews_card_month_12
[0m17:10:10.945569 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.Tactical_pageviews_card_month_12"
[0m17:10:10.947563 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_pageviews_card_month_12 (compile): 17:10:10.937592 => 17:10:10.946565
[0m17:10:10.948561 [debug] [Thread-1 (]: Began executing node model.site_dev.Tactical_pageviews_card_month_12
[0m17:10:10.949560 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_pageviews_card_month_12 (execute): 17:10:10.948561 => 17:10:10.948561
[0m17:10:10.950557 [debug] [Thread-1 (]: Finished running node model.site_dev.Tactical_pageviews_card_month_12
[0m17:10:10.951554 [debug] [Thread-1 (]: Began running node model.site_dev.Tactical_pageviews_card_ytd_12
[0m17:10:10.953549 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.site_dev.Tactical_pageviews_card_month_12, now model.site_dev.Tactical_pageviews_card_ytd_12)
[0m17:10:10.954546 [debug] [Thread-1 (]: Began compiling node model.site_dev.Tactical_pageviews_card_ytd_12
[0m17:10:10.962525 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.Tactical_pageviews_card_ytd_12"
[0m17:10:10.964518 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_pageviews_card_ytd_12 (compile): 17:10:10.954546 => 17:10:10.964518
[0m17:10:10.965517 [debug] [Thread-1 (]: Began executing node model.site_dev.Tactical_pageviews_card_ytd_12
[0m17:10:10.966513 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_pageviews_card_ytd_12 (execute): 17:10:10.966513 => 17:10:10.966513
[0m17:10:10.968508 [debug] [Thread-1 (]: Finished running node model.site_dev.Tactical_pageviews_card_ytd_12
[0m17:10:10.969506 [debug] [Thread-1 (]: Began running node model.site_dev.cards
[0m17:10:10.970503 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.site_dev.Tactical_pageviews_card_ytd_12, now model.site_dev.cards)
[0m17:10:10.971500 [debug] [Thread-1 (]: Began compiling node model.site_dev.cards
[0m17:10:10.980477 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.cards"
[0m17:10:10.982470 [debug] [Thread-1 (]: Timing info for model.site_dev.cards (compile): 17:10:10.972498 => 17:10:10.981473
[0m17:10:10.983468 [debug] [Thread-1 (]: Began executing node model.site_dev.cards
[0m17:10:10.984465 [debug] [Thread-1 (]: Timing info for model.site_dev.cards (execute): 17:10:10.983468 => 17:10:10.983468
[0m17:10:10.985469 [debug] [Thread-1 (]: Finished running node model.site_dev.cards
[0m17:10:10.986460 [debug] [Thread-1 (]: Began running node model.site_dev.example_by
[0m17:10:10.987458 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.site_dev.cards, now model.site_dev.example_by)
[0m17:10:10.988455 [debug] [Thread-1 (]: Began compiling node model.site_dev.example_by
[0m17:10:10.992445 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.example_by"
[0m17:10:10.994439 [debug] [Thread-1 (]: Timing info for model.site_dev.example_by (compile): 17:10:10.989453 => 17:10:10.993440
[0m17:10:10.995436 [debug] [Thread-1 (]: Began executing node model.site_dev.example_by
[0m17:10:10.996433 [debug] [Thread-1 (]: Timing info for model.site_dev.example_by (execute): 17:10:10.996433 => 17:10:10.996433
[0m17:10:10.998444 [debug] [Thread-1 (]: Finished running node model.site_dev.example_by
[0m17:10:10.999425 [debug] [Thread-1 (]: Began running node model.site_dev.example_by_me
[0m17:10:11.000425 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.site_dev.example_by, now model.site_dev.example_by_me)
[0m17:10:11.001420 [debug] [Thread-1 (]: Began compiling node model.site_dev.example_by_me
[0m17:10:11.004411 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.example_by_me"
[0m17:10:11.011426 [debug] [Thread-1 (]: Timing info for model.site_dev.example_by_me (compile): 17:10:11.001420 => 17:10:11.010419
[0m17:10:11.012423 [debug] [Thread-1 (]: Began executing node model.site_dev.example_by_me
[0m17:10:11.013420 [debug] [Thread-1 (]: Timing info for model.site_dev.example_by_me (execute): 17:10:11.013420 => 17:10:11.013420
[0m17:10:11.015416 [debug] [Thread-1 (]: Finished running node model.site_dev.example_by_me
[0m17:10:11.016412 [debug] [Thread-1 (]: Began running node model.site_dev.overview_sales_card_12
[0m17:10:11.017411 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.site_dev.example_by_me, now model.site_dev.overview_sales_card_12)
[0m17:10:11.018414 [debug] [Thread-1 (]: Began compiling node model.site_dev.overview_sales_card_12
[0m17:10:11.027168 [debug] [Thread-1 (]: Timing info for model.site_dev.overview_sales_card_12 (compile): 17:10:11.018414 => 17:10:11.026168
[0m17:10:11.110974 [debug] [Thread-1 (]: Compilation Error in model overview_sales_card_12 (models\example\overview_sales_card_12.sql)
  Required var 'json' not found in config:
  Vars supplied to overview_sales_card_12 = {
      "article_evaluation": {
          "over_both_goals": {
              "case": "((coalesce(coalesce(l.hits,0)/coalesce(l.pageviews,0)*100,0))>=coalesce(g.Min_CTA,0) and coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0) )",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          },
          "under_both_goal": {
              "case": "(coalesce((coalesce(l.hits,0)/coalesce(l.pageviews,0)*100),0)<coalesce(g.Min_CTA,0) and coalesce(l.pageviews,0)<coalesce(g.Min_pageviews,0) )",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          },
          "under_one_goal": {
              "case": "(coalesce( coalesce((coalesce(l.hits,0) / coalesce(l.pageviews,0)),0) * 100 , 0)>=coalesce(g.Min_CTA,0) or coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0)) and !((coalesce( coalesce((coalesce(l.hits,0) / coalesce(l.pageviews,0)),0) * 100 , 0))>=coalesce(g.Min_CTA,0) and  coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0) ) ",
              "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
              "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
          }
      },
      "date_month": "DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)",
      "date_month_before": "DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) ",
      "date_week": "DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)",
      "date_year": "MAKEDATE(EXTRACT(YEAR FROM CURDATE()), 1) AND DATE_SUB(CAST(NOW() AS DATE), INTERVAL 1 DAY)",
      "date_year_before": "DATE_SUB(MAKEDATE(EXTRACT(YEAR FROM CURDATE()),1), INTERVAL 1 Year) and  DATE_SUB(DATE_SUB(cast(NOW() as date), INTERVAL 1 DAY),INTERVAL 1 Year)",
      "event_action": "Next Click",
      "overview": {
          "overview_pageviews_card": {
              "hint": "Sidevisninger \u00e5r til dato ift sidste \u00e5r til dato og ift m\u00e5ls\u00e6tning",
              "label": "Sidevisninger"
          },
          "overview_sales_card": {
              "hint": "Gns. next click \u00e5r til dato ift. sidste \u00e5r",
              "label": "Next click (%)"
          },
          "overview_visits_card": {
              "hint": "Bes\u00f8g \u00e5r til dato ift sidste \u00e5r til dato og ift m\u00e5ls\u00e6tning",
              "label": "Bes\u00f8g"
          }
      },
      "site": 12,
      "tendency": {
          "tactical_articles_card": {
              "hint": "Artikler publiceret seneste 30 dage ift. forrige 30 dage",
              "label": "Artikler"
          },
          "tactical_clicks_card": {
              "hint": "Gns. next click p\u00e5 artikler publiceret seneste 30 dage ift. forrige 30 dage",
              "label": "Gns. next click (%)"
          },
          "tactical_pageviews_card": {
              "hint": "Gns. sidevisninger pr artikler publiceret \u00e5r til dato ift. sidste \u00e5r til dato",
              "label": "Gns. sidevisninger pr artikel"
          },
          "tactical_userneeds_pageviews_chart": {
              "dropdown_count": [
                  "",
                  "_second",
                  "_third"
              ],
              "dropdown_name": {
                  "Categories": "Categories",
                  "Tags": "Tags",
                  "userneeds": "userneeds"
              },
              "dropdown_val": {
                  "categories": [
                      "Nyheder",
                      "Debat",
                      "Inspiration",
                      "Anmeldelser"
                  ],
                  "tags": [
                      "skolepolitik",
                      "Psykisk arbejdsmilj\u00f8"
                  ],
                  "userneeds": [
                      "Opdater mig",
                      "Forbind mig",
                      "Hj\u00e6lp mig med at forst\u00e5",
                      "Giv mig en fordel",
                      "Underhold mig",
                      "Inspirer mig"
                  ]
              },
              "hint": "Artikler grupperet ift hvordan de har performet p\u00e5 next click",
              "label": "Artikler ift. next click m\u00e5l"
          }
      }
  }
[0m17:10:11.112970 [debug] [Thread-1 (]: Finished running node model.site_dev.overview_sales_card_12
[0m17:10:11.113966 [debug] [Thread-1 (]: Began running node model.site_dev.tactical_articles_card_month_12
[0m17:10:11.115961 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.site_dev.overview_sales_card_12, now model.site_dev.tactical_articles_card_month_12)
[0m17:10:11.116958 [debug] [Thread-1 (]: Began compiling node model.site_dev.tactical_articles_card_month_12
[0m17:10:11.121945 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.tactical_articles_card_month_12"
[0m17:10:11.124886 [debug] [Thread-1 (]: Timing info for model.site_dev.tactical_articles_card_month_12 (compile): 17:10:11.117957 => 17:10:11.123885
[0m17:10:11.124886 [debug] [Thread-1 (]: Began executing node model.site_dev.tactical_articles_card_month_12
[0m17:10:11.125883 [debug] [Thread-1 (]: Timing info for model.site_dev.tactical_articles_card_month_12 (execute): 17:10:11.125883 => 17:10:11.125883
[0m17:10:11.127878 [debug] [Thread-1 (]: Finished running node model.site_dev.tactical_articles_card_month_12
[0m17:10:11.128876 [debug] [Thread-1 (]: Began running node model.site_dev.tactical_articles_card_year_12_test_dbt
[0m17:10:11.129875 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.site_dev.tactical_articles_card_month_12, now model.site_dev.tactical_articles_card_year_12_test_dbt)
[0m17:10:11.130869 [debug] [Thread-1 (]: Began compiling node model.site_dev.tactical_articles_card_year_12_test_dbt
[0m17:10:11.137851 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.tactical_articles_card_year_12_test_dbt"
[0m17:10:11.139846 [debug] [Thread-1 (]: Timing info for model.site_dev.tactical_articles_card_year_12_test_dbt (compile): 17:10:11.130869 => 17:10:11.138850
[0m17:10:11.139846 [debug] [Thread-1 (]: Began executing node model.site_dev.tactical_articles_card_year_12_test_dbt
[0m17:10:11.141841 [debug] [Thread-1 (]: Timing info for model.site_dev.tactical_articles_card_year_12_test_dbt (execute): 17:10:11.140844 => 17:10:11.140844
[0m17:10:11.142838 [debug] [Thread-1 (]: Finished running node model.site_dev.tactical_articles_card_year_12_test_dbt
[0m17:10:11.143837 [debug] [Thread-1 (]: Began running node model.site_dev.tactical_articles_cards
[0m17:10:11.144831 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.site_dev.tactical_articles_card_year_12_test_dbt, now model.site_dev.tactical_articles_cards)
[0m17:10:11.145830 [debug] [Thread-1 (]: Began compiling node model.site_dev.tactical_articles_cards
[0m17:10:11.151833 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.tactical_articles_cards"
[0m17:10:11.153810 [debug] [Thread-1 (]: Timing info for model.site_dev.tactical_articles_cards (compile): 17:10:11.146827 => 17:10:11.152810
[0m17:10:11.154806 [debug] [Thread-1 (]: Began executing node model.site_dev.tactical_articles_cards
[0m17:10:11.155803 [debug] [Thread-1 (]: Timing info for model.site_dev.tactical_articles_cards (execute): 17:10:11.154806 => 17:10:11.154806
[0m17:10:11.156800 [debug] [Thread-1 (]: Finished running node model.site_dev.tactical_articles_cards
[0m17:10:11.157797 [debug] [Thread-1 (]: Began running node model.site_dev.tactical_userneeds_pageviews_chart
[0m17:10:11.160792 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.site_dev.tactical_articles_cards, now model.site_dev.tactical_userneeds_pageviews_chart)
[0m17:10:11.161789 [debug] [Thread-1 (]: Began compiling node model.site_dev.tactical_userneeds_pageviews_chart
[0m17:10:11.179741 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.tactical_userneeds_pageviews_chart"
[0m17:10:11.183728 [debug] [Thread-1 (]: Timing info for model.site_dev.tactical_userneeds_pageviews_chart (compile): 17:10:11.162819 => 17:10:11.183728
[0m17:10:11.185724 [debug] [Thread-1 (]: Began executing node model.site_dev.tactical_userneeds_pageviews_chart
[0m17:10:11.187717 [debug] [Thread-1 (]: Timing info for model.site_dev.tactical_userneeds_pageviews_chart (execute): 17:10:11.186721 => 17:10:11.186721
[0m17:10:11.189711 [debug] [Thread-1 (]: Finished running node model.site_dev.tactical_userneeds_pageviews_chart
[0m17:10:11.189711 [debug] [Thread-1 (]: Began running node model.site_dev.tactical_userneeds_pageviews_chart_month_13
[0m17:10:11.191706 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.site_dev.tactical_userneeds_pageviews_chart, now model.site_dev.tactical_userneeds_pageviews_chart_month_13)
[0m17:10:11.191706 [debug] [Thread-1 (]: Began compiling node model.site_dev.tactical_userneeds_pageviews_chart_month_13
[0m17:10:11.219632 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.tactical_userneeds_pageviews_chart_month_13"
[0m17:10:11.221627 [debug] [Thread-1 (]: Timing info for model.site_dev.tactical_userneeds_pageviews_chart_month_13 (compile): 17:10:11.192704 => 17:10:11.220630
[0m17:10:11.222624 [debug] [Thread-1 (]: Began executing node model.site_dev.tactical_userneeds_pageviews_chart_month_13
[0m17:10:11.223622 [debug] [Thread-1 (]: Timing info for model.site_dev.tactical_userneeds_pageviews_chart_month_13 (execute): 17:10:11.223622 => 17:10:11.223622
[0m17:10:11.225616 [debug] [Thread-1 (]: Finished running node model.site_dev.tactical_userneeds_pageviews_chart_month_13
[0m17:10:11.226613 [debug] [Thread-1 (]: Began running node model.site_dev.tactical_userneeds_pageviews_chart_month_13.sql_output
[0m17:10:11.227611 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.site_dev.tactical_userneeds_pageviews_chart_month_13, now model.site_dev.tactical_userneeds_pageviews_chart_month_13.sql_output)
[0m17:10:11.229607 [debug] [Thread-1 (]: Began compiling node model.site_dev.tactical_userneeds_pageviews_chart_month_13.sql_output
[0m17:10:11.236587 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.tactical_userneeds_pageviews_chart_month_13.sql_output"
[0m17:10:11.238363 [debug] [Thread-1 (]: Timing info for model.site_dev.tactical_userneeds_pageviews_chart_month_13.sql_output (compile): 17:10:11.230604 => 17:10:11.238363
[0m17:10:11.240363 [debug] [Thread-1 (]: Began executing node model.site_dev.tactical_userneeds_pageviews_chart_month_13.sql_output
[0m17:10:11.241360 [debug] [Thread-1 (]: Timing info for model.site_dev.tactical_userneeds_pageviews_chart_month_13.sql_output (execute): 17:10:11.240363 => 17:10:11.240363
[0m17:10:11.242357 [debug] [Thread-1 (]: Finished running node model.site_dev.tactical_userneeds_pageviews_chart_month_13.sql_output
[0m17:10:11.243355 [debug] [Thread-1 (]: Began running node model.site_dev.test
[0m17:10:11.244353 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.site_dev.tactical_userneeds_pageviews_chart_month_13.sql_output, now model.site_dev.test)
[0m17:10:11.245350 [debug] [Thread-1 (]: Began compiling node model.site_dev.test
[0m17:10:11.269285 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.test"
[0m17:10:11.271281 [debug] [Thread-1 (]: Timing info for model.site_dev.test (compile): 17:10:11.246347 => 17:10:11.270283
[0m17:10:11.272278 [debug] [Thread-1 (]: Began executing node model.site_dev.test
[0m17:10:11.273275 [debug] [Thread-1 (]: Timing info for model.site_dev.test (execute): 17:10:11.272278 => 17:10:11.272278
[0m17:10:11.274272 [debug] [Thread-1 (]: Finished running node model.site_dev.test
[0m17:10:11.275270 [debug] [Thread-1 (]: Began running node model.site_dev.test_by
[0m17:10:11.276268 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.site_dev.test, now model.site_dev.test_by)
[0m17:10:11.278260 [debug] [Thread-1 (]: Began compiling node model.site_dev.test_by
[0m17:10:11.307183 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.test_by"
[0m17:10:11.310176 [debug] [Thread-1 (]: Timing info for model.site_dev.test_by (compile): 17:10:11.279258 => 17:10:11.309186
[0m17:10:11.311171 [debug] [Thread-1 (]: Began executing node model.site_dev.test_by
[0m17:10:11.313167 [debug] [Thread-1 (]: Timing info for model.site_dev.test_by (execute): 17:10:11.312169 => 17:10:11.312169
[0m17:10:11.316159 [debug] [Thread-1 (]: Finished running node model.site_dev.test_by
[0m17:10:11.317155 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:10:11.318156 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m17:10:11.319154 [debug] [MainThread]: Connection 'model.site_dev.test_by' was properly closed.
[0m17:10:11.320147 [error] [MainThread]: Encountered an error:
Runtime Error
  Compilation Error in model overview_sales_card_12 (models\example\overview_sales_card_12.sql)
    Required var 'json' not found in config:
    Vars supplied to overview_sales_card_12 = {
        "article_evaluation": {
            "over_both_goals": {
                "case": "((coalesce(coalesce(l.hits,0)/coalesce(l.pageviews,0)*100,0))>=coalesce(g.Min_CTA,0) and coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0) )",
                "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
                "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
            },
            "under_both_goal": {
                "case": "(coalesce((coalesce(l.hits,0)/coalesce(l.pageviews,0)*100),0)<coalesce(g.Min_CTA,0) and coalesce(l.pageviews,0)<coalesce(g.Min_pageviews,0) )",
                "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
                "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
            },
            "under_one_goal": {
                "case": "(coalesce( coalesce((coalesce(l.hits,0) / coalesce(l.pageviews,0)),0) * 100 , 0)>=coalesce(g.Min_CTA,0) or coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0)) and !((coalesce( coalesce((coalesce(l.hits,0) / coalesce(l.pageviews,0)),0) * 100 , 0))>=coalesce(g.Min_CTA,0) and  coalesce(l.pageviews,0)>=coalesce(g.Min_pageviews,0) ) ",
                "hint": "Artikler publiceret \u00e5r til dato, der n\u00e5r \u00e9t af m\u00e5lene",
                "label": "Artikler over p\u00e5 \u00e9t af m\u00e5lene"
            }
        },
        "date_month": "DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)",
        "date_month_before": "DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) ",
        "date_week": "DATE_SUB(NOW(), INTERVAL 8 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)",
        "date_year": "MAKEDATE(EXTRACT(YEAR FROM CURDATE()), 1) AND DATE_SUB(CAST(NOW() AS DATE), INTERVAL 1 DAY)",
        "date_year_before": "DATE_SUB(MAKEDATE(EXTRACT(YEAR FROM CURDATE()),1), INTERVAL 1 Year) and  DATE_SUB(DATE_SUB(cast(NOW() as date), INTERVAL 1 DAY),INTERVAL 1 Year)",
        "event_action": "Next Click",
        "overview": {
            "overview_pageviews_card": {
                "hint": "Sidevisninger \u00e5r til dato ift sidste \u00e5r til dato og ift m\u00e5ls\u00e6tning",
                "label": "Sidevisninger"
            },
            "overview_sales_card": {
                "hint": "Gns. next click \u00e5r til dato ift. sidste \u00e5r",
                "label": "Next click (%)"
            },
            "overview_visits_card": {
                "hint": "Bes\u00f8g \u00e5r til dato ift sidste \u00e5r til dato og ift m\u00e5ls\u00e6tning",
                "label": "Bes\u00f8g"
            }
        },
        "site": 12,
        "tendency": {
            "tactical_articles_card": {
                "hint": "Artikler publiceret seneste 30 dage ift. forrige 30 dage",
                "label": "Artikler"
            },
            "tactical_clicks_card": {
                "hint": "Gns. next click p\u00e5 artikler publiceret seneste 30 dage ift. forrige 30 dage",
                "label": "Gns. next click (%)"
            },
            "tactical_pageviews_card": {
                "hint": "Gns. sidevisninger pr artikler publiceret \u00e5r til dato ift. sidste \u00e5r til dato",
                "label": "Gns. sidevisninger pr artikel"
            },
            "tactical_userneeds_pageviews_chart": {
                "dropdown_count": [
                    "",
                    "_second",
                    "_third"
                ],
                "dropdown_name": {
                    "Categories": "Categories",
                    "Tags": "Tags",
                    "userneeds": "userneeds"
                },
                "dropdown_val": {
                    "categories": [
                        "Nyheder",
                        "Debat",
                        "Inspiration",
                        "Anmeldelser"
                    ],
                    "tags": [
                        "skolepolitik",
                        "Psykisk arbejdsmilj\u00f8"
                    ],
                    "userneeds": [
                        "Opdater mig",
                        "Forbind mig",
                        "Hj\u00e6lp mig med at forst\u00e5",
                        "Giv mig en fordel",
                        "Underhold mig",
                        "Inspirer mig"
                    ]
                },
                "hint": "Artikler grupperet ift hvordan de har performet p\u00e5 next click",
                "label": "Artikler ift. next click m\u00e5l"
            }
        }
    }
[0m17:10:11.328128 [debug] [MainThread]: Command `dbt compile` failed at 17:10:11.328128 after 4.94 seconds
[0m17:10:11.332116 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002880B005390>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002880B96DD90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002880B5CEA50>]}
[0m17:10:11.333113 [debug] [MainThread]: Flushing usage events
[0m18:25:01.297568 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A5711D0ED0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A5711D3190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A5711D07D0>]}


============================== 18:25:01.303555 | 414ed53c-c4b2-4215-842d-5135dfd59c8a ==============================
[0m18:25:01.303555 [info ] [MainThread]: Running with dbt=1.7.17
[0m18:25:01.306547 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --models Tactical_clicks_months_12.sql', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:25:01.622403 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '414ed53c-c4b2-4215-842d-5135dfd59c8a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A57141B9D0>]}
[0m18:25:01.710167 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '414ed53c-c4b2-4215-842d-5135dfd59c8a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A57120DE50>]}
[0m18:25:01.712576 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m18:25:01.725546 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m18:25:01.750156 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m18:25:01.751154 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '414ed53c-c4b2-4215-842d-5135dfd59c8a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A57149FE50>]}
[0m18:25:03.690967 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example
[0m18:25:03.698945 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '414ed53c-c4b2-4215-842d-5135dfd59c8a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A57149C710>]}
[0m18:25:03.719888 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '414ed53c-c4b2-4215-842d-5135dfd59c8a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A57152C690>]}
[0m18:25:03.720884 [info ] [MainThread]: Found 16 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m18:25:03.721883 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '414ed53c-c4b2-4215-842d-5135dfd59c8a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A5714AFD90>]}
[0m18:25:03.724874 [info ] [MainThread]: 
[0m18:25:03.726869 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m18:25:03.729863 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m18:25:03.744823 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m18:25:03.745818 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m18:25:03.746816 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:25:05.375315 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m18:25:05.377315 [debug] [ThreadPool]: On list_schemas: Close
[0m18:25:05.379310 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m18:25:05.381305 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m18:25:05.388284 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m18:25:05.389283 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m18:25:05.390320 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:25:06.934100 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m18:25:06.935099 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m18:25:06.937096 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m18:25:07.530197 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m18:25:07.534193 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m18:25:07.536188 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m18:25:07.537185 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m18:25:08.119343 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m18:25:08.119343 [debug] [ThreadPool]: On create__site_dev: Close
[0m18:25:08.123850 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m18:25:08.135823 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m18:25:08.136821 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m18:25:08.137816 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:25:09.989857 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m18:25:09.992856 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m18:25:09.995849 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m18:25:10.992760 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m18:25:10.999754 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m18:25:11.197668 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m18:25:11.203653 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '414ed53c-c4b2-4215-842d-5135dfd59c8a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A57170CE10>]}
[0m18:25:11.206641 [debug] [MainThread]: Using mysql connection "master"
[0m18:25:11.207641 [debug] [MainThread]: On master: BEGIN
[0m18:25:11.209632 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:25:13.345511 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m18:25:13.347510 [debug] [MainThread]: On master: COMMIT
[0m18:25:13.348505 [debug] [MainThread]: Using mysql connection "master"
[0m18:25:13.350502 [debug] [MainThread]: On master: COMMIT
[0m18:25:13.943218 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m18:25:13.944215 [debug] [MainThread]: On master: Close
[0m18:25:13.946213 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m18:25:13.947207 [info ] [MainThread]: 
[0m18:25:13.954188 [debug] [Thread-1 (]: Began running node model.site_dev.Tactical_clicks_months_12
[0m18:25:13.956184 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.Tactical_clicks_months_12 ................. [RUN]
[0m18:25:13.957181 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.site_dev.Tactical_clicks_months_12'
[0m18:25:13.959175 [debug] [Thread-1 (]: Began compiling node model.site_dev.Tactical_clicks_months_12
[0m18:25:13.985107 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.Tactical_clicks_months_12"
[0m18:25:14.002072 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_clicks_months_12 (compile): 18:25:13.960173 => 18:25:13.987101
[0m18:25:14.007047 [debug] [Thread-1 (]: Began executing node model.site_dev.Tactical_clicks_months_12
[0m18:25:14.128721 [debug] [Thread-1 (]: Writing runtime sql for node "model.site_dev.Tactical_clicks_months_12"
[0m18:25:14.132712 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_clicks_months_12"
[0m18:25:14.134706 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: BEGIN
[0m18:25:14.136700 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m18:25:15.836094 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m18:25:15.838086 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_clicks_months_12"
[0m18:25:15.840119 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "node_id": "model.site_dev.Tactical_clicks_months_12"} */

  create view `site_dev`.`Tactical_clicks_months_12__dbt_tmp`
    
    
  as (
    

-- 
-- 
-- 
DELIMITER //
CREATE PROCEDURE `Tactical_clicks_months_12_dbt_test`()
BEGIN
    WITH curr_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND categories <> "Nyhedsoverblik"
        AND siteid = '14'
    ),
    agg_curr_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks
        FROM prod.events e
        JOIN curr_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND e.siteid = '14'
        AND e.Event_Action = 'Next Click'
        GROUP BY 1
    ),
    agg_curr_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum
        FROM prod.pages p
        LEFT JOIN curr_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = '14'
        AND p.date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        GROUP BY p.siteid
    ),
    value_curr_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks / p.pageview_sum * 100, 2) AS value
        FROM agg_curr_30_days_events e
        LEFT JOIN agg_curr_30_days_pages p ON e.siteid = p.siteid
    ),
    last_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY)
        AND siteid = site
        AND categories <> "Nyhedsoverblik"
    ),
    agg_last_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks_last
        FROM prod.events e
        JOIN last_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY)
        AND e.siteid = '14'
        AND e.Event_Action = 'Next Click'
        GROUP BY 1
    ),
    agg_last_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum_last
        FROM prod.pages p
        LEFT JOIN last_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = '14'
        AND p.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY)
        GROUP BY p.siteid
    ),
    value_last_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks_last / p.pageview_sum_last * 100, 2) AS value_last
        FROM agg_last_30_days_events e
        LEFT JOIN agg_last_30_days_pages p ON e.siteid = p.siteid
    )
    SELECT 
        JSON_OBJECT(
            'site', al.siteid,
            'data', JSON_OBJECT(
            'label', 'Gns. next click (%)',
            'hint', 'Gns. next click på artikler publiceret seneste 30 dage ift. forrige 30 dage',
            'value', COALESCE(value, 0),
            'change', COALESCE(value - value_last, 0),
            'progressCurrent', '',
            'progressTotal', ''
            )
        ) AS json_data
    FROM value_curr_30_days al
    LEFT JOIN value_last_30_days alb ON al.siteid = alb.siteid
    WHERE al.siteid = '14';
END;
DELIMITER ;
  );
[0m18:25:16.602605 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'DELIMITER //
CREATE PROCEDURE `Tactical_clicks_months_12_dbt_test`()
BEGIN
    W' at line 12
[0m18:25:16.609588 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: ROLLBACK
[0m18:25:16.816573 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_clicks_months_12 (execute): 18:25:14.015044 => 18:25:16.814544
[0m18:25:16.819567 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: Close
[0m18:25:16.946216 [debug] [Thread-1 (]: Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'DELIMITER //
  CREATE PROCEDURE `Tactical_clicks_months_12_dbt_test`()
  BEGIN
      W' at line 12
  compiled Code at target\run\site_dev\models\example\Tactical_clicks_months_12.sql
[0m18:25:16.948211 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '414ed53c-c4b2-4215-842d-5135dfd59c8a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A571256450>]}
[0m18:25:16.949208 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.Tactical_clicks_months_12 ........ [[31mERROR[0m in 2.99s]
[0m18:25:16.951203 [debug] [Thread-1 (]: Finished running node model.site_dev.Tactical_clicks_months_12
[0m18:25:16.954196 [debug] [MainThread]: Using mysql connection "master"
[0m18:25:16.955193 [debug] [MainThread]: On master: BEGIN
[0m18:25:16.956203 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m18:25:19.032133 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m18:25:19.033130 [debug] [MainThread]: On master: COMMIT
[0m18:25:19.034126 [debug] [MainThread]: Using mysql connection "master"
[0m18:25:19.036120 [debug] [MainThread]: On master: COMMIT
[0m18:25:19.773836 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m18:25:19.774838 [debug] [MainThread]: On master: Close
[0m18:25:19.776833 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:25:19.777833 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m18:25:19.778830 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m18:25:19.779826 [debug] [MainThread]: Connection 'model.site_dev.Tactical_clicks_months_12' was properly closed.
[0m18:25:19.780823 [info ] [MainThread]: 
[0m18:25:19.782816 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 16.05 seconds (16.05s).
[0m18:25:19.784841 [debug] [MainThread]: Command end result
[0m18:25:19.802764 [info ] [MainThread]: 
[0m18:25:19.804760 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m18:25:19.805757 [info ] [MainThread]: 
[0m18:25:19.806754 [error] [MainThread]:   Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'DELIMITER //
  CREATE PROCEDURE `Tactical_clicks_months_12_dbt_test`()
  BEGIN
      W' at line 12
  compiled Code at target\run\site_dev\models\example\Tactical_clicks_months_12.sql
[0m18:25:19.806754 [info ] [MainThread]: 
[0m18:25:19.808747 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m18:25:19.810742 [debug] [MainThread]: Command `dbt run` failed at 18:25:19.810742 after 18.62 seconds
[0m18:25:19.811740 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A571227B50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A571224DD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A5714DDCD0>]}
[0m18:25:19.812736 [debug] [MainThread]: Flushing usage events
[0m18:25:27.236142 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E248638A90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E24863BF10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E2486383D0>]}


============================== 18:25:27.245121 | 3fca025c-d1ee-4f26-b969-d3efb54aa158 ==============================
[0m18:25:27.245121 [info ] [MainThread]: Running with dbt=1.7.17
[0m18:25:27.247114 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'debug': 'False', 'version_check': 'True', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --models Tactical_clicks_ytd_12.sql', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m18:25:27.586276 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3fca025c-d1ee-4f26-b969-d3efb54aa158', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E248834390>]}
[0m18:25:27.670051 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3fca025c-d1ee-4f26-b969-d3efb54aa158', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E24863A4D0>]}
[0m18:25:27.673043 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m18:25:27.685013 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m18:25:27.792967 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m18:25:27.793964 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m18:25:27.795959 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example
[0m18:25:27.804935 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3fca025c-d1ee-4f26-b969-d3efb54aa158', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E248677DD0>]}
[0m18:25:27.826876 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3fca025c-d1ee-4f26-b969-d3efb54aa158', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E248924A10>]}
[0m18:25:27.827873 [info ] [MainThread]: Found 16 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m18:25:27.828871 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3fca025c-d1ee-4f26-b969-d3efb54aa158', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E2488DE990>]}
[0m18:25:27.830865 [info ] [MainThread]: 
[0m18:25:27.832862 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m18:25:27.836016 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m18:25:27.851973 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m18:25:27.852971 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m18:25:27.853966 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:25:29.757171 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m18:25:29.763157 [debug] [ThreadPool]: On list_schemas: Close
[0m18:25:29.768143 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m18:25:29.771135 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m18:25:29.789085 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m18:25:29.791079 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m18:25:29.792077 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:25:32.005307 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m18:25:32.008347 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m18:25:32.011320 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m18:25:32.633693 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m18:25:32.639671 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m18:25:32.641665 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m18:25:32.644659 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m18:25:33.327670 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m18:25:33.329663 [debug] [ThreadPool]: On create__site_dev: Close
[0m18:25:33.342997 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m18:25:33.366933 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m18:25:33.370929 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m18:25:33.372915 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:25:35.357954 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m18:25:35.359950 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m18:25:35.361946 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m18:25:35.995892 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m18:25:35.999881 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m18:25:36.209780 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m18:25:36.215113 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3fca025c-d1ee-4f26-b969-d3efb54aa158', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E248924E50>]}
[0m18:25:36.218116 [debug] [MainThread]: Using mysql connection "master"
[0m18:25:36.221108 [debug] [MainThread]: On master: BEGIN
[0m18:25:36.223100 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:25:38.249830 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m18:25:38.304875 [debug] [MainThread]: On master: COMMIT
[0m18:25:38.305872 [debug] [MainThread]: Using mysql connection "master"
[0m18:25:38.306870 [debug] [MainThread]: On master: COMMIT
[0m18:25:38.892890 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m18:25:38.893892 [debug] [MainThread]: On master: Close
[0m18:25:38.894888 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m18:25:38.895885 [info ] [MainThread]: 
[0m18:25:38.901380 [debug] [Thread-1 (]: Began running node model.site_dev.Tactical_clicks_ytd_12
[0m18:25:38.903347 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.Tactical_clicks_ytd_12 .................... [RUN]
[0m18:25:38.905343 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.site_dev.Tactical_clicks_ytd_12'
[0m18:25:38.907349 [debug] [Thread-1 (]: Began compiling node model.site_dev.Tactical_clicks_ytd_12
[0m18:25:38.923296 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.Tactical_clicks_ytd_12"
[0m18:25:38.925291 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_clicks_ytd_12 (compile): 18:25:38.907349 => 18:25:38.924294
[0m18:25:38.926287 [debug] [Thread-1 (]: Began executing node model.site_dev.Tactical_clicks_ytd_12
[0m18:25:38.987123 [debug] [Thread-1 (]: Writing runtime sql for node "model.site_dev.Tactical_clicks_ytd_12"
[0m18:25:38.989116 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_clicks_ytd_12"
[0m18:25:38.991111 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_ytd_12: BEGIN
[0m18:25:38.993106 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m18:25:40.580345 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m18:25:40.588323 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_clicks_ytd_12"
[0m18:25:40.597298 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_ytd_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "node_id": "model.site_dev.Tactical_clicks_ytd_12"} */

  create view `site_dev`.`Tactical_clicks_ytd_12__dbt_tmp`
    
    
  as (
    

-- 
-- 
-- 
DELIMITER //
CREATE PROCEDURE `Tactical_clicks_months_12_dbt_test`()
BEGIN
    WITH curr_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN MAKEDATE(EXTRACT(YEAR FROM CURDATE()),1)  and  DATE_SUB(cast(NOW() as date), INTERVAL 1 DAY)
        AND categories <> "Nyhedsoverblik"
        AND siteid = '14'
    ),
    agg_curr_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks
        FROM prod.events e
        JOIN curr_30_days_article_published a ON a.id = e.postid
        WHERE e.date between MAKEDATE(EXTRACT(YEAR FROM CURDATE()),1)  and  DATE_SUB(cast(NOW() as date), INTERVAL 1 DAY)
        AND e.siteid = '14'
        AND e.Event_Action = 'Next Click'
        GROUP BY 1
    ),
    agg_curr_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum
        FROM prod.pages p
        LEFT JOIN curr_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = '14'
        AND p.date between MAKEDATE(EXTRACT(YEAR FROM CURDATE()),1)  and  DATE_SUB(cast(NOW() as date), INTERVAL 1 DAY)
        GROUP BY p.siteid
    ),
    value_curr_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks / p.pageview_sum * 100, 2) AS value
        FROM agg_curr_30_days_events e
        LEFT JOIN agg_curr_30_days_pages p ON e.siteid = p.siteid
    ),
    last_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date between DATE_SUB(MAKEDATE(EXTRACT(YEAR FROM CURDATE()),1), INTERVAL 1 Year)  and DATE_SUB(DATE_SUB(cast(NOW() as date), INTERVAL 1 DAY),INTERVAL 1 Year) 
        AND siteid = site
        AND categories <> "Nyhedsoverblik"
    ),
    agg_last_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks_last
        FROM prod.events e
        JOIN last_30_days_article_published a ON a.id = e.postid
        WHERE e.date between DATE_SUB(MAKEDATE(EXTRACT(YEAR FROM CURDATE()),1), INTERVAL 1 Year) and DATE_SUB(DATE_SUB(cast(NOW() as date), INTERVAL 1 DAY),INTERVAL 1 Year) 
        AND e.siteid = '14'
        AND e.Event_Action = 'Next Click'
        GROUP BY 1
    ),
    agg_last_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum_last
        FROM prod.pages p
        LEFT JOIN last_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = '14'
        AND p.date between DATE_SUB(MAKEDATE(EXTRACT(YEAR FROM CURDATE()),1), INTERVAL 1 Year)  and DATE_SUB(DATE_SUB(cast(NOW() as date), INTERVAL 1 DAY),INTERVAL 1 Year) 
        GROUP BY p.siteid
    ),
    value_last_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks_last / p.pageview_sum_last * 100, 2) AS value_last
        FROM agg_last_30_days_events e
        LEFT JOIN agg_last_30_days_pages p ON e.siteid = p.siteid
    )
    SELECT 
        JSON_OBJECT(
            'site', al.siteid,
            'data', JSON_OBJECT(
            'label', 'Gns. next click (%)',
            'hint', 'Gns. next click på artikler publiceret seneste 30 dage ift. forrige 30 dage',
            'value', COALESCE(value, 0),
            'change', COALESCE(value - value_last, 0),
            'progressCurrent', '',
            'progressTotal', ''
            )
        ) AS json_data
    FROM value_curr_30_days al
    LEFT JOIN value_last_30_days alb ON al.siteid = alb.siteid
    WHERE al.siteid = '14';
END;
DELIMITER ;
  );
[0m18:25:41.193065 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'DELIMITER //
CREATE PROCEDURE `Tactical_clicks_months_12_dbt_test`()
BEGIN
    W' at line 12
[0m18:25:41.197054 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_ytd_12: ROLLBACK
[0m18:25:41.399926 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_clicks_ytd_12 (execute): 18:25:38.926287 => 18:25:41.397949
[0m18:25:41.404912 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_ytd_12: Close
[0m18:25:41.432835 [debug] [Thread-1 (]: Database Error in model Tactical_clicks_ytd_12 (models\example\Tactical_clicks_ytd_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'DELIMITER //
  CREATE PROCEDURE `Tactical_clicks_months_12_dbt_test`()
  BEGIN
      W' at line 12
  compiled Code at target\run\site_dev\models\example\Tactical_clicks_ytd_12.sql
[0m18:25:41.434829 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3fca025c-d1ee-4f26-b969-d3efb54aa158', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E248AF3C90>]}
[0m18:25:41.436821 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.Tactical_clicks_ytd_12 ........... [[31mERROR[0m in 2.53s]
[0m18:25:41.437817 [debug] [Thread-1 (]: Finished running node model.site_dev.Tactical_clicks_ytd_12
[0m18:25:41.441723 [debug] [MainThread]: Using mysql connection "master"
[0m18:25:41.442720 [debug] [MainThread]: On master: BEGIN
[0m18:25:41.443718 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m18:25:43.044506 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m18:25:43.047495 [debug] [MainThread]: On master: COMMIT
[0m18:25:43.049488 [debug] [MainThread]: Using mysql connection "master"
[0m18:25:43.052481 [debug] [MainThread]: On master: COMMIT
[0m18:25:43.656935 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m18:25:43.659937 [debug] [MainThread]: On master: Close
[0m18:25:43.664932 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:25:43.666917 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m18:25:43.669907 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m18:25:43.671906 [debug] [MainThread]: Connection 'model.site_dev.Tactical_clicks_ytd_12' was properly closed.
[0m18:25:43.673900 [info ] [MainThread]: 
[0m18:25:43.674897 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 15.84 seconds (15.84s).
[0m18:25:43.677888 [debug] [MainThread]: Command end result
[0m18:25:43.696834 [info ] [MainThread]: 
[0m18:25:43.697832 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m18:25:43.698832 [info ] [MainThread]: 
[0m18:25:43.699827 [error] [MainThread]:   Database Error in model Tactical_clicks_ytd_12 (models\example\Tactical_clicks_ytd_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'DELIMITER //
  CREATE PROCEDURE `Tactical_clicks_months_12_dbt_test`()
  BEGIN
      W' at line 12
  compiled Code at target\run\site_dev\models\example\Tactical_clicks_ytd_12.sql
[0m18:25:43.700825 [info ] [MainThread]: 
[0m18:25:43.701823 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m18:25:43.703817 [debug] [MainThread]: Command `dbt run` failed at 18:25:43.703817 after 16.56 seconds
[0m18:25:43.704814 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E248271B50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E241BC2350>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E2488A3990>]}
[0m18:25:43.704814 [debug] [MainThread]: Flushing usage events
[0m18:25:50.136457 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000254173CC950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002541740B990>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000254173CFCD0>]}


============================== 18:25:50.142439 | 672e9f28-d24e-47ef-bfbb-0cf8d53a43e4 ==============================
[0m18:25:50.142439 [info ] [MainThread]: Running with dbt=1.7.17
[0m18:25:50.143437 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --models tactical_articles_card_month_12.sql', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m18:25:50.444080 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '672e9f28-d24e-47ef-bfbb-0cf8d53a43e4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000254173B1050>]}
[0m18:25:50.571737 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '672e9f28-d24e-47ef-bfbb-0cf8d53a43e4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000254173CD9D0>]}
[0m18:25:50.574731 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m18:25:50.594676 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m18:25:50.761282 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m18:25:50.763279 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m18:25:50.768263 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example
[0m18:25:50.801176 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '672e9f28-d24e-47ef-bfbb-0cf8d53a43e4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002541778D5D0>]}
[0m18:25:50.854034 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '672e9f28-d24e-47ef-bfbb-0cf8d53a43e4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000254176B4B10>]}
[0m18:25:50.857027 [info ] [MainThread]: Found 16 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m18:25:50.859023 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '672e9f28-d24e-47ef-bfbb-0cf8d53a43e4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025417435BD0>]}
[0m18:25:50.864008 [info ] [MainThread]: 
[0m18:25:50.868007 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m18:25:50.872984 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m18:25:50.907891 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m18:25:50.908888 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m18:25:50.909885 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:25:52.641314 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m18:25:52.643311 [debug] [ThreadPool]: On list_schemas: Close
[0m18:25:52.646303 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m18:25:52.647299 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m18:25:52.654280 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m18:25:52.657272 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m18:25:52.658271 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:25:54.196250 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m18:25:54.198247 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m18:25:54.200241 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m18:25:54.794953 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m18:25:54.797944 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m18:25:54.798942 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m18:25:54.799966 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m18:25:55.382815 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m18:25:55.384816 [debug] [ThreadPool]: On create__site_dev: Close
[0m18:25:55.389215 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m18:25:55.399187 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m18:25:55.400183 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m18:25:55.401182 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:25:57.024810 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m18:25:57.026801 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m18:25:57.029796 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m18:25:57.625737 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m18:25:57.629731 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m18:25:57.828013 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m18:25:57.830010 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '672e9f28-d24e-47ef-bfbb-0cf8d53a43e4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025417627590>]}
[0m18:25:57.831009 [debug] [MainThread]: Using mysql connection "master"
[0m18:25:57.833003 [debug] [MainThread]: On master: BEGIN
[0m18:25:57.835000 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:25:59.365037 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m18:25:59.367031 [debug] [MainThread]: On master: COMMIT
[0m18:25:59.369029 [debug] [MainThread]: Using mysql connection "master"
[0m18:25:59.370023 [debug] [MainThread]: On master: COMMIT
[0m18:25:59.963460 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m18:25:59.965462 [debug] [MainThread]: On master: Close
[0m18:25:59.966461 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m18:25:59.968457 [info ] [MainThread]: 
[0m18:25:59.973439 [debug] [Thread-1 (]: Began running node model.site_dev.tactical_articles_card_month_12
[0m18:25:59.975435 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.tactical_articles_card_month_12 ........... [RUN]
[0m18:25:59.977432 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.site_dev.tactical_articles_card_month_12'
[0m18:25:59.979424 [debug] [Thread-1 (]: Began compiling node model.site_dev.tactical_articles_card_month_12
[0m18:25:59.994390 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.tactical_articles_card_month_12"
[0m18:25:59.998374 [debug] [Thread-1 (]: Timing info for model.site_dev.tactical_articles_card_month_12 (compile): 18:25:59.981420 => 18:25:59.997375
[0m18:26:00.000368 [debug] [Thread-1 (]: Began executing node model.site_dev.tactical_articles_card_month_12
[0m18:26:00.076164 [debug] [Thread-1 (]: Writing runtime sql for node "model.site_dev.tactical_articles_card_month_12"
[0m18:26:00.077165 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.tactical_articles_card_month_12"
[0m18:26:00.079158 [debug] [Thread-1 (]: On model.site_dev.tactical_articles_card_month_12: BEGIN
[0m18:26:00.082150 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m18:26:01.669403 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m18:26:01.671396 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.tactical_articles_card_month_12"
[0m18:26:01.672394 [debug] [Thread-1 (]: On model.site_dev.tactical_articles_card_month_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "node_id": "model.site_dev.tactical_articles_card_month_12"} */

  create view `site_dev`.`tactical_articles_card_month_12__dbt_tmp`
    
    
  as (
    

CREATE PROCEDURE `prod`.`tactical_articles_card_month_12_test_dbt`()
BEGIN
    WITH last_30_day AS (
        SELECT siteId as siteId, COUNT(date) as value 
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) AND categories <> "Nyhedsoverblik"
        AND siteid = '14'
        GROUP BY 1
    ),
    last_30_days_before AS (
        SELECT siteId as siteId, COUNT(*) as value  
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY) AND categories <> "Nyhedsoverblik"
        AND siteid = '14'
        GROUP BY 1
    )
    SELECT
        JSON_OBJECT(
            'site', ld.siteId,
            'data', JSON_OBJECT(
                'label', 'Artikler',
                'hint', 'Artikler publiceret seneste 30 dage ift. forrige 30 dage',
                'value', COALESCE(ld.value, 0),
                'change', COALESCE(ROUND(((ld.value - lb.value) / lb.value) * 100, 2), 0),
                'progressCurrent', '',
                'progressTotal', ''
            )
        ) AS json_data
    FROM last_30_day ld
    LEFT JOIN last_30_days_before lb ON ld.siteId = lb.siteId;
END;
  );
[0m18:26:02.275897 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_month_12_test_dbt`()
BEGIN
    W' at line 9
[0m18:26:02.279887 [debug] [Thread-1 (]: On model.site_dev.tactical_articles_card_month_12: ROLLBACK
[0m18:26:02.484437 [debug] [Thread-1 (]: Timing info for model.site_dev.tactical_articles_card_month_12 (execute): 18:26:00.001364 => 18:26:02.483441
[0m18:26:02.486434 [debug] [Thread-1 (]: On model.site_dev.tactical_articles_card_month_12: Close
[0m18:26:02.505383 [debug] [Thread-1 (]: Database Error in model tactical_articles_card_month_12 (models\example\tactical_articles_card_month_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_month_12_test_dbt`()
  BEGIN
      W' at line 9
  compiled Code at target\run\site_dev\models\example\tactical_articles_card_month_12.sql
[0m18:26:02.507376 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '672e9f28-d24e-47ef-bfbb-0cf8d53a43e4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002541787E110>]}
[0m18:26:02.509374 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.tactical_articles_card_month_12 .. [[31mERROR[0m in 2.53s]
[0m18:26:02.512374 [debug] [Thread-1 (]: Finished running node model.site_dev.tactical_articles_card_month_12
[0m18:26:02.517351 [debug] [MainThread]: Using mysql connection "master"
[0m18:26:02.518371 [debug] [MainThread]: On master: BEGIN
[0m18:26:02.520344 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m18:26:04.111100 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m18:26:04.116075 [debug] [MainThread]: On master: COMMIT
[0m18:26:04.120062 [debug] [MainThread]: Using mysql connection "master"
[0m18:26:04.124053 [debug] [MainThread]: On master: COMMIT
[0m18:26:04.711644 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m18:26:04.714633 [debug] [MainThread]: On master: Close
[0m18:26:04.718617 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:26:04.721620 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m18:26:04.723606 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m18:26:04.724603 [debug] [MainThread]: Connection 'model.site_dev.tactical_articles_card_month_12' was properly closed.
[0m18:26:04.726595 [info ] [MainThread]: 
[0m18:26:04.728593 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 13.86 seconds (13.86s).
[0m18:26:04.730586 [debug] [MainThread]: Command end result
[0m18:26:04.748537 [info ] [MainThread]: 
[0m18:26:04.750532 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m18:26:04.751529 [info ] [MainThread]: 
[0m18:26:04.752526 [error] [MainThread]:   Database Error in model tactical_articles_card_month_12 (models\example\tactical_articles_card_month_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`tactical_articles_card_month_12_test_dbt`()
  BEGIN
      W' at line 9
  compiled Code at target\run\site_dev\models\example\tactical_articles_card_month_12.sql
[0m18:26:04.753523 [info ] [MainThread]: 
[0m18:26:04.754521 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m18:26:04.757520 [debug] [MainThread]: Command `dbt run` failed at 18:26:04.756516 after 14.71 seconds
[0m18:26:04.758510 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025417011CD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000254167F6490>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002541760B610>]}
[0m18:26:04.758510 [debug] [MainThread]: Flushing usage events
[0m18:26:10.944704 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000211DC179050>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000211DBC4C850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000211DC1AE690>]}


============================== 18:26:10.954677 | 3cfc2476-2bc3-4325-8ce5-a8a3dae8cb90 ==============================
[0m18:26:10.954677 [info ] [MainThread]: Running with dbt=1.7.17
[0m18:26:10.957693 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --models tactical_articles_card_year_12.sql', 'send_anonymous_usage_stats': 'True'}
[0m18:26:11.269823 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3cfc2476-2bc3-4325-8ce5-a8a3dae8cb90', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000211DB596DD0>]}
[0m18:26:11.376538 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3cfc2476-2bc3-4325-8ce5-a8a3dae8cb90', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000211DC39EBD0>]}
[0m18:26:11.380075 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m18:26:11.397033 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m18:26:11.507737 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m18:26:11.508733 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m18:26:11.510728 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example
[0m18:26:11.519705 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3cfc2476-2bc3-4325-8ce5-a8a3dae8cb90', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000211DAEF5690>]}
[0m18:26:11.541646 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3cfc2476-2bc3-4325-8ce5-a8a3dae8cb90', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000211DC493C90>]}
[0m18:26:11.542646 [info ] [MainThread]: Found 16 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m18:26:11.543643 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3cfc2476-2bc3-4325-8ce5-a8a3dae8cb90', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000211DC3D77D0>]}
[0m18:26:11.545638 [warn ] [MainThread]: The selection criterion 'tactical_articles_card_year_12.sql' does not match any nodes
[0m18:26:11.547633 [info ] [MainThread]: 
[0m18:26:11.548668 [warn ] [MainThread]: Nothing to do. Try checking your model configs and model specification args
[0m18:26:11.549626 [debug] [MainThread]: Command end result
[0m18:26:11.563588 [debug] [MainThread]: Command `dbt run` succeeded at 18:26:11.563588 after 0.75 seconds
[0m18:26:11.564598 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000211DB596810>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000211D5721750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000211D5712310>]}
[0m18:26:11.565583 [debug] [MainThread]: Flushing usage events
[0m18:26:18.007013 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E3A6C58D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E3AA8C890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E3AA8D250>]}


============================== 18:26:18.015989 | 195fcbd1-0b23-4f81-8007-6625064c513f ==============================
[0m18:26:18.015989 [info ] [MainThread]: Running with dbt=1.7.17
[0m18:26:18.017985 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'debug': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --models Tactical_pageviews_card_month_12.sql', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m18:26:18.365057 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '195fcbd1-0b23-4f81-8007-6625064c513f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E3AC37E50>]}
[0m18:26:18.464788 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '195fcbd1-0b23-4f81-8007-6625064c513f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E3AA8E710>]}
[0m18:26:18.466773 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m18:26:18.478750 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m18:26:18.585458 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m18:26:18.586457 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m18:26:18.588451 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example
[0m18:26:18.600421 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '195fcbd1-0b23-4f81-8007-6625064c513f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E3AA8DD50>]}
[0m18:26:18.632333 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '195fcbd1-0b23-4f81-8007-6625064c513f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E3ADA7F10>]}
[0m18:26:18.634327 [info ] [MainThread]: Found 16 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m18:26:18.636323 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '195fcbd1-0b23-4f81-8007-6625064c513f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E3AD4F710>]}
[0m18:26:18.641311 [info ] [MainThread]: 
[0m18:26:18.643307 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m18:26:18.647294 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m18:26:18.671230 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m18:26:18.672231 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m18:26:18.674225 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:26:20.235775 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m18:26:20.238767 [debug] [ThreadPool]: On list_schemas: Close
[0m18:26:20.242757 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m18:26:20.244753 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m18:26:20.255723 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m18:26:20.256719 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m18:26:20.258714 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:26:21.792729 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m18:26:21.793727 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m18:26:21.796728 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m18:26:22.391127 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m18:26:22.394119 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m18:26:22.398110 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m18:26:22.399106 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m18:26:23.005484 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m18:26:23.007481 [debug] [ThreadPool]: On create__site_dev: Close
[0m18:26:23.050365 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m18:26:23.075298 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m18:26:23.078302 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m18:26:23.100230 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:26:24.676975 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m18:26:24.677972 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m18:26:24.679967 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m18:26:25.262911 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m18:26:25.264909 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m18:26:25.461278 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m18:26:25.468255 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '195fcbd1-0b23-4f81-8007-6625064c513f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E3ACE6B50>]}
[0m18:26:25.473243 [debug] [MainThread]: Using mysql connection "master"
[0m18:26:25.476236 [debug] [MainThread]: On master: BEGIN
[0m18:26:25.479228 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:26:27.090657 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m18:26:27.094679 [debug] [MainThread]: On master: COMMIT
[0m18:26:27.096674 [debug] [MainThread]: Using mysql connection "master"
[0m18:26:27.099664 [debug] [MainThread]: On master: COMMIT
[0m18:26:27.710902 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m18:26:27.711902 [debug] [MainThread]: On master: Close
[0m18:26:27.713898 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m18:26:27.714894 [info ] [MainThread]: 
[0m18:26:27.722137 [debug] [Thread-1 (]: Began running node model.site_dev.Tactical_pageviews_card_month_12
[0m18:26:27.725132 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.Tactical_pageviews_card_month_12 .......... [RUN]
[0m18:26:27.727125 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.site_dev.Tactical_pageviews_card_month_12'
[0m18:26:27.728122 [debug] [Thread-1 (]: Began compiling node model.site_dev.Tactical_pageviews_card_month_12
[0m18:26:27.748067 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.Tactical_pageviews_card_month_12"
[0m18:26:27.750062 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_pageviews_card_month_12 (compile): 18:26:27.729120 => 18:26:27.750062
[0m18:26:27.751059 [debug] [Thread-1 (]: Began executing node model.site_dev.Tactical_pageviews_card_month_12
[0m18:26:27.847801 [debug] [Thread-1 (]: Writing runtime sql for node "model.site_dev.Tactical_pageviews_card_month_12"
[0m18:26:27.850792 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_pageviews_card_month_12"
[0m18:26:27.851789 [debug] [Thread-1 (]: On model.site_dev.Tactical_pageviews_card_month_12: BEGIN
[0m18:26:27.856777 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m18:26:29.460354 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m18:26:29.461363 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_pageviews_card_month_12"
[0m18:26:29.462357 [debug] [Thread-1 (]: On model.site_dev.Tactical_pageviews_card_month_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "node_id": "model.site_dev.Tactical_pageviews_card_month_12"} */

  create view `site_dev`.`Tactical_pageviews_card_month_12__dbt_tmp`
    
    
  as (
    






CREATE PROCEDURE `prod`.`Tactical_pageviews_card_month_12_dbt_test`()
BEGIN
with last_month_article_published as(
SELECT siteid as siteid,id   FROM prod.site_archive_post
where date between DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) 
AND  categories <> "Nyhedsoverblik"
and siteid = 14
),
last_month_article_published_Agg as(
select siteid as siteid,count(*) as agg from  last_month_article_published
where  siteid = 14
group by 1
),
agg_last_month as (
select  e.siteid as siteid,sum(unique_pageviews)/agg as value from prod.pages e
join  last_month_article_published a on a.id=e.postid
join last_month_article_published_Agg agg on agg.siteid=a.siteid 
where e.date between DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY) and e.siteid = 14
group by 1,agg
),
last_month_before_article_published as(
SELECT siteid as siteid,id   FROM prod.site_archive_post
where DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY)  and siteid = 14
 AND  categories <> "Nyhedsoverblik"
),
last_month_before_article_published_Agg as(
select siteid as siteid,count(*) as agg from  last_month_before_article_published
where siteid = 14
group by 1
),
agg_last_month_before as(
select  e.siteid as siteid,sum(unique_pageviews)/agg as value from prod.pages e
join  last_month_before_article_published a on a.id=e.postid
join last_month_before_article_published_Agg agg on agg.siteid=a.siteid 
where DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY)  and e.siteid = 14
group by 1,agg
),
json_data as( 
select al.siteid as site, label_val label, hint_val  hint, al.value as valu,((al.value-alb.value)/al.value)*100 as chang, '' as progressCurrent , '' as progresstotal
from agg_last_month al
left join agg_last_month_before alb on al.siteid=alb.siteid
where al.siteid = 14
)
select 
    JSON_OBJECT(
            'site',14,
            'data',JSON_OBJECT(
            'label', 'Artikler',
            'hint', 'Artikler publiceret seneste 30 dage ift. forrige 30 dage',
            'value',COALESCE(valu,0),
            'change',COALESCE(chang,0),
            'progressCurrent',progressCurrent, 
            'progressTotal',progressTotal
 )) AS json_data  from json_data;
 
 END
  );
[0m18:26:30.059942 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_pageviews_card_month_12_dbt_test`()
BEGIN
with' at line 14
[0m18:26:30.060941 [debug] [Thread-1 (]: On model.site_dev.Tactical_pageviews_card_month_12: ROLLBACK
[0m18:26:30.264866 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_pageviews_card_month_12 (execute): 18:26:27.753055 => 18:26:30.263863
[0m18:26:30.265862 [debug] [Thread-1 (]: On model.site_dev.Tactical_pageviews_card_month_12: Close
[0m18:26:30.277829 [debug] [Thread-1 (]: Database Error in model Tactical_pageviews_card_month_12 (models\example\Tactical_pageviews_card_month_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_pageviews_card_month_12_dbt_test`()
  BEGIN
  with' at line 14
  compiled Code at target\run\site_dev\models\example\Tactical_pageviews_card_month_12.sql
[0m18:26:30.279825 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '195fcbd1-0b23-4f81-8007-6625064c513f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E3AAF38D0>]}
[0m18:26:30.280820 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.Tactical_pageviews_card_month_12 . [[31mERROR[0m in 2.55s]
[0m18:26:30.282816 [debug] [Thread-1 (]: Finished running node model.site_dev.Tactical_pageviews_card_month_12
[0m18:26:30.286807 [debug] [MainThread]: Using mysql connection "master"
[0m18:26:30.287802 [debug] [MainThread]: On master: BEGIN
[0m18:26:30.288800 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m18:26:31.870208 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m18:26:31.871207 [debug] [MainThread]: On master: COMMIT
[0m18:26:31.873200 [debug] [MainThread]: Using mysql connection "master"
[0m18:26:31.874199 [debug] [MainThread]: On master: COMMIT
[0m18:26:32.474632 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m18:26:32.478621 [debug] [MainThread]: On master: Close
[0m18:26:32.485603 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:26:32.488591 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m18:26:32.490588 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m18:26:32.492582 [debug] [MainThread]: Connection 'model.site_dev.Tactical_pageviews_card_month_12' was properly closed.
[0m18:26:32.494574 [info ] [MainThread]: 
[0m18:26:32.495572 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 13.85 seconds (13.85s).
[0m18:26:32.497566 [debug] [MainThread]: Command end result
[0m18:26:32.518511 [info ] [MainThread]: 
[0m18:26:32.519509 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m18:26:32.521502 [info ] [MainThread]: 
[0m18:26:32.523498 [error] [MainThread]:   Database Error in model Tactical_pageviews_card_month_12 (models\example\Tactical_pageviews_card_month_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'CREATE PROCEDURE `prod`.`Tactical_pageviews_card_month_12_dbt_test`()
  BEGIN
  with' at line 14
  compiled Code at target\run\site_dev\models\example\Tactical_pageviews_card_month_12.sql
[0m18:26:32.525493 [info ] [MainThread]: 
[0m18:26:32.527490 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m18:26:32.530480 [debug] [MainThread]: Command `dbt run` failed at 18:26:32.530480 after 14.62 seconds
[0m18:26:32.533470 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E3AA8CCD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E33F514D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E3AA78190>]}
[0m18:26:32.534474 [debug] [MainThread]: Flushing usage events
[0m18:34:48.619011 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B4AA3CF50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B4AA73990>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B4AA3D310>]}


============================== 18:34:48.633391 | dcddbcac-dd84-4c1c-8abd-fef2c792cf4f ==============================
[0m18:34:48.633391 [info ] [MainThread]: Running with dbt=1.7.17
[0m18:34:48.636442 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models Tactical_clicks_months_12.sql', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m18:34:49.627345 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'dcddbcac-dd84-4c1c-8abd-fef2c792cf4f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B4A50C8D0>]}
[0m18:34:49.897418 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'dcddbcac-dd84-4c1c-8abd-fef2c792cf4f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B4AA3F590>]}
[0m18:34:49.901512 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m18:34:49.940777 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m18:34:50.449269 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 2 files changed.
[0m18:34:50.454355 [debug] [MainThread]: Partial parsing: updated file: site_dev://models\example\tactical_articles_card_year_12_test_dbt.sql
[0m18:34:50.455253 [debug] [MainThread]: Partial parsing: updated file: site_dev://models\example\tactical_articles_card_month_12.sql
[0m18:34:51.070572 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example
[0m18:34:51.098181 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'dcddbcac-dd84-4c1c-8abd-fef2c792cf4f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B4AF6A710>]}
[0m18:34:51.161579 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'dcddbcac-dd84-4c1c-8abd-fef2c792cf4f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B4AF50B10>]}
[0m18:34:51.165567 [info ] [MainThread]: Found 16 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m18:34:51.168725 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'dcddbcac-dd84-4c1c-8abd-fef2c792cf4f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B4ADEBAD0>]}
[0m18:34:51.178531 [info ] [MainThread]: 
[0m18:34:51.182546 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m18:34:51.188567 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m18:34:51.238745 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m18:34:51.241776 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m18:34:51.245286 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:34:53.191212 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m18:34:53.197500 [debug] [ThreadPool]: On list_schemas: Close
[0m18:34:53.202508 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m18:34:53.206686 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m18:34:53.226623 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m18:34:53.228586 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m18:34:53.231578 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:34:55.267445 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m18:34:55.269891 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m18:34:55.272265 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m18:34:55.999540 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m18:34:56.004500 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m18:34:56.008951 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m18:34:56.011941 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m18:34:56.787397 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m18:34:56.795444 [debug] [ThreadPool]: On create__site_dev: Close
[0m18:34:56.834901 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m18:34:56.931912 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m18:34:56.934080 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m18:34:56.936928 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:34:59.844193 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 3.0 seconds
[0m18:34:59.857376 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m18:34:59.862406 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m18:35:00.694546 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m18:35:00.700693 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m18:35:00.898598 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m18:35:00.906344 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'dcddbcac-dd84-4c1c-8abd-fef2c792cf4f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B4AD64390>]}
[0m18:35:00.912327 [debug] [MainThread]: Using mysql connection "master"
[0m18:35:00.919306 [debug] [MainThread]: On master: BEGIN
[0m18:35:00.925294 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:35:02.993784 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m18:35:03.001582 [debug] [MainThread]: On master: COMMIT
[0m18:35:03.005561 [debug] [MainThread]: Using mysql connection "master"
[0m18:35:03.012541 [debug] [MainThread]: On master: COMMIT
[0m18:35:03.762404 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m18:35:03.765397 [debug] [MainThread]: On master: Close
[0m18:35:03.768977 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m18:35:03.770971 [info ] [MainThread]: 
[0m18:35:03.780255 [debug] [Thread-1 (]: Began running node model.site_dev.Tactical_clicks_months_12
[0m18:35:03.784246 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.Tactical_clicks_months_12 ................. [RUN]
[0m18:35:03.789023 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.site_dev.Tactical_clicks_months_12'
[0m18:35:03.791226 [debug] [Thread-1 (]: Began compiling node model.site_dev.Tactical_clicks_months_12
[0m18:35:03.837137 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.Tactical_clicks_months_12"
[0m18:35:03.842123 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_clicks_months_12 (compile): 18:35:03.793344 => 18:35:03.840128
[0m18:35:03.844311 [debug] [Thread-1 (]: Began executing node model.site_dev.Tactical_clicks_months_12
[0m18:35:03.985357 [debug] [Thread-1 (]: Writing runtime sql for node "model.site_dev.Tactical_clicks_months_12"
[0m18:35:03.988338 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_clicks_months_12"
[0m18:35:03.990333 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: BEGIN
[0m18:35:03.992329 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m18:35:05.768210 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m18:35:05.770205 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_clicks_months_12"
[0m18:35:05.773326 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "node_id": "model.site_dev.Tactical_clicks_months_12"} */

  create view `site_dev`.`Tactical_clicks_months_12__dbt_tmp`
    
    
  as (
    

-- 
-- 
-- 
DELIMITER //
CREATE PROCEDURE `Tactical_clicks_months_12_dbt_test`()
BEGIN
    WITH curr_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND categories <> "Nyhedsoverblik"
        AND siteid = '14'
    ),
    agg_curr_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks
        FROM prod.events e
        JOIN curr_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND e.siteid = '14'
        AND e.Event_Action = 'Next Click'
        GROUP BY 1
    ),
    agg_curr_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum
        FROM prod.pages p
        LEFT JOIN curr_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = '14'
        AND p.date BETWEEN DATE_SUB(NOW(), INTERVAL 31 DAY) AND DATE_SUB(NOW(), INTERVAL 1 DAY)
        GROUP BY p.siteid
    ),
    value_curr_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks / p.pageview_sum * 100, 2) AS value
        FROM agg_curr_30_days_events e
        LEFT JOIN agg_curr_30_days_pages p ON e.siteid = p.siteid
    ),
    last_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY)
        AND siteid = site
        AND categories <> "Nyhedsoverblik"
    ),
    agg_last_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks_last
        FROM prod.events e
        JOIN last_30_days_article_published a ON a.id = e.postid
        WHERE e.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY)
        AND e.siteid = '14'
        AND e.Event_Action = 'Next Click'
        GROUP BY 1
    ),
    agg_last_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum_last
        FROM prod.pages p
        LEFT JOIN last_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = '14'
        AND p.date BETWEEN DATE_SUB(NOW(), INTERVAL 61 DAY) AND DATE_SUB(NOW(), INTERVAL 31 DAY)
        GROUP BY p.siteid
    ),
    value_last_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks_last / p.pageview_sum_last * 100, 2) AS value_last
        FROM agg_last_30_days_events e
        LEFT JOIN agg_last_30_days_pages p ON e.siteid = p.siteid
    )
    SELECT 
        JSON_OBJECT(
            'site', al.siteid,
            'data', JSON_OBJECT(
            'label', 'Gns. next click (%)',
            'hint', 'Gns. next click på artikler publiceret seneste 30 dage ift. forrige 30 dage',
            'value', COALESCE(value, 0),
            'change', COALESCE(value - value_last, 0),
            'progressCurrent', '',
            'progressTotal', ''
            )
        ) AS json_data
    FROM value_curr_30_days al
    LEFT JOIN value_last_30_days alb ON al.siteid = alb.siteid
    WHERE al.siteid = '14';
END;
DELIMITER ;
  );
[0m18:35:06.440305 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'DELIMITER //
CREATE PROCEDURE `Tactical_clicks_months_12_dbt_test`()
BEGIN
    W' at line 12
[0m18:35:06.445292 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: ROLLBACK
[0m18:35:06.717275 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_clicks_months_12 (execute): 18:35:03.846111 => 18:35:06.715270
[0m18:35:06.719265 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_months_12: Close
[0m18:35:06.737219 [debug] [Thread-1 (]: Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'DELIMITER //
  CREATE PROCEDURE `Tactical_clicks_months_12_dbt_test`()
  BEGIN
      W' at line 12
  compiled Code at target\run\site_dev\models\example\Tactical_clicks_months_12.sql
[0m18:35:06.740211 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dcddbcac-dd84-4c1c-8abd-fef2c792cf4f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B4B008890>]}
[0m18:35:06.742206 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.Tactical_clicks_months_12 ........ [[31mERROR[0m in 2.95s]
[0m18:35:06.747402 [debug] [Thread-1 (]: Finished running node model.site_dev.Tactical_clicks_months_12
[0m18:35:06.753846 [debug] [MainThread]: Using mysql connection "master"
[0m18:35:06.754841 [debug] [MainThread]: On master: BEGIN
[0m18:35:06.756841 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m18:35:09.415497 [debug] [MainThread]: SQL status: SUCCESS 0 in 3.0 seconds
[0m18:35:09.417761 [debug] [MainThread]: On master: COMMIT
[0m18:35:09.419743 [debug] [MainThread]: Using mysql connection "master"
[0m18:35:09.422832 [debug] [MainThread]: On master: COMMIT
[0m18:35:10.030611 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m18:35:10.034541 [debug] [MainThread]: On master: Close
[0m18:35:10.038452 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:35:10.042314 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m18:35:10.044958 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m18:35:10.047717 [debug] [MainThread]: Connection 'model.site_dev.Tactical_clicks_months_12' was properly closed.
[0m18:35:10.051736 [info ] [MainThread]: 
[0m18:35:10.054468 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 18.87 seconds (18.87s).
[0m18:35:10.059620 [debug] [MainThread]: Command end result
[0m18:35:10.130386 [info ] [MainThread]: 
[0m18:35:10.133499 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m18:35:10.135493 [info ] [MainThread]: 
[0m18:35:10.138472 [error] [MainThread]:   Database Error in model Tactical_clicks_months_12 (models\example\Tactical_clicks_months_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'DELIMITER //
  CREATE PROCEDURE `Tactical_clicks_months_12_dbt_test`()
  BEGIN
      W' at line 12
  compiled Code at target\run\site_dev\models\example\Tactical_clicks_months_12.sql
[0m18:35:10.142501 [info ] [MainThread]: 
[0m18:35:10.145290 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m18:35:10.153243 [debug] [MainThread]: Command `dbt run` failed at 18:35:10.152254 after 21.71 seconds
[0m18:35:10.156466 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B43EF2350>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B43F01790>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B43F01750>]}
[0m18:35:10.160290 [debug] [MainThread]: Flushing usage events
[0m18:35:22.626661 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC3F308DD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC3F308690>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC3F3088D0>]}


============================== 18:35:22.638470 | ea6ddf0f-16fe-4eed-8065-0e0219a322ec ==============================
[0m18:35:22.638470 [info ] [MainThread]: Running with dbt=1.7.17
[0m18:35:22.641437 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'E:\\Kasper_Sindri_Media', 'version_check': 'True', 'debug': 'False', 'log_path': 'E:\\Kasper_Sindri_Media\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models Tactical_clicks_ytd_12.sql', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:35:23.021716 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ea6ddf0f-16fe-4eed-8065-0e0219a322ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC3F4CDD50>]}
[0m18:35:23.125315 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ea6ddf0f-16fe-4eed-8065-0e0219a322ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC3F53FC90>]}
[0m18:35:23.128267 [info ] [MainThread]: Registered adapter: mysql=1.7.0
[0m18:35:23.146240 [debug] [MainThread]: checksum: df69a17a5cb23fb99a7422df02bc7a63a38fc52c957542963e77e6cc79b17fab, vars: {}, profile: , target: , version: 1.7.17
[0m18:35:23.299370 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m18:35:23.300775 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m18:35:23.302362 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.example
[0m18:35:23.312365 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ea6ddf0f-16fe-4eed-8065-0e0219a322ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC3F376750>]}
[0m18:35:23.335600 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ea6ddf0f-16fe-4eed-8065-0e0219a322ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC3F627650>]}
[0m18:35:23.336590 [info ] [MainThread]: Found 16 models, 0 sources, 0 exposures, 0 metrics, 385 macros, 0 groups, 0 semantic models
[0m18:35:23.337586 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ea6ddf0f-16fe-4eed-8065-0e0219a322ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC3F344450>]}
[0m18:35:23.341575 [info ] [MainThread]: 
[0m18:35:23.343568 [debug] [MainThread]: Acquiring new mysql connection 'master'
[0m18:35:23.346341 [debug] [ThreadPool]: Acquiring new mysql connection 'list_schemas'
[0m18:35:23.366533 [debug] [ThreadPool]: Using mysql connection "list_schemas"
[0m18:35:23.367867 [debug] [ThreadPool]: On list_schemas: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_schemas"} */
select distinct schema_name
        from information_schema.schemata
[0m18:35:23.368330 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:35:25.064539 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 2.0 seconds
[0m18:35:25.070525 [debug] [ThreadPool]: On list_schemas: Close
[0m18:35:25.075509 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_schemas, now create__site_dev)
[0m18:35:25.078766 [debug] [ThreadPool]: Creating schema "schema: "site_dev"
"
[0m18:35:25.098471 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m18:35:25.100462 [debug] [ThreadPool]: On create__site_dev: BEGIN
[0m18:35:25.102460 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:35:26.855161 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m18:35:26.859144 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m18:35:26.861140 [debug] [ThreadPool]: On create__site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "create__site_dev"} */
create schema if not exists `site_dev`
[0m18:35:27.565475 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.0 seconds
[0m18:35:27.572466 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m18:35:27.575492 [debug] [ThreadPool]: Using mysql connection "create__site_dev"
[0m18:35:27.578574 [debug] [ThreadPool]: On create__site_dev: COMMIT
[0m18:35:28.297617 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m18:35:28.300599 [debug] [ThreadPool]: On create__site_dev: Close
[0m18:35:28.315549 [debug] [ThreadPool]: Acquiring new mysql connection 'list_None_site_dev'
[0m18:35:28.347469 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m18:35:28.351565 [debug] [ThreadPool]: On list_None_site_dev: BEGIN
[0m18:35:28.354550 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:35:29.995686 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 2.0 seconds
[0m18:35:30.000662 [debug] [ThreadPool]: Using mysql connection "list_None_site_dev"
[0m18:35:30.005547 [debug] [ThreadPool]: On list_None_site_dev: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "connection_name": "list_None_site_dev"} */
select
      null as "database",
      table_name as name,
      table_schema as "schema",
      case when table_type = 'BASE TABLE' then 'table'
           when table_type = 'VIEW' then 'view'
           else table_type
      end as table_type
    from information_schema.tables
    where table_schema = 'site_dev'
  
[0m18:35:30.870418 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 1.0 seconds
[0m18:35:30.881001 [debug] [ThreadPool]: On list_None_site_dev: ROLLBACK
[0m18:35:31.081446 [debug] [ThreadPool]: On list_None_site_dev: Close
[0m18:35:31.087152 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ea6ddf0f-16fe-4eed-8065-0e0219a322ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC3F5AF9D0>]}
[0m18:35:31.091117 [debug] [MainThread]: Using mysql connection "master"
[0m18:35:31.093110 [debug] [MainThread]: On master: BEGIN
[0m18:35:31.095181 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:35:33.230671 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m18:35:33.235658 [debug] [MainThread]: On master: COMMIT
[0m18:35:33.239653 [debug] [MainThread]: Using mysql connection "master"
[0m18:35:33.241649 [debug] [MainThread]: On master: COMMIT
[0m18:35:33.928462 [debug] [MainThread]: SQL status: SUCCESS 0 in 1.0 seconds
[0m18:35:33.932489 [debug] [MainThread]: On master: Close
[0m18:35:33.937508 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m18:35:33.942502 [info ] [MainThread]: 
[0m18:35:33.959862 [debug] [Thread-1 (]: Began running node model.site_dev.Tactical_clicks_ytd_12
[0m18:35:33.964089 [info ] [Thread-1 (]: 1 of 1 START sql view model site_dev.Tactical_clicks_ytd_12 .................... [RUN]
[0m18:35:33.969838 [debug] [Thread-1 (]: Acquiring new mysql connection 'model.site_dev.Tactical_clicks_ytd_12'
[0m18:35:33.972828 [debug] [Thread-1 (]: Began compiling node model.site_dev.Tactical_clicks_ytd_12
[0m18:35:34.039211 [debug] [Thread-1 (]: Writing injected SQL for node "model.site_dev.Tactical_clicks_ytd_12"
[0m18:35:34.050715 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_clicks_ytd_12 (compile): 18:35:33.974856 => 18:35:34.044193
[0m18:35:34.054716 [debug] [Thread-1 (]: Began executing node model.site_dev.Tactical_clicks_ytd_12
[0m18:35:34.260998 [debug] [Thread-1 (]: Writing runtime sql for node "model.site_dev.Tactical_clicks_ytd_12"
[0m18:35:34.267628 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_clicks_ytd_12"
[0m18:35:34.270619 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_ytd_12: BEGIN
[0m18:35:34.273612 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m18:35:36.539316 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 2.0 seconds
[0m18:35:36.542306 [debug] [Thread-1 (]: Using mysql connection "model.site_dev.Tactical_clicks_ytd_12"
[0m18:35:36.547289 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_ytd_12: /* {"app": "dbt", "dbt_version": "1.7.17", "profile_name": "site_dev", "target_name": "dev", "node_id": "model.site_dev.Tactical_clicks_ytd_12"} */

  create view `site_dev`.`Tactical_clicks_ytd_12__dbt_tmp`
    
    
  as (
    

-- 
-- 
-- 
DELIMITER //
CREATE PROCEDURE `Tactical_clicks_months_12_dbt_test`()
BEGIN
    WITH curr_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date BETWEEN MAKEDATE(EXTRACT(YEAR FROM CURDATE()),1)  and  DATE_SUB(cast(NOW() as date), INTERVAL 1 DAY)
        AND categories <> "Nyhedsoverblik"
        AND siteid = '14'
    ),
    agg_curr_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks
        FROM prod.events e
        JOIN curr_30_days_article_published a ON a.id = e.postid
        WHERE e.date between MAKEDATE(EXTRACT(YEAR FROM CURDATE()),1)  and  DATE_SUB(cast(NOW() as date), INTERVAL 1 DAY)
        AND e.siteid = '14'
        AND e.Event_Action = 'Next Click'
        GROUP BY 1
    ),
    agg_curr_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum
        FROM prod.pages p
        LEFT JOIN curr_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = '14'
        AND p.date between MAKEDATE(EXTRACT(YEAR FROM CURDATE()),1)  and  DATE_SUB(cast(NOW() as date), INTERVAL 1 DAY)
        GROUP BY p.siteid
    ),
    value_curr_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks / p.pageview_sum * 100, 2) AS value
        FROM agg_curr_30_days_events e
        LEFT JOIN agg_curr_30_days_pages p ON e.siteid = p.siteid
    ),
    last_30_days_article_published AS (
        SELECT siteid, id
        FROM prod.site_archive_post
        WHERE date between DATE_SUB(MAKEDATE(EXTRACT(YEAR FROM CURDATE()),1), INTERVAL 1 Year)  and DATE_SUB(DATE_SUB(cast(NOW() as date), INTERVAL 1 DAY),INTERVAL 1 Year) 
        AND siteid = site
        AND categories <> "Nyhedsoverblik"
    ),
    agg_last_30_days_events AS (
        SELECT 
            e.siteid AS siteid, 
            SUM(e.hits) AS next_clicks_last
        FROM prod.events e
        JOIN last_30_days_article_published a ON a.id = e.postid
        WHERE e.date between DATE_SUB(MAKEDATE(EXTRACT(YEAR FROM CURDATE()),1), INTERVAL 1 Year) and DATE_SUB(DATE_SUB(cast(NOW() as date), INTERVAL 1 DAY),INTERVAL 1 Year) 
        AND e.siteid = '14'
        AND e.Event_Action = 'Next Click'
        GROUP BY 1
    ),
    agg_last_30_days_pages AS (
        SELECT
            p.siteid,
            SUM(p.unique_pageviews) AS pageview_sum_last
        FROM prod.pages p
        LEFT JOIN last_30_days_article_published a ON a.id = p.postid
        WHERE p.siteid = '14'
        AND p.date between DATE_SUB(MAKEDATE(EXTRACT(YEAR FROM CURDATE()),1), INTERVAL 1 Year)  and DATE_SUB(DATE_SUB(cast(NOW() as date), INTERVAL 1 DAY),INTERVAL 1 Year) 
        GROUP BY p.siteid
    ),
    value_last_30_days AS (
        SELECT
            e.siteid,
            ROUND(e.next_clicks_last / p.pageview_sum_last * 100, 2) AS value_last
        FROM agg_last_30_days_events e
        LEFT JOIN agg_last_30_days_pages p ON e.siteid = p.siteid
    )
    SELECT 
        JSON_OBJECT(
            'site', al.siteid,
            'data', JSON_OBJECT(
            'label', 'Gns. next click (%)',
            'hint', 'Gns. next click på artikler publiceret seneste 30 dage ift. forrige 30 dage',
            'value', COALESCE(value, 0),
            'change', COALESCE(value - value_last, 0),
            'progressCurrent', '',
            'progressTotal', ''
            )
        ) AS json_data
    FROM value_curr_30_days al
    LEFT JOIN value_last_30_days alb ON al.siteid = alb.siteid
    WHERE al.siteid = '14';
END;
DELIMITER ;
  );
[0m18:35:37.199635 [debug] [Thread-1 (]: mysql adapter: MySQL error: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'DELIMITER //
CREATE PROCEDURE `Tactical_clicks_months_12_dbt_test`()
BEGIN
    W' at line 12
[0m18:35:37.203166 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_ytd_12: ROLLBACK
[0m18:35:37.403743 [debug] [Thread-1 (]: Timing info for model.site_dev.Tactical_clicks_ytd_12 (execute): 18:35:34.059076 => 18:35:37.402838
[0m18:35:37.406264 [debug] [Thread-1 (]: On model.site_dev.Tactical_clicks_ytd_12: Close
[0m18:35:37.434932 [debug] [Thread-1 (]: Database Error in model Tactical_clicks_ytd_12 (models\example\Tactical_clicks_ytd_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'DELIMITER //
  CREATE PROCEDURE `Tactical_clicks_months_12_dbt_test`()
  BEGIN
      W' at line 12
  compiled Code at target\run\site_dev\models\example\Tactical_clicks_ytd_12.sql
[0m18:35:37.437709 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea6ddf0f-16fe-4eed-8065-0e0219a322ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC3F79C150>]}
[0m18:35:37.441436 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model site_dev.Tactical_clicks_ytd_12 ........... [[31mERROR[0m in 3.47s]
[0m18:35:37.444428 [debug] [Thread-1 (]: Finished running node model.site_dev.Tactical_clicks_ytd_12
[0m18:35:37.455425 [debug] [MainThread]: Using mysql connection "master"
[0m18:35:37.457677 [debug] [MainThread]: On master: BEGIN
[0m18:35:37.460609 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m18:35:41.941418 [debug] [MainThread]: SQL status: SUCCESS 0 in 4.0 seconds
[0m18:35:41.943411 [debug] [MainThread]: On master: COMMIT
[0m18:35:41.946458 [debug] [MainThread]: Using mysql connection "master"
[0m18:35:41.949426 [debug] [MainThread]: On master: COMMIT
[0m18:35:43.554776 [debug] [MainThread]: SQL status: SUCCESS 0 in 2.0 seconds
[0m18:35:43.559288 [debug] [MainThread]: On master: Close
[0m18:35:43.565271 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:35:43.568269 [debug] [MainThread]: Connection 'create__site_dev' was properly closed.
[0m18:35:43.572255 [debug] [MainThread]: Connection 'list_None_site_dev' was properly closed.
[0m18:35:43.573250 [debug] [MainThread]: Connection 'model.site_dev.Tactical_clicks_ytd_12' was properly closed.
[0m18:35:43.577230 [info ] [MainThread]: 
[0m18:35:43.580223 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 20.23 seconds (20.23s).
[0m18:35:43.582215 [debug] [MainThread]: Command end result
[0m18:35:43.618485 [info ] [MainThread]: 
[0m18:35:43.622476 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m18:35:43.627388 [info ] [MainThread]: 
[0m18:35:43.634467 [error] [MainThread]:   Database Error in model Tactical_clicks_ytd_12 (models\example\Tactical_clicks_ytd_12.sql)
  1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'DELIMITER //
  CREATE PROCEDURE `Tactical_clicks_months_12_dbt_test`()
  BEGIN
      W' at line 12
  compiled Code at target\run\site_dev\models\example\Tactical_clicks_ytd_12.sql
[0m18:35:43.638224 [info ] [MainThread]: 
[0m18:35:43.645327 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m18:35:43.650547 [debug] [MainThread]: Command `dbt run` failed at 18:35:43.650547 after 21.19 seconds
[0m18:35:43.652542 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC3E7C8C50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC38841850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC38841750>]}
[0m18:35:43.653637 [debug] [MainThread]: Flushing usage events
